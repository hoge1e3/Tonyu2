function disp(n){function e(n){if(null==n)return t("null%n");if("string"==typeof n)return t("'%s'%n",n);if("number"==typeof n)return t("%s%n",n);if("function"==typeof n)return t("func%n");t(n instanceof Array?"[%{":"{%{");var r="";for(var i in n)t(r+i+":"),e(n[i]);t(n instanceof Array?"%}]%n":"%}}%n")}var t=IndentBuffer();return e(n),t.buf}function XMLBuffer(n){var e;return e=function(t,r){if(null!=t&&"string"!=typeof t&&"number"!=typeof t){var i=Parser.getRange(t);if(i)for(;e.srcLen<i.pos;)e.src(n.substring(e.srcLen,i.pos));if(null!=t){if(r&&e.tag("<attr_"+r+">"),t.type&&e.tag("<"+t.type+">"),t.text)e.src(i.text);else{var a=e.orderByPos(t);a.forEach(function(n){n.name&&n.name.match(/^-/)?e(n.value):e(n.value,n.name)})}if(i)for(;e.srcLen<i.pos+i.len;)e.src(n.substring(e.srcLen,i.pos+i.len));t.type&&e.tag("</"+t.type+">"),r&&e.tag("</attr_"+r+">")}}},e.orderByPos=XMLBuffer.orderByPos,e.src=function(n){e.buf+=n.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),e.srcLen+=n.length},e.tag=function(n){e.buf+=n},e.buf="",e.srcLen=0,e}function TError(n,e,t){if("string"==typeof e)return{isTError:!0,mesg:n,src:{name:function(){return e},text:function(){return e}},pos:t,toString:function(){return this.mesg+" at "+e+":"+this.pos},raise:function(){throw this}};var r=null;if(e&&e.src&&(r=e,e=r.src.tonyu),"function"!=typeof e.name)throw"src="+e+" should be file object";return{isTError:!0,mesg:n,src:e,pos:t,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.pos},raise:function(){throw this}}}function ExpressionParser(){function n(n,e){var t={};return t.eq=function(t){return n==t.type()&&e==t.prio()},t.type=function(e){return e?e==n:n},t.prio=function(){return e},t.toString=function(){return"["+n+":"+e+"]"},t}function e(n){var e={},t=n;return e.add=function(n){t=t?t.or(n):n},e.get=function(){return t},e}function t(){var t=e(),r={};return r.reg=function(e,r,i){var a=n(e,r);t.add(i.ret(Parser.create(function(n){return n.opType=a,n})).setName("(opType "+a+" "+i.name+")"))},r.get=function(){return t.get()},r.parse=function(n){return r.get().parse(n)},r}function r(n,e){return}function i(n,e){var t,u=e;if(r(e," start minprio= "+n),e=s.parse(e),r(e," prefixorelem "+n),!e.isSuccess())return e;if(t=e.opType,t.type("prefix")){if(pre=e.result[0],e=i(t.prio(),e),!e.isSuccess())return e;var l=a.mkPrefix.def(pre,e.result[0]);if(u=e.clone(),u.result=[l],!e.nextPostfixOrInfix)return u;e=e.nextPostfixOrInfix}else if(u=e.clone(),e=o.parse(e),!e.isSuccess())return u;for(;;){if(r(e,"st:pi"),r(u,"res:ex"),t=e.opType,t.prio()<n)return u.nextPostfixOrInfix=e,u;if(t.type("postfix")){var l=a.mkPostfix.def(u.result[0],e.result[0]);if(u=e.clone(),u.result=[l],r(e,"185"),e=o.parse(e),!e.isSuccess())return u}else if(t.type("infixl")){var f=e.result[0];if(e=i(t.prio()+1,e),!e.isSuccess())return u;var l=a.mkInfixl.def(u.result[0],f,e.result[0]);if(u=e.clone(),u.result=[l],!e.nextPostfixOrInfix)return u;e=e.nextPostfixOrInfix}else if(t.type("infixr")){var f=e.result[0];if(e=i(t.prio(),e),!e.isSuccess())return u;var l=a.mkInfixr.def(u.result[0],f,e.result[0]);if(u=e.clone(),u.result=[l],!e.nextPostfixOrInfix)return u;e=e.nextPostfixOrInfix}else if(t.type("trifixr")){var p=u.result[0],h=e.result[0];if(e=i(t.prio()+1,e),!e.isSuccess())return u;var d=e.result[0],e=c[t.prio()].parse(e);if(!e.isSuccess())return u;var m=e.result[0];if(e=i(t.prio(),e),!e.isSuccess())return u;var v=e.result[0],l=a.mkTrifixr.def(p,h,d,m,v);if(u=e.clone(),u.result=[l],!e.nextPostfixOrInfix)return u;e=e.nextPostfixOrInfix}else{var f=e.result[0];if(e=i(t.prio()+1,e),!e.isSuccess())return u;var l=a.mkInfix.def(u.result[0],f,e.result[0]);if(u=e.clone(),u.result=[l],!e.nextPostfixOrInfix)return u;if(e=e.nextPostfixOrInfix,t.prio()==e.opType.prio())return u.success=!1,u}}}var a={},s=t(),o=t(),u=e(),c=[];return a.element=function(n){s.reg("element",-1,n),u.add(n)},a.getElement=function(){return u.get()},a.prefix=function(n,e){s.reg("prefix",n,e)},a.postfix=function(n,e){o.reg("postfix",n,e)},a.infixl=function(n,e){o.reg("infixl",n,e)},a.infixr=function(n,e){o.reg("infixr",n,e)},a.infix=function(n,e){o.reg("infix",n,e)},a.trifixr=function(n,e,t){o.reg("trifixr",n,e),c[n]=t},a.custom=function(){},a.mkInfix=function(n){a.mkInfix.def=n},a.mkInfix.def=function(n,e,t){return Parser.setRange({type:"infix",op:e,left:n,right:t})},a.mkInfixl=function(n){a.mkInfixl.def=n},a.mkInfixl.def=function(n,e,t){return Parser.setRange({type:"infixl",op:e,left:n,right:t})},a.mkInfixr=function(n){a.mkInfixr.def=n},a.mkInfixr.def=function(n,e,t){return Parser.setRange({type:"infixr",op:e,left:n,right:t})},a.mkPrefix=function(n){a.mkPrefix.def=n},a.mkPrefix.def=function(n,e){return Parser.setRange({type:"prefix",op:n,right:e})},a.mkPostfix=function(n){a.mkPostfix.def=n},a.mkPostfix.def=function(n,e){return Parser.setRange({type:"postfix",left:n,op:e})},a.mkTrifixr=function(n){a.mkTrifixr.def=n},a.mkTrifixr.def=function(n,e,t,r,i){return Parser.setRange({type:"trifixr",left:n,op1:e,mid:t,op2:r,right:i})},a.build=function(){return a.built=Parser.create(function(n){return i(0,n)}).setName("ExpBuilt"),a.built},a.lazy=function(){return Parser.create(function(n){return a.built.parse(n)})},a}function context(){function n(n,t){var r={};for(var i in n)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=e[i],e[i]=e.ovrFunc(e[i],n[i])):(r[i]=e[i],e[i]=n[i]);t(e);for(var i in r)e[i]=r[i]}var e={};return e.ovrFunc=function(n,e){return e.parent=n,e},e.enter=n,e}function fukidashi(n,e,t,r,i){var a="c",s=20,o=5,u=TextRect.draw(n,e,t,r-s-o-i,i,a);n.beginPath(),n.moveTo(t,r),n.lineTo(t+o,r-s),n.lineTo(t+u.w/2+o,r-s),n.lineTo(t+u.w/2+o,r-s-u.h-2*o),n.lineTo(t-u.w/2-o,r-s-u.h-2*o),n.lineTo(t-u.w/2-o,r-s),n.lineTo(t-o,r-s),n.closePath(),n.fill(),n.stroke();var c=n.fillStyle;n.fillStyle=n.strokeStyle,TextRect.draw(n,e,t,r-s-o-i,i,a,"fill"),n.fillStyle=c}!function(){var n={};return n.def=function(e,t,r){var i=n.getModuleInfo(n.curName);i.type=r,n.setReqs(i,e),i.func=function(){return t.apply(this,n.getObjs(e))},n.loadIfAvailable(i)},define=function(e,t){n.def(e,t,"define")},require=requirejs=function(e,t){n.def(e,t,"require")},n.setReqs=function(e,t){t.forEach(function(t){var r=n.getModuleInfo(t);r.loaded||(e.reqs[t]=r,r.revReqs[e.name]=e)})},n.getModuleInfo=function(e){var t=n.modules;return t[e]||(t[e]={name:e,reqs:{},revReqs:{}}),t[e]},n.doLoad=function(e){var t=n.getModuleInfo(e);if(t.loaded)return t.obj;t.loaded=!0;var r=null;if(t.func)r=t.func();else{var i=e.split(/\./);r=function(){return this}(),i.forEach(function(n){r&&(r=r[n])}),null==r&&console.log("Warning: No obj for "+e)}if("define"==t.type&&null==r)throw"No obj for "+e;t.obj=r;for(var a in t.revReqs)n.notifyLoaded(t.revReqs[a],t.name);return r},n.notifyLoaded=function(e,t){delete e.reqs[t],n.loadIfAvailable(e)},n.loadIfAvailable=function(e){for(var t in e.reqs)return;n.doLoad(e.name)},n.getObjs=function(e){var t=[];return e.forEach(function(e){var r=n.doLoad(e);t.push(r)}),t},n.modules={},n.setName=function(e){n.curName&&(n.getModuleInfo(n.curName).func||n.doLoad(n.curName)),e&&(n.curName=e)},requireSimulator=n,n}(),requireSimulator.setName("FS"),FS=function(){function n(n,e){return n.substring(n.length-e.length)===e}function e(n,e){return n.substring(0,e.length)===e}function t(){return(new Date).getTime()}function r(n){var e=n.split(T);return""==e[e.length-1]&&(e[e.length-2]+=T,e.pop()),e}function i(n){for(var e in b){var t=n.substring(0,e.length),r=n.substring(e.length);if(t==e)return{rom:b[e],rel:r}}return null}function a(n){return i(n)}function s(n,e){if(x)return u(n,e);var t=i(n);if(2!=arguments.length)return t?t.rom[t.rel]:localStorage[n];if(t)throw n+" is Read only.";return null!=e?localStorage[n]=e:void delete localStorage[n]}function o(n){if(x)return c(n);var e=i(n);return e?e.rel in e.rom:n in localStorage}function u(n,e){var t=i(n);if(2!=arguments.length)return t?t.rom[t.rel]:x[n];if(t)throw n+" is Read only.";return null!=e?x[n]=e:void delete x[n]}function c(n){var e=i(n);return e?e.rel in e.rom:n in x}function l(n,e,t){if(null==n)throw"putDir: Null path";if(!g(n))throw"Not a directory : "+n;s(n,JSON.stringify(e));var r=m(n);if(null!=r){var i=f(r);p(i,r,y(n),t)}}function f(e){if(null==e)throw"getDir: Null path";n(e,T)||(e+=T);var t=s(e);try{t=JSON.parse(t)}catch(r){a(e)?console.log("dinfo err : "+e+" - "+t):s(e,"{}"),t={}}for(var i in t)"number"==typeof t[i]&&(t[i]={lastUpdate:t[i]});return t}function p(n,e,r,i){n[r]||(n[r]={},i&&(n[r].trashed=!0)),i||delete n[r].trashed,n[r].lastUpdate=t(),l(e,n,i)}function h(n,e,r){n[r]&&(n[r]={lastUpdate:t(),trashed:!0},l(e,n,!0))}function d(n,e,t){n[t]&&(delete n[t],l(e,n,!0))}function m(n){if(n==T)return null;var e=r(n);return e[e.length-1]="",e.join(T)}function v(n){return e(n,T)}function g(e){return n(e,T)}function y(n){var e=r(n);return e[e.length-1]}var x=null;("undefined"==typeof localStorage||null==localStorage)&&(console.log("FS: Using RAMDisk"),x={});var w={},b={},T="/";w.roms=b,w.endsWith=n,w.splitPath=r,w.orderByNewest=function(n,e){if(!(n&&e&&n.lastUpdate&&e.lastUpdate))return 0;var t=n.lastUpdate(),r=e.lastUpdate();return r>t?1:t>r?-1:0},w.orderByName=function(n,e){return n.name&&e.name&&(n=n.name(),e=e.name()),n>e?1:e>n?-1:0},w.orderByNumberedName=function(n,e){function t(n){for(var e=[],t=/^[0-9]*/,r=/^[^0-9]*/;n&&(n.match(r),e.push(RegExp.lastMatch),n=n.replace(r,""));){n.match(t);var i=parseInt(RegExp.lastMatch);e.push(i),n=n.replace(t,"")}return e}n.name&&e.name&&(n=n.name(),e=e.name());var r,i=t(n),a=t(e);for(r=0;r<i.length;r++){if(r>=a.length)return 1;if(i[r]>a[r])return 1;if(i[r]<a[r])return-1}return r<a.length?-1:0},w.importDir=function(n){var e=w.get(n.base);n.confirm||e.mkdir();var t=n.data,r=[];for(var i in t){var a=e.path()+i,o=w.get(a);if(r.push("["+(o.isReadOnly()?"ro":o.exists()?"exists":"new")+"]"+a),!o.isReadOnly()&&!n.confirm)if(o.isDir()){var u=f(a),c=JSON.parse(t[i]);for(var p in c)u[p]=c[p];l(a,u,!1)}else s(a,t[i])}return r},w.mountROM=function(n){console.log("ROM mouted on ",n.base),b[n.base]=n.data};var S="DONOTEXPORT";return w.exportDir=function(n,e){function t(r){var a=r.relPath(n);if(i[a]=r.text(),e.keepCR||(i[a]=i[a].replace(/\r/g,"")),r.isDir()){if(r.rel(S).exists())return;r.each(t)}}e||(e={}),"string"==typeof n&&(n=w.get(n));var r={base:n.path()},i=r.data={};return t(n),r},w.get=function(t,a){if(a||(a={}),null==t)throw"FS.get: Null path";if(t.isDir)return t;if(a.topDir&&!e(t,a.topDir))throw t+" is out of securtyDomain";if(!v(t))throw t+": Path must starts with '/'";var u,c=m(t),x=y(t);if(g(t)){var b=u={};b.files=function(n,e){var t=[];return b.each(function(n){t.add(n)},e),t},b.each=function(n,e){b.ls(e).forEach(function(e){var t=b.rel(e);n(t)})},b.recursive=function(n,e){b.each(function(e){e.isDir()?e.recursive(n):n(e)},e)},b.listFiles=function(n){var e;"function"==typeof n&&(e=n),n=b.convertOptions(n),e||(e=n.order);var r=f(t),i=[];for(var a in r)(n.includeTrashed||!r[a].trashed)&&(n.excludes[t+a]||i.push(b.rel(a)));return"function"==typeof e&&i.sort&&i.sort(e),i},b.ls=function(n){var e=b.listFiles(n),t=[];return e.forEach(function(n){t.push(n.name())}),t},b.convertOptions=function(n){if(n||(n={}),n.excludes||(n.excludes={}),n.excludes instanceof Array){var r={};n.excludes.forEach(function(n){e(n,"/")?r[n]=1:r[t+n]=1}),n.excludes=r}return n},b.isDir=function(){return!0},b.rel=function(n){var e=r(n),t=b.path();return t=t.replace(/\/$/,""),e.forEach(function(n){".."==n||"../"==n?t=m(t):(t=t.replace(/\/$/,""),t+=T+("."==n||"./"==n?"":n))}),w.get(t,a)},b.rm=function(){if(!b.exists())throw t+": No such dir.";var n=b.ls();if(n.length>0)throw t+": Directory not empty";if(null!=c){var e=f(c);h(e,c,x)}},b.removeWithoutTrash=function(){if(b.each(function(n){n.removeWithoutTrash()},{includeTrashed:!0}),s(t,null),null!=c){var n=f(c);d(n,c,x)}},b.mkdir=function(){b.touch(),f(t)},b.text=function(){return s(t)},b.obj=function(){return JSON.parse(b.text())},b.exists=function(){if("/"==t)return!0;var n=f(c);return n&&n[x]&&!n[x].trashed}}else{var S=u={};S.isDir=function(){return!1},S.rm=function(){if(!S.exists())throw t+": No such file.";if(s(t,null),null!=c){var n=f(c);h(n,c,x)}},S.removeWithoutTrash=function(){if(!S.exists()&&!S.isTrashed())throw t+": No such file.";if(s(t,null),null!=c){var n=f(c);d(n,c,x)}},S.text=function(){return 0==arguments.length?s(t):(s(t,arguments[0]),void S.touch())},S.lines=function(){return S.text().split("\n")},S.obj=function(){if(0==arguments.length){var n=S.text();return n?JSON.parse(n):null}S.text(JSON.stringify(arguments[0]))},S.copyFrom=function(n,e){S.text(n.text()),e.a&&S.metaInfo(n.metaInfo())},S.exists=function(){return o(t)}}return u.relPath=function(n){var e=n.path?n.path():n;if(e.substring(e.length-1)!=T)throw e+" is not a directory.";return t.substring(0,e.length)!=e?"../"+u.relPath(n.up()):t.substring(e.length)},u.isTrashed=function(){var n=u.metaInfo();return n?n.trashed:!1},u.metaInfo=function(){if(null!=c){var n=f(c);if(0==arguments.length)return n[x];n[x]=arguments[0],l(c,n,n[x].trashed)}return{}},u.lastUpdate=function(){return u.metaInfo().lastUpdate},u.up=function(){return null==c?null:w.get(c,a)},u.path=function(){return t},u.name=function(){return x},u.truncExt=function(n){return x.substring(0,x.length-n.length)},u.touch=function(){if(null!=c){var n=f(c);p(n,c,x,!1)}},u.isReadOnly=function(){var n=i(t);return!!n},u.startsWith=function(n){return e(x,n)},u.endsWith=function(e){return n(x,e)},u.equals=function(n){return n&&"function"==typeof n.path&&n.path()==t},u.toString=function(){return t},u},w.scan=function(){for(var n in localStorage)if(v(n)){var e=m(n);if(null!=e){var t=f(e),r=y(n);p(t,e,r,t[r]&&t[r].trashed)}}},w.dump=function(){for(var n in localStorage)console.log(n)},w.ls=function(n){return w.get(n).ls()},w}(),requireSimulator.setName("WebSite"),define([],function(){var n=document.location.href,e=!!n.match(/html\/dev\//)&&!!n.match(/localhost:3/);return window.WebSite=n.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/j/D/9/q/jD9qQ.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:e}:n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)||(n.match(/^file:/)||n.match(/localhost/)||n.match(/tonyuedit\.appspot\.com/))&&n.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/ecl.png":"../../images/ecl.png"},top:"../../",devMode:e}:{urlAliases:{},top:"../../",devMode:e},window.WebSite.disableROM={},(n.match(/tonyuedit\.appspot\.com/)||n.match(/localhost:8888/))&&(window.WebSite.disableROM={"ROM_d.js":!0}),(n.match(/\.appspot\.com/)||n.match(/localhost:888[87]/))&&(window.WebSite.serverType="GAE"),n.match(/localhost:3000/)&&(window.WebSite.serverType="Node"),window.WebSite.serverTop=n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)?window.WebSite.top+"exe/":window.WebSite.top+"edit/",window.WebSite.sampleImg=window.WebSite.top+"images",window.WebSite.blobPath=window.WebSite.serverTop+"serveBlob",window.WebSite}),requireSimulator.setName("fs/ROMk"),function(){var n={base:"/Tonyu/Kernel/",data:{"":'{".desktop":{"lastUpdate":1418199307653},"Actor.tonyu":{"lastUpdate":1414051292629},"BaseActor.tonyu":{"lastUpdate":1418199307655},"Boot.tonyu":{"lastUpdate":1416889517769},"InputDevice.tonyu":{"lastUpdate":1416889517771},"Keys.tonyu":{"lastUpdate":1411529063832},"Map.tonyu":{"lastUpdate":1412840047455},"MapEditor.tonyu":{"lastUpdate":1413954028924},"MathMod.tonyu":{"lastUpdate":1400120164000},"MML.tonyu":{"lastUpdate":1407216015130},"NoviceActor.tonyu":{"lastUpdate":1411021950732},"Panel.tonyu":{"lastUpdate":1418198857560},"ScaledCanvas.tonyu":{"lastUpdate":1414051292632},"Sprites.tonyu":{"lastUpdate":1416889517770},"TObject.tonyu":{"lastUpdate":1400120164000},"TQuery.tonyu":{"lastUpdate":1403517241136},"WaveTable.tonyu":{"lastUpdate":1400120164000},"Pad.tonyu":{"lastUpdate":1414554218357}}',".desktop":'{"runMenuOrd":["TouchedTestMain","Main1023","Main2","MapLoad","Main","AcTestM","NObjTest","NObjTest2","AcTest","AltBoot","Ball","Bar","Bounce","MapTest","MapTest2nd","SetBGCTest","Label","PanelTest","Boot","InputDevice","Sprites","BaseActor"]}',"Actor.tonyu":'extends BaseActor;\nnative Sprites;\nnative Tonyu;\n\n\\new(x,y,p) {\n    super(x,y,p);\n    if (Tonyu.runMode) initSprite();\n}\n\\initSprite() {\n    if(layer && typeof layer.add=="function"){\n        layer.add(this);\n    }else{\n        $Sprites.add(this);\n    }\n    onAppear();\n}\n\\onAppear() {\n}\n',"BaseActor.tonyu":'extends null;\nincludes MathMod;\nnative Tonyu;\nnative Key;\nnative console;\nnative Math;\nnative fukidashi;\nnative TextRect;\nnative FS;\nnative Array;\n\n\\new(x,y,p) {\n    if (Tonyu.runMode) {\n        var thg=currentThreadGroup();\n        if (thg) _th=thg.addObj(this);\n    }\n    if (typeof x=="object") Tonyu.extend(this,x); \n    else if (typeof x=="number") {\n        this.x=x;\n        this.y=y;\n        this.p=p;\n    }\n    if (scaleX==null) scaleX=1;\n    if (rotation==null) rotation=0;\n    if (rotate==null) rotate=0;\n    if (alpha==null) alpha=255;\n    if (zOrder==null) zOrder=0;\n    if (age==null) age=0;\n    if (anim!=null && typeof anim=="object"){\n        animMode=true;\n        animFrame=0;\n    }else{\n        animMode=false;\n    }\n    if (animFps==null) animFps=1;\n}\nnowait \\extend(obj) {\n    return Tonyu.extend(this,obj);\n}\n\nnowait \\print(pt) {\n    console.log.apply(console,arguments);\n    if($consolePanel){\n        $consolePanel.scroll(0,20);\n        $consolePanel.setFillStyle("white");\n        $consolePanel.fillText(pt,0,$consolePrintY,20,"left");\n    }\n}\n\nnowait \\setAnimFps(f){\n    this.animFps=f;\n    this.animFrame=0;\n    this.animMode=true;\n}\nnowait \\startAnim(){\n    this.animMode=true;\n}\nnowait \\stopAnim(){\n    this.animMode=false;\n}\n\\update() {\n    ifwait {\n        _thread.suspend();\n    }\n}\n\\updateEx(updateT){\n    for(var updateCount=0;updateCount<updateT;updateCount++){\n        update();\n    }\n}\nnowait \\getkey(k) {\n    return $Keys.getkey(k);\n}\nnowait \\hitTo(t) {\n    return crashTo(t);\n}\nnowait \\all(c) {\n    var res=new TQuery;\n    $Sprites.sprites.forEach \\(s) {\n        if (s===this) return;\n        if (!c || s instanceof c) {\n            res.push(s);\n        }\n    };\n    return res;// new TQuery{objects:res};\n}\nnowait \\allCrash(t) {\n    var res=new TQuery;\n    var sp=this; //_sprite || this;\n    var t1=getCrashRect();\n    if (!t1) return res;\n    $Sprites.sprites.forEach(\\(s) {\n        var t2;\n        if (s!==this && \n        !s.excludeFromAll &&\n        s instanceof t && \n        (t2=s.getCrashRect()) &&\n        Math.abs(t1.x-t2.x)*2<t1.width+t2.width &&\n        Math.abs(t1.y-t2.y)*2<t1.height+t2.height) {\n            res.push(s);    \n        }\n    });\n    return res;\n}\nnowait \\crashTo(t) {\n    if (!t) return false;\n    if (typeof t=="function") {\n        return allCrash(t)[0];\n    }\n    return crashTo1(t);\n}\nnowait \\crashTo1(t) {\n    if (!t || t._isDead) return false;\n    /*if (_sprite && t._sprite) {\n        return _sprite.crashTo(t._sprite);\n    }*/\n    var t1=getCrashRect();\n    var t2=t.getCrashRect();\n    return \n    //    t1.x!=null && t1.y!=null && t1.width && t1.height &&\n    //    t2.x!=null && t2.y!=null && t2.width && t2.height &&\n    t1 && t2 &&\n    Math.abs(t1.x-t2.x)*2<t1.width+t2.width &&\n    Math.abs(t1.y-t2.y)*2<t1.height+t2.height;\n}\nnowait \\getCrashRect() {\n    var actWidth=width*scaleX, actHeight;\n    if(typeof scaleY==="undefined"){\n        actHeight=height*scaleX;\n    }else{\n        actHeight=height*scaleY;\n    }\n    return typeof x=="number" &&\n    typeof y=="number" &&\n    typeof width=="number" &&\n    typeof height=="number" && \n    {x,y,width:actWidth,height:actHeight};\n}\nnowait \\within(t,distance){\n    if(!t || t._isDead) return false;\n    if(Math.sqrt(Math.abs(x-t.x)*Math.abs(x-t.x)+ Math.abs(y-t.y)*Math.abs(y-t.y))<distance){\n        return true;\n    }\n    return false;\n}\nnowait \\watchHit(typeA,typeB,onHit) {\n    $Sprites.watchHit(typeA , typeB, \\(a,b) {\n        onHit.apply(this,[a,b]);\n    });\n}\nnowait \\currentThreadGroup() {\n    return $currentThreadGroup; \n}\nnowait \\die() {\n    if (_th) {\n        _th.kill();\n    }\n    hide();\n    play().stop();\n    _isDead=true;\n}\nnowait \\hide() {\n    /*if (_sprite) {\n        $Sprites.remove(_sprite);\n        _sprite=null;\n    } else {*/\n        //$Sprites.remove(this);\n    //}\n    if(layer && typeof layer.remove=="function"){\n        layer.remove(this);\n    }else{\n        $Sprites.remove(this);\n    }\n}\nnowait \\show(x,y,p) {\n    if(layer && typeof layer.add=="function"){\n        layer.add(this);\n    }else{\n        $Sprites.add(this);\n    }\n    if (x!=null) this.x=x;\n    if (y!=null) this.y=y;\n    if (p!=null) this.p=p;\n}\n\nnowait \\rnd(r) {\n    if (typeof r=="number") {\n        return Math.floor(Math.random()*r);\n    }\n    return Math.random();\n}\nnowait \\detectShape() {\n    if (typeof p!="number") {\n        if (text!=null) return;\n        p=0;\n    }\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) return;\n    width=pImg.width;\n    height=pImg.height;\n}\n\\waitFor(f) {\n    ifwait {\n        _thread.waitFor(f);\n    }\n    update();\n}\nnowait \\isDead() {\n    return _isDead;\n}\n\nnowait \\animation(){\n    age++;\n    if(animMode && age%animFps==0){\n        p=anim[animFrame%anim.length];\n        animFrame++;\n    }\n}\nnowait \\draw(ctx) {\n    if (x==null || y==null) return;\n    detectShape();\n    if (pImg) {\n        ctx.save();\n        ctx.translate(x,y);\n        //if (typeof rotate=="number" ) rotation=rotate;// 削除予定\n        //ctx.rotate(this.rotation/180*Math.PI);\n        animation();\n        if(this.rotation!=0){\n            ctx.rotate(this.rotation/180*Math.PI);\n        }else{\n            ctx.rotate(this.rotate/180*Math.PI);\n        }\n        if(typeof this.scaleY==="undefined") {\n            ctx.scale(this.scaleX,this.scaleX);\n        }else{\n            ctx.scale(this.scaleX,this.scaleY);\n        }\n        ctx.globalAlpha=this.alpha/255;\n        ctx.drawImage(\n        pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n        -width/2, -height/2, width, height);\n        ctx.restore();\n    } else if (text!==null && text!==undefined) {\n        if (!size) size=15;\n        if (!align) align="center";\n        if (!fillStyle) fillStyle="white";\n        ctx.fillStyle=fillStyle;\n        ctx.globalAlpha=this.alpha/255;\n        var rect=TextRect.draw(ctx, text, x, y, size, align , "fill");\n        width=rect.w;\n        height=rect.h;\n    }\n    if (_fukidashi) {\n        if (_fukidashi.c>0) {\n            _fukidashi.c--;\n            ctx.fillStyle="white";\n            ctx.strokeStyle="black";\n            fukidashi ( ctx , _fukidashi.text, \n            x, y-height/2-10, _fukidashi.size);\n        }\n    }\n}\nnowait \\asyncResult() {\n    return Tonyu.asyncResult();\n}\n\n\\screenOut(a) {\n    //オブジェクトが画面外に出たかどうかを判定します。\n    if (!a) a=0;\n    var r=0;\n    var viewX=0,viewY=0;\n    if (x<viewX+a)               r+=viewX+a-x;\n    if (y<viewY+a)               r+=viewY+a-y;\n    if (x>$screenWidth +viewX-a) r+=x-($screenWidth +viewX-a);\n    if (y>$screenHeight+viewY-a) r+=y-($screenHeight+viewY-a);\n    return r;\n}\n\\file(path) {\n    var d=Tonyu.currentProject.getDir();\n    var files=d.rel("files/");\n    return FS.get(files.rel(path)) {topDir:d};\n}\n\\waitInputDevice(fl) {\n    if (fl!==false) {\n        if (!origTG) {\n            ifwait {\n                origTG=_thread.group;\n                _thread.setGroup(null);\n            }\n        }\n        a=asyncResult();\n        $InputDevice.addOnetimeListener(a.receiver);\n        waitFor(a);\n    } else {\n        if (origTG) {\n            ifwait {\n                _thread.setGroup(origTG);\n                origTG=null;\n            }\n        }\n    }\n}\n\\redrawScreen() {\n    $Sprites.draw($Screen.buf[0]);\n    $Screen.draw();\n}\n\\play() {\n    if (!_mml) _mml=new MML;\n    if (isDead() || arguments.length==0) return _mml;\n    var mmls=[];\n    for (var i=0; i<arguments.length; i++) {\n        mmls.push(arguments[i]);\n    }\n    _mml.play(mmls);\n    while (_mml.bufferCount()>2) {\n        update();\n    }\n    return _mml;\n}\nnowait \\playSE() {\n    var mml=new MML;\n    var mmls=[];\n    for (var i=0; i<arguments.length; i++) {\n        mmls.push(arguments[i]);\n    }\n    mml.play(mmls);\n    return mml;\n}',"Boot.tonyu":'native $;\nnative TError;\nnative $LASTPOS;\nnative Key;\nnative Date;\nnative ImageList;\nnative Tonyu;\nnative SplashScreen;\nnative Math;\n\n\\initSprites() {\n    $Sprites=new Sprites();\n    $FrontSprites=new Sprites();\n    print ("Loading pats..");\n    var rs=$currentProject.getResource();\n    var a=asyncResult();\n    ImageList.load( rs.images, a.receiver)\n    {baseDir:$currentProject.getDir()};\n    waitFor(a);\n    var r=a[0];\n    $Sprites.setImageList(r);\n    for (var name,val in r.names) {\n        Tonyu.setGlobal(name, val);\n    }\n    print ("Loading pats done.");\n    cvj=$("canvas");\n    if (Tonyu.noviceMode) {\n        $Screen=new ScaledCanvas{canvas:cvj, width:600, height:300};\n    } else {\n        $Screen=new ScaledCanvas{canvas:cvj, width:465, height:465};\n    }\n}\n\n\n\\initThread() {\n    $mainThreadGroup=thg=Tonyu.threadGroup();\n    var o=Tonyu.currentProject.getOptions();\n    var mainClassName=o.run.mainClass;\n    print("MainClass= "+mainClassName);\n    mainClass=Tonyu.getClass(mainClassName);\n    if (!mainClass) {\n        TError( mainClassName+" というクラスはありません", \n        "不明" ,0).raise();\n    }\n    Tonyu.runMode=true;\n    $currentThreadGroup=thg;\n    new mainClass();\n}\n\\stop() {\n    \n    for (var k,v in $MMLS) {\n        v.stop();\n    }\n    $WaveTable.stop();\n}\ninitSprites();\n$InputDevice=new InputDevice;\n$InputDevice.initCanvasEvents(cvj);\ninitThread();\n\n$pat_fruits=30;\n$Keys=new Keys;\n$MMLS={};\n$Math=Math;\n$WaveTable=new WaveTable;\n$consolePanel=new Panel{align:"center",x:465/2,y:465/2,width:465,height:465,zOrder:-10,layer:$FrontSprites};\n$consolePrintY=465-15;\n$panel=new Panel{align:"center",x:$screenWidth/2,y:$screenHeight/2,width:$screenWidth,height:$screenHeight,zOrder:-1,layer:$FrontSprites};\nif (typeof SplashScreen!="undefined") SplashScreen.hide();\nwhile (true) {\n    ti=new Date().getTime();\n    thg.steps();\n    $Keys.update();\n    $InputDevice.update();\n    $screenWidth=$Screen.width;\n    $screenHeight=$Screen.height;\n    $Screen.fillCanvas($Screen.buf[0]);\n    $Sprites.draw($Screen.buf[0]);\n    $FrontSprites.draw($Screen.buf[0]);\n    $Screen.draw();\n    $Sprites.checkHit();\n    wt=33-(new Date().getTime()-ti);\n    if (wt<0) wt=0;\n    waitFor(Tonyu.timeout(wt));\n}',"InputDevice.tonyu":'extends null;\nnative $;\nnative window;\nnative Tonyu;\n\\new() {\n    listeners=[];\n    touchEmu=true;\n}\n\\handleListeners() {\n    var l=listeners;\n    listeners=[];\n    while (l.length>0) { (l.shift())(); }\n}\n\\addOnetimeListener(l){\n    listeners.push(l);\n}\n\\initCanvasEvents(cvj) {\n    var cv=cvj[0];\n    $handleMouse=\\(e) {\n        var p=cvj.offset();\n        var mp={x:e.clientX-p.left, y:e.clientY-p.top};\n        mp=$Screen.canvas2buf(mp);\n        $mouseX=mp.x;\n        $mouseY=mp.y;\n        if (touchEmu) {\n            $touches[0].x=mp.x;\n            $touches[0].y=mp.y;\n        }\n        handleListeners();\n    };\n    $touches=[{},{},{},{},{}];\n    $touches.findById=\\(id) {\n        for (var j=0 ; j<$touches.length ; j++) {\n            if ($touches[j].identifier==id) {\n                return $touches[j];\n            }\n        }\n    };\n    $handleTouch=\\(e) {\n        touchEmu=false;\n        var p=cvj.offset();\n        e.preventDefault();\n        var ts=e.originalEvent.changedTouches;\n        for (var i =0 ; i<ts.length ; i++) {\n            var src=ts[i];\n            var dst=$touches.findById(src.identifier);\n            if (!dst) {\n                for (var j=0 ; j<$touches.length ; j++) {\n                    if (!$touches[j].touched) {\n                        dst=$touches[j];\n                        dst.identifier=src.identifier;\n                        break;\n                    }\n                }\n            }\n            if (dst) {\n                mp={x:src.pageX-p.left, y:src.pageY-p.top};\n                mp=$Screen.canvas2buf(mp);\n                dst.x=mp.x;\n                dst.y=mp.y;\n                if(!dst.touched) dst.touched=1;\n            }\n        }\n        $mouseX=$touches[0].x;\n        $mouseY=$touches[0].y;\n        handleListeners();\n    };\n    $handleTouchEnd=\\(e) {\n        var ts=e.originalEvent.changedTouches;\n        for (var i =0 ; i<ts.length ; i++) {\n            var src=ts[i];\n            var dst=$touches.findById(src.identifier);\n            if (dst) {\n                dst.touched=0;\n                dst.identifier=-1;\n            }\n        }\n        handleListeners();\n    };\n    var handleMouse=\\(e){$handleMouse(e);};\n    var handleTouch=\\(e){$handleTouch(e);};\n    var handleTouchEnd=\\(e){$handleTouchEnd(e);};\n    var d=$.data(cv,"events");\n    if (!d) {\n        $.data(cv,"events","true");\n        cvj.mousedown(handleMouse);\n        cvj.mousemove(handleMouse);\n        cvj.on("touchstart",handleTouch);\n        cvj.on("touchmove",handleTouch);\n        cvj.on("touchend",handleTouchEnd);\n    }\n}\n\n\\update() {\n    for (var i in $touches) {\n        if (i.touched>0) {i.touched++;}\n        if (i.touched==-1) i.touched=1;\n    }\n}',"Keys.tonyu":'extends TObject;\nnative String;\nnative $;\nnative document;\n//\\new () {this.main();}\nstats={};\ncodes={\n    left: 37 , up:38 , right: 39, down:40, space:32, enter:13,\n    shift:16, ctrl:17, alt:18, mouseleft: 1\n};\nfor (var i=65 ; i<65+26; i++) {\n    codes[String.fromCharCode(i).toLowerCase()]=i;\n}\nfor (var i=48 ; i<58; i++) {\n    codes[String.fromCharCode(i)]=i;\n}\nif (!$.data(document,"key_event")) {\n    $.data(document,"key_event",true);\n    $(document).keydown \\(e) {$Keys.keydown(e);};\n    $(document).keyup \\(e) {$Keys.keyup(e);};\n    $(document).mousedown \\(e) {\n        if ($InputDevice.touchEmu) {\n            $touches[0].touched=1;\n        }\n        $Keys.keydown{keyCode:1};\n    };\n    $(document).mouseup \\(e) {\n        if ($InputDevice.touchEmu) {\n            $touches[0].touched=0;\n        }\n        $Keys.keyup{keyCode:1};\n    };\n}\nfunction getkey(code) {\n    if (typeof code=="string") {\n        code=codes[code.toLowerCase()];\n    }\n    if (!code) return 0;\n    if (stats[code]==-1) return 0;\n    if (!stats[code]) stats[code]=0;\n    return stats[code];\n}\nfunction update() {\n    for (var i in stats) {\n        if (stats[i]>0) {stats[i]++;}\n        if (stats[i]==-1) stats[i]=1;\n    }\n}\n\\keydown(e) {\n    var s=stats[e.keyCode];\n    if (!s) {\n        stats[e.keyCode]=1;\n    }\n    $InputDevice.handleListeners();\n}\n\\keyup(e) {\n    stats[e.keyCode]=0;\n    $InputDevice.handleListeners();\n}',"MML.tonyu":'extends TObject;\nnative T;\n\nmmlBuf=[];\n\\play(mmls) {\n    mmlBuf.push(mmls);\n    if (!isPlaying()) {\n        playNext();\n    }\n}\n\\playNext() {\n    //print("play!", id(), bufferCount());\n    if (cTimeBase==null) cTimeBase=0;\n    if (m) {\n        cTimeBase+=m.currentTime;\n        //print(m.currentTime);\n    }\n    var mml=mmlBuf.shift();\n    if (!mml) {\n        m=null;\n        cTimeBase=0;\n        return;\n    }\n    mwav=$WaveTable.get(0,0).play();\n    m=T("mml", {mml}, mwav);\n    m.on("ended", playNext);\n    m.start();\n    $MMLS[id()]=this;\n}\n\\id() {\n    if (!_id) _id=rnd()+"";\n    return _id;\n}\n\\bufferCount() {\n    return mmlBuf.length;\n}\n\\isPlaying() {\n    return m;\n}\n\\currentTime() {\n    if (m) return m.currentTime+cTimeBase;\n    return -1;\n}\n\\stop() {\n    if (m) {\n        if (mwav) {\n            mwav.pause();\n            mwav.stop();\n        }\n        m.pause();\n        m.stop();\n        m=null;\n        mmlBuf=[];\n        //print("stop!", id(), bufferCount());\n        delete $MMLS[id()];\n    }\n}\n',"Map.tonyu":'native Math;\nnative $;\n\\new (param){\n    sx=0;\n    sy=0;\n    super(param);\n    buf=$("<canvas>").attr{width:col*chipWidth,height:row*chipHeight};\n    mapObj=true;\n    mapTable = [];\n    mapOnTable = [];\n    for(var j=0;j<row;j++){\n        rows = [];\n        for(var i=0;i<col;i++){\n            rows.push(-1);\n        }\n        mapTable.push(rows);\n    }\n    for(var j=0;j<row;j++){\n        rows = [];\n        for(var i=0;i<col;i++){\n            rows.push(-1);\n        }\n        mapOnTable.push(rows);\n    }\n    /*for(var i=0;i<col;i++){\n        mapTable[i]=[];\n    }*/\n    initMap();\n}\n\\initMap(){\n    if(!mapData) return;\n    for(var i=0;i<row;i++){\n        for(var j=0;j<col;j++){\n            set(j,i,mapData[i][j]);\n        }\n    }\n    if(!mapOnData) return;\n    for(var i=0;i<row;i++){\n        for(var j=0;j<col;j++){\n            setOn(j,i,mapOnData[i][j]);\n        }\n    }\n}\n\\load(dataFile){\n    baseData=file("../maps/").rel(dataFile).obj();\n    if(!baseData) baseData=file(dataFile).obj();\n    mapTable=baseData[0];\n    mapData=mapTable;\n    row=mapTable.length;\n    col=mapTable[0].length;\n    mapOnTable=baseData[1];\n    mapOnData=mapOnTable;\n    buf=$("<canvas>").attr{width:col*chipWidth,height:row*chipHeight};\n    initMap();\n}\n\\set(setCol,setRow,p){\n    if(setCol>=col || setRow>=row || setCol<0 || setRow<0) return;\n    mapTable[setRow][setCol]=p;\n    //mapOnTable[setRow][setCol]=-1;\n    ctx=buf[0].getContext("2d");\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) {\n        ctx.clearRect(setCol*chipWidth,setRow*chipHeight,chipWidth,chipHeight);\n        return;\n    }\n    ctx.clearRect(setCol*chipWidth,setRow*chipHeight,chipWidth,chipHeight);\n    ctx.save();\n    ctx.drawImage(\n    pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n    setCol*chipWidth, setRow*chipHeight, chipWidth, chipHeight);\n    ctx.restore();\n}\n\\setOn(setCol,setRow,p){\n    if(setCol>=col || setRow>=row || setCol<0 || setRow<0) return;\n    set(setCol,setRow,mapTable[setRow][setCol]);\n    mapOnTable[setRow][setCol]=p;\n    ctx=buf[0].getContext("2d");\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) return;\n    ctx.save();\n    ctx.drawImage(\n    pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n    setCol*chipWidth, setRow*chipHeight, chipWidth, chipHeight);\n    ctx.restore();\n}\n\\setOnAt(setX,setY,p){\n    setOn(Math.floor(setX/chipWidth),Math.floor(setY/chipHeight),p);\n}\n\\setAt(setX,setY,p){\n    set(Math.floor(setX/chipWidth),Math.floor(setY/chipHeight),p);\n}\n\\get(getCol,getRow){\n    if(getCol<col && getRow<row && getCol>=0 && getRow>=0) return mapTable[getRow][getCol];\n    return -1;\n}\n\\getAt(getX,getY){\n    return get(Math.floor(getX/chipWidth),Math.floor(getY/chipHeight));\n}\n\\getOn(getCol,getRow){\n    if(getCol<col && getRow<row && getCol>=0 && getRow>=0) return mapOnTable[getRow][getCol];\n    return -1;\n}\n\\getOnAt(getX,getY){\n    return getOn(Math.floor(getX/chipWidth),Math.floor(getY/chipHeight));\n}\n\\scrollTo(scrollX,scrollY){\n    sx=-scrollX;\n    sy=-scrollY;\n}\n\\draw(ctx) {\n    pImg=buf[0];\n    ctx.save();\n    ctx.drawImage(\n    pImg, 0, 0,col*chipWidth, row*chipHeight,\n    sx, sy, col*chipWidth, row*chipHeight);\n    ctx.restore();\n}\n',"MapEditor.tonyu":'native prompt;\nloadMode=false;\nprint("Load Data?: Y or N");\nwhile(true){\n    if(getkey("y")>0){\n        loadMode=true;\n        break;\n    }\n    if(getkey("n")>0){\n        loadMode=false;\n        break;\n    }\n    update();\n}\nif(loadMode){\n    fileName=prompt("Input json file (*.json)","map.json");\n    if(fileName){\n        mapDataFile=file("../maps/").rel(fileName);\n    }\n    if(mapDataFile.obj()){\n        baseData=mapDataFile.obj();\n    }else{\n        mapDataFile=file(fileName);\n        if(mapDataFile.obj()){\n            baseData=mapDataFile.obj();\n        }\n    }\n    if(baseData==undefined){\n        print("Load failed");\n        loadMode=false;\n    }else if(baseData[0] && baseData[1]){\n        mapData=baseData[0];\n        mapOnData=baseData[1];\n    }\n}\nupdate();\n//if(mapData){\n    /*\n    print("Load Data?: Y or N");\n    while(true){\n        if(getkey("y")==1){\n            loadMode=true;\n            break;\n        }\n        if(getkey("n")==1){\n            loadMode=false;\n            break;\n        }\n    }*/\n//}\nif(!loadMode){\n    row=prompt("input row");\n    update();\n    col=prompt("input col");\n    panel=new Panel{width:col*32,height:row*32};\n    panel.x=panel.width/2+10;\n    panel.y=panel.height/2;\n    panel.setFillStyle("cyan");\n    panel.fillRect(0,0,panel.width,panel.height);\n    $map=new Map{row,col,chipWidth:32,chipHeight:32};\n}else{\n    if(!mapOnData){\n        $map=new Map{row:mapData.length,col:mapData[0].length,chipWidth:32,chipHeight:32,mapData};\n    }else{\n        $map=new Map{row:mapData.length,col:mapData[0].length,chipWidth:32,chipHeight:32,mapData,mapOnData};\n    }\n    panel=new Panel{width:$map.col*32,height:$map.row*32,zOrder:100};\n    panel.x=panel.width/2;\n    panel.y=panel.height/2;\n    panel.setFillStyle("cyan");\n    panel.fillRect(0,0,panel.width,panel.height);\n}\n$mp=new Map{row:16,col:8,chipWidth:32,chipHeight:32};\ncounter=0;\nfor(var i=0;i<16;i++){\n    for(var j=0;j<8;j++){\n        $mp.set(j,i,$pat_mapchip+counter);\n        counter++;\n    }\n}\nmode="get";\nprevMode="set";\nmapp=0;\nmx=0;\nmy=0;\nchipX=0;\nchipY=0;\nx=$screenWidth-16;\ny=$screenHeight-16;\nwhile(true){\n    p=mapp;\n    if(getkey("e")==1){\n        $mp.scrollTo(1000,1000);\n        mode="erase";\n        print(mode+" mode");\n    }\n    if(getkey("s")==1){\n        $mp.scrollTo(1000,1000);\n        if(mode=="set"){\n            mode="setOn";\n        }else{\n            mode="set";\n        }\n        print(mode+" mode");\n    }\n    if(getkey("o")==1){\n        $mp.scrollTo(1000,1000);\n        mode="setOn";\n    }\n    if(getkey("g")==1){\n        if(mode!="get"){\n            prevMode=mode;\n            $mp.scrollTo(0,0);\n            mode="get";\n            chipX=0;\n            chipY=0;\n        }else{\n            $mp.scrollTo(1000,1000);\n            mode=prevMode;\n        }\n        print(mode+" mode");\n    }\n    if(getkey("p")==1){\n        //add\n        saveFileName=prompt("input json file(*.json)","map.json");\n        /*print("mapTable=[");\n        data="[";\n        for(var i=0;i<$map.row-1;i++){\n            var tmp=[];\n            tmp=$map.mapTable[i].concat(tmp);\n            print("["+tmp+"],");\n            data+="["+tmp+"],";\n        }\n        var tmp=[];\n        tmp=$map.mapTable[i].concat(tmp);\n        print("["+tmp+"]");\n        data+="["+tmp+"]";\n        print("];");\n        data+="]";*/\n        //add\n        saveDataFile=file("../maps/").rel(saveFileName);\n        data=[$map.mapTable,$map.mapOnTable];\n        //comment\n        //mapDataFile.obj(data);\n        //add\n        saveDataFile.obj(data);\n        print(saveFileName+" Saved");\n        //mapDataFile.obj.push($map.mapOnTable);\n    }\n    if(getkey("c")==1){\n        $mp.scrollTo(1000,1000);\n        mode="spuit";\n        print(mode+" mode");\n    }\n    if(mode!="get"){\n        if(getkey("left")>0) mx=mx+8;\n        if(getkey("right")>0) mx=mx-8;\n        if(getkey("up")>0) my=my+8;\n        if(getkey("down")>0) my=my-8;\n        $map.scrollTo(mx,my);\n    }else{\n        if(getkey("left")>0) chipX=chipX+8;\n        if(getkey("right")>0) chipX=chipX-8;\n        if(getkey("up")>0) chipY=chipY+8;\n        if(getkey("down")>0) chipY=chipY-8;\n        $mp.scrollTo(chipX,chipY);\n    }\n    panel.x=panel.width/2-mx;\n    panel.y=panel.height/2-my;\n    if(mode=="set" && getkey(1)>0){\n        $map.setAt($mouseX+mx,$mouseY+my,mapp);\n        $map.setOnAt($mouseX+mx,$mouseY+my,-1);\n    }else if(mode=="erase" && getkey(1)>0){\n        $map.setAt($mouseX+mx,$mouseY+my,-1);\n    }else if(mode=="get" && getkey(1)>0){\n        mapp=$mp.getAt($mouseX+chipX,$mouseY+chipY);\n        mode=prevMode;\n        $mp.scrollTo(1000,1000);\n        print(mode+" mode");\n        updateEx(10);\n    }else if(mode=="setOn" && getkey(1)>0){\n        $map.setOnAt($mouseX+mx,$mouseY+my,mapp);\n    }else if(mode=="spuit" && getkey(1)>0){\n        mapp=$map.getAt($mouseX+mx,$mouseY+my);\n        mode="set";\n        print(mode+" mode");\n        updateEx(10);\n    }\n    update();\n}',"MathMod.tonyu":'extends null;\nnative Math;\n\n\\sin(d) {\n    return Math.sin(rad(d));\n}\n\\cos(d) {\n    return Math.cos(rad(d));\n}\n\\rad(d) {\n    return d/180*Math.PI;\n}\n\\deg(d) {\n    return d/Math.PI*180;\n}\n\n\\abs(v) {\n    return Math.abs(v);\n}\n\\atan2(x,y) {\n    return deg(Math.atan2(x,y));\n}\n\\floor(x) {\n    return Math.floor(x);\n}\n\\angleDiff(a,b) {\n    var c;\n    a=floor(a);\n    b=floor(b);\n    if (a>=b) {\n        c=(a-b) % 360;\n        if (c>=180) c-=360;\n    } else {\n        c=-((b-a) % 360);\n        if (c<-180) c+=360;\n    }\n    return c;\n}\n\\sqrt(t) {\n    return Math.sqrt(t);\n}\n\\dist(dx,dy) {\n    if (typeof dx=="object") {\n        var t=dx;\n        dx=t.x-x;dy=t.y-y;\n    }\n    return sqrt(dx*dx+dy*dy);\n}',"NoviceActor.tonyu":"extends BaseActor;\nnative Tonyu;\n\n\\sleep(n) {\n    if(!n) n=1;\n    for(n;n>0;n--) update();\n}\n\\initSprite() {\n    if (!_sprite) {\n        _sprite=new BaseActor{owner:this};// Sprites.add{owner:this};\n        $Sprites.add(this);\n    }\n}\n\\say(text,size) {\n    if (!size) size=15;\n    initSprite();\n    _sprite._fukidashi={text:text, size:size, c:30};\n}\n\\sprite(x,y,p) {\n    go(x,y,p);\n}\n\\show(x,y,p) {\n    go(x,y,p);\n}\nnowait \\draw(ctx) {\n    _sprite.draw(ctx);\n}\n\\getCrashRect() {\n    return _sprite.getCrashRect();\n}\n\\go(x,y,p) {\n    initSprite();\n    _sprite.x=x;\n    _sprite.y=y;\n    if (p!=null) _sprite.p=p;\n    //update();\n}\n\\change(p) {\n    initSprite();\n    _sprite.p=p;\n}","Pad.tonyu":"\\new(opt) {\n    super(opt);\n    padImageP = $pat_inputPad;\n    jujiKey = new Actor{x:96+1, y:$screenHeight-96-1, p:padImageP+0,zOrder:-9,layer:$FrontSprites};\n    no1Key = new Actor{x:$screenWidth-96, y:$screenHeight-96, p:padImageP+1,zOrder:-9,layer:$FrontSprites};\n    jujiKey.show();\n    no1Key.show();\n    \n    jujiKeyPushU = new Actor{x:jujiKey.x, y:jujiKey.y-60, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushL = new Actor{x:jujiKey.x-60, y:jujiKey.y, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushR = new Actor{x:jujiKey.x+60, y:jujiKey.y, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushD = new Actor{x:jujiKey.x, y:jujiKey.y+60, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPush1 = new Actor{x:no1Key.x, y:no1Key.y, p:padImageP+2, scaleX:2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushU.hide();\n    jujiKeyPushL.hide();\n    jujiKeyPushR.hide();\n    jujiKeyPushD.hide();\n    jujiKeyPush1.hide();\n}\n\\die(){\n    jujiKey.die();\n    no1Key.die();\n    jujiKeyPushU.die();\n    jujiKeyPushL.die();\n    jujiKeyPushR.die();\n    jujiKeyPushD.die();\n    jujiKeyPush1.die();\n    super.die();\n}\nAPAD_DIAG_SIZE = 96;\n\\padUpdate() {\n    // 操作 //\n    keyPushL = 0;\n    keyPushR = 0;\n    keyPushU = 0;\n    keyPushD = 0;\n    keyPush1 = 0;\n    \n    padKeyNotapCnt ++;\n    for (var i=0; i<5; i++) { // タップ判定・マウス判定 //\n        var t = $touches[i];\n        if (t.touched) {\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-APAD_DIAG_SIZE/2, jujiKey.y-32-64, 64+APAD_DIAG_SIZE, 64)) keyPushU = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-APAD_DIAG_SIZE/2, jujiKey.y-32+64, 64+APAD_DIAG_SIZE, 64)) keyPushD = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-64, jujiKey.y-32-APAD_DIAG_SIZE/2, 64, 64+APAD_DIAG_SIZE)) keyPushL = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32+64, jujiKey.y-32-APAD_DIAG_SIZE/2, 64, 64+APAD_DIAG_SIZE)) keyPushR = 1;\n            if (isOnRectWH(t.x, t.y, no1Key.x-64, no1Key.y-64, 128, 128)) keyPush1 = 1;\n            padKeySW = 1;\n            padKeyNotapCnt = 0;\n        }\n    }\n    \n    // カウントアップ\n    if (keyPushL) keyCntL ++; else keyCntL = 0;\n    if (keyPushR) keyCntR ++; else keyCntR = 0;\n    if (keyPushU) keyCntU ++; else keyCntU = 0;\n    if (keyPushD) keyCntD ++; else keyCntD = 0;\n    if (keyPush1) keyCnt1 ++; else keyCnt1 = 0;\n    \n    // 表示\n    if (keyPushL) jujiKeyPushL.show(); else jujiKeyPushL.hide();\n    if (keyPushR) jujiKeyPushR.show(); else jujiKeyPushR.hide();\n    if (keyPushU) jujiKeyPushU.show(); else jujiKeyPushU.hide();\n    if (keyPushD) jujiKeyPushD.show(); else jujiKeyPushD.hide();\n    if (keyPush1) jujiKeyPush1.show(); else jujiKeyPush1.hide();\n    \n}\n\n\\getPadUp()    { return keyCntU; }\n\\getPadDown()  { return keyCntD; }\n\\getPadLeft()  { return keyCntL; }\n\\getPadRight() { return keyCntR; }\n\\getPadButton(i) {\n    var value;\n    if (i == 0) value = keyCnt1;\n    return value;\n}\n\n\\getUp()    { return keyCntU; }\n\\getDown()  { return keyCntD; }\n\\getLeft()  { return keyCntL; }\n\\getRight() { return keyCntR; }\n\\getButton(i) {\n    var value;\n    if (i == 0) value = keyCnt1;\n    return value;\n}\n\n// 範囲 //\n\\isOnRect(mx, my, rx, ry, rx2, ry2) {\n    return (rx <= mx && mx < rx2 && ry <= my && my < ry2);\n}\n\n// 範囲 //\n\\isOnRectWH(mx, my, rx, ry, rw, rh) {\n    return (rx <= mx && mx < rx+rw && ry <= my && my < ry+rh);\n}\n\nwhile(true) {\n    padUpdate();\n    update();\n}","Panel.tonyu":'native $;\nnative Math;\nnative isNaN;\n\\new(opt){\n    super(opt);\n    this.width=width;\n    this.height=height;\n    if(align==null) align="center";\n    if(alpha==null) alpha=255;\n    buf=$("<canvas>").attr{width,height};\n}\n\\setPanel(width,height){\n    this.width=width;\n    this.height=height;\n    buf=$("<canvas>").attr{width,height};\n}\n\\setFillStyle(color){\n    this.color=color;\n}\n\\fillRect(x,y,rectWidth,rectHeight){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    //ctx.clearRect(0,0,this.width,this.height);\n    ctx.fillStyle=color;\n    ctx.fillRect(x,y,rectWidth,rectHeight);\n    ctx.restore();\n}\n\\fillText(text,x,y,size,align){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    //ctx.clearRect(0,0,this.width,this.height);\n    ctx.textAlign = align;\n    ctx.fillStyle=color;\n    ctx.font=size+"px \'Courier New\'";\n    ctx.fillText(text,x,y);\n    ctx.restore();\n}\n\\clearRect(clearX,clearY,clearW,clearH){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    ctx.clearRect(clearX,clearY,clearW,clearH);\n    ctx.restore();\n}\n\\getPixel(getX,getY){\n    if(typeof getX=="number" && !isNaN(getX) && \n    typeof getY=="number" && !isNaN(getY)){\n        ctx=buf[0].getContext("2d");\n        imagedata=ctx.getImageData(getX,getY,1,1);\n        colordata=[imagedata.data[0],imagedata.data[1],imagedata.data[2],imagedata.data[3]];\n        //print(imagedata.data);\n    }else{\n        colordata=[0,0,0,0];\n    }\n    return(colordata);\n}\n\\scroll(scrollX,scrollY){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    imagedata=ctx.getImageData(0,0,this.width,this.height);\n    clearRect(0,0,width,height);\n    ctx.putImageData(imagedata,-scrollX,-scrollY);\n    ctx.restore();\n}\n\\draw(ctx){\n    pImg=buf[0];\n    ctx.save();\n    if(align=="left"){\n        ctx.translate(x+width/2,y+height/2);\n    }else if(align=="center"){\n        ctx.translate(x,y);\n    }else if(align=="right"){\n        ctx.translate(x-width/2,y-height/2);\n    }\n    if(this.rotation!=0){\n        ctx.rotate(this.rotation/180*Math.PI);\n    }else{\n        ctx.rotate(this.rotate/180*Math.PI);\n    }\n    ctx.globalAlpha=this.alpha/255;\n    ctx.drawImage(\n    pImg, 0, 0,width,height,\n    -width/2, -height/2, width ,height);\n    ctx.restore();\n}',"ScaledCanvas.tonyu":'native $;\nnative Math;\n\n// canvas:phisical  buf: logical\n\\new (opt) {\n    extend(opt);\n    // canvas/ width,height\n    resize(width, height);\n    cw=canvas.width();\n    ch=canvas.height();\n    cctx=canvas[0].getContext("2d");\n    this.color="rgb(20,80,180)";\n    sx=0;\n    sy=0;\n    isDrawGrid=$Sprites.isDrawGrid;\n}\n\\resize(width,height) {\n    this.width=width;\n    this.height=height;\n    buf=$("<canvas>").attr{width,height};\n    ctx=buf[0].getContext("2d");  \n    $screenWidth=width;\n    $screenHeight=height;\n    if($panel){\n        $panel.setPanel($screenWidth,$screenHeight);\n    }\n}\n\\shouldDraw1x1(srcw,srch,dstw,dsth) {\n    // srcw=465 -> dstw=460...665\n    var larger=200;\n    var smaller=5;\n    return srcw-smaller<=dstw && dstw<=srcw+larger &&\n    srch-smaller<=dsth && dsth<=srch+larger;\n}\n\\draw() {\n    cw=canvas.width();\n    ch=canvas.height();\n    var calcw=ch/height*width; // calch=ch\n    var calch=cw/width*height; // calcw=cw\n    if (calch>ch) calch=ch;\n    if (calcw>cw) calcw=cw;\n    cctx.clearRect(0,0,cw,ch);\n    if (shouldDraw1x1(width,height,calcw,calch)) {\n        calcw=width;calch=height;\n    }\n    var marginw=Math.floor((cw-calcw)/2);\n    var marginh=Math.floor((ch-calch)/2);\n    cctx.drawImage(buf[0],\n    0,0,width, height, \n    marginw,marginh,calcw, calch );\n}\n\\canvas2buf(point) {\n    var calcw=ch/height*width; // calch=ch\n    var calch=cw/width*height; // calcw=cw\n    if (calch>ch) calch=ch;\n    if (calcw>cw) calcw=cw;\n    if (shouldDraw1x1(width,height,calcw,calch)) {\n        calcw=width;calch=height;\n    }\n    var marginw=Math.floor((cw-calcw)/2);\n    var marginh=Math.floor((ch-calch)/2);\n    \n    return {x: (point.x-marginw)/calcw*width, \n    y: (point.y-marginh)/calch*height};\n}\n\\setBGColor(color){\n    this.color=color;\n}\n\\fillCanvas(cv){\n    var ctx=cv.getContext("2d");\n    ctx.save();\n    ctx.fillStyle=$Screen.color;\n    ctx.fillStyle=color;\n    ctx.fillRect(0,0,cv.width,cv.height);\n    if (isDrawGrid) drawGrid(cv);\n    ctx.restore();\n}\n\\scrollTo(scrollX,scrollY){\n    /*for(o in all()){\n        //print(o.mapObj);\n        if(o.mapObj){\n            o.scrollTo(o.sx+scrollX,o.sy+scrollY);\n        }else if(o.x!=undefined && o.y!=undefined){\n            o.x+=scrollX;\n            o.y+=scrollY;\n        }\n    }*/\n    //sx=scrollX;\n    //sy=scrollY;\n    $Sprites.scrollTo(scrollX,scrollY);\n}',"Sprites.tonyu":'native Tonyu;\n\\new() {\n    sprites=[];\n    imageList=[];\n    hitWatchers=[];\n    isDrawGrid=Tonyu.noviceMode;\n    sx=0;\n    sy=0;\n    objId=0;\n}\nfunction add(s) {\n    if (s.__addedToSprites) return;\n    sprites.push(s);\n    if(s.__genId==null){\n        s.__genId=objId;\n        objId++;\n    }\n    s.__addedToSprites=this;\n    return s;\n}\nfunction remove(s) {\n    var idx=sprites.indexOf(s);\n    if (idx<0) return;\n    sprites.splice(idx,1);\n    delete s.__addedToSprites;\n}\nfunction clear() {sprites.splice(0,sprites.length);}\nfunction compOrder(obj1, obj2){\n    var val1=obj1.zOrder;\n    var val2=obj2.zOrder;\n    if(val1>val2){\n        return -1;\n    }else if(val1<val2){\n        return 1;\n    }else if(val1==val2){\n        if(obj1.__genId>obj2.__genId){\n            return 1;\n        }else{\n            return -1;\n        }\n        return 0;\n    }\n}\nfunction draw(cv) {\n    var ctx=cv.getContext("2d");\n    ctx.save();\n    /*\n    ctx.fillStyle=$Screen.color;\n    ctx.fillRect(0,0,cv.width,cv.height);\n    if (isDrawGrid) drawGrid(cv);\n    */\n    var orderArray=[];\n    orderArray=orderArray.concat(sprites);\n    orderArray.sort(compOrder);\n    ctx.translate(-sx,-sy);\n    orderArray.forEach(\\(s){\n        s.draw(ctx);\n    });\n    ctx.restore();\n}\nfunction checkHit() {\n    hitWatchers.forEach(function (w) {\n        sprites.forEach(function (a) {\n            //console.log("a:",  a.owner);\n            var a_owner=a;//a.owner|| a;\n            if (! (a_owner instanceof w.A)) return;\n            sprites.forEach(function (b) {\n                var b_owner=b;//b.owner|| b;\n                if (a===b) return;\n                if (! (b_owner instanceof w.B)) return;\n                //console.log("b:",  b.owner);\n                if (a.crashTo1(b)) {\n                    //console.log("hit", a.owner, b.owner);\n                    w.h(a_owner,b_owner);\n                }\n            });\n        });\n    });\n}\nfunction watchHit(typeA, typeB, onHit) {\n    var p={A: typeA, B:typeB, h:onHit};\n    //console.log(p);\n    hitWatchers.push(p);\n}\nfunction drawGrid(c) {\n    var ctx=c.getContext("2d");\n    ctx.textBaseline="top";\n    ctx.save();\n    ctx.strokeStyle="rgb(40,100,200)";\n    for (var i=0 ; i<c.width ; i+=10) {\n        ctx.beginPath();\n        ctx.lineWidth=(i % 100 ==0 ? 4 : 1);\n        ctx.moveTo(i,0);\n        ctx.lineTo(i,c.height);\n        ctx.closePath();\n        ctx.stroke();\n    }\n    \n    for (var i=0 ; i<c.height ; i+=10) {\n        ctx.beginPath();\n        ctx.lineWidth=(i % 100 ==0 ? 4 : 1);\n        ctx.moveTo(0,i);\n        ctx.lineTo(c.width,i);\n        ctx.closePath();\n        ctx.stroke();\n    }\n    ctx.fillStyle="white";\n    ctx.font="15px monospaced";\n    for (var i=100 ; i<c.width ; i+=100) {\n        ctx.fillText(i, i,0);\n    }\n    for (var i=100 ; i<c.height ; i+=100) {\n        ctx.fillText(i, 0,i);\n    }\n    ctx.restore();\n}\nfunction setImageList(il) {\n    imageList=il;\n}\nfunction getImageList() {\n    return imageList;\n}\nfunction scrollTo(scrollX,scrollY){\n    sx=scrollX;\n    sy=scrollY;\n}',"TObject.tonyu":'native Tonyu;\n\\new (options) {\n    if (typeof options=="object") extend(options);\n    this.main();\n}\nnowait \\extend(obj) {\n    return Tonyu.extend(this,obj);\n}',"TQuery.tonyu":'extends TObject;\nincludes MathMod;\n\\new () {\n    length=0;\n}\n\\tonyuIterator(arity) {\n    var res={};\n    res.i=0;\n    if (arity==1) {\n        res.next=function () {\n            if (res.i>=this.length) return false;\n            res[0]=this[res.i];\n            res.i++;\n            return true;\n        };\n    } else {\n        res.next=function () {\n            if (res.i>=this.length) return false;\n            res[0]=res.i;\n            res[1]=this[res.i];\n            res.i++;\n            return true;\n        };\n    }\n    return res;\n}\n\\attr() {\n    var values;\n    if (length==0) return;\n    if (arguments.length==1 && typeof arguments[0]=="string") {\n        return this[0][arguments[0]];\n    }\n    if (arguments.length>=2) {\n        values={};\n        for (var i=0 ; i<arguments.length-1 ;i+=2) {\n            values[arguments[i]]=arguments[i+1];\n        }\n    } else {\n        values=arguments[0];\n    }\n    if (values) {\n        for (var e in this) {\n            e.extend( values);\n        }\n    }\n}\n\\genKeyfunc(key) {\n    if (typeof key!="function") {\n        return \\(o) {return o[key];};\n    } else {\n        return key;\n    }\n}\n\\maxs(key) {\n    var f=genKeyfunc(key);\n    var res,reso=new TQuery;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v>=res) {\n            if (v>res) reso=new TQuery;\n            reso.push(o);\n            res=v;\n        }\n    }\n    return reso;\n}\n\\mins(key) {\n    var f=genKeyfunc(key);\n    var res,reso=new TQuery;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v<=res) {\n            if (v<res) reso=new TQuery;\n            reso.push(o);\n            res=v;\n        }\n    }\n    return reso;\n}\n\\minObj(key) {\n    return mins(key)[0];\n}\n\\maxObj(key) {\n    return maxs(key)[0];\n}\n\\nearests(x,y) {\n    if (typeof x=="object") {y=x.y;x=x.x;}\n    return mins \\(o) {\n        return dist(o.x-x,o.y-y);\n    };\n}\n\\nearest(x,y) {\n    return nearests(x,y)[0];\n}\n\\withins(xo,yd,d) {\n    var x,y;\n    if (typeof xo=="object") {\n        x=xo.x;y=xo.y;d=yd;\n    } else {\n        x=xo;y=yd;\n    }\n    return find \\(o) {\n        return dist(o.x-x,o.y-y)<=d;\n    };\n}\n\\within(xo,yd,d) {\n    return withins(xo,yd,d).nearest();\n}\n\n\\max(key) {\n    var f=genKeyfunc(key);\n    var res;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v>res) res=v;\n    }\n    return res;\n}\n\\min(key) {\n    var f=genKeyfunc(key);\n    var res;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v<res) res=v;\n    }\n    return res;\n}\n\\push(e) {\n    this[length]=e;\n    length++;\n}\n\\size() {return length;}\n\\find(f) {\n    var no=new TQuery;\n    for (var o in this) {\n        if (f(o)) no.push(o);\n    }\n    return no;\n} \n\\apply(name, args) {\n    var res;\n    if (!args) args=[];\n    for (var o in this) {\n        var f=o[name];\n        if (typeof f=="function") {\n            res=f.apply(o, args);\n        }\n    }\n    return res;\n}\n// \\alive => find \\(o) => !o.isDead()  //  (in future)\n\\alive() {\n    return find \\(o) {\n        return !o.isDead();\n    };\n}\n\\die() {\n    var a=alive();\n    if (a.length==0) return false;\n    a.apply("die");\n    return true;\n}\n\n\\klass(k) {\n    return find \\(o) { return o instanceof k; };\n}',"WaveTable.tonyu":'extends TObject;\nnative T;\n\nwav={};\nenv={};\n\\setWav(num, synth) {\n    wav[num]=synth;\n}\n\\setEnv(num, synth) {\n    env[num]=synth;\n}\n\\get(w,e) {\n    var synth=T("OscGen") {osc:wav[w], env:env[e], mul:0.25};\n    return synth;\n}\n\\stop() {\n    /*for (var k,v in tbl) {\n        v.pause();\n        v.stop();\n    }*/\n}\n\nif (typeof T!=="undefined") {\n    //env=T("adsr", {a:0,d:200,s:0.5,r:10});\n    env = T("env",{table:[1, [0.6, 50], [0, 100]], releaseNode:2});\n    setEnv(0, env);\n    setWav(0, T("pulse"));\n    //    synth=T("OscGen") {wave:"pulse", env, mul:0.25};\n    //set(0,synth);    \n}\n'}};
(WebSite.devMode||WebSite.disableROM["ROM_k.js"])&&(n.base="/ROM"+n.base),FS.mountROM(n)}(),requireSimulator.setName("Tonyu"),Tonyu=function(){function n(){function n(){return null!=h&&d}function e(){return v}function t(){m=0}function r(n){h={prev:h,func:n}}function a(){h&&h.func(p)}function s(n){h=h.prev,c=n}function o(e){v=!0,e&&e.addTerminatedListener&&e.addTerminatedListener(function(){if(v=!1,p.group)p.group.notifyResume();else if(n())try{p.steps()}catch(e){i(e)}})}function u(n){p.group=n,n&&n.add(p)}function c(){return c}function l(){var n=Tonyu.currentThread;for(Tonyu.currentThread=p,m=x;m-->0;)a();Tonyu.currentThread=n}function f(){d=!1}var c,p={enter:r,exit:s,steps:l,step:a,isAlive:n,isWaiting:e,suspend:t,retVal:c,kill:f,waitFor:o,setGroup:u},h=null,d=!0,m=0,v=!1;return p}function e(n){var e={},t=[];return e.addTerminatedListener=function(n){t.push(n)},setTimeout(function(){t.forEach(function(n){n()})},n),e}function t(){var n=[],e=[],t=!1;return n.addTerminatedListener=function(n){t?setTimeout(n,0):e.push(n)},n.receiver=function(){t=!0;for(var e=0;e<arguments.length;e++)n[e]=arguments[e];n.notify()},n.notify=function(){e.forEach(function(n){n()})},n}function r(){function e(n){n.group=u,p?p.push(n):c.push(n)}function t(t,r){var i=n();return r||(r="main"),i.enter(t["fiber$"+r]()),e(i),i}function r(){try{a()}catch(n){i(n)}}function a(){function n(n){n.isWaiting()||(f=!1,n.steps())}for(var e=c.length-1;e>=0;e--){var t=c[e];t.isAlive()&&t.group===u||c.splice(e,1)}for(f=!0,p=[],c.forEach(n);p.length>0;)w=p,p=[],w.forEach(function(e){c.push(e),n(e)});p=null}function s(){l=!1}function o(){}var u,c=[],l=!0,f=!1,p=null;return u={add:e,addObj:t,steps:r,kill:s,notifyResume:o}}function i(n){if(!Tonyu.onRuntimeError)throw alert("エラー! at "+$LASTPOS+" メッセージ  : "+n),n;Tonyu.onRuntimeError(n)}function a(n){if(n===Function)return null;if("function"==typeof n)n.constructor=null;else if("object"==typeof n)for(var e in n)n[e]=a(n[e]);return n}function s(){var n,e,t=[];if(1==arguments.length)e=arguments[0];else if(2==arguments.length&&"function"==typeof arguments[0])n=arguments[0],e=arguments[1];else if(2==arguments.length&&arguments[0]instanceof Array)t=arguments[0],e=arguments[1];else{if(3!=arguments.length)throw console.log(arguments),"Invalid argument spec";if(n=arguments[0],!n)throw"No parent class";t=arguments[1],e=arguments[2]}e=a(e);var r=e.initialize?e.initialize:n?function(){n.apply(this,arguments)}:function(){};return delete e.initialize,t.forEach(function(n){if(!n.methods)throw n+" Does not have methods";for(var t in n.methods)t in e||(e[t]=n.methods[t])}),r.methods=e,r.prototype=o(n,e),r.prototype.isTonyuObject=!0,r}function o(n,e){return n?u(new n,e):e}function u(n,e){if(e&&"object"==typeof e)for(var t in e)n[t]=e[t];return n}function c(n,e){b[n]=e}function l(n){return b[n]}function f(n){return T[n]}function p(n,e){return function(){return e.apply(n,arguments)}}function h(n,e,t,r){if(!n)throw new Error(r+"(="+n+")のメソッド "+e+"を呼び出せません");var i=n[e];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+e+"(="+i+")はメソッドではありません");return i.apply(n,t)}function d(n,e,t){if("function"!=typeof n)throw new Error(t+"は関数ではありません");return n.apply({},e)}function m(n,e){if(n!=n||null==n)throw new Error(e+"(="+n+")は初期化されていません");return n}function v(n){for(var e=[],t=0;t<n.length;t++)e[t]=n[t];return e}function g(n){throw console.log("Not a tonyu object: ",n),n+" is not a tonyu object"}function y(n,e){return n in e}var x=60,b={},T={};return Tonyu={thread:n,threadGroup:r,klass:s,bless:o,extend:u,globals:b,classes:T,setGlobal:c,getGlobal:l,getClass:f,timeout:e,asyncResult:t,bindFunc:p,not_a_tonyu_object:g,hasKey:y,invokeMethod:h,callFunc:d,checkNonNull:m,A:v}}(),requireSimulator.setName("Tonyu.Iterator"),define(["Tonyu"],function(){function n(n,e){var t={};if(n.tonyuIterator)return n.tonyuIterator(e);if(n instanceof Array)t.i=0,t.next=1==e?function(){return t.i>=n.length?!1:(this[0]=n[t.i],t.i++,!0)}:function(){return t.i>=n.length?!1:(this[0]=t.i,this[1]=n[t.i],t.i++,!0)};else{if(!(n instanceof Object))throw console.log(n),"Cannot iterable";t.i=0;var r=[];if(1==e){for(var i in n)r.push(i);t.next=function(){return t.i>=r.length?!1:(this[0]=r[t.i],t.i++,!0)}}else{for(var i in n)r.push([i,n[i]]);t.next=function(){return t.i>=r.length?!1:(this[0]=r[t.i][0],this[1]=r[t.i][1],t.i++,!0)}}}return t}return Tonyu.iterator=n,n}),requireSimulator.setName("IndentBuffer"),IndentBuffer=function(){var n=function(){function e(){i++;var n=t[i];if(null==n)throw console.log(t),i+"th null param: fmt="+r;return n}for(var t=arguments,r=t[0],i=0;;){var a=r.indexOf("%");if(0>a){n.buf+=r;break}n.buf+=r.substring(0,a),a++;var s=r.charAt(a);if("s"==s){var o=e();"string"==typeof o||"number"==typeof o||(null==o?o="null":o.text&&(o=o.text)),n.buf+=o,a++}else if("d"==s){var u=e();if("number"!=typeof u)throw u+" is not a number: fmt="+r;n.buf+=u,a++}else if("n"==s)n.ln(),a++;else if("{"==s)n.indent(),a++;else if("}"==s)n.dedent(),a++;else if("%"==s)n.buf+="%";else if("f"==s)e()(n),a++;else if("l"==s){var c=e();n.buf+=n.toLiteral(c),a++}else if("v"==s){var l=e();if(!l)throw"Null %v";if("object"!=typeof l)throw"nonobject %v:"+l;n.visitor.visit(l),a++}else if("z"==s){var f=e();if("val"in f)return void(n.buf+=f.val);f.gen||n.lazy(f),n.buf+=f.gen,a++}else if("j"==s){var p=e(),h=p[0],d=p[1],m=!1;if(!d||!d.forEach)throw console.log(d),d+" is not array. cannot join fmt:"+r;d.forEach(function(e){m&&n.printf(h),m=!0,n.visitor.visit(e)}),a++}else"D"==s?(e(),a++):a+=2;r=r.substring(a)}};return n.print=function(e){n.buf+=e},n.printf=n,n.buf="",n.lazy=function(e){return e||(e={}),e.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),e.reg=new RegExp(e.gen,"g"),e.put=function(e){return this.val=e,n.buf=n.buf.replace(this.reg,e),e},e},n.ln=function(){n.buf+="\n"+n.indentBuf},n.indent=function(){n.indentBuf+=n.indentStr,n.buf+="\n"+n.indentBuf},n.dedent=function(){var e=n.indentStr.length;if(!n.buf.substring(n.buf.length-e).match(/^\s*$/))throw console.log(n.buf),"Non-space truncated ";n.buf=n.buf.substring(0,n.buf.length-e),n.indentBuf=n.indentBuf.substring(0,n.indentBuf.length-e)},n.toLiteral=function(n,e){return e||(e="'"),n=n.replace(/\\/g,"\\\\"),n=n.replace(/\r/g,"\\r"),n=n.replace(/\n/g,"\\n"),n="'"==e?n.replace(/'/g,"\\'"):n.replace(/"/g,'\\"'),e+n+e},n.indentBuf="",n.indentStr="  ",n},requireSimulator.setName("disp"),requireSimulator.setName("Parser"),Parser=function(){function n(n,e){var t;for(t in e)n[t]=e[t];return n}function e(n){this.parse=i.options.traceTap?function(e){console.log("tap: name="+this.name+"  pos="+(e?e.pos:"?"));var t=n.apply(this,[e]),r="NOIMG";return t.src&&t.src.str&&(r=t.src.str.substring(t.pos-3,t.pos)+"^"+t.src.str.substring(t.pos,t.pos+3)),t.src&&t.src.tokens&&(r=t.src.tokens[t.pos-1]+"["+t.src.tokens[t.pos]+"]"+t.src.tokens[t.pos+1]),console.log("/tap: name="+this.name+" pos="+(e?e.pos:"?")+"->"+(t?t.pos:"?")+" "+r+" res="+(t?t.success:"?")),t}:n}function t(n,e){if(null==n)throw e+" is null!";return n}function r(n,e){null!=n&&(this.src={maxPos:0,global:e},"string"==typeof n&&(this.src.str=n),n instanceof Array&&(this.src.tokens=n),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:e,StringParser:a,nc:t};i.dispTbl=function(n){var e="",t={};if(!n)return e;for(var r in n){var i=n[r].name;t[i]||(t[i]=""),t[i]+=r}for(var i in t)e+=t[i]+"->"+i+",";return e},e.create=function(n){return new e(n)},i.create=e.create,n(e.prototype,{except:function(n){var t=this;return this.ret(e.create(function(e){return n.apply({},e.result)&&(e.success=!1),e}).setName("(except "+t.name+")"))},noFollow:function(n){var r=this;return t(n,"p"),this.ret(e.create(function(e){var t=n.parse(e);return e.success=!t.success,e}).setName("("+r.name+" noFollow "+n.name+")"))},andNoUnify:function(n){t(n,"next");var r=this,i=e.create(function(e){var t=r.parse(e);if(!t.success)return t;var i=n.parse(t);return i.success&&(i.result=t.result.concat(i.result)),i});return i.setName("("+this.name+" "+n.name+")")},and:function(n){var t=this.andNoUnify(n);if(!this._first)return t;var r=this._first.tbl,a={};for(var s in r)a[s]=r[s].andNoUnify(n);return t=e.fromFirst(this._first.space,a),t.setName("("+this.name+" >> "+n.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+t.name+" tbl="+i.dispTbl(a)),t},retNoUnify:function(n){var t,r=this;t="function"==typeof n?e.create(function(e){var t=e.clone();return t.result=[n.apply({},e.result)],t}).setName("retfunc"):n;var i=e.create(function(n){var e=r.parse(n);return e.success?t.parse(e):e}).setName("("+this.name+" >= "+t.name+")");return i},ret:function(n){if(!this._first)return this.retNoUnify(n);var t=this._first.tbl,r={};for(var a in t)r[a]=t[a].retNoUnify(n);return res=e.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+n.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(n,t){if(!i.options.optimizeFirst)return this;if(null==n)throw"Space is null2!";if("string"==typeof t){for(var r={},a=0;a<t.length;a++)r[t.substring(a,a+1)]=this;return e.fromFirst(n,r).setName("(fst "+this.name+")")}if(null==t)return e.fromFirst(n,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof t)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(n){if(!i.options.optimizeFirst)return this;"string"==typeof n&&(n=[n]);var t={};if(n){var r=this;n.forEach(function(n){t[n]=r})}else t.ALL=this;return e.fromFirstTokens(t).setName("(fstT "+this.name+")")},unifyFirst:function(t){function r(n,e){return n?e?n.orNoUnify(e).checkTbl():n:e}function a(){var n=t._first.tbl,e={};for(var i in s)e[i]=1;for(var i in n)e[i]=1;delete e.ALL,(s.ALL||n.ALL)&&(s.ALL=r(s.ALL,n.ALL));for(var i in e)s[i]&&n[i]?s[i]=r(s[i],n[i]):s[i]&&!n[i]?s[i]=r(s[i],n.ALL):!s[i]&&n[i]&&(s[i]=r(s.ALL,n[i]))}var s={};this.checkTbl(),t.checkTbl(),n(s,this._first.tbl),a();var o=e.fromFirst(this._first.space,s).setName("("+this.name+")U("+t.name+")");return i.options.verboseFirst&&console.log("Created unify name="+o.name+" tbl="+i.dispTbl(s)),o},or:function(n){return t(n,"other"),this._first&&n._first&&this._first.space&&this._first.space===n._first.space?this.unifyFirst(n):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+n.name+" "+this._first+" - "+n._first),this.orNoUnify(n))},orNoUnify:function(n){var t=this,r=e.create(function(e){var r=t.parse(e);if(r.success)return r;var i=n.parse(e);return i});return r.name="("+this.name+")|("+n.name+")",r},setName:function(n){return this.name=n,this._first,this},profile:function(n){return i.options.profile&&(this.parse=this.parse.profile(n||this.name)),this},repN:function(n){var t=this;n||(n=0);var r=e.create(function(e){for(var r=e,i=[];;){var a=t.parse(r);if(!a.success){var s;return i.length>=n?(s=r.clone(),s.result=[i],s.success=!0,s):(s=e.clone(),s.success=!1,s)}i.push(a.result[0]),r=a}});return r.setName("("+t.name+" * "+n+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var n=this;return e.create(function(e){var t=n.parse(e);return t.success?t:(e=e.clone(),e.success=!0,e.result=[null],e)}).setName("("+n.name+")?")},sep1:function(n,e){var r=this;t(r,"value"),t(n,"sep");var i=n.and(r).ret(function(n,t){return e?t:{sep:n,value:t}});return r.and(i.rep0()).ret(function(n,t){var r;if(e){var i=[n];for(r in t)i.push(t[r]);return i}return{head:n,tails:t}}).setName("(sep1 "+r.name+"~~"+n.name+")")},sep0:function(n){return this.sep1(n,!0).opt().ret(function(n){return n?n:[]})},tap:function(n){return this},retN:function(n){return this.ret(function(){return arguments[n]})},parseStr:function(n,e){var t=new r(n,e);return this.parse(t)},checkTbl:function(){if(!this._first)return this;var n=this._first.tbl;for(var e in n)if(!n[e].parse)throw this.name+": tbl."+e+" is not a parser :"+n[e];return this}}),n(r.prototype,{clone:function(){var n=new r;return n.src=this.src,n.pos=this.pos,n.result=this.result.slice(),n.success=this.success,n},updateMaxPos:function(n){n>this.src.maxPos&&(this.src.maxPos=n)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),e.fromFirst=function(n,t){if("TOKEN"==n)return e.fromFirstTokens(t);var r=e.create(function(e){var r=n.parse(e),a=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+a+" tbl="+(t[a]?t[a].name:"-")),t[a]?t[a].parse(r):t.ALL?t.ALL.parse(r):(r.success=!1,r)});return r._first={space:n,tbl:t},r.checkTbl(),r},e.fromFirstTokens=function(n){var t=e.create(function(e){var t=e.src.tokens[e.pos],r=t?t.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(n[r]?n[r].name:"-")),null!=r&&n[r]?n[r].parse(e):n.ALL?n.ALL.parse(e):(e.success=!1,e)});return t._first={space:"TOKEN",tbl:n},t.checkTbl(),t};var a={empty:e.create(function(n){var e=n.clone();return e.success=!0,e.result=[null],e}).setName("E"),fail:e.create(function(n){return n.success=!1,n}).setName("F"),str:function(n){return this.strLike(function(e,t){return e.substring(t,t+n.length)===n?{len:n.length}:null}).setName(n)},reg:function(n){return(n+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(n+"")),this.strLike(function(e,t){var r=n.exec(e.substring(t));return r?(r.len=r[0].length,r):null}).setName(n+"")},strLike:function(t){return e.create(function(e){var r=e.src.str;if(null==r)throw"strLike: str is null!";var a=e.pos,s=t(r,a,e);if(i.options.traceToken&&console.log("pos="+a+" r="+s),s){i.options.traceToken&&console.log("str:succ"),s.pos=a,s.src=e.src;var o=e.clone();return n(o,{pos:a+s.len,success:!0,result:[s]}),e.updateMaxPos(o.pos),o}return i.options.traceToken&&console.log("str:fail"),e.success=!1,e}).setName("STRLIKE")},parse:function(n,e,t){var i=new r(e,t);return n.parse(i)}};a.eof=a.strLike(function(n,e){return e==n.length?{len:0}:null}).setName("EOF"),i.StringParser=a;var s={token:function(n){return e.create(function(e){var t=e.src.tokens[e.pos];return e.success=!1,t?(t.type==n&&(e=e.clone(),e.updateMaxPos(e.pos),e.pos++,e.success=!0,e.result=[t]),e):e}).setName(n).firstTokens(n)},parse:function(n,e,t){var i=new r(e,t);return n.parse(i)},eof:e.create(function(n){return n.success=n.pos>=n.src.tokens.length,n}).setName("EOT")};return i.TokensParser=s,i.lazy=function(n){var t=null;return e.create(function(e){if(t||(t=n()),!t)throw n+" returned null!";return this.name=n.name,t.parse(e)}).setName("LZ")},i.addRange=function(n,e){if(null==e)return n;if("number"!=typeof n.pos)return n.pos=e.pos,n.len=e.len,n;var t=e.pos+e.len,r=n.pos+n.len;return e.pos<n.pos&&(n.pos=e.pos),t>r&&(n.len=t-n.pos),n},i.setRange=function(n){if(null!=n&&"string"!=typeof n&&"number"!=typeof n&&"boolean"!=typeof n){var e=i.getRange(n);if(null!=e)return n;for(var t in n)if(n.hasOwnProperty(t)){var r=i.setRange(n[t]);i.addRange(n,r)}return n}},i.getRange=function(n){return null==n?null:"number"!=typeof n.pos?null:"number"==typeof n.len?n:null},i}(),requireSimulator.setName("Grammar"),Grammar=function(){function n(n){return"string"==typeof n?t.get(n):n}var e=Parser,t=null;return t=function(e){var r={};return r.ands=function(){for(var r=n(arguments[0]),i=1;i<arguments.length;i++)r=r.and(n(arguments[i]));r=r.tap(e),t.defs[e]=r;var a={};return a.autoNode=function(){var n=r.ret(function(){for(var n={type:e},t=0;t<arguments.length;t++){var r=arguments[t],i=Parser.setRange(r);Parser.addRange(n,i),n["-element"+t]=r}n.toString=function(){return"("+this.type+")"}}).setName(e);return t.defs[e]=n},a.ret=function(n){if(0==arguments.length)return r;if("function"==typeof n)return t.defs[e]=r.ret(n);for(var i=[],a=function(n){return n},s=0;s<arguments.length;s++){if("function"==typeof arguments[s]){a=arguments[s];break}i[s]=arguments[s]}var o=r.ret(function(){var n={type:e};n[Grammar.SUBELEMENTS]=[];for(var t=0;t<arguments.length;t++){var r=arguments[t],s=Parser.setRange(r);Parser.addRange(n,s),i[t]&&(n[i[t]]=r),n[Grammar.SUBELEMENTS].push(r)}return n.toString=function(){return"("+this.type+")"},a(n)}).setName(e);return t.defs[e]=o},a},r.ors=function(){for(var r=n(arguments[0]),i=1;i<arguments.length;i++)r=r.or(n(arguments[i]));return t.defs[e]=r.setName(e)},r},t.defs={},t.get=function(n){return t.defs[n]?t.defs[n]:e.lazy(function(){var e=t.defs[n];if(!e)throw"grammar named '"+n+"' is undefined";return e}).setName("(Lazy of "+n+")")},t},Grammar.SUBELEMENTS="[SUBELEMENTS]",requireSimulator.setName("XMLBuffer"),XMLBuffer.orderByPos=function(n){var e=[];if(n[XMLBuffer.SUBELEMENTS])n[XMLBuffer.SUBELEMENTS].forEach(function(n){e.push(n)});else for(var t in n)n.hasOwnProperty(t)&&null!=n[t]&&"string"!=typeof n[t]&&"number"!=typeof n[t]&&"number"==typeof n[t].pos&&e.push(isNaN(parseInt(t))&&!(t+"").match(/-/)?{name:t,value:n[t]}:{value:n[t]});return e=e.sort(function(n,e){return n.value.pos-e.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",requireSimulator.setName("TError"),requireSimulator.setName("TT"),TT=function(){function n(n,e){var t,r;"string"==typeof n?(t=a.str(n),n.length>0&&(r=n.substring(0,1)),e||(e=n)):(t=a.reg(n),e||(e=n+""));var i=c.and(t).ret(function(n,t){var r={};if(r.pos=t.pos,"number"!=typeof r.pos)throw"no pos for "+e+" "+disp(t);if(r.len=t.len,r.text=t.src.str.substring(r.pos,r.pos+r.len),"string"!=typeof r.text)throw"no text("+r.text+") for "+e+" "+disp(t);return r.toString=function(){return this.text},r});return r&&(i=i.first(c,r)),i.setName(e)}function e(e,t,i){"string"==typeof i&&(i=n(i)),l[e]=r(l[e],i.ret(function(n){return n.type=t,n}).setName(t))}function t(n,t,r,i){t==s&&(t=r);for(var a=1;n>=a;a*=2)0!=(n&a)&&e(n&a,t,r,i);f[t]=i}function r(n,e){return n?n.or(e):e}function i(n){var e=((new Date).getTime(),Parser.StringParser.parse(p,n));return e.success||console.log("Stopped at "+n.substring(e.src.maxPos-5,e.src.maxPos+5)),"object"==typeof WebSite&&WebSite.devMode&&(window.tokenStat=window.tokenStat||{},e.result[0].forEach(function(n){window.tokenStat[n.text]=window.tokenStat[n.text]||0,window.tokenStat[n.text]++})),e}var a=Parser.StringParser,s="SAMENAME",o=1,u=2,c=a.reg(/^(\s*(\/\*([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),l={},f={},p=Parser.create(function(n){for(var e=u,t=[];;){if(n=l[e].parse(n),!n.success)break;var r=n.result[0];e=f[r.type],t.push(r)}return n=c.parse(n),n.success=n.src.maxPos==n.src.str.length,n.result[0]=t,n}),h={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,"for":!0,"else":!0,"super":!0,"while":!0,"break":!0,"do":!0,"switch":!0,"try":!0,"catch":!0,"finally":!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},d=n(/^[0-9\.]+/).ret(function(n){return n.type="number",n.value=parseInt(n.text),n}).first(c,"0123456789"),m=n({exec:function(n){var e=n.substring(0,1);if('"'!==e&&"'"!==e)return!1;for(var t=1;t<n.length;t++){var r=n.substring(t,t+1);if(r===e)return[n.substring(0,t+1)];"\\"===r&&t++}return!1},toString:function(){return"literal"}}).first(c,"\"'"),v=n({exec:function(n){if("/"!==n.substring(0,1))return!1;for(var e=1;e<n.length;e++){var t=n.substring(e,e+1);if("/"===t)return[n.substring(0,e+1)];if("\n"==t)return!1;"\\"===t&&e++}return!1},toString:function(){return"regex"}}).first(c,"/");t(u|o,"number",d,o),t(u,"regex",v,o),t(u|o,"literal",m,o),t(u|o,s,"++",o),t(u|o,s,"--",o),t(u|o,s,"!==",u),t(u|o,s,"===",u),t(u|o,s,"+=",u),t(u|o,s,"-=",u),t(u|o,s,"*=",u),t(u|o,s,"/=",u),t(u|o,s,"%=",u),t(u|o,s,">=",u),t(u|o,s,"<=",u),t(u|o,s,"!=",u),t(u|o,s,"==",u),t(u|o,s,">>",u),t(u|o,s,"<<",u),t(u|o,s,"&&",u),t(u|o,s,"||",u),t(u|o,s,"(",u),t(u|o,s,")",o),t(u|o,s,"[",u),t(u|o,s,"]",o),t(u|o,s,"{",u),t(u|o,s,"}",o),t(u|o,s,">",u),t(u|o,s,"<",u),t(u|o,s,"+",u),t(u|o,s,"-",u),t(u|o,s,".",u),t(u|o,s,"?",u),t(u|o,s,"=",u),t(u|o,s,"*",u),t(u|o,s,"%",u),t(o,s,"/",u),t(o|u,s,"^",u),t(o|u,s,"~",u),t(o|u,s,"\\",u),t(o|u,s,":",u),t(o|u,s,";",u),t(o|u,s,",",u),t(u|o,s,"!",u),t(u|o,s,"&",u),t(u|o,s,"|",u);var g=n(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(n){return n.type="constructor"==n.text?"tk_constructor":h.hasOwnProperty(n.text)?n.text:"symbol",n}).first(c);for(var y in h)f[y]=u;return f.tk_constructor=u,f.symbol=o,l[u]=r(l[u],g),l[o]=r(l[o],g),{parse:i,extension:"js"}}(),requireSimulator.setName("ExpressionParser"),requireSimulator.setName("TonyuLang"),TonyuLang=function(){function n(n){return function(){return arguments[n]}}function e(n,e){var t=[];if(n&&!n.args)throw disp(n);if(n){var r=Parser.getRange(n);Parser.addRange(t,r),n.args.forEach(function(n){t.push(n)})}return e.forEach(function(n){var e=Parser.getRange(n);Parser.addRange(t,e),t.push(n.obj)}),t}function t(n,e,t){var r={type:"infix",left:n,op:e,right:t};return Parser.setRange(r),r.toString=function(){return"("+n+e+t+")"},r}var r=Parser,i={},a=Grammar(),s=a.get,o=(r.StringParser,r.TokensParser.token),u=o("number").ret(function(n){if(n.type="number","string"!=typeof n.text)throw"No text for "+disp(n);if(n.value=parseFloat(n.text),isNaN(n.value))throw"No value for "+disp(n);return n}),c=o("symbol"),l=o("==="),f=o("!=="),p=o("=="),h=o("!="),d=o(">="),m=o("<="),v=o(">"),g=o("<"),y=o("&&"),x=o("||"),w=o("-"),b=o("+"),T=o("*"),S=o("/"),k=o("%"),P=o("="),j=o("literal"),$=o("regex"),R=ExpressionParser(),E=a("arrayElem").ands(o("["),R.lazy(),o("]")).ret(null,"subscript"),D=a("argList").ands(o("("),R.lazy().sep0(o(","),!0),o(")")).ret(null,"args"),I=a("member").ands(o("."),c).ret(null,"name"),L=a("parenExpr").ands(o("("),R.lazy(),o(")")).ret(null,"expr"),M=a("varAccess").ands(c).ret("name"),N=s("funcExpr").firstTokens(["function","\\"]),C=a("funcExprArg").ands(N).ret("obj"),A=s("objlit").firstTokens("{"),_=a("objlitArg").ands(A).ret("obj"),O=_.or(C),F=D.and(O.rep0()).ret(function(n,t){return e(n,t)}).or(O.rep1().ret(function(n){return e(null,n)})),B=(D.or(_),a("call").ands(F).ret("args")),W=a("scall").ands(F).ret("args"),U=a("newExpr").ands(o("new"),M,B.opt()).ret(null,"klass","params"),K=a("superExpr").ands(o("super"),o(".").and(c).ret(n(1)).opt(),W).ret(null,"name","params"),X=o("true").or(o("false")).or(o("null")).or(o("undefined")).or(o("this")).or(o("arguments")).ret(function(n){return n.type="reservedConst",n});R.element(u),R.element(X),R.element($),R.element(j),R.element(L),R.element(U),R.element(K),R.element(N),R.element(A),R.element(s("arylit").firstTokens("[")),R.element(M);var H=0;R.infixr(H,P),R.infixr(H,o("+=")),R.infixr(H,o("-=")),R.infixr(H,o("*=")),R.infixr(H,o("/=")),R.infixr(H,o("%=")),R.infixr(H,o("|=")),R.infixr(H,o("&=")),H++,R.trifixr(H,o("?"),o(":")),H++,R.infixl(H,x),H++,R.infixl(H,y),H++,R.infix(H,o("instanceof")),R.infix(H,o("is")),R.infix(H,l),R.infix(H,f),R.infix(H,p),R.infix(H,h),R.infix(H,d),R.infix(H,m),R.infix(H,v),R.infix(H,g),H++,R.postfix(H+3,o("++")),R.postfix(H+3,o("--")),R.infixl(H,w),R.infixl(H,b),H++,R.infixl(H,T),R.infixl(H,S),R.infixl(H,k),H++,R.prefix(H,o("typeof")),R.prefix(H,o("delete")),R.prefix(H,o("++")),R.prefix(H,o("--")),R.prefix(H,o("+")),R.prefix(H,o("-")),R.prefix(H,o("!")),H++,H++,R.postfix(H,B),R.postfix(H,I),R.postfix(H,E),R.mkInfixl(t),R.mkInfixr(t);{var q=R.build().setName("expr").profile(),n=function(n){return function(){return arguments[n]}},z=s("stmt").firstTokens();a("exprstmt").ands(q,o(";")).ret("expr")}a("compound").ands(o("{"),z.rep0(),o("}")).ret(null,"stmts");{var Y=o("else").and(z).ret(n(1)),G=(a("return").ands(o("return"),q.opt(),o(";")).ret(null,"value"),a("if").ands(o("if"),o("("),q,o(")"),z,Y.opt()).ret(null,null,"cond",null,"then","_else"),a("forin").ands(o("var").opt(),c.sep1(o(","),!0),o("in"),q).ret("isVar","vars",null,"set")),V=a("normalFor").ands(z,q.opt(),o(";"),q.opt()).ret("init","cond",null,"next"),Z=V.or(G),Q=(a("for").ands(o("for"),o("("),Z,o(")"),"stmt").ret(null,null,"inFor",null,"loop"),a("while").ands(o("while"),o("("),q,o(")"),"stmt").ret(null,null,"cond",null,"loop"),a("break").ands(o("break"),o(";")).ret("brk"),a("finally").ands(o("finally"),"stmt").ret(null,"stmt"),a("catch").ands(o("catch"),o("("),c,o(")"),"stmt").ret(null,null,"name",null,"stmt"),a("catches").ors("catch","finally")),J=(a("try").ands(o("try"),"stmt",Q.rep1()).ret(null,"stmt","catches"),a("varDecl").ands(c,o("=").and(q).ret(n(1)).opt()).ret("name","value"));a("varsDecl").ands(o("var"),J.sep1(o(","),!0),o(";")).ret(null,"decls")}a("funcDeclHead").ands(o("nowait").opt(),o("function").or(o("fiber")).or(o("tk_constructor")).or(o("\\")).opt(),c.or(o("new")),"paramDecls").ret("nowait","ftype","name","params");a("funcDecl").ands("funcDeclHead","compound").ret("head","body"),a("nativeDecl").ands(o("native"),c,o(";")).ret(null,"name"),a("ifWait").ands(o("ifwait"),"stmt",Y.opt()).ret(null,"then","_else"),a("useThread").ands(o("usethread"),c,"stmt").ret(null,"threadVarName","stmt");z=a("stmt").ors("return","if","for","while","break","ifWait","try","nativeDecl","funcDecl","compound","exprstmt","varsDecl");var ne=a("paramDecl").ands(c).ret("name"),ee=a("paramDecls").ands(o("("),ne.sep0(o(","),!0),o(")")).ret(null,"params");a("funcExprHead").ands(o("function").or(o("\\")),c.opt(),ee.opt()).ret(null,"name","params");var te=(a("funcExpr").ands("funcExprHead","compound").ret("head","body"),a("jsonElem").ands(c.or(j),o(":").and(q).ret(function(n,e){return e}).opt()).ret("key","value")),re=(a("objlit").ands(o("{"),te.sep0(o(","),!0),o("}")).ret(null,"elems"),a("arylit").ands(o("["),q.sep0(o(","),!0),o("]")).ret(null,"elems"),a("extends").ands(o("extends"),c.or(o("null")),o(";")).ret(null,"superClassName")),ie=a("includes").ands(o("includes"),c.sep1(o(","),!0),o(";")).ret(null,"includeClassNames"),ae=a("program").ands(re.opt(),ie.opt(),z.rep0(),Parser.TokensParser.eof).ret("ext","incl","stmts");for(var se in a.defs)a.defs[se].profile();return i.parse=function(n){str="string"==typeof n?n:n.text(),str+="\n";var e=TT.parse(str);if(!e.isSuccess())throw TError("文法エラー(Token)",n,e.src.maxPos);var t=e.result[0],i=r.TokensParser.parse(ae,t);if(i.isSuccess()){var a=i.result[0];return a}var s=t[i.src.maxPos],o=s?s.pos+s.len:str.length;throw TError("文法エラー",n,o)},i.genXML=function(n,e){var t=XMLBuffer(n);return t(e),t.buf},i.extension="tonyu",i}(),requireSimulator.setName("ObjectMatcher"),ObjectMatcher=function(){function n(n,e){var t={};return t[i]=n,e&&(t[a]=e),t}function e(n){return n&&n[i]}function t(n,e,r){if(n===e)return!0;if(null==n)return!1;if("string"==typeof n&&e instanceof RegExp)return n.match(e);if("function"==typeof e)return e(n,r);if("object"==typeof e){for(var s in e)if(s!=i){var o=s==a?n:n[s],u=e[s];if(!t(o,u,r))return!1}return e[i]&&(r[e[i]]=n),!0}return!1}var r={},i="$var",a="$this";r.v=n,r.isVar=e;for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",o=0;o<s.length;o++){var u=s.substring(o,o+1);r[u]=n(u)}return r.match=function(n,e){var r={};return t(n,e,r)?r:null},r}(),requireSimulator.setName("context"),requireSimulator.setName("Visitor"),Visitor=function(n){var e={funcs:n};return e.visit=function(t){e.debug&&console.log("visit ",t.type,t.pos);var r=t?n[t.type]:null;return r?r.call(e,t):e.def?e.def.call(e,t):void 0},e.replace=function(n){return e.def||(e.def=function(n){if("object"==typeof n)for(var t in n)n[t]&&"object"==typeof n[t]&&(n[t]=e.visit(n[t]));return n}),e.visit(n)},e},requireSimulator.setName("Tonyu.Compiler"),Tonyu.Compiler=function(){function n(n,e){var t={type:n};if(e)for(var i in e)t[i]=e[i];return t.name||(t.name=r("_"+n+"_")),t}function e(n){return n?n.type:null}function t(n,e){function t(t){var i,s=e.options.compiler.defaultSuperClass,l=0;if((i=c.match(t,{ext:{superClassName:{text:c.T,pos:c.P}}}))&&(s=i.T,l=i.P,"null"==s&&(s=null)),n.includes=[],(i=c.match(t,{incl:{includeClassNames:c.C}}))&&i.C.forEach(function(t){var i=t.text,a=t.pos,s=e.classes[i];if(!s)throw TError("クラス "+i+"は定義されていません",r,a);n.includes.push(s)}),"Array"==s)n.superClass={name:"Array",builtin:!0};else if(s){var f=e.classes[s];if(!f)throw TError("親クラス "+s+"は定義されていません",r,l);n.superClass=f}t.stmts.forEach(function(n){if("funcDecl"==n.type){var e=n.head;o[e.name.text]={nowait:!!e.nowait,ftype:e.ftype.text,name:e.name.text,head:e,pos:e.pos,stmts:n.body.stmts}}else"nativeDecl"==n.type?u[n.name.text]=n:a.stmts.push(n)})}var r=n.src.tonyu,i=TonyuLang.parse(r),a={name:"main",stmts:[],pos:0},s={},o={main:a},u={};n.decls={fields:s,methods:o,natives:u},n.node=i;var c=ObjectMatcher;t(i)}function r(n){return n+(Math.random()+"").replace(/\./g,"")}function i(n,e,t){e._id||(n._idseq||(n._idseq=0),e._id=++n._idseq);var r=n[e._id];if(r||(r=n[e._id]={node:e}),t)for(var i in t)r[i]=t[i];return r}function a(t,a){function S(n,e){return i(t.annotation,n,e)}function k(n){return Y.substring(n.pos,n.pos+n.len)}function P(n){return"string"==typeof n?y+n:n.builtin?n.name:y+n.name}function j(n){for(var e={},t=[],r=[],i=n;i;i=i.superClass)t=t.concat(i.includes),e[P(i)]=!0,r.push(i);for(;t.length>0;){var i=t.shift();e[P(i)]||(e[P(i)]=!0,r.push(i),t=t.concat(i.includes))}return r}function $(e){if(!e.builtin){var t=ne,r=e.decls;for(var i in r.fields)t[i]=n(J.FIELD,{klass:e.name,name:i});for(var i in r.methods)t[i]=n(J.METHOD,{klass:e.name,name:i})}}function R(){var e=ne;j(t).forEach($);var r=t.decls;for(var i in r.natives)e[i]=n(J.NATIVE,{name:"native::"+i});for(var i in a.classes)e[i]=n(J.CLASS,{name:i})}function E(n){var e=function(){};return e.prototype=n,new e}function D(n){var e=null;return j(t).forEach(function(t){e||(e=t.decls.methods[n])}),e}function I(n){if(!n.head)return[];var e=n.head.params.params;if(!e.forEach)throw n+" is not array ";return e}function L(n){if("varAccess"==n.type||"postfix"==n.type&&("member"==n.op.type||"arrayElem"==n.op.type))return!0;throw console.log("LVal",n),TError("'"+k(n)+"'は左辺には書けません．",z,n.pos)}function M(n,e){return function(){se.enter(n,function(){ie.visit(e)})}}function N(r){var i=se.scope[r],a=e(i);if(!a){var s=r.match(/^\$/);a=s?J.GLOBAL:J.FIELD;var o={name:r};s||(o.klass=t.name),i=ne[r]=n(a,o)}return i}function C(n,t){var r=N(n),i=e(r);if(i==J.THVAR)ee.printf("%s",s);else if(i==J.FIELD)ee.printf("%s.%s",o,n);else if(i==J.METHOD)t?ee.printf("%s.%s",o,n):ee.printf("%s(%s,%s.%s)",d,o,o,n);else if(i==J.CLASS)ee.printf("%s",P(n));else if(i==J.GLOBAL)ee.printf("%s%s",x,n);else{if(i!=J.PARAM&&i!=J.LOCAL&&i!=J.NATIVE)throw console.log("Unknown scope type: ",i),"Unknown scope type: "+i;ee.printf("%s",n)}return r}function A(n){return function(){ee.printf("%s%s=%s;%n",a.options.compiler.commentLastPos?"//":"",f,V.add(t,n.pos))}}function _(e,t){var r={varDecls:{},subFuncDecls:{}};se.enter({locals:r},function(){de.visit(e)});for(var i in r.varDecls)t[i]=n(J.LOCAL);for(var i in r.subFuncDecls)t[i]=n(J.LOCAL);return r}function O(n,e){function t(){se.enter({scope:e},function(){for(var e in n.varDecls)ee.printf("var %s;%n",e);for(var e in n.subFuncDecls)H(n.subFuncDecls[e])})}return t}function F(n){var e=[];return n.forEach(function(n){e.push(P(n))}),e}function B(){se.enter({scope:ne},function(){t.superClass?re("%s=Tonyu.klass(%s,[%s],{%{",P(t),P(t.superClass),F(t.includes).join(",")):re("%s=Tonyu.klass([%s],{%{",P(t),F(t.includes).join(","));for(var n in Q){oe&&console.log("method1",n);var e=Q[n];se.enter({noWait:!0},function(){U(e)}),oe&&console.log("method2",n),se.enter({noWait:!1},function(){W(e)}),oe&&console.log("method3",n)}re("%}});")})}function W(e){function r(){se.enter({method:e,scope:a,pc:1},function(){e.stmts.forEach(function(n){re("%v%n",n)})})}var i=I(e),a=E(se.scope);i.forEach(function(r,i){a[r.name.text]=n(J.PARAM,{klass:t.name,name:e.name,no:i})});var f=_(e.stmts,a);re("%s%s :function (%j) {%{var %s=%s;%nvar %s=%s;%nvar %s=0;%n%f%nreturn function %s(%s) {%{for(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}};%n%}},%n",c,e.name,[",",I(e)],o,w,u,"arguments",l,O(f,a),X(e.pos),s,p,h,p,l,r,s,o)}function U(e){function r(){se.enter({method:e,scope:s},function(){e.stmts.forEach(function(n){re("%v%n",n)
})})}var i=q(e)?"initialize":e.name,a=I(e),s=E(se.scope);a.forEach(function(r,i){s[r.name.text]=n(J.PARAM,{klass:t.name,name:e.name,no:i})});var u=_(e.stmts,s);re("%s :function %s(%j) {%{var %s=%s;%n%f%n%f%}},%n",i,X(e.pos),[",",I(e)],o,w,O(u,s),r)}function K(e){function t(){se.enter({noWait:!0,scope:s},function(){a.stmts.forEach(function(n){re("%v%n",n)})})}var r,i,a=e.body;i=(r=G.match(e,{head:{params:{params:G.P}}}))?r.P:[];var s=E(se.scope);i.forEach(function(e){s[e.name.text]=n(J.PARAM)});var o=_(a,s);ee.printf("function (%j) {%{%f%n%f%}}",[",",i],O(o,s),t)}function X(n){return"_trc_func_"+V.add(t,n)+"_"+te++}function H(e){function t(){se.enter({noWait:!0,scope:o},function(){a.stmts.forEach(function(n){re("%v%n",n)})})}var r,i,a=e.body,s=e.head.name.text;i=(r=G.match(e,{head:{params:{params:G.P}}}))?r.P:[];var o=E(se.scope);i.forEach(function(e){o[e.name.text]=n(J.PARAM)});var u=_(a,o);ee.printf("function %s(%j) {%{%f%n%f%}}",s,[",",i],O(u,o),t)}function q(n){return G.match(n,{ftype:"constructor"})||G.match(n,{name:"new"})}var z=t.src.tonyu,Y=z.text(),G=ObjectMatcher,V=(P(t),a.traceTbl),Z=t.decls,Q=(Z.fields,Z.methods),J=(Z.natives,T),ne={},ee=IndentBuffer(),te=0,re=ee.printf,ie=null,ae=a.options.compiler.diagnose,se=context(),oe=!1,ue={type:"postfix",op:{$var:"A",type:"call"},left:{type:"varAccess",name:{text:G.T}}},ce={expr:ue},le={expr:{type:"infix",op:G.O,left:G.L,right:ue}},fe={expr:{type:"superExpr",$var:"S"}},pe={expr:{type:"infix",op:G.O,left:G.L,right:{type:"superExpr",$var:"S"}}};t.annotation={},ie=ee.visitor=Visitor({dummy:function(n){ee.printf("",n)},literal:function(n){ee.printf("%s",n.text)},paramDecl:function(n){ee.printf("%v",n.name)},paramDecls:function(n){ee.printf("(%j)",[", ",n.params])},funcDeclHead:function(n){ee.printf("function %v %v",n.name,n.params)},funcDecl:function(){},"return":function(n){se.noWait?n.value?ee.printf("return %v;",n.value):ee.printf("return %s;",o):n.value?ee.printf("%s.exit(%v);return;",s,n.value):ee.printf("%s.exit(%s);return;",s,o)},program:function(n){genClass(n.stmts)},number:function(n){ee.printf("%s",n.value)},reservedConst:function(n){"this"==n.text?ee.printf("%s",o):"arguments"!=n.text||se.noWait?ee.printf("%s",n.text):ee.printf("%s",u)},varDecl:function(e){se.scope[e.name.text]=n(J.LOCAL),e.value?ee.printf("%v = %v",e.name,e.value):ee.printf("%v",e.name)},varsDecl:function(n){A(n)(),ee.printf("%j;",[";",n.decls])},jsonElem:function(n){n.value?ee.printf("%v: %v",n.key,n.value):ee.printf("%v: %f",n.key,function(){S(n,{scopeInfo:C(n.key.text,!1)})})},objlit:function(n){ee.printf("{%j}",[",",n.elems])},arylit:function(n){ee.printf("[%j]",[",",n.elems])},funcExpr:function(n){K(n)},parenExpr:function(n){ee.printf("(%v)",n.expr)},varAccess:function(n){var e=n.name.text,t=C(e,!1);S(n,{scopeInfo:t})},exprstmt:function(n){var r;if(A(n)(),se.noWait||!(r=G.match(n,ce))||e(se.scope[r.T])!=J.METHOD||D(r.T).nowait)if(se.noWait||!(r=G.match(n,le))||e(se.scope[r.T])!=J.METHOD||D(r.T).nowait)if(!se.noWait&&(r=G.match(n,fe))){var i=P(t.superClass);r.S.name&&ee.printf("%s.enter( %s.prototype.%s%s.apply( %s, %v) );%n%s=%s;return;%n%}case %d:%{",s,i,c,r.S.name.text,o,r.S.params,l,se.pc,se.pc++)}else if(!se.noWait&&(r=G.match(n,pe))){var i=P(t.superClass);r.S.name&&ee.printf("%s.enter( %s.prototype.%s%s.apply( %s, %v) );%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal();%n",s,i,c,r.S.name.text,o,r.S.params,l,se.pc,se.pc++,r.L,r.O,s)}else ee.printf("%v;",n.expr);else ee.printf("%s.enter( %s.%s%s%v );%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal();%n",s,o,c,r.T,r.A,l,se.pc,se.pc++,r.L,r.O,s);else ee.printf("%s.enter( %s.%s%s%v );%n%s=%s;return;%n%}case %d:%{",s,o,c,r.T,r.A,l,se.pc,se.pc++)},infix:function(n){var e=n.op.text;if(("="==e||"+="==e||"-="==e||"*="==e||"/="==e||"%="==e)&&L(n.left),ae){if("+"==e||"-"==e||"*"==e||"/"==e||"%"==e)return void ee.printf("%s(%v,%l)%v%s(%v,%l)",g,n.left,k(n.left),n.op,g,n.right,k(n.right));if("+="==e||"-="==e||"*="==e||"/="==e||"%="==e)return void ee.printf("%v%v%s(%v,%l)",n.left,n.op,g,n.right,k(n.right))}ee.printf("%v%v%v",n.left,n.op,n.right)},trifixr:function(n){ee.printf("%v%v%v%v%v",n.left,n.op1,n.mid,n.op2,n.right)},prefix:function(n){ee.printf("%v %v",n.op,n.right)},postfix:function(n){var t;if(ae)if(t=G.match(n,{left:{type:"varAccess",name:{text:G.T}},op:{type:"call"}})){var r=N(t.T),i=e(r);i==J.FIELD||i==J.METHOD?ee.printf("%s(%s, %l, [%j], %l )",m,o,t.T,[",",n.op.args],"this"):ee.printf("%s(%v, [%j], %l)",v,n.left,[",",n.op.args],k(n.left))}else(t=G.match(n,{left:{type:"postfix",left:G.T,op:{type:"member",name:{text:G.N}}},op:{type:"call"}}))?ee.printf("%s(%v, %l, [%j], %l )",m,t.T,t.N,[",",n.op.args],k(t.T)):(t=G.match(n,{left:G.L,op:{type:"member",name:{text:G.N}}}))?ee.printf("%s(%v,%l).%s",g,t.L,k(t.L),t.N):ee.printf("%v%v",n.left,n.op);else G.match(n,{left:{type:"varAccess"},op:{type:"call"}})?(S(n.left,{scopeInfo:C(n.left.name.text,!0)}),ee.printf("%v",n.op)):ee.printf("%v%v",n.left,n.op)},"break":function(n){if(se.noWait)ee.printf("break;%n");else{if(!se.closestBrk)throw TError("break； は繰り返しの中で使います",z,n.pos);ee.printf("%s=%z; break;%n",l,se.closestBrk)}},"while":function(n){if(A(n)(),se.noWait)ee.printf("while (%v) {%f}",n.cond,M({noSurroundBrace:!0},n.loop));else{var e=ee.lazy(),t=se.pc++,r="reservedConst"==n.cond.type&&"true"==n.cond.text;ee.printf("%}case %d:%{"+(r?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",t,n.cond,l,e,M({closestBrk:e},n.loop),l,t,function(){ee.print(e.put(se.pc++))})}},"for":function(e){function t(e,t,r){return function(){r.forEach(function(t,r){se.scope[t.text]=n(J.LOCAL),ee.printf("%s=%s[%s];%n",t.text,e,r)})}}if(A(e)(),"forin"==e.inFor.type){var i=r("_it_");if(se.scope[i]=n(J.LOCAL),se.noWait)ee.printf("var %s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%v%n%}}",i,b,e.inFor.set,e.inFor.vars.length,i,t(i,e.inFor.isVar,e.inFor.vars),e.loop);else{var a=ee.lazy(),s=se.pc++;ee.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",i,b,e.inFor.set,e.inFor.vars.length,s,i,l,a,t(i,e.inFor.isVar,e.inFor.vars),M({closestBrk:a},e.loop),l,s,function(n){n.print(a.put(se.pc++))})}}else if(se.noWait)ee.printf("%v%nwhile(%v) {%{%v%n%v;%n%}}",e.inFor.init,e.inFor.cond,e.loop,e.inFor.next);else{var a=ee.lazy(),s=se.pc++;ee.printf("%v;%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%v;%n%s=%s;break;%n%}case %f:%{",e.inFor.init,s,e.inFor.cond,l,a,M({closestBrk:a},e.loop),e.inFor.next,l,s,function(n){n.print(a.put(se.pc++))})}},"if":function(n){if(A(n)(),se.noWait)n._else?ee.printf("if (%v) {%f} else {%f}",n.cond,M({noSurroundBrace:!0},n.then),M({noSurroundBrace:!0},n._else)):ee.printf("if (%v) {%f}",n.cond,M({noSurroundBrace:!0},n.then));else{var e={},t={};n._else?ee.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",n.cond,l,t,n.then,l,e,function(){ee.print(t.put(se.pc++))},n._else,function(){ee.print(e.put(se.pc++))}):ee.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",n.cond,l,e,n.then,function(){ee.print(e.put(se.pc++))})}},useThread:function(e){var t=E(se.scope);t[e.threadVarName.text]=n(J.THVAR),se.enter({scope:t},function(){ee.printf("%v",e.stmt)})},ifWait:function(e){if(se.noWait)e._else&&ee.printf("%v",e._else);else{var t=E(se.scope);t[s]=n(J.THVAR),se.enter({scope:t},function(){ee.printf("%v",e.then)})}},call:function(n){ee.printf("(%j)",[",",n.args])},objlitArg:function(n){ee.printf("%v",n.obj)},argList:function(n){ee.printf("%j",[",",n.args])},newExpr:function(n){var e=n.params;e?ee.printf("new %v%v",n.klass,e):ee.printf("new %v",n.klass)},scall:function(n){ee.printf("[%j]",[",",n.args])},superExpr:function(n){var e;n.name?(e=n.name.text,ee.printf("%s.prototype.%s.apply( %s, %v)",P(t.superClass),e,o,n.params)):ee.printf("%s.apply( %s, %v)",P(t.superClass),o,n.params)},arrayElem:function(n){ee.printf("[%v]",n.subscript)},member:function(n){ee.printf(".%v",n.name)},symbol:function(n){ee.print(n.text)},normalFor:function(n){ee.printf("%v; %v; %v",n.init,n.cond,n.next)},compound:function(n){se.noWait?se.noSurroundBrace?se.enter({noSurroundBrace:!1},function(){ee.printf("%{%j%n%}",["%n",n.stmts])}):ee.printf("{%{%j%n%}}",["%n",n.stmts]):ee.printf("%j",["%n",n.stmts])},"typeof":function(){ee.printf("typeof ")},"instanceof":function(){ee.printf(" instanceof ")},is:function(){ee.printf(" instanceof ")},regex:function(n){ee.printf("%s",n.text)}});var he=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];he.forEach(function(n){ie.funcs[n]=function(){ee.printf("%s",n)}}),ie.def=function(n){throw console.log("Err node="),console.log(n),n.type+" is not defined in visitor:compiler2"},ie.cnt=0;var de=Visitor({varDecl:function(n){se.locals.varDecls[n.name.text]=n},funcDecl:function(n){se.locals.subFuncDecls[n.head.name.text]=n},funcExpr:function(){},exprstmt:function(){},forin:function(n){n.isVar;n.vars.forEach(function(e){se.locals.varDecls[e.text]=n})}});return de.def=function(n){var e=this;if(n){var t;t=n instanceof Array?n:n[Grammar.SUBELEMENTS],t&&t.forEach(function(n){e.visit(n)})}},R(),B(),t.src.js=ee.buf,oe&&console.log("method4",ee.buf),ee.buf}var s="_thread",o="_this",u="_arguments",c="fiber$",l="__pc",f="$LASTPOS",p="__cnt",h=100,d="Tonyu.bindFunc",m="Tonyu.invokeMethod",v="Tonyu.callFunc",g="Tonyu.checkNonNull",y="Tonyu.classes.",x="Tonyu.globals.",w="this.isTonyuObject?this:Tonyu.not_a_tonyu_object(this)",b="Tonyu.iterator",T={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PARAM:"param",GLOBAL:"global",CLASS:"class"};return{initClassDecls:t,genJS:a}}(),"function"==typeof getReq&&getReq.exports("Tonyu.Compiler"),requireSimulator.setName("Tonyu.TraceTbl"),Tonyu.TraceTbl=function(){var n={},e=1e6,t=1,r=1e4,i={},a=[],s={};return n.add=function(n,o){var u=n.src.tonyu,c=u.path(),l=i[c];void 0==l&&(l=t++,t>r&&(t=0),i[c]=l,a[l]=c),s[c]=n,o>=e&&(o=e-1);var f=l*e+o;return f},n.decode=function(n){var t=n%e,r=(n-t)/e,i=a[r];if(i){var o=FS.get(i),u=s[i];return TError("Trace info",u||o,t)}return null},n},"function"==typeof getReq&&getReq.exports("Tonyu.TraceTbl"),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(n){return n.klass({initialize:function(n,e){this.options=e||{},this.img=n,this.height=n.height,this.width=n.width;var t=this.newImage(n.width,n.height),r=t.getContext("2d");r.drawImage(n,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,n.width,n.height).data,this.base=this.getPixel(0,0)},newImage:function(n,e){var t=document.createElement("canvas");return t.width=n,t.height=e,t},getPixel:function(n,e){var t=this.pixels,r=4*(n+e*this.width),i=t[0+r],a=t[1+r],s=t[2+r],o=t[3+r];return 256*(256*(256*o+s)+a)+i},setPixel:function(n,e,t){var r=4*(n+e*this.width);this.pixels[0+r]=255&t,t=(t-(255&t))/256,this.pixels[1+r]=255&t,t=(t-(255&t))/256,this.pixels[2+r]=255&t,t=(t-(255&t))/256,this.pixels[3+r]=255&t},parse:function(){try{for(var n=[],e=0;e<this.height;e++)for(var t=0;t<this.width;t++){var r=this.getPixel(t,e);r!=this.base&&n.push(this.parse1Pattern(t,e))}return n}catch(i){if(i.isParseError)return console.log("parse error! "+i),{image:this.img,x:0,y:0,width:this.width,height:this.height};throw i}},parse1Pattern:function(n,e){function t(n){return n}function r(n,e,t){return{toString:function(){return"at ("+n+","+e+") :"+t},isParseError:!0}}for(var i=this.getPixel(n,e),a=n,s=e,o=this.base,u=this.width,c=this.height;u>a;){var l=this.getPixel(a,s);if(l!=i)break;a++}if(a>=u||this.getPixel(a,s)!=o)throw r(a,s,t(this.getPixel(a,s))+"!="+t(o));for(a--;c>s&&this.getPixel(a,s)==i;)s++;if(s>=c||this.getPixel(a,s)!=o)throw r(a,s,t(this.getPixel(a,s))+"!="+t(o));s--;var f=n+1,p=e+1,h=a-f,d=s-p;if(console.log("PP",f,p,h,d,a,s),h*d==0)throw r(a,s,"w*h==0");for(var m=this.newImage(h,d),v=m.getContext("2d"),g=v.getImageData(0,0,h,d),y=g.data,x=0,w=p;s>w;w++)for(var b=f;a>b;b++){var T=this.getPixel(b,w);T==i?(y[x++]=0,y[x++]=0,y[x++]=0,y[x++]=0):(y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T)}v.putImageData(g,0,0);for(var S=p-1;s>=S;S++)for(var k=f-1;a>=k;k++)this.setPixel(k,S,o);return this.options.boundsInSrc?{x:f,y:p,width:h,height:d}:{image:m,x:0,y:0,width:h,height:d}}})}),requireSimulator.setName("Util"),Util=function(){function n(n,t){null==t&&(t=""),n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?t:e(i[1])}function e(n){return decodeURIComponent(n.replace(/\+/g,"%20"))}function t(n,e){return n.substring(n.length-e.length)===e}function r(n,e){return n.substring(0,e.length)===e}return{getQueryString:n,endsWith:t,startsWith:r}}(),requireSimulator.setName("ImageList"),define(["PatternParser","Util","WebSite"],function(n,e,t){function r(n){var e=[];return n.forEach(function(n){n&&""!=n.url&&e.push(n)}),e}var i,a={};return i=function(e,t,s){s||(s={}),e=r(e);var o=[],u=e.length;e.forEach(function(e,r){function c(){var i,a;if((i=e.pwidth)&&(a=e.pheight)){for(var s=0,c=0,l=this.width,f=this.height,p=[];;){var h=i,d=a;if(s+i>l&&(h=l-s),c+a>f&&(d=f-c),p.push({image:this,x:s,y:c,width:h,height:d}),s+=i,s+i>l&&(s=0,c+=a,c+a>f))break}o[r]=p}else{var m=new n(this);o[r]=m.parse()}if(o[r].name=e.name,u--,0==u){var v=[],g={};o.forEach(function(n){g[n.name]=v.length,v=v.concat(n)}),v.names=g,t(v)}}console.log("loading",e,r);var l=e.url,f=l;if(a[f])return void c.apply(a[f],[]);l=i.convURL(l,s.baseDir);var p=$("<img>");p.load(function(){a[f]=this,c.apply(this,[])}),p.attr("src",l)})},i.load=i,i.parse1=function(e,t,r){var i,a,s;if((i=e.pwidth)&&(a=e.pheight)){for(var o=0,u=0,c=t.width,l=t.height,f=[];;)if(f.push({image:this,x:o,y:u,width:i,height:a}),o+=i,o+i>c&&(o=0,u+=a,u+a>l))break;s=f}else{var p=new n(t,r);s=p.parse()}return s.name=e.name,s},i.convURL=function(n,r){if(n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(n,e){return t[e]}),t.urlAliases[n]&&(n=t.urlAliases[n]),e.startsWith(n,"ls:")){var i=n.substring("ls:".length);if(!r)throw"Baesdir not specified";var a=r.rel(i);if(!a.exists())throw"ImageList file not found: "+a;n=a.text()}return n},window.ImageList=i,i}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/_trc_func_([0-9]+)_.*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(n,e){if(s=n.stack,"string"!=typeof s)return!1;for(var t=s.split(/\n/),r=[],i=0;i<t.length;i++){var a=pat.exec(t[i]);if(a){var o=a[1],u=a[2],c=(a[3],e.decode(o));if(c&&c.klass){for(var l=c.klass.src.js,f=l.split(/\n/),p=null,i=0;i<f.length&&u>i+1;i++){var h=/\$LASTPOS=([0-9]+)/.exec(f[i]);h&&(p=parseInt(h[1]))}if(console.log("slines,row,sid",f,u,p),p){var d=e.decode(p);d&&r.push(d)}}}}return console.log("ttc.get",t,r),r},trc}),requireSimulator.setName("typeCheck"),define(["Visitor"],function(){return TypeCheck=function(){}}),requireSimulator.setName("Auth"),define(["WebSite"],function(n){var e={};return e.currentUser=function(e){$.ajax({type:"get",url:n.serverTop+"currentUser",data:{withCsrfToken:!0},success:function(n){console.log("auth.currentUser",n),n=JSON.parse(n);var t=n.user;"null"==t&&(t=null),console.log("user",t,"csrfToken",n.csrfToken),e(t,n.csrfToken)}})},e.assertLogin=function(t){e.currentUser(function(e,r){return e?t.success(e,r):(window.onLoggedIn=t.success,void t.showLoginLink(n.serverTop+"login"))})},window.Auth=e,e}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(n,e,t){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(n,t,r,i){var a=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(n){alert(n)}),a.append("theFile",r),a.append("user",n),a.append("project",t),a.append("fileName",r.name),$.ajax({type:"get",url:e.serverTop+"blobURL",success:function(n){$.ajax({url:n,type:"POST",data:a,processData:!1,contentType:!1,success:function(n){console.log("Res = "+n),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(n){if(t.startsWith(n,i)){var e=n.split("/");return{user:e[1],project:e[2],fileName:e[3]}}},r.url=function(n,t,r){return e.blobPath+n+"/"+t+"/"+r},r.uploadToExe=function(n,t){var r=n.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?t.success():(t.progress||(t.progress=function(n){console.log("uploadBlobToExe cnt=",n)}),void r.forEach(function(n){var r={csrfToken:t.csrfToken};for(var a in n)r[a]=n[a];$.ajax({type:"get",url:e.serverTop+"uploadBlobToExe",data:r,success:function(){return i--,0==i?t.success():void t.progress(i)},error:t.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function n(e,t){if("string"==typeof e){var r=new Image,i=null,a=null,s=function(n){n&&(a=n),a&&i&&a(i)};return r.onload=function(){i=n(r,t),s()},r.src=e,s}var o=t.width,u=t.height,c=t.getContext("2d"),l=e.width,f=e.height,p=u/f*l,h=o/l*f;h>u&&(h=u),p>o&&(p=o),c.clearRect(0,0,o,u);var d=Math.floor((o-p)/2),m=Math.floor((u-h)/2);return c.drawImage(e,0,0,l,f,d,m,p,h),{left:d,top:m,width:p,height:h,src:e}}return n}),requireSimulator.setName("thumbnail"),define(["ImageRect"],function(n){function e(e){try{var i=Tonyu.globals.$Screen.buf[0],a=$("<canvas>").attr({width:100,height:100});n(i,a[0]);var s=a[0].toDataURL(),o=e.getResource(),u=e.getDir(),c=t.file(e);c.text(s);for(var l={name:r,pwidth:100,pheight:100,url:"ls:"+c.relPath(u)},f=o.images,p=!1,h=0;h<f.length;h++)f[h].name==r&&(f[h]=l,p=!0);p||f.push(l),e.setResource(o),console.log("setRSRC",o)}catch(d){console.log("Create thumbnail failed",d)}}var t={},r="$icon_thumbnail";return t.set=function(n,t){setTimeout(function(){e(n)},t)},t.get=function(n){var e=t.file(n);return e.exists()?e.text():null},t.file=function(n){var e=n.getDir(),t=e.rel("images/").rel("icon_thumbnail.png");return t},t}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","Tonyu.Compiler","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","typeCheck","Blob","thumbnail"],function(Tonyu,Tonyu_Compiler,TError,FS,Tonyu_TraceTbl,ImageList,StackTrace,tc,Blob,thumbnail){return Tonyu.Project=function(dir,kernelDir){function orderByInheritance(n){var e={},t=[],r=0;for(var i in n)e[i]=!1,r++;for(;t.length<r;){var a=t.length;for(var i in n)if(!e[i]){var s=n[i],o=s.superClass,u=[o],c=!0;s.includes&&(u=u.concat(s.includes)),u.forEach(function(n){c=c&&(!n||n.builtin||e[n.name])}),c&&(t.push(s),e[i]=!0)}if(t.length==a)throw TError("クラスの循環参照があります","不明",0)}return t}var TPR={};kernelDir||(kernelDir=FS.get("/Tonyu/Kernel/"));var traceTbl=Tonyu.TraceTbl(),env={classes:{},traceTbl:traceTbl,options:{compiler:{}}};return TPR.EXT=".tonyu",TPR.env=env,TPR.dumpJS=function(n){function e(n){console.log("Class "+n+":\n"+env.classes[n].src.js)}if(n)e(n);else for(var n in env.classes)e(n)},TPR.stop=function(){var n=TPR.runningThread;n&&n.kill();var e=TPR.runningObj;e&&e.stop&&e.stop()},TPR.rawRun=function(n){TPR.compile(),thumbnail.set(TPR,2e3),TPR.rawBoot(n)},TPR.compile=function(){return console.log("Kernel editable",TPR.isKernelEditable()),TPR.isKernelEditable()?void TPR.compileDir(dir):(env.kernelClasses||TPR.compileKernel(),void TPR.compileUser())},TPR.compileKernel=function(){TPR.compileDir(kernelDir),env.kernelClasses=env.classes},TPR.compileUser=function(){TPR.compileDir(dir,env.kernelClasses)},TPR.compileDir=function(cdir,baseClasses){function collect(n){if(n.endsWith(TPR.EXT)){var e=n.truncExt(TPR.EXT);env.classes[e]={name:e,src:{tonyu:n}},delete skip[e]}}TPR.getOptions(),Tonyu.runMode=!1,env.classes=Tonyu.extend({},baseClasses||{});var skip=Tonyu.extend({},baseClasses||{});Tonyu.currentProject=TPR,Tonyu.globals.$currentProject=TPR,TPR.isKernelEditable()&&kernelDir.each(collect),cdir.each(collect);for(var n in env.classes)skip[n]||(console.log("initClassDecl: "+n),Tonyu.Compiler.initClassDecls(env.classes[n],env));var ord=orderByInheritance(env.classes);ord.forEach(function(c){if(!skip[c.name]){console.log("genJS :"+c.name),Tonyu.Compiler.genJS(c,env);try{eval(c.src.js)}catch(e){throw console.log(c.src.js),e}}})},TPR.getResource=function(){var n=dir.rel("res.json");return n.exists()?n.obj():Tonyu.defaultResource},TPR.setResource=function(n){var e=dir.rel("res.json");e.obj(n)},TPR.getThumbnail=function(){return thumbnail.get(TPR)},TPR.convertBlobInfos=function(n){function e(t){if("object"==typeof t)for(var i in t)if(t.hasOwnProperty(i)){var a=t[i];if("url"==i){var s;(s=Blob.isBlobURL(a))&&(t[i]=[Blob.BLOB_PATH_EXPR,n,r,s.fileName].join("/"))}e(a)}}var t=TPR.getResource(),r=TPR.getName();e(t),TPR.setResource(t)},TPR.getBlobInfos=function(){function n(e){if("object"==typeof e)for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];if("url"==r){var a;(a=Blob.isBlobURL(i))&&t.push(a)}n(i)}}var e=TPR.getResource(),t=[];return n(e),t},TPR.loadResource=function(n){var e=TPR.getResource();ImageList(e.images,function(e){var t=Tonyu.getGlobal("$Sprites");t&&t.setImageList(e);for(var r in e.names)Tonyu.setGlobal(r,e.names[r]);n&&n()})},TPR.getOptions=function(){env.options=null;var n=dir.rel("options.json");return n.exists()&&(env.options=n.obj()),env.options&&!env.options.run&&(env.options=null),env.options||(env.options=Tonyu.defaultOptions),env.options.compiler||(env.options.compiler={}),env.options.compiler.commentLastPos=TPR.runScriptMode||StackTrace.isAvailable(),env.options},TPR.setOptions=function(n){n&&(env.options=n);var e=dir.rel("options.json");e.obj(env.options)},TPR.rawBoot=function(n){var e=Tonyu.getClass(n);if(!e)throw TError(n+" というクラスはありません","不明",0);var t=new e,r=Tonyu.thread();r.enter(t.fiber$main()),TPR.runningThread=r,TPR.runningObj=t,$LASTPOS=0,r.steps()},TPR.isKernel=function(n){var e=kernelDir.rel(n+TPR.EXT);return e.exists()?e:null},TPR.isKernelEditable=function(){return env.options.kernelEditable},TPR.getDir=function(){return dir},TPR.getName=function(){return dir.name().replace(/\/$/,"")},TPR.renameClassName=function(n,e){TPR.compile();var t=TPR.env.classes;for(var r in t){var i=t[r],a=i.src.tonyu,s=i.annotation,o=[];if(s&&a){for(var u in s)try{var c=s[u],l=c.scopeInfo;if(l&&"class"==l.type&&l.name==n){var f=c.node.pos,p=c.node.len,h=a.text().substring(f,f+p);h==n&&(o.push({pos:f,len:p}),console.log(a.path(),f,p,a.text().substring(f-5,f+p+5),"->",e))}}catch(d){console.log(d)}o=o.sort(function(n,e){return e.pos-n.pos}),console.log(a.path(),o);var m=a.text(),v=m;o.forEach(function(n){m=m.substring(0,n.pos)+e+m.substring(n.pos+n.len)}),v==m||a.isReadOnly()||(console.log("Refact:",a.path(),m),a.text(m))}}},TPR}}),requireSimulator.setName("Shell"),define(["FS","Util"],function(n,e){function t(n,e){var t=r(n);if(e&&!t.exists())throw t+": no such file or directory";return t}function r(t){if("string"!=typeof t)return t;if(e.startsWith(t,"/"))return n.get(t);var r=i.cwd;return r.rel(t)}var i={cwd:n.get("/")};return i.cd=function(n){return i.cwd=t(n,!0),i.pwd()},i.resolve=t,i.pwd=function(){return i.cwd+""},i.ls=function(n){return n=n?t(n,!0):i.cwd,n.ls()},i.cp=function(n,e,r){r||(r={}),r.v&&i.echo("cp",n,e);var a=t(n,!0),s=t(e);if(a.isDir()&&s.isDir()){var o=0;return a.recursive(function(n){var e=n.relPath(a),t=s.rel(e);(r.test||r.v)&&i.echo((t.exists()?"[ovr]":"[new]")+t+"<-"+n),r.test||t.copyFrom(n,r),o++}),o}if(a.isDir()||s.isDir()){if(!a.isDir()&&s.isDir())return s.rel(a.name()).text(a.text()),1;throw"Cannot copy directory "+a+" to file "+s}return s.text(a.text()),1},i.rm=function(n,e){if(e||(e={}),e.notrash)return n=t(n,!1),n.removeWithoutTrash(),1;if(n=t(n,!0),n.isDir()&&e.r){var r=n,a=0;return r.each(function(n){n.exists()&&(a+=i.rm(n,e))}),r.rm(),a+1}return n.rm(),1},i.cat=function(n){n=t(n,!0),i.echo(n.text())},i.resolve=function(n){return n||(n="."),n=t(n)},i.grep=function(n,e,r){function a(n,e,t){r.res&&r.res.push({file:n,lineNo:e,line:t}),i.echo(n+"("+e+"): "+t)}return e=t(e,!0),r||(r={}),r.res||(r.res=[]),e.isDir()?e.each(function(e){i.grep(n,e,r)}):"string"==typeof n&&e.lines().forEach(function(t,r){t.indexOf(n)>=0&&a(e,r+1,t)}),r.res},i.touch=function(n){return n=t(n),n.text(n.exists()?n.text():""),1},i.setout=function(n){i.outUI=n},i.echo=function(){console.log.apply(console,arguments),i.outUI&&i.outUI.log&&i.outUI.log.apply(i.outUI,arguments)},i.err=function(){console.log.apply(console,arguments),i.outUI&&i.outUI.err&&i.outUI.err.apply(i.outUI,arguments)},i.prompt=function(){},i.ASYNC={r:"SH_ASYNC"},i.help=function(){for(var n in i){var e=i[n];"function"==typeof e&&i.echo(n+(e.description?" - "+e.description:""))}},sh=i,i}),requireSimulator.setName("KeyEventChecker"),define([],function(){var n={};return n.down=function(e,t,r){e instanceof $||(e=$(e)),e.bind("keydown",function(i){return n.is(i,t)?r.call(e[0],i):void 0})},n.is=function(n,e){e=e.toLowerCase(),n=n.originalEvent||n;var t="";return n.altKey&&(t+="alt+"),n.ctrlKey&&(t+="ctrl+"),n.shiftKey&&(t+="shift+"),t+=n.keyCode>=112&&n.keyCode<=123?"f"+(n.keyCode-111):String.fromCharCode(n.keyCode),t=t.toLowerCase(),e==t},n}),requireSimulator.setName("ScriptTagFS"),define([],function(){var n={};return n.toObj=function(){function n(n,e){var t=n.split("\n"),r="";return t.forEach(function(n){r+=n.length>e?n.substring(0,e):n+"\n"}),r}var e=$("script"),t={};return e.each(function(){var e=this;if("text/tonyu"==e.type){var r=$(e).data("filename");if(r){var i=$(e).data("wrap");i?(i=parseInt(i),t[r]=n(e.innerHTML,i)):t[r]=e.innerHTML}}}),t},n}),requireSimulator.setName("TextRect"),TextRect=function(){function n(n,t,r,i,a,s,o){s||(s="center"),n.textBaseline="top",e(n,a);var u=n.measureText(t),c={y:i,w:u.width,h:a};switch(s.substring(0,1).toLowerCase()){case"l":c.x=r;break;case"r":c.x=r-u.width;break;case"c":c.x=r-u.width/2}return"fill"==o&&n.fillText(t,c.x,i),"stroke"==o&&n.strokeText(t,c.x,i),c}function e(n,e){var t=n.font.replace(/^[0-9\.]+/,"");n.font=e+t}return{draw:n,setFontSize:e}}(),requireSimulator.setName("fukidashi"),requireSimulator.setName("runtime"),requirejs(["ImageList","TextRect","fukidashi"],function(){}),requireSimulator.setName("runScript"),requirejs(["fs/ROMk","FS","Tonyu.Project","Shell","KeyEventChecker","ScriptTagFS","runtime"],function(n,e,t,r,i,a){$(function(){function n(){i=$(window).width(),s=$(window).height(),o.attr({width:i,height:s})}Tonyu.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32}],sounds:[]},SplashScreen={hide:function(){$("#splash").hide()},show:function(){}};var i=$(window).width(),s=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var o=$("<canvas>").attr({width:i,height:s}).appendTo("body");$(window).resize(n);var u=location.href.replace(/\?.*/,"").split(/\//),c=u.pop();c.length<0&&(u="runscript");var l=e.get("/Tonyu/"+c+"/"),f=a.toObj();for(var p in f){var h=l.rel(p);h.text(f[p])}r.cd(l);var d="Main",m=$("script");m.each(function(){var n=this;if("text/tonyu"==n.type){var e=$(n).data("filename");if(e){var t=l.rel(e);$(n).data("main")&&(d=t.truncExt(".tonyu"))}}}),Tonyu.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:d,bootClass:"Boot"},kernelEditable:!1};var v=e.get("/Tonyu/Kernel/"),g=t(l,v),y=g.getOptions();y.compiler&&y.compiler.diagnose&&(y.compiler.diagnose=!1,g.setOptions(y)),g.runScriptMode=!0,g.rawRun(y.run.bootClass)})}),requireSimulator.setName();