function fukidashi(n,e,t,r,i){var a="c",o=20,s=5,u=TextRect.draw(n,e,t,r-o-s-i,i,a);n.beginPath(),n.moveTo(t,r),n.lineTo(t+s,r-o),n.lineTo(t+u.w/2+s,r-o),n.lineTo(t+u.w/2+s,r-o-u.h-2*s),n.lineTo(t-u.w/2-s,r-o-u.h-2*s),n.lineTo(t-u.w/2-s,r-o),n.lineTo(t-s,r-o),n.closePath(),n.fill(),n.stroke();var l=n.fillStyle;n.fillStyle=n.strokeStyle,TextRect.draw(n,e,t,r-o-s-i,i,a,"fill"),n.fillStyle=l}!function(){var n={};return n.def=function(e,t,r){var i=n.getModuleInfo(n.curName);i.type=r,n.setReqs(i,e),i.func=function(){return t.apply(this,n.getObjs(e))},n.loadIfAvailable(i)},define=function(e,t){n.def(e,t,"define")},require=requirejs=function(e,t){n.def(e,t,"require")},n.setReqs=function(e,t){t.forEach(function(t){var r=n.getModuleInfo(t);r.loaded||(e.reqs[t]=r,r.revReqs[e.name]=e)})},n.getModuleInfo=function(e){var t=n.modules;return t[e]||(t[e]={name:e,reqs:{},revReqs:{}}),t[e]},n.doLoad=function(e){var t=n.getModuleInfo(e);if(t.loaded)return t.obj;t.loaded=!0;var r=null;if(t.func)r=t.func();else{var i=e.split(/\./);r=function(){return this}(),i.forEach(function(n){r&&(r=r[n])}),null==r&&console.log("Warning: No obj for "+e)}if("define"==t.type&&null==r)throw"No obj for "+e;t.obj=r;for(var a in t.revReqs)n.notifyLoaded(t.revReqs[a],t.name);return r},n.notifyLoaded=function(e,t){delete e.reqs[t],n.loadIfAvailable(e)},n.loadIfAvailable=function(e){for(var t in e.reqs)return;n.doLoad(e.name)},n.getObjs=function(e){var t=[];return e.forEach(function(e){var r=n.doLoad(e);t.push(r)}),t},n.modules={},n.setName=function(e){n.curName&&(n.getModuleInfo(n.curName).func||n.doLoad(n.curName)),e&&(n.curName=e)},requireSimulator=n,n}(),requireSimulator.setName("WebSite"),define([],function(){var n=document.location.href,e=!!n.match(/html\/dev\//)&&!!n.match(/localhost:3/);return window.WebSite=n.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/j/D/9/q/jD9qQ.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:e,pluginTop:"http://tonyuedit.appspot.com/js/plugins"}:n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)||(n.match(/^file:/)||n.match(/localhost/)||n.match(/tonyuedit\.appspot\.com/))&&n.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:e}:{urlAliases:{},top:"../..",devMode:e},window.WebSite.pluginTop||(window.WebSite.pluginTop=window.WebSite.top+"/js/plugins"),window.WebSite.disableROM={},n.match(/tonyuedit\.appspot\.com/)||n.match(/localhost:8888/),(n.match(/\.appspot\.com/)||n.match(/localhost:888[87]/))&&(window.WebSite.serverType="GAE"),n.match(/localhost:3000/)&&(window.WebSite.serverType="Node"),window.WebSite.serverTop=n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)?window.WebSite.top+"/exe":window.WebSite.top+"/edit",window.WebSite.sampleImg=window.WebSite.top+"/images",window.WebSite.blobPath=window.WebSite.serverTop+"/serveBlob",window.WebSite.isNW="object"==typeof process&&process.__node_webkit,window.WebSite.tonyuHome="/Tonyu/",window.WebSite.isNW&&(window.WebSite.tonyuHome=process.env.TONYU_HOME?process.env.TONYU_HOME.replace(/\\/g,"/"):process.cwd().replace(/\\/g,"/").replace(/\/$/,"")+"/fs/Tonyu/"),window.WebSite}),requireSimulator.setName("FS"),define(["WebSite"],function(n){function e(n,e){if(e)for(var t in e)n[t]=e[t]}function t(n,e){return n.substring(n.length-e.length)===e}function r(n,e){return n.substring(0,e.length)===e}function i(){return(new Date).getTime()}function a(n){var e=n.split(E);return""==e[e.length-1]&&(e[e.length-2]+=E,e.pop()),e}function o(n){for(var e in R){var t=n.substring(0,e.length),r=n.substring(e.length);if(t==e)return{rom:R[e],rel:r}}return null}function s(n){return f(n)?P:localStorage}function u(n,e){var t=s(n),r=o(n);if(2!=arguments.length)return r?r.rom[r.rel]:t[n];if(r)throw new Error(n+" is Read only.");return null!=e?t[n]=e:void delete t[n]}function l(n){var e=s(n),t=o(n);return t?t.rel in t.rom:n in e}function c(n,e,t,r){if(null==n)throw new Error("putDir: Null path");if(!y(n))throw new Error("Not a directory : "+n);r==b?P[n]=e:u(n,JSON.stringify(e));var i=v(n);if(null!=i){var a=p(i,r);h(a,i,x(n),t,r)}}function f(n){return"ALL"==k?!0:"object"==typeof k&&k?n in k:!1}function p(n,r){if(null==n)throw new Error("getDir: Null path");t(n,E)||(n+=E);var i={},a={};if(r&b&&(a=P[n]||{}),r&T)try{var o=u(n);o&&(i=JSON.parse(o))}catch(s){console.log("dinfo err : "+n+" - "+i)}e(i,a),e(i,D[n]);for(var l in i)"number"==typeof i[l]&&(i[l]={lastUpdate:i[l]});return i}function h(n,e,t,r,a){n[t]||(n[t]={},r&&(n[t].trashed=!0)),r||delete n[t].trashed,n[t].lastUpdate=i(),c(e,n,r,a)}function d(n,e,t,r){n[t]&&(n[t]={lastUpdate:i(),trashed:!0},c(e,n,!0,r))}function m(n,e,t,r){n[t]&&(delete n[t],c(e,n,!0,r))}function v(n){if(n==E)return null;var e=a(n);return e[e.length-1]="",e.join(E)}function g(n){return r(n,E)}function y(n){return t(n,E)}function x(n){var e=a(n);return e[e.length-1]}if(n.isNW){var w=require("SFileNW");return"object"==typeof window&&(window.FS=w),w}var b=1,T=2,S=3,P={},k=null;("undefined"==typeof localStorage||null==localStorage)&&(console.log("FS: Using RAMDisk"),k="ALL");var j={};"object"==typeof window&&(window.FS=j),j.ramDisk=P,j.ramDiskUsage=k;var R={},D={},E="/";j.roms=R,j.romParents=D,j.endsWith=t,j.splitPath=a,j.orderByNewest=function(n,e){if(!(n&&e&&n.lastUpdate&&e.lastUpdate))return 0;var t=n.lastUpdate(),r=e.lastUpdate();return r>t?1:t>r?-1:0},j.orderByName=function(n,e){return n.name&&e.name&&(n=n.name(),e=e.name()),n>e?1:e>n?-1:0},j.orderByNumberedName=function(n,e){function t(n){for(var e=[],t=/^[0-9]*/,r=/^[^0-9]*/;n&&(n.match(r),e.push(RegExp.lastMatch),n=n.replace(r,""));){n.match(t);var i=parseInt(RegExp.lastMatch);e.push(i),n=n.replace(t,"")}return e}n.name&&e.name&&(n=n.name(),e=e.name());var r,i=t(n),a=t(e);for(r=0;r<i.length;r++){if(r>=a.length)return 1;if(i[r]>a[r])return 1;if(i[r]<a[r])return-1}return r<a.length?-1:0},j.importDir=function(n){var e=j.get(n.base);n.confirm||e.mkdir();var t=n.data,r=[];for(var i in t){var a=e.path()+i,o=j.get(a);if(r.push("["+(o.isReadOnly()?"ro":o.exists()?"exists":"new")+"]"+a),!o.isReadOnly()&&!n.confirm)if(o.isDir()){var s=p(a,T),l=JSON.parse(t[i]);for(var f in l)s[f]=l[f];c(a,s,!1,T)}else u(a,t[i])}return r},j.mountROM=function(n){console.log("ROM mouted on ",n.base),R[n.base]=n.data;var e=a(n.base),t=e.pop(),r=e.join(E)+E;D[r]||(D[r]={}),D[r][t]={lastUpdate:(new Date).getTime()}};var $="DONOTEXPORT";return j.exportDir=function(n,e){function t(r){var a=r.relPath(n);if(i[a]=r.text(),e.keepCR||(i[a]=i[a].replace(/\r/g,"")),r.isDir()){if(r.rel($).exists())return;r.each(t)}}e||(e={}),"string"==typeof n&&(n=j.get(n));var r={base:n.path()},i=r.data={};return t(n),r},j.get=function(n,e){if(e||(e={}),null==n)throw new Error("FS.get: Null path");if(n.isDir)return n;if(e.topDir&&!r(n,e.topDir))throw new Error(n+" is out of securtyDomain");if(!g(n))throw new Error(n+": Path must starts with '/'");var i,s=v(n),w=x(n);if(y(n)){var R=i={};R.files=function(n,e){var t=[];return R.each(function(n){t.add(n)},e),t},R.each=function(n,e){R.ls(e).forEach(function(e){var t=R.rel(e);n(t)})},R.recursive=function(n,e){R.each(function(e){e.isDir()?e.recursive(n):n(e)},e)},R.listFiles=function(e){var t;"function"==typeof e&&(t=e),e=R.convertOptions(e),t||(t=e.order);var r=p(n,S),i=[];for(var a in r)(e.includeTrashed||!r[a].trashed)&&(e.excludes[n+a]||i.push(R.rel(a)));return"function"==typeof t&&i.sort&&i.sort(t),i},R.ls=function(n){var e=R.listFiles(n),t=[];return e.forEach(function(n){t.push(n.name())}),t},R.convertOptions=function(e){if(e||(e={}),e.excludes||(e.excludes={}),e.excludes instanceof Array){var t={};e.excludes.forEach(function(e){r(e,"/")?t[e]=1:t[n+e]=1}),e.excludes=t}return e},R.isDir=function(){return!0},R.rel=function(n){var t=a(n),r=R.path();return r=r.replace(/\/$/,""),t.forEach(function(n){".."==n||"../"==n?r=v(r):(r=r.replace(/\/$/,""),r+=E+("."==n||"./"==n?"":n))}),j.get(r,e)},R.rm=function(){if(!R.exists())throw new Error(n+": No such dir.");var e=R.ls();if(e.length>0)throw new Error(n+": Directory not empty");if(null!=s){var t=R.mediaType(),r=p(s,t);d(r,s,w,t)}},R.removeWithoutTrash=function(){var e=R.mediaType();if(R.each(function(n){n.removeWithoutTrash()},{includeTrashed:!0}),u(n,null),null!=s){var t=p(s,e);m(t,s,w,e)}},R.mkdir=function(){R.touch()},R.text=function(){return u(n)},R.obj=function(){return JSON.parse(R.text())},R.exists=function(){if("/"==n)return!0;var e=p(s,S);return e&&e[w]&&!e[w].trashed},R.mediaType=function(){return P[n]&&!localStorage[n]?b:T}}else{var D=i={};D.isDir=function(){return!1},D.rm=function(){if(!D.exists())throw new Error(n+": No such file.");if(u(n,null),null!=s){var e=D.mediaType(),t=p(s,e);d(t,s,w,e)}},D.removeWithoutTrash=function(){if(!D.exists()&&!D.isTrashed())throw new Error(n+": No such file.");if(u(n,null),null!=s){var e=D.mediaType(),t=p(s,e);m(t,s,w,e)}},D.text=function(){return 0==arguments.length?u(n):(u(n,arguments[0]),void D.touch())},D.lines=function(){return D.text().split("\n")},D.obj=function(){if(0==arguments.length){var n=D.text();return n?JSON.parse(n):null}D.text(JSON.stringify(arguments[0]))},D.copyFrom=function(n,e){D.text(n.text()),e.a&&D.metaInfo(n.metaInfo())},D.exists=function(){return l(n)},D.useRAMDisk=function(){return"ALL"!=k?(k=k||{},k[n]=!0,D):void 0},D.mediaType=function(){return f(n)?b:T}}return i.relPath=function(e){var t=e.path?e.path():e;if(t.substring(t.length-1)!=E)throw new Error(t+" is not a directory.");return n.substring(0,t.length)!=t?"../"+i.relPath(e.up()):n.substring(t.length)},i.isTrashed=function(){var n=i.metaInfo();return n?n.trashed:!1},i.metaInfo=function(){if(null!=s){var n;if(0==arguments.length)return n=p(s,S),n[w];var e=i.mediaType();n=p(s,e),n[w]=arguments[0],c(s,n,n[w].trashed,e)}return{}},i.lastUpdate=function(){return i.metaInfo().lastUpdate},i.up=function(){return null==s?null:j.get(s,e)},i.path=function(){return n},i.name=function(){return w},i.truncExt=function(n){return w.substring(0,w.length-n.length)},i.touch=function(){if(null!=s){var n=i.mediaType(),e=p(s,n);h(e,s,w,!1,n)}},i.isReadOnly=function(){var e=o(n);return!!e},i.startsWith=function(n){return r(w,n)},i.endsWith=function(n){return t(w,n)},i.equals=function(e){return e&&"function"==typeof e.path&&e.path()==n},i.toString=function(){return n},i},j.scan=function(){for(var n in localStorage)if(g(n)){var e=v(n);if(null!=e){var t=p(e,T),r=x(n);h(t,e,r,t[r]&&t[r].trashed,T)}}},j.dump=function(){for(var n in localStorage)console.log(n)},j.ls=function(n){return j.get(n).ls()},j}),requireSimulator.setName("fs/ROMk"),function(){var n={base:"/Tonyu/Kernel/",data:{"":'{".desktop":{"lastUpdate":1424849946377},"Actor.tonyu":{"lastUpdate":1425004177938},"BaseActor.tonyu":{"lastUpdate":1425018531557},"BodyActor.tonyu":{"lastUpdate":1425555929415},"Boot.tonyu":{"lastUpdate":1425019818961},"DxChar.tonyu":{"lastUpdate":1421384204610},"EventMod.tonyu":{"lastUpdate":1425010352383},"InputDevice.tonyu":{"lastUpdate":1416890086000},"Keys.tonyu":{"lastUpdate":1412697666000},"Map.tonyu":{"lastUpdate":1421122943495},"MapEditor.tonyu":{"lastUpdate":1421122943503},"MathMod.tonyu":{"lastUpdate":1424849946395},"MediaPlayer.tonyu":{"lastUpdate":1421384204625},"MML.tonyu":{"lastUpdate":1424849946399},"NoviceActor.tonyu":{"lastUpdate":1412697666000},"Pad.tonyu":{"lastUpdate":1421122943510},"Panel.tonyu":{"lastUpdate":1424849946404},"PlainChar.tonyu":{"lastUpdate":1421384204651},"PlayMod.tonyu":{"lastUpdate":1425018365373},"ScaledCanvas.tonyu":{"lastUpdate":1421122943524},"SecretChar.tonyu":{"lastUpdate":1421384204695},"SpriteChar.tonyu":{"lastUpdate":1421384204710},"Sprites.tonyu":{"lastUpdate":1421122943538},"T1Line.tonyu":{"lastUpdate":1421384204718},"T1Map.tonyu":{"lastUpdate":1421384204728},"T1Page.tonyu":{"lastUpdate":1421384204737},"T1Text.tonyu":{"lastUpdate":1421384204745},"T2Body.tonyu":{"lastUpdate":1425264703379},"T2Mod.tonyu":{"lastUpdate":1425020004839},"T2World.tonyu":{"lastUpdate":1425266002500},"TextChar.tonyu":{"lastUpdate":1421384204762},"TObject.tonyu":{"lastUpdate":1421122943543},"TQuery.tonyu":{"lastUpdate":1412697666000},"WaveTable.tonyu":{"lastUpdate":1412697666000}}',".desktop":'{"runMenuOrd":["Main0121","Main1023","TouchedTestMain","Main2","MapLoad","Main","AcTestM","NObjTest","NObjTest2","AcTest","AltBoot","Ball","Bar","Bounce","MapTest","MapTest2nd","SetBGCTest","Label","PanelTest","BaseActor","Panel","MathMod"]}',"Actor.tonyu":'extends BaseActor;\nincludes PlayMod;\nnative Sprites;\nnative Tonyu;\n\n\\new(x,y,p) {\n    super(x,y,p);\n    if (Tonyu.runMode) initSprite();\n}\n\\initSprite() {\n    if(layer && typeof layer.add=="function"){\n        layer.add(this);\n    }else{\n        $Sprites.add(this);\n    }\n    onAppear();\n}\n\\onAppear() {\n}\n',"BaseActor.tonyu":'extends null;\nincludes MathMod,EventMod;\nnative Tonyu;\nnative Key;\nnative console;\nnative Math;\nnative fukidashi;\nnative TextRect;\nnative FS;\nnative Array;\n\n\\new(x,y,p) {\n    if (Tonyu.runMode) {\n        var thg=currentThreadGroup();\n        if (thg) _th=thg.addObj(this);\n    }\n    if (typeof x=="object") Tonyu.extend(this,x); \n    else if (typeof x=="number") {\n        this.x=x;\n        this.y=y;\n        this.p=p;\n    }\n    if (scaleX==null) scaleX=1;\n    if (rotation==null) rotation=0;\n    if (rotate==null) rotate=0;\n    if (alpha==null) alpha=255;\n    if (zOrder==null) zOrder=0;\n    if (age==null) age=0;\n    if (anim!=null && typeof anim=="object"){\n        animMode=true;\n        animFrame=0;\n    }else{\n        animMode=false;\n    }\n    if (animFps==null) animFps=1;\n}\nnowait \\extend(obj) {\n    return Tonyu.extend(this,obj);\n}\n\nnowait \\print(pt) {\n    console.log.apply(console,arguments);\n    if($consolePanel){\n        $consolePanel.scroll(0,20);\n        $consolePanel.setFillStyle("white");\n        $consolePanel.fillText(pt,0,$consolePrintY,20,"left");\n    }\n}\n\nnowait \\setAnimFps(f){\n    this.animFps=f;\n    this.animFrame=0;\n    this.animMode=true;\n}\nnowait \\startAnim(){\n    this.animMode=true;\n}\nnowait \\stopAnim(){\n    this.animMode=false;\n}\n\\update() {\n    onUpdate();\n    if(_thread) {\n        _thread.suspend();\n    }\n}\nnowait \\onUpdate() {\n    \n}\n\\updateEx(updateT){\n    for(var updateCount=0;updateCount<updateT;updateCount++){\n        update();\n    }\n}\nnowait \\getkey(k) {\n    return $Keys.getkey(k);\n}\nnowait \\hitTo(t) {\n    return crashTo(t);\n}\nnowait \\all(c) {\n    var res=new TQuery;\n    $Sprites.sprites.forEach \\(s) {\n        if (s===this) return;\n        if (!c || s instanceof c) {\n            res.push(s);\n        }\n    };\n    return res;// new TQuery{objects:res};\n}\nnowait \\allCrash(t) {\n    var res=new TQuery;\n    var sp=this; //_sprite || this;\n    var t1=getCrashRect();\n    if (!t1) return res;\n    $Sprites.sprites.forEach(\\(s) {\n        var t2;\n        if (s!==this && \n        !s.excludeFromAll &&\n        s instanceof t && \n        (t2=s.getCrashRect()) &&\n        Math.abs(t1.x-t2.x)*2<t1.width+t2.width &&\n        Math.abs(t1.y-t2.y)*2<t1.height+t2.height) {\n            res.push(s);    \n        }\n    });\n    return res;\n}\nnowait \\crashTo(t) {\n    if (!t) return false;\n    if (typeof t=="function") {\n        return allCrash(t)[0];\n    }\n    return crashTo1(t);\n}\nnowait \\crashTo1(t) {\n    if (!t || t._isDead) return false;\n    /*if (_sprite && t._sprite) {\n        return _sprite.crashTo(t._sprite);\n    }*/\n    var t1=getCrashRect();\n    var t2=t.getCrashRect();\n    return \n    //    t1.x!=null && t1.y!=null && t1.width && t1.height &&\n    //    t2.x!=null && t2.y!=null && t2.width && t2.height &&\n    t1 && t2 &&\n    Math.abs(t1.x-t2.x)*2<t1.width+t2.width &&\n    Math.abs(t1.y-t2.y)*2<t1.height+t2.height;\n}\nnowait \\getCrashRect() {\n    var actWidth=width*scaleX, actHeight;\n    if(typeof scaleY==="undefined"){\n        actHeight=height*scaleX;\n    }else{\n        actHeight=height*scaleY;\n    }\n    return typeof x=="number" &&\n    typeof y=="number" &&\n    typeof width=="number" &&\n    typeof height=="number" && \n    {x,y,width:actWidth,height:actHeight};\n}\nnowait \\within(t,distance){\n    if(!t || t._isDead) return false;\n    if(Math.sqrt(Math.abs(x-t.x)*Math.abs(x-t.x)+ Math.abs(y-t.y)*Math.abs(y-t.y))<distance){\n        return true;\n    }\n    return false;\n}\nnowait \\watchHit(typeA,typeB,onHit) {\n    $Sprites.watchHit(typeA , typeB, \\(a,b) {\n        onHit.apply(this,[a,b]);\n    });\n}\nnowait \\currentThreadGroup() {\n    return $currentThreadGroup; \n}\nnowait \\die() {\n    if (_th) {\n        _th.kill();\n    }\n    hide();\n    fireEvent("die");\n    _isDead=true;\n}\nnowait \\hide() {\n    /*if (_sprite) {\n        $Sprites.remove(_sprite);\n        _sprite=null;\n    } else {*/\n        //$Sprites.remove(this);\n    //}\n    if(layer && typeof layer.remove=="function"){\n        layer.remove(this);\n    }else{\n        $Sprites.remove(this);\n    }\n}\nnowait \\show(x,y,p) {\n    if(layer && typeof layer.add=="function"){\n        layer.add(this);\n    }else{\n        $Sprites.add(this);\n    }\n    if (x!=null) this.x=x;\n    if (y!=null) this.y=y;\n    if (p!=null) this.p=p;\n}\n\nnowait \\detectShape() {\n    if (typeof p!="number") {\n        if (text!=null) return;\n        p=0;\n    }\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) return;\n    width=pImg.width;\n    height=pImg.height;\n}\n\\waitFor(f) {\n    ifwait {\n        _thread.waitFor(f);\n    }\n    update();\n}\nnowait \\isDead() {\n    return _isDead;\n}\n\nnowait \\animation(){\n    age++;\n    if(animMode && age%animFps==0){\n        p=anim[animFrame%anim.length];\n        animFrame++;\n    }\n}\nnowait \\draw(ctx) {\n    if (x==null || y==null || _isInvisible) return;\n    detectShape();\n    if (pImg) {\n        ctx.save();\n        ctx.translate(x,y);\n        //if (typeof rotate=="number" ) rotation=rotate;// 削除予定\n        //ctx.rotate(this.rotation/180*Math.PI);\n        animation();\n        if(this.rotation!=0){\n            ctx.rotate(this.rotation/180*Math.PI);\n        }else{\n            ctx.rotate(this.rotate/180*Math.PI);\n        }\n        if(typeof this.scaleY==="undefined") {\n            ctx.scale(this.scaleX,this.scaleX);\n        }else{\n            ctx.scale(this.scaleX,this.scaleY);\n        }\n        ctx.globalAlpha=this.alpha/255;\n        ctx.drawImage(\n        pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n        -width/2, -height/2, width, height);\n        ctx.restore();\n    } else if (text!==null && text!==undefined) {\n        if (!size) size=15;\n        if (!align) align="center";\n        if (!fillStyle) fillStyle="white";\n        ctx.fillStyle=fillStyle;\n        ctx.globalAlpha=this.alpha/255;\n        var rect=TextRect.draw(ctx, text, x, y, size, align , "fill");\n        width=rect.w;\n        height=rect.h;\n    }\n    if (_fukidashi) {\n        if (_fukidashi.c>0) {\n            _fukidashi.c--;\n            ctx.fillStyle="white";\n            ctx.strokeStyle="black";\n            fukidashi ( ctx , _fukidashi.text, \n            x, y-height/2-10, _fukidashi.size);\n        }\n    }\n}\nnowait \\asyncResult() {\n    return Tonyu.asyncResult();\n}\n\n\\screenOut(a) {\n    //オブジェクトが画面外に出たかどうかを判定します。\n    if (!a) a=0;\n    var r=0;\n    var viewX=0,viewY=0;\n    if (x<viewX+a)               r+=viewX+a-x;\n    if (y<viewY+a)               r+=viewY+a-y;\n    if (x>$screenWidth +viewX-a) r+=x-($screenWidth +viewX-a);\n    if (y>$screenHeight+viewY-a) r+=y-($screenHeight+viewY-a);\n    return r;\n}\n\\file(path) {\n    var d=Tonyu.currentProject.getDir();\n    var files=d.rel("files/");\n    return FS.get(files.rel(path)) {topDir:d};\n}\n\\waitInputDevice(fl) {\n    if (fl!==false) {\n        if (!origTG) {\n            ifwait {\n                origTG=_thread.group;\n                _thread.setGroup(null);\n            }\n        }\n        a=asyncResult();\n        $InputDevice.addOnetimeListener(a.receiver);\n        waitFor(a);\n    } else {\n        if (origTG) {\n            ifwait {\n                _thread.setGroup(origTG);\n                origTG=null;\n            }\n        }\n    }\n}\n\\redrawScreen() {\n    $Sprites.draw($Screen.buf[0]);\n    $Screen.draw();\n}\n\n// from PlainChar\n\\color(r,g,b) {\n    return "rgb("+[r,g,b].join(",")+")";\n}\n\\drawText(x,y,text,col,size) {\n    if ($debug) return;\n    if (!size) size=15;\n    if (!col) col="cyan";\n    var tp=all(T1Text).find \\(t) {return t.hidden;};\n    if (tp.length>0) {\n        tp[0].extend{x,y,text,fillStyle:col, size,hidden:false};\n    }else {\n        new T1Text{x,y,text,fillStyle:col, size};  \n    }\n}\n\\drawLine(x,y,tx,ty,col) {\n    if (!col) col="white";\n    var tp=all(T1Line).find \\(t) {return t.hidden;};\n    if (tp.length>0) {\n        tp[0].extend{x,y,tx,ty,col};\n    }else {\n        new T1Line{x,y,tx,ty,col};  \n    }\n}\n\\loadPage(page,arg){\n    all().die();\n    new page(arg);\n    die();\n}\n\n\\setVisible(v) {\n    _isInvisible=!v;\n}',"BodyActor.tonyu":'extends Actor;\nincludes T2Mod;\nnative Box2D;\n\n\\getWorld() {\n    if ($t2World) return $t2World;\n    $t2World=new T2World;\n    return $t2World;\n}\n\\onAppear() {\n    world=getWorld().world;\n    scale=getWorld().scale;\n    var b2Vec2 = Box2D.Common.Math.b2Vec2;\n    var b2BodyDef = Box2D.Dynamics.b2BodyDef;\n    var b2Body = Box2D.Dynamics.b2Body;\n    var b2FixtureDef = Box2D.Dynamics.b2FixtureDef;\n    var b2Fixture = Box2D.Dynamics.b2Fixture;\n    var b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape;\n    var b2CircleShape = Box2D.Collision.Shapes.b2CircleShape;\n    \n    var fixDef = new b2FixtureDef;\n    fixDef.density = density || 1.0;\n    fixDef.friction = friction || 0.5;\n    fixDef.restitution = restitution || 0.2;\n    \n    var bodyDef = new b2BodyDef;\n    bodyDef.type = isStatic ? b2Body.b2_staticBody :\n    b2Body.b2_dynamicBody;\n    \n    bodyDef.position.x = x /scale;\n    bodyDef.position.y = y /scale;\n    shape=shape || (radius ? "circle" : "box");\n    var w=width,h=height;\n    if (!w) {\n        detectShape();\n        w=width*(scaleX||1);\n        h=height*(scaleY||scaleX||1);\n    }\n    if (shape=="box") {\n        if (!h) h=w;\n        fixDef.shape = new b2PolygonShape;\n        fixDef.shape.SetAsOrientedBox(w/2/scale, h/2/scale,\n        new b2Vec2(0,0),0);\n    } else {\n        radius=radius || w/2 || 16;\n        fixDef.shape = new b2CircleShape(\n        radius/scale\n        );\n        width=height=radius*2;\n    } \n    body=world.CreateBody(bodyDef);\n    body.CreateFixture(fixDef);\n    body.SetUserData(this);\n    body.SetAngle(rad(rotation));\n}\n\\allContact(klass) {\n    var res=[];\n    for (var c=world.GetContactList();c;c=c.GetNext()) {\n        if (c.IsTouching()) {\n            var a=c.GetFixtureA().GetBody().GetUserData();\n            var b=c.GetFixtureB().GetBody().GetUserData();\n            if (a===this) {\n                if (!klass || b===klass || b instanceof klass) {\n                    res.push(b);\n                }\n            } else if (b===this) {\n                if (!klass || a===klass || a instanceof klass) {\n                    res.push(a);\n                }\n            }\n        }\n    }\n    return res;\n}\n\\applyForce(fx,fy,px,py) {\n    var b2Vec2 = Box2D.Common.Math.b2Vec2;\n    var scale=getWorld().scale;\n    var fps=60;\n    body.ApplyForce(new b2Vec2(fx ,fy),body.GetPosition());\n}\n\\applyImpulse(fx,fy,px,py) {\n    var b2Vec2 = Box2D.Common.Math.b2Vec2;\n    var scale=getWorld().scale;\n    var fps=60;\n    body.ApplyImpulse(new b2Vec2(fx ,fy),body.GetPosition());\n}\n\n\\applyTorque(a) {\n    body.ApplyTorque(a);\n}\n\\moveBy(dx,dy) {\n    var pos=body.GetPosition();\n    pos.x+=dx/scale;\n    pos.y+=dy/scale;\n    body.SetPosition(pos);\n}\n\\contactTo(t) {\n    return allContact(t)[0];\n}\n\\die() {\n    super.die();\n    world.DestroyBody(body);\n}\n\\updatePos() {\n    if (!body) return;\n    var scale=getWorld().scale;\n    var pos=body.GetPosition();\n    x=pos.x*scale;\n    y=pos.y*scale;\n    rotation=deg(body.GetAngle());\n}\n\n',"Boot.tonyu":'extends Actor;\nnative $;\nnative TError;\nnative $LASTPOS;\nnative Key;\nnative Date;\nnative ImageList;\nnative Tonyu;\nnative SplashScreen;\nnative Math;\n\n\\initSprites() {\n    $Sprites=new Sprites();\n    $FrontSprites=new Sprites();\n    print ("Loading plugins..");\n    var a=asyncResult();\n    $currentProject.loadPlugins(a.receiver);\n    waitFor(a);\n    print ("Loading pats..");\n    var rs=$currentProject.getResource();\n    a=asyncResult();\n    ImageList.load( rs.images, a.receiver)\n    {baseDir:$currentProject.getDir()};\n    waitFor(a);\n    var r=a[0];\n    $Sprites.setImageList(r);\n    for (var name,val in r.names) {\n        Tonyu.setGlobal(name, val);\n    }\n    print ("Loading pats done.");\n    cvj=$("canvas");\n    if (Tonyu.noviceMode) {\n        $Screen=new ScaledCanvas{canvas:cvj, width:600, height:300};\n    } else {\n        $Screen=new ScaledCanvas{canvas:cvj, width:465, height:465};\n    }\n}\n\n\n\\initThread() {\n    $mainThreadGroup=thg=Tonyu.threadGroup();\n    var o=Tonyu.currentProject.getOptions();\n    var mainClassName=o.run.mainClass;\n    print("MainClass= "+mainClassName);\n    mainClass=Tonyu.getClass(mainClassName);\n    if (!mainClass) {\n        TError( mainClassName+" というクラスはありません", \n        "不明" ,0).raise();\n    }\n    Tonyu.runMode=true;\n    $currentThreadGroup=thg;\n    new mainClass();\n}\n\\stop() {\n    fireEvent("stop");\n}\ninitSprites();\n$InputDevice=new InputDevice;\n$InputDevice.initCanvasEvents(cvj);\ninitThread();\n\n$pat_fruits=30;\n$Keys=new Keys;\n$Math=Math;\n$consolePanel=new Panel{align:"center",x:465/2,y:465/2,width:465,height:465,zOrder:-10,layer:$FrontSprites};\n$consolePrintY=465-15;\n$panel=new Panel{align:"center",x:$screenWidth/2,y:$screenHeight/2,width:$screenWidth,height:$screenHeight,zOrder:-1,layer:$FrontSprites};\nif (typeof SplashScreen!="undefined") SplashScreen.hide();\ninitFPSParams();\n\nwhile (true) {\n    thg.steps();\n    $Keys.update();\n    $InputDevice.update();\n    $screenWidth=$Screen.width;\n    $screenHeight=$Screen.height;\n    \n    doDraw=now()<deadLine;\n    if (!doDraw && frameSkipped>=maxFrameSkip) {\n        doDraw=true;\n        resetDeadLine();\n    }\n    if (doDraw) { // フレームスキップの時は描画しない\n        $Screen.fillCanvas($Screen.buf[0]);\n        $Sprites.draw($Screen.buf[0]);\n        $FrontSprites.draw($Screen.buf[0]);\n        $Screen.draw();\n        fps_fpsCnt ++;\n        frameSkipped=0;\n    } else {\n        frameSkipped++;\n    }\n    $Sprites.checkHit();\n    fps_rpsCnt ++;\n    measureFps();\n    waitFrame(); // FPS制御\n    while(paused) {\n        waitFor(Tonyu.timeout(1)); \n        if (!paused) resetDeadLine();\n    }\n}\n\nnowait \\initFPSParams() {\n    // フレームレートの設定\n    _fps = 30;\n    maxframeSkip = 5;\n    // フレームレート制御でつかう変数 //\n    frameCnt = 0;\n    resetDeadLine();\n    $Boot = this;\n    lastMeasured=now();\n    fps_fps=fps_rps=fps_fpsCnt=fps_rpsCnt=0;\n}\nnowait \\now() {\n    return new Date().getTime();\n}\nnowait \\resetDeadLine() {\n    deadLine=now()+1000/_fps;\n    frameSkipped = 0;\n}\n\n\\waitFrame() {\n    var wt=deadLine-now();\n    if (wt<1) {\n        if (wt<-1000) resetDeadLine();\n        wt=1;\n    }\n    wt=floor(wt);\n    waitFor(Tonyu.timeout(wt));\n    deadLine+=1000/_fps;\n}\n\nnowait \\getFrameRate() {\n    return _fps;\n}\n\n// Tonyu1の$System.setFrameRate() //\nnowait \\setFrameRate(fps, maxFrameSkip) {\n    _fps = fps;\n    if (typeof maxFrameSkip!="number") maxFrameSkip=5;\n    this.maxFrameSkip = maxFrameSkip;\n    resetDeadLine();\n}\n\n// FPS（計測したフレームレート）を返す //\nnowait \\getMeasuredFps() {\n    return fps_fps;\n}\n\n// RPS（計測した実行レート）を返す //\nnowait \\getMeasuredRps() {\n    return fps_rps;\n}\n\nnowait \\measureFps() {\n    if (now()>lastMeasured+1000) {\n        fps_fps=fps_fpsCnt;\n        fps_rps=fps_rpsCnt;\n        fps_fpsCnt=0;\n        fps_rpsCnt=0;\n        lastMeasured=now();\n    }\n}\n\n',"DxChar.tonyu":"extends SpriteChar;\n\n\\new (xx,yy,pp,ff,sz,rt,al){\n    super(xx,yy,pp,ff);\n    scaleX=1;\n    if (sz) scaleX=sz;\n    angle=0;\n    if (rt) angle=rt;\n    alpha=255;\n    if (al) alpha=al;\n}\n\\draw(c) {\n    rotation=angle;\n    super.draw(c);\n}\n","EventMod.tonyu":"extends null;\n\n\\getEventHandlers(type) {\n    if (!_handlers) _handlers={};\n    if (!_handlers[type]) _handlers[type]=[];\n    return _handlers[type];\n}\n\\on(type, handler) {\n    getEventHandlers(type).push(handler);\n}\n\n\\fireEvent(type,args) {\n    if (!args) args=[];\n    for (var h in getEventHandlers(type)) {\n        h.apply(this,args);\n    }\n}\n","InputDevice.tonyu":'extends null;\nnative $;\nnative window;\nnative Tonyu;\n\\new() {\n    listeners=[];\n    touchEmu=true;\n}\n\\handleListeners() {\n    var l=listeners;\n    listeners=[];\n    while (l.length>0) { (l.shift())(); }\n}\n\\addOnetimeListener(l){\n    listeners.push(l);\n}\n\\initCanvasEvents(cvj) {\n    var cv=cvj[0];\n    $handleMouse=\\(e) {\n        var p=cvj.offset();\n        var mp={x:e.clientX-p.left, y:e.clientY-p.top};\n        mp=$Screen.canvas2buf(mp);\n        $mouseX=mp.x;\n        $mouseY=mp.y;\n        if (touchEmu) {\n            $touches[0].x=mp.x;\n            $touches[0].y=mp.y;\n        }\n        handleListeners();\n    };\n    $touches=[{},{},{},{},{}];\n    $touches.findById=\\(id) {\n        for (var j=0 ; j<$touches.length ; j++) {\n            if ($touches[j].identifier==id) {\n                return $touches[j];\n            }\n        }\n    };\n    $handleTouch=\\(e) {\n        touchEmu=false;\n        var p=cvj.offset();\n        e.preventDefault();\n        var ts=e.originalEvent.changedTouches;\n        for (var i =0 ; i<ts.length ; i++) {\n            var src=ts[i];\n            var dst=$touches.findById(src.identifier);\n            if (!dst) {\n                for (var j=0 ; j<$touches.length ; j++) {\n                    if (!$touches[j].touched) {\n                        dst=$touches[j];\n                        dst.identifier=src.identifier;\n                        break;\n                    }\n                }\n            }\n            if (dst) {\n                mp={x:src.pageX-p.left, y:src.pageY-p.top};\n                mp=$Screen.canvas2buf(mp);\n                dst.x=mp.x;\n                dst.y=mp.y;\n                if(!dst.touched) dst.touched=1;\n            }\n        }\n        $mouseX=$touches[0].x;\n        $mouseY=$touches[0].y;\n        handleListeners();\n    };\n    $handleTouchEnd=\\(e) {\n        var ts=e.originalEvent.changedTouches;\n        for (var i =0 ; i<ts.length ; i++) {\n            var src=ts[i];\n            var dst=$touches.findById(src.identifier);\n            if (dst) {\n                dst.touched=0;\n                dst.identifier=-1;\n            }\n        }\n        handleListeners();\n    };\n    var handleMouse=\\(e){$handleMouse(e);};\n    var handleTouch=\\(e){$handleTouch(e);};\n    var handleTouchEnd=\\(e){$handleTouchEnd(e);};\n    var d=$.data(cv,"events");\n    if (!d) {\n        $.data(cv,"events","true");\n        cvj.mousedown(handleMouse);\n        cvj.mousemove(handleMouse);\n        cvj.on("touchstart",handleTouch);\n        cvj.on("touchmove",handleTouch);\n        cvj.on("touchend",handleTouchEnd);\n    }\n}\n\n\\update() {\n    for (var i in $touches) {\n        if (i.touched>0) {i.touched++;}\n        if (i.touched==-1) i.touched=1;\n    }\n}',"Keys.tonyu":'extends TObject;\nnative String;\nnative $;\nnative document;\n//\\new () {this.main();}\nstats={};\ncodes={\n    left: 37 , up:38 , right: 39, down:40, space:32, enter:13,\n    shift:16, ctrl:17, alt:18, mouseleft: 1\n};\nfor (var i=65 ; i<65+26; i++) {\n    codes[String.fromCharCode(i).toLowerCase()]=i;\n}\nfor (var i=48 ; i<58; i++) {\n    codes[String.fromCharCode(i)]=i;\n}\nif (!$.data(document,"key_event")) {\n    $.data(document,"key_event",true);\n    $(document).keydown \\(e) {$Keys.keydown(e);};\n    $(document).keyup \\(e) {$Keys.keyup(e);};\n    $(document).mousedown \\(e) {\n        if ($InputDevice.touchEmu) {\n            $touches[0].touched=1;\n        }\n        $Keys.keydown{keyCode:1};\n    };\n    $(document).mouseup \\(e) {\n        if ($InputDevice.touchEmu) {\n            $touches[0].touched=0;\n        }\n        $Keys.keyup{keyCode:1};\n    };\n}\nfunction getkey(code) {\n    if (typeof code=="string") {\n        code=codes[code.toLowerCase()];\n    }\n    if (!code) return 0;\n    if (stats[code]==-1) return 0;\n    if (!stats[code]) stats[code]=0;\n    return stats[code];\n}\nfunction update() {\n    for (var i in stats) {\n        if (stats[i]>0) {stats[i]++;}\n        if (stats[i]==-1) stats[i]=1;\n    }\n}\n\\keydown(e) {\n    var s=stats[e.keyCode];\n    if (!s) {\n        stats[e.keyCode]=1;\n    }\n    $InputDevice.handleListeners();\n}\n\\keyup(e) {\n    stats[e.keyCode]=0;\n    $InputDevice.handleListeners();\n}',"MML.tonyu":'extends TObject;\nincludes MathMod;\nnative T;\n\nmmlBuf=[];\n\\play(mmls) {\n    mmlBuf.push(mmls);\n    if (!isPlaying()) {\n        playNext();\n    }\n}\n\\playNext() {\n    //print("play!", id(), bufferCount());\n    if (cTimeBase==null) cTimeBase=0;\n    if (m) {\n        cTimeBase+=m.currentTime;\n        //print(m.currentTime);\n    }\n    var mml=mmlBuf.shift();\n    if (!mml) {\n        m=null;\n        cTimeBase=0;\n        return;\n    }\n    mwav=$WaveTable.get(0,0).play();\n    m=T("mml", {mml}, mwav);\n    m.on("ended", playNext);\n    m.start();\n    $MMLS[id()]=this;\n}\n\\id() {\n    if (!_id) _id=rnd()+"";\n    return _id;\n}\n\\bufferCount() {\n    return mmlBuf.length;\n}\n\\isPlaying() {\n    return m;\n}\n\\currentTime() {\n    if (m) return m.currentTime+cTimeBase;\n    return -1;\n}\n\\stop() {\n    if (m) {\n        if (mwav) {\n            mwav.pause();\n            mwav.stop();\n        }\n        m.pause();\n        m.stop();\n        m=null;\n        mmlBuf=[];\n        //print("stop!", id(), bufferCount());\n        delete $MMLS[id()];\n    }\n}\n',"Map.tonyu":'extends Actor;\nnative Math;\nnative $;\n\\new (param){\n    sx=0;\n    sy=0;\n    super(param);\n    buf=$("<canvas>").attr{width:col*chipWidth,height:row*chipHeight};\n    mapObj=true;\n    mapTable = [];\n    mapOnTable = [];\n    for(var j=0;j<row;j++){\n        rows = [];\n        for(var i=0;i<col;i++){\n            rows.push(-1);\n        }\n        mapTable.push(rows);\n    }\n    for(var j=0;j<row;j++){\n        rows = [];\n        for(var i=0;i<col;i++){\n            rows.push(-1);\n        }\n        mapOnTable.push(rows);\n    }\n    /*for(var i=0;i<col;i++){\n        mapTable[i]=[];\n    }*/\n    initMap();\n}\n\\initMap(){\n    if(!mapData) return;\n    for(var i=0;i<row;i++){\n        for(var j=0;j<col;j++){\n            set(j,i,mapData[i][j]);\n        }\n    }\n    if(!mapOnData) return;\n    for(var i=0;i<row;i++){\n        for(var j=0;j<col;j++){\n            setOn(j,i,mapOnData[i][j]);\n        }\n    }\n}\n\\load(dataFile){\n    baseData=file("../maps/").rel(dataFile).obj();\n    if(!baseData) baseData=file(dataFile).obj();\n    mapTable=baseData[0];\n    mapData=mapTable;\n    row=mapTable.length;\n    col=mapTable[0].length;\n    mapOnTable=baseData[1];\n    mapOnData=mapOnTable;\n    buf=$("<canvas>").attr{width:col*chipWidth,height:row*chipHeight};\n    initMap();\n}\n\\set(setCol,setRow,p){\n    if(setCol>=col || setRow>=row || setCol<0 || setRow<0) return;\n    mapTable[setRow][setCol]=p;\n    //mapOnTable[setRow][setCol]=-1;\n    ctx=buf[0].getContext("2d");\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) {\n        ctx.clearRect(setCol*chipWidth,setRow*chipHeight,chipWidth,chipHeight);\n        return;\n    }\n    ctx.clearRect(setCol*chipWidth,setRow*chipHeight,chipWidth,chipHeight);\n    ctx.save();\n    ctx.drawImage(\n    pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n    setCol*chipWidth, setRow*chipHeight, chipWidth, chipHeight);\n    ctx.restore();\n}\n\\setOn(setCol,setRow,p){\n    if(setCol>=col || setRow>=row || setCol<0 || setRow<0) return;\n    set(setCol,setRow,mapTable[setRow][setCol]);\n    mapOnTable[setRow][setCol]=p;\n    ctx=buf[0].getContext("2d");\n    p=Math.floor(p);\n    pImg=$Sprites.getImageList()[p];\n    if (!pImg) return;\n    ctx.save();\n    ctx.drawImage(\n    pImg.image, pImg.x, pImg.y, pImg.width, pImg.height,\n    setCol*chipWidth, setRow*chipHeight, chipWidth, chipHeight);\n    ctx.restore();\n}\n\\setOnAt(setX,setY,p){\n    setOn(Math.floor(setX/chipWidth),Math.floor(setY/chipHeight),p);\n}\n\\setAt(setX,setY,p){\n    set(Math.floor(setX/chipWidth),Math.floor(setY/chipHeight),p);\n}\n\\get(getCol,getRow){\n    if(getCol<col && getRow<row && getCol>=0 && getRow>=0) return mapTable[getRow][getCol];\n    return -1;\n}\n\\getAt(getX,getY){\n    return get(Math.floor(getX/chipWidth),Math.floor(getY/chipHeight));\n}\n\\getOn(getCol,getRow){\n    if(getCol<col && getRow<row && getCol>=0 && getRow>=0) return mapOnTable[getRow][getCol];\n    return -1;\n}\n\\getOnAt(getX,getY){\n    return getOn(Math.floor(getX/chipWidth),Math.floor(getY/chipHeight));\n}\n\\scrollTo(scrollX,scrollY){\n    sx=-scrollX;\n    sy=-scrollY;\n}\n\\draw(ctx) {\n    pImg=buf[0];\n    ctx.save();\n    ctx.drawImage(\n    pImg, 0, 0,col*chipWidth, row*chipHeight,\n    sx, sy, col*chipWidth, row*chipHeight);\n    ctx.restore();\n}\n',"MapEditor.tonyu":'extends Actor;\nnative prompt;\nloadMode=false;\nprint("Load Data?: Y or N");\nwhile(true){\n    if(getkey("y")>0){\n        loadMode=true;\n        break;\n    }\n    if(getkey("n")>0){\n        loadMode=false;\n        break;\n    }\n    update();\n}\nif(loadMode){\n    fileName=prompt("Input json file (*.json)","map.json");\n    if(fileName){\n        mapDataFile=file("../maps/").rel(fileName);\n    }\n    if(mapDataFile.obj()){\n        baseData=mapDataFile.obj();\n    }else{\n        mapDataFile=file(fileName);\n        if(mapDataFile.obj()){\n            baseData=mapDataFile.obj();\n        }\n    }\n    if(baseData==undefined){\n        print("Load failed");\n        loadMode=false;\n    }else if(baseData[0] && baseData[1]){\n        mapData=baseData[0];\n        mapOnData=baseData[1];\n    }\n}\nupdate();\n//if(mapData){\n    /*\n    print("Load Data?: Y or N");\n    while(true){\n        if(getkey("y")==1){\n            loadMode=true;\n            break;\n        }\n        if(getkey("n")==1){\n            loadMode=false;\n            break;\n        }\n    }*/\n//}\nif(!loadMode){\n    row=prompt("input row");\n    update();\n    col=prompt("input col");\n    panel=new Panel{width:col*32,height:row*32};\n    panel.x=panel.width/2+10;\n    panel.y=panel.height/2;\n    panel.setFillStyle("cyan");\n    panel.fillRect(0,0,panel.width,panel.height);\n    $map=new Map{row,col,chipWidth:32,chipHeight:32};\n}else{\n    if(!mapOnData){\n        $map=new Map{row:mapData.length,col:mapData[0].length,chipWidth:32,chipHeight:32,mapData};\n    }else{\n        $map=new Map{row:mapData.length,col:mapData[0].length,chipWidth:32,chipHeight:32,mapData,mapOnData};\n    }\n    panel=new Panel{width:$map.col*32,height:$map.row*32,zOrder:100};\n    panel.x=panel.width/2;\n    panel.y=panel.height/2;\n    panel.setFillStyle("cyan");\n    panel.fillRect(0,0,panel.width,panel.height);\n}\n$mp=new Map{row:16,col:8,chipWidth:32,chipHeight:32};\ncounter=0;\nfor(var i=0;i<16;i++){\n    for(var j=0;j<8;j++){\n        $mp.set(j,i,$pat_mapchip+counter);\n        counter++;\n    }\n}\nmode="get";\nprevMode="set";\nmapp=0;\nmx=0;\nmy=0;\nchipX=0;\nchipY=0;\nx=$screenWidth-16;\ny=$screenHeight-16;\nwhile(true){\n    p=mapp;\n    if(getkey("e")==1){\n        $mp.scrollTo(1000,1000);\n        mode="erase";\n        print(mode+" mode");\n    }\n    if(getkey("s")==1){\n        $mp.scrollTo(1000,1000);\n        if(mode=="set"){\n            mode="setOn";\n        }else{\n            mode="set";\n        }\n        print(mode+" mode");\n    }\n    if(getkey("o")==1){\n        $mp.scrollTo(1000,1000);\n        mode="setOn";\n    }\n    if(getkey("g")==1){\n        if(mode!="get"){\n            prevMode=mode;\n            $mp.scrollTo(0,0);\n            mode="get";\n            chipX=0;\n            chipY=0;\n        }else{\n            $mp.scrollTo(1000,1000);\n            mode=prevMode;\n        }\n        print(mode+" mode");\n    }\n    if(getkey("p")==1){\n        //add\n        saveFileName=prompt("input json file(*.json)","map.json");\n        /*print("mapTable=[");\n        data="[";\n        for(var i=0;i<$map.row-1;i++){\n            var tmp=[];\n            tmp=$map.mapTable[i].concat(tmp);\n            print("["+tmp+"],");\n            data+="["+tmp+"],";\n        }\n        var tmp=[];\n        tmp=$map.mapTable[i].concat(tmp);\n        print("["+tmp+"]");\n        data+="["+tmp+"]";\n        print("];");\n        data+="]";*/\n        //add\n        saveDataFile=file("../maps/").rel(saveFileName);\n        data=[$map.mapTable,$map.mapOnTable];\n        //comment\n        //mapDataFile.obj(data);\n        //add\n        saveDataFile.obj(data);\n        print(saveFileName+" Saved");\n        //mapDataFile.obj.push($map.mapOnTable);\n    }\n    if(getkey("c")==1){\n        $mp.scrollTo(1000,1000);\n        mode="spuit";\n        print(mode+" mode");\n    }\n    if(mode!="get"){\n        if(getkey("left")>0) mx=mx+8;\n        if(getkey("right")>0) mx=mx-8;\n        if(getkey("up")>0) my=my+8;\n        if(getkey("down")>0) my=my-8;\n        $map.scrollTo(mx,my);\n    }else{\n        if(getkey("left")>0) chipX=chipX+8;\n        if(getkey("right")>0) chipX=chipX-8;\n        if(getkey("up")>0) chipY=chipY+8;\n        if(getkey("down")>0) chipY=chipY-8;\n        $mp.scrollTo(chipX,chipY);\n    }\n    panel.x=panel.width/2-mx;\n    panel.y=panel.height/2-my;\n    if(mode=="set" && getkey(1)>0){\n        $map.setAt($mouseX+mx,$mouseY+my,mapp);\n        $map.setOnAt($mouseX+mx,$mouseY+my,-1);\n    }else if(mode=="erase" && getkey(1)>0){\n        $map.setAt($mouseX+mx,$mouseY+my,-1);\n    }else if(mode=="get" && getkey(1)>0){\n        mapp=$mp.getAt($mouseX+chipX,$mouseY+chipY);\n        mode=prevMode;\n        $mp.scrollTo(1000,1000);\n        print(mode+" mode");\n        updateEx(10);\n    }else if(mode=="setOn" && getkey(1)>0){\n        $map.setOnAt($mouseX+mx,$mouseY+my,mapp);\n    }else if(mode=="spuit" && getkey(1)>0){\n        mapp=$map.getAt($mouseX+mx,$mouseY+my);\n        mode="set";\n        print(mode+" mode");\n        updateEx(10);\n    }\n    update();\n}',"MathMod.tonyu":'extends null;\nnative Math;\n\nnowait \\sin(d) {\n    return Math.sin(rad(d));\n}\nnowait \\cos(d) {\n    return Math.cos(rad(d));\n}\nnowait \\rad(d) {\n    return d/180*Math.PI;\n}\nnowait \\deg(d) {\n    return d/Math.PI*180;\n}\n\nnowait \\abs(v) {\n    return Math.abs(v);\n}\nnowait \\atan2(x,y) {\n    return deg(Math.atan2(x,y));\n}\nnowait \\floor(x) {\n    return Math.floor(x);\n}\nnowait \\angleDiff(a,b) {\n    var c;\n    a=floor(a);\n    b=floor(b);\n    if (a>=b) {\n        c=(a-b) % 360;\n        if (c>=180) c-=360;\n    } else {\n        c=-((b-a) % 360);\n        if (c<-180) c+=360;\n    }\n    return c;\n}\nnowait \\sqrt(t) {\n    return Math.sqrt(t);\n}\nnowait \\dist(dx,dy) {\n    if (typeof dx=="object") {\n        var t=dx;\n        dx=t.x-x;dy=t.y-y;\n    }\n    return sqrt(dx*dx+dy*dy);\n}\nnowait \\trunc(f) {\n    if(f>=0) return Math.floor(f);\n    else return Math.ceil(f);\n}\nnowait \\ceil(f){\n    return Math.ceil(f);\n}\n\nnowait \\rnd(r) {\n    if (typeof r=="number") {\n        return Math.floor(Math.random()*r);\n    }\n    return Math.random();\n}',"MediaPlayer.tonyu":"\n\\play() {\n    \n}\n\\stop() {\n    \n}\n\\playSE() {\n    \n}\n\\setDelay(){\n    \n}\n\\setVolume(){\n    \n}","NoviceActor.tonyu":"extends BaseActor;\nnative Tonyu;\n\n\\sleep(n) {\n    if(!n) n=1;\n    for(n;n>0;n--) update();\n}\n\\initSprite() {\n    if (!_sprite) {\n        _sprite=new BaseActor{owner:this};// Sprites.add{owner:this};\n        $Sprites.add(this);\n    }\n}\n\\say(text,size) {\n    if (!size) size=15;\n    initSprite();\n    _sprite._fukidashi={text:text, size:size, c:30};\n}\n\\sprite(x,y,p) {\n    go(x,y,p);\n}\n\\show(x,y,p) {\n    go(x,y,p);\n}\nnowait \\draw(ctx) {\n    _sprite.draw(ctx);\n}\n\\getCrashRect() {\n    return _sprite.getCrashRect();\n}\n\\go(x,y,p) {\n    initSprite();\n    _sprite.x=x;\n    _sprite.y=y;\n    if (p!=null) _sprite.p=p;\n    //update();\n}\n\\change(p) {\n    initSprite();\n    _sprite.p=p;\n}","Pad.tonyu":"extends Actor;\n\\new(opt) {\n    super(opt);\n    padImageP = $pat_inputPad;\n    jujiKey = new Actor{x:96+1, y:$screenHeight-96-1, p:padImageP+0,zOrder:-9,layer:$FrontSprites};\n    no1Key = new Actor{x:$screenWidth-96, y:$screenHeight-96, p:padImageP+1,zOrder:-9,layer:$FrontSprites};\n    jujiKey.show();\n    no1Key.show();\n    \n    jujiKeyPushU = new Actor{x:jujiKey.x, y:jujiKey.y-60, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushL = new Actor{x:jujiKey.x-60, y:jujiKey.y, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushR = new Actor{x:jujiKey.x+60, y:jujiKey.y, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushD = new Actor{x:jujiKey.x, y:jujiKey.y+60, p:padImageP+2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPush1 = new Actor{x:no1Key.x, y:no1Key.y, p:padImageP+2, scaleX:2, zOrder:-10,layer:$FrontSprites};\n    jujiKeyPushU.hide();\n    jujiKeyPushL.hide();\n    jujiKeyPushR.hide();\n    jujiKeyPushD.hide();\n    jujiKeyPush1.hide();\n}\n\\die(){\n    jujiKey.die();\n    no1Key.die();\n    jujiKeyPushU.die();\n    jujiKeyPushL.die();\n    jujiKeyPushR.die();\n    jujiKeyPushD.die();\n    jujiKeyPush1.die();\n    super.die();\n}\nAPAD_DIAG_SIZE = 96;\n\\padUpdate() {\n    // 操作 //\n    keyPushL = 0;\n    keyPushR = 0;\n    keyPushU = 0;\n    keyPushD = 0;\n    keyPush1 = 0;\n    \n    padKeyNotapCnt ++;\n    for (var i=0; i<5; i++) { // タップ判定・マウス判定 //\n        var t = $touches[i];\n        if (t.touched) {\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-APAD_DIAG_SIZE/2, jujiKey.y-32-64, 64+APAD_DIAG_SIZE, 64)) keyPushU = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-APAD_DIAG_SIZE/2, jujiKey.y-32+64, 64+APAD_DIAG_SIZE, 64)) keyPushD = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32-64, jujiKey.y-32-APAD_DIAG_SIZE/2, 64, 64+APAD_DIAG_SIZE)) keyPushL = 1;\n            if (isOnRectWH(t.x, t.y, jujiKey.x-32+64, jujiKey.y-32-APAD_DIAG_SIZE/2, 64, 64+APAD_DIAG_SIZE)) keyPushR = 1;\n            if (isOnRectWH(t.x, t.y, no1Key.x-64, no1Key.y-64, 128, 128)) keyPush1 = 1;\n            padKeySW = 1;\n            padKeyNotapCnt = 0;\n        }\n    }\n    \n    // カウントアップ\n    if (keyPushL) keyCntL ++; else keyCntL = 0;\n    if (keyPushR) keyCntR ++; else keyCntR = 0;\n    if (keyPushU) keyCntU ++; else keyCntU = 0;\n    if (keyPushD) keyCntD ++; else keyCntD = 0;\n    if (keyPush1) keyCnt1 ++; else keyCnt1 = 0;\n    \n    // 表示\n    if (keyPushL) jujiKeyPushL.show(); else jujiKeyPushL.hide();\n    if (keyPushR) jujiKeyPushR.show(); else jujiKeyPushR.hide();\n    if (keyPushU) jujiKeyPushU.show(); else jujiKeyPushU.hide();\n    if (keyPushD) jujiKeyPushD.show(); else jujiKeyPushD.hide();\n    if (keyPush1) jujiKeyPush1.show(); else jujiKeyPush1.hide();\n    \n}\n\n\\getPadUp()    { return keyCntU; }\n\\getPadDown()  { return keyCntD; }\n\\getPadLeft()  { return keyCntL; }\n\\getPadRight() { return keyCntR; }\n\\getPadButton(i) {\n    var value;\n    if (i == 0) value = keyCnt1;\n    return value;\n}\n\n\\getUp()    { return keyCntU; }\n\\getDown()  { return keyCntD; }\n\\getLeft()  { return keyCntL; }\n\\getRight() { return keyCntR; }\n\\getButton(i) {\n    var value;\n    if (i == 0) value = keyCnt1;\n    return value;\n}\n\n// 範囲 //\n\\isOnRect(mx, my, rx, ry, rx2, ry2) {\n    return (rx <= mx && mx < rx2 && ry <= my && my < ry2);\n}\n\n// 範囲 //\n\\isOnRectWH(mx, my, rx, ry, rw, rh) {\n    return (rx <= mx && mx < rx+rw && ry <= my && my < ry+rh);\n}\n\nwhile(true) {\n    padUpdate();\n    update();\n}","Panel.tonyu":'extends Actor;\nnative $;\nnative Math;\nnative isNaN;\n\\new(opt){\n    super(opt);\n    this.width=width;\n    this.height=height;\n    if(align==null) align="center";\n    if(alpha==null) alpha=255;\n    buf=$("<canvas>").attr{width,height};\n}\n\\setPanel(width,height){\n    this.width=width;\n    this.height=height;\n    buf=$("<canvas>").attr{width,height};\n}\n\\setFillStyle(color){\n    this.fillStyle=color;\n}\n\\fillRect(x,y,rectWidth,rectHeight){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    //ctx.clearRect(0,0,this.width,this.height);\n    ctx.fillStyle=fillStyle;\n    ctx.fillRect(x,y,rectWidth,rectHeight);\n    ctx.restore();\n}\n\\fillText(text,x,y,size,align){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    //ctx.clearRect(0,0,this.width,this.height);\n    ctx.textAlign = align;\n    ctx.fillStyle=fillStyle;\n    ctx.font=size+"px \'Courier New\'";\n    ctx.fillText(text,x,y);\n    ctx.restore();\n}\n\\clearRect(clearX,clearY,clearW,clearH){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    ctx.clearRect(clearX,clearY,clearW,clearH);\n    ctx.restore();\n}\n\\getPixel(getX,getY){\n    if(typeof getX=="number" && !isNaN(getX) && \n    typeof getY=="number" && !isNaN(getY)){\n        ctx=buf[0].getContext("2d");\n        imagedata=ctx.getImageData(getX,getY,1,1);\n        colordata=[imagedata.data[0],imagedata.data[1],imagedata.data[2],imagedata.data[3]];\n        //print(imagedata.data);\n    }else{\n        colordata=[0,0,0,0];\n    }\n    return(colordata);\n}\n\\scroll(scrollX,scrollY){\n    ctx=buf[0].getContext("2d");\n    ctx.save();\n    imagedata=ctx.getImageData(0,0,this.width,this.height);\n    clearRect(0,0,width,height);\n    ctx.putImageData(imagedata,-scrollX,-scrollY);\n    ctx.restore();\n}\n\\draw(ctx){\n    pImg=buf[0];\n    ctx.save();\n    if(align=="left"){\n        ctx.translate(x+width/2,y+height/2);\n    }else if(align=="center"){\n        ctx.translate(x,y);\n    }else if(align=="right"){\n        ctx.translate(x-width/2,y-height/2);\n    }\n    if(this.rotation!=0){\n        ctx.rotate(this.rotation/180*Math.PI);\n    }else{\n        ctx.rotate(this.rotate/180*Math.PI);\n    }\n    ctx.globalAlpha=this.alpha/255;\n    ctx.drawImage(\n    pImg, 0, 0,width,height,\n    -width/2, -height/2, width ,height);\n    ctx.restore();\n}',"PlainChar.tonyu":'native Tonyu;\nnative Math;\n\\new(x,y,p) {\n    if (Tonyu.runMode) {\n        var thg=currentThreadGroup();\n        if (thg) _th=thg.addObj(this,"tMain");\n        initSprite();\n    }\n    if (typeof x=="object") Tonyu.extend(this,x); \n    else if (typeof x=="number") {\n        this.x=x;\n        this.y=y;\n        this.p=p;\n    }\n}\n\\draw(c) {\n    onDraw();\n    if (_isInvisible) return;\n    super.draw(c);\n}\n\\setVisible(v) {\n    _isInvisible=!v;\n}\n\\onDraw() {\n    \n}\n\\update() {\n    onUpdate();\n    super.update();\n}\n\\onUpdate() {\n    \n}\n\\initSprite() {\n    if(layer && typeof layer.add=="function"){\n        layer.add(this);\n    }else{\n        $Sprites.add(this);\n    }\n    onAppear();\n}\n\\tMain() {\n    main();\n    die();\n}\n\\color(r,g,b) {\n    return "rgb("+[r,g,b].join(",")+")";\n}\n\\drawText(x,y,text,col,size) {\n    if ($debug) return;\n    if (!size) size=15;\n    if (!col) col="cyan";\n    var tp=all(T1Text).find \\(t) {return t.hidden;};\n    if (tp.length>0) {\n        tp[0].extend{x,y,text,fillStyle:col, size,hidden:false};\n    }else {\n        new T1Text{x,y,text,fillStyle:col, size};  \n    }\n}\n\\drawLine(x,y,tx,ty,col) {\n    if (!col) col="white";\n    var tp=all(T1Line).find \\(t) {return t.hidden;};\n    if (tp.length>0) {\n        tp[0].extend{x,y,tx,ty,col};\n    }else {\n        new T1Line{x,y,tx,ty,col};  \n    }\n}\n\\appear(t) {\n    return t;\n}\n\\trunc(f) {\n    return Math.trunc(f);\n}\n\\loadPage(page,arg){\n    all().die();\n    new page(arg);\n    die();\n}',"PlayMod.tonyu":'extends BaseActor;\nnowait \\initMML() {\n    if (mmlInited) return;\n    mmlInited=true;\n    $currentProject.requestPlugin("timbre");\n    if (!$MMLS) {\n       $MMLS={};\n       $WaveTable=new WaveTable;\n       $Boot.on("stop", releaseMML);\n    }\n    on("die") \\() { play().stop(); };\n}\nnowait \\releaseMML() {\n    if ($MMLS) {\n       for (var k,v in $MMLS) {\n          v.stop();\n       }\n       $MMLS=null;\n    } \n    if ($WaveTable) {\n       $WaveTable.stop();\n       $WaveTable=null;\n    }\n}\n\\play() {\n    initMML();\n    if (!_mml) _mml=new MML;\n    if (isDead() || arguments.length==0) return _mml;\n    var mmls=[];\n    for (var i=0; i<arguments.length; i++) {\n        mmls.push(arguments[i]);\n    }\n    _mml.play(mmls);\n    while (_mml.bufferCount()>2) {\n        update();\n    }\n    return _mml;\n}\nnowait \\playSE() {\n    initMML();\n    var mml=new MML;\n    var mmls=[];\n    for (var i=0; i<arguments.length; i++) {\n        mmls.push(arguments[i]);\n    }\n    mml.play(mmls);\n    return mml;\n}\n',"ScaledCanvas.tonyu":'extends Actor;\nnative $;\nnative Math;\n\n// canvas:phisical  buf: logical\n\\new (opt) {\n    extend(opt);\n    // canvas/ width,height\n    resize(width, height);\n    cw=canvas.width();\n    ch=canvas.height();\n    cctx=canvas[0].getContext("2d");\n    this.color="rgb(20,80,180)";\n    sx=0;\n    sy=0;\n    isDrawGrid=$Sprites.isDrawGrid;\n}\n\\resize(width,height) {\n    this.width=width;\n    this.height=height;\n    buf=$("<canvas>").attr{width,height};\n    ctx=buf[0].getContext("2d");  \n    $screenWidth=width;\n    $screenHeight=height;\n    if($panel){\n        $panel.setPanel($screenWidth,$screenHeight);\n    }\n}\n\\shouldDraw1x1(srcw,srch,dstw,dsth) {\n    // srcw=465 -> dstw=460...665\n    var larger=200;\n    var smaller=5;\n    return srcw-smaller<=dstw && dstw<=srcw+larger &&\n    srch-smaller<=dsth && dsth<=srch+larger;\n}\n\\draw() {\n    cw=canvas.width();\n    ch=canvas.height();\n    var calcw=ch/height*width; // calch=ch\n    var calch=cw/width*height; // calcw=cw\n    if (calch>ch) calch=ch;\n    if (calcw>cw) calcw=cw;\n    cctx.clearRect(0,0,cw,ch);\n    if (shouldDraw1x1(width,height,calcw,calch)) {\n        calcw=width;calch=height;\n    }\n    var marginw=Math.floor((cw-calcw)/2);\n    var marginh=Math.floor((ch-calch)/2);\n    cctx.drawImage(buf[0],\n    0,0,width, height, \n    marginw,marginh,calcw, calch );\n}\n\\canvas2buf(point) {\n    var calcw=ch/height*width; // calch=ch\n    var calch=cw/width*height; // calcw=cw\n    if (calch>ch) calch=ch;\n    if (calcw>cw) calcw=cw;\n    if (shouldDraw1x1(width,height,calcw,calch)) {\n        calcw=width;calch=height;\n    }\n    var marginw=Math.floor((cw-calcw)/2);\n    var marginh=Math.floor((ch-calch)/2);\n    \n    return {x: (point.x-marginw)/calcw*width, \n    y: (point.y-marginh)/calch*height};\n}\n\\setBGColor(color){\n    this.color=color;\n}\n\\fillCanvas(cv){\n    var ctx=cv.getContext("2d");\n    ctx.save();\n    ctx.fillStyle=$Screen.color;\n    ctx.fillStyle=color;\n    ctx.fillRect(0,0,cv.width,cv.height);\n    if (isDrawGrid) drawGrid(cv);\n    ctx.restore();\n}\n\\scrollTo(scrollX,scrollY){\n    /*for(o in all()){\n        //print(o.mapObj);\n        if(o.mapObj){\n            o.scrollTo(o.sx+scrollX,o.sy+scrollY);\n        }else if(o.x!=undefined && o.y!=undefined){\n            o.x+=scrollX;\n            o.y+=scrollY;\n        }\n    }*/\n    //sx=scrollX;\n    //sy=scrollY;\n    $Sprites.scrollTo(scrollX,scrollY);\n}',"SecretChar.tonyu":"extends PlainChar;\n\n\\draw(c) {\n    \n}","SpriteChar.tonyu":"extends PlainChar;\n\n\\new(x,y,p,f) {\n    super(x,y,p);\n    this.f=f;\n    if (!this.x) this.x=0;\n    if (!this.y) this.y=0;\n    if (!this.p) this.p=0;\n}\n\\draw(c) {\n    if (f) {\n        if (!scaleY) scaleY=scaleX;\n        scaleX*=-1;\n    }\n    super.draw(c);\n    if (f) scaleX*=-1;\n}","Sprites.tonyu":'extends Actor;\nnative Tonyu;\n\\new() {\n    sprites=[];\n    imageList=[];\n    hitWatchers=[];\n    isDrawGrid=Tonyu.noviceMode;\n    sx=0;\n    sy=0;\n    objId=0;\n}\nfunction add(s) {\n    if (s.__addedToSprites) return;\n    sprites.push(s);\n    if(s.__genId==null){\n        s.__genId=objId;\n        objId++;\n    }\n    s.__addedToSprites=this;\n    return s;\n}\nfunction remove(s) {\n    var idx=sprites.indexOf(s);\n    if (idx<0) return;\n    sprites.splice(idx,1);\n    delete s.__addedToSprites;\n}\nfunction clear() {sprites.splice(0,sprites.length);}\nfunction compOrder(obj1, obj2){\n    var val1=obj1.zOrder;\n    var val2=obj2.zOrder;\n    if(val1>val2){\n        return -1;\n    }else if(val1<val2){\n        return 1;\n    }else if(val1==val2){\n        if(obj1.__genId>obj2.__genId){\n            return 1;\n        }else{\n            return -1;\n        }\n        return 0;\n    }\n}\nfunction draw(cv) {\n    var ctx=cv.getContext("2d");\n    ctx.save();\n    /*\n    ctx.fillStyle=$Screen.color;\n    ctx.fillRect(0,0,cv.width,cv.height);\n    if (isDrawGrid) drawGrid(cv);\n    */\n    var orderArray=[];\n    orderArray=orderArray.concat(sprites);\n    orderArray.sort(compOrder);\n    ctx.translate(-sx,-sy);\n    orderArray.forEach(\\(s){\n        s.draw(ctx);\n    });\n    ctx.restore();\n}\nfunction checkHit() {\n    hitWatchers.forEach(function (w) {\n        sprites.forEach(function (a) {\n            //console.log("a:",  a.owner);\n            var a_owner=a;//a.owner|| a;\n            if (! (a_owner instanceof w.A)) return;\n            sprites.forEach(function (b) {\n                var b_owner=b;//b.owner|| b;\n                if (a===b) return;\n                if (! (b_owner instanceof w.B)) return;\n                //console.log("b:",  b.owner);\n                if (a.crashTo1(b)) {\n                    //console.log("hit", a.owner, b.owner);\n                    w.h(a_owner,b_owner);\n                }\n            });\n        });\n    });\n}\nfunction watchHit(typeA, typeB, onHit) {\n    var p={A: typeA, B:typeB, h:onHit};\n    //console.log(p);\n    hitWatchers.push(p);\n}\nfunction drawGrid(c) {\n    var ctx=c.getContext("2d");\n    ctx.textBaseline="top";\n    ctx.save();\n    ctx.strokeStyle="rgb(40,100,200)";\n    for (var i=0 ; i<c.width ; i+=10) {\n        ctx.beginPath();\n        ctx.lineWidth=(i % 100 ==0 ? 4 : 1);\n        ctx.moveTo(i,0);\n        ctx.lineTo(i,c.height);\n        ctx.closePath();\n        ctx.stroke();\n    }\n    \n    for (var i=0 ; i<c.height ; i+=10) {\n        ctx.beginPath();\n        ctx.lineWidth=(i % 100 ==0 ? 4 : 1);\n        ctx.moveTo(0,i);\n        ctx.lineTo(c.width,i);\n        ctx.closePath();\n        ctx.stroke();\n    }\n    ctx.fillStyle="white";\n    ctx.font="15px monospaced";\n    for (var i=100 ; i<c.width ; i+=100) {\n        ctx.fillText(i, i,0);\n    }\n    for (var i=100 ; i<c.height ; i+=100) {\n        ctx.fillText(i, 0,i);\n    }\n    ctx.restore();\n}\nfunction setImageList(il) {\n    imageList=il;\n}\nfunction getImageList() {\n    return imageList;\n}\nfunction scrollTo(scrollX,scrollY){\n    sx=scrollX;\n    sy=scrollY;\n}',"T1Line.tonyu":"\\draw(ctx) {\n    if (hidden) return;\n    \n    ctx.strokeStyle=col;\n    ctx.beginPath();\n    ctx.moveTo(x,y);\n    ctx.lineTo(tx,ty);\n    ctx.stroke();\n    hidden=true;\n}\n","T1Map.tonyu":'extends Map;\nnative Tonyu;\nnative $;\n\n\\setBGColor(c) {\n    $Screen.setBGColor(c);\n}\n\\load(fileName) {\n    /*\n    o={\n        "chipWidth":"32","chipHeight":"32",\n        "pTable":[{name:"$pat_aaa", p:10}, {name:"$pat_bbb","p":25} ],\n        "baseData":[\n        [//map\n        [0,6],[0,5],[1,3],\n        [1,3],[1,2],[0,5]\n        ],\n        [//mapOn\n        [-1,-1],[1,4],[0,2],\n        [-1,-1],[-1,-1],[1,8]\n        ]\n        ]\n    }\n    */\n    var f=file("../maps/").rel(fileName);\n    var o=f.obj();\n    chipWidth=o.chipWidth;\n    chipHeight=o.chipHeight;\n    baseData=o.baseData;\n    mapTable=conv(baseData[0],o.pTable);\n    mapData=mapTable;\n    row=mapTable.length;\n    col=mapTable[0].length;\n    mapOnTable=conv(baseData[1],o.pTable);\n    mapOnData=mapOnTable;\n    \n    buf=$("<canvas>").attr{width:col*chipWidth,height:row*chipHeight};\n    initMap();   \n}\n\\conv(mat, tbl) {\n    var res=[];\n    mat.forEach \\(row) {\n        var rrow=[];\n        res.push(rrow);\n        row.forEach \\(dat) {// dat:[0,20]\n            var t=tbl[dat[0]];\n            if (t) rrow.push(Tonyu.globals[t.name]+dat[1]);\n            else rrow.push(dat[1]);\n        };\n    };\n    return res;\n}',"T1Page.tonyu":"extends PlainChar;\n\n\\initGlobals() {\n    $chars=$Sprites.sprites;\n    $Boot.setFrameRate(60);\n    $clBlack=color(0,0,0);\n    $clRed=color(255,0,0);\n    $clGreen=color(0,255,0);\n    $clYellow=color(255,255,0);\n    $clBlue=color(0,0,255);\n    $clPink=color(255,0,255);\n    $clAqua=color(0,255,255);\n    $clWhite=color(255,255,255);\n    $mplayer=new MediaPlayer;\n}","T1Text.tonyu":"\\draw(c) {\n    if (hidden) return;\n    c.font=size+\"px 'ＭＳ Ｐゴシック'\";\n    \n    super.draw(c);\n    hidden=true;\n}","T2Body.tonyu":"extends BodyActor;\n","T2Mod.tonyu":"native Box2D;\n\n\\bvec(tx,ty) {\n    var b2Vec2 = Box2D.Common.Math.b2Vec2;\n    return new b2Vec2(tx/scale,ty/scale);  \n}","T2World.tonyu":'includes T2Mod;\n\nnative Box2D;\nnative Tonyu;\n\\onAppear() {\n    $currentProject.requestPlugin("box2d");  \n    initWorld();\n}\nloop();\n\n\n\\initWorld() {\n    gravity=gravity || 9.8;\n    gravityX=gravityX || 0;\n    var b2World = Box2D.Dynamics.b2World;\n    var b2Vec2 = Box2D.Common.Math.b2Vec2;\n    scale=scale || 32;\n    world = new b2World(\n    new b2Vec2(gravityX, gravity)    //gravity\n    ,  true                 //allow sleep\n    );\n    $t2World=this;\n    $Boot.on("stop",releaseWorld);\n    on("die",releaseWorld);\n}\n\\releaseWorld() {\n    if ($t2World===this) $t2World=null;\n}\n\n\\loop() {\n    while(true) {\n        world.Step(\n        1 / $Boot.getFrameRate()  //frame-rate\n        ,  10       //velocity iterations\n        ,  10       //position iterations\n        );\n        world.DrawDebugData();\n        world.ClearForces();\n        updatePos();\n        update();\n    }\n}\n\\updatePos() {\n    for (var b=world.GetBodyList();b;b=b.GetNext()) {\n        var d=b.GetUserData();\n        if(d) d.updatePos();\n    }\n}\n',"TObject.tonyu":'extends null;\nnative Tonyu;\n\\new (options) {\n    if (typeof options=="object") extend(options);\n    this.main();\n}\nnowait \\extend(obj) {\n    return Tonyu.extend(this,obj);\n}',"TQuery.tonyu":'extends TObject;\nincludes MathMod;\n\\new () {\n    length=0;\n}\n\\tonyuIterator(arity) {\n    var res={};\n    res.i=0;\n    if (arity==1) {\n        res.next=function () {\n            if (res.i>=this.length) return false;\n            res[0]=this[res.i];\n            res.i++;\n            return true;\n        };\n    } else {\n        res.next=function () {\n            if (res.i>=this.length) return false;\n            res[0]=res.i;\n            res[1]=this[res.i];\n            res.i++;\n            return true;\n        };\n    }\n    return res;\n}\n\\attr() {\n    var values;\n    if (length==0) return;\n    if (arguments.length==1 && typeof arguments[0]=="string") {\n        return this[0][arguments[0]];\n    }\n    if (arguments.length>=2) {\n        values={};\n        for (var i=0 ; i<arguments.length-1 ;i+=2) {\n            values[arguments[i]]=arguments[i+1];\n        }\n    } else {\n        values=arguments[0];\n    }\n    if (values) {\n        for (var e in this) {\n            e.extend( values);\n        }\n    }\n}\n\\genKeyfunc(key) {\n    if (typeof key!="function") {\n        return \\(o) {return o[key];};\n    } else {\n        return key;\n    }\n}\n\\maxs(key) {\n    var f=genKeyfunc(key);\n    var res,reso=new TQuery;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v>=res) {\n            if (v>res) reso=new TQuery;\n            reso.push(o);\n            res=v;\n        }\n    }\n    return reso;\n}\n\\mins(key) {\n    var f=genKeyfunc(key);\n    var res,reso=new TQuery;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v<=res) {\n            if (v<res) reso=new TQuery;\n            reso.push(o);\n            res=v;\n        }\n    }\n    return reso;\n}\n\\minObj(key) {\n    return mins(key)[0];\n}\n\\maxObj(key) {\n    return maxs(key)[0];\n}\n\\nearests(x,y) {\n    if (typeof x=="object") {y=x.y;x=x.x;}\n    return mins \\(o) {\n        return dist(o.x-x,o.y-y);\n    };\n}\n\\nearest(x,y) {\n    return nearests(x,y)[0];\n}\n\\withins(xo,yd,d) {\n    var x,y;\n    if (typeof xo=="object") {\n        x=xo.x;y=xo.y;d=yd;\n    } else {\n        x=xo;y=yd;\n    }\n    return find \\(o) {\n        return dist(o.x-x,o.y-y)<=d;\n    };\n}\n\\within(xo,yd,d) {\n    return withins(xo,yd,d).nearest();\n}\n\n\\max(key) {\n    var f=genKeyfunc(key);\n    var res;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v>res) res=v;\n    }\n    return res;\n}\n\\min(key) {\n    var f=genKeyfunc(key);\n    var res;\n    for (var o in this) {\n        var v=f(o);\n        if (res==null || v<res) res=v;\n    }\n    return res;\n}\n\\push(e) {\n    this[length]=e;\n    length++;\n}\n\\size() {return length;}\n\\find(f) {\n    var no=new TQuery;\n    for (var o in this) {\n        if (f(o)) no.push(o);\n    }\n    return no;\n} \n\\apply(name, args) {\n    var res;\n    if (!args) args=[];\n    for (var o in this) {\n        var f=o[name];\n        if (typeof f=="function") {\n            res=f.apply(o, args);\n        }\n    }\n    return res;\n}\n// \\alive => find \\(o) => !o.isDead()  //  (in future)\n\\alive() {\n    return find \\(o) {\n        return !o.isDead();\n    };\n}\n\\die() {\n    var a=alive();\n    if (a.length==0) return false;\n    a.apply("die");\n    return true;\n}\n\n\\klass(k) {\n    return find \\(o) { return o instanceof k; };\n}',"TextChar.tonyu":'extends PlainChar;\nnative TextRect;\n\n\\new (xx,yy,t,c,s){\n    super(xx,yy);\n    text="";\n    col=$clWhite;\n    size=20;\n    if (!this.x) this.x=0;\n    if (!this.y) this.y=0;\n    if (t) text=t;\n    if (c) fillStyle=c;\n    if (s) size=s;\n}\n\\draw(ctx) {\n    if (!size) size=15;\n    if (!align) align="left";\n    if (!fillStyle) fillStyle="white";\n    ctx.fillStyle=fillStyle;\n    ctx.globalAlpha=this.alpha/255;\n    ctx.font=size+"px \'ＭＳ Ｐゴシック\'";\n    var rect=TextRect.draw(ctx, text, x, y, size, align , "fill");\n    width=rect.w;\n    height=rect.h;\n    \n    //    fillStyle=col;\n    //super.draw(ctx);\n}',"WaveTable.tonyu":'extends TObject;\nnative T;\n\nwav={};\nenv={};\n\\setWav(num, synth) {\n    wav[num]=synth;\n}\n\\setEnv(num, synth) {\n    env[num]=synth;\n}\n\\get(w,e) {\n    var synth=T("OscGen") {osc:wav[w], env:env[e], mul:0.25};\n    return synth;\n}\n\\stop() {\n    /*for (var k,v in tbl) {\n        v.pause();\n        v.stop();\n    }*/\n}\n\nif (typeof T!=="undefined") {\n    //env=T("adsr", {a:0,d:200,s:0.5,r:10});\n    env = T("env",{table:[1, [0.6, 50], [0, 100]], releaseNode:2});\n    setEnv(0, env);\n    setWav(0, T("pulse"));\n    //    synth=T("OscGen") {wave:"pulse", env, mul:0.25};\n    //set(0,synth);    \n}\n'}};
WebSite.devMode||WebSite.disableROM["ROM_k.js"]||WebSite.isNW?n.base="/ROM"+n.base:FS.mountROM(n)}(),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Tonyu=function(){function n(){function n(){return null!=g&&y}function e(){return w}function t(){x=0}function r(n){g={prev:g,func:n}}function a(n,e,t){t||(t=[]),t=[v].concat(t);var i=0;r(function(){switch(i){case 0:n["fiber$"+e].apply(n,t),i=1;break;case 1:l(),i=2}})}function o(){if(g)try{g.func(v)}catch(n){s(n)}}function s(n){if(0==v.tryStack.length)throw n;v.lastEx=n;for(var e=v.tryStack.pop();g;){if(e.frame===g){v.catchPC=e.catchPC;break}g=g.prev}}function u(){var n=v.lastEx;return v.lastEx=null,n}function l(n){g=g.prev,v.retVal=n}function c(n){v.tryStack.push({frame:g,catchPC:n})}function f(){v.tryStack.pop()}function p(e){w=!0,e&&e.addTerminatedListener&&e.addTerminatedListener(function(){if(w=!1,v.group)v.group.notifyResume();else if(n())try{v.steps()}catch(e){i(e)}})}function h(n){v.group=n,n&&n.add(v)}function d(){var n=Tonyu.currentThread;for(Tonyu.currentThread=v,x=b;x-->0;)o();Tonyu.currentThread=n}function m(){y=!1}var v={enter:r,apply:a,exit:l,steps:d,step:o,isAlive:n,isWaiting:e,suspend:t,retVal:0,tryStack:[],kill:m,waitFor:p,setGroup:h,enterTry:c,exitTry:f,startCatch:u},g=null,y=!0,x=0,w=!1;return v}function e(n){var e={},t=[];return e.addTerminatedListener=function(n){t.push(n)},setTimeout(function(){t.forEach(function(n){n()})},n),e}function t(){var n=[],e=[],t=!1;return n.addTerminatedListener=function(n){t?setTimeout(n,0):e.push(n)},n.receiver=function(){t=!0;for(var e=0;e<arguments.length;e++)n[e]=arguments[e];n.notify()},n.notify=function(){e.forEach(function(n){n()})},n}function r(){function e(n){n.group=u,p?p.push(n):l.push(n)}function t(t,r,i){r||(r="main");var a=n();return a.apply(t,r,i),e(a),a}function r(){try{a()}catch(n){i(n)}}function a(){function n(n){n.isWaiting()||(f=!1,n.steps())}for(var e=l.length-1;e>=0;e--){var t=l[e];t.isAlive()&&t.group===u||l.splice(e,1)}for(f=!0,p=[],l.forEach(n);p.length>0;)w=p,p=[],w.forEach(function(e){l.push(e),n(e)});p=null}function o(){c=!1}function s(){}var u,l=[],c=!0,f=!1,p=null;return u={add:e,addObj:t,steps:r,kill:o,notifyResume:s,threads:l}}function i(n){if(!Tonyu.onRuntimeError)throw alert("エラー! at "+$LASTPOS+" メッセージ  : "+n),n;Tonyu.onRuntimeError(n)}function a(n){if(n===Function)return null;if("function"==typeof n)n.constructor=null;else if("object"==typeof n)for(var e in n)n[e]=a(n[e]);return n}function o(){var n,e,t=[];if(1==arguments.length)e=arguments[0];else if(2==arguments.length&&"function"==typeof arguments[0])n=arguments[0],e=arguments[1];else if(2==arguments.length&&arguments[0]instanceof Array)t=arguments[0],e=arguments[1];else{if(3!=arguments.length)throw console.log(arguments),"Invalid argument spec";if(n=arguments[0],!n)throw"No parent class";t=arguments[1],e=arguments[2]}e=a(e);var r=e.initialize?e.initialize:n?function(){n.apply(this,arguments)}:function(){};return delete e.initialize,t.forEach(function(n){if(!n.methods)throw n+" Does not have methods";for(var t in n.methods)t in e||(e[t]=n.methods[t])}),r.methods=e,r.prototype=u(n,e),r.prototype.isTonyuObject=!0,s(r,{superClass:n?n.meta:null,includes:t.map(function(n){return n.meta})}),r}function s(n,e){n.meta=n.meta||{},l(n.meta,e)}function u(n,e){return n?l(new n,e):e}function l(n,e){if(e&&"object"==typeof e)for(var t in e)n[t]=e[t];return n}function c(n,e){T[n]=e}function f(n){return T[n]}function p(n){var e=n.split("."),t=S;if(e.forEach(function(n){t&&(t=t[n])}),!t&&1==e.length){var r;for(var i in S){var a=S[i][n];if(a){if(t)throw new Error("曖昧なクラス名： "+i+"."+n+", "+r);t=a,r=i+"."+n}}}return t}function h(n,e){return function(){return e.apply(n,arguments)}}function d(n,e,t,r){if(!n)throw new Error(r+"(="+n+")のメソッド "+e+"を呼び出せません");var i=n[e];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+e+"(="+i+")はメソッドではありません");return i.apply(n,t)}function m(n,e,t){if("function"!=typeof n)throw new Error(t+"は関数ではありません");return n.apply({},e)}function v(n,e){if(n!=n||null==n)throw new Error(e+"(="+n+")は初期化されていません");return n}function g(n){for(var e=[],t=1;t<n.length;t++)e[t-1]=n[t];return e}function y(n){throw console.log("Not a tonyu object: ",n),n+" is not a tonyu object"}function x(n,e){return n in e}var b=60;o.addMeta=s,o.ensureNamespace=function(n,e){var t,r=e.split("."),i=n;for(t=0;t<r.length;t++){var a=r[t];i[a]||(i[a]={}),i=i[a]}};var T={},S={};return Tonyu={thread:n,threadGroup:r,klass:o,bless:u,extend:l,globals:T,classes:S,setGlobal:c,getGlobal:f,getClass:p,timeout:e,asyncResult:t,bindFunc:h,not_a_tonyu_object:y,hasKey:x,invokeMethod:d,callFunc:m,checkNonNull:v,A:g}}()}),requireSimulator.setName("TError"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return TError=function(n,e,t){if("string"==typeof e)return{isTError:!0,mesg:n,src:{name:function(){return e},text:function(){return e}},pos:t,toString:function(){return this.mesg+" at "+e+":"+this.pos},raise:function(){throw this}};var r=null;if(e&&e.src&&(r=e,e=r.src.tonyu),"function"!=typeof e.name)throw"src="+e+" should be file object";var i;if("function"==typeof e.text){var a=e.text();"string"==typeof a&&(i=TError.calcRowCol(a,t))}return{isTError:!0,mesg:n,src:e,pos:t,row:i.row,col:i.col,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.row+":"+this.col},raise:function(){throw this}}},TError.calcRowCol=function(n,e){var t,r,i=n.split("\n"),a=0;for(t=0;t<i.length;t++)if(a+=i[t].length+1,a>e){r=e-(a-i[t].length);break}return{row:t,col:r}},TError}),requireSimulator.setName("Tonyu.TraceTbl"),define(["Tonyu","FS","TError"],function(n,e,t){return n.TraceTbl=function(){var n={},r=1e6,i=1,a=1e4,o={},s=[],u={};return n.add=function(n,e){var t=n.src.tonyu,l=t.path(),c=o[l];void 0==c&&(c=i++,i>a&&(i=0),o[l]=c,s[c]=l),u[l]=n,e>=r&&(e=r-1);var f=c*r+e;return f},n.decode=function(n){var i=n%r,a=(n-i)/r,o=s[a];if(o){var l=e.get(o),c=u[o];return t("Trace info",c||l,i)}return null},n}}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(n){return n.klass({initialize:function(n,e){this.options=e||{},this.img=n,this.height=n.height,this.width=n.width;var t=this.newImage(n.width,n.height),r=t.getContext("2d");r.drawImage(n,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,n.width,n.height).data,this.base=this.getPixel(0,0)},newImage:function(n,e){var t=document.createElement("canvas");return t.width=n,t.height=e,t},getPixel:function(n,e){var t=this.pixels,r=4*(n+e*this.width),i=t[0+r],a=t[1+r],o=t[2+r],s=t[3+r];return 256*(256*(256*s+o)+a)+i},setPixel:function(n,e,t){var r=4*(n+e*this.width);this.pixels[0+r]=255&t,t=(t-(255&t))/256,this.pixels[1+r]=255&t,t=(t-(255&t))/256,this.pixels[2+r]=255&t,t=(t-(255&t))/256,this.pixels[3+r]=255&t},parse:function(){try{for(var n=[],e=0;e<this.height;e++)for(var t=0;t<this.width;t++){var r=this.getPixel(t,e);r!=this.base&&n.push(this.parse1Pattern(t,e))}return n}catch(i){if(i.isParseError)return console.log("parse error! "+i),{image:this.img,x:0,y:0,width:this.width,height:this.height};throw i}},parse1Pattern:function(n,e){function t(n){return n}function r(n,e,t){return{toString:function(){return"at ("+n+","+e+") :"+t},isParseError:!0}}for(var i=this.getPixel(n,e),a=n,o=e,s=this.base,u=this.width,l=this.height;u>a;){var c=this.getPixel(a,o);if(c!=i)break;a++}if(a>=u||this.getPixel(a,o)!=s)throw r(a,o,t(this.getPixel(a,o))+"!="+t(s));for(a--;l>o&&this.getPixel(a,o)==i;)o++;if(o>=l||this.getPixel(a,o)!=s)throw r(a,o,t(this.getPixel(a,o))+"!="+t(s));o--;var f=n+1,p=e+1,h=a-f,d=o-p;if(console.log("PP",f,p,h,d,a,o),h*d==0)throw r(a,o,"w*h==0");for(var m=this.newImage(h,d),v=m.getContext("2d"),g=v.getImageData(0,0,h,d),y=g.data,x=0,w=p;o>w;w++)for(var b=f;a>b;b++){var T=this.getPixel(b,w);T==i?(y[x++]=0,y[x++]=0,y[x++]=0,y[x++]=0):(y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T,T=(T-(255&T))/256,y[x++]=255&T)}v.putImageData(g,0,0);for(var S=p-1;o>=S;S++)for(var P=f-1;a>=P;P++)this.setPixel(P,S,s);return this.options.boundsInSrc?{x:f,y:p,width:h,height:d}:{image:m,x:0,y:0,width:h,height:d}}})}),requireSimulator.setName("Util"),Util=function(){function n(n,t){null==t&&(t=""),n=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+n+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?t:e(i[1])}function e(n){return decodeURIComponent(n.replace(/\+/g,"%20"))}function t(n,e){return n.substring(n.length-e.length)===e}function r(n,e){return n.substring(0,e.length)===e}return{getQueryString:n,endsWith:t,startsWith:r}}(),requireSimulator.setName("ImageList"),define(["PatternParser","Util","WebSite"],function(n,e,t){function r(n){var e=[];return n.forEach(function(n){n&&""!=n.url&&e.push(n)}),e}var i,a={};return i=function(e,t,o){o||(o={}),e=r(e);var s=[],u=e.length;e.forEach(function(e,r){function l(){var i,a;if((i=e.pwidth)&&(a=e.pheight)){for(var o=0,l=0,c=this.width,f=this.height,p=[];;){var h=i,d=a;if(o+i>c&&(h=c-o),l+a>f&&(d=f-l),p.push({image:this,x:o,y:l,width:h,height:d}),o+=i,o+i>c&&(o=0,l+=a,l+a>f))break}s[r]=p}else{var m=new n(this);s[r]=m.parse()}if(s[r].name=e.name,u--,0==u){var v=[],g={};s.forEach(function(n){g[n.name]=v.length,v=v.concat(n)}),v.names=g,t(v)}}console.log("loading",e,r);var c=e.url,f=c;if(a[f])return void l.apply(a[f],[]);c=i.convURL(c,o.baseDir);var p=$("<img>");p.load(function(){a[f]=this,l.apply(this,[])}),p.attr("src",c)})},i.load=i,i.parse1=function(e,t,r){var i,a,o;if((i=e.pwidth)&&(a=e.pheight)){for(var s=0,u=0,l=t.width,c=t.height,f=[];;)if(f.push({image:this,x:s,y:u,width:i,height:a}),s+=i,s+i>l&&(s=0,u+=a,u+a>c))break;o=f}else{var p=new n(t,r);o=p.parse()}return o.name=e.name,o},i.convURL=function(n,r){if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(n,e){return t[e]}),t.urlAliases[n]&&(n=t.urlAliases[n]),e.startsWith(n,"ls:")){var i=n.substring("ls:".length);if(!r)throw new Error("Basedir not specified");var a=r.rel(i);if(!a.exists())throw"ImageList file not found: "+a;n=a.text()}return n},window.ImageList=i,i}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/_trc_func_([0-9]+)_.*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(n,e){var t=n.stack;if("string"!=typeof t)return!1;for(var r=t.split(/\n/),i=[],a=0;a<r.length;a++){var o=pat.exec(r[a]);if(o){var s=o[1],u=o[2],l=(o[3],e.decode(s));if(l&&l.klass){for(var c=l.klass.src.js,f=c.split(/\n/),p=null,h=0;h<f.length&&u>h+1;h++){var d=/\$LASTPOS=([0-9]+)/.exec(f[h]);d&&(p=parseInt(d[1]))}if(p){var m=e.decode(p);m&&i.push(m)}}}}return i},trc}),requireSimulator.setName("Visitor"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Visitor=function(n){var e={funcs:n,path:[]};return e.visit=function(t){try{e.path.push(t),e.debug&&console.log("visit ",t.type,t.pos);var r=t?n[t.type]:null;if(r)return r.call(e,t);if(e.def)return e.def.call(e,t)}finally{e.path.pop()}},e.replace=function(n){return e.def||(e.def=function(n){if("object"==typeof n)for(var t in n)n[t]&&"object"==typeof n[t]&&(n[t]=e.visit(n[t]));return n}),e.visit(n)},e}}),requireSimulator.setName("typeCheck"),"function"!=typeof define&&(define=require("requirejs").define),define(["Visitor"],function(){return TypeCheck=function(){}}),requireSimulator.setName("Auth"),define(["WebSite"],function(n){var e={};return e.currentUser=function(e){$.ajax({type:"get",url:n.serverTop+"/currentUser",data:{withCsrfToken:!0},success:function(n){console.log("auth.currentUser",n),n=JSON.parse(n);var t=n.user;"null"==t&&(t=null),console.log("user",t,"csrfToken",n.csrfToken),e(t,n.csrfToken)}})},e.assertLogin=function(t){e.currentUser(function(e,r){return e?t.success(e,r):(window.onLoggedIn=t.success,void t.showLoginLink(n.serverTop+"/login"))})},window.Auth=e,e}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(n,e,t){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(n,t,r,i){var a=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(n){alert(n)}),a.append("theFile",r),a.append("user",n),a.append("project",t),a.append("fileName",r.name),$.ajax({type:"get",url:e.serverTop+"/blobURL",success:function(n){$.ajax({url:n,type:"POST",data:a,processData:!1,contentType:!1,success:function(n){console.log("Res = "+n),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(n){if(t.startsWith(n,i)){var e=n.split("/");return{user:e[1],project:e[2],fileName:e[3]}}},r.url=function(n,t,r){return e.blobPath+n+"/"+t+"/"+r},r.uploadToExe=function(n,t){var r=n.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?t.success():(t.progress||(t.progress=function(n){console.log("uploadBlobToExe cnt=",n)}),void r.forEach(function(n){var r={csrfToken:t.csrfToken};for(var a in n)r[a]=n[a];$.ajax({type:"get",url:e.serverTop+"/uploadBlobToExe",data:r,success:function(){return i--,0==i?t.success():void t.progress(i)},error:t.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function n(e,t){if("string"==typeof e){var r=new Image,i=null,a=null,o=function(n){n&&(a=n),a&&i&&a(i)};return r.onload=function(){i=n(r,t),o()},r.src=e,o}var s=t.width,u=t.height,l=t.getContext("2d"),c=e.width,f=e.height,p=u/f*c,h=s/c*f;h>u&&(h=u),p>s&&(p=s),l.clearRect(0,0,s,u);var d=Math.floor((s-p)/2),m=Math.floor((u-h)/2);return l.drawImage(e,0,0,c,f,d,m,p,h),{left:d,top:m,width:p,height:h,src:e}}return n}),requireSimulator.setName("thumbnail"),define(["ImageRect"],function(n){function e(e){try{var i=Tonyu.globals.$Screen.buf[0],a=$("<canvas>").attr({width:100,height:100});n(i,a[0]);var o=a[0].toDataURL(),s=e.getResource(),u=e.getDir(),l=t.file(e);l.text(o);for(var c={name:r,pwidth:100,pheight:100,url:"ls:"+l.relPath(u)},f=s.images,p=!1,h=0;h<f.length;h++)f[h].name==r&&(f[h]=c,p=!0);p||f.push(c),e.setResource(s),console.log("setRSRC",s)}catch(d){console.log("Create thumbnail failed",d)}}var t={},r="$icon_thumbnail";return t.set=function(n,t){setTimeout(function(){e(n)},t)},t.get=function(n){var e=t.file(n);return e.exists()?e.text():null},t.file=function(n){var e=n.getDir(),t=e.rel("images/").rel("icon_thumbnail.png");return t},t}),requireSimulator.setName("plugins"),define(["WebSite"],function(n){function e(n){return"function"==typeof n&&(n={onload:n}),n||(n={}),n.onload||(n.onload=function(){}),n}var t={},r={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/T2Body/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return t.detectNeeded=function(n,e){for(var t in r){var i=r[t].detection.exec(n);i&&(e[t]=1)}return e},t.loaded=function(n){var e=r[n];if(!e)throw new Error("plugin not found: "+n);return window[e.symbol]},t.loadAll=function(n,i){function a(){u>=o.length?i.onload():t.load(o[u++],a)}i=e(i);var o=[];for(var s in n)r[s]&&!t.loaded(s)&&o.push(s);var u=0;console.log("loading plugins",o),a()},t.load=function(t,i){var a=r[t];if(!a)throw new Error("plugin not found: "+t);i=e(i);var o=n.pluginTop+"/"+a.src;$.getScript(o,i.onload)},t.request=function(n){if(!t.loaded(n)){var e=new Error("Plugin "+n+" required");e.pluginName=n}},t}),requireSimulator.setName("Tonyu.Iterator"),define(["Tonyu"],function(){function n(n,e){var t={};if(n.tonyuIterator)return n.tonyuIterator(e);if(n instanceof Array)t.i=0,t.next=1==e?function(){return t.i>=n.length?!1:(this[0]=n[t.i],t.i++,!0)}:function(){return t.i>=n.length?!1:(this[0]=t.i,this[1]=n[t.i],t.i++,!0)};else{if(!(n instanceof Object))throw console.log(n),"Cannot iterable";t.i=0;var r=[];if(1==e){for(var i in n)r.push(i);t.next=function(){return t.i>=r.length?!1:(this[0]=r[t.i],t.i++,!0)}}else{for(var i in n)r.push([i,n[i]]);t.next=function(){return t.i>=r.length?!1:(this[0]=r[t.i][0],this[1]=r[t.i][1],t.i++,!0)}}}return t}return Tonyu.iterator=n,n}),requireSimulator.setName("IndentBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return IndentBuffer=function(){var n=function(){function e(){i++;var n=t[i];if(null==n)throw console.log(t),new Error(i+"th null param: fmt="+r);return n}for(var t=arguments,r=t[0],i=0;;){var a=r.indexOf("%");if(0>a){n.buf+=r;break}n.buf+=r.substring(0,a),a++;var o=r.charAt(a);if("s"==o){var s=e();"string"==typeof s||"number"==typeof s||(null==s?s="null":s.text&&(s=s.text)),n.buf+=s,a++}else if("d"==o){var u=e();if("number"!=typeof u)throw new Error(u+" is not a number: fmt="+r);n.buf+=u,a++}else if("n"==o)n.ln(),a++;else if("{"==o)n.indent(),a++;else if("}"==o)n.dedent(),a++;else if("%"==o)n.buf+="%";else if("f"==o)e()(n),a++;else if("l"==o){var l=e();n.buf+=n.toLiteral(l),a++}else if("v"==o){var c=e();if(!c)throw new Error("Null %v");if("object"!=typeof c)throw new Error("nonobject %v:"+c);n.visitor.visit(c),a++}else if("z"==o){var f=e();if("val"in f)return void(n.buf+=f.val);f.gen||n.lazy(f),n.buf+=f.gen,a++}else if("j"==o){var p=e(),h=p[0],d=p[1],m=!1;if(!d||!d.forEach)throw console.log(d),new Error(d+" is not array. cannot join fmt:"+r);d.forEach(function(e){m&&n.printf(h),m=!0,n.visitor.visit(e)}),a++}else"D"==o?(e(),a++):a+=2;r=r.substring(a)}};return n.print=function(e){n.buf+=e},n.printf=n,n.buf="",n.lazy=function(e){return e||(e={}),e.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),e.reg=new RegExp(e.gen,"g"),e.put=function(e){return this.val=e,n.buf=n.buf.replace(this.reg,e),e},e},n.ln=function(){n.buf+="\n"+n.indentBuf},n.indent=function(){n.indentBuf+=n.indentStr,n.buf+="\n"+n.indentBuf},n.dedent=function(){var e=n.indentStr.length;if(!n.buf.substring(n.buf.length-e).match(/^\s*$/))throw console.log(n.buf),new Error("Non-space truncated ");n.buf=n.buf.substring(0,n.buf.length-e),n.indentBuf=n.indentBuf.substring(0,n.indentBuf.length-e)},n.toLiteral=function(n,e){return e||(e="'"),n=n.replace(/\\/g,"\\\\"),n=n.replace(/\r/g,"\\r"),n=n.replace(/\n/g,"\\n"),n="'"==e?n.replace(/'/g,"\\'"):n.replace(/"/g,'\\"'),e+n+e},n.indentBuf="",n.indentStr="  ",n}}),requireSimulator.setName("disp"),"function"!=typeof define&&(define=require("requirejs").define),define(["IndentBuffer"],function(n){return disp=function(e){function t(n){if(null==n)return r("null%n");if("string"==typeof n)return r("'%s'%n",n);if("number"==typeof n)return r("%s%n",n);if("function"==typeof n)return r("func%n");r(n instanceof Array?"[%{":"{%{");var e="";for(var i in n)r(e+i+":"),t(n[i]);r(n instanceof Array?"%}]%n":"%}}%n")}var r=n();return t(e),r.buf}}),requireSimulator.setName("Parser"),"function"!=typeof define&&(define=require("requirejs").define),define(["disp"],function(){return Parser=function(){function n(n,e){var t;for(t in e)n[t]=e[t];return n}function e(n){this.parse=i.options.traceTap?function(e){console.log("tap: name="+this.name+"  pos="+(e?e.pos:"?"));var t=n.apply(this,[e]),r="NOIMG";return t.src&&t.src.str&&(r=t.src.str.substring(t.pos-3,t.pos)+"^"+t.src.str.substring(t.pos,t.pos+3)),t.src&&t.src.tokens&&(r=t.src.tokens[t.pos-1]+"["+t.src.tokens[t.pos]+"]"+t.src.tokens[t.pos+1]),console.log("/tap: name="+this.name+" pos="+(e?e.pos:"?")+"->"+(t?t.pos:"?")+" "+r+" res="+(t?t.success:"?")),t}:n}function t(n,e){if(null==n)throw e+" is null!";return n}function r(n,e){null!=n&&(this.src={maxPos:0,global:e},"string"==typeof n&&(this.src.str=n),n instanceof Array&&(this.src.tokens=n),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:e,StringParser:a,nc:t};i.dispTbl=function(n){var e="",t={};if(!n)return e;for(var r in n){var i=n[r].name;t[i]||(t[i]=""),t[i]+=r}for(var i in t)e+=t[i]+"->"+i+",";return e},e.create=function(n){return new e(n)},i.create=e.create,n(e.prototype,{except:function(n){var t=this;return this.ret(e.create(function(e){return n.apply({},e.result)&&(e.success=!1),e}).setName("(except "+t.name+")"))},noFollow:function(n){var r=this;return t(n,"p"),this.ret(e.create(function(e){var t=n.parse(e);return e.success=!t.success,e}).setName("("+r.name+" noFollow "+n.name+")"))},andNoUnify:function(n){t(n,"next");var r=this,i=e.create(function(e){var t=r.parse(e);if(!t.success)return t;var i=n.parse(t);return i.success&&(i.result=t.result.concat(i.result)),i});return i.setName("("+this.name+" "+n.name+")")},and:function(n){var t=this.andNoUnify(n);if(!this._first)return t;var r=this._first.tbl,a={};for(var o in r)a[o]=r[o].andNoUnify(n);return t=e.fromFirst(this._first.space,a),t.setName("("+this.name+" >> "+n.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+t.name+" tbl="+i.dispTbl(a)),t},retNoUnify:function(n){var t,r=this;t="function"==typeof n?e.create(function(e){var t=e.clone();return t.result=[n.apply({},e.result)],t}).setName("retfunc"):n;var i=e.create(function(n){var e=r.parse(n);return e.success?t.parse(e):e}).setName("("+this.name+" >= "+t.name+")");return i},ret:function(n){if(!this._first)return this.retNoUnify(n);var t=this._first.tbl,r={};for(var a in t)r[a]=t[a].retNoUnify(n);return res=e.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+n.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(n,t){if(!i.options.optimizeFirst)return this;if(null==n)throw"Space is null2!";if("string"==typeof t){for(var r={},a=0;a<t.length;a++)r[t.substring(a,a+1)]=this;return e.fromFirst(n,r).setName("(fst "+this.name+")")}if(null==t)return e.fromFirst(n,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof t)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(n){if(!i.options.optimizeFirst)return this;"string"==typeof n&&(n=[n]);var t={};if(n){var r=this;n.forEach(function(n){t[n]=r})}else t.ALL=this;return e.fromFirstTokens(t).setName("(fstT "+this.name+")")},unifyFirst:function(t){function r(n,e){return n?e?n.orNoUnify(e).checkTbl():n:e}function a(){var n=t._first.tbl,e={};for(var i in o)e[i]=1;for(var i in n)e[i]=1;delete e.ALL,(o.ALL||n.ALL)&&(o.ALL=r(o.ALL,n.ALL));for(var i in e)o[i]&&n[i]?o[i]=r(o[i],n[i]):o[i]&&!n[i]?o[i]=r(o[i],n.ALL):!o[i]&&n[i]&&(o[i]=r(o.ALL,n[i]))}var o={};this.checkTbl(),t.checkTbl(),n(o,this._first.tbl),a();var s=e.fromFirst(this._first.space,o).setName("("+this.name+")U("+t.name+")");return i.options.verboseFirst&&console.log("Created unify name="+s.name+" tbl="+i.dispTbl(o)),s},or:function(n){return t(n,"other"),this._first&&n._first&&this._first.space&&this._first.space===n._first.space?this.unifyFirst(n):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+n.name+" "+this._first+" - "+n._first),this.orNoUnify(n))},orNoUnify:function(n){var t=this,r=e.create(function(e){var r=t.parse(e);if(r.success)return r;var i=n.parse(e);return i});return r.name="("+this.name+")|("+n.name+")",r},setName:function(n){return this.name=n,this._first,this},profile:function(n){return i.options.profile&&(this.parse=this.parse.profile(n||this.name)),this},repN:function(n){var t=this;n||(n=0);var r=e.create(function(e){for(var r=e,i=[];;){var a=t.parse(r);if(!a.success){var o;return i.length>=n?(o=r.clone(),o.result=[i],o.success=!0,o):(o=e.clone(),o.success=!1,o)}i.push(a.result[0]),r=a}});return r.setName("("+t.name+" * "+n+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var n=this;return e.create(function(e){var t=n.parse(e);return t.success?t:(e=e.clone(),e.success=!0,e.result=[null],e)}).setName("("+n.name+")?")},sep1:function(n,e){var r=this;t(r,"value"),t(n,"sep");var i=n.and(r).ret(function(n,t){return e?t:{sep:n,value:t}});return r.and(i.rep0()).ret(function(n,t){var r;if(e){var i=[n];for(r in t)i.push(t[r]);return i}return{head:n,tails:t}}).setName("(sep1 "+r.name+"~~"+n.name+")")},sep0:function(n){return this.sep1(n,!0).opt().ret(function(n){return n?n:[]})},tap:function(n){return this},retN:function(n){return this.ret(function(){return arguments[n]})},parseStr:function(n,e){var t=new r(n,e);return this.parse(t)},checkTbl:function(){if(!this._first)return this;var n=this._first.tbl;for(var e in n)if(!n[e].parse)throw this.name+": tbl."+e+" is not a parser :"+n[e];return this}}),n(r.prototype,{clone:function(){var n=new r;return n.src=this.src,n.pos=this.pos,n.result=this.result.slice(),n.success=this.success,n},updateMaxPos:function(n){n>this.src.maxPos&&(this.src.maxPos=n)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),e.fromFirst=function(n,t){if("TOKEN"==n)return e.fromFirstTokens(t);var r=e.create(function(e){var r=n.parse(e),a=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+a+" tbl="+(t[a]?t[a].name:"-")),t[a]?t[a].parse(r):t.ALL?t.ALL.parse(r):(r.success=!1,r)});return r._first={space:n,tbl:t},r.checkTbl(),r},e.fromFirstTokens=function(n){var t=e.create(function(e){var t=e.src.tokens[e.pos],r=t?t.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(n[r]?n[r].name:"-")),null!=r&&n[r]?n[r].parse(e):n.ALL?n.ALL.parse(e):(e.success=!1,e)});return t._first={space:"TOKEN",tbl:n},t.checkTbl(),t};var a={empty:e.create(function(n){var e=n.clone();return e.success=!0,e.result=[null],e}).setName("E"),fail:e.create(function(n){return n.success=!1,n}).setName("F"),str:function(n){return this.strLike(function(e,t){return e.substring(t,t+n.length)===n?{len:n.length}:null}).setName(n)},reg:function(n){return(n+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(n+"")),this.strLike(function(e,t){var r=n.exec(e.substring(t));return r?(r.len=r[0].length,r):null}).setName(n+"")},strLike:function(t){return e.create(function(e){var r=e.src.str;if(null==r)throw"strLike: str is null!";var a=e.pos,o=t(r,a,e);if(i.options.traceToken&&console.log("pos="+a+" r="+o),o){i.options.traceToken&&console.log("str:succ"),o.pos=a,o.src=e.src;var s=e.clone();return n(s,{pos:a+o.len,success:!0,result:[o]}),e.updateMaxPos(s.pos),s}return i.options.traceToken&&console.log("str:fail"),e.success=!1,e}).setName("STRLIKE")},parse:function(n,e,t){var i=new r(e,t);return n.parse(i)}};a.eof=a.strLike(function(n,e){return e==n.length?{len:0}:null}).setName("EOF"),i.StringParser=a;var o={token:function(n){return e.create(function(e){var t=e.src.tokens[e.pos];return e.success=!1,t?(t.type==n&&(e=e.clone(),e.updateMaxPos(e.pos),e.pos++,e.success=!0,e.result=[t]),e):e}).setName(n).firstTokens(n)},parse:function(n,e,t){var i=new r(e,t);return n.parse(i)},eof:e.create(function(n){var e=n.pos>=n.src.tokens.length;return n.success=e,e&&(n=n.clone(),n.result=[{type:"EOF"}]),n}).setName("EOT")};return i.TokensParser=o,i.lazy=function(n){var t=null;return e.create(function(e){if(t||(t=n()),!t)throw n+" returned null!";return this.name=n.name,t.parse(e)}).setName("LZ")},i.addRange=function(n,e){if(null==e)return n;if("number"!=typeof n.pos)return n.pos=e.pos,n.len=e.len,n;var t=e.pos+e.len,r=n.pos+n.len;return e.pos<n.pos&&(n.pos=e.pos),t>r&&(n.len=t-n.pos),n},i.setRange=function(n){if(null!=n&&"string"!=typeof n&&"number"!=typeof n&&"boolean"!=typeof n){var e=i.getRange(n);if(null!=e)return n;for(var t in n)if(n.hasOwnProperty(t)){var r=i.setRange(n[t]);i.addRange(n,r)}return n}},i.getRange=function(n){return null==n?null:"number"!=typeof n.pos?null:"number"==typeof n.len?n:null},i}()}),requireSimulator.setName("Grammar"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(n){return Grammar=function(){function e(n){return"string"==typeof n?r.get(n):n}var t=n,r=null;return r=function(t){var i={};return i.ands=function(){for(var i=e(arguments[0]),a=1;a<arguments.length;a++)i=i.and(e(arguments[a]));i=i.tap(t),r.defs[t]=i;var o={};return o.autoNode=function(){var e=i.ret(function(){for(var e={type:t},r=0;r<arguments.length;r++){var i=arguments[r],a=n.setRange(i);n.addRange(e,a),e["-element"+r]=i}e.toString=function(){return"("+this.type+")"}}).setName(t);return r.defs[t]=e},o.ret=function(e){if(0==arguments.length)return i;if("function"==typeof e)return r.defs[t]=i.ret(e);for(var a=[],o=function(n){return n},s=0;s<arguments.length;s++){if("function"==typeof arguments[s]){o=arguments[s];break}a[s]=arguments[s]}var u=i.ret(function(){var e={type:t};e[Grammar.SUBELEMENTS]=[];for(var r=0;r<arguments.length;r++){var i=arguments[r],s=n.setRange(i);n.addRange(e,s),a[r]&&(e[a[r]]=i),e[Grammar.SUBELEMENTS].push(i)}return e.toString=function(){return"("+this.type+")"},o(e)}).setName(t);return r.defs[t]=u},o},i.ors=function(){for(var n=e(arguments[0]),i=1;i<arguments.length;i++)n=n.or(e(arguments[i]));return r.defs[t]=n.setName(t)},i},r.defs={},r.get=function(n){return r.defs[n]?r.defs[n]:t.lazy(function(){var e=r.defs[n];if(!e)throw"grammar named '"+n+"' is undefined";return e}).setName("(Lazy of "+n+")")},r},Grammar.SUBELEMENTS="[SUBELEMENTS]",Grammar}),requireSimulator.setName("XMLBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(n){return XMLBuffer=function(e){var t;return t=function(r,i){if(null!=r&&"string"!=typeof r&&"number"!=typeof r){var a=n.getRange(r);if(a)for(;t.srcLen<a.pos;)t.src(e.substring(t.srcLen,a.pos));if(null!=r){if(i&&t.tag("<attr_"+i+">"),r.type&&t.tag("<"+r.type+">"),r.text)t.src(a.text);else{var o=t.orderByPos(r);o.forEach(function(n){n.name&&n.name.match(/^-/)?t(n.value):t(n.value,n.name)})}if(a)for(;t.srcLen<a.pos+a.len;)t.src(e.substring(t.srcLen,a.pos+a.len));r.type&&t.tag("</"+r.type+">"),i&&t.tag("</attr_"+i+">")}}},t.orderByPos=XMLBuffer.orderByPos,t.src=function(n){t.buf+=n.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),t.srcLen+=n.length},t.tag=function(n){t.buf+=n},t.buf="",t.srcLen=0,t},XMLBuffer.orderByPos=function(n){var e=[];if(n[XMLBuffer.SUBELEMENTS])n[XMLBuffer.SUBELEMENTS].forEach(function(n){e.push(n)});else for(var t in n)n.hasOwnProperty(t)&&null!=n[t]&&"string"!=typeof n[t]&&"number"!=typeof n[t]&&"number"==typeof n[t].pos&&e.push(isNaN(parseInt(t))&&!(t+"").match(/-/)?{name:t,value:n[t]}:{value:n[t]});return e=e.sort(function(n,e){return n.value.pos-e.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",XMLBuffer}),requireSimulator.setName("TT"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","disp","Parser","TError"],function(n,e,t,r,i){return TT=function(){function n(n,e){var t,i;"string"==typeof n?(t=s.str(n),n.length>0&&(i=n.substring(0,1)),e||(e=n)):(t=s.reg(n),e||(e=n+""));var a=f.and(t).ret(function(n,t){var i={};if(i.pos=t.pos,"number"!=typeof i.pos)throw"no pos for "+e+" "+r(t);if(i.len=t.len,i.text=t.src.str.substring(i.pos,i.pos+i.len),"string"!=typeof i.text)throw"no text("+i.text+") for "+e+" "+r(t);return i.toString=function(){return this.text},i});return i&&(a=a.first(f,i)),a.setName(e)}function e(e,t,r){"string"==typeof r&&(r=n(r)),p[e]=a(p[e],r.ret(function(n){return n.type=t,n}).setName(t))}function t(n,t,r,i){t==u&&(t=r);for(var a=1;n>=a;a*=2)0!=(n&a)&&e(n&a,t,r,i);h[t]=i}function a(n,e){return n?n.or(e):e}function o(n){var e=((new Date).getTime(),i.StringParser.parse(d,n));return e.success||console.log("Stopped at "+n.substring(e.src.maxPos-5,e.src.maxPos+5)),"object"==typeof WebSite&&WebSite.devMode&&(window.tokenStat=window.tokenStat||{},e.result[0].forEach(function(n){window.tokenStat[n.text]=window.tokenStat[n.text]||0,window.tokenStat[n.text]++})),e}var s=i.StringParser,u="SAMENAME",l=1,c=2,f=s.reg(/^(\s*(\/\*([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),p={},h={},d=i.create(function(n){for(var e=c,t=[];;){if(n=p[e].parse(n),!n.success)break;var r=n.result[0];e=h[r.type],t.push(r)}return n=f.parse(n),n.success=n.src.maxPos==n.src.str.length,n.result[0]=t,n
}),m={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,"for":!0,"else":!0,"super":!0,"while":!0,"break":!0,"do":!0,"switch":!0,"try":!0,"catch":!0,"finally":!0,"throw":!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,_thread:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},v=n(/^[0-9\.]+/).ret(function(n){return n.type="number",n.value=parseInt(n.text),n}).first(f,"0123456789"),g=n({exec:function(n){var e=n.substring(0,1);if('"'!==e&&"'"!==e)return!1;for(var t=1;t<n.length;t++){var r=n.substring(t,t+1);if(r===e)return[n.substring(0,t+1)];"\\"===r&&t++}return!1},toString:function(){return"literal"}}).first(f,"\"'"),y=n({exec:function(n){if("/"!==n.substring(0,1))return!1;for(var e=1;e<n.length;e++){var t=n.substring(e,e+1);if("/"===t){var r=/^[ig]*/.exec(n.substring(e+1));return[n.substring(0,e+1+r[0].length)]}if("\n"==t)return!1;"\\"===t&&e++}return!1},toString:function(){return"regex"}}).first(f,"/");t(c|l,"number",v,l),t(c,"regex",y,l),t(c|l,"literal",g,l),t(c|l,u,"++",l),t(c|l,u,"--",l),t(c|l,u,"!==",c),t(c|l,u,"===",c),t(c|l,u,"+=",c),t(c|l,u,"-=",c),t(c|l,u,"*=",c),t(c|l,u,"/=",c),t(c|l,u,"%=",c),t(c|l,u,">=",c),t(c|l,u,"<=",c),t(c|l,u,"!=",c),t(c|l,u,"==",c),t(c|l,u,">>",c),t(c|l,u,"<<",c),t(c|l,u,"&&",c),t(c|l,u,"||",c),t(c|l,u,"(",c),t(c|l,u,")",l),t(c|l,u,"[",c),t(c|l,u,"]",l),t(c|l,u,"{",c),t(c|l,u,"}",l),t(c|l,u,">",c),t(c|l,u,"<",c),t(c|l,u,"+",c),t(c|l,u,"-",c),t(c|l,u,".",c),t(c|l,u,"?",c),t(c|l,u,"=",c),t(c|l,u,"*",c),t(c|l,u,"%",c),t(l,u,"/",c),t(l|c,u,"^",c),t(l|c,u,"~",c),t(l|c,u,"\\",c),t(l|c,u,":",c),t(l|c,u,";",c),t(l|c,u,",",c),t(c|l,u,"!",c),t(c|l,u,"&",c),t(c|l,u,"|",c);var x=n(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(n){return n.type="constructor"==n.text?"tk_constructor":m.hasOwnProperty(n.text)?n.text:"symbol",n}).first(f);for(var w in m)h[w]=c;return h.tk_constructor=c,h.symbol=l,p[c]=a(p[c],x),p[l]=a(p[l],x),{parse:o,extension:"js"}}()}),requireSimulator.setName("ExpressionParser"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(n){return ExpressionParser=function(){function e(n,e){var t={};return t.eq=function(t){return n==t.type()&&e==t.prio()},t.type=function(e){return e?e==n:n},t.prio=function(){return e},t.toString=function(){return"["+n+":"+e+"]"},t}function t(n){var e={},t=n;return e.add=function(n){t=t?t.or(n):n},e.get=function(){return t},e}function r(){var r=t(),i={};return i.reg=function(t,i,a){var o=e(t,i);r.add(a.ret(n.create(function(n){return n.opType=o,n})).setName("(opType "+o+" "+a.name+")"))},i.get=function(){return r.get()},i.parse=function(n){return i.get().parse(n)},i}function i(n,e){return}function a(n,e){var t,r=e;if(i(e," start minprio= "+n),e=s.parse(e),i(e," prefixorelem "+n),!e.isSuccess())return e;if(t=e.opType,t.type("prefix")){if(pre=e.result[0],e=a(t.prio(),e),!e.isSuccess())return e;var l=o.mkPrefix.def(pre,e.result[0]);if(r=e.clone(),r.result=[l],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(r=e.clone(),e=u.parse(e),!e.isSuccess())return r;for(;;){if(i(e,"st:pi"),i(r,"res:ex"),t=e.opType,t.prio()<n)return r.nextPostfixOrInfix=e,r;if(t.type("postfix")){var l=o.mkPostfix.def(r.result[0],e.result[0]);if(r=e.clone(),r.result=[l],i(e,"185"),e=u.parse(e),!e.isSuccess())return r}else if(t.type("infixl")){var f=e.result[0];if(e=a(t.prio()+1,e),!e.isSuccess())return r;var l=o.mkInfixl.def(r.result[0],f,e.result[0]);if(r=e.clone(),r.result=[l],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(t.type("infixr")){var f=e.result[0];if(e=a(t.prio(),e),!e.isSuccess())return r;var l=o.mkInfixr.def(r.result[0],f,e.result[0]);if(r=e.clone(),r.result=[l],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(t.type("trifixr")){var p=r.result[0],h=e.result[0];if(e=a(t.prio()+1,e),!e.isSuccess())return r;var d=e.result[0],e=c[t.prio()].parse(e);if(!e.isSuccess())return r;var m=e.result[0];if(e=a(t.prio(),e),!e.isSuccess())return r;var v=e.result[0],l=o.mkTrifixr.def(p,h,d,m,v);if(r=e.clone(),r.result=[l],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else{var f=e.result[0];if(e=a(t.prio()+1,e),!e.isSuccess())return r;var l=o.mkInfix.def(r.result[0],f,e.result[0]);if(r=e.clone(),r.result=[l],!e.nextPostfixOrInfix)return r;if(e=e.nextPostfixOrInfix,t.prio()==e.opType.prio())return r.success=!1,r}}}var o={},s=r(),u=r(),l=t(),c=[];return o.element=function(n){s.reg("element",-1,n),l.add(n)},o.getElement=function(){return l.get()},o.prefix=function(n,e){s.reg("prefix",n,e)},o.postfix=function(n,e){u.reg("postfix",n,e)},o.infixl=function(n,e){u.reg("infixl",n,e)},o.infixr=function(n,e){u.reg("infixr",n,e)},o.infix=function(n,e){u.reg("infix",n,e)},o.trifixr=function(n,e,t){u.reg("trifixr",n,e),c[n]=t},o.custom=function(){},o.mkInfix=function(n){o.mkInfix.def=n},o.mkInfix.def=function(e,t,r){return n.setRange({type:"infix",op:t,left:e,right:r})},o.mkInfixl=function(n){o.mkInfixl.def=n},o.mkInfixl.def=function(e,t,r){return n.setRange({type:"infixl",op:t,left:e,right:r})},o.mkInfixr=function(n){o.mkInfixr.def=n},o.mkInfixr.def=function(e,t,r){return n.setRange({type:"infixr",op:t,left:e,right:r})},o.mkPrefix=function(n){o.mkPrefix.def=n},o.mkPrefix.def=function(e,t){return n.setRange({type:"prefix",op:e,right:t})},o.mkPostfix=function(n){o.mkPostfix.def=n},o.mkPostfix.def=function(e,t){return n.setRange({type:"postfix",left:e,op:t})},o.mkTrifixr=function(n){o.mkTrifixr.def=n},o.mkTrifixr.def=function(e,t,r,i,a){return n.setRange({type:"trifixr",left:e,op1:t,mid:r,op2:i,right:a})},o.build=function(){return o.built=n.create(function(n){return a(0,n)}).setName("ExpBuilt"),o.built},o.lazy=function(){return n.create(function(n){return o.built.parse(n)})},o}}),requireSimulator.setName("TonyuLang"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","TT","disp","Parser","ExpressionParser","TError"],function(n,e,t,r,i,a,o,s){return TonyuLang=function(){function t(n){return function(){return arguments[n]}}function u(n,e){var t=[];if(n&&!n.args)throw i(n);if(n){var r=a.getRange(n);a.addRange(t,r),n.args.forEach(function(n){t.push(n)})}return e.forEach(function(n){var e=a.getRange(n);a.addRange(t,e),t.push(n.obj)}),t}function l(n,e,t){var r={type:"infix",left:n,op:e,right:t};return a.setRange(r),r.toString=function(){return"("+n+e+t+")"},r}var c=a,f={},p=n(),h=p.get,d=(c.StringParser,c.TokensParser.token),m=d("number").ret(function(n){if(n.type="number","string"!=typeof n.text)throw"No text for "+i(n);if(n.value=parseFloat(n.text),isNaN(n.value))throw"No value for "+i(n);return n}),v=d("symbol"),g=d("==="),y=d("!=="),x=d("=="),w=d("!="),b=d(">="),T=d("<="),S=d(">"),P=d("<"),k=d("&&"),j=d("||"),R=d("-"),D=d("+"),E=d("*"),$=d("/"),C=d("%"),M=d("="),N=d("literal"),_=d("regex"),I=o(),A=p("arrayElem").ands(d("["),I.lazy(),d("]")).ret(null,"subscript"),L=p("argList").ands(d("("),I.lazy().sep0(d(","),!0),d(")")).ret(null,"args"),O=p("member").ands(d("."),v).ret(null,"name"),W=p("parenExpr").ands(d("("),I.lazy(),d(")")).ret(null,"expr"),F=p("varAccess").ands(v).ret("name"),B=h("funcExpr").firstTokens(["function","\\"]),U=p("funcExprArg").ands(B).ret("obj"),q=h("objlit").firstTokens("{"),K=p("objlitArg").ands(q).ret("obj"),X=K.or(U),H=L.and(X.rep0()).ret(function(n,e){return u(n,e)}).or(X.rep1().ret(function(n){return u(null,n)})),G=(L.or(K),p("call").ands(H).ret("args")),z=p("scall").ands(H).ret("args"),Y=p("newExpr").ands(d("new"),F,G.opt()).ret(null,"klass","params"),V=p("superExpr").ands(d("super"),d(".").and(v).ret(t(1)).opt(),z).ret(null,"name","params"),J=d("true").or(d("false")).or(d("null")).or(d("undefined")).or(d("_thread")).or(d("this")).or(d("arguments")).ret(function(n){return n.type="reservedConst",n});I.element(m),I.element(J),I.element(_),I.element(N),I.element(W),I.element(Y),I.element(V),I.element(B),I.element(q),I.element(h("arylit").firstTokens("[")),I.element(F);var Z=0;I.infixr(Z,M),I.infixr(Z,d("+=")),I.infixr(Z,d("-=")),I.infixr(Z,d("*=")),I.infixr(Z,d("/=")),I.infixr(Z,d("%=")),I.infixr(Z,d("|=")),I.infixr(Z,d("&=")),Z++,I.trifixr(Z,d("?"),d(":")),Z++,I.infixl(Z,j),Z++,I.infixl(Z,k),Z++,I.infix(Z,d("instanceof")),I.infix(Z,d("is")),I.infix(Z,g),I.infix(Z,y),I.infix(Z,x),I.infix(Z,w),I.infix(Z,b),I.infix(Z,T),I.infix(Z,S),I.infix(Z,P),Z++,I.postfix(Z+3,d("++")),I.postfix(Z+3,d("--")),I.infixl(Z,R),I.infixl(Z,D),Z++,I.infixl(Z,E),I.infixl(Z,$),I.infixl(Z,C),Z++,I.prefix(Z,d("typeof")),I.prefix(Z,d("delete")),I.prefix(Z,d("++")),I.prefix(Z,d("--")),I.prefix(Z,d("+")),I.prefix(Z,d("-")),I.prefix(Z,d("!")),Z++,Z++,I.postfix(Z,G),I.postfix(Z,O),I.postfix(Z,A),I.mkInfixl(l),I.mkInfixr(l);{var Q=I.build().setName("expr").profile(),t=function(n){return function(){return arguments[n]}},ne=h("stmt").firstTokens();p("exprstmt").ands(Q,d(";")).ret("expr")}p("compound").ands(d("{"),ne.rep0(),d("}")).ret(null,"stmts");{var ee=d("else").and(ne).ret(t(1)),te=(p("return").ands(d("return"),Q.opt(),d(";")).ret(null,"value"),p("if").ands(d("if"),d("("),Q,d(")"),ne,ee.opt()).ret(null,null,"cond",null,"then","_else"),p("forin").ands(d("var").opt(),v.sep1(d(","),!0),d("in"),Q).ret("isVar","vars",null,"set")),re=p("normalFor").ands(ne,Q.opt(),d(";"),Q.opt()).ret("init","cond",null,"next"),ie=re.or(te),ae=(p("for").ands(d("for"),d("("),ie,d(")"),"stmt").ret(null,null,"inFor",null,"loop"),p("while").ands(d("while"),d("("),Q,d(")"),"stmt").ret(null,null,"cond",null,"loop"),p("break").ands(d("break"),d(";")).ret("brk"),p("finally").ands(d("finally"),"stmt").ret(null,"stmt"),p("catch").ands(d("catch"),d("("),v,d(")"),"stmt").ret(null,null,"name",null,"stmt"),p("catches").ors("catch","finally")),oe=(p("try").ands(d("try"),"stmt",ae.rep1()).ret(null,"stmt","catches"),p("throw").ands(d("throw"),Q,d(";")).ret(null,"ex"),p("varDecl").ands(v,d("=").and(Q).ret(t(1)).opt()).ret("name","value"));p("varsDecl").ands(d("var"),oe.sep1(d(","),!0),d(";")).ret(null,"decls")}p("funcDeclHead").ands(d("nowait").opt(),d("function").or(d("fiber")).or(d("tk_constructor")).or(d("\\")).opt(),v.or(d("new")),"paramDecls").ret("nowait","ftype","name","params");p("funcDecl").ands("funcDeclHead","compound").ret("head","body"),p("nativeDecl").ands(d("native"),v,d(";")).ret(null,"name"),p("ifWait").ands(d("ifwait"),"stmt",ee.opt()).ret(null,"then","_else");ne=p("stmt").ors("return","if","for","while","break","ifWait","try","throw","nativeDecl","funcDecl","compound","exprstmt","varsDecl");var se=p("paramDecl").ands(v).ret("name"),ue=p("paramDecls").ands(d("("),se.sep0(d(","),!0),d(")")).ret(null,"params");p("funcExprHead").ands(d("function").or(d("\\")),v.opt(),ue.opt()).ret(null,"name","params");var le=(p("funcExpr").ands("funcExprHead","compound").ret("head","body"),p("jsonElem").ands(v.or(N),d(":").and(Q).ret(function(n,e){return e}).opt()).ret("key","value")),ce=(p("objlit").ands(d("{"),le.sep0(d(","),!0),d("}")).ret(null,"elems"),p("arylit").ands(d("["),Q.sep0(d(","),!0),d("]")).ret(null,"elems"),p("extends").ands(d("extends"),v.or(d("null")),d(";")).ret(null,"superClassName")),fe=p("includes").ands(d("includes"),v.sep1(d(","),!0),d(";")).ret(null,"includeClassNames"),pe=p("program").ands(ce.opt(),fe.opt(),ne.rep0(),a.TokensParser.eof).ret("ext","incl","stmts");for(var he in p.defs)p.defs[he].profile();return f.parse=function(n){str="string"==typeof n?n:n.text(),str+="\n";var e=r.parse(str);if(!e.isSuccess())throw s("文法エラー(Token)",n,e.src.maxPos);var t=e.result[0],i=c.TokensParser.parse(pe,t);if(i.isSuccess()){var a=i.result[0];return a}var o=t[i.src.maxPos],u=o?o.pos+o.len:str.length;throw s("文法エラー",n,u)},f.genXML=function(n,t){var r=e(n);return r(t),r.buf},f.extension="tonyu",f}()}),requireSimulator.setName("ObjectMatcher"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return ObjectMatcher=function(){function n(n,e){var t={};return t[i]=n,e&&(t[a]=e),t}function e(n){return n&&n[i]}function t(n,e,r){if(n===e)return!0;if(null==n)return!1;if("string"==typeof n&&e instanceof RegExp)return n.match(e);if("function"==typeof e)return e(n,r);if("object"==typeof e){for(var o in e)if(o!=i){var s=o==a?n:n[o],u=e[o];if(!t(s,u,r))return!1}return e[i]&&(r[e[i]]=n),!0}return!1}var r={},i="$var",a="$this";r.v=n,r.isVar=e;for(var o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s=0;s<o.length;s++){var u=o.substring(s,s+1);r[u]=n(u)}return r.match=function(n,e){var r={};return t(n,e,r)?r:null},r}()}),requireSimulator.setName("context"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return context=function(){function n(n,t){var r={};for(var i in n)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=e[i],e[i]=e.ovrFunc(e[i],n[i])):(r[i]=e[i],e[i]=n[i]);t(e);for(var i in r)e[i]=r[i]}var e={};return e.ovrFunc=function(n,e){return e.parent=n,e},e.enter=n,e}}),requireSimulator.setName("Tonyu.Compiler"),define(["Tonyu","ObjectMatcher","TError"],function(n){function e(n,e){var t={type:n};if(e)for(var r in e)t[r]=e[r];return t.name||(t.name=a("_"+n+"_")),t}function t(n){return n?n.type:null}function r(n){var e=function(){};return e.prototype=n,new e}function i(n,e){if(!n)throw e+" is null";return n}function a(n){return n+(h++ +"").replace(/\./g,"")}function o(n,e,t){e._id||(n._idseq||(n._idseq=0),e._id=++n._idseq);var r=n[e._id];if(r||(r=n[e._id]={node:e}),t)for(var i in t)r[i]=t[i];return r}function s(n){return srcCont.substring(n.pos,n.pos+n.len)}function u(n,e){var t=null;return l(n).forEach(function(n){t||(t=n.decls.methods[e])}),t}function l(n){for(var e={},t=[],r=[],i=n;i;i=i.superClass)t=t.concat(i.includes),e[i.fullName]=!0,r.push(i);for(;t.length>0;){var i=t.shift();e[i.fullName]||(e[i.fullName]=!0,r.push(i),t=t.concat(i.includes))}return r}function c(n){if(!n.head)return[];var e=n.head.params.params;if(!e.forEach)throw n+" is not array ";return e}var f={};n.Compiler=f;var p={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PARAM:"param",GLOBAL:"global",CLASS:"class"};f.ScopeTypes=p;var h=1;return f.newScopeType=e,f.getScopeType=t,f.newScope=r,f.nullCheck=i,f.genSym=a,f.annotation=o,f.getSource=s,f.getMethod=u,f.getDependingClasses=l,f.getParams=c,f}),requireSimulator.setName("Tonyu.Compiler.Semantics"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(n,e,t,r,i,a,o,s,u){return u.Semantics=function(){function n(n,e){function a(t){var r,a=e.options.compiler.defaultSuperClass,s=0;if((r=p.match(t,{ext:{superClassName:{text:p.N,pos:p.P}}}))&&(a=r.N,s=r.P,"null"==a&&(a=null)),n.includes=[],(r=p.match(t,{incl:{includeClassNames:p.C}}))&&r.C.forEach(function(t){var r=t.text,a=t.pos,s=e.classes[e.aliases[r]||r];if(!s)throw i("クラス "+r+"は定義されていません",o,a);n.includes.push(s)}),"Array"==a)n.superClass={name:"Array",fullName:"Array",builtin:!0};else if(a){var l=e.classes[e.aliases[a]||a];if(!l)throw i("親クラス "+a+"は定義されていません",o,s);n.superClass=l}t.stmts.forEach(function(n){if("funcDecl"==n.type){var e=n.head,t="function";e.ftype&&(t=e.ftype.text),c[e.name.text]={nowait:!!e.nowait,ftype:t,name:e.name.text,head:e,pos:e.pos,stmts:n.body.stmts}}else"nativeDecl"==n.type?f[n.name.text]=n:u.stmts.push(n)})}var o=n.src.tonyu,s=t.parse(o),u={name:"main",stmts:[],pos:0},l={},c={main:u},f={};n.decls={fields:l,methods:c,natives:f},n.node=s;var p=r;a(s)}function e(n,e){function t(e,t){return h(n.annotation,e,t)}function u(n){if(!n.builtin){var e=F,t=n.decls;for(var r in t.fields)e[r]=l(W.FIELD,{klass:n.name,name:r});for(var r in t.methods)e[r]=l(W.METHOD,{klass:n.name,name:r})}}function x(){var t=F;v(n).forEach(u);var r=n.decls;for(var i in r.natives)t[i]=l(W.NATIVE,{name:"native::"+i});for(var i in y)t[i]=l(W.NATIVE,{name:"native::"+i});for(var i in e.aliases)t[i]=l(W.CLASS,{name:i})}function w(){var e=v(n);for(var t in n.decls.methods){var r=n.decls.methods[t];e.forEach(function(n){var e=n.decls.methods[t];e&&e.nowait&&(r.nowait=!0)})}}function b(e){return m(n,e)}function T(n){if("varAccess"==n.type||"postfix"==n.type&&("member"==n.op.type||"arrayElem"==n.op.type))return"varAccess"==n.type&&t(n,{noBind:!0}),!0;throw console.log("LVal",n),i("'"+d(n)+"'は左辺には書けません．",I,n.pos)}function S(e){var t=B.scope[e],r=c(t);if(!r){var i=e.match(/^\$/);r=i?W.GLOBAL:W.FIELD;var a={name:e};i||(a.klass=n.name),t=F[e]=l(r,a)}return t}function P(n){var e=this;if(n&&"object"==typeof n){var t;if(t=n instanceof Array?n:n[Grammar.SUBELEMENTS],!t){t=[];for(var r in n)t.push(n[r])}t.forEach(function(n){e.visit(n)})}}function k(n){var e={varDecls:{},subFuncDecls:{}};return B.enter({locals:e},function(){V.visit(n)}),e}function j(n,e){n.forEach(function(n){t(n,e)})}function R(n){B.method&&(B.method.fiberCallRequired=!0),j(n,{fiberCallRequired:!0})}function D(n,e){B.enter({scope:e},function(){J.visit(n)})}function E(n,e){for(var t in n.varDecls)e[t]=l(W.LOCAL);for(var t in n.subFuncDecls)e[t]=l(W.LOCAL)}function $(n){n.locals=k(n.stmts),n.params=g(n)}function C(e){var t=f(B.scope);return e.params.forEach(function(r,i){t[r.name.text]=l(W.PARAM,{klass:n.name,name:e.name,no:i})}),E(e.locals,t),B.enter({method:e,finfo:e,noWait:!1},function(){D(e.stmts,t)}),e.scope=t,_(e.locals,t),t}function M(){B.enter({scope:F},function(){for(var n in O){U&&console.log("anon method1",n);var e=O[n];$(e),C(e)}})}function N(n){var e,r,i=n.body,a=n.head.name?n.head.name.text:"anonymous";r=(e=A.match(n,{head:{params:{params:A.P}}}))?e.P:[];var o=f(B.scope);r.forEach(function(n){o[n.name.text]=l(W.PARAM)});var s=k(i,o);E(s,o);var u=t(n);B.enter({finfo:u},function(){D(i,o)});var c={scope:o,locals:s,name:a,params:r};return t(n,c),t(n,u),_(s,o),c}function _(n,e){B.enter({scope:e},function(){for(var e in n.subFuncDecls)N(n.subFuncDecls[e])})}var I=n.src.tonyu,A=(I.text(),r),L=(e.traceTbl,n.decls),O=(L.fields,L.methods),W=(L.natives,a),F={},B=o(),U=!1,q={type:"postfix",left:{type:"postfix",left:A.T,op:{type:"member",name:{text:A.N}}},op:{type:"call",args:A.A}},K={type:"postfix",left:A.T,op:{type:"member",name:{text:A.N}}},X=fiberCallTmpl={type:"postfix",left:{type:"varAccess",name:{text:A.N}},op:{type:"call",args:A.A}},H={expr:fiberCallTmpl},G={expr:{type:"infix",op:A.O,left:A.L,right:fiberCallTmpl}},z={expr:{type:"superExpr",params:{args:A.A},$var:"S"}},Y={expr:{type:"infix",op:A.O,left:A.L,right:{type:"superExpr",params:{args:A.A},$var:"S"}}};n.annotation={};var V=s({varDecl:function(n){B.locals.varDecls[n.name.text]=n},funcDecl:function(n){B.locals.subFuncDecls[n.head.name.text]=n},funcExpr:function(){},"catch":function(n){B.locals.varDecls[n.name.text]=n},exprstmt:function(){},forin:function(n){n.isVar;n.vars.forEach(function(e){B.locals.varDecls[e.text]=n});var e=p("_it_");t(n,{iterName:e}),B.locals.varDecls[e]=n}});V.def=P;var J=s({varAccess:function(n){var e=S(n.name.text);t(n,{scopeInfo:e})},funcDecl:function(){},funcExpr:function(n){N(n)},jsonElem:function(n){if(n.value)this.visit(n.value);else{var e=S(n.key.text);t(n,{scopeInfo:e})}},"do":function(n){var e=this;B.enter({jumpable:!0},function(){e.def(n)})},"switch":function(n){var e=this;B.enter({jumpable:!0},function(){e.def(n)})},"while":function(n){var e=this;B.enter({jumpable:!0},function(){e.def(n)})},"for":function(n){var e=this;B.enter({jumpable:!0},function(){e.def(n)})},forin:function(n){n.vars.forEach(function(n){var e=S(n.text);t(n,{scopeInfo:e})}),this.visit(n.set)},ifWait:function(n){var e="_thread",t=this,r=f(B.scope);r[e]=l(W.THVAR),B.enter({scope:r},function(){t.visit(n.then)}),n._else&&t.visit(n._else),R(this.path)},"try":function(n){B.finfo.useTry=!0,this.def(n)},"return":function(n){B.noWait||j(this.path,{hasReturn:!0}),this.visit(n.value)},"break":function(n){if(!B.jumpable)throw i("break； は繰り返しの中で使います.",I,n.pos);B.noWait||j(this.path,{hasJump:!0})},"continue":function(n){if(!B.jumpable)throw i("continue； は繰り返しの中で使います.",I,n.pos);B.noWait||j(this.path,{hasJump:!0})},reservedConst:function(n){"arguments"==n.text&&(B.finfo.useArgs=!0)},postfix:function(n){var e;if(this.visit(n.left),this.visit(n.op),e=A.match(n,X)){var r=t(n.left).scopeInfo;t(n,{myMethodCall:{name:e.N,args:e.A,scopeInfo:r}})}else(e=A.match(n,q))?t(n,{othersMethodCall:{target:e.T,name:e.N,args:e.A}}):(e=A.match(n,K))&&t(n,{memberAccess:{target:e.T,name:e.N}})},infix:function(n){var e=n.op.text;("="==e||"+="==e||"-="==e||"*="==e||"/="==e||"%="==e)&&T(n.left),this.def(n)},exprstmt:function(e){var r,i;if(B.noWait||!(r=A.match(e,H))||c(B.scope[r.N])!=W.METHOD||b(r.N).nowait)if(B.noWait||!(r=A.match(e,G))||c(B.scope[r.N])!=W.METHOD||b(r.N).nowait){if(!B.noWait&&(r=A.match(e,z))&&r.S.name){if(i=b(r.S.name.text),!i)throw new Error("メソッド"+r.S.name.text+" はありません。");i.nowait||(r.type="noRetSuper",r.superClass=n.superClass,t(e,{fiberCall:r}),R(this.path))}else if(!B.noWait&&(r=A.match(e,Y))&&r.S.name){if(i=b(r.S.name.text),!i)throw new Error("メソッド"+r.S.name.text+" はありません。");i.nowait||(r.type="retSuper",r.superClass=n.superClass,t(e,{fiberCall:r}),R(this.path))}}else r.type="ret",t(e,{fiberCall:r}),R(this.path);else r.type="noRet",t(e,{fiberCall:r}),R(this.path);this.visit(e.expr)}});J.def=P,x(),w(),M()}var a=u.ScopeTypes,l=u.newScopeType,c=u.getScopeType,f=u.newScope,p=u.genSym,h=u.annotation,d=u.getSource,m=u.getMethod,v=u.getDependingClasses,g=u.getParams,y={Array:1,String:1,Boolean:1,Number:1,Void:1,Object:1,RegExp:1,Error:1};return{initClassDecls:n,annotate:e}}()}),requireSimulator.setName("Tonyu.Compiler.JSGenerator"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(n,e,t,r,i,a,o,s,u){return u.JSGenerator=function(){function n(n,u){function D(e,t){return j(n.annotation,e,t)}function E(n){return"string"==typeof n?w+(u.aliases[n]||n):n.builtin?n.fullName:w+n.fullName}function $(n){var e=[];return n.forEach(function(n){e.push(E(n))}),e}function C(n,e){return function(){z.enter(n,function(){v.visit(e)})}}function M(n,r,i){var a=k(r);if(a==ne.THVAR)H.printf("%s",e);else if(a==ne.FIELD)H.printf("%s.%s",t,n);else if(a==ne.METHOD)i&&i.noBind?H.printf("%s.%s",t,n):H.printf("%s(%s,%s.%s)",m,t,t,n);else if(a==ne.CLASS)H.printf("%s",E(n));else if(a==ne.GLOBAL)H.printf("%s%s",b,n);else{if(a!=ne.PARAM&&a!=ne.LOCAL&&a!=ne.NATIVE)throw console.log("Unknown scope type: ",a),new Error("Unknown scope type: "+a);H.printf("%s",n)}return r}function N(n){return function(){_.apply(this,[n])}}function _(n){"compound"==n.type?z.enter({noWait:!0},function(){H.printf("%j%n",["%n",n.stmts])}):v.visit(n)}function I(e){return function(){H.printf("%s%s=%s;%n",u.options.compiler.commentLastPos?"//":"",p,J.add(n,e.pos))}}function A(){z.enter({},function(){w+n.namespace;G("Tonyu.klass.ensureNamespace(%s,%l);%n",w.replace(/\.$/,""),n.namespace),n.superClass?G("%s=Tonyu.klass(%s,[%s],{%{",E(n),E(n.superClass),$(n.includes).join(",")):G("%s=Tonyu.klass([%s],{%{",E(n),$(n.includes).join(","));for(var e in Q){Y&&console.log("method1",e);var t=Q[e];z.enter({noWait:!0,threadAvail:!1},function(){W(t)}),Y&&console.log("method2",e),t.nowait||z.enter({noWait:!1,threadAvail:!0},function(){O(t)}),Y&&console.log("method3",e)}G("__dummy: false%n"),G("%}});%n")}),G("Tonyu.klass.addMeta(%s,%s);%n",E(n),JSON.stringify(L(n)))}function L(n){var e={fullName:n.fullName,namespace:n.namespace,shortName:n.shortName,decls:{methods:{}}};for(var t in n.decls.methods)e.decls.methods[t]={nowait:!!n.decls.methods[t].nowait};return e}function O(n){function r(){z.enter({method:n,noWait:!0,threadAvail:!0},function(){o.forEach(function(n){G("%v%n",n)})})}function i(){z.enter({method:n,finfo:n,pc:1},function(){s.forEach(function(n){G("%v%n",n)})})}if(!K(n)){var a=n.stmts,o=[],s=[],u=o,p=!0;p?a.forEach(function(n){D(n).fiberCallRequired&&(u=s),u.push(n)}):s=a,G("%s%s :function %s(%j) {%{var %s=%s;%n%svar %s=%s;%nvar %s=0;%n%f%n%f%n",c,n.name,B(n.pos),[",",[re].concat(n.params)],t,T,n.useArgs?"":"//",l,"Tonyu.A(arguments)",f,q(n),r),s.length>0?G("%s.enter(function %s(%s) {%{if (%s.lastEx) %s=%s.catchPC;%nfor(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}});%n",e,B(n.pos),e,e,f,e,h,d,h,f,i,e,t):G("%s.retVal=%s;return;%n",e,t),G("%}},%n")}}function W(n){function e(){z.enter({method:n,finfo:n},function(){n.stmts.forEach(function(n){G("%v%n",n)})})}var r=K(n)?"initialize":n.name;G("%s :function %s(%j) {%{var %s=%s;%n%f%n%f%}},%n",r,B(n.pos),[",",n.params],t,T,q(n),e)}function F(n){function e(){z.enter({noWait:!0,threadAvail:!1,finfo:t},function(){n.body.stmts.forEach(function(n){G("%v%n",n)})})}var t=D(n);H.printf("function (%j) {%{%f%n%f%}}",[",",t.params],q(t),e)}function B(e){return"_trc_func_"+J.add(n,e)+"_"+ee++}function U(n){function e(){z.enter({noWait:!0,threadAvail:!1,finfo:t},function(){n.body.stmts.forEach(function(n){G("%v%n",n)})})}var t=D(n);H.printf("function %s(%j) {%{%f%n%f%}}",t.name,[",",t.params],q(t),e)}function q(n){function e(){z.enter({},function(){for(var e in n.locals.varDecls)H.printf("var %s;%n",e);for(var e in n.locals.subFuncDecls)U(n.locals.subFuncDecls[e])})}return e}function K(n){return V.match(n,{ftype:"constructor"})||V.match(n,{name:"new"})}var X=n.src.tonyu,H=a(),G=H.printf,z=o(),Y=!1,V=r,J=u.traceTbl,Z=n.decls,Q=(Z.fields,Z.methods),ne=(Z.natives,P),ee=0,te=u.options.compiler.diagnose,re={type:"THNode"};v=H.visitor=s({THNode:function(){H.printf(e)},dummy:function(n){H.printf("",n)},literal:function(n){H.printf("%s",n.text)},paramDecl:function(n){H.printf("%v",n.name)},paramDecls:function(n){H.printf("(%j)",[", ",n.params])},funcDeclHead:function(n){H.printf("function %v %v",n.name,n.params)},funcDecl:function(){},"return":function(n){if(z.inTry)throw i("現実装では、tryの中にreturnは書けません",X,n.pos);z.noWait?z.threadAvail?n.value?H.printf("%s.retVal=%v;return;%n",e,n.value):H.printf("%s.retVal=%s;return;%n",e,t):n.value?H.printf("return %v;",n.value):H.printf("return %s;",t):n.value?H.printf("%s.exit(%v);return;",e,n.value):H.printf("%s.exit(%s);return;",e,t)},program:function(n){genClass(n.stmts)},number:function(n){H.printf("%s",n.value)},reservedConst:function(n){"this"==n.text?H.printf("%s",t):"arguments"==n.text&&z.threadAvail?H.printf("%s",l):n.text==e?H.printf("%s",z.threadAvail?e:"null"):H.printf("%s",n.text)},varDecl:function(n){n.value?H.printf("%v = %v",n.name,n.value):H.printf("%v",n.name)},varsDecl:function(n){I(n)(),H.printf("%j;",[";",n.decls])},jsonElem:function(n){n.value?H.printf("%v: %v",n.key,n.value):H.printf("%v: %f",n.key,function(){M(n.key.text,D(n).scopeInfo,D(n))})},objlit:function(n){H.printf("{%j}",[",",n.elems])},arylit:function(n){H.printf("[%j]",[",",n.elems])},funcExpr:function(n){F(n)},parenExpr:function(n){H.printf("(%v)",n.expr)},varAccess:function(n){{var e=n.name.text;M(e,D(n).scopeInfo,D(n))}},exprstmt:function(r){var i={};if(I(r)(),z.noWait||(i=D(r).fiberCall||{}),"noRet"==i.type)H.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{",t,c,i.N,[", ",[re].concat(i.A)],f,z.pc,z.pc++);else if("ret"==i.type)H.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",t,c,i.N,[", ",[re].concat(i.A)],f,z.pc,z.pc++,i.L,i.O,e);else if("noRetSuper"==i.type){var a=E(n.superClass);H.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{",a,c,i.S.name.text,t,[", ",[re].concat(i.A)],f,z.pc,z.pc++)}else"retSuper"==i.type?H.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",a,c,i.S.name.text,t,[", ",[re].concat(i.A)],f,z.pc,z.pc++,i.L,i.O,e):H.printf("%v;",r.expr)},infix:function(n){var e=n.op.text;if(te){if("+"==e||"-"==e||"*"==e||"/"==e||"%"==e)return void H.printf("%s(%v,%l)%v%s(%v,%l)",x,n.left,R(n.left),n.op,x,n.right,R(n.right));if("+="==e||"-="==e||"*="==e||"/="==e||"%="==e)return void H.printf("%v%v%s(%v,%l)",n.left,n.op,x,n.right,R(n.right))}H.printf("%v%v%v",n.left,n.op,n.right)},trifixr:function(n){H.printf("%v%v%v%v%v",n.left,n.op1,n.mid,n.op2,n.right)},prefix:function(n){H.printf("%v %v",n.op,n.right)},postfix:function(n){var e=D(n);if(te){if(e.myMethodCall){var r=e.myMethodCall,i=r.scopeInfo,a=k(i);return void(a==ne.FIELD||a==ne.METHOD?H.printf("%s(%s, %l, [%j], %l )",g,t,r.name,[",",r.args],"this"):H.printf("%s(%v, [%j], %l)",y,n.left,[",",r.args],R(n.left)))}if(e.othersMethodCall){var o=e.othersMethodCall;return void H.printf("%s(%v, %l, [%j], %l )",g,o.target,o.name,[",",o.args],R(o.target))}if(e.memberAccess){var s=e.memberAccess;return void H.printf("%s(%v,%l).%s",x,s.target,R(s.target),s.name)}}else if(e.myMethodCall){var r=e.myMethodCall,i=r.scopeInfo,a=k(i);if(a==ne.METHOD)return void H.printf("%s.%s(%j)",t,r.name,[",",r.args])}H.printf("%v%v",n.left,n.op)},"break":function(n){if(z.noWait)H.printf("break;%n");else{if(z.inTry&&z.exitTryOnJump)throw i("現実装では、tryの中にbreak;は書けません",X,n.pos);if(!z.closestBrk)throw i("break； は繰り返しの中で使います",X,n.pos);H.printf("%s=%z; break;%n",f,z.closestBrk)}},"try":function(n){var t=D(n);if(!z.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)){if(1!=n.catches.length||"catch"!=n.catches[0].type)throw i("現実装では、catch節1個のみをサポートしています",X,n.pos);var r=n.catches[0],a={},o={};H.printf("%s.enterTry(%z);%n",e,a),H.printf("%f",C({inTry:!0,exitTryOnJump:!0},n.stmt)),H.printf("%s.exitTry();%n",e),H.printf("%s=%z;break;%n",f,o),H.printf("%}case %f:%{",function(){H.print(a.put(z.pc++))}),H.printf("%s=%s.startCatch();%n",r.name.text,e),H.printf("%s.exitTry();%n",e),H.printf("%v%n",r.stmt),H.printf("%}case %f:%{",function(){H.print(o.put(z.pc++))})}else z.enter({noWait:!0},function(){H.printf("try {%{%f%n%}} ",N(n.stmt)),n.catches.forEach(v.visit)})},"catch":function(n){H.printf("catch (%s) {%{%f%n%}}",n.name.text,N(n.stmt))},"throw":function(n){H.printf("throw %v;%n",n.ex)},"while":function(n){I(n)();var e=D(n);if(z.noWait||!e.fiberCallRequired&&!e.hasReturn)z.enter({noWait:!0},function(){H.printf("while (%v) {%{%f%n%}}",n.cond,N(n.loop))});else{var t=H.lazy(),r=z.pc++,i="reservedConst"==n.cond.type&&"true"==n.cond.text;H.printf("%}case %d:%{"+(i?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",r,n.cond,f,t,C({closestBrk:t,exitTryOnJump:!1},n.loop),f,r,function(){H.print(t.put(z.pc++))})}},"for":function(n){function e(n,e,t){return function(){t.forEach(function(e,t){H.printf("%s=%s[%s];%n",e.text,n,t)})}}I(n)();var t=D(n);if("forin"==n.inFor.type){var r=D(n.inFor).iterName;if(z.noWait||!t.fiberCallRequired&&!t.hasReturn)z.enter({noWait:!0},function(){H.printf("%s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%f%n%}}",r,S,n.inFor.set,n.inFor.vars.length,r,e(r,n.inFor.isVar,n.inFor.vars),N(n.loop))});else{var i=H.lazy(),a=z.pc++;H.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",r,S,n.inFor.set,n.inFor.vars.length,a,r,f,i,e(r,n.inFor.isVar,n.inFor.vars),C({closestBrk:i,exitTryOnJump:!1},n.loop),f,a,function(n){n.print(i.put(z.pc++))})}}else if(z.noWait||!t.fiberCallRequired&&!t.hasReturn)z.enter({noWait:!0},function(){H.printf("%v%nwhile(%v) {%{%v%n%v;%n%}}",n.inFor.init,n.inFor.cond,n.loop,n.inFor.next)});else{var i=H.lazy(),a=z.pc++;H.printf("%v;%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%v;%n%s=%s;break;%n%}case %f:%{",n.inFor.init,a,n.inFor.cond,f,i,C({closestBrk:i,exitTryOnJump:!1},n.loop),n.inFor.next,f,a,function(n){n.print(i.put(z.pc++))})}},"if":function(n){I(n)();var e=D(n);if(!z.noWait&&(e.fiberCallRequired||e.hasJump||e.hasReturn)){var t={},r={};n._else?H.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",n.cond,f,r,n.then,f,t,function(){H.print(r.put(z.pc++))},n._else,function(){H.print(t.put(z.pc++))}):H.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",n.cond,f,t,n.then,function(){H.print(t.put(z.pc++))})}else z.enter({noWait:!0},function(){n._else?H.printf("if (%v) {%{%f%n%}} else {%{%f%n%}}",n.cond,N(n.then),N(n._else)):H.printf("if (%v) {%{%f%n%}}",n.cond,N(n.then))})},ifWait:function(n){z.noWait?n._else&&H.printf("%v",n._else):H.printf("%v",n.then)
},call:function(n){H.printf("(%j)",[",",n.args])},objlitArg:function(n){H.printf("%v",n.obj)},argList:function(n){H.printf("%j",[",",n.args])},newExpr:function(n){var e=n.params;e?H.printf("new %v%v",n.klass,e):H.printf("new %v",n.klass)},scall:function(n){H.printf("[%j]",[",",n.args])},superExpr:function(e){var r;e.name?(r=e.name.text,H.printf("%s.prototype.%s.apply( %s, %v)",E(n.superClass),r,t,e.params)):H.printf("%s.apply( %s, %v)",E(n.superClass),t,e.params)},arrayElem:function(n){H.printf("[%v]",n.subscript)},member:function(n){H.printf(".%v",n.name)},symbol:function(n){H.print(n.text)},normalFor:function(n){H.printf("%v; %v; %v",n.init,n.cond,n.next)},compound:function(n){var e=D(n);!z.noWait&&(e.fiberCallRequired||e.hasJump||e.hasReturn)?H.printf("%j",["%n",n.stmts]):z.enter({noWait:!0},function(){H.printf("{%{%j%n%}}",["%n",n.stmts])})},"typeof":function(){H.printf("typeof ")},"instanceof":function(){H.printf(" instanceof ")},is:function(){H.printf(" instanceof ")},regex:function(n){H.printf("%s",n.text)}});var ie=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];return ie.forEach(function(n){v.funcs[n]=function(){H.printf("%s",n)}}),v.def=function(n){throw console.log("Err node="),console.log(n),n.type+" is not defined in visitor:compiler2"},v.cnt=0,A(),n.src.js=H.buf,Y&&console.log("method4",H.buf),H.buf}{var e="_thread",t="_this",l="_arguments",c="fiber$",f="__pc",p="$LASTPOS",h="__cnt",d=100,m="Tonyu.bindFunc",g="Tonyu.invokeMethod",y="Tonyu.callFunc",x="Tonyu.checkNonNull",w="Tonyu.classes.",b="Tonyu.globals.",T="this.isTonyuObject?this:Tonyu.not_a_tonyu_object(this)",S="Tonyu.iterator",P=u.ScopeTypes,k=u.getScopeType,j=u.annotation,R=u.getSource;u.getMethod,u.getDependingClasses,u.getParams}return{genJS:n}}()}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","typeCheck","Blob","thumbnail","WebSite","plugins","Tonyu.Compiler.Semantics","Tonyu.Compiler.JSGenerator"],function(Tonyu,TError,FS,Tonyu_TraceTbl,ImageList,StackTrace,tc,Blob,thumbnail,WebSite,plugins,Semantics,JSGenerator){return Tonyu.Project=function(dir,kernelDir){function orderByInheritance(n){var e={},t=[],r=0;for(var i in n)e[i]=!1,r++;for(;t.length<r;){var a=t.length;for(var i in n)if(!e[i]){var o=n[i],s=o.superClass,u=[s],l=!0;o.includes&&(u=u.concat(o.includes)),u.forEach(function(n){l=l&&(!n||n.builtin||e[n.fullName])}),l&&(t.push(o),e[i]=!0)}if(t.length==a)throw TError("クラスの循環参照があります","不明",0)}return t}var TPR={},home=FS.get(WebSite.tonyuHome);kernelDir||(kernelDir=home.rel("Kernel/"));var traceTbl=Tonyu.TraceTbl(),env={classes:{},traceTbl:traceTbl,options:{compiler:{}}};return TPR.EXT=".tonyu",TPR.NSP_KER="kernel",TPR.NSP_USR="user",TPR.env=env,TPR.dumpJS=function(n){function e(n){console.log("Class "+n+":\n"+env.classes[n].src.js)}if(n)e(n);else for(var n in env.classes)e(n)},TPR.stop=function(){var n=TPR.runningThread;n&&n.kill();var e=TPR.runningObj;e&&e.stop&&e.stop()},TPR.rawRun=function(n){TPR.compile(),TPR.runScriptMode||thumbnail.set(TPR,2e3),TPR.rawBoot(n)},TPR.compile=function(){console.log("Kernel editable",TPR.isKernelEditable()),TPR.isKernelEditable()?TPR.compileDir(TPR.NSP_KER,[dir,kernelDir]):(env.kernelClasses||TPR.compileKernel(),TPR.compileUser())},TPR.compileKernel=function(){TPR.compileDir(TPR.NSP_KER,[kernelDir]),env.kernelClasses=env.classes},TPR.compileUser=function(){TPR.compileDir(TPR.NSP_USR,[dir],env.kernelClasses)},TPR.compileDir=function(nsp,dirs,baseClasses){function collect(n){if(n.endsWith(TPR.EXT)){var e=n.truncExt(TPR.EXT),t=nsp+"."+e;env.classes[t]={name:e,fullName:t,shortName:e,namespace:nsp,src:{tonyu:n}},env.aliases[e]=t,delete skip[t]}}TPR.getOptions(),Tonyu.runMode=!1,env.classes=Tonyu.extend({},baseClasses||{}),env.aliases={};for(var n in env.classes){var cl=env.classes[n];env.aliases[cl.shortName]=cl.fullName}var skip=Tonyu.extend({},baseClasses||{});Tonyu.currentProject=TPR,Tonyu.globals.$currentProject=TPR;for(var i=dirs.length-1;i>=0;i--)dirs[i].each(collect);for(var n in env.classes)skip[n]||(console.log("initClassDecl: "+n),Semantics.initClassDecls(env.classes[n],env));var ord=orderByInheritance(env.classes);ord.forEach(function(n){skip[n.fullName]||(console.log("annotate :"+n.fullName),Semantics.annotate(n,env))}),ord.forEach(function(c){if(!skip[c.fullName]){console.log("genJS :"+c.fullName),JSGenerator.genJS(c,env);try{eval(c.src.js)}catch(e){throw console.log(c.src.js),e}}})},TPR.getResource=function(){var n=dir.rel("res.json");return n.exists()?n.obj():Tonyu.defaultResource},TPR.setResource=function(n){var e=dir.rel("res.json");e.obj(n)},TPR.getThumbnail=function(){return thumbnail.get(TPR)},TPR.convertBlobInfos=function(n){function e(t){if("object"==typeof t)for(var i in t)if(t.hasOwnProperty(i)){var a=t[i];if("url"==i){var o;(o=Blob.isBlobURL(a))&&(t[i]=[Blob.BLOB_PATH_EXPR,n,r,o.fileName].join("/"))}e(a)}}var t=TPR.getResource(),r=TPR.getName();e(t),TPR.setResource(t)},TPR.getBlobInfos=function(){function n(e){if("object"==typeof e)for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];if("url"==r){var a;(a=Blob.isBlobURL(i))&&t.push(a)}n(i)}}var e=TPR.getResource(),t=[];return n(e),t},TPR.loadResource=function(n){var e=TPR.getResource();ImageList(e.images,function(e){var t=Tonyu.getGlobal("$Sprites");t&&t.setImageList(e);for(var r in e.names)Tonyu.setGlobal(r,e.names[r]);n&&n()})},TPR.getOptions=function(){env.options=null;var n=dir.rel("options.json");return n.exists()&&(env.options=n.obj()),env.options&&!env.options.run&&(env.options=null),env.options||(env.options=Tonyu.defaultOptions),TPR.fixOptions(env.options),env.options},TPR.fixOptions=function(n){n.compiler||(n.compiler={}),n.compiler.commentLastPos=TPR.runScriptMode||StackTrace.isAvailable(),n.run.mainClass=TPR.fixClassName(n.run.mainClass),n.run.bootClass=TPR.fixClassName(n.run.bootClass),n.plugins||(n.plugins={},dir.each(function(e){e.endsWith(TPR.EXT)&&plugins.detectNeeded(e.text(),n.plugins)}))},TPR.requestPlugin=function(n){if(!plugins.loaded(n)){var e=TPR.getOptions();e.plugins[n]=1,TPR.setOptions(e);var t=new Error("必要なプラグイン"+n+"を追加しました。もう一度実行してください");throw t.pluginName=n,t}},TPR.loadPlugins=function(n){var e=TPR.getOptions();plugins.loadAll(e.plugins,n)},TPR.fixClassName=function(n){if(TPR.classExists(n))return n;var e,t=n.split("."),r=t.pop();return e=TPR.NSP_USR+"."+r,TPR.classExists(e)?e:(e=TPR.NSP_KER+"."+r,TPR.classExists(e)?e:n)},TPR.classExists=function(n){var e=n.split(".");if(1==e.length)return!1;var t=e[0],r=e[1];if(TPR.isKernelEditable()){if(t==TPR.NSP_KER){if(dir.rel(r+TPR.EXT).exists())return!0;if(kernelDir.rel(r+TPR.EXT).exists())return!0}}else{if(t==TPR.NSP_KER&&kernelDir.rel(r+TPR.EXT).exists())return!0;if(t==TPR.NSP_USR&&dir.rel(r+TPR.EXT).exists())return!0}return!1},TPR.setOptions=function(n){n&&(env.options=n);var e=dir.rel("options.json");e.obj(env.options)},TPR.rawBoot=function(n){var e=Tonyu.getClass(n);if(!e)throw TError(n+" というクラスはありません","不明",0);var t=new e,r=Tonyu.thread();r.apply(t,"main"),TPR.runningThread=r,TPR.runningObj=t,$LASTPOS=0,r.steps()},TPR.isKernel=function(n){var e=kernelDir.rel(n+TPR.EXT);return e.exists()?e:null},TPR.isKernelEditable=function(){return env.options.kernelEditable},TPR.getDir=function(){return dir},TPR.getName=function(){return dir.name().replace(/\/$/,"")},TPR.renameClassName=function(n,e){TPR.compile();var t=TPR.env.classes;for(var r in t){var i=t[r],a=i.src.tonyu,o=i.annotation,s=[];if(o&&a){for(var u in o)try{var l=o[u],c=l.scopeInfo;if(c&&"class"==c.type&&c.name==n){var f=l.node.pos,p=l.node.len,h=a.text().substring(f,f+p);h==n&&(s.push({pos:f,len:p}),console.log(a.path(),f,p,a.text().substring(f-5,f+p+5),"->",e))}}catch(d){console.log(d)}s=s.sort(function(n,e){return e.pos-n.pos}),console.log(a.path(),s);var m=a.text(),v=m;s.forEach(function(n){m=m.substring(0,n.pos)+e+m.substring(n.pos+n.len)}),v==m||a.isReadOnly()||(console.log("Refact:",a.path(),m),a.text(m))}}},TPR}}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite"],function(n,e,t){function r(n,e){var t=i(n);if(e&&!t.exists())throw t+": no such file or directory";return t}function i(t){if("string"!=typeof t)return t;if(e.startsWith(t,"/"))return n.get(t);var r=a.cwd;return r.rel(t)}var a={cwd:n.get("/")};return a.cd=function(n){return a.cwd=r(n,!0),a.pwd()},a.resolve=r,a.pwd=function(){return a.cwd+""},a.ls=function(n){return n=n?r(n,!0):a.cwd,n.ls()},a.cp=function(n,e,t){t||(t={}),t.v&&a.echo("cp",n,e);var i=r(n,!0),o=r(e);if(i.isDir()&&o.isDir()){var s=0;return i.recursive(function(n){var e=n.relPath(i),r=o.rel(e);(t.test||t.v)&&a.echo((r.exists()?"[ovr]":"[new]")+r+"<-"+n),t.test||r.copyFrom(n,t),s++}),s}if(i.isDir()||o.isDir()){if(!i.isDir()&&o.isDir())return o.rel(i.name()).text(i.text()),1;throw"Cannot copy directory "+i+" to file "+o}return o.text(i.text()),1},a.rm=function(n,e){if(e||(e={}),e.notrash)return n=r(n,!1),n.removeWithoutTrash(),1;if(n=r(n,!0),n.isDir()&&e.r){var t=n,i=0;return t.each(function(n){n.exists()&&(i+=a.rm(n,e))}),t.rm(),i+1}return n.rm(),1},a.cat=function(n){n=r(n,!0),a.echo(n.text())},a.resolve=function(n){return n||(n="."),n=r(n)},a.grep=function(n,e,t){function i(n,e,r){t.res&&t.res.push({file:n,lineNo:e,line:r}),a.echo(n+"("+e+"): "+r)}return e=r(e,!0),t||(t={}),t.res||(t.res=[]),e.isDir()?e.each(function(e){a.grep(n,e,t)}):"string"==typeof n&&e.lines().forEach(function(t,r){t.indexOf(n)>=0&&i(e,r+1,t)}),t.res},a.touch=function(n){return n=r(n),n.text(n.exists()?n.text():""),1},a.setout=function(n){a.outUI=n},a.echo=function(){console.log.apply(console,arguments),a.outUI&&a.outUI.log&&a.outUI.log.apply(a.outUI,arguments)},a.err=function(){console.log.apply(console,arguments),a.outUI&&a.outUI.err&&a.outUI.err.apply(a.outUI,arguments)},a.prompt=function(){},a.ASYNC={r:"SH_ASYNC"},a.help=function(){for(var n in a){var e=a[n];"function"==typeof e&&a.echo(n+(e.description?" - "+e.description:""))}},sh=a,t.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),a}),requireSimulator.setName("KeyEventChecker"),define([],function(){var n={};return n.down=function(e,t,r){e instanceof $||(e=$(e)),e.bind("keydown",function(i){return n.is(i,t)?r.call(e[0],i):void 0})},n.is=function(n,e){e=e.toLowerCase(),n=n.originalEvent||n;var t="";return n.altKey&&(t+="alt+"),n.ctrlKey&&(t+="ctrl+"),n.shiftKey&&(t+="shift+"),t+=n.keyCode>=112&&n.keyCode<=123?"f"+(n.keyCode-111):String.fromCharCode(n.keyCode),t=t.toLowerCase(),e==t},n}),requireSimulator.setName("ScriptTagFS"),define([],function(){var n={};return n.toObj=function(){function n(n,e){var t=n.split("\n"),r="";return t.forEach(function(n){r+=n.length>e?n.substring(0,e):n+"\n"}),r}var e=$("script"),t={};return e.each(function(){var e=this;if("text/tonyu"==e.type){var r=$(e).data("filename");if(r){var i=$(e).data("wrap");i?(i=parseInt(i),t[r]=n(e.innerHTML,i)):t[r]=e.innerHTML}}}),t},n}),requireSimulator.setName("TextRect"),TextRect=function(){function n(n,t,r,i,a,o,s){o||(o="center"),n.textBaseline="top",e(n,a);var u=n.measureText(t),l={y:i,w:u.width,h:a};switch(o.substring(0,1).toLowerCase()){case"l":l.x=r;break;case"r":l.x=r-u.width;break;case"c":l.x=r-u.width/2}return"fill"==s&&n.fillText(t,l.x,i),"stroke"==s&&n.strokeText(t,l.x,i),l}function e(n,e){var t=n.font.replace(/^[0-9\.]+/,"");n.font=e+t}return{draw:n,setFontSize:e}}(),requireSimulator.setName("fukidashi"),requireSimulator.setName("runtime"),requirejs(["ImageList","TextRect","fukidashi"],function(){}),requireSimulator.setName("runScript"),requirejs(["FS","Tonyu.Project","Shell","KeyEventChecker","ScriptTagFS","runtime","WebSite"],function(n,e,t,r,i,a,o){$(function(){function r(){s=$(window).width(),u=$(window).height(),l.attr({width:s,height:u})}var a=n.get(o.tonyuHome);Tonyu.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32}],sounds:[]},SplashScreen={hide:function(){$("#splash").hide()},show:function(){}};var s=$(window).width(),u=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var l=$("<canvas>").attr({width:s,height:u}).appendTo("body");$(window).resize(r);var c=location.href.replace(/\?.*/,"").split(/\//),f=c.pop();f.length<0&&(c="runscript");var p=a.rel(f+"/"),h=i.toObj();for(var d in h){var m=p.rel(d);m.isDir()||m.useRAMDisk().text(h[d])}t.cd(p);var v="Main",g=$("script");g.each(function(){var n=this;if("text/tonyu"==n.type){var e=$(n).data("filename");if(e){var t=p.rel(e);$(n).data("main")&&(v=t.truncExt(".tonyu"))}}}),Tonyu.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:v,bootClass:"Boot"},kernelEditable:!1};var y=a.rel("Kernel/"),x=e(p,y),w=x.getOptions();w.compiler&&w.compiler.diagnose&&(w.compiler.diagnose=!1,x.setOptions(w)),x.runScriptMode=!0,x.rawRun(w.run.bootClass)})}),requireSimulator.setName();