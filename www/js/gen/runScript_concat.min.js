!function(){var t={};return t.def=function(e,n,r){var i=t.getModuleInfo(t.curName);i.type=r,t.setReqs(i,e),i.func=function(){return n.apply(this,t.getObjs(e))},t.loadIfAvailable(i)},define=function(e,n){t.def(e,n,"define")},requirejs=function(e,n){t.def(e,n,"require")},t.setReqs=function(e,n){n.forEach(function(n){var r=t.getModuleInfo(n);r.loaded||(e.reqs[n]=r,r.revReqs[e.name]=e)})},t.getModuleInfo=function(e){var n=t.modules;return n[e]||(n[e]={name:e,reqs:{},revReqs:{}}),n[e]},t.doLoad=function(e){var n=t.getModuleInfo(e);if(n.loaded)return n.obj;n.loaded=!0;var r=null;if(n.func)r=n.func();else{var i=e.split(/\./);r=function(){return this}(),i.forEach(function(t){r&&(r=r[t])}),null==r&&console.log("Warning: No obj for "+e)}if("define"==n.type&&null==r)throw"No obj for "+e;n.obj=r;for(var o in n.revReqs)t.notifyLoaded(n.revReqs[o],n.name);return r},t.notifyLoaded=function(e,n){delete e.reqs[n],t.loadIfAvailable(e)},t.loadIfAvailable=function(e){for(var n in e.reqs)return;t.doLoad(e.name)},t.getObjs=function(e){var n=[];return e.forEach(function(e){var r=t.doLoad(e);n.push(r)}),n},t.modules={},t.setName=function(e){t.curName&&(t.getModuleInfo(t.curName).func||t.doLoad(t.curName)),e&&(t.curName=e)},requireSimulator=t,t}(),requireSimulator.setName("extend"),define([],function(){return function(t,e){for(var n in e)t[n]=e[n]}}),requireSimulator.setName("assert"),define([],function(){function t(e){if(e instanceof Array){var n=[];return e.forEach(function(e){n=n.concat(t(e))}),n}return[e]}var e=function(e){this.failMesg=t(e||"Assertion failed: ")};e.prototype={fail:function(){var e=$a(arguments);throw e=t(e),e=this.failMesg.concat(e),console.log.apply(console,e),new Error(e.join(" "))},subAssertion:function(){var n=$a(arguments);return n=t(n),new e(this.failMesg.concat(n))},assert:function(t,e){return t||this.fail(e),t},eq:function(t,e){return t!==e&&this.fail(t,"!==",e),t},is:function(t,e){var n=e,r=t;if(null==n)return n;if(n._assert_func)return n._assert_func.apply(this,[r]),t;if(this.assert(null!=t,[t,"should be ",n]),n instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&n instanceof global.Array){t&&"number"==typeof t.length||this.fail(t,"should be array:");for(var i=this,o=0;o<n.length;o++){var s=i.subAssertion("failed at ",t,"[",o,"]: ");s.is(r[o],n[o])}return t}if(n===String||"string"==n)return this.assert("string"==typeof r,[r,"should be a string "]),t;if(n===Number||"number"==n)return this.assert("number"==typeof r,[r,"should be a number"]),t;if(n instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&n instanceof global.RegExp)return this.is(r,String),this.assert(n.exec(r),[r,"does not match to",n]),t;if("function"==typeof n)return this.assert(r instanceof n,[r,"should be ",n]),t;if(n&&"object"==typeof n){for(var a in n){var s=this.subAssertion("failed at ",t,".",a,":");s.is(t[a],n[a])}return t}this.fail("Invaild type: ",n)},ensureError:function(t,e){try{t()}catch(n){return"string"==typeof e&&r(n+""===e,t+" thrown an error "+n+" but expected:"+e),void console.log("Error thrown successfully: ",n.message)}this.fail(t,"should throw an error",e)}},$a=function(t){for(var e=[],n=0;n<t.length;n++)e.push(t[n]);return e};var n=new e,r=function(){try{return n.assert.apply(n,arguments)}catch(t){throw new Error(t.message)}};return r.is=function(){try{return n.is.apply(n,arguments)}catch(t){throw new Error(t.message)}},r.eq=function(){try{return n.eq.apply(n,arguments)}catch(t){throw new Error(t.message)}},r.ensureError=function(){try{return n.ensureError.apply(n,arguments)}catch(t){throw new Error(t.message)}},r.fail=n.fail.bind(n),r.f=function(t){return{_assert_func:t}},r.and=function(){var t=$a(arguments);return r(t instanceof Array),r.f(function(e){for(var n=this,r=0;r<t.length;r++)n.is(e,t[r])})},r}),requireSimulator.setName("PathUtil"),define(["assert"],function(t){function e(e,n){return t.is(arguments,[String,String]),e.substring(e.length-n.length)===n}function n(e,n){return t.is(arguments,[String,String]),e.substring(0,n.length)===n}var r,i=/^([a-zA-Z]):/,o=t.f(function(t){this.is(t,String),this.assert(r.isPath(t),[t," is not a path"])}),s=t.f(function(t){this.is(t,String),this.assert(r.isAbsolutePath(t),[t," is not a absolute path"])}),a=t.f(function(t){this.is(t,String),this.assert(!r.isAbsolutePath(t),[t," is not a relative path"])}),u=t.and(f,s),f=t.f(function(t){this.is(t,o),this.assert(r.isDir(t),[t," is not a directory path"])}),c=t.f(function(t){this.is(t,o),this.assert(!r.isDir(t),[t," is not a file path"])}),l="/";return r={Path:o,Absolute:s,Relative:a,Dir:f,File:c,AbsDir:u,SEP:l,endsWith:e,startsWith:n,hasDriveLetter:function(t){return i.exec(t)},isPath:function(e){return t.is(arguments,[String]),!e.match(/\/\//)},isRelativePath:function(e){return t.is(arguments,[String]),r.isPath(e)&&!r.isAbsolutePath(e)},isAbsolutePath:function(e){return t.is(arguments,[String]),r.isPath(e)&&(r.startsWith(e,l)||r.hasDriveLetter(e))},isDir:function(n){return t.is(arguments,[o]),e(n,l)},splitPath:function(e){t.is(arguments,[o]);var n=e.split(l);return""==n[n.length-1]&&(n[n.length-2]+=l,n.pop()),n},name:function(e){return t.is(arguments,[String]),r.splitPath(e).pop()},ext:function(e){t.is(arguments,[String]);var n=r.name(e),i=/\.[a-zA-Z0-9]+$/.exec(n);return i?i[0]:null},truncExt:function(e,n){t.is(e,String);var i=r.name(e);return n=n||r.ext(e),t.is(n,String),i.substring(0,i.length-n.length)},truncSEP:function(e){return t.is(arguments,[o]),r.isDir(e)?e.substring(0,e.length-1):e},endsWith:function(n,i){return t.is(arguments,[String,String]),e(r.name(n),i)},parent:function(e){return t.is(arguments,[String]),r.up(e)},rel:function(e,n){if(""==n)return e;t.is(arguments,[u,a]);var i=r.splitPath(n),o=e;o=o.replace(/\/$/,"");var s=r;return i.forEach(function(t){".."==t||"../"==t?o=s.up(o):(o=o.replace(/\/$/,""),o+=l+("."==t||"./"==t?"":t))}),o},relPath:function(e,n){return t.is(arguments,[u,u]),e.substring(0,n.length)!=n?"../"+r.relPath(e,this.up(n)):e.substring(n.length)},up:function(e){if(t.is(arguments,[o]),e==l)return null;var n=r.splitPath(e);return n.pop(),n.join(l)+l}}}),requireSimulator.setName("MIMETypes"),define([],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".mp3":"audio/mp3",".ogg":"audio/ogg",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu"}}),requireSimulator.setName("DataURL"),define(["extend","assert"],function(t,e){function n(t){return t instanceof ArrayBuffer||"undefined"!=typeof Buffer&&t instanceof Buffer}function r(t){function e(e){throw console.log(e),console.log(t,c),new Error(e)}t=t.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=t.length,s=0,a=0;if(!i)return new o(0);r=Math.floor(i/4*3),"="==t.charAt(i-1)&&(r-=1),"="==t.charAt(i-2)&&(r-=1);for(var u=new o(r),f="undefined"!=typeof Buffer?u:new Uint8Array(u),c=0,l=0;r>l&&(a=n[t.charCodeAt(c)],void 0===a&&e("Invalid letter: "+t.charCodeAt(c)),s=a<<2,c++,a=n[t.charCodeAt(c)],void 0===a&&e("Invalid letter: "+t.charCodeAt(c)),f[l]=s|a>>4&3,s=(15&a)<<4,c++,l++,!(l>=r))&&(a=n[t.charCodeAt(c)],void 0===a&&e("Invalid letter: "+t.charCodeAt(c)),f[l]=s|a>>2&15,s=(3&a)<<6,c++,l++,!(l>=r));)a=n[t.charCodeAt(c)],void 0===a&&e("Invalid letter: "+t.charCodeAt(c)),f[l]=s|a,c++,l++;return u}function i(t){for(var e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(t),i=r.length,o=0,s=0,a=0;i>a&&(s=r[a],n+=e[s>>2],o=(3&s)<<4,a++,!(a>=i))&&(s=r[a],n+=e[o|s>>4],o=(15&s)<<2,a++,!(a>=i));)s=r[a],n+=e[o|s>>6],n+=e[63&s],a++;var u=i%3;return u&&(n+=e[o]),1==u?n+="==":2==u&&(n+="="),n}var o="undefined"!=typeof Buffer?Buffer:ArrayBuffer,s=function(t,r){"string"==typeof t?(this.url=t,this.dataURL2bin(t)):t&&n(t.buffer)?(this.buffer=t.buffer,e.is(r,String),this.contentType=r,this.bin2dataURL(this.buffer,this.contentType)):n(t)?(this.buffer=t,e.is(r,String),this.contentType=r,this.bin2dataURL(this.buffer,this.contentType)):e.fail("Invalid args: ",arguments)};return t(s.prototype,{bin2dataURL:function(t,r){e(n(t)),e.is(r,String);var o=this.dataHeader(r),s=i(t);return e.is(s,String),this.url=o+s},dataURL2bin:function(t){e.is(arguments,[String]);var n=/^data:([^;]+);base64,/i,i=n.exec(t);return e(i,["malformed dataURL:",t]),this.contentType=i[1],this.buffer=r(t.substring(i[0].length)),e.is(this.buffer,o)},dataHeader:function(t){return e.is(arguments,[String]),"data:"+t+";base64,"},toString:function(){return e.is(this.url,String)}}),s}),requireSimulator.setName("Contents"),define(["DataURL"],function(t){var e={convert:function(e,n){var r;if("string"==typeof e&&(r=String),e instanceof t&&(r=t),e instanceof ArrayBuffer&&(r=ArrayBuffer),r==n)return e;throw new Error("Cannot convert from "+r+" to "+n)}};return e}),requireSimulator.setName("Util"),Util=function(){function t(t,n){null==n&&(n=""),t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?n:e(i[1])}function e(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function n(t,e){return t.substring(t.length-e.length)===e}function r(t,e){return t.substring(0,e.length)===e}function i(t){function e(e){throw console.log(e),console.log(t,f),new Error(e)}t=t.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=t.length,o=0,s=0;if(!i)return new ArrayBuffer(0);r=Math.floor(i/4*3),"="==t.charAt(i-1)&&(r-=1),"="==t.charAt(i-2)&&(r-=1);for(var a=new ArrayBuffer(r),u=new Uint8Array(a),f=0,c=0;r>c&&(s=n[t.charCodeAt(f)],void 0===s&&e("Invalid letter: "+t.charCodeAt(f)),o=s<<2,f++,s=n[t.charCodeAt(f)],void 0===s&&e("Invalid letter: "+t.charCodeAt(f)),u[c]=o|s>>4&3,o=(15&s)<<4,f++,c++,!(c>=r))&&(s=n[t.charCodeAt(f)],void 0===s&&e("Invalid letter: "+t.charCodeAt(f)),u[c]=o|s>>2&15,o=(3&s)<<6,f++,c++,!(c>=r));)s=n[t.charCodeAt(f)],void 0===s&&e("Invalid letter: "+t.charCodeAt(f)),u[c]=o|s,f++,c++;return a}function o(t){for(var e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(t),i=r.length,o=0,s=0,a=0;i>a&&(s=r[a],n+=e[s>>2],o=(3&s)<<4,a++,!(a>=i))&&(s=r[a],n+=e[o|s>>4],o=(15&s)<<2,a++,!(a>=i));)s=r[a],n+=e[o|s>>6],n+=e[63&s],a++;var u=i%3;return u&&(n+=e[o]),1==u?n+="==":2==u&&(n+="="),n}function s(t){if(t.__privatized)return t;var e={__privatized:!0};for(var n in t)!function(n){var r=t[n];n.match(/^_/)||"function"==typeof r&&(e[n]=function(){var e=r.apply(t,arguments);return e})}(n);return e}return{getQueryString:t,endsWith:n,startsWith:r,Base64_To_ArrayBuffer:i,Base64_From_ArrayBuffer:o,privatize:s}}(),requireSimulator.setName("SFile"),define(["Contents","extend","assert","PathUtil","Util"],function(e,n,r,i,o){var s=function(t,e){r.is(e,i.Absolute),r(t&&t.getReturnTypes),this._path=e,this.fs=t,this.isDir()&&!i.isDir(e)&&(this._path+=i.SEP)};return s.is=function(t){return t&&"function"==typeof t.isSFile&&t.isSFile()},s.prototype={isSFile:function(){return!0},setPolicy:function(t){if(this.policy)throw new Error("policy already set");return this.policy=t,this._clone()},_clone:function(){return this._resolve(this.path())},_resolve:function(t,e){var n;if(e=e||{},s.is(t))n=t;else{r.is(t,i.Absolute);var a,u=e.policy||this.policy;if(u&&(a=u.topDir)&&(a.path&&(a=a.path()),!i.startsWith(t,a)))throw new Error(t+": cannot access. Restricted to "+a);n=this.fs.getRootFS().get(t),n.policy=u}return n.policy?o.privatize(n):n},contains:function(t){return r(s.is(t),t+" shoud be a SFile object."),this.isDir()?i.startsWith(t.path(),this.path()):!1},path:function(){return this._path},name:function(){return i.name(this.path())},truncExt:function(t){return i.truncExt(this.path(),t)},ext:function(){return i.ext(this.path())},relPath:function(t){var e=t.path?t.path():t;return i.relPath(this.path(),r.is(e,i.Absolute))},up:function(){var t=this.path(),e=i.up(t);return null==e?null:this._resolve(e)},rel:function(t){r.is(t,i.Relative),this.assertDir();var e=this.path();return this._resolve(i.rel(e,t))},startsWith:function(t){return i.startsWith(this.name(),t)},endsWith:function(t){return i.endsWith(this.name(),t)},equals:function(t){return t&&"function"==typeof t.path&&t.path()==this.path()},toString:function(){return this.path()},touch:function(){this.fs.touch(this.path())},isReadOnly:function(){this.fs.isReadOnly(this.path())},isTrashed:function(){var t=this.metaInfo();return t?t.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(t){return this.fs.getMetaInfo(this.path(),t)},setMetaInfo:function(t,e){return this.fs.setMetaInfo(this.path(),t,e)},lastUpdate:function(){return r(this.exists()),this.metaInfo().lastUpdate},exists:function(t){t=t||{};var e=this.fs.exists(this.path(),t);return e||t.noFollowLink?e:this._resolveLinkNoPolicy().exists({noFollowLink:!0})},rm:function(t){if(t=t||{},!this.exists({noFollowLink:!0})){var e=this._resolveLinkNoPolicy();if(!this.equals(e))return e.rm(t)}this.isDir()&&(t.recursive||t.r)&&this.each(function(e){e.rm(t)});var n=this.path();this.fs.rm(n,t)},removeWithoutTrash:function(t){t=t||{},t.noTrash=!0,this.rm(t)},isDir:function(){return this.fs.isDir(this.path())},text:function(){var t=this._resolveLinkNoPolicy();return this.equals(t)?arguments.length>0?void this.setText(arguments[0]):this.getText():t.text.apply(t,arguments)},setText:function(t){r.is(t,String),this.fs.setContent(this.path(),t)},getText:function(){return this.fs.getContent(this.path(),{type:String})},isText:function(){return this.fs.isText(this.path())},setBytes:function(e){return r.is(t,ArrayBuffer),this.fs.setContent(e)},getBytes:function(){return this.fs.getContent(this.path(),{type:ArrayBuffer})},getURL:function(){return this.fs.getURL(this.path())},lines:function(){return this.text().split("\n")},obj:function(){var t=this;if(0==arguments.length){var e=t.text();return e?JSON.parse(e):null}t.text(JSON.stringify(r.is(arguments[0],Object)))},copyTo:function(t,e){return t.copyFrom(this,e)},copyFrom:function(t,e){var n=this,e=e||{},o=t.isDir(),s=n.isDir();if(!o&&s&&(n=n.rel(t.name()),r(!n.isDir(),n+" is a directory."),s=!1),o&&!s)this.err("Cannot move dir to file");else{if(!o&&!s)return e.echo&&e.echo(t+" -> "+n),this.fs.cp(r.is(t.path(),i.Absolute),n.path(),e);r(o&&s),t.each(function(t){n.rel(t.name()).copyFrom(t,e)})}},moveFrom:function(t,e){var n=this.copyFrom(t,e);return t.rm({recursive:!0}),n},assertDir:function(){return r.is(this.path(),i.Dir),this},each:function(t,e){var n=this.assertDir();n.listFiles(e).forEach(t)},recursive:function(t,e){var n=this.assertDir();n.each(function(e){e.isDir()?e.recursive(t):t(e)},e)},listFiles:function(t){r(null==t||"object"==typeof t);var e=this.assertDir(),n=this._resolveLinkNoPolicy();if(!this.equals(n))return n.listFiles.apply(n,arguments).map(function(t){return e.rel(t.name())});var i,o=this.path();"function"==typeof t&&(i=t),t=e.convertOptions(t),i||(i=t.order);for(var s=this.fs.opendir(o,t),a=[],u=0;u<s.length;u++){var f=s[u];t.excludes[o+f]||a.push(e.rel(f))}return"function"==typeof i&&a.sort&&a.sort(i),a},ls:function(t){r(null==t||"object"==typeof t);var e=this.assertDir(),n=e.listFiles(t);return n.map(function(t){return t.name()})},convertOptions:function(t){var e=(this.assertDir(),this.path());if(t||(t={}),t.excludes||(t.excludes={}),t.excludes instanceof Array){var n={};t.excludes.forEach(function(t){i.startsWith(t,"/")?n[t]=1:n[e+t]=1}),t.excludes=n}return r.is(t,{excludes:{}})},mkdir:function(){this.touch()},link:function(t,e){t=this._resolve(r(t)),this.fs.link(this.path(),t.path(),e)},_resolveLinkOpt:function(t){var e=this.fs.resolveLink(this.path());return r.is(e,i.Absolute),this._resolve(e,t)},_resolveLinkNoPolicy:function(){return this._resolveLinkOpt({policy:{}})},resolveLink:function(){return this._resolveLinkOpt()},isLink:function(){return this.fs.isLink(this.path())}},s}),requireSimulator.setName("FS2"),define(["extend","PathUtil","MIMETypes","assert","SFile"],function(t,e,n,r,i){function o(t){throw new Error(t+" is STUB!")}var s=function(){};return t(s.prototype,{err:function(t,e){throw new Error(t+": "+e)},fstab:function(){return this._fstab=this._fstab||[]},resolveFS:function(t){r.is(t,e.Absolute);var n;return this.fstab().forEach(function(r){n||e.startsWith(t,r.path)&&(n=r.fs)}),n||(n=this),r.is(n,s)},isReadOnly:function(){o("isReadOnly")},mounted:function(t,n){r.is(arguments,[s,e.AbsDir]),this.parentFS=t,this.mountPoint=n},relFromMountPoint:function(t){return r.is(t,e.Absolute),this.parentFS?(r.is(this.mountPoint,e.AbsDir),e.relPath(t,this.mountPoint)):e.relPath(t,e.SEP)},dirFromFstab:function(t,n){r.is(t,e.AbsDir);var i=(n||{}).res||[];return this.fstab().forEach(function(n){e.up(n.path)==t&&i.push(e.name(n.path))}),i},getRootFS:function(){for(var t,e=this;e;e=e.parentFS)t=e;return r.is(t,s)},getReturnTypes:function(){o("")},getContent:function(){o("")},setContent:function(){o("")},getMetaInfo:function(){o("")},setMetaInfo:function(){o("")},mkdir:function(){o("mkdir")},touch:function(){o("touch")},exists:function(){o("exists")},opendir:function(){o("opendir")},cp:function(t,n,i){r.is(arguments,[e.Absolute,e.Absolute]),i=i||{};var o=this.isDir(t),s=this.resolveFS(n).isDir(n);if(o||s)throw"only file to file supports";var a=this.getContent(t),u=this.resolveFS(n).setContent(n,a);return i.a&&this.setMetaInfo(n,this.getMetaInfo(t)),u},mv:function(t,e,n){return this.cp(t,e,n),this.rm(t,{r:!0})},rm:function(){o("")},link:function(){throw new Error("This FS not support link.")},getURL:function(){o("")}}),s.delegateMethods=function(t,n){for(var i in n)!function(i){t[i]=function(){var t=arguments[0];r.is(t,e.Absolute);var o=this.resolveFS(t);return o!==this?o[i].apply(o,arguments):n[i].apply(this,arguments)}}(i)},s.delegateMethods(s.prototype,{assertWriteable:function(t){this.isReadOnly(t)&&this.err(t,"read only.")},mount:function(t,n){if(r.is(arguments,[e.AbsDir,s]),this.exists(t))throw new Error(t+": Directory exists");var i=e.up(t);if(null==i)throw new Error("Cannot mount on root");if(!this.exists(i))throw new Error(t+": Parent Directory not exist");n.mounted(this,t),this.fstab().unshift({path:t,fs:n})},getContentType:function(t,r){var i=e.ext(t);return n[i]||(r||{}).def||"text/plain"},isText:function(t){var n=this.getContentType(t);return e.startsWith(n,"text")},assertExist:function(t,n){this.exists(t,n)||this.err(t,": No such "+(e.isDir(t)?"directory":"file"))},isDir:function(t){return e.isDir(t)},find:function(t,n){r.is(arguments,[e.Absolute]);var i=this.opendir(t,n),o=this,s=[t];return i.forEach(function(r){var i=e.rel(t,r);if(e.isDir(i)){var a=o.resolveFS(i);s=s.concat(a.find(i,n))}else s.push(i)}),s},resolveLink:function(t){r.is(t,e.Absolute);for(var n=t;n;n=e.up(n)){r(!this.mountPoint||e.startsWith(n,this.mountPoint),n+" is out of mountPoint. path="+t);var i=this.isLink(n);if(i){r(i!=n,"l==p=="+i);var o=e.rel(i,e.relPath(t,n));return r(o!=t,"np==path=="+o),r.is(this.getRootFS().resolveFS(o).resolveLink(o),e.Absolute)}if(this.exists(n))return t}return t},isLink:function(){return null},get:function(t){return r.eq(this.resolveFS(t),this),new i(this,t)}}),s}),requireSimulator.setName("WebSite"),define([],function(){var t,e=document.location.href,n=!!e.match(/html\/dev\//)&&!!e.match(/localhost:3/);t=e.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:n,pluginTop:"http://tonyuedit.appspot.com/js/plugins",removeJSOutput:!0}:e.match(/tonyuexe\.appspot\.com/)||e.match(/localhost:8887/)||e.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:n}:{urlAliases:{},top:".",devMode:n};var r=window.navigator.userAgent.toLowerCase();return t.tablet=-1!=r.indexOf("windows")&&-1!=r.indexOf("touch")||-1!=r.indexOf("ipad")||-1!=r.indexOf("android")&&-1==r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("tablet")||-1!=r.indexOf("kindle")||-1!=r.indexOf("silk")||-1!=r.indexOf("playbook"),t.mobile=-1!=r.indexOf("windows")&&-1!=r.indexOf("phone")||-1!=r.indexOf("iphone")||-1!=r.indexOf("ipod")||-1!=r.indexOf("android")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("blackberry"),t.pluginTop||(t.pluginTop=t.top+"/js/plugins"),t.disableROM={},e.match(/tonyuedit\.appspot\.com/)||e.match(/localhost:8888/),(e.match(/\.appspot\.com/)||e.match(/localhost:888[87]/))&&(t.serverType="GAE"),e.match(/localhost:3000/)&&(t.serverType="Node"),t.serverTop=e.match(/tonyuexe\.appspot\.com/)||e.match(/localhost:8887/)?t.top+"/exe":t.top+"/edit",t.sampleImg=t.top+"/images",t.blobPath=t.serverTop+"/serveBlob",t.isNW="object"==typeof process&&process.__node_webkit,t.mp3Disabled=t.isNW,t.tonyuHome="/Tonyu/",t.url={getDirInfo:t.serverTop+"/getDirInfo",getFiles:t.serverTop+"/File2LSSync",putFiles:t.serverTop+"/LS2FileSync"},t.isNW&&(t.cwd=process.cwd().replace(/\\/g,"/").replace(/\/?$/,"/"),t.tonyuHome=process.env.TONYU_HOME?process.env.TONYU_HOME.replace(/\\/g,"/").replace(/\/?$/,"/"):t.cwd+"fs/Tonyu/",t.logdir="/var/log/Tonyu/",t.wwwDir=t.cwd+"www/",t.kernelDir=t.wwwDir+"Kernel/",t.ffmpeg=t.cwd+"ffmpeg/bin/ffmpeg.exe"),t.compiledKernel=e.match(/tonyuedit\.appspot\.com/)||e.match(/localhost:888/)||t.isNW?t.top+"/Kernel/js/concat.js":"http://tonyuexe.appspot.com/Kernel/js/concat.js",window.WebSite=t}),requireSimulator.setName("NativeFS"),define(["FS2","assert","PathUtil","extend","MIMETypes","DataURL"],function(t,e,n,r,i,o){var s="object"==typeof process&&process.__node_webkit;if(!s)return function(){throw new Error("This system not suppert native FS")};var a=e,u=require("fs"),f=function(t){t&&(e.is(t,n.AbsDir),this.rootPoint=t)};f.available=!0;var c=n.SEP,l=f.prototype=new t;return l.toNativePath=function(t){return this.rootPoint?(e.is(t,n.Absolute),n.rel(this.rootPoint,this.relFromMountPoint(t))):t},t.delegateMethods(f.prototype,{getReturnTypes:function(){return a.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(t,r){r=r||{},e.is(t,n.Absolute);var i=this.toNativePath(t),s=r.type;if(this.isText(t))return s===String?u.readFileSync(i,{encoding:"utf8"}):u.readFileSync(i);if(s===String){var a=u.readFileSync(i),f=new o(a,this.getContentType(t));return f.url}return u.readFileSync(i)},setContent:function(t,r){e.is(t,n.Absolute);var i=n.up(t);i&&this.getRootFS().mkdir(i);var s=this.toNativePath(t),a="string"==typeof r;if(!this.isText(t)){if(a){var f=new o(r);return u.writeFileSync(s,f.buffer)}return u.writeFileSync(s,r)}u.writeFileSync(s,r)},getMetaInfo:function(t,e){this.assertExist(t,e);var n=this.stat(t);return n.lastUpdate=n.mtime.getTime(),n},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(t){e.is(t,n.Absolute);var r=this.toNativePath(t);return u.statSync(r)},mkdir:function(t){if(a.is(arguments,[n.Absolute]),this.exists(t)){if(this.isDir(t))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(t);var e=n.up(t);e&&this.getRootFS().mkdir(e);var r=this.toNativePath(t);return u.mkdirSync(r)},opendir:function(t){a.is(arguments,[String]);var e=this.toNativePath(t),r=n.truncSEP(e),i=u.readdirSync(e).map(function(t){var e=u.statSync(r+c+t),n=e.isDirectory()?c:"";return t+n}),o=this.dirFromFstab(t);return a.is(o.concat(i),Array)},rm:function(t,e){a.is(arguments,[n.Absolute]),e=e||{},this.assertExist(t);var r=this.toNativePath(t);return this.isDir(t)?u.rmdirSync(r):u.unlinkSync(r)},exists:function(t){var e=this.toNativePath(t);return u.existsSync(e)},isDir:function(t){return this.exists(t)?this.stat(t).isDirectory():n.isDir(t)},touch:function(t){!this.exists(t)&&this.isDir(t)?this.mkdir(t):this.exists(t)&&!this.isDir(t)},getURL:function(t){return"file:///"+t.replace(/\\/g,"/")}}),f}),requireSimulator.setName("LSFS"),define(["FS2","PathUtil","extend","assert","DataURL"],function(t,e,n,r,i){function o(){return(new Date).getTime()}var s=function(t,e){this.storage=t,this.options=e||{}},a=e.isDir.bind(e),u=e.up.bind(e),f=e.endsWith.bind(e),c=(e.Path,e.Absolute),l=e.SEP;return s.ramDisk=function(){var t={};return t[e.SEP]="{}",new s(t)},s.now=o,s.prototype=new t,s.prototype.resolveKey=function(t){return r.is(t,e.Absolute),e.SEP+this.relFromMountPoint(t)},s.prototype.getItem=function(t){r.is(t,e.Absolute);var n=this.resolveKey(t);return this.storage[n]},s.prototype.setItem=function(t,n){r.is(t,e.Absolute);var i=this.resolveKey(t);r(i.indexOf("..")<0),r(e.startsWith(i,e.SEP)),this.storage[i]=n},s.prototype.removeItem=function(t){r.is(t,e.Absolute);var n=this.resolveKey(t);delete this.storage[n]},s.prototype.itemExists=function(t){r.is(t,e.Absolute);var n=this.resolveKey(t);return n in this.storage},s.prototype.inMyFS=function(t){return!this.mountPoint||e.startsWith(t,this.mountPoint)},s.prototype.getDirInfo=function(t){if(r.is(arguments,[e.AbsDir]),null==t)throw new Error("getDir: Null path");f(t,l)||(t+=l),r(this.inMyFS(t));var n={};try{var i=this.getItem(t);i&&(n=JSON.parse(i))}catch(o){console.log("dinfo err : ",t,i)}return n},s.prototype.putDirInfo=function(t,n,i){if(r.is(arguments,[e.AbsDir,Object]),!a(t))throw new Error("Not a directory : "+t);r(this.inMyFS(t)),this.setItem(t,JSON.stringify(n));var o=u(t);if(null!=o){if(!this.inMyFS(o))return r(this.getRootFS()!==this),void this.getRootFS().touch(o);var s=this.getDirInfo(o);this._touch(s,o,e.name(t),i)}},s.prototype._touch=function(t,e,n,i){r.is(arguments,[Object,String,String]),r(this.inMyFS(e)),t[n]||(t[n]={},i&&(t[n].trashed=!0)),i||delete t[n].trashed,t[n].lastUpdate=o(),this.putDirInfo(e,t,i)},s.prototype.removeEntry=function(t,e,n){r.is(arguments,[Object,String,String]),t[n]&&(t[n]={lastUpdate:o(),trashed:!0},this.putDirInfo(e,t,!0))},s.prototype.removeEntryWithoutTrash=function(t,e,n){r.is(arguments,[Object,String,String]),t[n]&&(delete t[n],this.putDirInfo(e,t,!0))},t.delegateMethods(s.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return r.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(t,e){if(r.is(arguments,[c]),this.assertExist(t),e&&e.type==ArrayBuffer){var n=new i(this.getItem(t));return n.buffer}return this.getItem(t)},setContent:function(t,e){r.is(arguments,[c,String]),this.assertWriteable(t),this.setItem(t,e),this.touch(t)},getMetaInfo:function(t){if(this.assertExist(t,{includeTrashed:!0}),r.is(arguments,[c]),t==e.SEP)return{};var n=r(e.up(t));if(!this.inMyFS(n))return{};var i=e.name(t);r.is(n,e.AbsDir);var o=this.getDirInfo(n);return r(o[i])},setMetaInfo:function(t,n){r.is(arguments,[String,Object]),this.assertWriteable(t);var i=r(e.up(t));if(this.inMyFS(i)){var o=this.getDirInfo(i),s=e.name(t);o[s]=n,this.putDirInfo(i,o,o[s].trashed)}},mkdir:function(t){r.is(arguments,[c]),this.assertWriteable(t),this.touch(t)},opendir:function(t,e){r.is(arguments,[String]),e=e||{};var n=this.getDirInfo(t),i=this.dirFromFstab(t);for(var o in n)r(n[o]),(!n[o].trashed||e.includeTrashed)&&i.push(o);return r.is(i,Array)},rm:function(t,n){r.is(arguments,[c]),n=n||{},this.assertWriteable(t);var i=e.up(t);if(null==i||!this.inMyFS(i))throw new Error(t+": cannot remove. It is root of this FS.");if(this.assertExist(t,{includeTrashed:n.noTrash}),e.isDir(t)){var o=this.opendir(t);o.length>0&&this.err(t,"Directory not empty"),n.noTrash&&this.removeItem(t)}else this.removeItem(t);var s=this.getDirInfo(i);n.noTrash?this.removeEntryWithoutTrash(s,i,e.name(t)):this.removeEntry(s,i,e.name(t))},exists:function(t,n){r.is(arguments,[c]),n=n||{};var i=e.name(t),o=e.up(t);if(null==o||!this.inMyFS(o))return!0;var s=this.getDirInfo(o),a=s[i];return a&&a.trashed&&this.itemExists(t)&&(this.isDir(t)||r.fail("Inconsistent "+t+": trashed, but remains in storage")),!a&&this.itemExists(t)&&r.fail("Inconsistent "+t+": not exists in metadata, but remains in storage"),!a||a.trashed||a.link||this.itemExists(t)||r.fail("Inconsistent "+t+": exists in metadata, but not in storage"),a&&!n.includeTrashed&&(a=!a.trashed),!!a},link:function(t,n){r.is(arguments,[e.AbsDir,e.AbsDir]),this.assertWriteable(t),this.exists(t)&&this.err(t,"file exists"),e.isDir(t)&&!e.isDir(n)&&this.err(t," can not link to file "+n),!e.isDir(t)&&e.isDir(n)&&this.err(t," can not link to directory "+n);var i={};i.link=n,i.lastUpdate=o(),this.setMetaInfo(t,i),console.log(this.storage),r(this.exists(t)),r(this.isLink(t))},isLink:function(t){if(r.is(arguments,[e.AbsDir]),!this.exists(t))return null;var n=r(this.getMetaInfo(t));
return n.link},touch:function(t){r.is(arguments,[c]),this.assertWriteable(t),this.itemExists(t)||(e.isDir(t)?this.setItem(t,"{}"):this.setItem(t,""));var n=u(t);if(null!=n)if(this.inMyFS(n)){var i=this.getDirInfo(n);this._touch(i,n,e.name(t),!1)}else r(this.getRootFS()!==this),this.getRootFS().touch(n)},getURL:function(t){return this.getContent(t,{type:String})}}),s}),requireSimulator.setName("Env"),define(["assert","PathUtil"],function(t,e){var n=function(t){this.value=t};return n.prototype={expand:function(e){t.is(e,String);var n=this;return e.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,e){return n.get(e)})},expandPath:function(n){return t.is(n,String),n=this.expand(n),n=n.replace(/\/+/g,"/"),t.is(n,e.Path)},get:function(t){return this.value[t]},set:function(t,e){this.value[t]=e}},n}),requireSimulator.setName("FS"),define(["FS2","WebSite","NativeFS","LSFS","PathUtil","Env","assert","SFile"],function(t,e,n,r,i,o,s,a){var t={};"object"==typeof window&&(window.FS=t);var u,f=new o(e);return u=e.isNW?new n:new r(localStorage),t.get=function(){return u.get.apply(u,arguments)},t.expandPath=function(){return f.expandPath.apply(f,arguments)},t.resolve=function(e,n){return a.is(e)?e:(e=f.expandPath(e),n&&!i.isAbsolutePath(e)?(n=f.expandPath(n),t.get(n).rel(e)):t.get(e))},t.mount=function(){return u.mount.apply(u,arguments)},t}),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert"],function(t){return Tonyu=function(){function e(){function t(){return null!=x&&T}function e(){return w}function n(){M=!0,S=0}function r(t){x={prev:x,func:t}}function i(t,e,n){n||(n=[]);var i;"string"==typeof e&&(i=t["fiber$"+e]),"function"==typeof e&&(i=e.fiber),n=[b].concat(n);var o=0;r(function(){switch(o){case 0:i.apply(t,n),o=1;break;case 1:f(),o=2}})}function o(){if(x)try{x.func(b)}catch(t){a(t)}}function a(t){if(0==b.tryStack.length)return v(),void s(t);b.lastEx=t;for(var e=b.tryStack.pop();x;){if(e.frame===x){b.catchPC=e.catchPC;break}x=x.prev}}function u(){var t=b.lastEx;return b.lastEx=null,t}function f(t){x=x?x.prev:null,b.retVal=t}function c(t){b.tryStack.push({frame:x,catchPC:t})}function l(){b.tryStack.pop()}function p(t,e){if(n(),t.on){var r;e=e.concat(function(){b.lastEvent=arguments,b.retVal=arguments[0],r.remove(),g()}),r=t.on.apply(t,e)}}function h(t){var e=function(){b.retVal=arguments,g()},r=function(){for(var t="",e=0;e<arguments.length;e++)t+=arguments[e]+",";0==t.length&&(t="Async fail");var n=new Error(t);n.args=arguments,a(n),g()};t(e,r),n()}function d(e){w=!0,n(),e&&e.addTerminatedListener&&e.addTerminatedListener(function(){if(w=!1,b.group)b.group.notifyResume();else if(t())try{b.steps()}catch(e){s(e)}})}function m(t){b.group=t,t&&t.add(b)}function g(){var e=Tonyu.currentThread;for(Tonyu.currentThread=b,S=E,b.preempted=!1,M=!1;S-->0&&x;)o();b.preempted=!M&&t(),Tonyu.currentThread=e}function v(){T=!1,x=null}function y(){x=null,tryStack=[]}var b={enter:r,apply:i,exit:f,steps:g,step:o,isAlive:t,isWaiting:e,suspend:n,retVal:0,tryStack:[],kill:v,waitFor:d,setGroup:m,enterTry:c,exitTry:l,startCatch:u,waitEvent:p,runAsync:h,clearFrame:y},x=null,T=!0,S=0,w=!1,M=!1;return b}function n(t){var e={},n=[];return e.addTerminatedListener=function(t){n.push(t)},setTimeout(function(){n.forEach(function(t){t()})},t),e}function r(){var t={},e=[];return t.addTerminatedListener=function(t){e.push(t)},requestAnimationFrame(function(){e.forEach(function(t){t()})}),t}function i(){var t=[],e=[],n=!1;return t.addTerminatedListener=function(t){n?setTimeout(t,0):e.push(t)},t.receiver=function(){n=!0;for(var e=0;e<arguments.length;e++)t[e]=arguments[e];t.notify()},t.notify=function(){e.forEach(function(t){t()})},t}function o(){function t(t){t.group=u,p?p.push(t):f.push(t)}function n(n,r,i){r||(r="main");var o=e();return o.apply(n,r,i),t(o),o}function r(){try{i()}catch(t){s(t)}}function i(){function t(t){t.isWaiting()||(l=!1,t.steps())}for(var e=f.length-1;e>=0;e--){var n=f[e];n.isAlive()&&n.group===u||f.splice(e,1)}for(l=!0,p=[],f.forEach(t);p.length>0;)w=p,p=[],w.forEach(function(e){f.push(e),t(e)});p=null}function o(){c=!1}function a(){}var u,f=[],c=!0,l=!1,p=null;return u={add:t,addObj:n,steps:r,kill:o,notifyResume:a,threads:f}}function s(t){if(!Tonyu.onRuntimeError)throw alert("エラー! at "+$LASTPOS+" メッセージ  : "+t),t;Tonyu.onRuntimeError(t)}function a(t){if(t===Function)return null;if("function"==typeof t)t.constructor=null;else if("object"==typeof t)for(var e in t)t[e]=a(t[e]);return t}function u(e,n){return t.is(arguments,[String,Object]),c(klass.getMeta(e),n)}function f(t,e){return t?c(new t,e):e}function c(t,e){if(e&&"object"==typeof e)for(var n in e)t[n]=e[n];return t}function l(t,e){M[t]=e}function p(t){return M[t]}function h(t){var e=t.split("."),n=L;if(e.forEach(function(t){n&&(n=n[t])}),!n&&1==e.length){var r;for(var i in L){var o=L[i][t];if(o){if(n)throw new Error("曖昧なクラス名： "+i+"."+t+", "+r);n=o,r=i+"."+t}}}return n}function d(t,e){var n=function(){return e.apply(t,arguments)};return n.methodInfo=Tonyu.extend({thiz:t},e.methodInfo||{}),e.fiber&&(n.fiber=function(){return e.fiber.apply(t,arguments)},n.fiber.methodInfo=Tonyu.extend({thiz:t},e.fiber.methodInfo||{})),n}function m(t,e,n,r){if(!t)throw new Error(r+"(="+t+")のメソッド "+e+"を呼び出せません");var i=t[e];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+e+"(="+i+")はメソッドではありません");return i.apply(t,n)}function g(t,e,n){if("function"!=typeof t)throw new Error(n+"は関数ではありません");return t.apply({},e)}function v(t,e){if(t!=t||null==t)throw new Error(e+"(="+t+")は初期化されていません");return t}function y(t){for(var e=[],n=1;n<t.length;n++)e[n-1]=t[n];return e}function b(){throw new Error("クラス名はnewをつけて呼び出して下さい。")}function x(t){throw console.log("Not a tonyu object: ",t),new Error(t+" is not a tonyu object")}function T(t,e){return t in e}function S(t){var n=h(t);if(!n)throw new Error(t+" というクラスはありません");Tonyu.runMode=!0;var r=new n,i=e();i.apply(r,"main");var o;(o=Tonyu.currentProject)&&(o.runningThread=i,o.runningObj=r),$LASTPOS=0,i.steps()}var E=60;klass=function(){throw alert("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again."),new Error("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again.")},klass.addMeta=u,klass.getMeta=function(t){if("function"==typeof t)return t.meta;if("string"==typeof t){var e=A[t];return e||(A[t]=e={}),e}},klass.ensureNamespace=function(t,e){var n,r=e.split("."),i=t;for(n=0;n<r.length;n++){var o=r[n];i[o]||(i[o]={}),i=i[o]}return i},klass.define=function(t){var e=t.superclass,n=t.includes,r=t.fullName,i=t.shortName,o=t.namespace,s=t.methods,c=t.decls,l=klass.ensureNamespace(Tonyu.classes,o),p=a(s),h=p.initialize;delete p.initialize;var d;d=h?e?function(){this instanceof d||b(),Tonyu.runMode?h.apply(this,arguments):e.apply(this,arguments)}:function(){this instanceof d||b(),Tonyu.runMode&&h.apply(this,arguments)}:e?function(){this instanceof d||b(),e.apply(this,arguments)}:function(){this instanceof d||b()},l[i]=d,d.methods=p,n.forEach(function(t){if(!t.methods)throw t+" Does not have methods";for(var e in t.methods)e in p||(p[e]=t.methods[e])});var m={},g=/^__([gs]et)ter__(.*)$/;for(var v in p)if(!v.match(/^fiber\$/)){p["fiber$"+v]&&(p[v].fiber=p["fiber$"+v],p[v].fiber.methodInfo={name:v,klass:d,fiber:!0}),p[v].methodInfo={name:v,klass:d};var y=g.exec(v);y&&(m[y[2]]=m[y[2]]||{},m[y[2]][y[1]]=p[v])}d.prototype=f(e,p),d.prototype.isTonyuObject=!0;for(var v in m)Object.defineProperty(d.prototype,v,m[v]);d.meta=u(r,{fullName:r,shortName:i,namepsace:o,decls:c,superclass:e?e.meta:null,func:d,includes:n.map(function(t){return t.meta})});var x=klass.getMeta(d);return d.prototype.getClassInfo=function(){return x},d};var M={},L={},A={};return Tonyu={thread:e,threadGroup:o,klass:klass,bless:f,extend:c,globals:M,classes:L,classMetas:A,setGlobal:l,getGlobal:p,getClass:h,timeout:n,animationFrame:r,asyncResult:i,bindFunc:d,not_a_tonyu_object:x,hasKey:T,invokeMethod:m,callFunc:g,checkNonNull:v,run:S,VERSION:1448500513331,A:y}}()}),requireSimulator.setName("Tonyu.Iterator"),define(["Tonyu"],function(){function t(t,e){var n={};if(t.tonyuIterator)return t.tonyuIterator(e);if(t instanceof Array)n.i=0,n.next=1==e?function(){return n.i>=t.length?!1:(this[0]=t[n.i],n.i++,!0)}:function(){return n.i>=t.length?!1:(this[0]=n.i,this[1]=t[n.i],n.i++,!0)};else{if(!(t instanceof Object))throw console.log(t),new Error(t+" is not iterable");n.i=0;var r=[];if(1==e){for(var i in t)r.push(i);n.next=function(){return n.i>=r.length?!1:(this[0]=r[n.i],n.i++,!0)}}else{for(var i in t)r.push([i,t[i]]);n.next=function(){return n.i>=r.length?!1:(this[0]=r[n.i][0],this[1]=r[n.i][1],n.i++,!0)}}}return n}return Tonyu.iterator=t,t}),requireSimulator.setName("IndentBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return IndentBuffer=function(){var t=function(){function e(){i++;var t=n[i];if(null==t)throw console.log(n),new Error(i+"th null param: fmt="+r);return t}for(var n=arguments,r=n[0],i=0;;){var o=r.indexOf("%");if(0>o){t.buf+=r;break}t.buf+=r.substring(0,o),o++;var s=r.charAt(o);if("s"==s){var a=e();"string"==typeof a||"number"==typeof a||(null==a?a="null":a.text&&(a=a.text)),t.buf+=a,o++}else if("d"==s){var u=e();if("number"!=typeof u)throw new Error(u+" is not a number: fmt="+r);t.buf+=u,o++}else if("n"==s)t.ln(),o++;else if("{"==s)t.indent(),o++;else if("}"==s)t.dedent(),o++;else if("%"==s)t.buf+="%";else if("f"==s)e()(t),o++;else if("l"==s){var f=e();t.buf+=t.toLiteral(f),o++}else if("v"==s){var c=e();if(!c)throw new Error("Null %v");if("object"!=typeof c)throw new Error("nonobject %v:"+c);t.visitor.visit(c),o++}else if("z"==s){var l=e();if("val"in l)return void(t.buf+=l.val);l.gen||t.lazy(l),t.buf+=l.gen,o++}else if("j"==s){var p=e(),h=p[0],d=p[1],m=!1;if(!d||!d.forEach)throw console.log(d),new Error(d+" is not array. cannot join fmt:"+r);d.forEach(function(e){m&&t.printf(h),m=!0,t.visitor.visit(e)}),o++}else"D"==s?(e(),o++):o+=2;r=r.substring(o)}};return t.print=function(e){t.buf+=e},t.printf=t,t.buf="",t.lazy=function(e){return e||(e={}),e.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),e.reg=new RegExp(e.gen,"g"),e.put=function(e){return this.val=e,t.buf=t.buf.replace(this.reg,e),e},e},t.ln=function(){t.buf+="\n"+t.indentBuf},t.indent=function(){t.indentBuf+=t.indentStr,t.buf+="\n"+t.indentBuf},t.dedent=function(){var e=t.indentStr.length;if(!t.buf.substring(t.buf.length-e).match(/^\s*$/))throw console.log(t.buf),new Error("Non-space truncated ");t.buf=t.buf.substring(0,t.buf.length-e),t.indentBuf=t.indentBuf.substring(0,t.indentBuf.length-e)},t.toLiteral=function(t,e){return e||(e="'"),t=t.replace(/\\/g,"\\\\"),t=t.replace(/\r/g,"\\r"),t=t.replace(/\n/g,"\\n"),t="'"==e?t.replace(/'/g,"\\'"):t.replace(/"/g,'\\"'),e+t+e},t.indentBuf="",t.indentStr="  ",t}}),requireSimulator.setName("disp"),"function"!=typeof define&&(define=require("requirejs").define),define(["IndentBuffer"],function(t){return disp=function(e){function n(t){if(null==t)return r("null%n");if("string"==typeof t)return r("'%s'%n",t);if("number"==typeof t)return r("%s%n",t);if("function"==typeof t)return r("func%n");r(t instanceof Array?"[%{":"{%{");var e="";for(var i in t)r(e+i+":"),n(t[i]);r(t instanceof Array?"%}]%n":"%}}%n")}var r=t();return n(e),r.buf}}),requireSimulator.setName("Parser"),"function"!=typeof define&&(define=require("requirejs").define),define(["disp"],function(){return Parser=function(){function t(t,e){var n;for(n in e)t[n]=e[n];return t}function e(t){this.parse=i.options.traceTap?function(e){console.log("tap: name="+this.name+"  pos="+(e?e.pos:"?"));var n=t.apply(this,[e]),r="NOIMG";return n.src&&n.src.str&&(r=n.src.str.substring(n.pos-3,n.pos)+"^"+n.src.str.substring(n.pos,n.pos+3)),n.src&&n.src.tokens&&(r=n.src.tokens[n.pos-1]+"["+n.src.tokens[n.pos]+"]"+n.src.tokens[n.pos+1]),console.log("/tap: name="+this.name+" pos="+(e?e.pos:"?")+"->"+(n?n.pos:"?")+" "+r+" res="+(n?n.success:"?")),n}:t}function n(t,e){if(null==t)throw e+" is null!";return t}function r(t,e){null!=t&&(this.src={maxPos:0,global:e},"string"==typeof t&&(this.src.str=t),t instanceof Array&&(this.src.tokens=t),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:e,StringParser:o,nc:n};i.dispTbl=function(t){var e="",n={};if(!t)return e;for(var r in t){var i=t[r].name;n[i]||(n[i]=""),n[i]+=r}for(var i in n)e+=n[i]+"->"+i+",";return e},e.create=function(t){return new e(t)},i.create=e.create,t(e.prototype,{except:function(t){var n=this;return this.ret(e.create(function(e){return t.apply({},e.result)&&(e.success=!1),e}).setName("(except "+n.name+")"))},noFollow:function(t){var r=this;return n(t,"p"),this.ret(e.create(function(e){var n=t.parse(e);return e.success=!n.success,e}).setName("("+r.name+" noFollow "+t.name+")"))},andNoUnify:function(t){n(t,"next");var r=this,i=e.create(function(e){var n=r.parse(e);if(!n.success)return n;var i=t.parse(n);return i.success&&(i.result=n.result.concat(i.result)),i});return i.setName("("+this.name+" "+t.name+")")},and:function(t){var n=this.andNoUnify(t);if(!this._first)return n;var r=this._first.tbl,o={};for(var s in r)o[s]=r[s].andNoUnify(t);return n=e.fromFirst(this._first.space,o),n.setName("("+this.name+" >> "+t.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+n.name+" tbl="+i.dispTbl(o)),n},retNoUnify:function(t){var n,r=this;n="function"==typeof t?e.create(function(e){var n=e.clone();return n.result=[t.apply({},e.result)],n}).setName("retfunc"):t;var i=e.create(function(t){var e=r.parse(t);return e.success?n.parse(e):e}).setName("("+this.name+" >= "+n.name+")");return i},ret:function(t){if(!this._first)return this.retNoUnify(t);var n=this._first.tbl,r={};for(var o in n)r[o]=n[o].retNoUnify(t);return res=e.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+t.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(t,n){if(!i.options.optimizeFirst)return this;if(null==t)throw"Space is null2!";if("string"==typeof n){for(var r={},o=0;o<n.length;o++)r[n.substring(o,o+1)]=this;return e.fromFirst(t,r).setName("(fst "+this.name+")")}if(null==n)return e.fromFirst(t,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof n)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(t){if(!i.options.optimizeFirst)return this;"string"==typeof t&&(t=[t]);var n={};if(t){var r=this;t.forEach(function(t){n[t]=r})}else n.ALL=this;return e.fromFirstTokens(n).setName("(fstT "+this.name+")")},unifyFirst:function(n){function r(t,e){return t?e?t.orNoUnify(e).checkTbl():t:e}function o(){var t=n._first.tbl,e={};for(var i in s)e[i]=1;for(var i in t)e[i]=1;delete e.ALL,(s.ALL||t.ALL)&&(s.ALL=r(s.ALL,t.ALL));for(var i in e)s[i]&&t[i]?s[i]=r(s[i],t[i]):s[i]&&!t[i]?s[i]=r(s[i],t.ALL):!s[i]&&t[i]&&(s[i]=r(s.ALL,t[i]))}var s={};this.checkTbl(),n.checkTbl(),t(s,this._first.tbl),o();var a=e.fromFirst(this._first.space,s).setName("("+this.name+")U("+n.name+")");return i.options.verboseFirst&&console.log("Created unify name="+a.name+" tbl="+i.dispTbl(s)),a},or:function(t){return n(t,"other"),this._first&&t._first&&this._first.space&&this._first.space===t._first.space?this.unifyFirst(t):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+t.name+" "+this._first+" - "+t._first),this.orNoUnify(t))},orNoUnify:function(t){var n=this,r=e.create(function(e){var r=n.parse(e);if(r.success)return r;var i=t.parse(e);return i});return r.name="("+this.name+")|("+t.name+")",r},setName:function(t){return this.name=t,this._first,this},profile:function(t){return i.options.profile&&(this.parse=this.parse.profile(t||this.name)),this},repN:function(t){var n=this;t||(t=0);var r=e.create(function(e){for(var r=e,i=[];;){var o=n.parse(r);if(!o.success){var s;return i.length>=t?(s=r.clone(),s.result=[i],s.success=!0,s):(s=e.clone(),s.success=!1,s)}i.push(o.result[0]),r=o}});return r.setName("("+n.name+" * "+t+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var t=this;return e.create(function(e){var n=t.parse(e);return n.success?n:(e=e.clone(),e.success=!0,e.result=[null],e)}).setName("("+t.name+")?")},sep1:function(t,e){var r=this;n(r,"value"),n(t,"sep");var i=t.and(r).ret(function(t,n){return e?n:{sep:t,value:n}});return r.and(i.rep0()).ret(function(t,n){var r;if(e){var i=[t];for(r in n)i.push(n[r]);return i}return{head:t,tails:n}}).setName("(sep1 "+r.name+"~~"+t.name+")")},sep0:function(t){return this.sep1(t,!0).opt().ret(function(t){return t?t:[]})},tap:function(t){return this},retN:function(t){return this.ret(function(){return arguments[t]})},parseStr:function(t,e){var n=new r(t,e);return this.parse(n)},checkTbl:function(){if(!this._first)return this;var t=this._first.tbl;for(var e in t)if(!t[e].parse)throw this.name+": tbl."+e+" is not a parser :"+t[e];return this}}),t(r.prototype,{clone:function(){var t=new r;return t.src=this.src,t.pos=this.pos,t.result=this.result.slice(),t.success=this.success,t},updateMaxPos:function(t){t>this.src.maxPos&&(this.src.maxPos=t)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),e.fromFirst=function(t,n){if("TOKEN"==t)return e.fromFirstTokens(n);var r=e.create(function(e){var r=t.parse(e),o=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+o+" tbl="+(n[o]?n[o].name:"-")),n[o]?n[o].parse(r):n.ALL?n.ALL.parse(r):(r.success=!1,r)});return r._first={space:t,tbl:n},r.checkTbl(),r},e.fromFirstTokens=function(t){var n=e.create(function(e){var n=e.src.tokens[e.pos],r=n?n.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(t[r]?t[r].name:"-")),null!=r&&t[r]?t[r].parse(e):t.ALL?t.ALL.parse(e):(e.success=!1,e)});return n._first={space:"TOKEN",tbl:t},n.checkTbl(),n};var o={empty:e.create(function(t){var e=t.clone();return e.success=!0,e.result=[null],e}).setName("E"),fail:e.create(function(t){return t.success=!1,t}).setName("F"),str:function(t){return this.strLike(function(e,n){return e.substring(n,n+t.length)===t?{len:t.length}:null}).setName(t)},reg:function(t){return(t+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(t+"")),this.strLike(function(e,n){var r=t.exec(e.substring(n));return r?(r.len=r[0].length,r):null}).setName(t+"")},strLike:function(n){return e.create(function(e){var r=e.src.str;if(null==r)throw"strLike: str is null!";var o=e.pos,s=n(r,o,e);if(i.options.traceToken&&console.log("pos="+o+" r="+s),s){i.options.traceToken&&console.log("str:succ"),s.pos=o,s.src=e.src;var a=e.clone();return t(a,{pos:o+s.len,success:!0,result:[s]}),e.updateMaxPos(a.pos),a}return i.options.traceToken&&console.log("str:fail"),e.success=!1,e}).setName("STRLIKE")},parse:function(t,e,n){var i=new r(e,n);return t.parse(i)}};o.eof=o.strLike(function(t,e){return e==t.length?{len:0}:null}).setName("EOF"),i.StringParser=o;var s={token:function(t){return e.create(function(e){var n=e.src.tokens[e.pos];return e.success=!1,n?(n.type==t&&(e=e.clone(),e.updateMaxPos(e.pos),e.pos++,e.success=!0,e.result=[n]),e):e}).setName(t).firstTokens(t)},parse:function(t,e,n){var i=new r(e,n);return t.parse(i)},eof:e.create(function(t){var e=t.pos>=t.src.tokens.length;return t.success=e,e&&(t=t.clone(),t.result=[{type:"EOF"}]),t}).setName("EOT")};return i.TokensParser=s,i.lazy=function(t){var n=null;return e.create(function(e){if(n||(n=t()),!n)throw t+" returned null!";return this.name=t.name,n.parse(e)}).setName("LZ")},i.addRange=function(t,e){if(null==e)return t;if("number"!=typeof t.pos)return t.pos=e.pos,t.len=e.len,t;var n=e.pos+e.len,r=t.pos+t.len;return e.pos<t.pos&&(t.pos=e.pos),n>r&&(t.len=n-t.pos),t},i.setRange=function(t){if(null!=t&&"string"!=typeof t&&"number"!=typeof t&&"boolean"!=typeof t){var e=i.getRange(t);if(null!=e)return t;for(var n in t)if(t.hasOwnProperty(n)){var r=i.setRange(t[n]);i.addRange(t,r)}return t}},i.getRange=function(t){return null==t?null:"number"!=typeof t.pos?null:"number"==typeof t.len?t:null},i}()}),requireSimulator.setName("Grammar"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(t){return Grammar=function(){function e(t){return"string"==typeof t?r.get(t):t}var n=t,r=null;return r=function(n){var i={};return i.ands=function(){for(var i=e(arguments[0]),o=1;o<arguments.length;o++)i=i.and(e(arguments[o]));i=i.tap(n),r.defs[n]=i;var s={};return s.autoNode=function(){var e=i.ret(function(){for(var e={type:n},r=0;r<arguments.length;r++){var i=arguments[r],o=t.setRange(i);t.addRange(e,o),e["-element"+r]=i}e.toString=function(){return"("+this.type+")"}}).setName(n);return r.defs[n]=e},s.ret=function(e){if(0==arguments.length)return i;if("function"==typeof e)return r.defs[n]=i.ret(e);for(var o=[],s=function(t){return t},a=0;a<arguments.length;a++){if("function"==typeof arguments[a]){s=arguments[a];break}o[a]=arguments[a]}var u=i.ret(function(){var e={type:n};e[Grammar.SUBELEMENTS]=[];for(var r=0;r<arguments.length;r++){var i=arguments[r],a=t.setRange(i);t.addRange(e,a),o[r]&&(e[o[r]]=i),e[Grammar.SUBELEMENTS].push(i)}return e.toString=function(){return"("+this.type+")"},s(e)}).setName(n);return r.defs[n]=u},s},i.ors=function(){for(var t=e(arguments[0]),i=1;i<arguments.length;i++)t=t.or(e(arguments[i]));return r.defs[n]=t.setName(n)},i},r.defs={},r.get=function(t){return r.defs[t]?r.defs[t]:n.lazy(function(){var e=r.defs[t];if(!e)throw"grammar named '"+t+"' is undefined";return e}).setName("(Lazy of "+t+")")},r},Grammar.SUBELEMENTS="[SUBELEMENTS]",Grammar}),requireSimulator.setName("XMLBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(t){return XMLBuffer=function(e){var n;return n=function(r,i){if(null!=r&&"string"!=typeof r&&"number"!=typeof r){var o=t.getRange(r);if(o)for(;n.srcLen<o.pos;)n.src(e.substring(n.srcLen,o.pos));if(null!=r){if(i&&n.tag("<attr_"+i+">"),r.type&&n.tag("<"+r.type+">"),r.text)n.src(o.text);else{var s=n.orderByPos(r);s.forEach(function(t){t.name&&t.name.match(/^-/)?n(t.value):n(t.value,t.name)})}if(o)for(;n.srcLen<o.pos+o.len;)n.src(e.substring(n.srcLen,o.pos+o.len));r.type&&n.tag("</"+r.type+">"),i&&n.tag("</attr_"+i+">")}}},n.orderByPos=XMLBuffer.orderByPos,n.src=function(t){n.buf+=t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),n.srcLen+=t.length},n.tag=function(t){n.buf+=t},n.buf="",n.srcLen=0,n},XMLBuffer.orderByPos=function(t){var e=[];if(t[XMLBuffer.SUBELEMENTS])t[XMLBuffer.SUBELEMENTS].forEach(function(t){e.push(t)});else for(var n in t)t.hasOwnProperty(n)&&null!=t[n]&&"string"!=typeof t[n]&&"number"!=typeof t[n]&&"number"==typeof t[n].pos&&e.push(isNaN(parseInt(n))&&!(n+"").match(/-/)?{name:n,value:t[n]}:{value:t[n]});return e=e.sort(function(t,e){return t.value.pos-e.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",XMLBuffer}),requireSimulator.setName("TError"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return TError=function(t,e,n){if("string"==typeof e)return{isTError:!0,mesg:t,src:{name:function(){return e},text:function(){return e}},pos:n,toString:function(){return this.mesg+" at "+e+":"+this.pos},raise:function(){throw this}};var r=null;if(e&&e.src&&(r=e,e=r.src.tonyu),"function"!=typeof e.name)throw"src="+e+" should be file object";var i;if("function"==typeof e.text){var o=e.text();"string"==typeof o&&(i=TError.calcRowCol(o,n))}return{isTError:!0,mesg:t,src:e,pos:n,row:i.row,col:i.col,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.row+":"+this.col},raise:function(){throw this}}},TError.calcRowCol=function(t,e){var n,r,i=t.split("\n"),o=0;for(n=0;n<i.length;n++)if(o+=i[n].length+1,o>e){r=e-(o-i[n].length);break}return{row:n,col:r}},TError}),requireSimulator.setName("TT"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","disp","Parser","TError"],function(t,e,n,r,i){return TT=function(){function t(t,e){var n,i;"string"==typeof t?(n=a.str(t),t.length>0&&(i=t.substring(0,1)),e||(e=t)):(n=a.reg(t),e||(e=t+""));var o=l.and(n).ret(function(t,n){var i={};if(i.pos=n.pos,"number"!=typeof i.pos)throw"no pos for "+e+" "+r(n);if(i.len=n.len,i.text=n.src.str.substring(i.pos,i.pos+i.len),"string"!=typeof i.text)throw"no text("+i.text+") for "+e+" "+r(n);return i.toString=function(){return this.text},i});return i&&(o=o.first(l,i)),o.setName(e)}function e(e,n,r){"string"==typeof r&&(r=t(r)),p[e]=o(p[e],r.ret(function(t){return t.type=n,t}).setName(n))}function n(t,n,r,i){n==u&&(n=r);for(var o=1;t>=o;o*=2)0!=(t&o)&&e(t&o,n,r,i);h[n]=i}function o(t,e){return t?t.or(e):e}function s(t){var e=((new Date).getTime(),i.StringParser.parse(d,t));return e.success||console.log("Stopped at "+t.substring(e.src.maxPos-5,e.src.maxPos+5)),e}var a=i.StringParser,u="SAMENAME",f=1,c=2,l=a.reg(/^(\s*(\/\*([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),p={},h={},d=i.create(function(t){for(var e=c,n=[];;){if(t=p[e].parse(t),!t.success)break;var r=t.result[0];e=h[r.type],n.push(r)}return t=l.parse(t),t.success=t.src.maxPos==t.src.str.length,t.result[0]=n,t}),m={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,"for":!0,"else":!0,"super":!0,"while":!0,"break":!0,"do":!0,"switch":!0,"try":!0,"catch":!0,"finally":!0,"throw":!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,_thread:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},g=t(/^[0-9\.]+/).ret(function(t){return t.type="number",t.value=parseInt(t.text),t}).first(l,"0123456789"),v=t({exec:function(t){var e=t.substring(0,1);if('"'!==e&&"'"!==e)return!1;for(var n=1;n<t.length;n++){var r=t.substring(n,n+1);if(r===e)return[t.substring(0,n+1)];"\\"===r&&n++}return!1},toString:function(){return"literal"}}).first(l,"\"'"),y=t({exec:function(t){if("/"!==t.substring(0,1))return!1;for(var e=1;e<t.length;e++){var n=t.substring(e,e+1);if("/"===n){var r=/^[ig]*/.exec(t.substring(e+1));return[t.substring(0,e+1+r[0].length)]}if("\n"==n)return!1;"\\"===n&&e++}return!1},toString:function(){return"regex"}}).first(l,"/");n(c|f,"number",g,f),n(c,"regex",y,f),n(c|f,"literal",v,f),n(c|f,u,"++",f),n(c|f,u,"--",f),n(c|f,u,"!==",c),n(c|f,u,"===",c),n(c|f,u,"+=",c),n(c|f,u,"-=",c),n(c|f,u,"*=",c),n(c|f,u,"/=",c),n(c|f,u,"%=",c),n(c|f,u,">=",c),n(c|f,u,"<=",c),n(c|f,u,"!=",c),n(c|f,u,"==",c),n(c|f,u,">>",c),n(c|f,u,"<<",c),n(c|f,u,"&&",c),n(c|f,u,"||",c),n(c|f,u,"(",c),n(c|f,u,")",f),n(c|f,u,"[",c),n(c|f,u,"]",f),n(c|f,u,"{",c),n(c|f,u,"}",f),n(c|f,u,">",c),n(c|f,u,"<",c),n(c|f,u,"+",c),n(c|f,u,"-",c),n(c|f,u,".",c),n(c|f,u,"?",c),n(c|f,u,"=",c),n(c|f,u,"*",c),n(c|f,u,"%",c),n(f,u,"/",c),n(f|c,u,"^",c),n(f|c,u,"~",c),n(f|c,u,"\\",c),n(f|c,u,":",c),n(f|c,u,";",c),n(f|c,u,",",c),n(c|f,u,"!",c),n(c|f,u,"&",c),n(c|f,u,"|",c);var b=t(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(t){return t.type="constructor"==t.text?"tk_constructor":m.hasOwnProperty(t.text)?t.text:"symbol",t}).first(l);for(var x in m)h[x]=c;return h.tk_constructor=c,h.symbol=f,p[c]=o(p[c],b),p[f]=o(p[f],b),{parse:s,extension:"js"}}()}),requireSimulator.setName("ExpressionParser"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(t){return ExpressionParser=function(){function e(t,e){var n={};return n.eq=function(n){return t==n.type()&&e==n.prio()},n.type=function(e){return e?e==t:t},n.prio=function(){return e},n.toString=function(){return"["+t+":"+e+"]"},n}function n(t){var e={},n=t;return e.add=function(t){n=n?n.or(t):t},e.get=function(){return n},e}function r(){var r=n(),i={};return i.reg=function(n,i,o){var s=e(n,i);r.add(o.ret(t.create(function(t){return t.opType=s,t})).setName("(opType "+s+" "+o.name+")"))},i.get=function(){return r.get()},i.parse=function(t){return i.get().parse(t)},i}function i(t,e){return}function o(t,e){var n,r=e;if(i(e," start minprio= "+t),e=a.parse(e),i(e," prefixorelem "+t),!e.isSuccess())return e;if(n=e.opType,n.type("prefix")){if(pre=e.result[0],e=o(n.prio(),e),!e.isSuccess())return e;var f=s.mkPrefix.def(pre,e.result[0]);if(r=e.clone(),r.result=[f],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(r=e.clone(),e=u.parse(e),!e.isSuccess())return r;for(;;){if(i(e,"st:pi"),i(r,"res:ex"),n=e.opType,n.prio()<t)return r.nextPostfixOrInfix=e,r;if(n.type("postfix")){var f=s.mkPostfix.def(r.result[0],e.result[0]);if(r=e.clone(),r.result=[f],i(e,"185"),e=u.parse(e),!e.isSuccess())return r}else if(n.type("infixl")){var l=e.result[0];if(e=o(n.prio()+1,e),!e.isSuccess())return r;var f=s.mkInfixl.def(r.result[0],l,e.result[0]);if(r=e.clone(),r.result=[f],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(n.type("infixr")){var l=e.result[0];if(e=o(n.prio(),e),!e.isSuccess())return r;var f=s.mkInfixr.def(r.result[0],l,e.result[0]);if(r=e.clone(),r.result=[f],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else if(n.type("trifixr")){var p=r.result[0],h=e.result[0];if(e=o(n.prio()+1,e),!e.isSuccess())return r;var d=e.result[0],e=c[n.prio()].parse(e);if(!e.isSuccess())return r;var m=e.result[0];if(e=o(n.prio(),e),!e.isSuccess())return r;var g=e.result[0],f=s.mkTrifixr.def(p,h,d,m,g);if(r=e.clone(),r.result=[f],!e.nextPostfixOrInfix)return r;e=e.nextPostfixOrInfix}else{var l=e.result[0];if(e=o(n.prio()+1,e),!e.isSuccess())return r;var f=s.mkInfix.def(r.result[0],l,e.result[0]);if(r=e.clone(),r.result=[f],!e.nextPostfixOrInfix)return r;if(e=e.nextPostfixOrInfix,n.prio()==e.opType.prio())return r.success=!1,r}}}var s={},a=r(),u=r(),f=n(),c=[];return s.element=function(t){a.reg("element",-1,t),f.add(t)},s.getElement=function(){return f.get()},s.prefix=function(t,e){a.reg("prefix",t,e)},s.postfix=function(t,e){u.reg("postfix",t,e)},s.infixl=function(t,e){u.reg("infixl",t,e)},s.infixr=function(t,e){u.reg("infixr",t,e)},s.infix=function(t,e){u.reg("infix",t,e)},s.trifixr=function(t,e,n){u.reg("trifixr",t,e),c[t]=n},s.custom=function(){},s.mkInfix=function(t){s.mkInfix.def=t},s.mkInfix.def=function(e,n,r){return t.setRange({type:"infix",op:n,left:e,right:r})},s.mkInfixl=function(t){s.mkInfixl.def=t},s.mkInfixl.def=function(e,n,r){return t.setRange({type:"infixl",op:n,left:e,right:r})},s.mkInfixr=function(t){s.mkInfixr.def=t},s.mkInfixr.def=function(e,n,r){return t.setRange({type:"infixr",op:n,left:e,right:r})},s.mkPrefix=function(t){s.mkPrefix.def=t},s.mkPrefix.def=function(e,n){return t.setRange({type:"prefix",op:e,right:n})},s.mkPostfix=function(t){s.mkPostfix.def=t},s.mkPostfix.def=function(e,n){return t.setRange({type:"postfix",left:e,op:n})},s.mkTrifixr=function(t){s.mkTrifixr.def=t},s.mkTrifixr.def=function(e,n,r,i,o){return t.setRange({type:"trifixr",left:e,op1:n,mid:r,op2:i,right:o})},s.build=function(){return s.built=t.create(function(t){return o(0,t)}).setName("ExpBuilt"),s.built},s.lazy=function(){return t.create(function(t){return s.built.parse(t)})},s}}),requireSimulator.setName("TonyuLang"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","TT","disp","Parser","ExpressionParser","TError"],function(t,e,n,r,i,o,s,a){return TonyuLang=function(){function n(t){return function(){return arguments[t]}}function u(t,e){var n=[];if(t&&!t.args)throw i(t);if(t){var r=o.getRange(t);o.addRange(n,r),t.args.forEach(function(t){n.push(t)})}return e.forEach(function(t){var e=o.getRange(t);o.addRange(n,e),n.push(t.obj)}),n}function f(t,e,n){var r={type:"infix",left:t,op:e,right:n};return o.setRange(r),r.toString=function(){return"("+t+e+n+")"},r}var c=o,l={},p=t(),h=p.get,d=(c.StringParser,c.TokensParser.token),m=d("number").ret(function(t){if(t.type="number","string"!=typeof t.text)throw"No text for "+i(t);if(t.value=parseFloat(t.text),isNaN(t.value))throw"No value for "+i(t);return t}),g=d("symbol"),v=d("==="),y=d("!=="),b=d("=="),x=d("!="),T=d(">="),S=d("<="),w=d(">"),E=d("<"),M=d("&&"),L=d("||"),A=d("-"),P=d("+"),N=d("*"),D=d("/"),k=d("%"),C=d("="),B=d("literal"),j=d("regex"),F=s(),I=p("arrayElem").ands(d("["),F.lazy(),d("]")).ret(null,"subscript"),R=p("argList").ands(d("("),F.lazy().sep0(d(","),!0),d(")")).ret(null,"args"),_=p("member").ands(d("."),g).ret(null,"name"),O=p("parenExpr").ands(d("("),F.lazy(),d(")")).ret(null,"expr"),q=p("varAccess").ands(g).ret("name"),U=h("funcExpr").firstTokens(["function","\\"]),G=p("funcExprArg").ands(U).ret("obj"),W=h("objlit").firstTokens("{"),$=p("objlitArg").ands(W).ret("obj"),z=$.or(G),V=R.and(z.rep0()).ret(function(t,e){return u(t,e)
}).or(z.rep1().ret(function(t){return u(null,t)})),K=(R.or($),p("call").ands(V).ret("args")),H=p("scall").ands(V).ret("args"),J=p("newExpr").ands(d("new"),q,K.opt()).ret(null,"klass","params"),X=p("superExpr").ands(d("super"),d(".").and(g).ret(n(1)).opt(),H).ret(null,"name","params"),Z=d("true").or(d("false")).or(d("null")).or(d("undefined")).or(d("_thread")).or(d("this")).or(d("arguments")).ret(function(t){return t.type="reservedConst",t});F.element(m),F.element(Z),F.element(j),F.element(B),F.element(O),F.element(J),F.element(X),F.element(U),F.element(W),F.element(h("arylit").firstTokens("[")),F.element(q);var Y=0;F.infixr(Y,C),F.infixr(Y,d("+=")),F.infixr(Y,d("-=")),F.infixr(Y,d("*=")),F.infixr(Y,d("/=")),F.infixr(Y,d("%=")),F.infixr(Y,d("|=")),F.infixr(Y,d("&=")),Y++,F.trifixr(Y,d("?"),d(":")),Y++,F.infixl(Y,L),Y++,F.infixl(Y,M),Y++,F.infix(Y,d("instanceof")),F.infix(Y,d("is")),F.infix(Y,v),F.infix(Y,y),F.infix(Y,b),F.infix(Y,x),F.infix(Y,T),F.infix(Y,S),F.infix(Y,w),F.infix(Y,E),Y++,F.postfix(Y+3,d("++")),F.postfix(Y+3,d("--")),F.infixl(Y,A),F.infixl(Y,P),Y++,F.infixl(Y,N),F.infixl(Y,D),F.infixl(Y,k),Y++,F.prefix(Y,d("typeof")),F.prefix(Y,d("delete")),F.prefix(Y,d("++")),F.prefix(Y,d("--")),F.prefix(Y,d("+")),F.prefix(Y,d("-")),F.prefix(Y,d("!")),Y++,Y++,F.postfix(Y,K),F.postfix(Y,_),F.postfix(Y,I),F.mkInfixl(f),F.mkInfixr(f);{var Q=F.build().setName("expr").profile(),n=function(t){return function(){return arguments[t]}},te=h("stmt").firstTokens();p("exprstmt").ands(Q,d(";")).ret("expr")}p("compound").ands(d("{"),te.rep0(),d("}")).ret(null,"stmts");var ee=d("else").and(te).ret(n(1)),ne=(p("return").ands(d("return"),Q.opt(),d(";")).ret(null,"value"),p("if").ands(d("if"),d("("),Q,d(")"),te,ee.opt()).ret(null,null,"cond",null,"then","_else"),p("forin").ands(d("var").opt(),g.sep1(d(","),!0),d("in"),Q).ret("isVar","vars",null,"set")),re=p("normalFor").ands(te,Q.opt(),d(";"),Q.opt()).ret("init","cond",null,"next"),ie=re.or(ne),oe=(p("for").ands(d("for"),d("("),ie,d(")"),"stmt").ret(null,null,"inFor",null,"loop"),p("while").ands(d("while"),d("("),Q,d(")"),"stmt").ret(null,null,"cond",null,"loop"),p("break").ands(d("break"),d(";")).ret("brk"),p("finally").ands(d("finally"),"stmt").ret(null,"stmt"),p("catch").ands(d("catch"),d("("),g,d(")"),"stmt").ret(null,null,"name",null,"stmt"),p("catches").ors("catch","finally")),se=(p("try").ands(d("try"),"stmt",oe.rep1()).ret(null,"stmt","catches"),p("throw").ands(d("throw"),Q,d(";")).ret(null,"ex"),g),ae=p("typeDecl").ands(d(":"),se).ret(null,"vtype"),ue=p("varDecl").ands(g,ae.opt(),d("=").and(Q).ret(n(1)).opt()).ret("name","vtype","value"),fe=(p("varsDecl").ands(d("var"),ue.sep1(d(","),!0),d(";")).ret(null,"decls"),p("paramDecl").ands(g,ae.opt()).ret("name","vtype")),ce=p("paramDecls").ands(d("("),fe.sep0(d(","),!0),d(")")).ret(null,"params"),le=p("setterDecl").ands(d("="),fe).ret(null,"value");p("funcDeclHead").ands(d("nowait").opt(),d("function").or(d("fiber")).or(d("tk_constructor")).or(d("\\")).opt(),g.or(d("new")),le.opt(),ce.opt(),ae.opt()).ret("nowait","ftype","name","setter","params","rtype");p("funcDecl").ands("funcDeclHead","compound").ret("head","body"),p("nativeDecl").ands(d("native"),g,d(";")).ret(null,"name"),p("ifWait").ands(d("ifwait"),"stmt",ee.opt()).ret(null,"then","_else");te=p("stmt").ors("return","if","for","while","break","ifWait","try","throw","nativeDecl","funcDecl","compound","exprstmt","varsDecl"),p("funcExprHead").ands(d("function").or(d("\\")),g.opt(),ce.opt()).ret(null,"name","params");var pe=(p("funcExpr").ands("funcExprHead","compound").ret("head","body"),p("jsonElem").ands(g.or(B),d(":").and(Q).ret(function(t,e){return e}).opt()).ret("key","value")),he=(p("objlit").ands(d("{"),pe.sep0(d(","),!0),d("}")).ret(null,"elems"),p("arylit").ands(d("["),Q.sep0(d(","),!0),d("]")).ret(null,"elems"),p("extends").ands(d("extends"),g.or(d("null")),d(";")).ret(null,"superclassName")),de=p("includes").ands(d("includes"),g.sep1(d(","),!0),d(";")).ret(null,"includeClassNames"),me=p("program").ands(he.opt(),de.opt(),te.rep0(),o.TokensParser.eof).ret("ext","incl","stmts");for(var ge in p.defs)p.defs[ge].profile();return l.parse=function(t){str="string"==typeof t?t:t.text(),str+="\n";var e=r.parse(str);if(!e.isSuccess())throw a("文法エラー(Token)",t,e.src.maxPos);var n=e.result[0],i=c.TokensParser.parse(me,n);if(i.isSuccess()){var o=i.result[0];return o}var s=n[i.src.maxPos],u=s?s.pos+s.len:str.length;throw a("文法エラー",t,u)},l.genXML=function(t,n){var r=e(t);return r(n),r.buf},l.extension="tonyu",l}()}),requireSimulator.setName("ObjectMatcher"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return ObjectMatcher=function(){function t(t,e){var n={};return n[i]=t,e&&(n[o]=e),n}function e(t){return t&&t[i]}function n(t,e,r){if(t===e)return!0;if(null==t)return!1;if("string"==typeof t&&e instanceof RegExp)return t.match(e);if("function"==typeof e)return e(t,r);if("object"==typeof e){for(var s in e)if(s!=i){var a=s==o?t:t[s],u=e[s];if(!n(a,u,r))return!1}return e[i]&&(r[e[i]]=t),!0}return!1}var r={},i="$var",o="$this";r.v=t,r.isVar=e;for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=0;a<s.length;a++){var u=s.substring(a,a+1);r[u]=t(u)}return r.match=function(t,e){var r={};return n(t,e,r)?r:null},r}()}),requireSimulator.setName("context"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return context=function(){function t(t,n){var r={};for(var i in t)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=e[i],e[i]=e.ovrFunc(e[i],t[i])):(r[i]=e[i],e[i]=t[i]);n(e);for(var i in r)e[i]=r[i]}var e={};return e.ovrFunc=function(t,e){return e.parent=t,e},e.enter=t,e}}),requireSimulator.setName("Visitor"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Visitor=function(t){var e={funcs:t,path:[]};return e.visit=function(n){try{e.path.push(n),e.debug&&console.log("visit ",n.type,n.pos);var r=n?t[n.type]:null;if(r)return r.call(e,n);if(e.def)return e.def.call(e,n)}finally{e.path.pop()}},e.replace=function(t){return e.def||(e.def=function(t){if("object"==typeof t)for(var n in t)t[n]&&"object"==typeof t[n]&&(t[n]=e.visit(t[n]));return t}),e.visit(t)},e}}),requireSimulator.setName("Tonyu.Compiler"),define(["Tonyu","ObjectMatcher","TError"],function(t){function e(t,e){var n={type:t};if(e)for(var r in e)n[r]=e[r];return n.name||(n.name=o("_"+t+"_")),n}function n(t){return t?t.type:null}function r(t){var e=function(){};return e.prototype=t,new e}function i(t,e){if(!t)throw e+" is null";return t}function o(t){return t+(h++ +"").replace(/\./g,"")}function s(t,e,n){e._id||(t._idseq||(t._idseq=0),e._id=++t._idseq);var r=t[e._id];if(r||(r=t[e._id]={node:e}),n)for(var i in n)r[i]=n[i];return r}function a(t,e){return t.substring(e.pos,e.pos+e.len)}function u(t,e){var n=null;return f(t).forEach(function(t){n||(n=t.decls.methods[e])}),n}function f(t){function e(t){n[t.fullName]||(n[t.fullName]=!0,r.push(t),t.superclass&&e(t.superclass),t.includes&&t.includes.forEach(e))}var n={},r=[];return e(t),r}function c(t){var e=[];if(!t.head)return e;t.head.setter&&e.push(t.head.setter.value);var n=t.head.params?t.head.params.params:null;if(n&&!n.forEach)throw t+" is not array ";return n&&(e=e.concat(n)),e}var l={};t.Compiler=l;var p={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PARAM:"param",GLOBAL:"global",CLASS:"class"};l.ScopeTypes=p;var h=1;return l.newScopeType=e,l.getScopeType=n,l.newScope=r,l.nullCheck=i,l.genSym=o,l.annotation=s,l.getSource=a,l.getMethod=u,l.getDependingClasses=f,l.getParams=c,l}),requireSimulator.setName("Tonyu.Compiler.JSGenerator"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(t,e,n,r,i,o,s,a,u){return u.JSGenerator=function(){function t(t,P){function N(t){return u.getSource(H,t)}function D(e,n){return A(t.annotation,e,n)}function k(t){return"string"==typeof t?x+(P.aliases[t]||t):t.builtin?t.fullName:x+t.fullName}function C(t){var e=[];return t.forEach(function(t){e.push(k(t))}),e}function B(t,e){return function(){Z.enter(t,function(){v.visit(e)})}}function j(t,r,i){var o=L(r);if(o==re.THVAR)J.printf("%s",e);else if(o==re.FIELD)J.printf("%s.%s",n,t);else if(o==re.METHOD)i&&i.noBind?J.printf("%s.%s",n,t):J.printf("%s(%s,%s.%s)",m,n,n,t);else if(o==re.CLASS)J.printf("%s",k(t));else if(o==re.GLOBAL)J.printf("%s%s",T,t);else{if(o!=re.PARAM&&o!=re.LOCAL&&o!=re.NATIVE)throw console.log("Unknown scope type: ",o),new Error("Unknown scope type: "+o);J.printf("%s",t)}return r}function F(t){return function(){I.apply(this,[t])}}function I(t){"compound"==t.type?Z.enter({noWait:!0},function(){J.printf("%j%n",["%n",t.stmts])}):v.visit(t)}function R(e){return function(){J.printf("%s%s=%s;//%s%n",P.options.compiler.commentLastPos?"//":"",p,te.add(t,e.pos),t.fullName+":"+e.pos)}}function _(){Z.enter({},function(){X("Tonyu.klass.define({%{"),X("fullName: %l,%n",t.fullName),X("shortName: %l,%n",t.shortName),X("namespace: %l,%n",t.namespace),t.superclass&&X("superclass: %s,%n",k(t.superclass)),X("includes: [%s],%n",C(t.includes).join(",")),X("methods: {%{");for(var e in ne){Y&&console.log("method1",e);var n=ne[e];Z.enter({noWait:!0,threadAvail:!1},function(){U(n)}),Y&&console.log("method2",e),n.nowait||Z.enter({noWait:!1,threadAvail:!0},function(){q(n)}),Y&&console.log("method3",e)}X("__dummy: false%n"),X("%}},%n"),X("decls: %s%n",JSON.stringify(O(t))),X("%}});")})}function O(t){var e={methods:{}};for(var n in t.decls.methods)e.methods[n]={nowait:!!t.decls.methods[n].nowait};return e}function q(t){function r(){Z.enter({method:t,noWait:!0,threadAvail:!0},function(){s.forEach(function(t){X("%v%n",t)})})}function i(){Z.enter({method:t,finfo:t,pc:1},function(){a.forEach(function(t){X("%v%n",t)})})}if(!V(t)){var o=t.stmts,s=[],a=[],u=s,p=!0;p?o.forEach(function(t){D(t).fiberCallRequired&&(u=a),u.push(t)}):a=o,X("%s%s :function %s(%j) {%{"+w+"var %s=%s;%n%svar %s=%s;%nvar %s=0;%n%f%n%f%n",c,t.name,W(t.pos,"f_"+t.name),[",",[se].concat(t.params)],n,S,t.useArgs?"":"//",f,"Tonyu.A(arguments)",l,z(t),r),a.length>0?X("%s.enter(function %s(%s) {%{if (%s.lastEx) %s=%s.catchPC;%nfor(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}});%n",e,W(t.pos,"ent_"+t.name),e,e,l,e,h,d,h,l,i,e,n):X("%s.retVal=%s;return;%n",e,n),X("%}},%n")}}function U(t){function e(){Z.enter({method:t,finfo:t},function(){t.stmts.forEach(function(t){X("%v%n",t)})})}var r=V(t)?"initialize":t.name;X("%s :function %s(%j) {%{"+w+"var %s=%s;%n%f%n%f%}},%n",r,W(t.pos,r),[",",t.params],n,S,z(t),e)}function G(t){function e(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){t.body.stmts.forEach(function(t){X("%v%n",t)})})}var n=D(t);J.printf("(function %s(%j) {%{%f%n%f%}})",n.name,[",",n.params],z(n),e)}function W(e,n){return n||(n=ie++ +""),"_trc_"+t.shortName+"_"+n}function $(t){function e(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){t.body.stmts.forEach(function(t){X("%v%n",t)})})}var n=D(t);J.printf("function %s(%j) {%{%f%n%f%}}",n.name,[",",n.params],z(n),e)}function z(t){function e(){Z.enter({},function(){for(var e in t.locals.varDecls)J.printf("var %s;%n",e);for(var e in t.locals.subFuncDecls)$(t.locals.subFuncDecls[e])})}return e}function V(t){return Q.match(t,{ftype:"constructor"})||Q.match(t,{name:"new"})}var K=t.src.tonyu,H=K.text(),J=o(),X=J.printf,Z=s(),Y=!1,Q=r,te=P.traceTbl,ee=t.decls,ne=(ee.fields,ee.methods),re=(ee.natives,M),ie=0,oe=P.options.compiler.diagnose,se={type:"THNode"};v=J.visitor=a({THNode:function(){J.printf(e)},dummy:function(t){J.printf("",t)},literal:function(t){J.printf("%s",t.text)},paramDecl:function(t){J.printf("%v",t.name)},paramDecls:function(t){J.printf("(%j)",[", ",t.params])},funcDeclHead:function(t){J.printf("function %v %v",t.name,t.params)},funcDecl:function(){},"return":function(t){if(Z.inTry)throw i("現実装では、tryの中にreturnは書けません",K,t.pos);Z.noWait?Z.threadAvail?t.value?J.printf("%s.retVal=%v;return;%n",e,t.value):J.printf("%s.retVal=%s;return;%n",e,n):t.value?J.printf("return %v;",t.value):J.printf("return %s;",n):t.value?J.printf("%s.exit(%v);return;",e,t.value):J.printf("%s.exit(%s);return;",e,n)},program:function(t){genClass(t.stmts)},number:function(t){J.printf("%s",t.value)},reservedConst:function(t){"this"==t.text?J.printf("%s",n):"arguments"==t.text&&Z.threadAvail?J.printf("%s",f):t.text==e?J.printf("%s",Z.threadAvail?e:"null"):J.printf("%s",t.text)},varDecl:function(t){t.value?J.printf("%v = %v",t.name,t.value):J.printf("%v",t.name)},varsDecl:function(t){R(t)(),J.printf("%j;",[";",t.decls])},jsonElem:function(t){t.value?J.printf("%v: %v",t.key,t.value):J.printf("%v: %f",t.key,function(){j(t.key.text,D(t).scopeInfo,D(t))})},objlit:function(t){J.printf("{%j}",[",",t.elems])},arylit:function(t){J.printf("[%j]",[",",t.elems])},funcExpr:function(t){G(t)},parenExpr:function(t){J.printf("(%v)",t.expr)},varAccess:function(t){{var e=t.name.text;j(e,D(t).scopeInfo,D(t))}},exprstmt:function(r){var i={};if(R(r)(),Z.noWait||(i=D(r).fiberCall||{}),"noRet"==i.type)J.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{",n,c,i.N,[", ",[se].concat(i.A)],l,Z.pc,Z.pc++);else if("ret"==i.type)J.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",n,c,i.N,[", ",[se].concat(i.A)],l,Z.pc,Z.pc++,i.L,i.O,e);else if("noRetSuper"==i.type){var o=k(t.superclass);J.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{",o,c,i.S.name.text,n,[", ",[se].concat(i.A)],l,Z.pc,Z.pc++)}else"retSuper"==i.type?J.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",o,c,i.S.name.text,n,[", ",[se].concat(i.A)],l,Z.pc,Z.pc++,i.L,i.O,e):J.printf("%v;",r.expr)},infix:function(t){var e=t.op.text;if(oe){if("+"==e||"-"==e||"*"==e||"/"==e||"%"==e)return void J.printf("%s(%v,%l)%v%s(%v,%l)",b,t.left,N(t.left),t.op,b,t.right,N(t.right));if("+="==e||"-="==e||"*="==e||"/="==e||"%="==e)return void J.printf("%v%v%s(%v,%l)",t.left,t.op,b,t.right,N(t.right))}J.printf("%v%v%v",t.left,t.op,t.right)},trifixr:function(t){J.printf("%v%v%v%v%v",t.left,t.op1,t.mid,t.op2,t.right)},prefix:function(t){J.printf("%v %v",t.op,t.right)},postfix:function(t){var e=D(t);if(oe){if(e.myMethodCall){var r=e.myMethodCall,i=r.scopeInfo,o=L(i);return void(o==re.FIELD||o==re.METHOD?J.printf("%s(%s, %l, [%j], %l )",g,n,r.name,[",",r.args],"this"):J.printf("%s(%v, [%j], %l)",y,t.left,[",",r.args],N(t.left)))}if(e.othersMethodCall){var s=e.othersMethodCall;return void J.printf("%s(%v, %l, [%j], %l )",g,s.target,s.name,[",",s.args],N(s.target))}if(e.memberAccess){var a=e.memberAccess;return void J.printf("%s(%v,%l).%s",b,a.target,N(a.target),a.name)}}else if(e.myMethodCall){var r=e.myMethodCall,i=r.scopeInfo,o=L(i);if(o==re.METHOD)return void J.printf("%s.%s(%j)",n,r.name,[",",r.args])}J.printf("%v%v",t.left,t.op)},"break":function(t){if(Z.noWait)J.printf("break;%n");else{if(Z.inTry&&Z.exitTryOnJump)throw i("現実装では、tryの中にbreak;は書けません",K,t.pos);if(!Z.closestBrk)throw i("break； は繰り返しの中で使います",K,t.pos);J.printf("%s=%z; break;%n",l,Z.closestBrk)}},"try":function(t){var n=D(t);if(!Z.noWait&&(n.fiberCallRequired||n.hasJump||n.hasReturn)){if(1!=t.catches.length||"catch"!=t.catches[0].type)throw i("現実装では、catch節1個のみをサポートしています",K,t.pos);var r=t.catches[0],o={},s={};J.printf("%s.enterTry(%z);%n",e,o),J.printf("%f",B({inTry:!0,exitTryOnJump:!0},t.stmt)),J.printf("%s.exitTry();%n",e),J.printf("%s=%z;break;%n",l,s),J.printf("%}case %f:%{",function(){J.print(o.put(Z.pc++))}),J.printf("%s=%s.startCatch();%n",r.name.text,e),J.printf("%s.exitTry();%n",e),J.printf("%v%n",r.stmt),J.printf("%}case %f:%{",function(){J.print(s.put(Z.pc++))})}else Z.enter({noWait:!0},function(){J.printf("try {%{%f%n%}} ",F(t.stmt)),t.catches.forEach(v.visit)})},"catch":function(t){J.printf("catch (%s) {%{%f%n%}}",t.name.text,F(t.stmt))},"throw":function(t){J.printf("throw %v;%n",t.ex)},"while":function(t){R(t)();var e=D(t);if(Z.noWait||!e.fiberCallRequired&&!e.hasReturn)Z.enter({noWait:!0},function(){J.printf("while (%v) {%{%f%n%}}",t.cond,F(t.loop))});else{var n=J.lazy(),r=Z.pc++,i="reservedConst"==t.cond.type&&"true"==t.cond.text;J.printf("%}case %d:%{"+(i?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",r,t.cond,l,n,B({closestBrk:n,exitTryOnJump:!1},t.loop),l,r,function(){J.print(n.put(Z.pc++))})}},"for":function(t){function e(t,e,n){return function(){n.forEach(function(e,n){J.printf("%s=%s[%s];%n",e.text,t,n)})}}R(t)();var n=D(t);if("forin"==t.inFor.type){var r=D(t.inFor).iterName;if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){J.printf("%s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%f%n%}}",r,E,t.inFor.set,t.inFor.vars.length,r,e(r,t.inFor.isVar,t.inFor.vars),F(t.loop))});else{var i=J.lazy(),o=Z.pc++;J.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",r,E,t.inFor.set,t.inFor.vars.length,o,r,l,i,e(r,t.inFor.isVar,t.inFor.vars),B({closestBrk:i,exitTryOnJump:!1},t.loop),l,o,function(t){t.print(i.put(Z.pc++))})}}else if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){J.printf("%v%nwhile(%v) {%{%v%n%v;%n%}}",t.inFor.init,t.inFor.cond,t.loop,t.inFor.next)});else{var i=J.lazy(),o=Z.pc++;J.printf("%v;%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%v;%n%s=%s;break;%n%}case %f:%{",t.inFor.init,o,t.inFor.cond,l,i,B({closestBrk:i,exitTryOnJump:!1},t.loop),t.inFor.next,l,o,function(t){t.print(i.put(Z.pc++))})}},"if":function(t){R(t)();var e=D(t);if(!Z.noWait&&(e.fiberCallRequired||e.hasJump||e.hasReturn)){var n={},r={};t._else?J.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",t.cond,l,r,t.then,l,n,function(){J.print(r.put(Z.pc++))},t._else,function(){J.print(n.put(Z.pc++))}):J.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",t.cond,l,n,t.then,function(){J.print(n.put(Z.pc++))})}else Z.enter({noWait:!0},function(){t._else?J.printf("if (%v) {%{%f%n%}} else {%{%f%n%}}",t.cond,F(t.then),F(t._else)):J.printf("if (%v) {%{%f%n%}}",t.cond,F(t.then))})},ifWait:function(t){Z.noWait?t._else&&J.printf("%v",t._else):J.printf("%v",t.then)},call:function(t){J.printf("(%j)",[",",t.args])},objlitArg:function(t){J.printf("%v",t.obj)},argList:function(t){J.printf("%j",[",",t.args])},newExpr:function(t){var e=t.params;e?J.printf("new %v%v",t.klass,e):J.printf("new %v",t.klass)},scall:function(t){J.printf("[%j]",[",",t.args])},superExpr:function(e){var r;if(!t.superclass)throw new Error(t.fullName+"には親クラスがありません");e.name?(r=e.name.text,J.printf("%s.prototype.%s.apply( %s, %v)",k(t.superclass),r,n,e.params)):J.printf("%s.apply( %s, %v)",k(t.superclass),n,e.params)},arrayElem:function(t){J.printf("[%v]",t.subscript)},member:function(t){J.printf(".%v",t.name)},symbol:function(t){J.print(t.text)},normalFor:function(t){J.printf("%v; %v; %v",t.init,t.cond,t.next)},compound:function(t){var e=D(t);!Z.noWait&&(e.fiberCallRequired||e.hasJump||e.hasReturn)?J.printf("%j",["%n",t.stmts]):Z.enter({noWait:!0},function(){J.printf("{%{%j%n%}}",["%n",t.stmts])})},"typeof":function(){J.printf("typeof ")},"instanceof":function(){J.printf(" instanceof ")},is:function(){J.printf(" instanceof ")},regex:function(t){J.printf("%s",t.text)}});var ae=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];return ae.forEach(function(t){v.funcs[t]=function(){J.printf("%s",t)}}),v.def=function(t){throw console.log("Err node="),console.log(t),t.type+" is not defined in visitor:compiler2"},v.cnt=0,_(),t.src.js=J.buf,Y&&console.log("method4",J.buf),J.buf}{var e="_thread",n="_this",f="_arguments",c="fiber$",l="__pc",p="$LASTPOS",h="__cnt",d=100,m="Tonyu.bindFunc",g="Tonyu.invokeMethod",y="Tonyu.callFunc",b="Tonyu.checkNonNull",x="Tonyu.classes.",T="Tonyu.globals.",S="this",w='"use strict";%n',E="Tonyu.iterator",M=u.ScopeTypes,L=u.getScopeType,A=u.annotation;u.getMethod,u.getDependingClasses,u.getParams}return{genJS:t}}()}),requireSimulator.setName("Tonyu.Compiler.Semantics"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(t,e,n,r,i,o,s,a,u){return u.Semantics=function(){function t(t,e){function o(n){var r,o=e.options.compiler.defaultSuperClass,s=0;if((r=p.match(n,{ext:{superclassName:{text:p.N,pos:p.P}}}))&&(o=r.N,s=r.P,"null"==o&&(o=null)),t.includes=[],(r=p.match(n,{incl:{includeClassNames:p.C}}))&&r.C.forEach(function(n){var r=n.text,o=n.pos,s=e.classes[e.aliases[r]||r];if(!s)throw i("クラス "+r+"は定義されていません",a,o);t.includes.push(s)}),"Array"==o)t.superclass={name:"Array",fullName:"Array",builtin:!0};else if(o){var f=e.classes[e.aliases[o]||o];if(!f)throw i("親クラス "+o+"は定義されていません",a,s);t.superclass=f}n.stmts.forEach(function(t){if("funcDecl"==t.type){var e=t.head,n="function";e.ftype&&(n=e.ftype.text);var r=e.name.text,i=e.params?"":e.setter?"__setter__":"__getter__";r=i+r,c[r]={nowait:!!e.nowait||""!=i,ftype:n,name:r,head:e,pos:e.pos,stmts:t.body.stmts}}else"nativeDecl"==t.type?l[t.name.text]=t:u.stmts.push(t)})}var s,a=t.src.tonyu;t.node&&t.nodeTimestamp==a.lastUpdate()&&(s=t.node),s||(console.log("Parse "+a),s=n.parse(a),t.nodeTimestamp=a.lastUpdate());var u={name:"main",stmts:[],pos:0},f={},c={main:u},l={};t.decls={fields:f,methods:c,natives:l},t.node=s;var p=r;o(s)}function e(t,e){function n(t){return u.getSource(R,t)}function y(e,n){return h(t.annotation,e,n)}function b(t){if(!t.builtin){var e=G,n=t.decls;for(var r in n.fields)e[r]=f(U.FIELD,{klass:t.name,name:r});for(var r in n.methods)e[r]=f(U.METHOD,{klass:t.name,name:r})}}function x(){var n=G;m(t).forEach(b);var r=t.decls;for(var i in r.natives)n[i]=f(U.NATIVE,{name:"native::"+i});for(var i in v)n[i]=f(U.NATIVE,{name:"native::"+i});for(var i in e.aliases)n[i]=f(U.CLASS,{name:i})}function T(){var e=m(t);for(var n in t.decls.methods){var r=t.decls.methods[n];e.forEach(function(t){var e=t.decls.methods[n];e&&e.nowait&&(r.nowait=!0)})}}function S(e){return d(t,e)}function w(t){if("varAccess"==t.type||"postfix"==t.type&&("member"==t.op.type||"arrayElem"==t.op.type))return"varAccess"==t.type&&y(t,{noBind:!0}),!0;throw console.log("LVal",t),i("'"+n(t)+"'は左辺には書けません．",I,t.pos)}function E(e){var n=W.scope[e],r=c(n);if(!r){var i=e.match(/^\$/);r=i?U.GLOBAL:U.FIELD;var o={name:e};i||(o.klass=t.name),n=G[e]=f(r,o)}return n}function M(t){var e=this;if(t&&"object"==typeof t){var n;if(n=t instanceof Array?t:t[Grammar.SUBELEMENTS],!n){n=[];for(var r in t)n.push(t[r])}n.forEach(function(t){e.visit(t)})}}function L(t){var e={varDecls:{},subFuncDecls:{}};return W.enter({locals:e},function(){Y.visit(t)}),e}function A(t,e){t.forEach(function(t){y(t,e)})}function P(t){W.method&&(W.method.fiberCallRequired=!0),A(t,{fiberCallRequired:!0})}function N(t,e){W.enter({scope:e},function(){Q.visit(t)})}function D(t,e){for(var n in t.varDecls)e[n]=f(U.LOCAL);for(var n in t.subFuncDecls)e[n]=f(U.LOCAL)}function k(t){t.locals=L(t.stmts),t.params=g(t)}function C(e){var n=l(W.scope);return e.params.forEach(function(r,i){n[r.name.text]=f(U.PARAM,{klass:t.name,name:e.name,no:i})}),D(e.locals,n),W.enter({method:e,finfo:e,noWait:!1},function(){N(e.stmts,n)}),e.scope=n,F(e.locals,n),n}function B(){W.enter({scope:G},function(){for(var t in q){$&&console.log("anon method1",t);var e=q[t];k(e),C(e)}})}function j(t){var e,n,r=t.body,i=t.head.name?t.head.name.text:"anonymous_"+t.pos;n=(e=_.match(t,{head:{params:{params:_.P}}}))?e.P:[];var o=l(W.scope);n.forEach(function(t){o[t.name.text]=f(U.PARAM)});var s=L(r,o);D(s,o);var a=y(t);W.enter({finfo:a},function(){N(r,o)});var u={scope:o,locals:s,name:i,params:n};return y(t,u),y(t,a),F(s,o),u}function F(t,e){W.enter({scope:e},function(){for(var e in t.subFuncDecls)j(t.subFuncDecls[e])})}var I=t.src.tonyu,R=I.text(),_=r,O=(e.traceTbl,t.decls),q=(O.fields,O.methods),U=(O.natives,o),G={},W=s(),$=!1,z={type:"postfix",left:{type:"postfix",left:_.T,op:{type:"member",name:{text:_.N}}},op:{type:"call",args:_.A}},V={type:"postfix",left:_.T,op:{type:"member",name:{text:_.N}}},K=fiberCallTmpl={type:"postfix",left:{type:"varAccess",name:{text:_.N}},op:{type:"call",args:_.A}},H={expr:fiberCallTmpl},J={expr:{type:"infix",op:_.O,left:_.L,right:fiberCallTmpl}},X={expr:{type:"superExpr",params:{args:_.A},$var:"S"}},Z={expr:{type:"infix",op:_.O,left:_.L,right:{type:"superExpr",params:{args:_.A},$var:"S"}}};t.annotation={};var Y=a({varDecl:function(t){W.locals.varDecls[t.name.text]=t},funcDecl:function(t){W.locals.subFuncDecls[t.head.name.text]=t},funcExpr:function(){},"catch":function(t){W.locals.varDecls[t.name.text]=t},exprstmt:function(){},forin:function(t){t.isVar;t.vars.forEach(function(e){W.locals.varDecls[e.text]=t});var e=p("_it_");y(t,{iterName:e}),W.locals.varDecls[e]=t}});Y.def=M;var Q=a({varAccess:function(t){var e=E(t.name.text);y(t,{scopeInfo:e})},funcDecl:function(){},funcExpr:function(t){j(t)},jsonElem:function(t){if(t.value)this.visit(t.value);else{var e=E(t.key.text);y(t,{scopeInfo:e})}},"do":function(t){var e=this;W.enter({jumpable:!0},function(){e.def(t)})},"switch":function(t){var e=this;W.enter({jumpable:!0},function(){e.def(t)})},"while":function(t){var e=this;W.enter({jumpable:!0},function(){e.def(t)}),P(this.path)},"for":function(t){var e=this;W.enter({jumpable:!0},function(){e.def(t)})},forin:function(t){t.vars.forEach(function(t){var e=E(t.text);y(t,{scopeInfo:e})}),this.visit(t.set)},ifWait:function(t){var e="_thread",n=this,r=l(W.scope);r[e]=f(U.THVAR),W.enter({scope:r},function(){n.visit(t.then)}),t._else&&n.visit(t._else),P(this.path)},"try":function(t){W.finfo.useTry=!0,this.def(t)},"return":function(t){W.noWait||A(this.path,{hasReturn:!0}),this.visit(t.value)},"break":function(t){if(!W.jumpable)throw i("break； は繰り返しの中で使います.",I,t.pos);W.noWait||A(this.path,{hasJump:!0})},"continue":function(t){if(!W.jumpable)throw i("continue； は繰り返しの中で使います.",I,t.pos);W.noWait||A(this.path,{hasJump:!0})},reservedConst:function(t){"arguments"==t.text&&(W.finfo.useArgs=!0)},postfix:function(t){var e;if(this.visit(t.left),this.visit(t.op),e=_.match(t,K)){var n=y(t.left).scopeInfo;y(t,{myMethodCall:{name:e.N,args:e.A,scopeInfo:n}})}else(e=_.match(t,z))?y(t,{othersMethodCall:{target:e.T,name:e.N,args:e.A}}):(e=_.match(t,V))&&y(t,{memberAccess:{target:e.T,name:e.N}})},infix:function(t){var e=t.op.text;("="==e||"+="==e||"-="==e||"*="==e||"/="==e||"%="==e)&&w(t.left),this.def(t)},exprstmt:function(e){var n,r;if(W.noWait||!(n=_.match(e,H))||c(W.scope[n.N])!=U.METHOD||S(n.N).nowait)if(W.noWait||!(n=_.match(e,J))||c(W.scope[n.N])!=U.METHOD||S(n.N).nowait){if(!W.noWait&&(n=_.match(e,X))&&n.S.name){if(r=S(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="noRetSuper",n.superclass=t.superclass,y(e,{fiberCall:n}),P(this.path))}else if(!W.noWait&&(n=_.match(e,Z))&&n.S.name){if(r=S(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="retSuper",n.superclass=t.superclass,y(e,{fiberCall:n}),P(this.path))}}else n.type="ret",y(e,{fiberCall:n}),P(this.path);else n.type="noRet",y(e,{fiberCall:n}),P(this.path);this.visit(e.expr)}});Q.def=M,x(),T(),B()}var o=u.ScopeTypes,f=u.newScopeType,c=u.getScopeType,l=u.newScope,p=u.genSym,h=u.annotation,d=u.getMethod,m=u.getDependingClasses,g=u.getParams,v={Array:1,String:1,Boolean:1,Number:1,Void:1,Object:1,RegExp:1,Error:1};return{initClassDecls:t,annotate:e}}()}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/(_trc_[A-Za-z0-9_]*).*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(t){var e=t.stack;if("string"!=typeof e)return!1;for(var n=e.split(/\n/),r=[],i=0;i<n.length;i++){var o=pat.exec(n[i]);if(o){var s=o[1],a=o[2],u=o[3];r.push({fname:s,row:a,col:u})}}return console.log("StackTrace.get",r),r},trc}),requireSimulator.setName("Tonyu.TraceTbl"),define(["Tonyu","FS","TError","StackTrace"],function(t,e,n,r){return t.TraceTbl=function(){var t={},i=1e6,o=1,s=1e4,a={},u=[],f={};t.add=function(t,e){var n=t.src.tonyu,r=n.path(),c=a[r];void 0==c&&(c=o++,o>s&&(o=0),a[r]=c,u[c]=r),f[r]=t,e>=i&&(e=i-1);var l=c*i+e;return l};var c={};return t.decodeOLD=function(t){var r=t%i,o=(t-r)/i,s=u[o];if(s){var a=e.get(s),c=f[s];return n("Trace info",c||a,r)}return null},t.srcMap=c,t.decode=function(t){var e=new RegExp("LASTPOS="+t+";//(.*)\r?\n");console.log("pat=",e);for(var n in c){var r=e.exec(c[n]);if(r)return r[1];console.log("pat=",e,"Not found in ",n)}},t.find=function(t){var e=r.get(t),n=e[0];if(!n)return null;var i=new RegExp("LASTPOS=[0-9]+;//(.*)\r?");for(var o in c){console.log("Finding ",n.fname," in ",o);var s=c[o].indexOf(n.fname);if(s>=0){console.log("fname found at ",s);var a=c[o].split(/\n/),u=n.row-1;console.log("Scan from row=",u);for(var f=u;f>=0&&(console.log("row ",f,a[f]),null!=a[f]);f--){var l=i.exec(a[f]);if(l)return l[1]}console.log("Not found LASTPOS pat")}else console.log("Not found in ",o)}},t.addSource=function(t,e){c[t]=e},t}()}),requireSimulator.setName("DeferredUtil"),define([],function(){var t;return t={directPromise:function(t){var e=new $.Deferred;return setTimeout(function(){e.resolve(t)},0),e.promise()},throwPromise:function(t){return d=new $.Deferred,setTimeout(function(){d.reject(t)},0),d.promise()},throwF:function(e){return function(){try{return e.apply(this,arguments)}catch(n){return console.log(n.stack),t.throwPromise(n)}}},each:function(e,n){if(e instanceof Array)return t.loop(function(r){return r>=e.length?t.brk():$.when(n(e[r])).then(function(){return r+1})},0);var r=[];for(var i in e)r.push({k:i,v:e[i]});return t.each(r,function(t){n(t.k,t.v)})},loop:function(e,n){t.directPromise(n).then(t.throwF(function(){var n=e.apply(this,arguments);return n.DU_BRK?n.res:$.when(n).then(function(n){return t.loop(e,n)})}))},brk:function(t){return{DU_BRK:!0,res:t}}}}),requireSimulator.setName("compiledProject"),define(["DeferredUtil"],function(t){var e=function(e,n){return{getNamespace:function(){return e},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(e){var n=t.directPromise(),r=this.getNamespace();return this.getDependingProjects().forEach(function(t){t.getNamespace()!=r&&(n=n.then(function(){return t.loadClasses(e)}))}),n},loadClasses:function(t){console.log("Load compiled classes ns=",e,"url=",n);var r=new $.Deferred,i=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.src=n;var s=!1;return o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,o.onload=o.onreadystatechange=null,i&&o.parentNode&&i.removeChild(o),console.log("Done Load compiled classes ns=",e,"url=",n,Tonyu.classes),r.resolve())},this.loadDependingClasses(t).then(function(){i.insertBefore(o,i.firstChild)}),r.promise()}}};return e}),requireSimulator.setName("ProjectCompiler"),define(["Tonyu","Tonyu.Compiler.JSGenerator","Tonyu.Compiler.Semantics","Tonyu.TraceTbl","FS","assert","SFile","DeferredUtil","compiledProject"],function(t,e,n,r,i,o,s,a,u){var f=function(r){function c(e){var n=h.env;return e||(e={}),e.visited||(e={visited:{},classes:n.classes=n.classes||t.classMetas,options:e}),e}function l(t){function e(e){var n=e.superclass,i=n?[n]:[];return e.includes&&(i=i.concat(e.includes)),i=i.filter(function(e){return e&&t[e.fullName]&&!e.builtin&&!r[e.fullName]})}function n(t,r){if(console.log("detectloop",t.fullName),o[t.fullName]){console.log("Detected: ",t.fullName,o,o[t.fullName]);var i=t.fullName,s=[];do s.unshift(i),i=o[i];
while(i!=t.fullName);return s.unshift(t.fullName),s}r&&(o[t.fullName]=r.fullName);var a,u=e(t);return u.forEach(function(e){if(!a){var r=n(e,t);r&&(a=r)}}),delete o[t.fullName],a}var r={},i=[],o={},s=0;for(var a in t)r[a]=!1,s++;for(;i.length<s;){var u=i.length;for(var a in t)if(!r[a]){var f=t[a],c=e(f);0==c.length&&(i.push(f),r[a]=!0)}if(i.length==u){var l=[];for(var a in t)if(!r[a]){l=n(t[a])||[];break}throw TError("次のクラス間に循環参照があります: "+l.join("->"),"不明",0)}}return i}function p(t){console.log("loading: "+t.path());var e=new Function(t.text());return d.addSource(t.path(),e+""),a.directPromise(e())}o(s.is(r)&&r.isDir(),"projectCompiler: "+r+" is not dir obj");var h={env:{}},d=t.TraceTbl,m=a.throwF;return h.env.traceTbl=d,h.EXT=".tonyu",h.getOptionsFile=function(){var t=r.rel("options.json");return t},h.getOptions=function(){var t=h.env;t.options={};var e=h.getOptionsFile();return e.exists()&&(t.options=e.obj()),h.fixOptions(t.options),t.options},h.setOptions=function(t){h.getOptionsFile().obj(t)},h.fixOptions=function(t){t.compiler||(t.compiler={})},h.resolve=function(t){if(t instanceof Array){var e=[];return t.forEach(function(t){e.push(h.resolve(t))}),e}if("string"==typeof t)return i.resolve(t,r.path());if(!t||!t.isDir)throw new Error("Cannot TPR.resolve: "+t);return t},h.shouldCompile=function(){var e=h.getOutputFile();if(!e.exists())return!0;if(e.isReadOnly())return!1;var n=e.lastUpdate();if(n<t.VERSION)return console.log("Should compile: ",e.name()+" last="+new Date(n)+" < Tonyu.ver="+new Date(t.VERSION)),!0;var r=h.sourceFiles(h.getNamespace());for(var i in r){var o=r[i],s=o.lastUpdate();if(s>n)return console.log("Should compile: ",o.name()+" last="+new Date(s)),!0}var a=h.getOptionsFile();return a.exists()&&a.lastUpdate()>n?(console.log("Should compile: ",a.name()+" last="+new Date(a.lastUpdate())),!0):!1},h.getClassName=function(t){if(o(s.is(t)),r.contains(t))return h.getNamespace()+"."+t.truncExt(h.EXT);var e;return h.getDependingProjects().forEach(function(n){e||(e=n.getClassName(t))}),e},h.getNamespace=function(){var t=h.getOptions();return o(t.compiler.namespace,"namespace not specified opt="+JSON.stringify(t))},h.getOutputFile=function(){var t=h.getOptions(),e=h.resolve(o(t.compiler.outputFile,"output file should be specified in options"));if(e.isDir())throw new Error("out: directory style not supported");return e},h.loadDependingClasses=function(t){var e=a.directPromise(),n=h.getNamespace();return h.getDependingProjects().forEach(function(r){r.getNamespace()!=n&&(e=e.then(function(){return r.loadClasses(t)}))}),e},h.loadClasses=function(e){t.runMode=!1,console.log("LoadClasses: "+r.path()),e=c(e);var n=e.visited||{};return n[h.path()]?a.directPromise():(n[h.path()]=!0,h.loadDependingClasses(e).then(function(){return h.shouldCompile()}).then(function(t){if(t)return h.compile(e);var n=h.getOutputFile("js");return p(n)}))},h.compile=function(e){t.runMode=!1,console.log("Compile: "+r.path()),e=c(e);var i=h.getNamespace();return h.loadDependingClasses(e).then(m(function(){var r=e.classes,o=(e.options,h.env);o.aliases={},o.parsedNode=o.parsedNode||{},o.classes=r;for(var s in r){var a=r[s];o.aliases[a.shortName]=a.fullName}var u={},f=h.sourceFiles(i);for(var c in f){var p=f[c],d=i+"."+c,m=t.klass.getMeta(d);u[d]=r[d]=m,t.extend(m,{fullName:d,shortName:c,namespace:i}),m.src=m.src||{},m.src.tonyu=p,o.aliases[c]=d}for(var s in u)console.log("initClassDecl: "+s),n.initClassDecls(u[s],o);var g=l(u);g.forEach(function(t){console.log("annotate :"+t.fullName),n.annotate(t,o)}),h.concatJS(g)}))},h.concatJS=function(t){var n=h.env,r="";t.forEach(function(t){console.log("concatJS :"+t.fullName),e.genJS(t,n),r+=t.src.js+"\n"});var i=h.getOutputFile();i.text(r),p(i)},h.getDependingProjects=function(){var t=h.getOptions(),e=t.compiler.dependingProjects||[];return e.map(function(t){if("string"==typeof t){var e=h.resolve(t);return f(e)}return"object"==typeof t?u(t.namespace,i.expandPath(t.compiledURL)):void 0})},h.dir=r,h.path=function(){return r.path()},h.sourceFiles=function(t){function e(t){if(t.endsWith(h.EXT)){var e=t.truncExt(h.EXT);r[e]=t}}for(var n=h.sourceDirs(t),r={},i=n.length-1;i>=0;i--)n[i].recursive(e);return r},h.sourceDir=function(){return r},h.sourceDirs=function(t){var e=h.getDependingProjects(),n=[r];return e.forEach(function(e){var r=e.getNamespace();if(!t||r==t){var i=e.sourceDir();i&&n.push(i)}}),n},h.decodeTrace=function(t){var e=t.split(":"),n=e[0],r=parseInt(e[1]),i=n.split("."),o=i.pop(),s=i.join(".");if(s==h.getNamespace()){var a=h.sourceFiles(s);for(var u in a)if(o==u)return TError("Trace info",a[u],r)}},h};return"object"==typeof sh&&(sh.tonyuc=function(t){var e=f(sh.resolve(t));return e.compile()}),f}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(t){var e=function(t,e){this.options=e||{},this.img=t,this.height=t.height,this.width=t.width;var n=this.newImage(t.width,t.height),r=n.getContext("2d");r.drawImage(t,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,t.width,t.height).data,this.base=this.getPixel(0,0)};return t.extend(e.prototype,{newImage:function(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,n},getPixel:function(t,e){var n=this.pixels,r=4*(t+e*this.width),i=n[0+r],o=n[1+r],s=n[2+r],a=n[3+r];return 256*(256*(256*a+s)+o)+i},setPixel:function(t,e,n){var r=4*(t+e*this.width);this.pixels[0+r]=255&n,n=(n-(255&n))/256,this.pixels[1+r]=255&n,n=(n-(255&n))/256,this.pixels[2+r]=255&n,n=(n-(255&n))/256,this.pixels[3+r]=255&n},parse:function(){try{for(var t=[],e=0;e<this.height;e++)for(var n=0;n<this.width;n++){var r=this.getPixel(n,e);r!=this.base&&t.push(this.parse1Pattern(n,e))}return t}catch(i){if(i.isParseError)return console.log("parse error! "+i),{image:this.img,x:0,y:0,width:this.width,height:this.height};throw i}},parse1Pattern:function(t,e){function n(t){return t}function r(t,e,n){return{toString:function(){return"at ("+t+","+e+") :"+n},isParseError:!0}}for(var i=this.getPixel(t,e),o=t,s=e,a=this.base,u=this.width,f=this.height;u>o;){var c=this.getPixel(o,s);if(c!=i)break;o++}if(o>=u||this.getPixel(o,s)!=a)throw r(o,s,n(this.getPixel(o,s))+"!="+n(a));for(o--;f>s&&this.getPixel(o,s)==i;)s++;if(s>=f||this.getPixel(o,s)!=a)throw r(o,s,n(this.getPixel(o,s))+"!="+n(a));s--;var l=t+1,p=e+1,h=o-l,d=s-p;if(console.log("PP",l,p,h,d,o,s),h*d==0)throw r(o,s,"w*h==0");for(var m=this.newImage(h,d),g=m.getContext("2d"),v=g.getImageData(0,0,h,d),y=v.data,b=0,x=p;s>x;x++)for(var T=l;o>T;T++){var S=this.getPixel(T,x);S==i?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S)}g.putImageData(v,0,0);for(var w=p-1;s>=w;w++)for(var E=l-1;o>=E;E++)this.setPixel(E,w,a);return this.options.boundsInSrc?{x:l,y:p,width:h,height:d}:{image:m,x:0,y:0,width:h,height:d}}}),e}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu"],function(t,e,n){var r={};return r.resolve=function(n,r){if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,n){return t[n]}),t.urlAliases[n]&&(n=t.urlAliases[n]),e.startsWith(n,"ls:")){var i=n.substring("ls:".length);if(!r)throw new Error("Basedir not specified");var o=r.rel(i);if(!o.exists())throw new Error("Resource file not found: "+o);if(t.mp3Disabled&&i.match(/\.mp3$/)){var s=r.rel(i.replace(/\.mp3$/,".ogg"));s.exists()&&(o=s)}n=o.getURL()}return n},n.Assets=r,r}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets"],function(t,e,n){function r(t){var e=[];return t.forEach(function(t){t&&""!=t.url&&e.push(t)}),e}var i,o={};return i=function(e,n,s){s||(s={}),e=r(e);var a=[],u=e.length;e.forEach(function(e,r){function f(){var i,o;if((i=e.pwidth)&&(o=e.pheight)){for(var s=0,f=0,c=this.width,l=this.height,p=[];;){var h=i,d=o;if(s+i>c&&(h=c-s),f+o>l&&(d=l-f),p.push({image:this,x:s,y:f,width:h,height:d}),s+=i,s+i>c&&(s=0,f+=o,f+o>l))break}a[r]=p}else{var m=new t(this);a[r]=m.parse()}if(a[r].name=e.name,u--,0==u){var g=[],v={};a.forEach(function(t){v[t.name]=g.length,g=g.concat(t)}),g.names=v,n(g)}}console.log("loading",e,r);var c=e.url,l=c;if(o[l])return void f.apply(o[l],[]);c=i.convURL(c,s.baseDir);var p=$("<img>");p.load(function(){o[l]=this,f.apply(this,[])}),p.attr("src",c)})},i.load=i,i.parse1=function(e,n,r){var i,o,s;if((i=e.pwidth)&&(o=e.pheight)){for(var a=0,u=0,f=n.width,c=n.height,l=[];;)if(l.push({image:this,x:a,y:u,width:i,height:o}),a+=i,a+i>f&&(a=0,u+=o,u+o>c))break;s=l}else{var p=new t(n,r);s=p.parse()}return s.name=e.name,s},i.convURL=function(t,e){return n.resolve(t,e)},window.ImageList=i,i}),requireSimulator.setName("typeCheck"),"function"!=typeof define&&(define=require("requirejs").define),define(["Visitor"],function(){return TypeCheck=function(){}}),requireSimulator.setName("Auth"),define(["WebSite"],function(t){var e={};return e.currentUser=function(e){$.ajax({type:"get",url:t.serverTop+"/currentUser",data:{withCsrfToken:!0},success:function(t){console.log("auth.currentUser",t),t=JSON.parse(t);var n=t.user;"null"==n&&(n=null),console.log("user",n,"csrfToken",t.csrfToken),e(n,t.csrfToken)}})},e.assertLogin=function(n){e.currentUser(function(e,r){return e?n.success(e,r):(window.onLoggedIn=n.success,void n.showLoginLink(t.serverTop+"/login"))})},window.Auth=e,e}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(t,e,n){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(t,n,r,i){var o=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(t){alert(t)}),o.append("theFile",r),o.append("user",t),o.append("project",n),o.append("fileName",r.name),$.ajax({type:"get",url:e.serverTop+"/blobURL",success:function(t){$.ajax({url:t,type:"POST",data:o,processData:!1,contentType:!1,success:function(t){console.log("Res = "+t),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(t){if(n.startsWith(t,i)){var e=t.split("/");return{user:e[1],project:e[2],fileName:e[3]}}},r.url=function(t,n,r){return e.blobPath+t+"/"+n+"/"+r},r.uploadToExe=function(t,n){var r=t.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?n.success():(n.progress||(n.progress=function(t){console.log("uploadBlobToExe cnt=",t)}),void r.forEach(function(t){var r={csrfToken:n.csrfToken};for(var o in t)r[o]=t[o];$.ajax({type:"get",url:e.serverTop+"/uploadBlobToExe",data:r,success:function(){return i--,0==i?n.success():void n.progress(i)},error:n.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function t(e,n){if("string"==typeof e){var r=new Image,i=null,o=null,s=function(t){t&&(o=t),o&&i&&o(i)};return r.onload=function(){i=t(r,n),s()},r.src=e,s}var a=n.width,u=n.height,f=n.getContext("2d"),c=e.width,l=e.height,p=u/l*c,h=a/c*l;h>u&&(h=u),p>a&&(p=a),f.clearRect(0,0,a,u);var d=Math.floor((a-p)/2),m=Math.floor((u-h)/2);return f.drawImage(e,0,0,c,l,d,m,p,h),{left:d,top:m,width:p,height:h,src:e}}return t}),requireSimulator.setName("thumbnail"),define(["ImageRect"],function(t){function e(e){try{var i=Tonyu.globals.$Screen.buf[0],o=$("<canvas>").attr({width:100,height:100});t(i,o[0]);var s=o[0].toDataURL(),a=e.getResource(),u=e.getDir(),f=n.file(e);f.text(s);for(var c={name:r,pwidth:100,pheight:100,url:"ls:"+f.relPath(u)},l=a.images,p=!1,h=0;h<l.length;h++)l[h].name==r&&(l[h]=c,p=!0);p||l.push(c),e.setResource(a),console.log("setRSRC",a)}catch(d){console.log("Create thumbnail failed",d)}}var n={},r="$icon_thumbnail";return n.set=function(t,n){setTimeout(function(){e(t)},n)},n.get=function(t){var e=n.file(t);return e.exists()?e.text():null},n.file=function(t){var e=t.getDir(),n=e.rel("images/").rel("icon_thumbnail.png");return n},n}),requireSimulator.setName("plugins"),define(["WebSite"],function(t){function e(t){return"function"==typeof t&&(t={onload:t}),t||(t={}),t.onload||(t.onload=function(){}),t}var n={},r={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return n.installed=r,n.detectNeeded=function(t,e){for(var n in r){var i=r[n].detection.exec(t);i&&(e[n]=1)}return e},n.loaded=function(t){var e=r[t];if(!e)throw new Error("plugin not found: "+t);return window[e.symbol]},n.loadAll=function(t,i){function o(){u>=s.length?i.onload():n.load(s[u++],o)}i=e(i);var s=[];for(var a in t)r[a]&&!n.loaded(a)&&s.push(a);var u=0;console.log("loading plugins",s),o()},n.load=function(n,i){var o=r[n];if(!o)throw new Error("plugin not found: "+n);i=e(i);var s=t.pluginTop+"/"+o.src;location.href.match(/^file:/)?($("<script>").attr("src",s).appendTo("body"),setTimeout(i.onload,500)):$.getScript(s,i.onload)},n.request=function(t){if(!n.loaded(t)){var e=new Error("Plugin "+t+" required");e.pluginName=t}},n}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","ProjectCompiler","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","typeCheck","Blob","thumbnail","WebSite","plugins","Tonyu.Compiler.Semantics","Tonyu.Compiler.JSGenerator","DeferredUtil","compiledProject"],function(t,e,n,r,i,o,s,a,u,f,c,l,p,h,d,m){return t.Project=function(n,i){{var a=e(n);t.extend({},a),r.get(c.tonyuHome)}a.EXT=".tonyu",a.NSP_KER="kernel",a.NSP_USR="user";var p;p=i?e(i):m(a.NSP_KER,c.compiledKernel);var h=t.TraceTbl,g={classes:t.classMetas,traceTbl:h,options:{compiler:{}}};return a.env=g,a.dumpJS=function(t){function e(t){console.log("Class "+t+":\n"+g.classes[t].src.js)}if(t)e(t);else for(var t in g.classes)e(t)},a.stop=function(){var t=a.runningThread;t&&t.kill();var e=a.runningObj;e&&e.stop&&e.stop()},a.rawRun=function(t){if(c.removeJSOutput){var e=a.getOutputFile();e.exists()&&e.rm()}return a.loadClasses().then(d.throwF(function(){a.fixBootRunClasses(),a.runScriptMode||f.set(a,2e3),a.rawBoot(t)}))},a.getResource=function(){var e=n.rel("res.json");if(e.exists()){var r=e.obj(),i=!1;for(var o in r)for(var s=r[o],u=s.length-1;u>=0;u--)s[u].url||(s.splice(u,1),i=!0);return i&&a.setResource(r),r}return t.defaultResource},a.hasSoundResource=function(){var t=a.getResource();return t&&t.sounds&&t.sounds.length>0},a.setResource=function(t){var e=n.rel("res.json");e.obj(t)},a.getThumbnail=function(){return f.get(a)},a.convertBlobInfos=function(t){function e(n){if("object"==typeof n)for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];if("url"==i){var s;(s=u.isBlobURL(o))&&(n[i]=[u.BLOB_PATH_EXPR,t,r,s.fileName].join("/"))}e(o)}}var n=a.getResource(),r=a.getName();e(n),a.setResource(n)},a.getBlobInfos=function(){function t(e){if("object"==typeof e)for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];if("url"==r){var o;(o=u.isBlobURL(i))&&n.push(o)}t(i)}}var e=a.getResource(),n=[];return t(e),n},a.loadResource=function(e){var n=a.getResource();o(n.images,function(n){var r=t.getGlobal("$Sprites");r&&r.setImageList(n);for(var i in n.names)t.setGlobal(i,n.names[i]);e&&e()})},a.getOptions=function(){g.options=null;var e=n.rel("options.json");return e.exists()&&(g.options=e.obj()),g.options&&!g.options.run&&(g.options=null),g.options||(g.options=t.defaultOptions),a.fixOptions(g.options),g.options},a.fixOptions=function(t){t.compiler||(t.compiler={}),t.compiler.commentLastPos=a.runScriptMode||s.isAvailable(),t.plugins||(t.plugins={},n.each(function(e){e.endsWith(a.EXT)&&l.detectNeeded(e.text(),t.plugins)}))},a.requestPlugin=function(t){if(!l.loaded(t)){var e=a.getOptions();e.plugins[t]=1,a.setOptions(e);var n=new Error("必要なプラグイン"+t+"を追加しました。もう一度実行してください");throw n.pluginName=t,n}},a.loadPlugins=function(t){var e=a.getOptions();return l.loadAll(e.plugins,t)},a.fixBootRunClasses=function(){var t=a.getOptions();if(t.run){var e=a.fixClassName(t.run.mainClass),n=a.fixClassName(t.run.bootClass);(e!=t.run.mainClass||n!=t.run.bootClass)&&(t.run.mainClass=e,t.run.bootClass=n,a.setOptions(t))}},a.fixClassName=function(e){if(t.getClass(e))return e;var n,r=e.split("."),i=r.pop();return n=a.NSP_USR+"."+i,t.getClass(n)?n:(n=a.NSP_KER+"."+i,t.getClass(n)?n:e)},a.getNamespace=function(){var t=a.getOptions();return t.compiler&&t.compiler.namespace?t.compiler.namespace:a.isKernelEditable()?a.NSP_KER:a.NSP_USR},a.getDependingProjects=function(){return[p]},a.getOutputFile=function(){var t=a.getOptions();return t.compiler.outputFile?r.resolve(t.compiler.outputFile):n.rel("js/concat.js")},a.setOptions=function(t){t&&(g.options=t);var e=n.rel("options.json"),r=e.exists()?e.text():"",i=JSON.stringify(g.options);r!=i&&(console.log("update option",r,i),e.text(i))},a.rawBoot=function(e){t.run(e)},a.srcExists=function(t,e){var n=null;return e.recursive(function(e){e.truncExt(a.EXT)===t&&(n=e)}),n},a.isKernel=function(e){return i?a.srcExists(e,i):g.classes[a.NSP_KER+"."+e]||t.getClass(a.NSP_KER+"."+e)},a.isKernelEditable=function(){return g.options.kernelEditable},a.getDir=function(){return n},a.getName=function(){return n.name().replace(/\/$/,"")},a.renameClassName=function(t,e){a.compile();var n=a.env.classes;for(var r in n){var i=n[r],o=i.src?i.src.tonyu:null,s=i.annotation,u=[];if(s&&o){for(var f in s)try{var c=s[f],l=c.scopeInfo;if(l&&"class"==l.type&&l.name==t){var p=c.node.pos,h=c.node.len,d=o.text().substring(p,p+h);d==t&&(u.push({pos:p,len:h}),console.log(o.path(),p,h,o.text().substring(p-5,p+h+5),"->",e))}}catch(m){console.log(m)}u=u.sort(function(t,e){return e.pos-t.pos}),console.log(o.path(),u);var g=o.text(),v=g;u.forEach(function(t){g=g.substring(0,t.pos)+e+g.substring(t.pos+t.len)}),v==g||o.isReadOnly()||(console.log("Refact:",o.path(),g),o.text(g))}}},a}}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite"],function(t,e,n){function r(t,e){var n=i(t);if(e&&!n.exists())throw n+": no such file or directory";return n}function i(n){if("string"!=typeof n)return n;if(e.startsWith(n,"/"))return t.get(n);var r=o.cwd;return r.rel(n)}var o={cwd:t.get("/")};return o.cd=function(t){return o.cwd=r(t,!0),o.pwd()},o.resolve=r,o.pwd=function(){return o.cwd+""},o.ls=function(t){return t=t?r(t,!0):o.cwd,t.ls()},o.cp=function(t,e,n){n||(n={}),n.v&&(o.echo("cp",t,e),n.echo=o.echo.bind(o));var i=r(t,!0),s=r(e);return i.copyTo(s,n)},o.rm=function(t,e){if(e||(e={}),e.notrash)return t=r(t,!1),t.removeWithoutTrash(),1;if(t=r(t,!0),t.isDir()&&e.r){var n=t,i=0;return n.each(function(t){t.exists()&&(i+=o.rm(t,e))}),n.rm(),i+1}return t.rm(),1},o.cat=function(t){t=r(t,!0),o.echo(t.text())},o.resolve=function(t){return t||(t="."),t=r(t)},o.grep=function(t,e,n){function i(t,e,r){n.res&&n.res.push({file:t,lineNo:e,line:r}),o.echo(t+"("+e+"): "+r)}return e=r(e,!0),n||(n={}),n.res||(n.res=[]),e.isDir()?e.each(function(e){o.grep(t,e,n)}):"string"==typeof t&&e.lines().forEach(function(n,r){n.indexOf(t)>=0&&i(e,r+1,n)}),n.res},o.touch=function(t){return t=r(t),t.text(t.exists()?t.text():""),1},o.setout=function(t){o.outUI=t},o.echo=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.log&&o.outUI.log.apply(o.outUI,arguments)},o.err=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.err&&o.outUI.err.apply(o.outUI,arguments)},o.prompt=function(){},o.ASYNC={r:"SH_ASYNC"},o.help=function(){for(var t in o){var e=o[t];"function"==typeof e&&o.echo(t+(e.description?" - "+e.description:""))}},sh=o,n.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),o}),requireSimulator.setName("KeyEventChecker"),define([],function(){var t={};return t.down=function(e,n,r){e instanceof $||(e=$(e)),e.bind("keydown",function(i){return t.is(i,n)?r.call(e[0],i):void 0})},t.is=function(t,e){e=e.toLowerCase(),t=t.originalEvent||t;var n="";return t.altKey&&(n+="alt+"),t.ctrlKey&&(n+="ctrl+"),t.shiftKey&&(n+="shift+"),n+=t.keyCode>=112&&t.keyCode<=123?"f"+(t.keyCode-111):String.fromCharCode(t.keyCode),n=n.toLowerCase(),e==n},t}),requireSimulator.setName("ScriptTagFS"),define([],function(){var t={};return t.toObj=function(){function t(t,e){var n=t.split("\n"),r="";return n.forEach(function(t){r+=t.length>e?t.substring(0,e):t+"\n"}),r}var e=$("script"),n={};return e.each(function(){var e=this;if("text/tonyu"==e.type){var r=$(e).data("filename");if(r){var i=parseInt($(e).data("lastupdate")),o=$(e).data("wrap");o?(o=parseInt(o),n[r]={lastUpdate:i,text:t(e.innerHTML,o)}):n[r]={lastUpdate:i,text:e.innerHTML}}}}),n},t.copyTo=function(e){var n=t.toObj();for(var r in n){var i=e.rel(r);i.text(n[r].text)}},t}),requireSimulator.setName("T2MediaLib");var T2MediaLib_BGMPlayer=function(t){this.id=t,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1};T2MediaLib_BGMPlayer.prototype.playBGM=function(t,e,n,r,i){if(!T2MediaLib.context)return null;var o=this.playingBGM;return o instanceof AudioBufferSourceNode&&o.stop(0),this.playingBGM=T2MediaLib.playSE(t,this.bgmVolume,this.bgmTempo,n,e,r,i),this.playingBGMName=t,this.bgmPause=0,this.playingBGM},T2MediaLib_BGMPlayer.prototype.stopBGM=function(){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?(t.stop(0),this.playingBGM=null,t):null},T2MediaLib_BGMPlayer.prototype.pauseBGM=function(){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?(0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=t.loopStart,this.bgmPauseLoopEnd=t.loopEnd,this.bgmPauseLoop=t.loop,this.bgmPauseCurrentTime=t.context.currentTime,this.bgmPauseTempo=T2MediaLib.bgmTempo,t.stop(0),this.bgmPause=1),t):null},T2MediaLib_BGMPlayer.prototype.resumeBGM=function(){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?(1===this.bgmPause&&(t=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd),this.bgmPause=0),t):null},T2MediaLib_BGMPlayer.prototype.setBGMVolume=function(t){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?(this.bgmVolume=t,void T2MediaLib.setSEVolume(e,t)):null},T2MediaLib_BGMPlayer.prototype.setBGMTempo=function(t){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?(0===this.bgmPause&&(e.plusTime-=(T2MediaLib.context.currentTime-e.playStartTime)*(t-this.bgmTempo)),this.bgmTempo=t,void T2MediaLib.setSERate(e,t)):null},T2MediaLib_BGMPlayer.prototype.getBGMCurrentTime=function(){var t=this.playingBGM;if(!(t instanceof AudioBufferSourceNode))return null;var e,n,r,i,o,s,a;return 0===this.bgmPause?(r=T2MediaLib.context.currentTime,i=this.bgmTempo):(r=this.bgmPauseCurrentTime,i=this.bgmPauseTempo),n=(r-t.playStartTime)*i+t.plusTime,t.loop&&(t.loopEnd-t.loopStart>0?n<t.loopStart?(o=0,s=0,a=t.buffer.duration):(o=t.loopStart,s=t.loopStart,a=t.loopEnd-t.loopStart):(a=t.buffer.duration,o=0,s=0)),t.loop?e=(n-s)%a+o:(e=n,e>t.buffer.duration&&(e=t.buffer.duration)),e},T2MediaLib_BGMPlayer.prototype.getBGMLength=function(){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?t.buffer.duration:null};var T2MediaLib={context:null,seDataAry:{data:[]},bgmPlayerMax:16,bgmPlayerAry:[],playingBGM:null,playingBGMName:null,bgmPause:0,bgmPauseTime:0,bgmPauseCurrentTime:0,bgmPauseTempo:0,bgmPauseLoop:!1,bgmPauseLoopStart:0,bgmPauseLoopEnd:0,bgmVolume:1,bgmTempo:1,playingAudio:null,audioVolume:1,audioTempo:1,audioDataAry:{data:[]},init:function(){if(!this.inited&&(this.inited=!0,!this.disabled&&(window.AudioContext?T2MediaLib.context=new AudioContext:window.webkitAudioContext?T2MediaLib.context=new webkitAudioContext:(T2MediaLib.context=null,console.log("Your browser does not support yet Web Audio API")),T2MediaLib.context)))for(var t=0;t<T2MediaLib.bgmPlayerMax;t++)T2MediaLib.bgmPlayerAry[t]=new T2MediaLib_BGMPlayer(t)},allClearData:function(){var t=T2MediaLib.seDataAry.data;for(var e in t)delete t[e]},clearData:function(t){var e=T2MediaLib.seDataAry.data;delete e[t]},loadSEFromArray:function(t,e){for(var n=T2MediaLib.context,r=n.createBuffer(1,e.length,n.sampleRate),i=r.getChannelData(0),o=0;o<e.length;o++)i[o]=e[o];T2MediaLib.seDataAry.data[t]=r},loadSE:function(t,e,n){if(!T2MediaLib.context||T2MediaLib.disabled)return T2MediaLib.seDataAry.data[t]=-1,null;"object"==typeof WebSite&&WebSite.mp3Disabled&&(e=e.replace(/\.mp3$/,".ogg"));var r=new XMLHttpRequest;r.onload=function(){if(200===r.status||0===r.status){var i=r.response;if(i instanceof ArrayBuffer){var o=function(e){T2MediaLib.seDataAry.data[t]=e,n&&n.succ&&n.succ(t)},s=function(r){r instanceof Error?console.log("T2MediaLib: "+r.message,e):console.log("T2MediaLib: Error decodeAudioData()",e),T2MediaLib.seDataAry.data[t]=-4,n&&n.err&&n.err(t,T2MediaLib.seDataAry.data[t])};T2MediaLib.context.decodeAudioData(i,o,s)}else T2MediaLib.seDataAry.data[t]=-3,n&&n.err&&n.err(t,T2MediaLib.seDataAry.data[t])}else T2MediaLib.seDataAry.data[t]=-2,n&&n.err&&n.err(t,T2MediaLib.seDataAry.data[t])},r.onerror=function(e){n&&n.err&&n.err(t,e+"")},T2MediaLib.seDataAry.data[t]=null,e.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer?(r={onload:r.onload},r.response=Util.Base64_To_ArrayBuffer(e.replace(/^data:audio\/[a-zA-Z0-9]+;base64,/i,"")),r.status=200,r.onload()):(r.open("GET",e,!0),r.responseType="arraybuffer",r.send(null))},activate:function(){if(this.init(),!this.isActivated){this.isActivated=!0;for(var t=T2MediaLib.context,e=t.createBuffer(1,Math.floor(t.sampleRate/32),t.sampleRate),n=e.getChannelData(0),r=Math.floor(t.sampleRate/860),i=0;i<n.length;i++)n[i]=(r/2>i%r?.1:-.1)*(r>i?2:1);var o=t.createBufferSource();o.buffer=e,o.connect(t.destination),o.noteOn?o.noteOn(0):o.start&&o.start(0)}},playSE:function(t,e,n,r,i,o,s){if(!T2MediaLib.context)return null;var a=T2MediaLib.seDataAry.data[t];if(!(a instanceof AudioBuffer))return null;null===e&&(e=1),n||(n=1),r?r>a.duration?r=a.duration:0>r&&(r=0):r=0,i||(i=!1),o?0>o?o=0:o>a.duration&&(o=a.duration):o=0,s?0>s?s=0:s>a.duration&&(s=a.duration):s=a.duration;var u=T2MediaLib.context.createBufferSource();T2MediaLib.context.createGain=T2MediaLib.context.createGain||T2MediaLib.context.createGainNode;var f=T2MediaLib.context.createGain();u.buffer=a,u.loop=i,u.loopStart=o,u.loopEnd=s,u.playbackRate.value=n,u.connect(f),f.connect(T2MediaLib.context.destination);var c;return c=i&&s-o>0&&r>s?s:r,u.gainNode=f,u.playStartTime=T2MediaLib.context.currentTime,u.playOffset=c,u.plusTime=c,u.start=u.start||u.noteOn,u.stop=u.stop||u.noteOff,f.gain.value=e*e,r?i?u.start(0,r,86400):u.start(0,r):u.start(0),u.onended=function(){delete u.gainNode,u.onended=null},u},stopSE:function(t){return t instanceof AudioBufferSourceNode?(t.stop(0),t):null},setSEVolume:function(t,e){return t instanceof AudioBufferSourceNode?void(t.gainNode.gain.value=e*e):null},setSERate:function(t,e){return t instanceof AudioBufferSourceNode?void(t.playbackRate.value=e):null},getSEData:function(t){return T2MediaLib.seDataAry.data[t]},loadBGM:function(t,e,n){return T2MediaLib.loadSE(t,e,n)},playBGM:function(t,e,n,r,i,o){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var s=T2MediaLib.bgmPlayerAry[t];return s instanceof T2MediaLib_BGMPlayer?s.playBGM(e,n,r,i,o):null},stopBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.stopBGM():null},pauseBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.pauseBGM():null},resumeBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.resumeBGM():null},setBGMVolume:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var n=T2MediaLib.bgmPlayerAry[t];return n instanceof T2MediaLib_BGMPlayer?n.setBGMVolume(e):null},setBGMTempo:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var n=T2MediaLib.bgmPlayerAry[t];return n instanceof T2MediaLib_BGMPlayer?n.setBGMTempo(e):null},getBGMCurrentTime:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMCurrentTime():null},getBGMLength:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMLength():null},getBGMData:function(t){return T2MediaLib.getSEData(t)},getBGMPlayerMax:function(){return T2MediaLib.bgmPlayerMax},allStopBGM:function(){for(var t=0;t<T2MediaLib.bgmPlayerMax;t++)T2MediaLib.stopBGM(t)},loadAudio:function(t,e){var n=new Audio(e);n.play(),T2MediaLib.audioDataAry.data[t]=null,n.addEventListener("loadstart",function(){if(!T2MediaLib.context)return null;var t=T2MediaLib.context.createMediaElementSource(n);t.connect(T2MediaLib.context.destination)},!1),n.addEventListener("canplay",function(){T2MediaLib.audioDataAry.data[t]=n},!1),n.load()},playAudio:function(t,e,n){var r=T2MediaLib.audioDataAry.data[t];return r?(n||(n=0),T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.pause(),T2MediaLib.playingAudio.currentTime=0),T2MediaLib.playingAudio=r,r.loop=e,r.volume=T2MediaLib.audioVolume,r.currentTime=n,r.play(),r):null},stopAudio:function(){var t=T2MediaLib.playingAudio;return t instanceof Audio?(t.pause(),t.currentTime=0,T2MediaLib.playingAudio=null,t):null},pauseAudio:function(){var t=T2MediaLib.playingAudio;return t?(t.pause(),t):null},resumeAudio:function(){var t=T2MediaLib.playingAudio;return t?(t.play(),t):null},setAudioVolume:function(t){T2MediaLib.audioVolume=t,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.volume=t)},setAudioTempo:function(t){T2MediaLib.audioTempo=t,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.playbackRate=t)},setAudioPosition:function(t){T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.currentTime=t)},getAudioData:function(t){return T2MediaLib.audioDataAry.data[t]},getAudioCurrentTime:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.currentTime:null},getAudioLength:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.duration:null}};requireSimulator.setName("runtime"),requirejs(["ImageList","T2MediaLib","Tonyu","Tonyu.Iterator"],function(){}),requireSimulator.setName("runScript"),requirejs(["FS","Tonyu.Project","Shell","KeyEventChecker","ScriptTagFS","runtime","WebSite","LSFS"],function(t,e,n,r,i,o,s,a){$(function(){function r(){c=$(window).width(),l=$(window).height(),p.attr({width:c-10,height:l-10})}function o(){Tonyu.currentProject=Tonyu.globals.$currentProject=S;var t=S.getOptions();t.compiler&&t.compiler.diagnose&&(t.compiler.diagnose=!1,S.setOptions(t)),S.runScriptMode=!0,S.rawRun(t.run.bootClass)}var u=t.get(s.tonyuHome),f=t.get("/ram/");t.mount(f.path(),a.ramDisk()),Tonyu.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32}],sounds:[]},SplashScreen={hide:function(){$("#splash").hide()},show:function(){}};var c=$(window).width(),l=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var p=$("<canvas>").attr({width:c-10,height:l-10}).appendTo("body");$(window).resize(r);var h=location.href.replace(/\?.*/,"").split(/\//),d=h.pop()||"runscript",m=h.pop()||"nobody",g=f,v=u.rel(m+"/"+d+"/");f.rel("files/").link(v);var y=i.toObj();for(var b in y){var x=g.rel(b);if(!x.isDir()){var T=y[b];x.text(T.text),delete T.text,T.lastUpdate&&x.metaInfo(T)}}n.cd(g),Tonyu.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:"Main",bootClass:"Boot"},kernelEditable:!1};var S=e(g);o()})}),requireSimulator.setName();