!function(){var e={};return e.def=function(t,n,r){var i=e.getModuleInfo(e.curName);i.type=r,e.setReqs(i,t),i.func=function(){return n.apply(this,e.getObjs(t))},e.loadIfAvailable(i)},define=function(t,n){e.def(t,n,"define")},requirejs=function(t,n){e.def(t,n,"require")},e.setReqs=function(t,n){n.forEach(function(n){var r=e.getModuleInfo(n);r.loaded||(t.reqs[n]=r,r.revReqs[t.name]=t)})},e.getModuleInfo=function(t){var n=e.modules;return n[t]||(n[t]={name:t,reqs:{},revReqs:{}}),n[t]},e.doLoad=function(t){var n=e.getModuleInfo(t);if(n.loaded)return n.obj;n.loaded=!0;var r=null;if(n.func)r=n.func();else{var i=t.split(/\./);r=function(){return this}(),i.forEach(function(e){r&&(r=r[e])}),null==r&&console.log("Warning: No obj for "+t)}if("define"==n.type&&null==r)throw"No obj for "+t;n.obj=r;for(var o in n.revReqs)e.notifyLoaded(n.revReqs[o],n.name);return r},e.notifyLoaded=function(t,n){delete t.reqs[n],e.loadIfAvailable(t)},e.loadIfAvailable=function(t){for(var n in t.reqs)return;e.doLoad(t.name)},e.getObjs=function(t){var n=[];return t.forEach(function(t){var r=e.doLoad(t);n.push(r)}),n},e.modules={},e.setName=function(t){e.curName&&(e.getModuleInfo(e.curName).func||e.doLoad(e.curName)),t&&(e.curName=t)},requireSimulator=e,e}(),requireSimulator.setName("extend"),define([],function(){return function(e,t){for(var n in t)e[n]=t[n]}}),requireSimulator.setName("assert"),define([],function(){function e(t){if(t instanceof Array){var n=[];return t.forEach(function(t){n=n.concat(e(t))}),n}return[t]}var t,n=function(t){this.failMesg=e(t||"Assertion failed: ")};n.prototype={fail:function(){var n=t(arguments);throw n=e(n),n=this.failMesg.concat(n),console.log.apply(console,n),new Error(n.join(" "))},subAssertion:function(){var r=t(arguments);return r=e(r),new n(this.failMesg.concat(r))},assert:function(e,t){return e||this.fail(t),e},eq:function(e,t){return e!==t&&this.fail(e,"!==",t),e},ne:function(e,t){return e===t&&this.fail(e,"===",t),e},isset:function(e,t){return null==e&&this.fail((t||"")+" is null/undef"),e},is:function(e,t){var n=t,r=e;if(null==n&&this.fail("assert.is: type must be set"),n._assert_func)return n._assert_func.apply(this,[r]),e;if(this.assert(null!=e,[e,"should be ",n]),n instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&n instanceof global.Array){e&&"number"==typeof e.length||this.fail(e,"should be array:");for(var i=this,o=0;o<n.length;o++){var s=i.subAssertion("failed at ",e,"[",o,"]: ");null==n[o]&&console.log("WOW!7",r[o],n[o]),s.is(r[o],n[o])}return e}if(n===String||"string"==n)return this.assert("string"==typeof r,[r,"should be a string "]),e;if(n===Number||"number"==n)return this.assert("number"==typeof r,[r,"should be a number"]),e;if(n instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&n instanceof global.RegExp)return this.is(r,String),this.assert(n.exec(r),[r,"does not match to",n]),e;if("function"==typeof n)return this.assert(r instanceof n,[r,"should be ",n]),e;if(n&&"object"==typeof n){for(var a in n){var s=this.subAssertion("failed at ",e,".",a,":");s.is(e[a],n[a])}return e}this.fail("Invaild type: ",n)},ensureError:function(e,t){try{e()}catch(n){return"string"==typeof t&&i(n+""===t,e+" thrown an error "+n+" but expected:"+t),void console.log("Error thrown successfully: ",n.message)}this.fail(e,"should throw an error",t)}},t=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t};var r=new n,i=function(){try{return r.assert.apply(r,arguments)}catch(e){throw new Error(e.message)}};return["is","isset","ne","eq","ensureError"].forEach(function(e){i[e]=function(){try{return r[e].apply(r,arguments)}catch(t){throw console.log(t.stack),new Error(t.message)}}}),i.fail=r.fail.bind(r),i.f=function(e){return{_assert_func:e}},i.and=function(){var e=t(arguments);return i(e instanceof Array),i.f(function(t){for(var n=this,r=0;r<e.length;r++)n.is(t,e[r])})},i}),requireSimulator.setName("PathUtil"),define(["assert"],function(e){function t(t,n){return e.is(arguments,[String,String]),t.substring(t.length-n.length)===n}function n(t,n){return e.is(arguments,[String,String]),t.substring(0,n.length)===n}var r,i=/^([a-zA-Z]):/,o=/^([a-z]+):\/\/\/?([^\/]+)\//,s=e.f(function(e){this.is(e,String),this.assert(r.isPath(e),[e," is not a path"])}),a=e.f(function(e){this.is(e,String),this.assert(r.isAbsolutePath(e),[e," is not a absolute path"])}),u=e.f(function(e){this.is(e,String),this.assert(!r.isAbsolutePath(e),[e," is not a relative path"])}),c=e.f(function(e){this.is(e,s),this.assert(r.isDir(e),[e," is not a directory path"])}),f=e.and(c,a),l=e.f(function(e){this.is(e,s),this.assert(!r.isDir(e),[e," is not a file path"])}),p="/";return r={Path:s,Absolute:a,Relative:u,Dir:c,File:l,AbsDir:f,SEP:p,endsWith:t,startsWith:n,hasDriveLetter:function(e){return i.exec(e)},isURL:function(e){var t=o.exec(e);if(t)return{protocol:t[1],hostPort:t[2],path:p+e.substring(t[0].length)}},isPath:function(){return e.is(arguments,[String]),!0},isRelativePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&!r.isAbsolutePath(t)},isAbsolutePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&(r.startsWith(t,p)||r.hasDriveLetter(t)||r.isURL(t))},isDir:function(n){return n=r.fixSep(n),e.is(arguments,[s]),t(n,p)},fixSep:function(t){return e.is(arguments,[String]),e.is(t.replace(/\\/g,"/"),s)},directorify:function(t){return t=r.fixSep(t),r.isDir(t)?t:e.is(t+p,c)},filify:function(t){return t=r.fixSep(t),r.isDir(t)?e.is(t.substring(0,t.length-1),l):t},splitPath:function(t){e.is(arguments,[s]);var n;if(n=this.isURL(t)){var r=this.splitPath(n.path);return r[0]=n.protocol+"://"+n.hostPort,r}t=t.replace(/\/+/g,p);var i=t.split(p);return""==i[i.length-1]&&(i[i.length-2]+=p,i.pop()),i},name:function(t){return e.is(arguments,[String]),r.splitPath(t).pop()},ext:function(t){e.is(arguments,[String]);var n=r.name(t),i=/\.[a-zA-Z0-9]+$/.exec(n);return i?i[0]:null},truncExt:function(t,n){e.is(t,String);var i=r.name(t);return n=n||r.ext(t),e.is(n,String),i.substring(0,i.length-n.length)},truncSEP:function(t){return e.is(arguments,[s]),r.isDir(t)?t.substring(0,t.length-1):t},endsWith:function(n,i){return e.is(arguments,[String,String]),t(r.name(n),i)},parent:function(t){return e.is(arguments,[String]),r.up(t)},rel:function(t,n){if(""==n)return t;e.is(arguments,[f,u]);var i=r.splitPath(n),o=t;o=o.replace(/\/$/,"");var s=r;return i.forEach(function(e){".."==e||"../"==e?o=s.up(o):(o=o.replace(/\/$/,""),o+=p+("."==e||"./"==e?"":e))}),o},relPath:function(t,n){return e.is(arguments,[a,a]),t.substring(0,n.length)!=n?"../"+r.relPath(t,this.up(n)):t.substring(n.length)},up:function(e){if(e=r.fixSep(e),e==p)return null;var t=r.splitPath(e);return t.pop(),t.join(p)+p}},r.isAbsolute=r.isAbsolutePath,r.isRelative=r.isRelativePath,"object"==typeof window&&(window.PathUtil=r),r}),requireSimulator.setName("MIMETypes"),define([],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".mp3":"audio/mp3",".ogg":"audio/ogg",".mp4":"video/mp4",".m4a":"audio/x-m4a",".mid":"audio/mid",".midi":"audio/mid",".wav":"audio/wav",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu"}}),requireSimulator.setName("FS2"),define(["extend","PathUtil","MIMETypes","assert"],function(e,t,n,r){function i(e){throw new Error(e+" is STUB!")}var o=function(){},s={};return o.addFSType=function(e,t){s[e]=t},o.availFSTypes=function(){return s},e(o.prototype,{err:function(e,t){throw new Error(e+": "+t)},fstype:function(){return"Unknown"},isReadOnly:function(){i("isReadOnly")},supportsSync:function(){return!0},resolveFS:function(e){return r(this.getRootFS()!==this),this.getRootFS().resolveFS(e)},mounted:function(e,t){this.rootFS=e,this.mountPoint=t},inMyFS:function(e){return!this.mountPoint||t.startsWith(e,this.mountPoint)},getRootFS:function(){return r(this.rootFS,"rootFS is not set")},getReturnTypes:function(){i("")},getContent:function(){i("getContent")},getContentAsync:function(){return this.supportsSync()||i("getContentAsync"),$.when(this.getContent.apply(this,arguments))},setContent:function(){i("")},setContentAsync:function(e,t,n){var r=this;return r.supportsSync()||i("setContentAsync"),$.when(t).then(function(t){return $.when(r.setContent(e,t,n))})},getMetaInfo:function(){i("")},setMetaInfo:function(){i("")},mkdir:function(){i("mkdir")},touch:function(){i("touch")},exists:function(){i("exists")},opendir:function(){i("opendir")},cp:function(e,n,i){r.is(arguments,[t.Absolute,t.Absolute]),this.assertExist(e),i=i||{};var o=this.isDir(e),s=this.getRootFS().resolveFS(n),a=s.isDir(n);if(o||a)throw new Error("only file to file supports");if(this.supportsSync()&&s.supportsSync()){var u=this.getContent(e),c=s.setContent(n,u);return i.a&&s.setMetaInfo(n,this.getMetaInfo(e)),c}return s.setContentAsync(n,this.getContentAsync(e)).then(function(t){return i.a?s.setMetaInfo(n,this.getMetaInfo(e)):t})},mv:function(e,t,n){return this.cp(e,t,n),this.rm(e,{r:!0})},rm:function(){i("")},link:function(e,t){throw new Error("ln "+t+" "+e+" : This FS not support link.")},getURL:function(){i("")}}),o.delegateMethods=function(e,n){for(var i in n)!function(i){r.ne(i,"inMyFS"),e[i]=function(){var e=arguments[0];r.is(e,t.Absolute);var o=this.resolveFS(e);return o!==this?o[i].apply(o,arguments):n[i].apply(this,arguments)}}(i)},o.delegateMethods(o.prototype,{assertWriteable:function(e){this.isReadOnly(e)&&this.err(e,"read only.")},getContentType:function(e,r){var i=(t.ext(e)+"").toLowerCase();return n[i]||(r||{}).def||"text/plain"},isText:function(e){var n=this.getContentType(e);return t.startsWith(n,"text")},assertExist:function(e,n){this.exists(e,n)||this.err(e,": No such "+(t.isDir(e)?"directory":"file"))},isDir:function(e){return t.isDir(e)},find:function(e,n){r.is(arguments,[t.Absolute]);var i=this.opendir(e,n),o=this,s=[e];return i.forEach(function(r){var i=t.rel(e,r);if(t.isDir(i)){var a=o.resolveFS(i);s=s.concat(a.find(i,n))}else s.push(i)}),s},resolveLink:function(e){r.is(e,t.Absolute);for(var n=e;n;n=t.up(n)){r(!this.mountPoint||t.startsWith(n,this.mountPoint),n+" is out of mountPoint. path="+e);var i=this.isLink(n);if(i){r(i!=n,"l==p=="+i);var o=t.rel(i,t.relPath(e,n));return r(o!=e,"np==path=="+o),r.is(this.getRootFS().resolveFS(o).resolveLink(o),t.Absolute)}if(this.exists(n))return e}return e},isLink:function(){return null}}),o}),requireSimulator.setName("WebSite"),define(["PathUtil"],function(e){var t,n=document.location.href,r=!!n.match(/html\/dev\//)&&!!n.match(/localhost:3/);t=n.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:r,pluginTop:"http://tonyuedit.appspot.com/js/plugins",removeJSOutput:!0}:n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)||n.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:r}:{urlAliases:{},top:".",devMode:r};var i=window.navigator.userAgent.toLowerCase();return t.tablet=-1!=i.indexOf("windows")&&-1!=i.indexOf("touch")||-1!=i.indexOf("ipad")||-1!=i.indexOf("android")&&-1==i.indexOf("mobile")||-1!=i.indexOf("firefox")&&-1!=i.indexOf("tablet")||-1!=i.indexOf("kindle")||-1!=i.indexOf("silk")||-1!=i.indexOf("playbook"),t.mobile=-1!=i.indexOf("windows")&&-1!=i.indexOf("phone")||-1!=i.indexOf("iphone")||-1!=i.indexOf("ipod")||-1!=i.indexOf("android")&&-1!=i.indexOf("mobile")||-1!=i.indexOf("firefox")&&-1!=i.indexOf("mobile")||-1!=i.indexOf("blackberry"),t.pluginTop||(t.pluginTop=t.top+"/js/plugins"),t.disableROM={},n.match(/tonyuedit\.appspot\.com/)||n.match(/localhost:8888/),(n.match(/\.appspot\.com/)||n.match(/localhost:888[87]/))&&(t.serverType="GAE"),n.match(/localhost:3000/)&&(t.serverType="Node"),t.serverTop=n.match(/tonyuexe\.appspot\.com/)||n.match(/localhost:8887/)?t.top+"/exe":t.top+"/edit",t.sampleImg=t.top+"/images",t.blobPath=t.serverTop+"/serveBlob",t.isNW="object"==typeof process&&process.__node_webkit,t.mp3Disabled=t.isNW,t.tonyuHome="/Tonyu/",t.url={getDirInfo:t.serverTop+"/getDirInfo",getFiles:t.serverTop+"/File2LSSync",putFiles:t.serverTop+"/LS2FileSync"},t.isNW?(t.cwd=e.directorify(process.cwd()),t.tonyuHome=process.env.TONYU_HOME?e.directorify(process.env.TONYU_HOME):e.rel(t.cwd,"fs/Tonyu/"),t.logdir=process.env.TONYU_LOGDIR,t.wwwDir=e.rel(t.cwd,"www/"),t.platform=process.platform,t.ffmpeg=e.rel(t.cwd,"win32"==t.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),t.pkgInfo=require(e.rel(t.cwd,"package.json")),t.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):t.pkgInfo&&t.pkgInfo.config&&t.pkgInfo.config.prjDirs?t.pkgInfo.config.prjDirs.map(function(n){return n=e.directorify(n),e.isAbsolute(n)?n:e.rel(t.cwd,n)}):[e.rel(t.cwd,"Projects/"),e.rel(t.tonyuHome,"Projects/")],t.kernelDir=e.rel(t.wwwDir,"Kernel/")):(t.wwwDir=location.protocol+"//"+location.host+"/",t.projects=[e.rel(t.tonyuHome,"Projects/")]),(n.match(/tonyuedit\.appspot\.com/)||n.match(/localhost:888/))&&(t.kernelDir=location.protocol+"//"+location.host+"/Kernel/"),t.compiledKernel=n.match(/tonyuedit\.appspot\.com/)||n.match(/localhost:888/)||t.isNW?t.top+"/Kernel/js/concat.js":"http://tonyuexe.appspot.com/Kernel/js/concat.js",window.WebSite=t}),requireSimulator.setName("Util"),Util=function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?n:t(i[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function r(e,t){return e.substring(0,t.length)===t}function i(e){function t(t){throw console.log(t),console.log(e,c),new Error(t)}e=e.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=e.length,o=0,s=0;if(!i)return new ArrayBuffer(0);r=Math.floor(i/4*3),"="==e.charAt(i-1)&&(r-=1),"="==e.charAt(i-2)&&(r-=1);for(var a=new ArrayBuffer(r),u=new Uint8Array(a),c=0,f=0;r>f&&(s=n[e.charCodeAt(c)],void 0===s&&t("Invalid letter: "+e.charCodeAt(c)),o=s<<2,c++,s=n[e.charCodeAt(c)],void 0===s&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|s>>4&3,o=(15&s)<<4,c++,f++,!(f>=r))&&(s=n[e.charCodeAt(c)],void 0===s&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|s>>2&15,o=(3&s)<<6,c++,f++,!(f>=r));)s=n[e.charCodeAt(c)],void 0===s&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|s,c++,f++;return a}function o(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(e),i=r.length,o=0,s=0,a=0;i>a&&(s=r[a],n+=t[s>>2],o=(3&s)<<4,a++,!(a>=i))&&(s=r[a],n+=t[o|s>>4],o=(15&s)<<2,a++,!(a>=i));)s=r[a],n+=t[o|s>>6],n+=t[63&s],a++;var u=i%3;return u&&(n+=t[o]),1==u?n+="==":2==u&&(n+="="),n}function s(e){if(e.__privatized)return e;var t={__privatized:!0};for(var n in e)!function(n){var r=e[n];n.match(/^_/)||"function"==typeof r&&(t[n]=function(){var t=r.apply(e,arguments);return t})}(n);return t}function a(){return"undefined"!=typeof Buffer}function u(e){return a()&&e instanceof Buffer}function c(e){return e instanceof ArrayBuffer||u(e)}function f(e){for(var t=[],n=0;n<e.length;n++)t.push("%"+("0"+e[n].toString(16)).slice(-2));try{return decodeURIComponent(t.join(""))}catch(r){throw console.log(t.join("")),r}}function l(e,t){for(var n=encodeURIComponent(e),r=/^%(..)/,i=[],o=0;o<n.length;o++){var s=r.exec(n.substring(o));s?(i.push(parseInt("0x"+s[1])),o+=s[0].length-1):i.push(n.charCodeAt(o))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(i):new Uint8Array(i).buffer}return{getQueryString:e,endsWith:n,startsWith:r,Base64_To_ArrayBuffer:i,Base64_From_ArrayBuffer:o,utf8bytes2str:f,str2utf8bytes:l,privatize:s,hasNodeBuffer:a,isNodeBuffer:u,isBuffer:c}}(),requireSimulator.setName("DataURL"),define(["extend","assert","Util"],function(e,t,n){function r(e,t){function r(t){throw console.log(t),console.log(e,p),new Error(t)}var i=t;e=e.replace(/[\n=]/g,"");var o=new Object;o[65]=0,o[66]=1,o[67]=2,o[68]=3,o[69]=4,o[70]=5,o[71]=6,o[72]=7,o[73]=8,o[74]=9,o[75]=10,o[76]=11,o[77]=12,o[78]=13,o[79]=14,o[80]=15,o[81]=16,o[82]=17,o[83]=18,o[84]=19,o[85]=20,o[86]=21,o[87]=22,o[88]=23,o[89]=24,o[90]=25,o[97]=26,o[98]=27,o[99]=28,o[100]=29,o[101]=30,o[102]=31,o[103]=32,o[104]=33,o[105]=34,o[106]=35,o[107]=36,o[108]=37,o[109]=38,o[110]=39,o[111]=40,o[112]=41,o[113]=42,o[114]=43,o[115]=44,o[116]=45,o[117]=46,o[118]=47,o[119]=48,o[120]=49,o[121]=50,o[122]=51,o[48]=52,o[49]=53,o[50]=54,o[51]=55,o[52]=56,o[53]=57,o[54]=58,o[55]=59,o[56]=60,o[57]=61,o[43]=62,o[47]=63;var s,a=e.length,u=0,c=0;if(!a)return new i(0);s=Math.floor(a/4*3),"="==e.charAt(a-1)&&(s-=1),"="==e.charAt(a-2)&&(s-=1);for(var f=new i(s),l=n.isNodeBuffer(f)?f:new Uint8Array(f),p=0,h=0;s>h&&(c=o[e.charCodeAt(p)],void 0===c&&r("Invalid letter: "+e.charCodeAt(p)),u=c<<2,p++,c=o[e.charCodeAt(p)],void 0===c&&r("Invalid letter: "+e.charCodeAt(p)),l[h]=u|c>>4&3,u=(15&c)<<4,p++,h++,!(h>=s))&&(c=o[e.charCodeAt(p)],void 0===c&&r("Invalid letter: "+e.charCodeAt(p)),l[h]=u|c>>2&15,u=(3&c)<<6,p++,h++,!(h>=s));)c=o[e.charCodeAt(p)],void 0===c&&r("Invalid letter: "+e.charCodeAt(p)),l[h]=u|c,p++,h++;return t===Uint8Array?l:f}function i(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],r="",i=n.isNodeBuffer(e)?e:new Uint8Array(e),o=i.length,s=0,a=0,u=0;o>u&&(a=i[u],r+=t[a>>2],s=(3&a)<<4,u++,!(u>=o))&&(a=i[u],r+=t[s|a>>4],s=(15&a)<<2,u++,!(u>=o));)a=i[u],r+=t[s|a>>6],r+=t[63&a],u++;var c=o%3;return c&&(r+=t[s]),1==c?r+="==":2==c&&(r+="="),r}var o=n.hasNodeBuffer()?Buffer:ArrayBuffer,s=(n.isNodeBuffer,n.isBuffer),a=function(e,n){"string"==typeof e?(this.url=e,this.binType=n||o,this.dataURL2bin(e)):e&&s(e.buffer)?(this.buffer=e.buffer,t.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):s(e)?(this.buffer=e,t.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):(console.log(arguments),t.fail("Invalid args: ",arguments))};return a.isBuffer=s,e(a.prototype,{bin2dataURL:function(e,n){t(s(e)),t.is(n,String);var r=this.dataHeader(n),o=i(e);return t.is(o,String),this.url=r+o},dataURL2bin:function(e){t.is(arguments,[String]);var n=/^data:([^;]+);base64,/i,i=n.exec(e);return t(i,["malformed dataURL:",e]),this.contentType=i[1],this.buffer=r(e.substring(i[0].length),this.binType),t.is(this.buffer,this.binType)},dataHeader:function(e){return t.is(arguments,[String]),"data:"+e+";base64,"},toString:function(){return t.is(this.url,String)}}),a}),requireSimulator.setName("Content"),define(["DataURL","Util","assert"],function(e,t,n){var r=function(){},i=(t.isNodeBuffer,t.isBuffer);r.plainText=function(e,t){var n=new r;return n.contentType=t||"text/plain",n.plain=e,n},r.url=function(e){var t=new r;return t.url=e,t},r.buffer2ArrayBuffer=function(e){return t.isBuffer(e)?n(new Uint8Array(e).buffer,"n2a: buf is not set"):n(e,"n2a: a is not set")},r.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return n(e,"a2n: a is not set")},r.bin=function(e,o){n(o,"contentType should be set");var s=new r;if(e&&i(e.buffer))s.arrayBuffer=e.buffer;else if(t.isNodeBuffer(e))s.nodeBuffer=e;else{if(!(e instanceof ArrayBuffer))throw new Error(e+" is not a bin");s.arrayBuffer=e}return s.contentType=o,s};var o=r.prototype;return o.toBin=function(n){if(n=n||(t.hasNodeBuffer()?Buffer:ArrayBuffer),this.nodeBuffer)return n===Buffer?this.nodeBuffer:this.arrayBuffer=r.buffer2ArrayBuffer(this.nodeBuffer);if(this.arrayBuffer)return n===ArrayBuffer?this.arrayBuffer:this.nodeBuffer=r.arrayBuffer2Buffer(this.arrayBuffer);if(this.url){var i=new e(this.url,n);return this.setBuffer(i.buffer)}if(null!=this.plain)return this.setBuffer(t.str2utf8bytes(this.plain,n));throw new Error("No data")},o.setBuffer=function(e){return n(e,"b is not set"),t.isNodeBuffer(e)?this.nodeBuffer=e:this.arrayBuffer=e},o.toArrayBuffer=function(){return this.toBin(ArrayBuffer)},o.toNodeBuffer=function(){return this.toBin(Buffer)},o.toURL=function(){if(this.url)return this.url;if(this.arrayBuffer||null==this.plain||(this.arrayBuffer=t.str2utf8bytes(this.plain,ArrayBuffer)),this.arrayBuffer||this.nodeBuffer){var n=new e(this.arrayBuffer||this.nodeBuffer,this.contentType);return this.url=n.url}throw new Error("No data")},o.toPlainText=function(){if(null!=this.plain)return this.plain;if(this.url&&!this.hasBin()){var n=new e(this.url,ArrayBuffer);this.arrayBuffer=n.buffer}if(this.hasBin())return this.plain=t.utf8bytes2str(this.nodeBuffer||new Uint8Array(this.arrayBuffer));throw new Error("No data")},o.hasURL=function(){return this.url},o.hasPlainText=function(){return null!=this.plain},o.hasBin=function(){return this.nodeBuffer||this.arrayBuffer},o.hasNodeBuffer=function(){return this.nodeBuffer},o.hasArrayBuffer=function(){return this.arrayBuffer},r}),requireSimulator.setName("NativeFS"),define(["FS2","assert","PathUtil","extend","MIMETypes","DataURL","Content"],function(e,t,n,r,i,o,s){var a="object"==typeof process&&process.__node_webkit;if(!a)return function(){throw new Error("This system not suppert native FS")};var u=t,c=require("fs"),f=function(e){e&&(t.is(e,n.AbsDir),this.rootPoint=e)},l=n.hasDriveLetter(process.cwd());f.available=!0;var p=n.SEP,h=f.prototype=new e;return h.toNativePath=function(e){return this.rootPoint?(t.is(e,n.Absolute),t(this.inMyFS(e),e+" is not fs of "+this),n.rel(this.rootPoint,n.relPath(e,this.mountPoint||n.SEP))):e},h.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return e},e.addFSType("NativeFS",function(e,t){return new f(t.r)}),f.prototype.fstype=function(){return"Native"+(this.rootPoint?"("+this.rootPoint+")":"")},f.prototype.inMyFS=function(e){return this.mountPoint?n.startsWith(e,this.mountPoint):!(!!l^!!n.hasDriveLetter(e))},e.delegateMethods(f.prototype,{getReturnTypes:function(){return u.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(e,r){r=r||{},t.is(e,n.Absolute);var i=this.toNativePath(e);return this.assertExist(e),this.isText(e)?s.plainText(c.readFileSync(i,{encoding:"utf8"})):s.bin(c.readFileSync(i),this.getContentType(e))},setContent:function(e,r){t.is(arguments,[n.Absolute,s]);var i=n.up(e);i&&this.getRootFS().resolveFS(i).mkdir(i);var o=this.toNativePath(e);r.hasBin()||!r.hasPlainText()?c.writeFileSync(o,r.toNodeBuffer()):c.writeFileSync(o,r.toPlainText())},getMetaInfo:function(e,t){this.assertExist(e,t);var n=this.stat(e);return n.lastUpdate=n.mtime.getTime(),n},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(e){t.is(e,n.Absolute);var r=this.toNativePath(e);return c.statSync(r)},mkdir:function(e){if(u.is(arguments,[n.Absolute]),this.exists(e)){if(this.isDir(e))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(e);var t=n.up(e);t&&this.getRootFS().resolveFS(t).mkdir(t);var r=this.toNativePath(e);return c.mkdirSync(r),this.assertExist(r)},opendir:function(e){u.is(arguments,[String]);var t=this.toNativePath(e),r=n.truncSEP(t),i=c.readdirSync(t).map(function(e){var t=c.statSync(r+p+e),n=t.isDirectory()?p:"";return e+n}),o=[];return u.is(o.concat(i),Array)},rm:function(e,t){u.is(arguments,[n.Absolute]),t=t||{},this.assertExist(e);var r=this.toNativePath(e);return this.isDir(e)?c.rmdirSync(r):c.unlinkSync(r)},exists:function(e){var t=this.toNativePath(e);return c.existsSync(t)},isDir:function(e){return this.exists(e)?this.stat(e).isDirectory():n.isDir(e)},touch:function(e){!this.exists(e)&&this.isDir(e)?this.mkdir(e):this.exists(e)&&c.utimesSync(e,Date.now()/1e3,Date.now()/1e3)},getURL:function(e){return"file:///"+e.replace(/\\/g,"/")}}),f}),requireSimulator.setName("LSFS"),define(["FS2","PathUtil","extend","assert","Util","Content"],function(e,t,n,r,i,o){function s(){return(new Date).getTime()}var a=function(e,t){this.storage=e,this.options=t||{}},u=t.isDir.bind(t),c=t.up.bind(t),f=t.endsWith.bind(t),l=(t.Path,t.Absolute),p=t.SEP;return a.ramDisk=function(){var e={};return e[t.SEP]="{}",new a(e)},e.addFSType("localStorage",function(){return new a(localStorage)}),e.addFSType("ram",function(){return a.ramDisk()}),a.now=s,a.prototype=new e,a.prototype.resolveKey=function(e){return r.is(e,t.Absolute),this.mountPoint?t.SEP+t.relPath(e,this.mountPoint):e},a.prototype.getItem=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);return this.storage[n]},a.prototype.setItem=function(e,n){r.is(e,t.Absolute);var i=this.resolveKey(e);r(i.indexOf("..")<0),r(t.startsWith(i,t.SEP)),this.storage[i]=n},a.prototype.removeItem=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);delete this.storage[n]},a.prototype.itemExists=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);return n in this.storage},a.prototype.getDirInfo=function(e){if(r.is(arguments,[t.AbsDir]),null==e)throw new Error("getDir: Null path");f(e,p)||(e+=p),r(this.inMyFS(e));var n={};try{var i=this.getItem(e);i&&(n=JSON.parse(i))}catch(o){console.log("dinfo err : ",e,i)}return n},a.prototype.putDirInfo=function(e,n,i){if(r.is(arguments,[t.AbsDir,Object]),!u(e))throw new Error("Not a directory : "+e);r(this.inMyFS(e)),this.setItem(e,JSON.stringify(n));var o=c(e);if(null!=o&&this.inMyFS(o)){var s=this.getDirInfo(o);this._touch(s,o,t.name(e),i)}},a.prototype._touch=function(e,t,n,i){r.is(arguments,[Object,String,String]),r(this.inMyFS(t)),e[n]||(e[n]={},i&&(e[n].trashed=!0)),i||delete e[n].trashed,e[n].lastUpdate=s(),this.putDirInfo(t,e,i)},a.prototype.removeEntry=function(e,t,n){r.is(arguments,[Object,String,String]),e[n]&&(e[n]={lastUpdate:s(),trashed:!0},this.putDirInfo(t,e,!0))},a.prototype.removeEntryWithoutTrash=function(e,t,n){r.is(arguments,[Object,String,String]),e[n]&&(delete e[n],this.putDirInfo(t,e,!0))},a.prototype.isRAM=function(){return this.storage!==localStorage},a.prototype.fstype=function(){return this.isRAM()?"ramDisk":"localStorage"},e.delegateMethods(a.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return r.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(e){r.is(arguments,[l]),this.assertExist(e);var t;return t=this.isText(e)?o.plainText(this.getItem(e)):o.url(this.getItem(e))},setContent:function(e,t){r.is(arguments,[l,o]),this.assertWriteable(e),this.isText(e)?this.setItem(e,t.toPlainText()):this.setItem(e,t.toURL()),this.touch(e)},getMetaInfo:function(e){if(this.assertExist(e,{includeTrashed:!0}),r.is(arguments,[l]),e==t.SEP)return{};var n=r(t.up(e));if(!this.inMyFS(n))return{};var i=t.name(e);r.is(n,t.AbsDir);var o=this.getDirInfo(n);return r(o[i])},setMetaInfo:function(e,n){r.is(arguments,[String,Object]),this.assertWriteable(e);var i=r(t.up(e));if(this.inMyFS(i)){var o=this.getDirInfo(i),s=t.name(e);o[s]=n,this.putDirInfo(i,o,o[s].trashed)}},mkdir:function(e){r.is(arguments,[l]),this.assertWriteable(e),this.touch(e)},opendir:function(e,t){r.is(arguments,[String]),t=t||{};var n=this.getDirInfo(e),i=[];for(var o in n)r(n[o]),(!n[o].trashed||t.includeTrashed)&&i.push(o);return r.is(i,Array)},rm:function(e,n){r.is(arguments,[l]),n=n||{},this.assertWriteable(e);var i=t.up(e);if(null==i||!this.inMyFS(i))throw new Error(e+": cannot remove. It is root of this FS.");if(this.assertExist(e,{includeTrashed:n.noTrash}),t.isDir(e)){var o=this.opendir(e);o.length>0&&this.err(e,"Directory not empty"),n.noTrash&&this.removeItem(e)}else this.removeItem(e);var s=this.getDirInfo(i);n.noTrash?this.removeEntryWithoutTrash(s,i,t.name(e)):this.removeEntry(s,i,t.name(e))},exists:function(e,n){r.is(arguments,[l]),n=n||{};var i=t.name(e),o=t.up(e);if(null==o||!this.inMyFS(o))return!0;var s=this.getDirInfo(o),a=s[i];return a&&a.trashed&&this.itemExists(e)&&this.isDir(e),!a&&this.itemExists(e),a&&!a.trashed&&!a.link&&!this.itemExists(e),a&&!n.includeTrashed&&(a=!a.trashed),!!a},link:function(e,n){r.is(arguments,[t.Absolute,t.Absolute]),this.assertWriteable(e),this.exists(e)&&this.err(e,"file exists"),t.isDir(e)&&!t.isDir(n)&&this.err(e," can not link to file "+n),!t.isDir(e)&&t.isDir(n)&&this.err(e," can not link to directory "+n);var i={};i.link=n,i.lastUpdate=s(),this.setMetaInfo(e,i),r(this.exists(e)),r(this.isLink(e))},isLink:function(e){if(r.is(arguments,[t.Absolute]),!this.exists(e))return null;var n=r(this.getMetaInfo(e));return n.link},touch:function(e){r.is(arguments,[l]),this.assertWriteable(e),this.itemExists(e)||(t.isDir(e)?this.setItem(e,"{}"):this.setItem(e,""));var n=c(e);if(null!=n)if(this.inMyFS(n)){var i=this.getDirInfo(n);this._touch(i,n,t.name(e),!1)}else r(this.getRootFS()!==this),this.getRootFS().resolveFS(n).touch(n)},getURL:function(e){return this.getContent(e).toURL()}}),a}),requireSimulator.setName("Env"),define(["assert","PathUtil"],function(e,t){var n=function(e){this.value=e
};return n.prototype={expand:function(t){e.is(t,String);var n=this;return t.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,t){return n.get(t)})},expandPath:function(n){return e.is(n,String),n=this.expand(n),n=n.replace(/\/+/g,"/"),n=n.replace(/^[a-z][a-z]+:\//,function(e){return e+"/"}),e.is(n,t.Path)},get:function(e){return this.value[e]},set:function(e,t){this.value[e]=t}},n}),requireSimulator.setName("SFile"),define(["extend","assert","PathUtil","Util","Content","FS2"],function(e,t,n,r,i,o){var s=function(e,r){t.is(r,n.Absolute),this._path=r,this.rootFS=e,this.fs=e.resolveFS(r),this.act={},this.act.path=this.fs.resolveLink(r),this.act.fs=e.resolveFS(this.act.path),t.is(this.act,{fs:o,path:n.Absolute}),this.isDir()&&!n.isDir(r)&&(this._path+=n.SEP)};return s.is=function(e){return e&&"function"==typeof e.isSFile&&e.isSFile()},s.prototype={isSFile:function(){return!0},setPolicy:function(e){if(this.policy)throw new Error("policy already set");return this.policy=e,this._clone()},getPolicy:function(){return this.policy},_clone:function(){return this._resolve(this.path())},_resolve:function(e,i){var o;if(i=i||{},s.is(e))o=e;else{t.is(e,n.Absolute);var a,u=i.policy||this.policy;if(u&&(a=u.topDir)&&(a.path&&(a=a.path()),!n.startsWith(e,a)))throw new Error(e+": cannot access. Restricted to "+a);o=new s(this.rootFS,e),o.policy=u}return o.policy?r.privatize(o):o},contains:function(e){return t(s.is(e),e+" shoud be a SFile object."),this.isDir()?n.startsWith(e.path(),this.path()):!1},path:function(){return this._path},name:function(){return n.name(this.path())},truncExt:function(e){return n.truncExt(this.path(),e)},ext:function(){return n.ext(this.path())},relPath:function(e){var r=e.path?e.path():e;return n.relPath(this.path(),t.is(r,n.Absolute))},up:function(){var e=this.path(),t=n.up(e);return null==t?null:this._resolve(t)},rel:function(e){t.is(e,n.Relative),this.assertDir();var r=this.path();return this._resolve(n.rel(r,e))},startsWith:function(e){return n.startsWith(this.name(),e)},endsWith:function(e){return n.endsWith(this.name(),e)},equals:function(e){return e&&"function"==typeof e.path&&e.path()==this.path()},toString:function(){return this.path()},touch:function(){this.act.fs.touch(this.act.path)},isReadOnly:function(){return this.act.fs.isReadOnly(this.act.path)},isTrashed:function(){var e=this.metaInfo();return e?e.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(e){return this.act.fs.getMetaInfo(this.act.path,e)},setMetaInfo:function(e,t){return this.act.fs.setMetaInfo(this.act.path,e,t)},lastUpdate:function(){return t(this.exists()),this.metaInfo().lastUpdate},exists:function(e){e=e||{};var t=this.fs.exists(this.path(),e);return t||e.noFollowLink?t:this.act.fs.exists(this.act.path,{noFollowLink:!0})},rm:function(e){return e=e||{},this.isLink()?this.fs.rm(this.path(),e):(this.isDir()&&(e.recursive||e.r)&&this.each(function(t){t.rm(e)}),this.act.fs.rm(this.act.path,e))},removeWithoutTrash:function(e){e=e||{},e.noTrash=!0,this.rm(e)},isDir:function(){return this.act.fs.isDir(this.act.path)},text:function(){return arguments.length>0?void this.setText(arguments[0]):this.getText()},setText:function(e){t.is(e,String),this.isText()?this.act.fs.setContent(this.act.path,i.plainText(e)):this.act.fs.setContent(this.act.path,i.url(e))},getContent:function(e){return"function"==typeof e?this.act.fs.getContentAsync(this.act.path).then(e):this.act.fs.getContent(this.act.path)},setContent:function(e){return this.act.fs.setContentAsync(this.act.path,e)},getText:function(){return this.isText()?this.act.fs.getContent(this.act.path).toPlainText():this.act.fs.getContent(this.act.path).toURL()},isText:function(){return this.act.fs.isText(this.act.path)},contentType:function(){return this.act.fs.getContentType(this.act.path)},setBytes:function(e){return this.act.fs.setContent(this.act.path,i.bin(e,this.contentType()))},getBytes:function(e){return e=e||{},this.act.fs.getContent(this.act.path).toBin(e.binType)},getURL:function(){return this.act.fs.getURL(this.act.path)},lines:function(){return this.text().replace(/\r/g,"").split("\n")},obj:function(){var e=this;if(0==arguments.length){var n=e.text();return n?JSON.parse(n):null}e.text(JSON.stringify(t.is(arguments[0],Object)))},copyFrom:function(e,t){return e.copyTo(this,t)},copyTo:function(e,n){t(e&&e.isSFile(),e+" is not a file");var r=this,n=n||{},i=r.isDir(),o=e.isDir();if(!i&&o&&(e=e.rel(r.name()),t(!e.isDir(),e+" is a directory."),o=!1),i&&!o)this.err("Cannot move dir to file");else{if(!i&&!o){n.echo&&n.echo(r+" -> "+e);var s=this.act.fs.cp(this.act.path,e.getResolvedLinkPath(),n);return n.a&&e.setMetaInfo(r.getMetaInfo()),s}t(i&&o),r.each(function(t){e.rel(t.name()).copyFrom(t,n)})}},moveFrom:function(e,t){var n=this.copyFrom(e,t);return e.rm({recursive:!0}),n},assertDir:function(){return t.is(this.path(),n.Dir),this},each:function(e,t){var n=this.assertDir();n.listFiles(t).forEach(e)},recursive:function(e,t){var n=this.assertDir();n.each(function(t){t.isDir()?t.recursive(e):e(t)},t)},listFiles:function(e){t(null==e||"object"==typeof e);var n,r=this.assertDir(),i=this.path();"function"==typeof e&&(n=e),e=r.convertOptions(e),n||(n=e.order);for(var o=this.act.fs.opendir(this.act.path,e),s=[],a=0;a<o.length;a++){var u=o[a];e.excludes[i+u]||s.push(r.rel(u))}return"function"==typeof n&&s.sort&&s.sort(n),s},ls:function(e){t(null==e||"object"==typeof e);var n=this.assertDir(),r=n.listFiles(e);return r.map(function(e){return e.name()})},convertOptions:function(e){var r=(this.assertDir(),this.path());if(e||(e={}),e.excludes||(e.excludes={}),e.excludes instanceof Array){var i={};e.excludes.forEach(function(e){n.startsWith(e,"/")?i[e]=1:i[r+e]=1}),e.excludes=i}return t.is(e,{excludes:{}})},mkdir:function(){this.touch()},link:function(e,t){if(this.exists())throw new Error(this.path()+": exists.");return this.act.fs.link(this.act.path,e.path(),t)},resolveLink:function(){return this._resolve(this.act.path)},isLink:function(){return this.fs.isLink(this.path())},getResolvedLinkPath:function(){return this.act.path}},s}),requireSimulator.setName("RootFS"),define(["assert","FS2","PathUtil","SFile"],function(e,t,n,r){var i=function(n){e.is(n,t),this.mount(null,n)},o=i.prototype,s={err:function(e,t){throw new Error(e+": "+t)},fstab:function(){return this._fstab=this._fstab||[]},unmount:function(t){e.is(arguments,[n.AbsDir]);var r=this.fstab();console.log(r);for(var i=0;i<r.length;i++)if(r[i].mountPoint==t)return r.splice(i,1),!0;return!1},availFSTypes:function(){return t.availFSTypes()},mount:function(n,r,i){if("string"==typeof r){var o=e(t.availFSTypes()[r],"fstype "+r+" is undefined.");r=o(n,i||{})}e.is(r,t),r.mounted(this,n),this.fstab().unshift(r)},resolveFS:function(r){e.is(r,n.Absolute);var i;return this.fstab().forEach(function(e){i||e.inMyFS(r)&&(i=e)}),i||this.err(r,"Cannot resolve"),e.is(i,t)},get:function(t){return e.is(t,n.Absolute),new r(this.resolveFS(t),t)}};for(var a in s)o[a]=s[a];return i}),requireSimulator.setName("FS"),define(["FS2","WebSite","NativeFS","LSFS","PathUtil","Env","assert","SFile","RootFS"],function(e,t,n,r,i,o,s,a,u){var e={};"object"==typeof window&&(window.FS=e);var c,f=new o(t);return c=new u(t.isNW?new n:new r(localStorage)),e.getRootFS=function(){return c},e.get=function(){return c.get.apply(c,arguments)},e.expandPath=function(){return f.expandPath.apply(f,arguments)},e.resolve=function(t,n){return a.is(t)?t:(t=f.expandPath(t),n&&!i.isAbsolutePath(t)?(n=f.expandPath(n),e.get(n).rel(t)):e.get(t))},e.mount=function(){return c.mount.apply(c,arguments)},e.unmount=function(){return c.unmount.apply(c,arguments)},e}),requireSimulator.setName("DeferredUtil"),define([],function(){var e;return e={ensureDefer:function(e){var t,n=new $.Deferred;return $.when(e).then(function(e){t?n.resolve(e):setTimeout(function(){n.resolve(e)},0)}).fail(function(e){t?n.reject(e):setTimeout(function(){n.reject(e)},0)}),t=!0,n.promise()},directPromise:function(e){var t=new $.Deferred;return setTimeout(function(){t.resolve(e)},0),t.promise()},then:function(t){return e.directPromise().then(t)},timeout:function(e){var t=new $.Deferred;return setTimeout(function(){t.resolve()},e),t.promise()},funcPromise:function(e){var t=new $.Deferred;return e(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()},throwPromise:function(e){var t=new $.Deferred;return setTimeout(function(){t.reject(e)},0),t.promise()},throwF:function(t){return function(){try{return t.apply(this,arguments)}catch(n){return console.log(n,n.stack),e.throwPromise(n)}}},each:function(t,n){if(t instanceof Array)return e.loop(function(r){return r>=t.length?e.brk():$.when(n(t[r],r)).then(function(){return r+1})},0);var r=[];for(var i in t)r.push({k:i,v:t[i]});return e.each(r,function(e){return n(e.k,e.v)})},loop:function(t,n){return e.directPromise(n).then(e.throwF(function(){var n=t.apply(this,arguments);return n.DU_BRK?n.res:$.when(n).then(function(n){return e.loop(t,n)})}))},brk:function(e){return{DU_BRK:!0,res:e}}}}),requireSimulator.setName("Class"),define(["assert"],function(e){function t(){var t,n;2==arguments.length?(t=e.is(arguments[0],Function),n=e.is(arguments[1],Object)):1==arguments.length&&(t=Object,n=e.is(arguments[0],Object));var r=n.initialize||function(){},i=r.prototype;for(var o in n)i[o]=n[o];return i.callSuper=function(){for(var n=[],r=0;arguments.length;r++)n.push(arguments[r]);var i=e.is(n.shift(),String),o=e.is(t.prototype[i],Function);return o.apply(this,n)},r}return t}),requireSimulator.setName("Tonyu.Thread"),define(["DeferredUtil","Class"],function(e,t){var n={enterC:{},exitC:0};try{window.cnts=n}catch(r){}var i=t({initialize:function(){this.frame=null,this._isDead=!1,this.cnt=0,this._isWaiting=!1,this.fSuspended=!1,this.tryStack=[],this.preemptionTime=60,this.onEndHandlers=[],this.age=0},isAlive:function(){return!this.isDead()},isDead:function(){return this._isDead=this._isDead||null==this.frame||this._threadGroup&&(this._threadGroup.objectPoolAge!=this.tGrpObjectPoolAge||this._threadGroup.isDeadThreadGroup())},setThreadGroup:function(e){this._threadGroup=e,this.tGrpObjectPoolAge=e.objectPoolAge},isWaiting:function(){return this._isWaiting},suspend:function(){this.fSuspended=!0,this.cnt=0},enter:function(e){this.frame={prev:this.frame,func:e}},apply:function(e,t,n){n||(n=[]);var r;"string"==typeof t&&(r=e["fiber$"+t]),"function"==typeof t&&(r=t.fiber),n=[this].concat(n);var i=0;return this.enter(function(t){switch(i){case 0:r.apply(e,n),i=1;break;case 1:t.notifyEnd(t.retVal),n[0].exit(),i=2}})},notifyEnd:function(e){this.onEndHandlers.forEach(function(t){t(e)})},on:function(e,t){"end"==e&&this.onEndHandlers.push(t)},gotoCatch:function(e){var t=this;if(0==t.tryStack.length)return t.kill(),void t.handleEx(e);t.lastEx=e;for(var n=t.tryStack.pop();t.frame;){if(n.frame===t.frame){t.catchPC=n.catchPC;break}t.frame=t.frame.prev}},startCatch:function(){var e=this,t=e.lastEx;return e.lastEx=null,t},exit:function(e){this.frame=this.frame?this.frame.prev:null,this.retVal=e},enterTry:function(e){var t=this;t.tryStack.push({frame:t.frame,catchPC:e})},exitTry:function(){var e=this;e.tryStack.pop()},waitEvent:function(e,t){var n=this;if(n.suspend(),e.on){var r;t=t.concat(function(){n.lastEvent=arguments,n.retVal=arguments[0],r.remove(),n.steps()}),r=e.on.apply(e,t)}},runAsync:function(e){var t=this,n=function(){t.retVal=arguments,t.steps()},r=function(){for(var e="",n=0;n<arguments.length;n++)e+=arguments[n]+",";0==e.length&&(e="Async fail");var r=new Error(e);r.args=arguments,t.gotoCatch(r),t.steps()};t.suspend(),setTimeout(function(){e(n,r)},0)},waitFor:function(t){var n=this;return n._isWaiting=!0,n.suspend(),e.ensureDefer(t).then(function(e){n.retVal=e,n.steps()}).fail(function(e){if(e instanceof Error)n.gotoCatch(e);else{var t=new Error(e);t.original=e,n.gotoCatch(t)}n.steps()})},resume:function(e){this.retVal=e,this.steps()},steps:function(){var e=this;if(!e.isDead()){var t=Tonyu.currentThread;for(Tonyu.currentThread=e,e.cnt=e.preemptionTime,e.preempted=!1,e.fSuspended=!1;e.cnt>0&&e.frame;)try{for(;e.cnt-->0&&e.frame;)e.frame.func(e);e.preempted=!e.fSuspended&&e.isAlive()}catch(n){e.gotoCatch(n)}Tonyu.currentThread=t}},kill:function(){var e=this;e._isDead=!0,e.frame=null},clearFrame:function(){this.frame=null,this.tryStack=[]}});return i}),requireSimulator.setName("Tonyu.Iterator"),define(["Class"],function(e){function t(e,t){if(e.tonyuIterator)return e.tonyuIterator(t);if(e instanceof Array)return 1==t?new n(e):new r(e);if(e instanceof Object)return 1==t?new i(e):new o(e);throw console.log(e),new Error(e+" is not iterable")}var n=e({initialize:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.set[this.i],this.i++,!0)}}),r=e({initialize:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.i,this[1]=this.set[this.i],this.i++,!0)}}),i=e({initialize:function(e){this.elems=[];for(var t in e)this.elems.push(t);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i],this.i++,!0)}}),o=e({initialize:function(e){this.elems=[];for(var t in e)this.elems.push([t,e[t]]);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i][0],this[1]=this.elems[this.i][1],this.i++,!0)}});return t}),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert","Tonyu.Thread","Tonyu.Iterator","DeferredUtil"],function(e,t,n,r){return Tonyu=function(){function i(){var e=new t;return e.handleEx=a,e}function o(e){return r.funcPromise(function(t){setTimeout(t,e)})}function s(){return r.funcPromise(function(e){requestAnimationFrame(e)})}function a(e){if(!Tonyu.onRuntimeError)throw"undefined"==typeof $LASTPOS&&($LASTPOS=0),alert("エラー! at "+$LASTPOS+" メッセージ  : "+e),console.log(e.stack),e;Tonyu.onRuntimeError(e)}function u(t,n){return e.is(arguments,[String,Object]),f(klass.getMeta(t),n)}function c(e,t){return e?f(Object.create(e.prototype),t):t}function f(e,t){if(t&&"object"==typeof t)for(var n in t)e[n]=t[n];return e}function l(e,t){S[e]=t}function p(e){return S[e]}function h(e){var t=e.split("."),n=w;if(t.forEach(function(e){n&&(n=n[e])}),!n&&1==t.length){var r;for(var i in w){var o=w[i][e];if(o){if(n)throw new Error("曖昧なクラス名： "+i+"."+e+", "+r);n=o,r=i+"."+e}}}return n}function m(e,t){if("function"!=typeof t)return t;var n=function(){return t.apply(e,arguments)};return n.methodInfo=Tonyu.extend({thiz:e},t.methodInfo||{}),t.fiber&&(n.fiber=function(){return t.fiber.apply(e,arguments)},n.fiber.methodInfo=Tonyu.extend({thiz:e},t.fiber.methodInfo||{})),n}function d(e,t,n,r){if(!e)throw new Error(r+"(="+e+")のメソッド "+t+"を呼び出せません");var i=e[t];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+t+"(="+i+")はメソッドではありません");return i.apply(e,n)}function g(e,t,n){if("function"!=typeof e)throw new Error(n+"は関数ではありません");return e.apply({},t)}function v(e,t){if(e!=e||null==e)throw new Error(t+"(="+e+")は初期化されていません");return e}function y(e){for(var t=[],n=1;n<e.length;n++)t[n-1]=e[n];return t}function b(e){throw new Error("クラス名"+e+"はnewをつけて呼び出して下さい。")}function T(e){throw console.log("Not a tonyu object: ",e),new Error(e+" is not a tonyu object")}function x(e,t){return e in t}function M(e){var t=h(e);if(!t)throw new Error(e+" というクラスはありません");Tonyu.runMode=!0;var n=new t,r=i();r.apply(n,"main");var o;(o=Tonyu.currentProject)&&(o.runningThread=r,o.runningObj=n),$LASTPOS=0,r.steps()}klass=function(){throw alert("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again."),new Error("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again.")},klass.addMeta=u,klass.removeMeta=function(e){delete A[e]},klass.getMeta=function(e){if("function"==typeof e)return e.meta;if("string"==typeof e){var t=A[e];return t||(A[e]=t={}),t}},klass.ensureNamespace=function(e,t){var n,r=t.split("."),i=e;for(n=0;n<r.length;n++){var o=r[n];i[o]||(i[o]={}),i=i[o]}return i},Function.prototype.constructor=function(){throw new Error("This method should not be called")},klass.define=function(e){var t=e.superclass,n=e.includes,r=e.fullName,i=e.shortName,o=e.namespace,s=e.methods,a=e.decls,f=klass.ensureNamespace(Tonyu.classes,o),l=s,p=l.initialize;delete l.initialize;var h;h=p?function(){this instanceof h||b(r),p.apply(this,arguments)}:t?function(){this instanceof h||b(r),t.apply(this,arguments)}:function(){this instanceof h||b(r)},f[i]=h,h.methods=l,n.forEach(function(e){if(!e.methods)throw e+" Does not have methods";for(var t in e.methods)t in l||(l[t]=e.methods[t])});var m={},d=/^__([gs]et)ter__(.*)$/;for(var g in l)if(!g.match(/^fiber\$/)){l["fiber$"+g]&&(l[g].fiber=l["fiber$"+g],l[g].fiber.methodInfo={name:g,klass:h,fiber:!0}),l[g].methodInfo={name:g,klass:h};var v=d.exec(g);v&&(m[v[2]]=m[v[2]]||{},m[v[2]][v[1]]=l[g])}h.prototype=c(t,l),h.prototype.isTonyuObject=!0;for(var g in m)Object.defineProperty(h.prototype,g,m[g]);h.meta=u(r,{fullName:r,shortName:i,namepsace:o,decls:a,superclass:t?t.meta:null,func:h,includes:n.map(function(e){return e.meta})});var y=klass.getMeta(h);return h.prototype.getClassInfo=function(){return y},h},klass.isSourceChanged=function(e){return e=e.meta||e,e.src&&e.src.tonyu?e.nodeTimestamp?e.src.tonyu.lastUpdate()>e.nodeTimestamp:!0:!1},klass.shouldCompile=function(e){if(e=e.meta||e,klass.isSourceChanged(e))return!0;for(var t=klass.getDependingClasses(e),n=0;n<t.length;n++)if(klass.shouldCompile(t[n]))return!0},klass.getDependingClasses=function(e){e=e.meta||e;var t=[];return e.superclass&&(t=[e.superclass]),e.includes&&(t=t.concat(e.includes)),t};var S={},w={},A={};return Tonyu={thread:i,klass:klass,bless:c,extend:f,globals:S,classes:w,classMetas:A,setGlobal:l,getGlobal:p,getClass:h,timeout:o,animationFrame:s,bindFunc:m,not_a_tonyu_object:T,hasKey:x,invokeMethod:d,callFunc:g,checkNonNull:v,run:M,iterator:n,VERSION:1489892993004,A:y}}()}),requireSimulator.setName("IndentBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return IndentBuffer=function(){var e=function(){function t(e){i++;var t=n[i];if(null==t&&!e)throw console.log(n),new Error(i+"th null param: fmt="+r);return t}for(var n=arguments,r=n[0],i=0;;){var o=r.indexOf("%");if(0>o){e.buf+=r;break}e.buf+=r.substring(0,o),o++;var s=r.charAt(o);if("s"==s){var a=t();"string"==typeof a||"number"==typeof a||(null==a?a="null":a.text&&(a=a.text)),e.buf+=a,o++}else if("d"==s){var u=t();if("number"!=typeof u)throw new Error(u+" is not a number: fmt="+r);e.buf+=u,o++}else if("n"==s)e.ln(),o++;else if("{"==s)e.indent(),o++;else if("}"==s)e.dedent(),o++;else if("%"==s)e.buf+="%";else if("f"==s)t()(e),o++;else if("l"==s){var c=t();e.buf+=e.toLiteral(c),o++}else if("v"==s){var f=t();if(!f)throw new Error("Null %v");if("object"!=typeof f)throw new Error("nonobject %v:"+f);e.visitor.visit(f),o++}else if("z"==s){var l=t();if("val"in l)return void(e.buf+=l.val);l.gen||e.lazy(l),e.buf+=l.gen,o++}else if("j"==s){var p=t(),h=p[0],m=p[1],d=!1;if(!m||!m.forEach)throw console.log(m),new Error(m+" is not array. cannot join fmt:"+r);m.forEach(function(t){d&&e.printf(h),d=!0,e.visitor.visit(t)}),o++}else"D"==s?(t(!0),o++):o+=2;r=r.substring(o)}};return e.print=function(t){e.buf+=t},e.printf=e,e.buf="",e.lazy=function(t){return t||(t={}),t.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),t.reg=new RegExp(t.gen,"g"),t.put=function(t){return this.val=t,e.buf=e.buf.replace(this.reg,t),t},t},e.ln=function(){e.buf+="\n"+e.indentBuf},e.indent=function(){e.indentBuf+=e.indentStr,e.buf+="\n"+e.indentBuf},e.dedent=function(){var t=e.indentStr.length;if(!e.buf.substring(e.buf.length-t).match(/^\s*$/))throw console.log(e.buf),new Error("Non-space truncated ");e.buf=e.buf.substring(0,e.buf.length-t),e.indentBuf=e.indentBuf.substring(0,e.indentBuf.length-t)},e.toLiteral=function(e,t){return t||(t="'"),e=e.replace(/\\/g,"\\\\"),e=e.replace(/\r/g,"\\r"),e=e.replace(/\n/g,"\\n"),e="'"==t?e.replace(/'/g,"\\'"):e.replace(/"/g,'\\"'),t+e+t},e.indentBuf="",e.indentStr="  ",e}}),requireSimulator.setName("disp"),"function"!=typeof define&&(define=require("requirejs").define),define(["IndentBuffer"],function(e){return disp=function(t){function n(e){if(null==e)return r("null%n");if("string"==typeof e)return r("'%s'%n",e);if("number"==typeof e)return r("%s%n",e);if("function"==typeof e)return r("func%n");r(e instanceof Array?"[%{":"{%{");var t="";for(var i in e)r(t+i+":"),n(e[i]);r(e instanceof Array?"%}]%n":"%}}%n")}var r=e();return n(t),r.buf}}),requireSimulator.setName("Parser"),"function"!=typeof define&&(define=require("requirejs").define),define(["disp"],function(){return Parser=function(){function e(e,t){var n;for(n in t)e[n]=t[n];return e}function t(e){this.parse=i.options.traceTap?function(t){console.log("tap: name="+this.name+"  pos="+(t?t.pos:"?"));var n=e.apply(this,[t]),r="NOIMG";return n.src&&n.src.str&&(r=n.src.str.substring(n.pos-3,n.pos)+"^"+n.src.str.substring(n.pos,n.pos+3)),n.src&&n.src.tokens&&(r=n.src.tokens[n.pos-1]+"["+n.src.tokens[n.pos]+"]"+n.src.tokens[n.pos+1]),console.log("/tap: name="+this.name+" pos="+(t?t.pos:"?")+"->"+(n?n.pos:"?")+" "+r+" res="+(n?n.success:"?")),n}:e}function n(e,t){if(null==e)throw t+" is null!";return e}function r(e,t){null!=e&&(this.src={maxPos:0,global:t},"string"==typeof e&&(this.src.str=e),e instanceof Array&&(this.src.tokens=e),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:t,StringParser:o,nc:n};i.dispTbl=function(e){var t="",n={};if(!e)return t;for(var r in e){var i=e[r].name;n[i]||(n[i]=""),n[i]+=r}for(var i in n)t+=n[i]+"->"+i+",";return t},t.create=function(e){return new t(e)},i.create=t.create,e(t.prototype,{except:function(e){var n=this;return this.ret(t.create(function(t){return e.apply({},t.result)&&(t.success=!1),t}).setName("(except "+n.name+")"))},noFollow:function(e){var r=this;return n(e,"p"),this.ret(t.create(function(t){var n=e.parse(t);return t.success=!n.success,t}).setName("("+r.name+" noFollow "+e.name+")"))},andNoUnify:function(e){n(e,"next");var r=this,i=t.create(function(t){var n=r.parse(t);if(!n.success)return n;var i=e.parse(n);return i.success&&(i.result=n.result.concat(i.result)),i});return i.setName("("+this.name+" "+e.name+")")},and:function(e){var n=this.andNoUnify(e);if(!this._first)return n;var r=this._first.tbl,o={};for(var s in r)o[s]=r[s].andNoUnify(e);return n=t.fromFirst(this._first.space,o),n.setName("("+this.name+" >> "+e.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+n.name+" tbl="+i.dispTbl(o)),n},retNoUnify:function(e){var n,r=this;n="function"==typeof e?t.create(function(t){var n=t.clone();return n.result=[e.apply({},t.result)],n}).setName("retfunc"):e;var i=t.create(function(e){var t=r.parse(e);return t.success?n.parse(t):t}).setName("("+this.name+" >= "+n.name+")");return i},ret:function(e){if(!this._first)return this.retNoUnify(e);var n=this._first.tbl,r={};for(var o in n)r[o]=n[o].retNoUnify(e);return res=t.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+e.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(e,n){if(!i.options.optimizeFirst)return this;if(null==e)throw"Space is null2!";if("string"==typeof n){for(var r={},o=0;o<n.length;o++)r[n.substring(o,o+1)]=this;return t.fromFirst(e,r).setName("(fst "+this.name+")")}if(null==n)return t.fromFirst(e,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof n)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(e){if(!i.options.optimizeFirst)return this;"string"==typeof e&&(e=[e]);var n={};if(e){var r=this;e.forEach(function(e){n[e]=r})}else n.ALL=this;return t.fromFirstTokens(n).setName("(fstT "+this.name+")")},unifyFirst:function(n){function r(e,t){return e?t?e.orNoUnify(t).checkTbl():e:t}function o(){var e=n._first.tbl,t={};for(var i in s)t[i]=1;for(var i in e)t[i]=1;delete t.ALL,(s.ALL||e.ALL)&&(s.ALL=r(s.ALL,e.ALL));for(var i in t)s[i]&&e[i]?s[i]=r(s[i],e[i]):s[i]&&!e[i]?s[i]=r(s[i],e.ALL):!s[i]&&e[i]&&(s[i]=r(s.ALL,e[i]))}var s={};this.checkTbl(),n.checkTbl(),e(s,this._first.tbl),o();var a=t.fromFirst(this._first.space,s).setName("("+this.name+")U("+n.name+")");return i.options.verboseFirst&&console.log("Created unify name="+a.name+" tbl="+i.dispTbl(s)),a},or:function(e){return n(e,"other"),this._first&&e._first&&this._first.space&&this._first.space===e._first.space?this.unifyFirst(e):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+e.name+" "+this._first+" - "+e._first),this.orNoUnify(e))},orNoUnify:function(e){var n=this,r=t.create(function(t){var r=n.parse(t);if(r.success)return r;var i=e.parse(t);return i});return r.name="("+this.name+")|("+e.name+")",r},setName:function(e){return this.name=e,this._first,this},profile:function(e){return i.options.profile&&(this.parse=this.parse.profile(e||this.name)),this},repN:function(e){var n=this;e||(e=0);var r=t.create(function(t){for(var r=t,i=[];;){var o=n.parse(r);if(!o.success){var s;return i.length>=e?(s=r.clone(),s.result=[i],s.success=!0,s):(s=t.clone(),s.success=!1,s)}i.push(o.result[0]),r=o}});return r.setName("("+n.name+" * "+e+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var e=this;return t.create(function(t){var n=e.parse(t);return n.success?n:(t=t.clone(),t.success=!0,t.result=[null],t)}).setName("("+e.name+")?")},sep1:function(e,t){var r=this;n(r,"value"),n(e,"sep");var i=e.and(r).ret(function(e,n){return t?n:{sep:e,value:n}});return r.and(i.rep0()).ret(function(e,n){var r;if(t){var i=[e];for(r in n)i.push(n[r]);return i}return{head:e,tails:n}}).setName("(sep1 "+r.name+"~~"+e.name+")")},sep0:function(e){return this.sep1(e,!0).opt().ret(function(e){return e?e:[]})},tap:function(e){return this},retN:function(e){return this.ret(function(){return arguments[e]})},parseStr:function(e,t){var n=new r(e,t);return this.parse(n)},checkTbl:function(){if(!this._first)return this;var e=this._first.tbl;for(var t in e)if(!e[t].parse)throw this.name+": tbl."+t+" is not a parser :"+e[t];return this}}),e(r.prototype,{clone:function(){var e=new r;return e.src=this.src,e.pos=this.pos,e.result=this.result.slice(),e.success=this.success,e},updateMaxPos:function(e){e>this.src.maxPos&&(this.src.maxPos=e)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),t.fromFirst=function(e,n){if("TOKEN"==e)return t.fromFirstTokens(n);var r=t.create(function(t){var r=e.parse(t),o=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+o+" tbl="+(n[o]?n[o].name:"-")),n[o]?n[o].parse(r):n.ALL?n.ALL.parse(r):(r.success=!1,r)});return r._first={space:e,tbl:n},r.checkTbl(),r},t.fromFirstTokens=function(e){var n=t.create(function(t){var n=t.src.tokens[t.pos],r=n?n.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(e[r]?e[r].name:"-")),null!=r&&e[r]?e[r].parse(t):e.ALL?e.ALL.parse(t):(t.success=!1,t)});return n._first={space:"TOKEN",tbl:e},n.checkTbl(),n};var o={empty:t.create(function(e){var t=e.clone();return t.success=!0,t.result=[null],t}).setName("E"),fail:t.create(function(e){return e.success=!1,e}).setName("F"),str:function(e){return this.strLike(function(t,n){return t.substring(n,n+e.length)===e?{len:e.length}:null}).setName(e)},reg:function(e){return(e+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(e+"")),this.strLike(function(t,n){var r=e.exec(t.substring(n));return r?(r.len=r[0].length,r):null}).setName(e+"")},strLike:function(n){return t.create(function(t){var r=t.src.str;if(null==r)throw"strLike: str is null!";var o=t.pos,s=n(r,o,t);if(i.options.traceToken&&console.log("pos="+o+" r="+s),s){i.options.traceToken&&console.log("str:succ"),s.pos=o,s.src=t.src;var a=t.clone();return e(a,{pos:o+s.len,success:!0,result:[s]}),t.updateMaxPos(a.pos),a}return i.options.traceToken&&console.log("str:fail"),t.success=!1,t}).setName("STRLIKE")},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)}};o.eof=o.strLike(function(e,t){return t==e.length?{len:0}:null}).setName("EOF"),i.StringParser=o;var s={token:function(e){return t.create(function(t){var n=t.src.tokens[t.pos];return t.success=!1,n?(n.type==e&&(t=t.clone(),t.updateMaxPos(t.pos),t.pos++,t.success=!0,t.result=[n]),t):t}).setName(e).firstTokens(e)},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)},eof:t.create(function(e){var t=e.pos>=e.src.tokens.length;return e.success=t,t&&(e=e.clone(),e.result=[{type:"EOF"}]),e}).setName("EOT")};return i.TokensParser=s,i.lazy=function(e){var n=null;return t.create(function(t){if(n||(n=e()),!n)throw e+" returned null!";return this.name=e.name,n.parse(t)}).setName("LZ")},i.addRange=function(e,t){if(null==t)return e;if("number"!=typeof e.pos)return e.pos=t.pos,e.len=t.len,e;var n=t.pos+t.len,r=e.pos+e.len;return t.pos<e.pos&&(e.pos=t.pos),n>r&&(e.len=n-e.pos),e},i.setRange=function(e){if(null!=e&&"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e){var t=i.getRange(e);if(null!=t)return e;for(var n in e)if(e.hasOwnProperty(n)){var r=i.setRange(e[n]);i.addRange(e,r)}return e}},i.getRange=function(e){return null==e?null:"number"!=typeof e.pos?null:"number"==typeof e.len?e:null},i}()}),requireSimulator.setName("Grammar"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return Grammar=function(){function t(e){return"string"==typeof e?r.get(e):e}var n=e,r=null;return r=function(n){var i={};return i.ands=function(){for(var i=t(arguments[0]),o=1;o<arguments.length;o++)i=i.and(t(arguments[o]));i=i.tap(n),r.defs[n]=i;var s={};return s.autoNode=function(){var t=i.ret(function(){for(var t={type:n},r=0;r<arguments.length;r++){var i=arguments[r],o=e.setRange(i);e.addRange(t,o),t["-element"+r]=i}t.toString=function(){return"("+this.type+")"}}).setName(n);return r.defs[n]=t},s.ret=function(t){if(0==arguments.length)return i;if("function"==typeof t)return r.defs[n]=i.ret(t);for(var o=[],s=function(e){return e},a=0;a<arguments.length;a++){if("function"==typeof arguments[a]){s=arguments[a];break}o[a]=arguments[a]}var u=i.ret(function(){var t={type:n};t[Grammar.SUBELEMENTS]=[];for(var r=0;r<arguments.length;r++){var i=arguments[r],a=e.setRange(i);e.addRange(t,a),o[r]&&(t[o[r]]=i),t[Grammar.SUBELEMENTS].push(i)}return t.toString=function(){return"("+this.type+")"},s(t)}).setName(n);return r.defs[n]=u},s},i.ors=function(){for(var e=t(arguments[0]),i=1;i<arguments.length;i++)e=e.or(t(arguments[i]));return r.defs[n]=e.setName(n)},i},r.defs={},r.get=function(e){return r.defs[e]?r.defs[e]:n.lazy(function(){var t=r.defs[e];if(!t)throw"grammar named '"+e+"' is undefined";return t}).setName("(Lazy of "+e+")")},r},Grammar.SUBELEMENTS="[SUBELEMENTS]",Grammar}),requireSimulator.setName("XMLBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return XMLBuffer=function(t){var n;return n=function(r,i){if(null!=r&&"string"!=typeof r&&"number"!=typeof r){var o=e.getRange(r);if(o)for(;n.srcLen<o.pos;)n.src(t.substring(n.srcLen,o.pos));if(null!=r){if(i&&n.tag("<attr_"+i+">"),r.type&&n.tag("<"+r.type+">"),r.text)n.src(o.text);else{var s=n.orderByPos(r);s.forEach(function(e){e.name&&e.name.match(/^-/)?n(e.value):n(e.value,e.name)})}if(o)for(;n.srcLen<o.pos+o.len;)n.src(t.substring(n.srcLen,o.pos+o.len));r.type&&n.tag("</"+r.type+">"),i&&n.tag("</attr_"+i+">")}}},n.orderByPos=XMLBuffer.orderByPos,n.src=function(e){n.buf+=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),n.srcLen+=e.length},n.tag=function(e){n.buf+=e},n.buf="",n.srcLen=0,n},XMLBuffer.orderByPos=function(e){var t=[];if(e[XMLBuffer.SUBELEMENTS])e[XMLBuffer.SUBELEMENTS].forEach(function(e){t.push(e)});else for(var n in e)e.hasOwnProperty(n)&&null!=e[n]&&"string"!=typeof e[n]&&"number"!=typeof e[n]&&"number"==typeof e[n].pos&&t.push(isNaN(parseInt(n))&&!(n+"").match(/-/)?{name:n,value:e[n]}:{value:e[n]});
return t=t.sort(function(e,t){return e.value.pos-t.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",XMLBuffer}),requireSimulator.setName("TError"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return TError=function(e,t,n){if("string"==typeof t)return{isTError:!0,mesg:e,src:{name:function(){return t},text:function(){return t}},pos:n,toString:function(){return this.mesg+" at "+t+":"+this.pos},raise:function(){throw this}};var r=null;if(t&&t.src&&(r=t,t=r.src.tonyu),"function"!=typeof t.name)throw"src="+t+" should be file object";var i;if("function"==typeof t.text){var o=t.text();"string"==typeof o&&(i=TError.calcRowCol(o,n))}return{isTError:!0,mesg:e,src:t,pos:n,row:i.row,col:i.col,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.row+":"+this.col},raise:function(){throw this}}},TError.calcRowCol=function(e,t){var n,r,i=e.split("\n"),o=0;for(n=0;n<i.length;n++)if(o+=i[n].length+1,o>t){r=t-(o-i[n].length);break}return{row:n,col:r}},TError}),requireSimulator.setName("TT"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","disp","Parser","TError"],function(e,t,n,r,i){return TT=function(){function e(e,t){var n,i;"string"==typeof e?(n=a.str(e),e.length>0&&(i=e.substring(0,1)),t||(t=e)):(n=a.reg(e),t||(t=e+""));var o=l.and(n).ret(function(e,n){var i={};if(i.pos=n.pos,"number"!=typeof i.pos)throw"no pos for "+t+" "+r(n);if(i.len=n.len,i.text=n.src.str.substring(i.pos,i.pos+i.len),"string"!=typeof i.text)throw"no text("+i.text+") for "+t+" "+r(n);return i.toString=function(){return this.text},i});return i&&(o=o.first(l,i)),o.setName(t)}function t(t,n,r){"string"==typeof r&&(r=e(r)),p[t]=o(p[t],r.ret(function(e){return e.type=n,e}).setName(n))}function n(e,n,r,i){n==u&&(n=r);for(var o=1;e>=o;o*=2)0!=(e&o)&&t(e&o,n,r,i);h[n]=i}function o(e,t){return e?e.or(t):t}function s(e){var t=((new Date).getTime(),i.StringParser.parse(m,e));return t.success||console.log("Stopped at "+e.substring(t.src.maxPos-5,t.src.maxPos+5)),t}var a=i.StringParser,u="SAMENAME",c=1,f=2,l=a.reg(/^(\s*(\/\*([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),p={},h={},m=i.create(function(e){for(var t=f,n=[];;){if(e=p[t].parse(e),!e.success)break;var r=e.result[0];t=h[r.type],n.push(r)}return e=l.parse(e),e.success=e.src.maxPos==e.src.str.length,e.result[0]=n,e}),d={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,"for":!0,"else":!0,"super":!0,"while":!0,"continue":!0,"break":!0,"do":!0,"switch":!0,"case":!0,"default":!0,"try":!0,"catch":!0,"finally":!0,"throw":!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,_thread:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},g=e(/^[0-9\.]+/).ret(function(e){return e.type="number",e.value=parseInt(e.text),e}).first(l,"0123456789"),v=e({exec:function(e){var t=e.substring(0,1);if('"'!==t&&"'"!==t)return!1;for(var n=1;n<e.length;n++){var r=e.substring(n,n+1);if(r===t)return[e.substring(0,n+1)];"\\"===r&&n++}return!1},toString:function(){return"literal"}}).first(l,"\"'"),y=e({exec:function(e){if("/"!==e.substring(0,1))return!1;for(var t=1;t<e.length;t++){var n=e.substring(t,t+1);if("/"===n){var r=/^[ig]*/.exec(e.substring(t+1));return[e.substring(0,t+1+r[0].length)]}if("\n"==n)return!1;"\\"===n&&t++}return!1},toString:function(){return"regex"}}).first(l,"/");n(f|c,"number",g,c),n(f,"regex",y,c),n(f|c,"literal",v,c),n(f|c,u,"++",c),n(f|c,u,"--",c),n(f|c,u,"!==",f),n(f|c,u,"===",f),n(f|c,u,"+=",f),n(f|c,u,"-=",f),n(f|c,u,"*=",f),n(f|c,u,"/=",f),n(f|c,u,"%=",f),n(f|c,u,">=",f),n(f|c,u,"<=",f),n(f|c,u,"!=",f),n(f|c,u,"==",f),n(f|c,u,">>",f),n(f|c,u,"<<",f),n(f|c,u,"&&",f),n(f|c,u,"||",f),n(f|c,u,"(",f),n(f|c,u,")",c),n(f|c,u,"[",f),n(f|c,u,"]",c),n(f|c,u,"{",f),n(f|c,u,"}",c),n(f|c,u,">",f),n(f|c,u,"<",f),n(f|c,u,"+",f),n(f|c,u,"-",f),n(f|c,u,".",f),n(f|c,u,"?",f),n(f|c,u,"=",f),n(f|c,u,"*",f),n(f|c,u,"%",f),n(c,u,"/",f),n(c|f,u,"^",f),n(c|f,u,"~",f),n(c|f,u,"\\",f),n(c|f,u,":",f),n(c|f,u,";",f),n(c|f,u,",",f),n(f|c,u,"!",f),n(f|c,u,"&",f),n(f|c,u,"|",f);var b=e(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(e){return e.type="constructor"==e.text?"tk_constructor":d.hasOwnProperty(e.text)?e.text:"symbol",e}).first(l);for(var T in d)h[T]=f;return h.tk_constructor=f,h.symbol=c,p[f]=o(p[f],b),p[c]=o(p[c],b),{parse:s,extension:"js"}}()}),requireSimulator.setName("ExpressionParser"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return ExpressionParser=function(){function t(e,t){var n={};return n.eq=function(n){return e==n.type()&&t==n.prio()},n.type=function(t){return t?t==e:e},n.prio=function(){return t},n.toString=function(){return"["+e+":"+t+"]"},n}function n(e){var t={},n=e;return t.add=function(e){n=n?n.or(e):e},t.get=function(){return n},t}function r(){var r=n(),i={};return i.reg=function(n,i,o){var s=t(n,i);r.add(o.ret(e.create(function(e){return e.opType=s,e})).setName("(opType "+s+" "+o.name+")"))},i.get=function(){return r.get()},i.parse=function(e){return i.get().parse(e)},i}function i(e,t){return}function o(e,t){var n,r=t;if(i(t," start minprio= "+e),t=a.parse(t),i(t," prefixorelem "+e),!t.isSuccess())return t;if(n=t.opType,n.type("prefix")){if(pre=t.result[0],t=o(n.prio(),t),!t.isSuccess())return t;var c=s.mkPrefix.def(pre,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(r=t.clone(),t=u.parse(t),!t.isSuccess())return r;for(;;){if(i(t,"st:pi"),i(r,"res:ex"),n=t.opType,n.prio()<e)return r.nextPostfixOrInfix=t,r;if(n.type("postfix")){var c=s.mkPostfix.def(r.result[0],t.result[0]);if(r=t.clone(),r.result=[c],i(t,"185"),t=u.parse(t),!t.isSuccess())return r}else if(n.type("infixl")){var l=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var c=s.mkInfixl.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("infixr")){var l=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var c=s.mkInfixr.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("trifixr")){var p=r.result[0],h=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var m=t.result[0],t=f[n.prio()].parse(t);if(!t.isSuccess())return r;var d=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var g=t.result[0],c=s.mkTrifixr.def(p,h,m,d,g);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else{var l=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var c=s.mkInfix.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;if(t=t.nextPostfixOrInfix,n.prio()==t.opType.prio())return r.success=!1,r}}}var s={},a=r(),u=r(),c=n(),f=[];return s.element=function(e){a.reg("element",-1,e),c.add(e)},s.getElement=function(){return c.get()},s.prefix=function(e,t){a.reg("prefix",e,t)},s.postfix=function(e,t){u.reg("postfix",e,t)},s.infixl=function(e,t){u.reg("infixl",e,t)},s.infixr=function(e,t){u.reg("infixr",e,t)},s.infix=function(e,t){u.reg("infix",e,t)},s.trifixr=function(e,t,n){u.reg("trifixr",e,t),f[e]=n},s.custom=function(){},s.mkInfix=function(e){s.mkInfix.def=e},s.mkInfix.def=function(t,n,r){return e.setRange({type:"infix",op:n,left:t,right:r})},s.mkInfixl=function(e){s.mkInfixl.def=e},s.mkInfixl.def=function(t,n,r){return e.setRange({type:"infixl",op:n,left:t,right:r})},s.mkInfixr=function(e){s.mkInfixr.def=e},s.mkInfixr.def=function(t,n,r){return e.setRange({type:"infixr",op:n,left:t,right:r})},s.mkPrefix=function(e){s.mkPrefix.def=e},s.mkPrefix.def=function(t,n){return e.setRange({type:"prefix",op:t,right:n})},s.mkPostfix=function(e){s.mkPostfix.def=e},s.mkPostfix.def=function(t,n){return e.setRange({type:"postfix",left:t,op:n})},s.mkTrifixr=function(e){s.mkTrifixr.def=e},s.mkTrifixr.def=function(t,n,r,i,o){return e.setRange({type:"trifixr",left:t,op1:n,mid:r,op2:i,right:o})},s.build=function(){return s.built=e.create(function(e){return o(0,e)}).setName("ExpBuilt"),s.built},s.lazy=function(){return e.create(function(e){return s.built.parse(e)})},s}}),requireSimulator.setName("TonyuLang"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","TT","disp","Parser","ExpressionParser","TError"],function(e,t,n,r,i,o,s,a){return TonyuLang=function(){function n(e){return function(){return arguments[e]}}function u(e,t){var n=[];if(e&&!e.args)throw i(e);if(e){var r=o.getRange(e);o.addRange(n,r),e.args.forEach(function(e){n.push(e)})}return t.forEach(function(e){var t=o.getRange(e);o.addRange(n,t),n.push(e.obj)}),n}function c(e,t,n){var r={type:"infix",left:e,op:t,right:n};return o.setRange(r),r.toString=function(){return"("+e+t+n+")"},r}var f=o,l={},p=e(),h=p.get,m=(f.StringParser,f.TokensParser.token),d=m("number").ret(function(e){if(e.type="number","string"!=typeof e.text)throw"No text for "+i(e);if(e.value=parseFloat(e.text),isNaN(e.value))throw"No value for "+i(e);return e}),g=m("symbol"),v=m("==="),y=m("!=="),b=m("=="),T=m("!="),x=m(">="),M=m("<="),S=m(">"),w=m("<"),A=m("&&"),P=m("||"),L=m("-"),E=m("+"),N=m("*"),B=m("/"),k=m("%"),D=m("="),I=m("literal"),C=m("regex"),R=s(),F=p("arrayElem").ands(m("["),R.lazy(),m("]")).ret(null,"subscript"),_=p("argList").ands(m("("),R.lazy().sep0(m(","),!0),m(")")).ret(null,"args"),j=p("member").ands(m("."),g).ret(null,"name"),O=p("parenExpr").ands(m("("),R.lazy(),m(")")).ret(null,"expr"),G=p("varAccess").ands(g).ret("name"),V=h("funcExpr").firstTokens(["function","\\"]),q=p("funcExprArg").ands(V).ret("obj"),U=h("objlit").firstTokens("{"),W=p("objlitArg").ands(U).ret("obj"),$=W.or(q),z=_.and($.rep0()).ret(function(e,t){return u(e,t)}).or($.rep1().ret(function(e){return u(null,e)})),K=(_.or(W),p("call").ands(z).ret("args")),J=p("scall").ands(z).ret("args"),H=p("newExpr").ands(m("new"),G,K.opt()).ret(null,"klass","params"),X=p("superExpr").ands(m("super"),m(".").and(g).ret(n(1)).opt(),J).ret(null,"name","params"),Y=m("true").or(m("false")).or(m("null")).or(m("undefined")).or(m("_thread")).or(m("this")).or(m("arguments")).ret(function(e){return e.type="reservedConst",e});R.element(d),R.element(Y),R.element(C),R.element(I),R.element(O),R.element(H),R.element(X),R.element(V),R.element(U),R.element(h("arylit").firstTokens("[")),R.element(G);var Z=0;R.infixr(Z,D),R.infixr(Z,m("+=")),R.infixr(Z,m("-=")),R.infixr(Z,m("*=")),R.infixr(Z,m("/=")),R.infixr(Z,m("%=")),R.infixr(Z,m("|=")),R.infixr(Z,m("&=")),Z++,R.trifixr(Z,m("?"),m(":")),Z++,R.infixl(Z,P),Z++,R.infixl(Z,A),Z++,R.infix(Z,m("instanceof")),R.infix(Z,m("is")),R.infix(Z,v),R.infix(Z,y),R.infix(Z,b),R.infix(Z,T),R.infix(Z,x),R.infix(Z,M),R.infix(Z,S),R.infix(Z,w),Z++,R.postfix(Z+3,m("++")),R.postfix(Z+3,m("--")),R.infixl(Z,L),R.infixl(Z,E),Z++,R.infixl(Z,N),R.infixl(Z,B),R.infixl(Z,k),Z++,R.prefix(Z,m("typeof")),R.prefix(Z,m("delete")),R.prefix(Z,m("++")),R.prefix(Z,m("--")),R.prefix(Z,m("+")),R.prefix(Z,m("-")),R.prefix(Z,m("!")),Z++,Z++,R.postfix(Z,K),R.postfix(Z,j),R.postfix(Z,F),R.mkInfixl(c),R.mkInfixr(c);{var Q=R.build().setName("expr").profile(),n=function(e){return function(){return arguments[e]}},et=h("stmt").firstTokens();p("exprstmt").ands(Q,m(";")).ret("expr")}p("compound").ands(m("{"),et.rep0(),m("}")).ret(null,"stmts");var tt=m("else").and(et).ret(n(1)),nt=(p("return").ands(m("return"),Q.opt(),m(";")).ret(null,"value"),p("if").ands(m("if"),m("("),Q,m(")"),et,tt.opt()).ret(null,null,"cond",null,"then","_else"),p("forin").ands(m("var").opt(),g.sep1(m(","),!0),m("in"),Q).ret("isVar","vars",null,"set")),rt=p("normalFor").ands(et,Q.opt(),m(";"),Q.opt()).ret("init","cond",null,"next"),it=rt.or(nt),ot=(p("for").ands(m("for"),m("("),it,m(")"),"stmt").ret(null,null,"inFor",null,"loop"),p("while").ands(m("while"),m("("),Q,m(")"),"stmt").ret(null,null,"cond",null,"loop"),p("do").ands(m("do"),"stmt",m("while"),m("("),Q,m(")"),m(";")).ret(null,"loop",null,null,"cond",null,null),p("case").ands(m("case"),Q,m(":"),et.rep0()).ret(null,"value",null,"stmts")),st=p("default").ands(m("default"),m(":"),et.rep0()).ret(null,null,"stmts"),at=(p("switch").ands(m("switch"),m("("),Q,m(")"),m("{"),ot.rep1(),st.opt(),m("}")).ret(null,null,"value",null,null,"cases","defs"),p("break").ands(m("break"),m(";")).ret("brk"),p("continue").ands(m("continue"),m(";")).ret("cont"),p("finally").ands(m("finally"),"stmt").ret(null,"stmt"),p("catch").ands(m("catch"),m("("),g,m(")"),"stmt").ret(null,null,"name",null,"stmt"),p("catches").ors("catch","finally")),ut=(p("try").ands(m("try"),"stmt",at.rep1()).ret(null,"stmt","catches"),p("throw").ands(m("throw"),Q,m(";")).ret(null,"ex"),g),ct=p("typeDecl").ands(m(":"),ut).ret(null,"vtype"),ft=p("varDecl").ands(g,ct.opt(),m("=").and(Q).ret(n(1)).opt()).ret("name","vtype","value"),lt=(p("varsDecl").ands(m("var"),ft.sep1(m(","),!0),m(";")).ret(null,"decls"),p("paramDecl").ands(g,ct.opt()).ret("name","vtype")),pt=p("paramDecls").ands(m("("),lt.sep0(m(","),!0),m(")")).ret(null,"params"),ht=p("setterDecl").ands(m("="),lt).ret(null,"value");p("funcDeclHead").ands(m("nowait").opt(),m("function").or(m("fiber")).or(m("tk_constructor")).or(m("\\")).opt(),g.or(m("new")),ht.opt(),pt.opt(),ct.opt()).ret("nowait","ftype","name","setter","params","rtype");p("funcDecl").ands("funcDeclHead","compound").ret("head","body"),p("nativeDecl").ands(m("native"),g,m(";")).ret(null,"name"),p("ifWait").ands(m("ifwait"),"stmt",tt.opt()).ret(null,"then","_else");et=p("stmt").ors("return","if","for","while","do","break","continue","switch","ifWait","try","throw","nativeDecl","funcDecl","compound","exprstmt","varsDecl"),p("funcExprHead").ands(m("function").or(m("\\")),g.opt(),pt.opt()).ret(null,"name","params");var mt=(p("funcExpr").ands("funcExprHead","compound").ret("head","body"),p("jsonElem").ands(g.or(I),m(":").and(Q).ret(function(e,t){return t}).opt()).ret("key","value")),dt=(p("objlit").ands(m("{"),mt.sep0(m(","),!0),m("}")).ret(null,"elems"),p("arylit").ands(m("["),Q.sep0(m(","),!0),m("]")).ret(null,"elems"),p("extends").ands(m("extends"),g.or(m("null")),m(";")).ret(null,"superclassName")),gt=p("includes").ands(m("includes"),g.sep1(m(","),!0),m(";")).ret(null,"includeClassNames"),vt=p("program").ands(dt.opt(),gt.opt(),et.rep0(),o.TokensParser.eof).ret("ext","incl","stmts");for(var yt in p.defs)p.defs[yt].profile();return l.parse=function(e){str="string"==typeof e?e:e.text(),str+="\n";var t=r.parse(str);if(!t.isSuccess())throw a("文法エラー(Token)",e,t.src.maxPos);var n=t.result[0],i=f.TokensParser.parse(vt,n);if(i.isSuccess()){var o=i.result[0];return o}var s=n[i.src.maxPos],u=s?s.pos+s.len:str.length;throw a("文法エラー",e,u)},l.genXML=function(e,n){var r=t(e);return r(n),r.buf},l.extension="tonyu",l}()}),requireSimulator.setName("ObjectMatcher"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return ObjectMatcher=function(){function e(e,t){var n={};return n[i]=e,t&&(n[o]=t),n}function t(e){return e&&e[i]}function n(e,t,r){if(e===t)return!0;if(null==e)return!1;if("string"==typeof e&&t instanceof RegExp)return e.match(t);if("function"==typeof t)return t(e,r);if("object"==typeof t){for(var s in t)if(s!=i){var a=s==o?e:e[s],u=t[s];if(!n(a,u,r))return!1}return t[i]&&(r[t[i]]=e),!0}return!1}var r={},i="$var",o="$this";r.v=e,r.isVar=t;for(var s="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=0;a<s.length;a++){var u=s.substring(a,a+1);r[u]=e(u)}return r.match=function(e,t){var r={};return n(e,t,r)?r:null},r}()}),requireSimulator.setName("context"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return context=function(){function e(e,n){var r={};for(var i in e)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=t[i],t[i]=t.ovrFunc(t[i],e[i])):(r[i]=t[i],t[i]=e[i]);n(t);for(var i in r)t[i]=r[i]}var t={};return t.ovrFunc=function(e,t){return t.parent=e,t},t.enter=e,t}}),requireSimulator.setName("Visitor"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Visitor=function(e){var t={funcs:e,path:[]};return t.visit=function(n){try{t.path.push(n),t.debug&&console.log("visit ",n.type,n.pos);var r=n?e[n.type]:null;if(r)return r.call(t,n);if(t.def)return t.def.call(t,n)}finally{t.path.pop()}},t.replace=function(e){return t.def||(t.def=function(e){if("object"==typeof e)for(var n in e)e[n]&&"object"==typeof e[n]&&(e[n]=t.visit(e[n]));return e}),t.visit(e)},t}}),requireSimulator.setName("Tonyu.Compiler"),define(["Tonyu","ObjectMatcher","TError"],function(e){function t(e,t){var n={type:e};if(t)for(var r in t)n[r]=t[r];return n.name||(n.name=o("_"+e+"_")),n}function n(e){return e?e.type:null}function r(e){var t=function(){};return t.prototype=e,new t}function i(e,t){if(!e)throw t+" is null";return e}function o(e){return e+(h++ +"").replace(/\./g,"")}function s(e,t,n){t._id||(e._idseq||(e._idseq=0),t._id=++e._idseq);var r=e[t._id];if(r||(r=e[t._id]={node:t}),n)for(var i in n)r[i]=n[i];return r}function a(e,t){return e.substring(t.pos,t.pos+t.len)}function u(e,t){var n=null;return c(e).forEach(function(e){n||(n=e.decls.methods[t])}),n}function c(e){function t(e){n[e.fullName]||(n[e.fullName]=!0,r.push(e),e.superclass&&t(e.superclass),e.includes&&e.includes.forEach(t))}var n={},r=[];return t(e),r}function f(e){var t=[];if(!e.head)return t;e.head.setter&&t.push(e.head.setter.value);var n=e.head.params?e.head.params.params:null;if(n&&!n.forEach)throw new Error(e+" is not array ");return n&&(t=t.concat(n)),t}var l={};e.Compiler=l;var p={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PARAM:"param",GLOBAL:"global",CLASS:"class",MODULE:"module"};l.ScopeTypes=p;var h=1;return l.newScopeType=t,l.getScopeType=n,l.newScope=r,l.nullCheck=i,l.genSym=o,l.annotation=s,l.getSource=a,l.getMethod=u,l.getDependingClasses=c,l.getParams=f,l}),requireSimulator.setName("Tonyu.Compiler.JSGenerator"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler","assert"],function(e,t,n,r,i,o,s,a,u,c){return u.JSGenerator=function(){function e(e,N){function B(e){return u.getSource(H,e)}function k(t,n){return E(e.annotation,t,n)}function D(e){return"string"==typeof e?x+(N.aliases[e]||e):e.builtin?e.fullName:x+e.fullName}function I(e){var t=[];return e.forEach(function(e){t.push(D(e))}),t}function C(e,t){return function(){Z.enter(e,function(){v.visit(t)})}}function R(e,r,i){var o=L(r);if(o==it.THVAR)X.printf("%s",t);else if(o==it.FIELD)X.printf("%s.%s",n,e);else if(o==it.METHOD)i&&i.noBind?X.printf("%s.%s",n,e):X.printf("%s(%s,%s.%s)",g,n,n,e);else if(o==it.CLASS)X.printf("%s",D(e));else if(o==it.GLOBAL)X.printf("%s%s",M,e);else{if(o!=it.PARAM&&o!=it.LOCAL&&o!=it.NATIVE&&o!=it.MODULE)throw console.log("Unknown scope type: ",o),new Error("Unknown scope type: "+o);X.printf("%s",e)}return r}function F(e){return function(){_.apply(this,[e])}}function _(e){"compound"==e.type?Z.enter({noWait:!0},function(){X.printf("%j%n",["%n",e.stmts])}):v.visit(e)}function j(t){return function(){Z.noLastPos||X.printf("%s%s=%s;//%s%n",N.options.compiler.commentLastPos?"//":"",h,tt.add(e,t.pos),e.fullName+":"+t.pos)}}function O(){Z.enter({},function(){if(at){Y("define(function (require) {%{");var t={Tonyu:1};for(var n in e.decls.amds)t[n]=1;if(e.superclass){var n=e.superclass.shortName;t[n]=1}(e.includes||[]).forEach(function(e){var n=e.shortName;t[n]=1});for(var n in e.decls.softRefClasses)t[n]=1;for(var n in t)Y("var %s=require('%s');%n",n,n)}Y((at?"return ":"")+"Tonyu.klass.define({%{"),Y("fullName: %l,%n",e.fullName),Y("shortName: %l,%n",e.shortName),Y("namespace: %l,%n",e.namespace),e.superclass&&Y("superclass: %s,%n",D(e.superclass)),Y("includes: [%s],%n",I(e.includes).join(",")),Y("methods: {%{");for(var r in rt){Q&&console.log("method1",r);var i=rt[r];Z.enter({noWait:!0,threadAvail:!1},function(){q(i)}),Q&&console.log("method2",r),i.nowait||Z.enter({noWait:!1,threadAvail:!0},function(){V(i)}),Q&&console.log("method3",r)}Y("__dummy: false%n"),Y("%}},%n"),Y("decls: %s%n",JSON.stringify(G(e))),Y("%}});"),at&&Y("%n%}});")})}function G(e){var t={methods:{}};for(var n in e.decls.methods)t.methods[n]={nowait:!!e.decls.methods[n].nowait};return t}function V(e){function r(){Z.enter({method:e,noWait:!0,threadAvail:!0},function(){s.forEach(function(e){Y("%v%n",e)})})}function i(){Z.enter({method:e,finfo:e,pc:1},function(){a.forEach(function(e){Y("%v%n",e)})})}if(!K(e)){var o=e.stmts,s=[],a=[],u=s,c=!0;c?o.forEach(function(e){k(e).fiberCallRequired&&(u=a),u.push(e)}):a=o,Y("%s%s :function %s(%j) {%{"+w+"var %s=%s;%n%svar %s=%s;%nvar %s=0;%n%f%n%f%n",l,e.name,W(e.pos,"f_"+e.name),[",",[ut].concat(e.params)],n,S,e.useArgs?"":"//",f,"Tonyu.A(arguments)",p,z(e),r),a.length>0?Y("%s.enter(function %s(%s) {%{if (%s.lastEx) %s=%s.catchPC;%nfor(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}});%n",t,W(e.pos,"ent_"+e.name),t,t,p,t,m,d,m,p,i,t,n):Y("%s.retVal=%s;return;%n",t,n),Y("%}},%n")}}function q(e){function t(){Z.enter({method:e,finfo:e},function(){e.stmts.forEach(function(e){Y("%v%n",e)})})}var r=K(e)?"initialize":e.name;Y("%s :function %s(%j) {%{"+w+"var %s=%s;%n%f%n%f%}},%n",r,W(e.pos,r),[",",e.params],n,S,z(e),t)}function U(e){function t(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){Y("%v%n",e)})})}var n=k(e);X.printf("(function %s(%j) {%{%f%n%f%}})",n.name,[",",n.params],z(n),t)}function W(t,n){return n||(n=ot++ +""),"_trc_"+e.shortName+"_"+n}function $(e){function t(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){Y("%v%n",e)})})}var n=k(e);X.printf("function %s(%j) {%{%f%n%f%}}",n.name,[",",n.params],z(n),t)}function z(e){function t(){Z.enter({},function(){for(var t in e.locals.varDecls)X.printf("var %s;%n",t);for(var t in e.locals.subFuncDecls)$(e.locals.subFuncDecls[t])})}return t}function K(e){return et.match(e,{ftype:"constructor"})||et.match(e,{name:"new"})}var J=e.src.tonyu,H=J.text(),X=o(),Y=X.printf,Z=s(),Q=!1,et=r,tt=N.traceTbl,nt=e.decls,rt=(nt.fields,nt.methods),it=(nt.natives,P),ot=0,st=N.options.compiler.diagnose,at=N.options.compiler.genAMD,ut={type:"THNode"};v=X.visitor=a({THNode:function(){X.printf(t)},dummy:function(e){X.printf("",e)},literal:function(e){X.printf("%s",e.text)},paramDecl:function(e){X.printf("%v",e.name)},paramDecls:function(e){X.printf("(%j)",[", ",e.params])},funcDeclHead:function(e){X.printf("function %v %v",e.name,e.params)},funcDecl:function(){},"return":function(e){if(Z.inTry)throw i("現実装では、tryの中にreturnは書けません",J,e.pos);Z.noWait?Z.threadAvail?e.value?X.printf("%s.retVal=%v;return;%n",t,e.value):X.printf("%s.retVal=%s;return;%n",t,n):e.value?X.printf("return %v;",e.value):X.printf("return %s;",n):e.value?X.printf("%s.exit(%v);return;",t,e.value):X.printf("%s.exit(%s);return;",t,n)},program:function(e){genClass(e.stmts)},number:function(e){X.printf("%s",e.value)},reservedConst:function(e){"this"==e.text?X.printf("%s",n):"arguments"==e.text&&Z.threadAvail?X.printf("%s",f):e.text==t?X.printf("%s",Z.threadAvail?t:"null"):X.printf("%s",e.text)},varDecl:function(e){var r=k(e),i=r.varInMain?n+".":"";if(e.value){var o=!Z.noWait&&k(e).fiberCall;o?(c.is(Z.pc,Number),X.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%s%v=%s.retVal;%n",n,l,o.N,[", ",[ut].concat(o.A)],p,Z.pc,Z.pc++,i,e.name,t)):X.printf("%s%v = %v;%n",i,e.name,e.value)}},varsDecl:function(e){var t=e.decls.filter(function(e){return e.value});t.length>0&&(j(e)(),t.forEach(function(e){X.printf("%v",e)}))},jsonElem:function(e){e.value?X.printf("%v: %v",e.key,e.value):X.printf("%v: %f",e.key,function(){R(e.key.text,k(e).scopeInfo,k(e))})},objlit:function(e){X.printf("{%j}",[",",e.elems])},arylit:function(e){X.printf("[%j]",[",",e.elems])},funcExpr:function(e){U(e)},parenExpr:function(e){X.printf("(%v)",e.expr)},varAccess:function(e){{var t=e.name.text;R(t,k(e).scopeInfo,k(e))}},exprstmt:function(r){var i={};if(j(r)(),Z.noWait||(i=k(r).fiberCall||{}),"noRet"==i.type)X.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{",n,l,i.N,[", ",[ut].concat(i.A)],p,Z.pc,Z.pc++);else if("ret"==i.type)X.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",n,l,i.N,[", ",[ut].concat(i.A)],p,Z.pc,Z.pc++,i.L,i.O,t);else if("noRetSuper"==i.type){var o=D(e.superclass);X.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{",o,l,i.S.name.text,n,[", ",[ut].concat(i.A)],p,Z.pc,Z.pc++)}else"retSuper"==i.type?X.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",o,l,i.S.name.text,n,[", ",[ut].concat(i.A)],p,Z.pc,Z.pc++,i.L,i.O,t):X.printf("%v;",r.expr)},infix:function(e){var t=e.op.text;if(st){if("+"==t||"-"==t||"*"==t||"/"==t||"%"==t)return void X.printf("%s(%v,%l)%v%s(%v,%l)",T,e.left,B(e.left),e.op,T,e.right,B(e.right));if("+="==t||"-="==t||"*="==t||"/="==t||"%="==t)return void X.printf("%v%v%s(%v,%l)",e.left,e.op,T,e.right,B(e.right))}X.printf("%v%v%v",e.left,e.op,e.right)},trifixr:function(e){X.printf("%v%v%v%v%v",e.left,e.op1,e.mid,e.op2,e.right)},prefix:function(e){X.printf("%v %v",e.op,e.right)},postfix:function(e){var t=k(e);if(st){if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=L(i);return void(o==it.FIELD||o==it.METHOD?X.printf("%s(%s, %l, [%j], %l )",y,n,r.name,[",",r.args],"this"):X.printf("%s(%v, [%j], %l)",b,e.left,[",",r.args],B(e.left)))}if(t.othersMethodCall){var s=t.othersMethodCall;return void X.printf("%s(%v, %l, [%j], %l )",y,s.target,s.name,[",",s.args],B(s.target))}if(t.memberAccess){var a=t.memberAccess;return void X.printf("%s(%v,%l).%s",T,a.target,B(a.target),a.name)}}else if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=L(i);if(o==it.METHOD)return void X.printf("%s.%s(%j)",n,r.name,[",",r.args])}X.printf("%v%v",e.left,e.op)},"break":function(e){if(Z.noWait)X.printf("break;%n");else{if(Z.inTry&&Z.exitTryOnJump)throw i("現実装では、tryの中にbreak;は書けません",J,e.pos);if(!Z.closestBrk)throw i("break； は繰り返しの中で使います",J,e.pos);X.printf("%s=%z; break;%n",p,Z.closestBrk)}},"continue":function(e){if(Z.noWait)X.printf("continue;%n");else{if(Z.inTry&&Z.exitTryOnJump)throw i("現実装では、tryの中にcontinue;は書けません",J,e.pos);if("number"==typeof Z.closestCnt)X.printf("%s=%s; break;%n",p,Z.closestCnt);else{if(!Z.closestCnt)throw i("continue； は繰り返しの中で使います",J,e.pos);X.printf("%s=%z; break;%n",p,Z.closestCnt)}}},"try":function(e){var n=k(e);if(!Z.noWait&&(n.fiberCallRequired||n.hasJump||n.hasReturn)){if(1!=e.catches.length||"catch"!=e.catches[0].type)throw i("現実装では、catch節1個のみをサポートしています",J,e.pos);var r=e.catches[0],o={},s={};X.printf("%s.enterTry(%z);%n",t,o),X.printf("%f",C({inTry:!0,exitTryOnJump:!0},e.stmt)),X.printf("%s.exitTry();%n",t),X.printf("%s=%z;break;%n",p,s),X.printf("%}case %f:%{",function(){X.print(o.put(Z.pc++))}),X.printf("%s=%s.startCatch();%n",r.name.text,t),X.printf("%s.exitTry();%n",t),X.printf("%v%n",r.stmt),X.printf("%}case %f:%{",function(){X.print(s.put(Z.pc++))})}else Z.enter({noWait:!0},function(){X.printf("try {%{%f%n%}} ",F(e.stmt)),e.catches.forEach(v.visit)})},"catch":function(e){X.printf("catch (%s) {%{%f%n%}}",e.name.text,F(e.stmt))},"throw":function(e){X.printf("throw %v;%n",e.ex)},"switch":function(e){if(Z.noWait)X.printf("switch (%v) {%{%j"+(e.defs?"%v":"%D")+"%n%}}",e.value,["%n",e.cases],e.defs);else{var t=e.cases.map(function(){return X.lazy()});e.defs&&t.push(X.lazy()),X.printf("switch (%v) {%{%f%n%}}%nbreak;%n",e.value,function(){var n=0;e.cases.forEach(function(e){X.printf("%}case %v:%{%s=%z;break;%n",e.value,p,t[n]),n++}),e.defs&&X.printf("%}default:%{%s=%z;break;%n",p,t[n])});var n=X.lazy();Z.enter({closestBrk:n},function(){var r=0;e.cases.forEach(function(e){X.printf("%}case %f:%{%j%n",function(){X.print(t[r].put(Z.pc++))},["%n",e.stmts]),r++}),e.defs&&X.printf("%}case %f:%{%j%n",function(){X.print(t[r].put(Z.pc++))},["%n",e.defs.stmts]),X.printf("case %f:%n",function(){X.print(n.put(Z.pc++))})})}},"case":function(e){X.printf("%}case %v:%{%j",e.value,["%n",e.stmts])},"default":function(e){X.printf("%}default:%{%j",["%n",e.stmts])},"while":function(e){j(e)();var t=k(e);if(Z.noWait||!t.fiberCallRequired&&!t.hasReturn)Z.enter({noWait:!0},function(){X.printf("while (%v) {%{%f%n%}}",e.cond,F(e.loop))});else{var n=X.lazy(),r=Z.pc++,i="reservedConst"==e.cond.type&&"true"==e.cond.text;X.printf("%}case %d:%{"+(i?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",r,e.cond,p,n,C({closestBrk:n,closestCnt:r,exitTryOnJump:!1},e.loop),p,r,function(){X.print(n.put(Z.pc++))})}},"do":function(e){j(e)();var t=k(e);if(Z.noWait||!t.fiberCallRequired&&!t.hasReturn)Z.enter({noWait:!0},function(){X.printf("do {%{%f%n%}} while (%v);%n",F(e.loop),e.cond)});else{var n=X.lazy(),r=X.lazy(),i=Z.pc++;X.printf("%}case %d:%{%f%n%}case %f:%{if (%v) { %s=%s; break; }%n%}case %f:%{",i,C({closestBrk:n,closestCnt:r,exitTryOnJump:!1},e.loop),function(){X.print(r.put(Z.pc++))},e.cond,p,i,function(){X.print(n.put(Z.pc++))})}},"for":function(e){function t(e,t,n){return function(){n.forEach(function(t,n){X.printf("%s=%s[%s];%n",t.text,e,n)})}}j(e)();var n=k(e);if("forin"==e.inFor.type){var r=k(e.inFor).iterName;if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){X.printf("%s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%f%n%}}",r,A,e.inFor.set,e.inFor.vars.length,r,t(r,e.inFor.isVar,e.inFor.vars),F(e.loop))});else{var i=X.lazy(),o=Z.pc++;X.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",r,A,e.inFor.set,e.inFor.vars.length,o,r,p,i,t(r,e.inFor.isVar,e.inFor.vars),C({closestBrk:i,closestCnt:o,exitTryOnJump:!1},e.loop),p,o,function(e){e.print(i.put(Z.pc++))})}}else if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){"varsDecl"==e.inFor.init.type||"exprstmt"==e.inFor.init.type?X.printf("%vfor (; %v ; %v) {%{%v%n%}}",e.inFor.init,e.inFor.cond,e.inFor.next,e.loop):X.printf("%v%nwhile(%v) {%{%v%n%v;%n%}}",e.inFor.init,e.inFor.cond,e.loop,e.inFor.next)});else{var i=X.lazy(),s=X.lazy(),o=Z.pc++;X.printf("%v%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%}case %f:%{%v;%n%s=%s;break;%n%}case %f:%{",e.inFor.init,o,e.inFor.cond,p,i,C({closestBrk:i,closestCnt:s,exitTryOnJump:!1},e.loop),function(e){e.print(s.put(Z.pc++))},e.inFor.next,p,o,function(e){e.print(i.put(Z.pc++))})}},"if":function(e){j(e)();var t=k(e);if(!Z.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)){var n={},r={};e._else?X.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",e.cond,p,r,e.then,p,n,function(){X.print(r.put(Z.pc++))},e._else,function(){X.print(n.put(Z.pc++))}):X.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",e.cond,p,n,e.then,function(){X.print(n.put(Z.pc++))})}else Z.enter({noWait:!0},function(){e._else?X.printf("if (%v) {%{%f%n%}} else {%{%f%n%}}",e.cond,F(e.then),F(e._else)):X.printf("if (%v) {%{%f%n%}}",e.cond,F(e.then))})},ifWait:function(e){Z.noWait?e._else&&X.printf("%v",e._else):X.printf("%v",e.then)},call:function(e){X.printf("(%j)",[",",e.args])},objlitArg:function(e){X.printf("%v",e.obj)},argList:function(e){X.printf("%j",[",",e.args])},newExpr:function(e){var t=e.params;t?X.printf("new %v%v",e.klass,t):X.printf("new %v",e.klass)},scall:function(e){X.printf("[%j]",[",",e.args])},superExpr:function(t){var r;if(!e.superclass)throw new Error(e.fullName+"には親クラスがありません");t.name?(r=t.name.text,X.printf("%s.prototype.%s.apply( %s, %v)",D(e.superclass),r,n,t.params)):X.printf("%s.apply( %s, %v)",D(e.superclass),n,t.params)},arrayElem:function(e){X.printf("[%v]",e.subscript)},member:function(e){X.printf(".%v",e.name)},symbol:function(e){X.print(e.text)},normalFor:function(e){X.printf("%v; %v; %v",e.init,e.cond,e.next)},compound:function(e){var t=k(e);!Z.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)?X.printf("%j",["%n",e.stmts]):Z.enter({noWait:!0},function(){X.printf("{%{%j%n%}}",["%n",e.stmts])
})},"typeof":function(){X.printf("typeof ")},"instanceof":function(){X.printf(" instanceof ")},is:function(){X.printf(" instanceof ")},regex:function(e){X.printf("%s",e.text)}});var ct=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];return ct.forEach(function(e){v.funcs[e]=function(){X.printf("%s",e)}}),v.def=function(e){throw console.log("Err node="),console.log(e),new Error(e.type+" is not defined in visitor:compiler2")},v.cnt=0,O(),at?(e.src.js=e.src.tonyu.up().rel(e.src.tonyu.truncExt()+".js"),e.src.js.text(X.buf)):e.src.js=X.buf,Q&&console.log("method4",X.buf),X.buf}{var t="_thread",n="_this",f="_arguments",l="fiber$",p="__pc",h="$LASTPOS",m="__cnt",d=100,g="Tonyu.bindFunc",y="Tonyu.invokeMethod",b="Tonyu.callFunc",T="Tonyu.checkNonNull",x="Tonyu.classes.",M="Tonyu.globals.",S="this",w='"use strict";%n',A="Tonyu.iterator",P=u.ScopeTypes,L=u.getScopeType,E=u.annotation;u.getMethod,u.getDependingClasses,u.getParams}return{genJS:e}}()}),requireSimulator.setName("Tonyu.Compiler.Semantics"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(e,t,n,r,i,o,s,a,u){return u.Semantics=function(){function e(e,t){function o(n){var r,o=t.options.compiler.defaultSuperClass,s=0;if((r=m.match(n,{ext:{superclassName:{text:m.N,pos:m.P}}}))&&(o=r.N,s=r.P,"null"==o&&(o=null)),e.includes=[],(r=m.match(n,{incl:{includeClassNames:m.C}}))&&r.C.forEach(function(n){var r=n.text,o=n.pos,s=t.classes[t.aliases[r]||r];if(!s)throw i("クラス "+r+"は定義されていません",a,o);e.includes.push(s)}),"Array"==o)e.superclass={name:"Array",fullName:"Array",builtin:!0};else if(o){var p=t.classes[t.aliases[o]||o];if(!p)throw i("親クラス "+o+"は定義されていません",a,s);e.superclass=p}else delete e.superclass;n.stmts.forEach(function(e){if("funcDecl"==e.type){var t=e.head,n="function";t.ftype&&(n=t.ftype.text);var r=t.name.text,i=t.params?"":t.setter?"__setter__":"__getter__";r=i+r,f[r]={nowait:!!t.nowait||""!=i,ftype:n,name:r,head:t,pos:t.pos,stmts:e.body.stmts}}else"nativeDecl"==e.type?l[e.name.text]=e:("varsDecl"==e.type&&e.decls.forEach(function(e){console.log("varDecl",e.name.text),c[e.name.text]=e}),u.stmts.push(e))})}var s,a=e.src.tonyu;e.node&&e.nodeTimestamp==a.lastUpdate()&&(s=e.node),s||(console.log("Parse "+a),s=n.parse(a),e.nodeTimestamp=a.lastUpdate());var u={name:"main",stmts:[],pos:0,isMain:!0},c={},f={main:u},l={},p={},h={};e.decls={fields:c,methods:f,natives:l,amds:p,softRefClasses:h},e.node=s;var m=r;o(s)}function t(e,t){function n(e){return u.getSource(_,e)}function y(t,n){return h(e.annotation,t,n)}function b(e){if(!e.builtin){var t=q,n=e.decls;for(var r in n.fields)t[r]=c(V.FIELD,{klass:e.name,name:r});for(var r in n.methods)t[r]=c(V.METHOD,{klass:e.name,name:r})}}function T(){var n=q;d(e).forEach(b);var r=e.decls;for(var i in r.natives)n[i]=c(V.NATIVE,{name:"native::"+i});for(var i in v)n[i]=c(V.NATIVE,{name:"native::"+i});for(var i in t.aliases)n[i]=c(V.CLASS,{name:i})}function x(){var t=d(e);for(var n in e.decls.methods){var r=e.decls.methods[n];t.forEach(function(e){var t=e.decls.methods[n];t&&t.nowait&&(r.nowait=!0)})}}function M(t){return m(e,t)}function S(e){if("varAccess"==e.type||"postfix"==e.type&&("member"==e.op.type||"arrayElem"==e.op.type))return"varAccess"==e.type&&y(e,{noBind:!0}),!0;throw console.log("LVal",e),i("'"+n(e)+"'は左辺には書けません．",F,e.pos)}function w(n){var r=U.scope[n],i=f(r);if(!i){if(t.amdPaths&&t.amdPaths[n])i=V.MODULE,e.decls.amds[n]=t.amdPaths[n];else{var o=n.match(/^\$/);i=o?V.GLOBAL:V.FIELD}var s={name:n};i==V.FIELD&&(s.klass=e.name,e.decls.fields[n]=r),r=q[n]=c(i,s)}return i==V.CLASS&&(e.decls.softRefClasses[n]=r),r}function A(e){var t=this;if(e&&"object"==typeof e){var n;if(n=e instanceof Array?e:e[Grammar.SUBELEMENTS],!n){n=[];for(var r in e)n.push(e[r])}n.forEach(function(e){t.visit(e)})}}function P(e){var t={varDecls:{},subFuncDecls:{}};return U.enter({locals:t},function(){Z.visit(e)}),t}function L(e,t){e.forEach(function(e){y(e,t)})}function E(e){U.method&&(U.method.fiberCallRequired=!0),L(e,{fiberCallRequired:!0})}function N(e,t){U.enter({scope:t},function(){Q.visit(e)})}function B(e,t){for(var n in e.varDecls)t[n]=c(V.LOCAL);for(var n in e.subFuncDecls)t[n]=c(V.LOCAL)}function k(e){U.enter({isMain:e.isMain},function(){e.locals=P(e.stmts),e.params=g(e)})}function D(e){var t,n,r=e.body,i=e.head.name?e.head.name.text:"anonymous_"+e.pos;n=(t=j.match(e,{head:{params:{params:j.P}}}))?t.P:[];var o=l(U.scope);n.forEach(function(e){o[e.name.text]=c(V.PARAM)});var s=P(r);B(s,o);var a=y(e);U.enter({finfo:a},function(){N(r,o)});var u={scope:o,locals:s,name:i,params:n};return y(e,u),y(e,a),I(s,o),u}function I(e,t){U.enter({scope:t},function(){for(var t in e.subFuncDecls)D(e.subFuncDecls[t])})}function C(t){var n=l(U.scope);return t.params.forEach(function(r,i){n[r.name.text]=c(V.PARAM,{klass:e.name,name:t.name,no:i})}),B(t.locals,n),U.enter({method:t,finfo:t,noWait:!1},function(){N(t.stmts,n)}),t.scope=n,I(t.locals,n),n}function R(){U.enter({scope:q},function(){for(var e in G){W&&console.log("anon method1",e);var t=G[e];k(t),C(t)}})}var F=e.src.tonyu,_=F.text(),j=r,O=(t.traceTbl,e.decls),G=(O.fields,O.methods),V=(O.natives,O.amds,o),q={},U=s(),W=!1,$={type:"postfix",left:{type:"postfix",left:j.T,op:{type:"member",name:{text:j.N}}},op:{type:"call",args:j.A}},z={type:"postfix",left:j.T,op:{type:"member",name:{text:j.N}}},K=fiberCallTmpl={type:"postfix",left:{type:"varAccess",name:{text:j.N}},op:{type:"call",args:j.A}},J={expr:fiberCallTmpl},H={expr:{type:"infix",op:j.O,left:j.L,right:fiberCallTmpl}},X={expr:{type:"superExpr",params:{args:j.A},$var:"S"}},Y={expr:{type:"infix",op:j.O,left:j.L,right:{type:"superExpr",params:{args:j.A},$var:"S"}}};e.annotation={};var Z=a({varDecl:function(e){U.isMain?y(e,{varInMain:!0}):U.locals.varDecls[e.name.text]=e},funcDecl:function(e){U.locals.subFuncDecls[e.head.name.text]=e},funcExpr:function(){},"catch":function(e){U.locals.varDecls[e.name.text]=e},exprstmt:function(){},forin:function(e){e.isVar;e.vars.forEach(function(t){U.locals.varDecls[t.text]=e});var t=p("_it_");y(e,{iterName:t}),U.locals.varDecls[t]=e}});Z.def=A;var Q=a({varAccess:function(e){{var t=w(e.name.text);f(t)}y(e,{scopeInfo:t})},funcDecl:function(){},funcExpr:function(e){D(e)},objlit:function(e){var t=this,n={};e.elems.forEach(function(e){var r;if(r="literal"==e.key.type?e.key.text.substring(1,e.key.text.length-1):e.key.text,n[r])throw i("オブジェクトリテラルのキー名'"+r+"'が重複しています",F,e.pos);n[r]=1,t.visit(e)})},jsonElem:function(e){if(e.value)this.visit(e.value);else{if("literal"==e.key.type)throw i("オブジェクトリテラルのパラメタに単独の文字列は使えません",F,e.pos);var t=w(e.key.text);y(e,{scopeInfo:t})}},"do":function(e){var t=this;U.enter({brkable:!0,contable:!0},function(){t.def(e)})},"switch":function(e){var t=this;U.enter({brkable:!0},function(){t.def(e)})},"while":function(e){var t=this;U.enter({brkable:!0,contable:!0},function(){t.def(e)}),E(this.path)},"for":function(e){var t=this;U.enter({brkable:!0,contable:!0},function(){t.def(e)})},forin:function(e){e.vars.forEach(function(e){var t=w(e.text);y(e,{scopeInfo:t})}),this.visit(e.set)},ifWait:function(e){var t="_thread",n=this,r=l(U.scope);r[t]=c(V.THVAR),U.enter({scope:r},function(){n.visit(e.then)}),e._else&&n.visit(e._else),E(this.path)},"try":function(e){U.finfo.useTry=!0,this.def(e)},"return":function(e){U.noWait||L(this.path,{hasReturn:!0}),this.visit(e.value)},"break":function(e){if(!U.brkable)throw i("break； は繰り返しまたはswitch文の中で使います.",F,e.pos);U.noWait||L(this.path,{hasJump:!0})},"continue":function(e){if(!U.contable)throw i("continue； は繰り返しの中で使います.",F,e.pos);U.noWait||L(this.path,{hasJump:!0})},reservedConst:function(e){"arguments"==e.text&&(U.finfo.useArgs=!0)},postfix:function(e){var t;if(this.visit(e.left),this.visit(e.op),t=j.match(e,K)){var n=y(e.left).scopeInfo;y(e,{myMethodCall:{name:t.N,args:t.A,scopeInfo:n}})}else(t=j.match(e,$))?y(e,{othersMethodCall:{target:t.T,name:t.N,args:t.A}}):(t=j.match(e,z))&&y(e,{memberAccess:{target:t.T,name:t.N}})},infix:function(e){var t=e.op.text;("="==t||"+="==t||"-="==t||"*="==t||"/="==t||"%="==t)&&S(e.left),this.def(e)},exprstmt:function(t){var n,r;if(U.noWait||!(n=j.match(t,J))||f(U.scope[n.N])!=V.METHOD||M(n.N).nowait)if(U.noWait||!(n=j.match(t,H))||f(U.scope[n.N])!=V.METHOD||M(n.N).nowait){if(!U.noWait&&(n=j.match(t,X))&&n.S.name){if(r=M(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="noRetSuper",n.superclass=e.superclass,y(t,{fiberCall:n}),E(this.path))}else if(!U.noWait&&(n=j.match(t,Y))&&n.S.name){if(r=M(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="retSuper",n.superclass=e.superclass,y(t,{fiberCall:n}),E(this.path))}}else n.type="ret",y(t,{fiberCall:n}),E(this.path);else n.type="noRet",y(t,{fiberCall:n}),E(this.path);this.visit(t.expr)},varDecl:function(e){var t;U.noWait||!(t=j.match(e.value,fiberCallTmpl))||f(U.scope[t.N])!=V.METHOD||M(t.N).nowait||(t.type="varDecl",y(e,{fiberCall:t}),E(this.path)),this.visit(e.value)}});Q.def=A,T(),x(),R()}var o=u.ScopeTypes,c=u.newScopeType,f=u.getScopeType,l=u.newScope,p=u.genSym,h=u.annotation,m=u.getMethod,d=u.getDependingClasses,g=u.getParams,v={Array:1,String:1,Boolean:1,Number:1,Void:1,Object:1,RegExp:1,Error:1};return{initClassDecls:e,annotate:t}}()}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/(_trc_[A-Za-z0-9_]*).*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(e){var t=e.stack;if("string"!=typeof t)return!1;for(var n=t.split(/\n/),r=[],i=0;i<n.length;i++){var o=pat.exec(n[i]);if(o){var s=o[1],a=o[2],u=o[3];r.push({fname:s,row:a,col:u})}}return console.log("StackTrace.get",r),r},trc}),requireSimulator.setName("Tonyu.TraceTbl"),define(["Tonyu","FS","TError","StackTrace"],function(e,t,n,r){return e.TraceTbl=function(){var e={},i=1e6,o=1,s=1e4,a={},u=[],c={};e.add=function(e,t){var n=e.src.tonyu,r=n.path(),f=a[r];void 0==f&&(f=o++,o>s&&(o=0),a[r]=f,u[f]=r),c[r]=e,t>=i&&(t=i-1);var l=f*i+t;return l};var f={};return e.decodeOLD=function(e){var r=e%i,o=(e-r)/i,s=u[o];if(s){var a=t.get(s),f=c[s];return n("Trace info",f||a,r)}return null},e.srcMap=f,e.decode=function(e){var t=new RegExp("LASTPOS="+e+";//(.*)\r?\n");console.log("pat=",t);for(var n in f){var r=t.exec(f[n]);if(r)return r[1];console.log("pat=",t,"Not found in ",n)}},e.find=function(e){var t=r.get(e),n=t[0];if(!n)return null;var i=new RegExp("LASTPOS=[0-9]+;//(.*)\r?");for(var o in f){console.log("Finding ",n.fname," in ",o);var s=f[o].indexOf(n.fname);if(s>=0){console.log("fname found at ",s);var a=f[o].split(/\n/),u=n.row-1;console.log("Scan from row=",u);for(var c=u;c>=0&&(console.log("row ",c,a[c]),null!=a[c]);c--){var l=i.exec(a[c]);if(l)return l[1]}console.log("Not found LASTPOS pat")}else console.log("Not found in ",o)}},e.addSource=function(e,t){f[e]=t},e}()}),requireSimulator.setName("compiledProject"),define(["DeferredUtil"],function(e){var t=function(t,n){return{getNamespace:function(){return t},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(t){var n=e.directPromise(),r=this.getNamespace();return this.getDependingProjects().forEach(function(e){e.getNamespace()!=r&&(n=n.then(function(){return e.loadClasses(t)}))}),n},loadClasses:function(e){console.log("Load compiled classes ns=",t,"url=",n);var r=new $.Deferred,i=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.src=n;var s=!1;return o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,o.onload=o.onreadystatechange=null,i&&o.parentNode&&i.removeChild(o),console.log("Done Load compiled classes ns=",t,"url=",n,Tonyu.classes),r.resolve())},this.loadDependingClasses(e).then(function(){i.insertBefore(o,i.firstChild)}),r.promise()}}};return t}),requireSimulator.setName("ProjectCompiler"),define(["Tonyu","Tonyu.Compiler.JSGenerator","Tonyu.Compiler.Semantics","Tonyu.TraceTbl","FS","assert","SFile","DeferredUtil","compiledProject"],function(e,t,n,r,i,o,s,a,u){var c=function(r){function f(t){var n=h.env;return t||(t={}),t.visited||(t={visited:{},classes:n.classes=n.classes||e.classMetas,options:t}),t}function l(e){function t(t){var n=t.superclass,i=n?[n]:[];return t.includes&&(i=i.concat(t.includes)),i=i.filter(function(t){return t&&e[t.fullName]&&!t.builtin&&!r[t.fullName]})}function n(e,r){if(console.log("detectloop",e.fullName),o[e.fullName]){console.log("Detected: ",e.fullName,o,o[e.fullName]);var i=e.fullName,s=[];do s.unshift(i),i=o[i];while(i!=e.fullName);return s.unshift(e.fullName),s}r&&(o[e.fullName]=r.fullName);var a,u=t(e);return u.forEach(function(t){if(!a){var r=n(t,e);r&&(a=r)}}),delete o[e.fullName],a}var r={},i=[],o={},s=0;for(var a in e)r[a]=!1,s++;for(;i.length<s;){var u=i.length;for(var a in e)if(!r[a]){var c=e[a],f=t(c);0==f.length&&(i.push(c),r[a]=!0)}if(i.length==u){var l=[];for(var a in e)if(!r[a]){l=n(e[a])||[];break}throw TError("次のクラス間に循環参照があります: "+l.join("->"),"不明",0)}}return i}function p(e){console.log("loading: "+e.path());var t=new Function(e.text());return m.addSource(e.path(),t+""),a.directPromise(t())}o(s.is(r)&&r.isDir(),"projectCompiler: "+r+" is not dir obj");var h={env:{}},m=e.TraceTbl,d=a.throwF;return h.env.traceTbl=m,h.EXT=".tonyu",h.getOptionsFile=function(){var e=r.rel("options.json");return e},h.getOptions=function(){var e=h.env;e.options={};var t=h.getOptionsFile();return t.exists()&&(e.options=t.obj()),h.fixOptions(e.options),e.options},h.setOptions=function(e){h.getOptionsFile().obj(e)},h.fixOptions=function(e){e.compiler||(e.compiler={})},h.resolve=function(e){if(e instanceof Array){var t=[];return e.forEach(function(e){t.push(h.resolve(e))}),t}if("string"==typeof e)return i.resolve(e,r.path());if(!e||!e.isDir)throw new Error("Cannot TPR.resolve: "+e);return e},h.shouldCompile=function(){var t=h.getOutputFile();if(!t.exists())return!0;if(t.isReadOnly())return!1;var n=t.lastUpdate();if(n<e.VERSION)return console.log("Should compile: ",t.name()+" last="+new Date(n)+" < Tonyu.ver="+new Date(e.VERSION)),!0;var r=h.sourceFiles(h.getNamespace());for(var i in r){var o=r[i],s=o.lastUpdate();if(s>n)return console.log("Should compile: ",o.name()+" last="+new Date(s)),!0}var a=h.getOptionsFile();return a.exists()&&a.lastUpdate()>n?(console.log("Should compile: ",a.name()+" last="+new Date(a.lastUpdate())),!0):!1},h.getClassName=function(e){if(o(s.is(e)),r.contains(e))return h.getNamespace()+"."+e.truncExt(h.EXT);var t;return h.getDependingProjects().forEach(function(n){t||(t=n.getClassName(e))}),t},h.getNamespace=function(){var e=h.getOptions();return o(e.compiler.namespace,"namespace not specified opt="+JSON.stringify(e))},h.getOutputFile=function(){var e=h.getOptions(),t=h.resolve(o(e.compiler.outputFile,"outputFile should be specified in options"));if(t.isDir())throw new Error("out: directory style not supported");return t},h.loadDependingClasses=function(e){var t=a.directPromise(),n=h.getNamespace();return h.getDependingProjects().forEach(function(r){r.getNamespace()!=n&&(t=t.then(function(){return r.loadClasses(e)}))}),t},h.loadClasses=function(t){e.runMode=!1,h.showProgress("LoadClasses: "+r.name()),console.log("LoadClasses: "+r.path()),t=f(t);var n=t.visited||{};return n[h.path()]?a.directPromise():(n[h.path()]=!0,h.loadDependingClasses(t).then(function(){return h.shouldCompile()}).then(function(e){if(e)return h.compile(t);var n=h.getOutputFile("js");return h.showProgress("Eval "+n.name()),p(n)}))},h.compile=function(t){e.runMode=!1,h.showProgress("Compile: "+r.name()),console.log("Compile: "+r.path()),t=f(t);var i,o,s,a,u,c,p,m=h.getNamespace();return h.loadDependingClasses(t).then(d(function(){i=t.classes,o=t.options,s=h.env,s.aliases={},s.parsedNode=s.parsedNode||{},s.classes=i;for(var r in i){var f=i[r];s.aliases[f.shortName]=f.fullName}a={},u=!!o.noIncremental,c=h.sourceFiles(m);for(var d in c){var g=c[d],v=m+"."+d;i[v]||(console.log("Class",v,"is added."),u=!0);var y=e.klass.getMeta(v);a[v]=i[v]=y,e.extend(y,{fullName:v,shortName:d,namespace:m}),y.src=y.src||{},y.src.tonyu=g,s.aliases[d]=v}for(var r in i)a[r]&&a[r].src&&!a[r].src.js&&(console.log("Class",r,"has no js src"),u=!0),a[r]||i[r].namespace!=m||(console.log("Class",r,"is removed"),e.klass.removeMeta(r),u=!0);if(u)p=a;else{p={};for(var r in a)e.klass.shouldCompile(a[r])&&(p[r]=a[r])}for(var r in p)console.log("initClassDecl: "+r),n.initClassDecls(p[r],s);var b=l(a);b.forEach(function(e){p[e.fullName]&&(console.log("annotate :"+e.fullName),n.annotate(e,s))}),h.genJS(b.filter(function(e){return p[e.fullName]}));var T=h.getOptions().compiler;return T.genAMD?void 0:h.concatJS(b)}))},h.genJS=function(e){var n=h.env;e.forEach(function(e){console.log("genJS :"+e.fullName),t.genJS(e,n)})},h.concatJS=function(e){var t="",n=h.getOutputFile();return h.showProgress("generate :"+n.name()),console.log("generate :"+n),e.forEach(function(e){if("string"==typeof e.src.js)t+=e.src.js+"\n";else{if(!(e.src.js&&e.src.js.isSFile&&e.src.js.isSFile()))throw new Error("Src for "+e.fullName+" not generated ");t+=e.src.js.text()+"\n"}}),n.text(t),p(n)},h.getDependingProjects=function(){var e=h.getOptions(),t=e.compiler.dependingProjects||[];return t.map(function(e){if("string"==typeof e){var t=h.resolve(e);return c(t)}return"object"==typeof e?u(e.namespace,i.expandPath(e.compiledURL)):void 0})},h.dir=r,h.path=function(){return r.path()},h.sourceFiles=function(e){function t(e){if(e.endsWith(h.EXT)){var t=e.truncExt(h.EXT);r[t]=e}}for(var n=h.sourceDirs(e),r={},i=n.length-1;i>=0;i--)n[i].recursive(t);return r},h.sourceDir=function(){return r},h.sourceDirs=function(e){var t=h.getDependingProjects(),n=[r];return t.forEach(function(t){var r=t.getNamespace();if(!e||r==e){var i=t.sourceDir();i&&n.push(i)}}),n},h.decodeTrace=function(e){var t=e.split(":"),n=t[0],r=parseInt(t[1]),i=n.split("."),o=i.pop(),s=i.join(".");if(s==h.getNamespace()){var a=h.sourceFiles(s);for(var u in a)if(o==u)return TError("Trace info",a[u],r)}},h.showProgress=function(){},h.setAMDPaths=function(e){h.env.amdPaths=e},h};return"object"==typeof sh&&(sh.tonyuc=function(e){var t=c(sh.resolve(e));return t.compile()}),c}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(e){var t=function(e,t){this.options=t||{},this.img=e,this.height=e.height,this.width=e.width;var n=this.newImage(e.width,e.height),r=n.getContext("2d");r.drawImage(e,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,e.width,e.height).data,this.base=this.getPixel(0,0)};return e.extend(t.prototype,{newImage:function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n},getPixel:function(e,t){var n=this.pixels,r=4*(e+t*this.width),i=n[0+r],o=n[1+r],s=n[2+r],a=n[3+r];return 256*(256*(256*a+s)+o)+i},setPixel:function(e,t,n){var r=4*(e+t*this.width);this.pixels[0+r]=255&n,n=(n-(255&n))/256,this.pixels[1+r]=255&n,n=(n-(255&n))/256,this.pixels[2+r]=255&n,n=(n-(255&n))/256,this.pixels[3+r]=255&n},parse:function(){try{for(var e=[],t=0;t<this.height;t++)for(var n=0;n<this.width;n++){var r=this.getPixel(n,t);r!=this.base&&e.push(this.parse1Pattern(n,t))}return e}catch(i){if(i.isParseError)return console.log("parse error! "+i),[{image:this.img,x:0,y:0,width:this.width,height:this.height}];throw i}},parse1Pattern:function(e,t){function n(e){return e}function r(e,t,n){return{toString:function(){return"at ("+e+","+t+") :"+n},isParseError:!0}}for(var i=this.getPixel(e,t),o=e,s=t,a=this.base,u=this.width,c=this.height;u>o;){var f=this.getPixel(o,s);if(f!=i)break;o++}if(o>=u||this.getPixel(o,s)!=a)throw r(o,s,n(this.getPixel(o,s))+"!="+n(a));for(o--;c>s&&this.getPixel(o,s)==i;)s++;if(s>=c||this.getPixel(o,s)!=a)throw r(o,s,n(this.getPixel(o,s))+"!="+n(a));s--;var l=e+1,p=t+1,h=o-l,m=s-p;if(console.log("PP",l,p,h,m,o,s),h*m==0)throw r(o,s,"w*h==0");for(var d=this.newImage(h,m),g=d.getContext("2d"),v=g.getImageData(0,0,h,m),y=v.data,b=0,T=p;s>T;T++)for(var x=l;o>x;x++){var M=this.getPixel(x,T);M==i?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&M,M=(M-(255&M))/256,y[b++]=255&M,M=(M-(255&M))/256,y[b++]=255&M,M=(M-(255&M))/256,y[b++]=255&M)}g.putImageData(v,0,0);for(var S=p-1;s>=S;S++)for(var w=l-1;o>=w;w++)this.setPixel(w,S,a);return this.options.boundsInSrc?{x:l,y:p,width:h,height:m}:{image:d,x:0,y:0,width:h,height:m}}}),t}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu"],function(e,t,n){var r={};return r.resolve=function(n,r){if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,n){return e[n]}),e.urlAliases[n]&&(n=e.urlAliases[n]),t.startsWith(n,"ls:")){var i=n.substring("ls:".length);if(!r)throw new Error("Basedir not specified");var o=r.rel(i);if(!o.exists())throw new Error("Resource file not found: "+o);if(e.mp3Disabled&&i.match(/\.(mp3|mp4|m4a)$/)){var s=r.rel(i.replace(/\.(mp3|mp4|m4a)$/,".ogg"));s.exists()&&(o=s)}n=o.getURL()}return n},n.Assets=r,r}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets","assert"],function(e,t,n,r){function i(e){var t=[];return e.forEach(function(e){e&&""!=e.url&&t.push(e)}),t}var o,s={};return o=function(t,n,a){a||(a={}),t=i(t);var u=[],c=t.length;0==c&&setTimeout(function(){var e=[];e.names={},n(e)},0),t.forEach(function(t,i){function f(){var o,s;if("single"==t.type)u[i]=[{image:this,x:0,y:0,width:this.width,height:this.height}];else if((o=t.pwidth)&&(s=t.pheight)){for(var a=0,f=0,l=this.width,p=this.height,h=[];;){var m=o,d=s;if(a+o>l&&(m=l-a),f+s>p&&(d=p-f),h.push({image:this,x:a,y:f,width:m,height:d}),a+=o,a+o>l&&(a=0,f+=s,f+s>p))break}u[i]=h}else{var g=new e(this);u[i]=g.parse()}if(u[i].name=t.name,r.is(u[i],Array),c--,0==c){var v=[],y={};u.forEach(function(e){y[e.name]=v.length,v=v.concat(e)}),v.names=y,n(v)}}console.log("loading",t,i);var l=t.url,p=l;if(s[p])return void f.apply(s[p],[]);l=o.convURL(l,a.baseDir);var h=$("<img>");h.load(function(){s[p]=this,f.apply(this,[])}),h.attr("src",l)})},o.load=o,o.parse1=function(t,n,i){var o,s,a;if((o=t.pwidth)&&(s=t.pheight)){for(var u=0,c=0,f=n.width,l=n.height,p=[];;)if(p.push({image:this,x:u,y:c,width:o,height:s}),u+=o,u+o>f&&(u=0,c+=s,c+s>l))break;a=p}else{var h=new e(n,i);a=h.parse()}return a.name=t.name,r.is(a,Array)},o.convURL=function(e,t){return n.resolve(e,t)},window.ImageList=o,o}),requireSimulator.setName("typeCheck"),"function"!=typeof define&&(define=require("requirejs").define),define(["Visitor"],function(){return TypeCheck=function(){}}),requireSimulator.setName("Auth"),define(["WebSite"],function(e){var t={};return t.currentUser=function(t){$.ajax({type:"get",url:e.serverTop+"/currentUser",data:{withCsrfToken:!0},success:function(e){console.log("auth.currentUser",e),e=JSON.parse(e);var n=e.user;"null"==n&&(n=null),console.log("user",n,"csrfToken",e.csrfToken),t(n,e.csrfToken)}})},t.assertLogin=function(n){t.currentUser(function(t,r){return t?n.success(t,r):(window.onLoggedIn=n.success,void n.showLoginLink(e.serverTop+"/login"))})},window.Auth=t,t}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(e,t,n){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(e,n,r,i){var o=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(e){alert(e)}),o.append("theFile",r),o.append("user",e),o.append("project",n),o.append("fileName",r.name),$.ajax({type:"get",url:t.serverTop+"/blobURL",success:function(e){$.ajax({url:e,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){console.log("Res = "+e),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(e){if(n.startsWith(e,i)){var t=e.split("/");return{user:t[1],project:t[2],fileName:t[3]}}},r.url=function(e,n,r){return t.blobPath+e+"/"+n+"/"+r},r.uploadToExe=function(e,n){var r=e.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?n.success():(n.progress||(n.progress=function(e){console.log("uploadBlobToExe cnt=",e)}),void r.forEach(function(e){var r={csrfToken:n.csrfToken};for(var o in e)r[o]=e[o];$.ajax({type:"get",url:t.serverTop+"/uploadBlobToExe",data:r,success:function(){return i--,0==i?n.success():void n.progress(i)},error:n.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function e(t,n){if("string"==typeof t){var r=new Image,i=null,o=null,s=function(e){e&&(o=e),o&&i&&o(i)};return r.onload=function(){i=e(r,n),s()},r.src=t,s}var a=n.width,u=n.height,c=n.getContext("2d"),f=t.width,l=t.height,p=u/l*f,h=a/f*l;h>u&&(h=u),p>a&&(p=a),c.clearRect(0,0,a,u);var m=Math.floor((a-p)/2),d=Math.floor((u-h)/2);return c.drawImage(t,0,0,f,l,m,d,p,h),{left:m,top:d,width:p,height:h,src:t}}return e}),requireSimulator.setName("thumbnail"),define(["ImageRect","Content"],function(e){function t(t){try{var i=Tonyu.globals.$Screen.buf[0],o=$("<canvas>").attr({width:100,height:100});e(i,o[0]);var s=o[0].toDataURL(),a=t.getResource(),u=t.getDir(),c=n.file(t);c.text(s);for(var f={name:r,pwidth:100,pheight:100,url:"ls:"+c.relPath(u)},l=a.images,p=!1,h=0;h<l.length;h++)l[h].name==r&&(l[h]=f,p=!0);p||l.push(f),t.setResource(a),console.log("setRSRC",a)}catch(m){console.log("Create thumbnail failed",m),console.log(m.stack)}}var n={},r="$icon_thumbnail";return n.set=function(e,n){setTimeout(function(){t(e)},n)},n.get=function(e){var t=n.file(e);return t.exists()?t.text():null},n.file=function(e){var t=e.getDir(),n=t.rel("images/").rel("icon_thumbnail.png");return n},n}),requireSimulator.setName("plugins"),define(["WebSite"],function(e){function t(e){return"function"==typeof e&&(e={onload:e}),e||(e={}),e.onload||(e.onload=function(){}),e}var n={},r={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return n.installed=r,n.detectNeeded=function(e,t){for(var n in r){var i=r[n].detection.exec(e);i&&(t[n]=1)}return t},n.loaded=function(e){var t=r[e];if(!t)throw new Error("plugin not found: "+e);return window[t.symbol]},n.loadAll=function(e,i){function o(){u>=s.length?i.onload():n.load(s[u++],o)}i=t(i);var s=[];for(var a in e)r[a]&&!n.loaded(a)&&s.push(a);var u=0;console.log("loading plugins",s),setTimeout(o,0)},n.load=function(n,i){var o=r[n];if(!o)throw new Error("plugin not found: "+n);i=t(i);var s=e.pluginTop+"/"+o.src;location.href.match(/^file:/)?($("<script>").attr("src",s).appendTo("body"),setTimeout(i.onload,500)):$.getScript(s,i.onload)},n.request=function(e){if(!n.loaded(e)){var t=new Error("Plugin "+e+" required");t.pluginName=e}},n}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","ProjectCompiler","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","typeCheck","Blob","thumbnail","WebSite","plugins","Tonyu.Compiler.Semantics","Tonyu.Compiler.JSGenerator","DeferredUtil","compiledProject"],function(e,t,n,r,i,o,s,a,u,c,f,l,p,h,m,d){return e.Project=function(n,i){{var a=t(n);e.extend({},a),r.get(f.tonyuHome)}a.EXT=".tonyu",a.NSP_KER="kernel",a.NSP_USR="user";var p;p=i?t(i):d(a.NSP_KER,f.compiledKernel);var h=e.TraceTbl,g={classes:e.classMetas,traceTbl:h,options:{compiler:{}}};return a.env=g,a.dumpJS=function(e){function t(e){console.log("Class "+e+":\n"+g.classes[e].src.js)}if(e)t(e);else for(var e in g.classes)t(e)},a.stop=function(){var e=a.runningThread;e&&e.kill();var t=a.runningObj;t&&t.stop&&t.stop()},a.rawRun=function(e){if(f.removeJSOutput){var t=a.getOutputFile();t.exists()&&t.rm()}return a.loadClasses().then(m.throwF(function(){a.fixBootRunClasses(),a.runScriptMode||c.set(a,2e3),a.rawBoot(e)}))},a.getResource=function(){var t=n.rel("res.json");if(t.exists()){var r=t.obj(),i=!1;for(var o in r)for(var s=r[o],u=s.length-1;u>=0;u--)s[u].url||(s.splice(u,1),i=!0);return i&&a.setResource(r),r}return e.defaultResource},a.hasSoundResource=function(){var e=a.getResource();return e&&e.sounds&&e.sounds.length>0},a.setResource=function(e){var t=n.rel("res.json");t.obj(e)},a.getThumbnail=function(){return c.get(a)},a.convertBlobInfos=function(e){function t(n){if("object"==typeof n)for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];if("url"==i){var s;(s=u.isBlobURL(o))&&(n[i]=[u.BLOB_PATH_EXPR,e,r,s.fileName].join("/"))}t(o)}}var n=a.getResource(),r=a.getName();t(n),a.setResource(n)},a.getBlobInfos=function(){function e(t){if("object"==typeof t)for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if("url"==r){var o;(o=u.isBlobURL(i))&&n.push(o)}e(i)}}var t=a.getResource(),n=[];return e(t),n},a.loadResource=function(t){var n=a.getResource();o(n.images,function(n){var r=e.getGlobal("$Sprites");r&&r.setImageList(n);for(var i in n.names)e.setGlobal(i,n.names[i]);t&&t()})},a.getOptions=function(){g.options=null;var t=n.rel("options.json");return t.exists()&&(g.options=t.obj()),g.options&&!g.options.run&&(g.options=null),g.options||(g.options=e.defaultOptions),a.fixOptions(g.options),g.options},a.fixOptions=function(e){e.compiler||(e.compiler={}),e.compiler.commentLastPos=a.runScriptMode||s.isAvailable(),e.plugins||(e.plugins={},n.each(function(t){t.endsWith(a.EXT)&&l.detectNeeded(t.text(),e.plugins)}))},a.requestPlugin=function(e){if(!l.loaded(e)){var t=a.getOptions();t.plugins[e]=1,a.setOptions(t);var n=new Error("必要なプラグイン"+e+"を追加しました。もう一度実行してください");throw n.pluginName=e,n}},a.loadPlugins=function(e){var t=a.getOptions();return l.loadAll(t.plugins,e)},a.fixBootRunClasses=function(){var e=a.getOptions();if(e.run){var t=a.fixClassName(e.run.mainClass),n=a.fixClassName(e.run.bootClass);(t!=e.run.mainClass||n!=e.run.bootClass)&&(e.run.mainClass=t,e.run.bootClass=n,a.setOptions(e))}},a.fixClassName=function(t){if(e.getClass(t))return t;var n,r=t.split("."),i=r.pop();return n=a.NSP_USR+"."+i,e.getClass(n)?n:(n=a.NSP_KER+"."+i,e.getClass(n)?n:t)},a.getNamespace=function(){var e=a.getOptions();return e.compiler&&e.compiler.namespace?e.compiler.namespace:a.isKernelEditable()?a.NSP_KER:a.NSP_USR},a.getDependingProjects=function(){return[p]},a.getOutputFile=function(){var e=a.getOptions();return e.compiler.outputFile?r.resolve(e.compiler.outputFile):n.rel("js/concat.js")},a.setOptions=function(e){e&&(g.options=e);var t=n.rel("options.json"),r=t.exists()?t.text():"",i=JSON.stringify(g.options);r!=i&&(console.log("update option",r,i),t.text(i))},a.rawBoot=function(t){a.showProgress("Running "+t),e.run(t)},a.srcExists=function(e,t){var n=null;return t.recursive(function(t){t.truncExt(a.EXT)===e&&(n=t)}),n},a.isKernel=function(t){return i?a.srcExists(t,i):g.classes[a.NSP_KER+"."+t]||e.getClass(a.NSP_KER+"."+t)},a.isKernelEditable=function(){return g.options.kernelEditable},a.getDir=function(){return n},a.getName=function(){return n.name().replace(/\/$/,"")},a.renameClassName=function(e,t){return a.compile({noIncremental:!0}).then(function(){var n=a.env.classes;for(var r in n){var i=n[r],o=i.src?i.src.tonyu:null,s=i.annotation,u=[];if(s&&o){console.log("Check",r);for(var c in s)try{var f=s[c],l=f.scopeInfo;if(l&&"class"==l.type&&l.name==e){var p=f.node.pos,h=f.node.len,m=o.text().substring(p,p+h);m==e&&(u.push({pos:p,len:h}),console.log(o.path(),p,h,o.text().substring(p-5,p+h+5),"->",t))}}catch(d){console.log(d)}u=u.sort(function(e,t){return t.pos-e.pos}),console.log(o.path(),u);var g=o.text(),v=g;u.forEach(function(e){g=g.substring(0,e.pos)+t+g.substring(e.pos+e.len)}),v==g||o.isReadOnly()||(console.log("Refact:",o.path(),g),o.text(g))}else console.log("No Check",r)}})},a.showProgress=function(e){"undefined"!=typeof SplashScreen&&SplashScreen.progress(e)},a}}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite","PathUtil","assert"],function(e,t,n,r){function i(e,t){var n=o(e);if(t&&!n.exists())throw n+": no such file or directory";
return n}function o(t){if("string"!=typeof t)return t;if(r.isAbsolutePath(t))return e.get(t);var n=s.cwd;return n.rel(t)}var s={};return s.cd=function(e){return s.cwd=i(e,!0),s.pwd()},s.mount=function(t,n){if(!t||!t.t){var r=[];for(var i in e.getRootFS().availFSTypes())r.push(i);return void sh.err("-t=("+r.join("|")+") should be specified.")}e.mount(n,t.t,t)},s.unmount=function(t){e.unmount(t)},s.fstab=function(){var t=e.getRootFS(),n=t.fstab(),r=this;n.forEach(function(e){r.echo(e.fstype()+"	"+(e.mountPoint||""))})},s.resolve=i,s.pwd=function(){return s.cwd+""},s.ls=function(e){return e=e?i(e,!0):s.cwd,e.ls()},s.cp=function(e,t,n){n||(n={}),n.v&&(s.echo("cp",e,t),n.echo=s.echo.bind(s));var r=i(e,!0),o=i(t);return r.copyTo(o,n)},s.ln=function(e,t,n){var r=i(t),o=i(e,!0);if(r.isDir()&&r.exists()&&(r=r.rel(o.name())),r.exists())throw new Error(r+" exists");return r.link(o,n)},s.rm=function(e,t){if(t||(t={}),t.notrash)return e=i(e,!1),e.removeWithoutTrash(),1;if(e=i(e,!0),e.isDir()&&t.r){var n=e,r=0;return n.each(function(e){e.exists()&&(r+=s.rm(e,t))}),n.rm(),r+1}return e.rm(),1},s.cat=function(e){return e=i(e,!0),s.echo(e.getContent(function(t){return e.isText()?t.toPlainText():t.toURL()}))},s.resolve=function(e){return e||(e="."),e=i(e)},s.grep=function(e,t,n){function r(e,t,r){n.res&&n.res.push({file:e,lineNo:t,line:r}),s.echo(e+"("+t+"): "+r)}return t=i(t,!0),n||(n={}),n.res||(n.res=[]),t.isDir()?t.each(function(t){s.grep(e,t,n)}):"string"==typeof e&&t.lines().forEach(function(n,i){n.indexOf(e)>=0&&r(t,i+1,n)}),n.res},s.touch=function(e){return e=i(e),e.text(e.exists()?e.text():""),1},s.setout=function(e){s.outUI=e},s.echo=function(){console.log.apply(console,arguments),s.outUI&&s.outUI.log&&s.outUI.log.apply(s.outUI,arguments)},s.err=function(){console.log.apply(console,arguments),s.outUI&&s.outUI.err&&s.outUI.err.apply(s.outUI,arguments)},s.prompt=function(){},s.ASYNC={r:"SH_ASYNC"},s.help=function(){for(var e in s){var t=s[e];"function"==typeof t&&s.echo(e+(t.description?" - "+t.description:""))}},sh=s,n.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),s}),requireSimulator.setName("KeyEventChecker"),define([],function(){var e={};return e.down=function(t,n,r){t instanceof $||(t=$(t)),t.bind("keydown",function(i){return e.is(i,n)?r.call(t[0],i):void 0})},e.is=function(e,t){t=t.toLowerCase(),e=e.originalEvent||e;var n="";return e.altKey&&(n+="alt+"),e.ctrlKey&&(n+="ctrl+"),e.shiftKey&&(n+="shift+"),n+=e.keyCode>=112&&e.keyCode<=123?"f"+(e.keyCode-111):String.fromCharCode(e.keyCode),n=n.toLowerCase(),t==n},e}),requireSimulator.setName("ScriptTagFS"),define(["Content"],function(e){var t={};return t.toObj=function(){function e(e,t){var n=e.split("\n"),r="";return n.forEach(function(e){r+=e.length>t?e.substring(0,t):e+"\n"}),r}var t=$("script"),n={};return t.each(function(){var t=this;if("text/tonyu"==t.type){var r=$(t).data("filename");if(r){var i=parseInt($(t).data("lastupdate")),o=$(t).data("wrap");o?(o=parseInt(o),n[r]={lastUpdate:i,text:e(t.innerHTML,o)}):n[r]={lastUpdate:i,text:t.innerHTML}}}}),n},t.copyTo=function(n){var r=t.toObj();for(var i in r){var o=n.rel(i);o.isText()?o.text(r[i].text):o.setBytes(e.url(r[i].text).toByteArray())}},t}),requireSimulator.setName("PicoAudio");var PicoAudio=function(){function e(e){var t=window.AudioContext||window.webkitAudioContext;this.context=e?e:new t,this.settings={globalVolume:.2,tempo:120,basePitch:440,resolution:480,hashLength:100,hashBuffer:1,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPort:0,loop:!1},this.trigger={isNoteTrigger:!0,noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[]},this.hashedDataList=[],this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}];for(var n=0;17>n;n++)this.channels.push([0,0,1]);this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate);for(var r=0;2>r;r++)for(var n=0;n<this.context.sampleRate;n++)this.whitenoise.getChannelData(r)[n]=2*Math.random()-1}function t(e){for(var t=0,n=0;n<e.length;n++)t=(t<<8)+e[n];return t}return e.prototype.createNote=function(e){function t(e,t){try{e.stop(t)}catch(r){try{e.disconnect(),n(o)}catch(r){}}}function n(e){e.disconnect(),e.gain.cancelScheduledValues(0)}{var r=this.createBaseNote(e,!0),i=r.oscillator,o=r.gainNode;r.panNode}switch(this.channels[r.channel][0]/10||e.instrument){case.1:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:i.type="sine",o.gain.value*=1.5;break;case.2:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:i.type="square",o.gain.value*=.8;break;case.3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:i.type="sawtooth";break;case.4:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:i.type="triangle",o.gain.value*=1.5;break;default:i.type="square"}switch(this.channels[r.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:o.gain.value*=1.1,o.gain.setValueAtTime(o.gain.value,r.start),o.gain.linearRampToValueAtTime(0,r.start+.2),t(i,r.start+.5);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:o.gain.value*=1.1,o.gain.setValueAtTime(o.gain.value,r.start),o.gain.linearRampToValueAtTime(.95*o.gain.value,r.start+.1),o.gain.setValueAtTime(.95*o.gain.value,r.start+.1),o.gain.linearRampToValueAtTime(0,r.start+1.5+3*r.velocity);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:o.gain.value*=1.1,o.gain.setValueAtTime(o.gain.value,r.start),o.gain.linearRampToValueAtTime(0,r.start+1+4*r.velocity);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:o.gain.value*=1,o.gain.setValueAtTime(o.gain.value,r.start),o.gain.linearRampToValueAtTime(.95*o.gain.value,r.start+.1),o.gain.setValueAtTime(.95*o.gain.value,r.start+.1),o.gain.linearRampToValueAtTime(0,r.start+2+10*r.velocity);break;case 119:o.gain.value=0,t(i,0)}return function(){t(i,0),n(o)}},e.prototype.createPercussionNote=function(e){function t(e,t){try{e.stop(t)}catch(n){try{e.disconnect()}catch(n){}}}function n(e){e.disconnect(),e.gain.cancelScheduledValues(0)}{var r=this.createBaseNote(e,!1),i=r.oscillator,o=r.gainNode,s=(r.panNode,r.start),a=(r.stop,r.velocity*((e.expression?e.expression[0].value:100)/127)),u=this.createBaseNote(e,!1,!0),c=u.oscillator,f=u.gainNode;u.panNode}switch(e.pitch){case 35:case 36:o.gain.value=.6*a,i.playbackRate.value=.02,i.stop(s+.07),f.gain.value=1.1*a,c.frequency.setValueAtTime(120,s),c.frequency.linearRampToValueAtTime(50,s+.07),c.stop(s+.07);break;case 38:case 40:i.playbackRate.value=.7,i.stop(s+.05),f.gain.setValueAtTime(.8*a,s),f.gain.linearRampToValueAtTime(0,s+.05),c.frequency.setValueAtTime(300,s),c.frequency.linearRampToValueAtTime(200,s+.05),c.stop(s+.05);break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,i.stop(s+.1),c.type="square",f.gain.setValueAtTime(a,s),f.gain.linearRampToValueAtTime(.01,s+.1),c.frequency.setValueAtTime(150+20*(e.pitch-40),s),c.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),s+.1),c.stop(s+.1);break;case 42:case 44:i.playbackRate.value=1.5,i.stop(s+.02),c.stop(0);break;case 46:i.playbackRate.value=1.5,i.stop(s+.3),o.gain.setValueAtTime(.9*a,s),o.gain.linearRampToValueAtTime(0,s+.3),c.stop(0);break;case 49:case 51:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,i.stop(s+.5),o.gain.setValueAtTime(1*a,s),o.gain.linearRampToValueAtTime(0,s+.5),c.stop(0);break;case 51:i.playbackRate.value=1.1,i.stop(s+.4),o.gain.setValueAtTime(.8*a,s),o.gain.linearRampToValueAtTime(0,s+.4),c.stop(0);break;case 59:i.playbackRate.value=1.8,i.stop(s+.3),o.gain.setValueAtTime(.5*a,s),o.gain.linearRampToValueAtTime(0,s+.3),c.stop(0);break;case 60:case 61:i.playbackRate.value=.03,i.stop(s+.03),f.gain.setValueAtTime(.8*a,s),f.gain.linearRampToValueAtTime(0,s+.1),c.frequency.setValueAtTime(400-40*(e.pitch-60),s),c.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),s+.1),c.stop(s+.1);break;case 62:i.playbackRate.value=.03,i.stop(s+.03),f.gain.setValueAtTime(a,s),f.gain.linearRampToValueAtTime(0,s+.03),c.frequency.setValueAtTime(200,s),c.frequency.linearRampToValueAtTime(250,s+.03),c.stop(s+.03);break;case 63:case 64:i.playbackRate.value=.03,i.stop(s+.03),f.gain.setValueAtTime(a,s),f.gain.linearRampToValueAtTime(0,s+.1),c.frequency.setValueAtTime(200-30*(e.pitch-63),s),c.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),s+.1),c.stop(s+.1);break;case 56:case 75:i.playbackRate.value=.01,i.stop(s+.1),f.gain.setValueAtTime(a,s),f.gain.linearRampToValueAtTime(0,s+.1),c.frequency.setValueAtTime(1e3+48*(e.pitch-56),s),c.stop(s+.1);break;case 80:i.playbackRate.value=5,o.gain.setValueAtTime(.5*a,s),o.gain.linearRampToValueAtTime(0,s+.2),i.stop(s+.05),c.type="triangle",f.gain.setValueAtTime(.7*a,s),f.gain.linearRampToValueAtTime(0,s+.2),c.frequency.setValueAtTime(6e3,s),c.stop(s+.05);break;case 81:i.playbackRate.value=5,o.gain.setValueAtTime(.9*a,s),o.gain.linearRampToValueAtTime(0,s+.5),i.stop(s+.5),c.type="triangle",f.gain.setValueAtTime(.8*a,s),f.gain.linearRampToValueAtTime(0,s+.3),c.frequency.setValueAtTime(6e3,s),c.stop(s+.3);break;default:i.playbackRate.value=e.pitch/69*2,i.stop(s+.05),t(c,0)}return function(){t(i,0),t(c,0),n(o),n(f)}},e.prototype.createBaseNote=function(e,t,n){var r=this.settings,i=this.context,o=this.states.startTime,s=this.getTime(e.start)+o,a=this.getTime(e.stop)+o,u=r.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),c=n?0:e.channel||0,f=(e.velocity||.1)*Number(n?1:this.channels[c][2]||1)*r.globalVolume,l=9!=c?i.createOscillator():i.createBufferSource(),p=i.createStereoPanner?i.createStereoPanner():i.createPanner?i.createPanner():{pan:{setValueAtTime:function(){}}},h=i.createGain(),m=this;if(!i.createStereoPanner&&i.createPanner){var d=e.pan?e.pan[0].value/127*2-1:0,g=90*d,v=Math.sin(g*(Math.PI/180)),y=-Math.cos(g*(Math.PI/180));p.panningModel="equalpower",p.setPosition(v,0,y)}else p.pan.value=e.pan?e.pan[0].value/127*2-1:0;return h.gain.value=f*((e.expression?e.expression[0].value:100)/127),9!=c?(l.type=e.type||"sine",l.detune.value=0,l.frequency.value=u,e.pitchBend?e.pitchBend.forEach(function(t){l.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),m.getTime(t.timing)+o)}):!1):(l.loop=!0,l.buffer=this.whitenoise),t&&(e.expression?e.expression.forEach(function(e){h.gain.setValueAtTime(f*(e.value/127),m.getTime(e.timing)+o)}):!1),i.createStereoPanner||i.createPanner?(i.createStereoPanner?e.pan?e.pan.forEach(function(e){p.pan.setValueAtTime(e.value/127*2-1,m.getTime(e.timing)+o)}):!1:i.createPanner&&p.positionX&&(e.pan?e.pan.forEach(function(e){var t=e.value/127*2-1,n=90*t,r=Math.sin(n*(Math.PI/180)),i=-Math.cos(n*(Math.PI/180));p.positionX.setValueAtTime(r,m.getTime(e.timing)+o),p.positionY.setValueAtTime(0,m.getTime(e.timing)+o),p.positionZ.setValueAtTime(i,m.getTime(e.timing)+o),p.setPosition(v,0,y)}):!1),l.connect(p),p.connect(h),h.connect(i.destination)):(l.connect(h),h.connect(i.destination)),l.start(s),9==c||n||l.stop(a),{start:s,stop:a,pitch:u,channel:c,velocity:f,oscillator:l,panNode:p,gainNode:h}},e.prototype.startWebMIDI=function(){var e,t=this;navigator.requestMIDIAccess().then(function(n){return e=n.outputs,t.settings.WebMIDIPortOutputs=e,e}).catch(function(e){console.log(e)})},e.prototype.initStatus=function(){if(this.stop(),this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[]},this.settings.isWebMIDI)for(var e=0;16>e;e++)this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([224+e,0,64]),this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([176+e,6,0]),this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([176+e,7,100]),this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([176+e,10,64]),this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([176+e,11,127])},e.prototype.stop=function(){var e=this.states;if(e.isPlaying=!1,e.playIndex-=this.settings.hashBuffer,e.stopTime=this.context.currentTime,e.stopFuncs.forEach(function(e){e.stopFunc()}),e.stopFuncs=[],this.settings.isWebMIDI)for(var t=0;16>t;t++)for(var n=0;128>n;n++)this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort).send([128+t,n,0])},e.prototype.play=function(){function e(e){(e.note||e.rootTimeout||i.isNoteTrigger)&&o.stopFuncs.push(e)}function t(e,t){("note"==e||"rootTimeout"==e||i.isNoteTrigger)&&o.stopFuncs.some(function(n,r){return n[e]==t?(o.stopFuncs.splice(r,1),!0):void 0})}var n=this.context,r=this.settings,i=this.trigger,o=this.states,s=this.hashedDataList,a=this;o.isPlaying=!0,o.startTime=o.startTime||o.stopTime?o.startTime+this.context.currentTime-o.stopTime:this.context.currentTime,o.stopFuncs=[];var u=function(){if(a.getTime(a.getTiming(Number.MAX_SAFE_INTEGER))-n.currentTime+o.startTime<=0)a.onSongEnd();else{var t=setTimeout(u,1);e({rootTimeout:t,stopFunc:function(){clearTimeout(t)}})}},c=1e3*(a.getTime(a.getTiming(Number.MAX_SAFE_INTEGER))-n.currentTime+o.startTime),f=setTimeout(u,c);e({rootTimeout:f,stopFunc:function(){clearTimeout(f)}}),function l(u){if(o.playIndex=u,s&&s[u]&&s[u].forEach(r.isWebMIDI?function(e){240!=e.message[0]&&255!=e.message[0]&&r.WebMIDIPortOutputs.get(r.WebMIDIPort).send(e.message,1e3*(a.getTime(e.timing)-n.currentTime+window.performance.now()/1e3+o.startTime))}:function(r){e({note:r,stopFunc:9!=r.channel?a.createNote(r):a.createPercussionNote(r)});var s=setTimeout(function(){t("timeout",s),i.isNoteTrigger&&i.noteOn(r);var n=setTimeout(function(){t("timeout",n),t("note",r),i.isNoteTrigger&&i.noteOff(r)},1e3*a.getTime(r.stop-r.start));e({timeout:n,stopFunc:function(){clearTimeout(n)}})},1e3*(a.getTime(r.start)-n.currentTime+o.startTime));e({timeout:s,stopFunc:function(){clearTimeout(s)}})}),u<s.length)if(u-Math.floor(1e3*(n.currentTime-o.startTime)/r.hashLength)<=r.hashBuffer)l(u+1);else{var c=setTimeout(function(){l(u+1),t("rootTimeout",c)},r.hashLength);e({rootTimeout:c,stopFunc:function(){clearTimeout(c)}})}else i.songEnd()}(o.playIndex||0)},e.prototype.setData=function(e){this.states.isPlaying&&this.stop(),this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack;var t=this,n=[];return this.settings.isWebMIDI?e.messages.forEach(function(e){var r=t.getTime(e.timing)*(1e3/t.settings.hashLength);n[Math.floor(r)]||(n[Math.floor(r)]=[]),n[Math.floor(r)].push(e)}):e.tracks.forEach(function(e){e.notes.forEach(function(r){var i=r;i.instrument=e.instrument;var o=t.getTime(r.start)*(1e3/t.settings.hashLength);n[Math.floor(o)]||(n[Math.floor(o)]=[]),n[Math.floor(o)].push(r)})}),this.hashedDataList=n,this.initStatus(),this},e.prototype.getGlobalVolume=function(){return this.settings.globalVolume},e.prototype.setGlobalVolume=function(e){this.settings.globalVolume=e},e.prototype.isLoop=function(){return this.settings.loop},e.prototype.setLoop=function(e){this.settings.loop=e},e.prototype.setStartTime=function(e){this.states.startTime-=e,this.states.playIndex=Math.floor(1e3*e/this.settings.hashLength)},e.prototype.onSongEnd=function(){this.settings.loop&&(this.initStatus(),this.play())},e.prototype.getTime=function(e){var t=0,n=120,r=0,i=this;return this.tempoTrack.some(function(o){return e<o.timing?!0:(t+=60/n/i.settings.resolution*(o.timing-r),r=o.timing,void(n=o.value))}),t+=60/n/i.settings.resolution*(e-r)},e.prototype.getTiming=function(e){var t=0,n=120,r=0,i=this;return this.tempoTrack.some(function(o){return t+=60/n/i.settings.resolution*(o.timing-r),t>e?(t-=60/n/i.settings.resolution*(o.timing-r),r+=(e-t)/(60/n/i.settings.resolution),!0):(r=o.timing,void(n=o.value))}),r},e.prototype.parseSMF=function(e){if(77!=e[0]||84!=e[1]||104!=e[2]||100!=e[3])return"Not Sandard MIDI File.";var n=new Object,r=4,i=new Object;i.size=t(e.subarray(4,8)),i.format=e[9],i.trackcount=t(e.subarray(10,12)),i.timemanage=e[12],i.resolution=t(e.subarray(12,14)),r+=4+i.size;var o=new Array,s=new Array,a=new Array,u=0;if(this.settings.isWebMIDI)var c=[];for(var f=0;f<i.trackcount;f++){if(77!=e[r]||84!=e[r+1]||114!=e[r+2]||107!=e[r+3])return"Irregular SMF.";r+=4;var l=new Object;o.push(l),l.size=t(e.subarray(r,r+4)),r+=4,l.notes=[],l.instrument=null;for(var p=r+l.size,h=0,m=2,d=0,g=64,v=127,y=100,b=1,T=-1,x=-1;p>r;){if(null!=b){for(var M=0;e[r]>=128;)M=(M<<7)+(e[r]-128),r++;M=(M<<7)+e[r],h+=M,r++}if(this.settings.isWebMIDI)var S=r;switch(Math.floor(e[r]/16)){case 8:b=e[r],l.notes.some(function(t){return t.pitch==e[r+1]&&null==t.stop?(t.stop=h,!0):void 0}),r+=3;break;case 9:b=e[r],0!=e[r+2]?l.notes.push({start:h,stop:null,pitch:e[r+1],pitchBend:[{timing:h,value:d}],pan:[{timing:h,value:g}],expression:[{timing:h,value:v}],velocity:e[r+2]/127*y/127,channel:e[r]-144}):l.notes.some(function(t){return t.pitch==e[r+1]&&null==t.stop?(t.stop=h,!0):void 0}),r+=3;break;case 10:b=e[r],r+=3;break;case 11:switch(b=e[r],e[r+1]){case 6:0==T&&0==x&&(m=e[r+2]);break;case 7:y=e[r+2];break;case 10:l.notes.forEach(function(t){null==t.stop&&t.pan.push({timing:h,value:e[r+2]})}),g=e[r+2];break;case 11:l.notes.forEach(function(t){null==t.stop&&t.expression.push({timing:h,value:e[r+2]})}),v=e[r+2];break;case 100:T=e[r+2];break;case 101:x=e[r+2]}r+=3;break;case 12:b=e[r],l.instrument=e[r+1],r+=2;break;case 13:b=e[r],r+=2;break;case 14:b=e[r],d=(128*e[r+2]+e[r+1]-8192)/8192*m,l.notes.forEach(function(e){null==e.stop&&e.pitchBend.push({timing:h,value:d})}),r+=3;break;case 15:switch(e[r]){case 240:for(;247!=e[r+1];)r++;r+=2;break;case 241:r+=2;break;case 242:r+=3;break;case 243:r+=2;break;case 246:case 247:case 248:case 250:case 251:case 252:case 254:r+=1;break;case 255:switch(e[r+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:h+=i.resolution-M;break;case 81:n.tempo=6e7/(65535*e[r+3]+255*e[r+4]+e[r+5]),s.push({timing:h,value:6e7/(65535*e[r+3]+255*e[r+4]+e[r+5])});break;case 84:break;case 88:a.push({timing:h,value:[e[r+3],Math.pow(2,e[r+4])]});break;case 89:case 127:}r+=e[r+2]+3}break;default:r--,e[r]=b,b=null}this.settings.isWebMIDI&&c.push({message:e.slice(S,r),timing:h})}h>u&&(u=h)}return s.push({timing:u,value:120}),n.header=i,n.tracks=o,n.tempoTrack=s,n.beatTrack=a,n.songLength=u,this.settings.isWebMIDI&&(n.messages=c),n},e}();requireSimulator.setName("T2MediaLib");var T2MediaLib_BGMPlayer=function(e){this.id=e,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1,this.bgmPan=0,this.picoAudio=null,this.PICO_AUDIO_VOLUME_COEF=.2};T2MediaLib_BGMPlayer.prototype.playBGM=function(e,t,n,r,i){if(!T2MediaLib.context)return null;this.stopBGM();var o=T2MediaLib.seDataAry.data[e];if(o instanceof AudioBuffer)this.playingBGM=T2MediaLib.playSE(e,this.bgmVolume,this.bgmPan,this.bgmTempo,n,t,r,i);else if(o instanceof Object){if(null==this.picoAudio&&(this.picoAudio=new PicoAudio(T2MediaLib.context)),this.picoAudio.setData(o),this.picoAudio.setLoop(t),this.picoAudio.setGlobalVolume(this.PICO_AUDIO_VOLUME_COEF*this.bgmVolume*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),n){var s=this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER));n>s?n=s:0>n&&(n=0)}else n=0;this.picoAudio.setStartTime(n),this.picoAudio.play(),this.playingBGM=this.picoAudio}return this.playingBGMName=e,this.bgmPause=0,this},T2MediaLib_BGMPlayer.prototype.stopBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?(this.picoAudio.stop(),this.playingBGM=null,this.playingBGMName=null):e instanceof AudioBufferSourceNode&&(e.stop(0),this.playingBGM=null,this.playingBGMName=null),this},T2MediaLib_BGMPlayer.prototype.pauseBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseCurrentTime=e.context.currentTime,e.stop(),this.bgmPause=1):e instanceof AudioBufferSourceNode&&0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=T2MediaLib.getSELoopStartTime(e),this.bgmPauseLoopEnd=T2MediaLib.getSELoopEndTime(e),this.bgmPauseLoop=T2MediaLib.isSELoop(e),this.bgmPauseCurrentTime=e.context.currentTime,this.bgmPauseTempo=this.bgmTempo,e.stop(0),this.bgmPause=1),this},T2MediaLib_BGMPlayer.prototype.resumeBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?1===this.bgmPause&&(e.play(),this.bgmPause=0):e instanceof AudioBufferSourceNode&&1===this.bgmPause&&(e=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd),this.bgmPause=0),this},T2MediaLib_BGMPlayer.prototype.onChangeBGMMasterVolume=function(){this.setBGMVolume(this.getBGMVolume())},T2MediaLib_BGMPlayer.prototype.getBGMVolume=function(){return this.bgmVolume},T2MediaLib_BGMPlayer.prototype.setBGMVolume=function(e){var t=this.playingBGM;return this.bgmVolume=e,t instanceof PicoAudio?this.picoAudio.setGlobalVolume(this.PICO_AUDIO_VOLUME_COEF*e*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume):t instanceof AudioBufferSourceNode&&(t.gainNode.gain.value=e*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),this},T2MediaLib_BGMPlayer.prototype.getBGMTempo=function(){return this.bgmTempo},T2MediaLib_BGMPlayer.prototype.setBGMTempo=function(e){var t=this.playingBGM;return 0>=e&&(e=1),t instanceof AudioBufferSourceNode&&0===this.bgmPause&&(t.plusTime-=(T2MediaLib.context.currentTime-t.playStartTime)*(e-this.bgmTempo)),this.bgmTempo=e,T2MediaLib.setSERate(t,e),this},T2MediaLib_BGMPlayer.prototype.getBGMPan=function(){return this.bgmPan},T2MediaLib_BGMPlayer.prototype.setBGMPan=function(e){var t=this.playingBGM;return this.bgmPan=e,t instanceof AudioBufferSourceNode&&T2MediaLib.setSEPan(t,e),this},T2MediaLib_BGMPlayer.prototype.isBGMLoop=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.isLoop():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoop:T2MediaLib.isSELoop(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoop=function(e){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.setLoop(e):t instanceof AudioBufferSourceNode&&(1===this.bgmPause?this.bgmPauseLoop=e:T2MediaLib.setSELoop(t,e)),this},T2MediaLib_BGMPlayer.prototype.getBGMLoopStartTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?0:e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopStart:T2MediaLib.getSELoopStartTime(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopStartTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopStartTime(t,e);this.bgmPauseLoopStart=e}return this},T2MediaLib_BGMPlayer.prototype.getBGMLoopEndTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.getBGMLength():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopEnd:T2MediaLib.getSELoopEndTime(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopEndTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopEndTime(t,e);this.bgmPauseLoopEnd=e}return this},T2MediaLib_BGMPlayer.prototype.getBGMCurrentTime=function(){var e=this.playingBGM;if(e instanceof PicoAudio){var t;return t=0===this.bgmPause?this.picoAudio.getTime(this.picoAudio.getTiming(this.picoAudio.context.currentTime-this.picoAudio.states.startTime)):this.bgmPauseTime}if(e instanceof AudioBufferSourceNode){var t,n,r,i,o,s,a;return 0===this.bgmPause?(r=T2MediaLib.context.currentTime,i=this.bgmTempo):(r=this.bgmPauseCurrentTime,i=this.bgmPauseTempo),n=(r-e.playStartTime)*i+e.plusTime,e.loop&&(e.loopEnd-e.loopStart>0?n<e.loopStart?(o=0,s=0,a=e.buffer.duration):(o=e.loopStart,s=e.loopStart,a=e.loopEnd-e.loopStart):(a=e.buffer.duration,o=0,s=0)),e.loop?t=(n-s)%a+o:(t=n,t>e.buffer.duration&&(t=e.buffer.duration)),t}return null},T2MediaLib_BGMPlayer.prototype.getBGMLength=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER)):e instanceof AudioBufferSourceNode?e.buffer.duration:null},T2MediaLib_BGMPlayer.prototype.getPlayingBGMName=function(){return this.playingBGMName};var T2MediaLib={context:null,picoAudio:null,seDataAry:{data:[]},bgmPlayerMax:16,bgmPlayerAry:[],masterVolume:1,seMasterVolume:1,bgmMasterVolume:1,playingAudio:null,audioVolume:1,audioTempo:1,audioDataAry:{data:[]},init:function(){if(!this.inited&&(this.inited=!0,!this.disabled&&(window.AudioContext?T2MediaLib.context=new AudioContext:window.webkitAudioContext?T2MediaLib.context=new webkitAudioContext:(T2MediaLib.context=null,console.log("Your browser does not support yet Web Audio API")),T2MediaLib.context)))for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.bgmPlayerAry[e]=new T2MediaLib_BGMPlayer(e)},allClearData:function(){var e=T2MediaLib.seDataAry.data;for(var t in e)delete e[t]},clearData:function(e){var t=T2MediaLib.seDataAry.data;delete t[e]},getMasterVolume:function(){return T2MediaLib.masterVolume},setMasterVolume:function(e){T2MediaLib.masterVolume=e;for(var t=0;t<T2MediaLib.bgmPlayerMax;t++){var n=T2MediaLib.bgmPlayerAry[t];n instanceof T2MediaLib_BGMPlayer&&n.onChangeBGMMasterVolume()}},loadSEFromArray:function(e,t,n){for(var r=T2MediaLib.context,i=null!=t&&null!=n?2:1,o=r.createBuffer(i,array.length,r.sampleRate),s=o.getChannelData(0),a=null!=n?o.getChannelData(1):null,u=0;u<array.length;u++)s[u]=t[u];if(a)for(var u=0;u<array.length;u++)a[u]=n[u];T2MediaLib.seDataAry.data[e]=o},loadSE:function(e,t,n){if(!T2MediaLib.context||T2MediaLib.disabled)return T2MediaLib.seDataAry.data[e]=-1,null;"object"==typeof WebSite&&WebSite.mp3Disabled&&(t=t.replace(/\.(mp3|mp4|m4a)$/,".ogg"));var r=new XMLHttpRequest;r.onload=function(){if(200===r.status||0===r.status){var t=r.response;if(t instanceof ArrayBuffer){var i=r.t2MediaLib_requestURL;if(i.match(/\.(midi?)$/)){null==T2MediaLib.picoAudio&&(T2MediaLib.picoAudio=new PicoAudio(T2MediaLib.context));var o=new Uint8Array(t),s=T2MediaLib.picoAudio.parseSMF(o);T2MediaLib.seDataAry.data[e]=s,n&&n.succ&&n.succ(e)}else{var a=function(t){T2MediaLib.seDataAry.data[e]=t,n&&n.succ&&n.succ(e)},u=function(t){t instanceof Error?console.log("T2MediaLib: "+t.message,i):console.log("T2MediaLib: Error decodeAudioData()",i),T2MediaLib.seDataAry.data[e]=-4,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])};T2MediaLib.context.decodeAudioData(t,a,u)}}else T2MediaLib.seDataAry.data[e]=-3,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])}else T2MediaLib.seDataAry.data[e]=-2,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])},r.onerror=function(t){n&&n.err&&n.err(e,t+"")},T2MediaLib.seDataAry.data[e]=null,t.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer?(r={onload:r.onload},r.t2MediaLib_requestURL=t,r.response=Util.Base64_To_ArrayBuffer(t.replace(/^data:audio\/[a-zA-Z0-9]+;base64,/i,"")),r.status=200,r.onload()):(r.t2MediaLib_requestURL=t,r.open("GET",t,!0),r.responseType="arraybuffer",r.send(null))},activate:function(){if(this.init(),!this.isActivated){this.isActivated=!0;for(var e=T2MediaLib.context,t=e.createBuffer(1,Math.floor(e.sampleRate/32),e.sampleRate),n=t.getChannelData(0),r=(Math.floor(e.sampleRate/860),0);r<n.length;r++)n[r]=0;var i=e.createBufferSource();i.buffer=t,i.connect(e.destination),i.noteOn?i.noteOn(0):i.start&&i.start(0)}},playSE:function(e,t,n,r,i,o,s,a){if(!T2MediaLib.context)return null;var u=T2MediaLib.seDataAry.data[e];if(!(u instanceof AudioBuffer))return null;null===t&&(t=1),null===n&&(n=0),r||(r=1),i?i>u.duration?i=u.duration:0>i&&(i=0):i=0,o||(o=!1),s?0>s?s=0:s>u.duration&&(s=u.duration):s=0,a?0>a?a=0:a>u.duration&&(a=u.duration):a=u.duration;var c=T2MediaLib.context.createBufferSource();T2MediaLib.context.createGain=T2MediaLib.context.createGain||T2MediaLib.context.createGainNode;var f=T2MediaLib.context.createGain(),l=T2MediaLib.context.createPanner();c.buffer=u,c.loop=o,c.loopStart=s,c.loopEnd=a,c.playbackRate.value=r,c.connect(f),f.connect(l),l.connect(T2MediaLib.context.destination),l.panningModel="equalpower",-1>n?n=-1:n>1&&(n=1);var p=90*n,h=Math.sin(p*(Math.PI/180)),m=-Math.cos(p*(Math.PI/180));(-1===n||1===n)&&(m=0),l.positionX?(l.positionX.value=h,l.positionY.value=0,l.positionZ.value=m):l.setPosition(h,0,m),f.gain.value=t*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume;var d;return d=o&&a-s>0&&i>a?a:i,c.gainNode=f,c.volumeValue=t,c.panNode=l,c.panValue=n,c.playStartTime=T2MediaLib.context.currentTime,c.playOffset=d,c.plusTime=d,c.start=c.start||c.noteOn,c.stop=c.stop||c.noteOff,i?o?c.start(0,i,86400):c.start(0,i):c.start(0),c.onended=function(){c.disconnect(),c.onended=null},c},stopSE:function(e){return e instanceof AudioBufferSourceNode?(e.stop(0),e):null},getSEMasterVolume:function(){return T2MediaLib.seMasterVolume},setSEMasterVolume:function(e){T2MediaLib.seMasterVolume=e},getSEVolume:function(e){return e instanceof AudioBufferSourceNode?source.volumeValue:null},setSEVolume:function(e,t){return e instanceof AudioBufferSourceNode?(e.gainNode.gain.value=t*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume,source.volumeValue=t,e):null},getSERate:function(e){return e instanceof AudioBufferSourceNode?e.playbackRate.value:null},setSERate:function(e,t){return e instanceof AudioBufferSourceNode?void(e.playbackRate.value=t):null},getSEPan:function(e){return e instanceof AudioBufferSourceNode?e.panValue:null},setSEPan:function(e,t){if(!(e instanceof AudioBufferSourceNode))return null;var n=e.panNode;-1>t?t=-1:t>1&&(t=1);var r=90*t,i=Math.sin(r*(Math.PI/180)),o=Math.cos(r*(Math.PI/180));(-1===t||1===t)&&(o=0),n.positionX?(n.positionX.value=i,n.positionY.value=0,n.positionZ.value=o):n.setPosition(i,0,o),e.panValue=t},isSELoop:function(e){return e instanceof AudioBufferSourceNode?e.loop:null},setSELoop:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loop=t):null},getSELoopStartTime:function(e){return e instanceof AudioBufferSourceNode?e.loopStart:null},setSELoopStartTime:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopStart=t):null},getSELoopEndTime:function(e){return e instanceof AudioBufferSourceNode?e.loopEnd:null},setSELoopEndTime:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopEnd=t):null},getSEData:function(e){return T2MediaLib.seDataAry.data[e]},loadBGM:function(e,t,n){return T2MediaLib.loadSE(e,t,n)},playBGM:function(e,t,n,r,i,o){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var s=T2MediaLib.bgmPlayerAry[e];return s instanceof T2MediaLib_BGMPlayer?s.playBGM(t,n,r,i,o):null},stopBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.stopBGM():null},pauseBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.pauseBGM():null},resumeBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.resumeBGM():null},getBGMMasterVolume:function(){return T2MediaLib.bgmMasterVolume},setBGMMasterVolume:function(e){T2MediaLib.bgmMasterVolume=e;for(var t=0;t<T2MediaLib.bgmPlayerMax;t++){var n=T2MediaLib.bgmPlayerAry[t];n instanceof T2MediaLib_BGMPlayer&&n.onChangeBGMMasterVolume()}},getBGMVolume:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMVolume():null},setBGMVolume:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;
var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMVolume(t):null},getBGMTempo:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMTempo():null},setBGMTempo:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMTempo(t):null},getBGMPan:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMPan():null},setBGMPan:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMPan(t):null},isBGMLoop:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.isBGMLoop():null},setBGMLoop:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMLoop(t):null},getBGMLoopStartTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLoopStartTime():null},setBGMLoopStartTime:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMLoopStartTime(t):null},getBGMLoopEndTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLoopEndTime():null},setBGMLoopEndTime:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMLoopEndTime(t):null},getBGMCurrentTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMCurrentTime():null},getBGMLength:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLength():null},getPlayingBGMName:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getPlayingBGMName():null},getBGMData:function(e){return T2MediaLib.getSEData(e)},getBGMPlayerMax:function(){return T2MediaLib.bgmPlayerMax},allStopBGM:function(){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.stopBGM(e)},allResetBGM:function(){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.stopBGM(e),T2MediaLib.setBGMVolume(e,1),T2MediaLib.setBGMTempo(e,1),T2MediaLib.setBGMPan(e,0);T2MediaLib.setMasterVolume(1),T2MediaLib.setSEMasterVolume(1),T2MediaLib.setBGMMasterVolume(1)},loadAudio:function(e,t){var n=new Audio(t);n.play(),T2MediaLib.audioDataAry.data[e]=null,n.addEventListener("loadstart",function(){if(!T2MediaLib.context)return null;var e=T2MediaLib.context.createMediaElementSource(n);e.connect(T2MediaLib.context.destination)},!1),n.addEventListener("canplay",function(){T2MediaLib.audioDataAry.data[e]=n},!1),n.load()},playAudio:function(e,t,n){var r=T2MediaLib.audioDataAry.data[e];return r?(n||(n=0),T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.pause(),T2MediaLib.playingAudio.currentTime=0),T2MediaLib.playingAudio=r,r.loop=t,r.volume=T2MediaLib.audioVolume,r.currentTime=n,r.play(),r):null},stopAudio:function(){var e=T2MediaLib.playingAudio;return e instanceof Audio?(e.pause(),e.currentTime=0,T2MediaLib.playingAudio=null,e):null},pauseAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.pause(),e):null},resumeAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.play(),e):null},setAudioVolume:function(e){T2MediaLib.audioVolume=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.volume=e)},setAudioTempo:function(e){T2MediaLib.audioTempo=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.playbackRate=e)},setAudioPosition:function(e){T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.currentTime=e)},getAudioData:function(e){return T2MediaLib.audioDataAry.data[e]},getAudioCurrentTime:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.currentTime:null},getAudioLength:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.duration:null}};requireSimulator.setName("exceptionCatcher"),define([],function(){var e={};return e.f=function(t){if("function"==typeof t){if(t.isTrcf)return t;var n=function(){if(!e.handleException||e.enter)return t.apply(this,arguments);try{return e.enter=!0,t.apply(this,arguments)}catch(n){e.handleException(n)}finally{e.enter=!1}};return n.isTrcf=!0,n}if("object"==typeof t){for(var r in t)t[r]=e.f(t[r]);return t}},e}),requireSimulator.setName("UI"),define(["Util","exceptionCatcher"],function(e,t){var n={},r=t.f;return n=function(){function t(){f.forEach(function(e){e()}),setTimeout(r(t),50)}function i(e){return e instanceof Array?o(e):"string"==typeof e?a(e):e}function o(e){var t=e[0],n=1,r=$("<"+t+">");for("object"!=typeof e[n]||e[n]instanceof Array||e[n]instanceof $||(s(r,e[n],t),n++);n<e.length;)r.append(i(e[n])),n++;return r}function s(t,i){function o(e,n){if(n)if("enterkey"==e)t.on("keypress",r(function(e){13==e.which&&n.apply(t,arguments)}));else if("realtimechange"==e){var o,s=!0;f.push(function(){var e;e="checkbox"==i.type?!!t.prop("checked"):t.val(),(s||o!=e)&&(n.apply(t,[e,o]),o=e),s=!1})}else t.on(e,r(n))}i.$var&&(l[i.$var]=t),i.$edit&&("string"==typeof i.$edit&&(i.$edit={name:i.$edit,type:n.types.String}),i.on||(i.on={}),i.on.realtimechange=r(function(e){p.writeToModel(i.$edit,e,t)}),l[i.$edit.name]||(l[i.$edit.name]=t),p.push({jq:t,params:i}));for(var s in i)if("on"==s)for(var a in i.on)o(a,i.on[a]);else"css"==s&&null!=i[s]?t.css(i[s]):e.startsWith(s,"$")||null==i[s]||t.attr(s,i[s])}function a(e){return $("<span>").text(e)}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var f=[],l={},p=[],h=i(u);return h.$edits=p,h.$vars=l,p.load=function(e){p.model=e,p.forEach(function(e){p.writeToJq(e.params.$edit,e.jq)}),p.validator.on.validate.call(p.validator,p.model)},p.writeToJq=function(e,t){var n=p.model;if(n){for(var r=e.name,i=r.split("."),o=0;o<i.length;o++)n=n[i[o]];n=e.type.toVal(n),"checkbox"==t.attr("type")?t.prop("checked",!!n):t.val(n)}},p.validator={errors:{},show:function(){if(l.validationMessage){l.validationMessage.empty();for(var e in this.errors)l.validationMessage.append(n("div",this.errors[e].mesg))}if(l.OKButton){var t=!0;for(var e in this.errors)t=!1;l.OKButton.attr("disabled",!t)}},on:{validate:function(){}},addError:function(e,t,n){this.errors[e]={mesg:t,jq:n},this.show()},removeError:function(e){delete this.errors[e],this.show()},allOK:function(){for(var e in this.errors)delete this.errors[e];this.show()},isValid:function(){var e=!0;for(var t in this.errors)e=!1;return e}},p.writeToModel=function(e,t,n){var r=p.model;if(r){var i=e.name;try{t=e.type.fromVal(t)}catch(o){return void p.validator.addError(i,o,n)}p.validator.removeError(i);for(var s=i.split("."),a=0;a<s.length;a++)a==s.length-1?p.on.writeToModel(i,t)||(r[s[a]]=t):r=r[s[a]];p.validator.on.validate.call(p.validator,p.model)}},p.on={},p.on.writeToModel=function(){},f.length>0&&setTimeout(r(t),50),h},n.types={String:{toVal:function(e){return e},fromVal:function(e){return e}},Number:{toVal:function(e){return e+""},fromVal:function(e){return parseFloat(e)}}},n}),requireSimulator.setName("UIDiag"),define(["UI"],function(e){var t={};return t.confirm=function(t){function n(e){return function(){i.resolve(e),r.dialog("close"),r.remove()}}var r=e("div",{title:"確認"},["div",t],["button",{on:{click:n(!0)}},"OK"],["button",{on:{click:n(!1)}},"キャンセル"]).dialog({width:"auto",close:n(!1)}),i=$.Deferred();return i.promise()},t.alert=function(t){function n(e){return function(){i.resolve(e),r.dialog("close"),r.remove()}}var r=e("div",{title:"確認"},["div",t],["button",{on:{click:n(!0)}},"OK"]).dialog({width:"auto",close:n(!1)}),i=$.Deferred();return i.promise()},t.prompt=function(t,n){function r(){var e=o.$vars.val.val();s.resolve(e),o.dialog("close"),o.remove()}function i(){o.dialog("close"),o.remove(),s.resolve()}var o=e("div",{title:"入力"},["div",t],["input",{on:{enterkey:r},$var:"val",value:n}],["br"],["button",{on:{click:r}},"OK"],["button",{on:{click:i}},"キャンセル"]).dialog({width:"auto",close:function(){o.dialog("close"),s.resolve()}});setTimeout(function(){o.$vars.val.focus()},10);var s=$.Deferred();return s.promise()},"undefined"!=typeof window&&(window.UIDiag=t),t}),requireSimulator.setName("runtime"),requirejs(["ImageList","PicoAudio","T2MediaLib","Tonyu","UIDiag"],function(){}),requireSimulator.setName("runScript"),requirejs(["FS","Tonyu.Project","Shell","KeyEventChecker","ScriptTagFS","runtime","WebSite","LSFS"],function(e,t,n,r,i,o,s,a){$(function(){function r(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("iphone")&&-1==e.indexOf("ipad")&&-1==e.indexOf("ipod")||window==window.parent?0:40}function o(){var e=r();p=$(window).width(),h=$(window).height(),m.attr({width:p-e,height:h-e})}function u(){Tonyu.currentProject=Tonyu.globals.$currentProject=w;var e=w.getOptions();e.compiler&&e.compiler.diagnose&&(e.compiler.diagnose=!1,w.setOptions(e)),w.runScriptMode=!0,w.rawRun(e.run.bootClass)}var c=e.get(s.tonyuHome),f=e.get("/ram/");e.mount(f.path(),a.ramDisk()),Tonyu.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32}],sounds:[]},SplashScreen={hide:function(){$("#splash").hide()},show:function(){},progress:function(e){$("#splash").text(e)}};var l=r(),p=$(window).width(),h=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var m=$("<canvas>").attr({width:p-l,height:h-l}).appendTo("body");$(window).resize(o);var d=location.href.replace(/\?.*/,"").split(/\//),g=d.pop()||"runscript",v=d.pop()||"nobody",y=f,b=c.rel(v+"/"+g+"/");f.rel("files/").link(b);var T=i.toObj();for(var x in T){var M=y.rel(x);if(!M.isDir()){var S=T[x];M.text(S.text),delete S.text,S.lastUpdate&&M.metaInfo(S)}}n.cd(y),Tonyu.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:"Main",bootClass:"Boot"},kernelEditable:!1};var w=t(y);u()})}),requireSimulator.setName();