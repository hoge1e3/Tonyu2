!function(e){e("function"==typeof define&&define.amd&&"function"==typeof requirejs?{requirejs:requirejs,define:define}:{})}(function(real){function FileList(e,t){function n(e){var t=$();if(!e)return t;var n=e.path();return v.find(d?"option":"span").each(function(){var e=$(this);e.data("filename")==n&&(t=e)}),t}function r(e){if((!m.on.select||!m.on.select(e))&&e)if(h=!1,e.isDir())a(e);else{var t=e.up();f.path()!=t.path()?(p=e,a(t)):(n(p).removeClass("selected"),p=e,n(p).addClass("selected"))}}function i(e){p&&(h=e,n(p).text(s(p,e)))}function o(){return h}function a(n){function i(){0==c&&o.remove();var t=l[c++];c<l.length&&setTimeout(i,0);var n=u(t);if(n){var a=p&&p.path()==t.path();if(d)e.append($("<option>").attr("value",t.path()).text(s(t)));else{var f=$("<span>").addClass("fileItem").text(s(t)).data("filename",t.path());a&&f.addClass("selected"),$("<li>").append(f).appendTo(v).click(function(){r(t)})}}}if("string"==typeof n&&(n=FS.get(n)),n&&(f=n,g.text(n.name()).attr({title:n.path()})),f&&f.isDir()){v.empty();var o=$("<div>").text("Wait..");v.append(o),d&&(e.empty(),e.append($("<option>").text("Select...")));var a=f.up();a&&!f.equals(t.topDir)&&(d?e.append($("<option>").attr("value",a.path()).text("[Up]")):$(d?"<option>":"<li>").append($("<span>").addClass("fileItem").text("[Up]")).appendTo(v).click(function(){r(a)})),p&&!p.exists()&&(p=null);var c=0,l=f.listFiles();l.length>0?setTimeout(i,0):o.remove()}}function s(e,t){return(t?"*":"")+(e.isReadOnly()?"[RO]":"")+u(e)}function u(e){return m.on.displayName?m.on.displayName.apply(m,arguments):e.name()}function c(){return p}function l(){return f}var f=null,p=null,h=!1,d="select"==e[0].tagName.toLowerCase();t||(t={});var m={select:r,ls:a,on:t.on?t.on:{},curFile:c,curDir:l,setModified:i,isModified:o},g=$("<div>"),v=$("<div>");return d?e.change(function(){this.value&&r(FS.get(this.value))}):e.append(g).append(v),m}function fixIndent(e,t){function n(){for(var e="",n=0;d>n;n++)e+=t;return e}t||(t="    ");var r={"{":1,"}":-1},i=[];try{var o=TT.parse(e),a=o.result[0];a.forEach(function(e){r[e.type]&&(i[u.row]||(i[u.row]=""),i[u.row]+=e.type)})}catch(s){for(var u={row:0,col:0},c=e.length,l=0;c>l;l++){var f=e.substring(l,l+1);r[f]?(i[u.row]||(i[u.row]=""),i[u.row]+=f):"\n"==f?(u.row++,u.col=0):u.col++}}var p="",h=e.split("\n"),d=0,m=0;return h.forEach(function(e){var t=0,r=0;e=e.replace(/^\s*/,""),null!=i[m]&&(i[m].match(/^(\}*)/),r=RegExp.$1.length,i[m].match(/(\{*)$/),t=RegExp.$1.length),d-=r,e=n()+e,d+=t,p+=e+"\n",m++}),p=p.replace(/\n$/,"")}function HttpHelper(e){var t={},n=e.lineMark;return t.buf=$("<div>"),t.bufs=[t.buf],t.maxLineNo=-1,t.cur=function(){return t.bufs[t.bufs.length-1]},t.p=function(e){"string"==typeof e&&(e=e.length>0?$("<span>").text(e):null),t.cur()?(t.lineNo>t.maxLineNo&&(t.maxLineNo=t.lineNo,t.cur().append($("<a>").attr({id:n+"-"+t.lineNo,name:n+"-"+t.lineNo}))),e&&t.cur().append(e)):console.log("Warning - Stack underflow")},t.enter=function(e){"string"==typeof e&&(e=$(e)),t.bufs.push(e)},t.exit=function(){var e=t.bufs.pop();t.p(e)},t.h=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},t}var R={};R.def=function(e,t,n){var r=R.getModuleInfo(R.curName);r.type=n,R.setReqs(r,e),r.func=function(){return t.apply(this,R.getObjs(e))},R.loadIfAvailable(r)};var define=function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]&&(R.curName=e.shift());var t=e.shift(),n=e.shift();R.def(t,n,"define")};define.amd={jQuery:!0};var requirejs=function(e,t){R.def(e,t,"require")};requirejs.isRequireSimulator=!0,R.setReqs=function(e,t){t.forEach(function(t){var n=R.getModuleInfo(t);n.loaded||(e.reqs[t]=n,n.revReqs[e.name]=e)})},R.getModuleInfo=function(e){var t=R.modules;return t[e]||(t[e]={name:e,reqs:{},revReqs:{}}),t[e]},R.doLoad=function(e){var t=R.getModuleInfo(e);if(t.loaded)return t.obj;t.loaded=!0;var n=null;if(t.func)n=t.func();else{var r=e.split(/\./);n=function(){return this}(),r.forEach(function(e){n&&(n=n[e])}),null==n&&console.log("Warning: No obj for "+e)}if("define"==t.type&&null==n)throw"No obj for "+e;t.obj=n;for(var i in t.revReqs)R.notifyLoaded(t.revReqs[i],t.name);return n},R.notifyLoaded=function(e,t){delete e.reqs[t],R.loadIfAvailable(e)},R.loadIfAvailable=function(e){for(var t in e.reqs)return;R.doLoad(e.name)},R.getObjs=function(e){var t=[];return e.forEach(function(e){var n=R.doLoad(e);t.push(n)}),t},R.modules={},R.setName=function(e){R.curName&&(R.getModuleInfo(R.curName).func||R.doLoad(R.curName)),e&&(R.curName=e)},R.real=real;var requireSimulator=R;requireSimulator.setName("Util"),Util=function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?n:t(i[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function r(e,t){return e.substring(0,t.length)===t}function i(e){function t(t){throw console.log(t),console.log(e,c),new Error(t)}e=e.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=e.length,o=0,a=0;if(!i)return new ArrayBuffer(0);r=Math.floor(i/4*3),"="==e.charAt(i-1)&&(r-=1),"="==e.charAt(i-2)&&(r-=1);for(var s=new ArrayBuffer(r),u=new Uint8Array(s),c=0,l=0;r>l&&(a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),o=a<<2,c++,a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=o|a>>4&3,o=(15&a)<<4,c++,l++,!(l>=r))&&(a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=o|a>>2&15,o=(3&a)<<6,c++,l++,!(l>=r));)a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=o|a,c++,l++;return s}function o(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(e),i=r.length,o=0,a=0,s=0;i>s&&(a=r[s],n+=t[a>>2],o=(3&a)<<4,s++,!(s>=i))&&(a=r[s],n+=t[o|a>>4],o=(15&a)<<2,s++,!(s>=i));)a=r[s],n+=t[o|a>>6],n+=t[63&a],s++;var u=i%3;return u&&(n+=t[o]),1==u?n+="==":2==u&&(n+="="),n}function a(e){if(e.__privatized)return e;var t={__privatized:!0};for(var n in e)!function(n){var r=e[n];n.match(/^_/)||"function"==typeof r&&(t[n]=function(){var t=r.apply(e,arguments);return t})}(n);return t}function s(){return"undefined"!=typeof Buffer}function u(e){return s()&&e instanceof Buffer}function c(e){return e instanceof ArrayBuffer||u(e)}function l(e){for(var t=[],n=0;n<e.length;n++)t.push("%"+("0"+e[n].toString(16)).slice(-2));try{return decodeURIComponent(t.join(""))}catch(r){throw console.log(t.join("")),r}}function f(e,t){for(var n=encodeURIComponent(e),r=/^%(..)/,i=[],o=0;o<n.length;o++){var a=r.exec(n.substring(o));a?(i.push(parseInt("0x"+a[1])),o+=a[0].length-1):i.push(n.charCodeAt(o))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(i):new Uint8Array(i).buffer}return{getQueryString:e,endsWith:n,startsWith:r,Base64_To_ArrayBuffer:i,Base64_From_ArrayBuffer:o,utf8bytes2str:l,str2utf8bytes:f,privatize:a,hasNodeBuffer:s,isNodeBuffer:u,isBuffer:c}}(),define("Util",[],function(){return Util}),requireSimulator.setName("FS"),define([],function(){var e,t,n={},i="REQJS_",o=0;n.def=function(e,t,r){var i=n.getModuleInfo(e);"function"==typeof t?(r=t,t=n.reqsFromFunc(r),n.setReqs(i,t),i.func=function(){var e={exports:{}},t=r(n.doLoad,e,e.exports);return t||e.exports}):(n.setReqs(i,t),i.func=function(){return r.apply(this,n.getObjs(t))}),n.loadIfAvailable(i)},e=function(e,t,r){n.def(e,t,r)},e.amd={},t=function(e,t){n.def(i+o++,e,t)},n.setReqs=function(e,t){t.forEach(function(t){var r=n.getModuleInfo(t);r.loaded||(e.reqs[t]=r,r.revReqs[e.name]=e)})},n.getModuleInfo=function(e){var t=n.modules;return t[e]=t[e]||{name:e,reqs:{},revReqs:{}}},n.doLoad=function(e){var t=n.getModuleInfo(e);if(t.loaded)return t.obj;t.loaded=!0;var r=t.func();null!=r||e.match(/^REQJS_/)||console.log("Warning: No obj for "+e),t.obj=r;for(var i in t.revReqs)n.notifyLoaded(t.revReqs[i],t.name);return r},n.notifyLoaded=function(e,t){delete e.reqs[t],n.loadIfAvailable(e)},n.loadIfAvailable=function(e){for(var t in e.reqs)return;n.doLoad(e.name)},n.getObjs=function(e){var t=[];return e.forEach(function(e){var r=n.doLoad(e);t.push(r)}),t},n.reqsFromFunc=function(e){var t=e+"",n=[];return t.replace(/require\s*\(\s*["']([^"']+)["']\s*\)/g,function(e,t){n.push(t)}),n},n.modules={},e("extend",[],function(){return function(e,t){for(var n in t)e[n]=t[n]}}),e("assert",[],function(){function e(t){if(t instanceof Array){var n=[];return t.forEach(function(t){n=n.concat(e(t))}),n}return[t]}var t,n=function(t){this.failMesg=e(t||"Assertion failed: ")};n.prototype={_regedType:{},registerType:function(e,t){this._regedType[e]=t},MODE_STRICT:"strict",MODE_DEFENSIVE:"defensive",MODE_BOOL:"bool",fail:function(){var n=t(arguments),r=n.shift();if(n=e(n),n=this.failMesg.concat(r).concat(n),console.log.apply(console,n),this.isDefensive())return r;if(this.isBool())return!1;throw new Error(n.join(" "))},subAssertion:function(){var r=t(arguments);return r=e(r),new n(this.failMesg.concat(r))},assert:function(e,t){return e?e:this.fail(e,t)},eq:function(e,t){return e!==t?this.fail(e,"!==",t):this.isBool()?!0:e},ne:function(e,t){return e===t?this.fail(e,"===",t):this.isBool()?!0:e},isset:function(e,t){return null==e?this.fail(e,(t||"")+" is null/undef"):this.isBool()?!0:e},is:function(e,t){var n=t,r=e;if(null==n)return this.fail(e,"assert.is: type must be set");if(n._assert_func)return n._assert_func.apply(this,[r]),this.isBool()?!0:e;if(this.assert(null!=e,[e,"should be ",n]),n instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&n instanceof global.Array){if(!e||"number"!=typeof e.length)return this.fail(e,"should be array:");for(var i=this,o=0;o<n.length;o++){var a=i.subAssertion("failed at ",e,"[",o,"]: ");null==n[o]&&console.log("WOW!7",r[o],n[o]),a.is(r[o],n[o])}return this.isBool()?!0:e}if(n===String||"string"==n)return this.assert("string"==typeof r,[r,"should be a string "]),this.isBool()?!0:e;if(n===Number||"number"==n)return this.assert("number"==typeof r,[r,"should be a number"]),this.isBool()?!0:e;if(n===Boolean||"boolean"==n)return this.assert("boolean"==typeof r,[r,"should be a boolean"]),this.isBool()?!0:e;if(n instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&n instanceof global.RegExp)return this.is(r,String),this.assert(n.exec(r),[r,"does not match to",n]),this.isBool()?!0:e;if(n===Function)return this.assert("function"==typeof r,[r,"should be a function"]),this.isBool()?!0:e;if("function"==typeof n)return this.assert(r instanceof n,[r,"should be ",n]),this.isBool()?!0:e;if(n&&"object"==typeof n){for(var s in n){var a=this.subAssertion("failed at ",e,".",s,":");a.is(e[s],n[s])}return this.isBool()?!0:e}if("string"==typeof n){var u=this._regedType[n];return u?this.is(e,u):this.isBool()?!0:e}return this.fail(e,"Invaild type: ",n)},ensureError:function(e,t){try{e()}catch(n){return"string"==typeof t&&i(n+""===t,e+" thrown an error "+n+" but expected:"+t),void console.log("Error thrown successfully: ",n.message)}this.fail(e,"should throw an error",t)},setMode:function(e){this._mode=e},isDefensive:function(){return this._mode===this.MODE_DEFENSIVE},isBool:function(){return this._mode===this.MODE_BOOL},isStrict:function(){return!this.isDefensive()&&!this.isBool()}},t=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t};var r=new n,i=function(){try{return r.assert.apply(r,arguments)}catch(e){throw new Error(e.stack)}};return["setMode","isDefensive","is","isset","ne","eq","ensureError"].forEach(function(e){i[e]=function(){try{return r[e].apply(r,arguments)}catch(t){throw console.log(t.stack),new Error(t.message)}}}),i.fail=r.fail.bind(r),i.MODE_STRICT=r.MODE_STRICT,i.MODE_DEFENSIVE=r.MODE_DEFENSIVE,i.MODE_BOOL=r.MODE_BOOL,i.f=function(e){return{_assert_func:e}},i.opt=function(e){return i.f(function(t){return null==t||t instanceof e})},i.and=function(){var e=t(arguments);return i(e instanceof Array),i.f(function(t){for(var n=this,r=0;r<e.length;r++)n.is(t,e[r])})},i}),e("PathUtil",["assert"],function(e){function t(t,n){return e.is(arguments,[String,String]),t.substring(t.length-n.length)===n}function n(t,n){return e.is(arguments,[String,String]),t.substring(0,n.length)===n}var r,i=/^([a-zA-Z]):/,o=/^([a-z\-]+):\/\/\/?([^\/]+)\//,a=e.f(function(e){this.is(e,String),this.assert(r.isPath(e),[e," is not a path"])}),s=e.f(function(e){this.is(e,String),this.assert(r.isAbsolutePath(e),[e," is not a absolute path"])}),u=e.f(function(e){this.is(e,String),this.assert(!r.isAbsolutePath(e),[e," is not a relative path"])}),c=e.f(function(e){this.is(e,a),this.assert(r.isDir(e),[e," is not a directory path"])}),l=e.and(c,s),f=e.f(function(e){this.is(e,a),this.assert(!r.isDir(e),[e," is not a file path"])}),p="/";return r={Path:a,Absolute:s,Relative:u,Dir:c,File:f,AbsDir:l,SEP:p,endsWith:t,startsWith:n,hasDriveLetter:function(e){return i.exec(e)},isURL:function(e){var t=o.exec(e);if(t)return{protocol:t[1],hostPort:t[2],path:p+e.substring(t[0].length)}},isPath:function(){return e.is(arguments,[String]),!0},isRelativePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&!r.isAbsolutePath(t)},isAbsolutePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&(r.startsWith(t,p)||r.hasDriveLetter(t)||r.isURL(t))},isDir:function(n){return n=r.fixSep(n),e.is(arguments,[a]),t(n,p)},hasBackslashSep:function(e){return e.indexOf("\\")>=0},fixSep:function(t,n){return n=n||"/",e.is(arguments,[String]),e.is(t.replace(/[\\\/]/g,n),a)},directorify:function(t){return r.isDir(t)?t:e.is(t+p,c)},filify:function(t){return r.isDir(t)?e.is(t.substring(0,t.length-1),f):t},splitPath:function(t){e.is(arguments,[a]);var n;if(n=this.isURL(t)){var r=this.splitPath(n.path);return r[0]=n.protocol+"://"+n.hostPort,r}t=t.replace(/\/+/g,p);var i=t.split(p);return""==i[i.length-1]&&(i[i.length-2]+=p,i.pop()),i},name:function(t){return e.is(arguments,[String]),r.splitPath(t).pop()},ext:function(t){e.is(arguments,[String]);var n=r.name(t),i=/\.[a-zA-Z0-9]+$/.exec(n);return i?i[0]:null},truncExt:function(t,n){e.is(t,String);var i=r.name(t);return n=n||r.ext(t),e.is(n,String),i.substring(0,i.length-n.length)},truncSEP:function(t){return e.is(arguments,[a]),r.isDir(t)?t.substring(0,t.length-1):t},endsWith:function(n,i){return e.is(arguments,[String,String]),t(r.name(n),i)},parent:function(t){return e.is(arguments,[String]),r.up(t)},rel:function(t,n){if(""==n)return t;e.is(arguments,[l,u]);var i=r.splitPath(n),o=t;o=o.replace(/\/$/,"");var a=r;return i.forEach(function(e){".."==e||"../"==e?o=a.up(o):(o=o.replace(/\/$/,""),o+=p+("."==e||"./"==e?"":e))}),o},relPath:function(t,n){return e.is(arguments,[s,s]),t.substring(0,n.length)!=n?"../"+r.relPath(t,this.up(n)):t.substring(n.length)},up:function(e){if(e==p)return null;var t=r.splitPath(e);return t.pop(),t.join(p)+p}},["directorify","filify","splitPath","name","rel","relPath","up"].forEach(function(e){var t=r[e];r[e]=function(){var e=!1,n=Array.prototype.slice.call(arguments).map(function(t){return r.hasBackslashSep(t)?(e=!0,r.fixSep(t)):t}),i=t.apply(r,n);return e?r.fixSep(i,"\\"):i}}),r.isAbsolute=r.isAbsolutePath,r.isRelative=r.isRelativePath,"object"==typeof window&&(window.PathUtil=r),r}),e("MIMETypes",[],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".wav":"audio/x-wav",".mp3":"audio/mp3",".ogg":"audio/ogg",".midi":"audio/midi",".mid":"audio/midi",".mzo":"audio/mzo",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu",".c":"text/c",".dtl":"text/dolittle"}}),e("DeferredUtil",[],function(){var e,t="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:null,n=function(e){this.res=e};return e={isNativePromise:function(e){return e&&"function"==typeof e.then&&"function"!=typeof e.promise&&"function"==typeof e.catch},isJQPromise:function(e){return e&&"function"==typeof e.then&&"function"==typeof e.promise&&"function"==typeof e.fail},isPromise:function(e){return e&&"function"==typeof e.then&&("function"==typeof e.promise||"function"==typeof e.catch)},all:function(t){return e.promise(function(n,r){var i=[],o=t.length;t.forEach(function(t,a){e.resolve(t).then(function(e){i[a]=e,o--,0===o&&n(i)},r)})})},resolve:function(t){return e.config.useJQ&&e.isJQPromise(t)?t:!e.config.useJQ&&e.isNativePromise(t)?t:e.promise(function(n,r){e.isPromise(t)?t.then(n,r):n(t)})},throwNowIfRejected:function(t){var n,r,i=t.then(function(e){return n||(n="resolved"),e},function(t){return n?e.reject(t):(n="rejected",void(r=t))});if(n||(n="notyet"),"rejected"===n)throw r;return i},assertResolved:function(e){var t,n;if(e.then(function(e){t=e,n=!0}),!n)throw console.log(r),new Error("Promise not resolved");return t},ensureDefer:function(t){return e.promise(function(n,r){var i;e.resolve(t).then(function(e){i?n(e):setTimeout(function(){n(e)},0)}).fail(function(e){i?r(e):setTimeout(function(){r(e)},0)}),i=!0})},directPromise:function(t){return e.timeout(t,0)},then:function(t){return e.directPromise().then(t)},timeout:function(t,n){return e.promise(function(e){setTimeout(function(){e(n)},t||0)})},funcPromise:function(t){if(e.config.useJQ){var n=new $.Deferred;try{t(function(e){n.resolve(e)},function(e){n.reject(e)})}catch(r){n.reject(r)}return n.promise()}if(e.external.Promise)return new e.external.Promise(function(e,n){try{t(e,n)}catch(r){n(r)}});throw new Error("promise is not found")},reject:function(t){if(e.config.useJQ){var n=new $.Deferred;return n.reject(t),n.promise()}return new e.external.Promise(function(e,n){n(t)})},throwPromise:function(t){if(e.config.useJQ){var n=new $.Deferred;return setTimeout(function(){n.reject(t)},0),n.promise()}return new e.external.Promise(function(e,n){n(t)})},throwF:function(t){return function(){try{return t.apply(this,arguments)}catch(n){return console.log(n,n.stack),e.throwPromise(n)}}},each:function(t,n){if(t instanceof Array)return e.loop(function(r){return r>=t.length?e.brk():e.resolve(n(t[r],r)).then(function(){return r+1})},0);var r=[];for(var i in t)r.push({k:i,v:t[i]});return e.each(r,function(e){return n(e.k,e.v)})},loop:function(t,r){try{for(var i;;){if(r instanceof n)return e.when1(r.res);var o=!0,a=!1,s=t(r),u=e.resolve(s).then(function(i){return r=i,o=!1,r instanceof n?r.res:a?e.loop(t,r):void 0}).fail(function(e){o=!1,i=e});if(i)throw i;if(a=!0,o)return u}}catch(c){return e.reject(c)}},brk:function(e){return new n(e)},tryLoop:function(t,n){return e.loop(e.tr(t),n)},tryEach:function(t,n){return e.loop(t,e.tr(n))},documentReady:function(){return e.callbackToPromise(function(e){$(e)})},requirejs:function(n){if(!t.requirejs)throw new Error("requirejs is not loaded");return e.callbackToPromise(function(e){t.requirejs(n,e)})}},e.NOP=function(e){return e},e.E=function(){console.log("DUE",arguments),e.errorHandler.apply(e,arguments)},e.errorHandler=function(e){console.error.apply(console,arguments),alert(e)},e.setE=function(t){e.errorHandler=t},e.begin=e.try=e.tr=e.throwF,e.promise=e.callbackToPromise=e.funcPromise,e.when1=e.resolve,e.config={},t.$&&t.$.Deferred&&(e.config.useJQ=!0),e.external={Promise:t.Promise},t.DeferredUtil||(t.DeferredUtil=e),e}),e("FSClass",["extend","PathUtil","MIMETypes","assert","DeferredUtil"],function(e,t,n,r,i){function o(e){throw new Error(e+" is STUB!")}var a=function(){},s={};return a.addFSType=function(e,t){s[e]=t},a.availFSTypes=function(){return s},e(a.prototype,{err:function(e,t){throw new Error(e+": "+t)},fstype:function(){return"Unknown"},isReadOnly:function(){o("isReadOnly")},supportsSync:function(){return!0},resolveFS:function(e){return r(this.getRootFS()!==this),this.getRootFS().resolveFS(e)},mounted:function(e,t){this.rootFS=e,this.mountPoint=t},inMyFS:function(e){return!this.mountPoint||t.startsWith(e,this.mountPoint)},getRootFS:function(){return r(this.rootFS,"rootFS is not set")},getReturnTypes:function(){o("")},getContent:function(){o("getContent")},getContentAsync:function(){return this.supportsSync()||o("getContentAsync"),i.resolve(this.getContent.apply(this,arguments))},setContent:function(){o("")},setContentAsync:function(e,t,n){var r=this;return r.supportsSync()||o("setContentAsync"),i.resolve(t).then(function(t){return i.resolve(r.setContent(e,t,n))})},appendContent:function(){o("")},appendContentAsync:function(e,t,n){var r=this;return r.supportsSync()||o("appendContentAsync"),i.resolve(t).then(function(t){return i.resolve(r.appendContent(e,t,n))})},getMetaInfo:function(){o("")},setMetaInfo:function(){o("")},mkdir:function(){o("mkdir")},touch:function(){o("touch")},exists:function(){o("exists")},opendir:function(){o("opendir")},opendirAsync:function(){return this.supportsSync()||o("opendirAsync"),i.resolve(this.opendir.apply(this,arguments))},cp:function(e,n,i){r.is(arguments,[t.Absolute,t.Absolute]),this.assertExist(e),i=i||{};var o=this.isDir(e),a=this.getRootFS().resolveFS(n),s=a.isDir(n);if(o||s)throw new Error("only file to file supports");if(this.supportsSync()&&a.supportsSync()){var u=this.getContent(e),c=a.setContent(n,u);return i.a&&a.setMetaInfo(n,this.getMetaInfo(e)),c}return a.setContentAsync(n,this.getContentAsync(e)).then(function(t){return i.a?a.setMetaInfo(n,this.getMetaInfo(e)):t})},mv:function(e,t,n){return this.cp(e,t,n),this.rm(e,{r:!0})},rm:function(){o("")},link:function(e,t){throw new Error("ln "+t+" "+e+" : This FS not support link.")},getURL:function(){o("")}}),a.delegateMethods=function(e,n){for(var i in n)!function(i){r.ne(i,"inMyFS"),e[i]=function(){var e=arguments[0];r.is(e,t.Absolute);var o=this.resolveFS(e);return o!==this?(console.log("Invoked for other fs",this.mountPoint,o.mountPoint),o[i].apply(o,arguments)):n[i].apply(this,arguments)}}(i)},a.delegateMethods(a.prototype,{assertWriteable:function(e){this.isReadOnly(e)&&this.err(e,"read only.")},getContentType:function(e,r){var i=(t.ext(e)+"").toLowerCase();return n[i]||(r||{}).def||"application/octet-stream"},getBlob:function(e,t){var n=this.getContent(e);return t=t||{},t.blobType=t.blobType||Blob,t.binType=t.binType||ArrayBuffer,n.hasPlainText()?new t.blobType([n.toPlainText()],this.getContentType(e)):new t.blobType([n.toBin(t.binType)],this.getContentType(e))},isText:function(e){var n=this.getContentType(e);return t.startsWith(n,"text")},assertExist:function(e,n){this.exists(e,n)||this.err(e,": No such "+(t.isDir(e)?"directory":"file"))},isDir:function(e){return t.isDir(e)},find:function(e,n){r.is(arguments,[t.Absolute]);var i=this.opendir(e,n),o=this,a=[e];return i.forEach(function(r){var i=t.rel(e,r);if(t.isDir(i)){var s=o.resolveFS(i);a=a.concat(s.find(i,n))}else a.push(i)}),a},resolveLink:function(e){r.is(e,t.Absolute);for(var n=e;n;n=t.up(n)){r(!this.mountPoint||t.startsWith(n,this.mountPoint),n+" is out of mountPoint. path="+e);var i=this.isLink(n);if(i){r(i!=n,"l==p=="+i);var o=t.rel(i,t.relPath(e,n));return r(o!=e,"np==path=="+o),r.is(this.getRootFS().resolveFS(o).resolveLink(o),t.Absolute)}if(this.exists(n))return e}return e},isLink:function(){return null},opendirEx:function(e){r.is(e,t.AbsDir);var n=this.opendir(e),i=this,o={};return n.forEach(function(n){var r=t.rel(e,n);o[n]=i.getMetaInfo(r)}),o},getDirTree:function(e,n){n=n||{};var i=n.dest=n.dest||{};n.style=n.style||"flat-absolute",n.excludes=n.excludes||[],r.is(n.excludes,Array),n.base||(n.base=e),r.is(e,t.AbsDir);var o=this.opendirEx(e,n);if("no-recursive"==n.style)return o;var a=this;for(var s in o){var u=o[s],c=t.rel(e,s),l=t.relPath(c,n.base);switch(n.style){case"flat-relative":case"hierarchical":if(n.excludes.indexOf(l)>=0)continue;break;case"flat-absolute":if(n.excludes.indexOf(c)>=0)continue}if(a.isDir(c))switch(n.style){case"flat-absolute":case"flat-relative":a.getDirTree(c,n);break;case"hierarchical":n.dest={},i[s]=a.getDirTree(c,n)}else switch(n.style){case"flat-absolute":i[c]=u;break;case"flat-relative":i[l]=u;break;case"hierarchical":i[s]=u}}return i}}),a}),e("Util",[],function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?n:t(i[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function r(e,t){return e.substring(0,t.length)===t}function i(e){if(e.__privatized)return e;var t={__privatized:!0};for(var n in e)!function(n){var r=e[n];n.match(/^_/)||"function"==typeof r&&(t[n]=function(){var t=r.apply(e,arguments);return t})}(n);return t}function o(e,t){for(var n in t||{})e[n]=t[n];return e}return{getQueryString:e,endsWith:n,startsWith:r,privatize:i,extend:o}});var a=a||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=t.createElementNS("http://www.w3.org/1999/xhtml","a"),r="download"in n,i=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},o=e.webkitRequestFileSystem,a=e.requestFileSystem||o||e.mozRequestFileSystem,s=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},u=0,c=function(t){var n=function(){"string"==typeof t?(e.URL||e.webkitURL||e).revokeObjectURL(t):t.remove()};e.chrome?n():setTimeout(n,10)},l=function(e,t,n){t=[].concat(t);for(var r=t.length;r--;){var i=e["on"+t[r]];if("function"==typeof i)try{i.call(e,n||e)}catch(o){s(o)}}},f=function(t,s){var f,p,h,d=this,m=t.type,g=!1,v=function(){l(d,["writestart","progress","write","writeend"])},y=function(){(g||!f)&&(f=(e.URL||e.webkitURL||e).createObjectURL(t)),p?p.location.href=f:void 0==e.open(f,"_blank")&&"undefined"!=typeof safari&&(e.location.href=f),d.readyState=d.DONE,v(),c(f)},b=function(e){return function(){return d.readyState!==d.DONE?e.apply(this,arguments):void 0}},T={create:!0,exclusive:!1};d.readyState=d.INIT,s||(s="download"),r?(f=(e.URL||e.webkitURL||e).createObjectURL(t),n.href=f,n.download=s,i(n),d.readyState=d.DONE,v(),c(f)):(e.chrome&&m&&"application/octet-stream"!==m&&(h=t.slice||t.webkitSlice,t=h.call(t,0,t.size,"application/octet-stream"),g=!0),o&&"download"!==s&&(s+=".download"),("application/octet-stream"===m||o)&&(p=e),a?(u+=t.size,a(e.TEMPORARY,u,b(function(e){e.root.getDirectory("saved",T,b(function(e){var n=function(){e.getFile(s,T,b(function(e){e.createWriter(b(function(n){n.onwriteend=function(t){p.location.href=e.toURL(),d.readyState=d.DONE,l(d,"writeend",t),c(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&y()},["writestart","progress","write","abort"].forEach(function(e){n["on"+e]=d["on"+e]}),n.write(t),d.abort=function(){n.abort(),d.readyState=d.DONE},d.readyState=d.WRITING}),y)}),y)};e.getFile(s,{create:!1},b(function(e){e.remove(),n()}),b(function(e){e.code===e.NOT_FOUND_ERR?n():y()}))}),y)}),y)):y())},p=f.prototype;return p.abort=function(){this.readyState=this.DONE,l(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t){return new f(e,t)}}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=a:"undefined"!=typeof e&&null!==e&&null!=e.amd&&e("FileSaver.min",[],function(){return a}),e("Content",["assert","Util","FileSaver.min"],function(e,t,n){var r=function(){},i=t.extend;r.plainText=function(e,t){var n=new r;return n.contentType=t||"text/plain",n.plain=e,n},r.url=function(e){var t=new r;return t.url=e,t},r.buffer2ArrayBuffer=function(t){if(r.isBuffer(t)){var n=new Uint8Array(t),i=n.buffer;if(i instanceof ArrayBuffer)return i;var o=Array.prototype.slice.call(n);return e(new Uint8Array(o).buffer,"n2a: buf is not set")}return e(t,"n2a: a is not set")},r.arrayBuffer2Buffer=function(t){if(t instanceof ArrayBuffer){var n=new Buffer(new Uint8Array(t));return n}return e(t,"a2n: a is not set")},r.bin=function(t,n){e(n,"contentType should be set");var i=new r;if(t&&r.isBuffer(t.buffer))i.arrayBuffer=t.buffer;else if(r.isNodeBuffer(t))i.nodeBuffer=t;else{if(!(t instanceof ArrayBuffer))throw new Error(t+" is not a bin");i.arrayBuffer=t}return i.contentType=n,i},r.looksLikeDataURL=function(e){return e.match(/^data:/)},r.download=n;var o=r.prototype;o.toBin=function(e){if(e=e||(r.hasNodeBuffer()?Buffer:ArrayBuffer),this.nodeBuffer)return e===Buffer?this.nodeBuffer:this.arrayBuffer=r.buffer2ArrayBuffer(this.nodeBuffer);if(this.arrayBuffer)return e===ArrayBuffer?this.arrayBuffer:this.nodeBuffer=r.arrayBuffer2Buffer(this.arrayBuffer);if(this.url){var t=new s(this.url,e);return this.setBuffer(t.buffer)}if(null!=this.plain)return this.setBuffer(r.str2utf8bytes(this.plain,e));throw new Error("No data")},o.setBuffer=function(t){return e(t,"b is not set"),r.isNodeBuffer(t)?this.nodeBuffer=t:this.arrayBuffer=t},o.toArrayBuffer=function(){return this.toBin(ArrayBuffer)},o.toNodeBuffer=function(){return this.toBin(Buffer)},o.toURL=function(){if(this.url)return this.url;if(this.arrayBuffer||null==this.plain||(this.arrayBuffer=r.str2utf8bytes(this.plain,ArrayBuffer)),this.arrayBuffer||this.nodeBuffer){var e=new s(this.arrayBuffer||this.nodeBuffer,this.contentType);return this.url=e.url}throw new Error("No data")},o.toPlainText=function(){if(this.hasPlainText())return this.plain;if(this.url&&!this.hasBin()){var e=new s(this.url,ArrayBuffer);this.arrayBuffer=e.buffer}if(this.hasBin())return this.plain=r.utf8bytes2str(this.nodeBuffer||new Uint8Array(this.arrayBuffer));throw new Error("No data")},o.hasURL=function(){return this.url},o.hasPlainText=function(){return null!=this.plain},o.hasBin=function(){return this.nodeBuffer||this.arrayBuffer},o.hasNodeBuffer=function(){return this.nodeBuffer},o.hasArrayBuffer=function(){return this.arrayBuffer
},o.toBlob=function(){return new Blob([this.toBin(ArrayBuffer)],{type:this.contentType})},o.download=function(e){r.download(this.toBlob(),e)},r.Base64_To_ArrayBuffer=function(e,t){function n(t){throw console.log(t),console.log(e,p),new Error(t)}var i=t||ArrayBuffer;e=e.replace(/[\n=]/g,"");var o=new Object;o[65]=0,o[66]=1,o[67]=2,o[68]=3,o[69]=4,o[70]=5,o[71]=6,o[72]=7,o[73]=8,o[74]=9,o[75]=10,o[76]=11,o[77]=12,o[78]=13,o[79]=14,o[80]=15,o[81]=16,o[82]=17,o[83]=18,o[84]=19,o[85]=20,o[86]=21,o[87]=22,o[88]=23,o[89]=24,o[90]=25,o[97]=26,o[98]=27,o[99]=28,o[100]=29,o[101]=30,o[102]=31,o[103]=32,o[104]=33,o[105]=34,o[106]=35,o[107]=36,o[108]=37,o[109]=38,o[110]=39,o[111]=40,o[112]=41,o[113]=42,o[114]=43,o[115]=44,o[116]=45,o[117]=46,o[118]=47,o[119]=48,o[120]=49,o[121]=50,o[122]=51,o[48]=52,o[49]=53,o[50]=54,o[51]=55,o[52]=56,o[53]=57,o[54]=58,o[55]=59,o[56]=60,o[57]=61,o[43]=62,o[47]=63;var a,s=e.length,u=0,c=0;if(!s)return new i(0);a=Math.floor(s/4*3),"="==e.charAt(s-1)&&(a-=1),"="==e.charAt(s-2)&&(a-=1);for(var l=new i(a),f=r.isNodeBuffer(l)?l:new Uint8Array(l),p=0,h=0;a>h&&(c=o[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),u=c<<2,p++,c=o[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c>>4&3,u=(15&c)<<4,p++,h++,!(h>=a))&&(c=o[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c>>2&15,u=(3&c)<<6,p++,h++,!(h>=a));)c=o[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c,p++,h++;return l},r.Base64_From_ArrayBuffer=function(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(e),i=r.length,o=0,a=0,s=0;i>s&&(a=r[s],n+=t[a>>2],o=(3&a)<<4,s++,!(s>=i))&&(a=r[s],n+=t[o|a>>4],o=(15&a)<<2,s++,!(s>=i));)a=r[s],n+=t[o|a>>6],n+=t[63&a],s++;var u=i%3;return u&&(n+=t[o]),1==u?n+="==":2==u&&(n+="="),n},r.hasNodeBuffer=function(){return"undefined"!=typeof Buffer},r.isNodeBuffer=function(e){return r.hasNodeBuffer()&&e instanceof Buffer},r.isBuffer=function(e){return e instanceof ArrayBuffer||r.isNodeBuffer(e)},r.utf8bytes2str=function(e){for(var t=[],n=0;n<e.length;n++)t.push("%"+("0"+e[n].toString(16)).slice(-2));return decodeURIComponent(t.join(""))},r.str2utf8bytes=function(e,t){for(var n=encodeURIComponent(e),r=/^%(..)/,i=[],o=0;o<n.length;o++){var a=r.exec(n.substring(o));a?(i.push(parseInt("0x"+a[1])),o+=a[0].length-1):i.push(n.charCodeAt(o))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(i):new Uint8Array(i).buffer};var a=r.hasNodeBuffer()?Buffer:ArrayBuffer,s=function(t,n){"string"==typeof t?(this.url=t,this.binType=n||a,this.dataURL2bin(t)):t&&r.isBuffer(t.buffer)?(this.buffer=t.buffer,e.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):r.isBuffer(t)?(this.buffer=t,e.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):(console.log(arguments),e.fail("Invalid args: ",arguments))};return r.DataURL=s,i(s.prototype,{bin2dataURL:function(t,n){e(r.isBuffer(t)),e.is(n,String);var i=this.dataHeader(n),o=r.Base64_From_ArrayBuffer(t);return e.is(o,String),this.url=i+o},dataURL2bin:function(t){e.is(arguments,[String]);var n=/^data:([^;]+);base64,/i,i=n.exec(t);return e(i,["malformed dataURL:",t]),this.contentType=i[1],this.buffer=r.Base64_To_ArrayBuffer(t.substring(i[0].length),this.binType),e.is(this.buffer,this.binType)},dataHeader:function(t){return e.is(arguments,[String]),"data:"+t+";base64,"},toString:function(){return e.is(this.url,String)}}),r}),e("NativeFS",["FSClass","assert","PathUtil","extend","Content"],function(e,t,n,r,i){var o="object"==typeof process;if(!o)return function(){throw new Error("This system not support native FS")};var a=t,s=require("fs"),u=function(e){e&&(t.is(e,n.AbsDir),this.rootPoint=e)},c=n.hasDriveLetter(process.cwd());u.available=!0;var l=n.SEP,f=u.prototype=new e;return f.toNativePath=function(e){return this.rootPoint?(t.is(e,n.Absolute),t(this.inMyFS(e),e+" is not fs of "+this),n.rel(this.rootPoint,n.relPath(e,this.mountPoint||n.SEP))):e},f.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return e},e.addFSType("NativeFS",function(e,t){return new u(t.r)}),u.prototype.fstype=function(){return"Native"+(this.rootPoint?"("+this.rootPoint+")":"")},u.prototype.inMyFS=function(e){return this.mountPoint?n.startsWith(e,this.mountPoint):!(!!c^!!n.hasDriveLetter(e))},e.delegateMethods(u.prototype,{getReturnTypes:function(){return a.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(e,r){r=r||{},t.is(e,n.Absolute);var o=this.toNativePath(e);return this.assertExist(e),i.bin(s.readFileSync(o),this.getContentType(e))},setContent:function(e,r){t.is(arguments,[n.Absolute,i]);var o=n.up(e);o&&this.getRootFS().resolveFS(o).mkdir(o);var a=this.toNativePath(e);r.hasBin()||!r.hasPlainText()?s.writeFileSync(a,r.toNodeBuffer()):s.writeFileSync(a,r.toPlainText())},appendContent:function(e,r){t.is(arguments,[n.Absolute,i]);var o=n.up(e);o&&this.getRootFS().resolveFS(o).mkdir(o);var a=this.toNativePath(e);r.hasBin()||!r.hasPlainText()?s.appendFileSync(a,r.toNodeBuffer()):s.appendFileSync(a,r.toPlainText())},getMetaInfo:function(e,t){this.assertExist(e,t);var n=this.stat(e);return n.lastUpdate=n.mtime.getTime(),n},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(e){t.is(e,n.Absolute);var r=this.toNativePath(e);return s.statSync(r)},mkdir:function(e){if(a.is(arguments,[n.Absolute]),this.exists(e)){if(this.isDir(e))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(e);var t=n.up(e);t&&this.getRootFS().resolveFS(t).mkdir(t);var r=this.toNativePath(e);return s.mkdirSync(r),this.assertExist(r)},opendir:function(e,t){a.is(arguments,[String]),t=t||{};var r=this.toNativePath(e),i=n.truncSEP(r),o=s.readdirSync(r);t.nosep||(o=o.map(function(e){var t=s.statSync(i+l+e),n=t.isDirectory()?l:"";return e+n}));var u=[];return a.is(u.concat(o),Array)},rm:function(e,t){a.is(arguments,[n.Absolute]),t=t||{},this.assertExist(e);var r=this.toNativePath(e);return this.isDir(e)?s.rmdirSync(r):s.unlinkSync(r)},exists:function(e){var t=this.toNativePath(e);return s.existsSync(t)},isDir:function(e){return this.exists(e)?this.stat(e).isDirectory():n.isDir(e)},touch:function(e){!this.exists(e)&&this.isDir(e)?this.mkdir(e):this.exists(e)&&s.utimesSync(e,Date.now()/1e3,Date.now()/1e3)},getURL:function(e){return"file:///"+e.replace(/\\/g,"/")}}),u}),e("LSFS",["FSClass","PathUtil","extend","assert","Util","Content"],function(e,t,n,r,i,o){function a(){return(new Date).getTime()}var s=function(e,t){r(e," new LSFS fail: no storage"),this.storage=e,this.options=t||{},this.options.useDirCache&&(this.dirCache={})},u=t.isDir.bind(t),c=t.up.bind(t),l=t.endsWith.bind(t),f=(t.Path,t.Absolute),p=t.SEP;return s.ramDisk=function(e){var n={};return n[t.SEP]="{}",e=e||{},"useDirCache"in e||(e.useDirCache=!0),new s(n,e)},e.addFSType("localStorage",function(e,t){return new s(localStorage,t)}),e.addFSType("ram",function(e,t){return s.ramDisk(t)}),s.now=a,s.prototype=new e,s.prototype.resolveKey=function(e){return r.is(e,t.Absolute),this.mountPoint?t.SEP+t.relPath(e,this.mountPoint):e},s.prototype.getItem=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);return this.storage[n]},s.prototype.setItem=function(e,n){r.is(e,t.Absolute);var i=this.resolveKey(e);r(i.indexOf("..")<0),r(t.startsWith(i,t.SEP)),this.storage[i]=n},s.prototype.removeItem=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);delete this.storage[n]},s.prototype.itemExists=function(e){r.is(e,t.Absolute);var n=this.resolveKey(e);return r(this.storage,"No storage"),n in this.storage},s.prototype.getDirInfo=function(e){if(r.is(arguments,[t.AbsDir]),null==e)throw new Error("getDir: Null path");if(l(e,p)||(e+=p),r(this.inMyFS(e)),this.dirCache&&this.dirCache[e])return this.dirCache[e];var n={};try{var i=this.getItem(e);i&&(n=JSON.parse(i))}catch(o){console.log("dinfo err : ",e,i)}return this.dirCache&&(this.dirCache[e]=n),n},s.prototype.putDirInfo=function(e,n,i){if(r.is(arguments,[t.AbsDir,Object]),!u(e))throw new Error("Not a directory : "+e);r(this.inMyFS(e)),this.dirCache&&(this.dirCache[e]=n),this.setItem(e,JSON.stringify(n));var o=c(e);if(null!=o&&this.inMyFS(o)){var a=this.getDirInfo(o);this._touch(a,o,t.name(e),i)}},s.prototype._touch=function(e,n,i,o){r.is(arguments,[Object,String,String]),r(this.inMyFS(n)),e[i]||(e[i]={},o&&(e[i].trashed=!0)),o||delete e[i].trashed,e[i].lastUpdate=a(),this.getRootFS().notifyChanged(t.rel(n,i),e[i]),this.putDirInfo(n,e,o)},s.prototype.removeEntry=function(e,t,n){r.is(arguments,[Object,String,String]),e[n]&&(e[n]={lastUpdate:a(),trashed:!0},this.putDirInfo(t,e,!0))},s.prototype.removeEntryWithoutTrash=function(e,t,n){r.is(arguments,[Object,String,String]),e[n]&&(delete e[n],this.putDirInfo(t,e,!0))},s.prototype.isRAM=function(){return this.storage!==localStorage},s.prototype.fstype=function(){return this.isRAM()?"ramDisk":"localStorage"},s.getUsage=function(){var e=0;for(var t in localStorage)"string"==typeof localStorage[t]&&(e+=localStorage[t].length);return e},s.getCapacity=function(){function e(){try{return localStorage[r+t]=n,t++,i+=n.length,!0}catch(e){return delete localStorage[r+t],!1}}var t=0,n="a",r="___checkls___",i=0,o=Math.pow(2,25);try{for(var a=0;10>a;a++)n+=n;for(var a in localStorage)a.substring(0,r.length)==r?delete localStorage[a]:"string"==typeof localStorage[a]&&(i+=localStorage[a].length);for(var s=i;e()&&n.length<o;)n+=n;for(;n.length>1024;)n=n.substring(n.length/2),e();return{using:s,max:i}}finally{for(var a=0;t>a;a++)delete localStorage[r+a]}},e.delegateMethods(s.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return r.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(e){r.is(arguments,[f]),this.assertExist(e);var t,n=this.getItem(e);return t=o.looksLikeDataURL(n)?o.url(n):o.plainText(n)},setContent:function(e,t){r.is(arguments,[f,o]),this.assertWriteable(e);var n=null;t.hasPlainText()&&(n=t.toPlainText(),o.looksLikeDataURL(n)&&(n=null)),null!=n?this.setItem(e,n):this.setItem(e,t.toURL()),this.touch(e)},getMetaInfo:function(e){if(this.assertExist(e,{includeTrashed:!0}),r.is(arguments,[f]),e==t.SEP)return{};var n=r(t.up(e));if(!this.inMyFS(n))return{};var i=t.name(e);r.is(n,t.AbsDir);var o=this.getDirInfo(n);return r(o[i])},setMetaInfo:function(e,n){r.is(arguments,[String,Object]),this.assertWriteable(e);var i=r(t.up(e));if(this.inMyFS(i)){var o=this.getDirInfo(i),a=t.name(e);o[a]=n,this.putDirInfo(i,o,o[a].trashed)}},mkdir:function(e){r.is(arguments,[f]),this.assertWriteable(e),this.touch(e)},opendir:function(e,t){r.is(arguments,[String]),t=t||{};var n=this.getDirInfo(e),i=[];for(var o in n)r(n[o]),(!n[o].trashed||t.includeTrashed)&&i.push(o);return r.is(i,Array)},rm:function(e,n){r.is(arguments,[f]),n=n||{},this.assertWriteable(e);var i=t.up(e);if(null==i||!this.inMyFS(i))throw new Error(e+": cannot remove. It is root of this FS.");if(this.assertExist(e,{includeTrashed:n.noTrash}),t.isDir(e)){var o=this.opendir(e);o.length>0&&this.err(e,"Directory not empty"),n.noTrash&&this.removeItem(e)}else this.removeItem(e);var a=this.getDirInfo(i);n.noTrash?this.removeEntryWithoutTrash(a,i,t.name(e)):this.removeEntry(a,i,t.name(e))},exists:function(e,n){r.is(arguments,[f]),n=n||{};var i=t.name(e),o=t.up(e);if(null==o||!this.inMyFS(o))return!0;var a=this.getDirInfo(o),s=a[i];return s&&s.trashed&&this.itemExists(e)&&this.isDir(e),!s&&this.itemExists(e),s&&!s.trashed&&!s.link&&!this.itemExists(e),s&&!n.includeTrashed&&(s=!s.trashed),!!s},link:function(e,n){r.is(arguments,[t.Absolute,t.Absolute]),this.assertWriteable(e),this.exists(e)&&this.err(e,"file exists"),t.isDir(e)&&!t.isDir(n)&&this.err(e," can not link to file "+n),!t.isDir(e)&&t.isDir(n)&&this.err(e," can not link to directory "+n);var i={};i.link=n,i.lastUpdate=a(),this.setMetaInfo(e,i),r(this.exists(e)),r(this.isLink(e))},isLink:function(e){if(r.is(arguments,[t.Absolute]),!this.exists(e))return null;var n=r(this.getMetaInfo(e));return n.link},touch:function(e){r.is(arguments,[f]),this.assertWriteable(e),this.itemExists(e)||(t.isDir(e)?(this.dirCache&&(this.dirCache[e]={}),this.setItem(e,"{}")):this.setItem(e,""));var n=c(e);if(null!=n)if(this.inMyFS(n)){var i=this.getDirInfo(n);this._touch(i,n,t.name(e),!1)}else r(this.getRootFS()!==this),this.getRootFS().resolveFS(n).touch(n)},getURL:function(e){return this.getContent(e).toURL()},opendirEx:function(e,n){r.is(e,t.AbsDir),n=n||{};var i={},o=this.getDirInfo(e);if(n.includeTrashed)return o;for(var a in o)o[a].trashed||(i[a]=o[a]);return i}}),s}),$.ajaxTransport("+binary",function(e,t,n){return window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))?{send:function(t,n){var r=new XMLHttpRequest,i=e.url,o=e.type,a=e.async||!0,s=e.responseType||"blob",u=e.data||null,c=e.username||null,l=e.password||null;r.addEventListener("load",function(){var t={};t[e.dataType]=r.response,n(r.status,r.statusText,t,r.getAllResponseHeaders())}),r.open(o,i,a,c,l);for(var f in t)r.setRequestHeader(f,t[f]);r.responseType=s,r.send(u)},abort:function(){n.abort()}}:void 0}),e("jquery.binarytransport",function(){}),e("WebFS",["FSClass","jquery.binarytransport","DeferredUtil","Content","PathUtil"],function(e,t,n,r,i){var o=function(){},a=o.prototype=new e;return e.addFSType("web",function(){return new o}),a.fstype=function(){return"Web"},a.supportsSync=function(){return!1},a.inMyFS=function(e){return i.isURL(e)},e.delegateMethods(a,{exists:function(){return!0},getContentAsync:function(e){var t=this;return n.promise(function(n,i){$.get(e,function(i){var o=new FileReader;o.addEventListener("loadend",function(){n(r.bin(o.result,t.getContentType(e)))}),o.readAsArrayBuffer(i)},"binary").fail(i)})},getURL:function(e){return e}}),o}),e("Env",["assert","PathUtil"],function(e,t){var n=function(e){this.value=e};return n.prototype={expand:function(t){e.is(t,String);var n=this;return t.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,t){return n.get(t)})},expandPath:function(n){return e.is(n,String),n=this.expand(n),n=n.replace(/\/+/g,"/"),n=n.replace(/^[a-z][a-z]+:\//,function(e){return e+"/"}),e.is(n,t.Path)},get:function(e){return this.value[e]},set:function(e,t){this.value[e]=t}},n}),e("SFile",["extend","assert","PathUtil","Util","Content","FSClass","FileSaver.min","DeferredUtil"],function(e,t,n,r,i,o,a,s){var u=function(e,r){t.is(r,n.Absolute),this._path=r,this.rootFS=e,this.fs=e.resolveFS(r),this.isDir()&&!n.isDir(r)&&(this._path+=n.SEP)};return u.is=function(e){return e&&"function"==typeof e.isSFile&&e.isSFile()},u.prototype={isSFile:function(){return!0},setPolicy:function(e){if(this.policy)throw new Error("policy already set");return this.policy=e,this._clone()},getPolicy:function(){return this.policy},_clone:function(){return this._resolve(this.path())},_resolve:function(e,i){var o;if(i=i||{},u.is(e))o=e;else{t.is(e,n.Absolute);var a,s=i.policy||this.policy;if(s&&(a=s.topDir)&&(a.path&&(a=a.path()),!n.startsWith(e,a)))throw new Error(e+": cannot access. Restricted to "+a);o=new u(this.rootFS,e),o.policy=s}return o.policy?r.privatize(o):o},contains:function(e){return t(u.is(e),e+" shoud be a SFile object."),this.isDir()?n.startsWith(e.path(),this.path()):!1},path:function(){return this._path},name:function(){return n.name(this.path())},truncExt:function(e){return n.truncExt(this.path(),e)},ext:function(){return n.ext(this.path())},relPath:function(e){var r=e.path?e.path():e;return n.relPath(this.path(),t.is(r,n.Absolute))},up:function(){var e=this.path(),t=n.up(e);return null==t?null:this._resolve(t)},rel:function(e){t.is(e,n.Relative),this.assertDir();var r=this.path();return this._resolve(n.rel(r,e))},sibling:function(e){return this.up().rel(e)},startsWith:function(e){return n.startsWith(this.name(),e)},endsWith:function(e){return n.endsWith(this.name(),e)},equals:function(e){return e&&"function"==typeof e.path&&e.path()==this.path()},toString:function(){return this.path()},touch:function(){return this.act.fs.touch(this.act.path)},isReadOnly:function(){return this.act.fs.isReadOnly(this.act.path)},isTrashed:function(){var e=this.metaInfo();return e?e.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(e){return this.act.fs.getMetaInfo(this.act.path,e)},setMetaInfo:function(e,t){return this.act.fs.setMetaInfo(this.act.path,e,t)},getDirTree:function(e){return this.act.fs.getDirTree(this.act.path,e)},assertExists:function(){t(this.exists(),this.path()+" does not exist.")},lastUpdate:function(){return this.assertExists(),this.metaInfo().lastUpdate},exists:function(e){var t=Array.prototype.slice.call(arguments);if("function"==typeof t[0]){var n=t.shift();return s.resolve(this.exists.apply(this,t)).then(n)}e=e||{};var r=this.fs.exists(this.path(),e);return r||e.noFollowLink?r:this.act.fs.exists(this.act.path,{noFollowLink:!0})},rm:function(e){var t=this;if(e=e||{},this.isLink())return s.resolve(this.fs.rm(this.path(),e));var n;return n=this.isDir()&&(e.recursive||e.r)?this.each(function(t){return t.rm(e)}):s.resolve(),n.then(function(){return t.act.fs.rm(t.act.path,e)})},removeWithoutTrash:function(e){e=e||{},e.noTrash=!0,this.rm(e)},isDir:function(){return this.act.fs.isDir(this.act.path)},text:function(e){return"function"==typeof e?this.getText(e):arguments.length>0?this.setText(arguments[0]):this.getText()},setText:function(e){if(t.is(e,String),this.isDir())throw new Error("Cannot write to directory: "+this.path());var n=this.contentType({def:null});return s.throwNowIfRejected(null!==n&&!n.match(/^text/)&&i.looksLikeDataURL(e)?this.setContent(i.url(e)):this.setContent(i.plainText(e)))},appendText:function(e){return t.is(e,String),this.act.fs.appendContent(this.act.path,i.plainText(e))},getContent:function(e){return"function"==typeof e?this.act.fs.getContentAsync(this.act.path).then(e):this.act.fs.getContent(this.act.path)},setContent:function(e){if(this.isDir())throw new Error("Cannot write to directory: "+this.path());return this.act.fs.setContentAsync(this.act.path,e)},getText:function(e){function t(e){try{return e.toPlainText()}catch(t){return e.toURL()}}if("function"==typeof e){return this.getContent(t).then(e)}return t(this.act.fs.getContent(this.act.path))},getDataURL:function(e){return"function"==typeof e?this.getContent(function(e){return e.toURL()}):this.getContent().toURL()},setDataURL:function(e){return this.setContent(i.url(e))},dataURL:function(e){return"string"==typeof e?this.setDataURL(e):"function"==typeof e?this.getDataURL(e):this.getDataURL()},isText:function(){return this.act.fs.isText(this.act.path)},contentType:function(e){return this.act.fs.getContentType(this.act.path,e)},bytes:function(e){return i.isBuffer(e)?this.setBytes(e):this.getBytes()},setBytes:function(e){return this.act.fs.setContent(this.act.path,i.bin(e,this.contentType()))},getBytes:function(e){return e=e||{},this.act.fs.getContent(this.act.path).toBin(e.binType)},getURL:function(){return this.act.fs.getURL(this.act.path)},lines:function(e){return e instanceof Array?this.text(e.join("\n")):"function"==typeof e?this.text(function(t){return e(t.replace(/\r/g,"").split("\n"))}):this.text().replace(/\r/g,"").split("\n")},obj:function(){var e=this;if(0==arguments.length){var n=e.text();return n?JSON.parse(n):null}e.text(JSON.stringify(t.is(arguments[0],Object)))},copyFrom:function(e,t){return e.copyTo(this,t)},copyTo:function(e,n){t(e&&e.isSFile(),e+" is not a file");var r=this,n=n||{},i=r.isDir(),o=e.isDir();if(!i&&o&&(e=e.rel(r.name()),t(!e.isDir(),e+" is a directory."),o=!1),!i||o){if(i||o)return t(i&&o,"Both src and dst should be dir"),r.each(function(t){var r,i=e.rel(t.name());return n.progress&&(r=n.progress(i,{src:t,dst:i})),s.resolve(r).then(function(){return i.copyFrom(t,n)})});n.echo&&n.echo(r+" -> "+e);var a=this.act.fs.cp(this.act.path,e.getResolvedLinkPath(),n);return a=s.resolve(a),n.a?a.then(function(){return e.setMetaInfo(r.getMetaInfo())}):a}this.err("Cannot move dir "+r.path()+" to file "+e.path())},moveFrom:function(e,t){var n=this;return n.exists(function(r){return n.copyFrom(e,t).then(function(){return e.rm({recursive:!0})},function(e){if(!r)return n.exists(function(e){return e?n.rm({recursive:!0}):void 0}).then(function(){throw e});throw e})})},moveTo:function(e,t){return e.moveFrom(this,t)},assertDir:function(){return t.is(this.path(),n.Dir),this},each:function(e,t){var n=this.assertDir();return n.listFilesAsync(t).then(function(t){return s.each(t,e)})},eachrev:function(e,t){var n=this.assertDir();return n.listFilesAsync(t).then(function(t){return s.each(t.reverse(),e)})},recursive:function(e,t){var n=this.assertDir();return t=n.convertOptions(t),n.each(function(n){return n.isDir()?n.recursive(e,t):e(n)},t)},listFilesAsync:function(e){t(null==e||"object"==typeof e);{var n,r=this.assertDir();this.path()}return e=r.convertOptions(e),n||(n=e.order),this.act.fs.opendirAsync(this.act.path,e).then(function(t){for(var i=[],o=0;o<t.length;o++){var a=t[o],s=r.rel(a);e.excludesF(s)||i.push(s)}return"function"==typeof n&&i.sort&&i.sort(n),i})},listFiles:function(){var e=Array.prototype.slice.call(arguments);return s.assertResolved(this.listFilesAsync.apply(this,e))},ls:function(e){t(null==e||"object"==typeof e);var n=this.assertDir();if(!e)return this.act.fs.opendir(this.act.path,e);var r=n.listFiles(e);return r.map(function(e){return e.name()})},convertOptions:function(e){var i=r.extend({},e),o=(this.assertDir(),this.path()),a=i.excludes||{};if("function"==typeof a)i.excludesF=a;else if("object"==typeof a){if(a instanceof Array){var s={};a.forEach(function(e){n.startsWith(e,"/")?s[e]=1:s[o+e]=1}),a=s}i.excludesF=function(e){return a[e.path()]}}return t.is(i,{excludesF:Function})},mkdir:function(){return this.touch()},link:function(e,t){if(this.exists())throw new Error(this.path()+": exists.");return this.act.fs.link(this.act.path,e.path(),t)},resolveLink:function(){return this._resolve(this.act.path)},isLink:function(){return this.fs.isLink(this.path())},getResolvedLinkPath:function(){return this.act.path},getFS:function(){return this.act.fs},observe:function(e){return this.getFS().getRootFS().addObserver(this.path(),e)},getBlob:function(){return new Blob([this.bytes()],{type:this.contentType()})},setBlob:function(e){var t=this;return s.promise(function(n){var r=new FileReader;r.addEventListener("loadend",function(){s.resolve(t.setBytes(r.result)).then(n)}),r.readAsArrayBuffer(e)})},download:function(){if(this.isDir())throw new Error(this+": Download dir is not support yet. Use 'zip' instead.");a(this.getBlob(),this.name())},err:function(){var e=Array.prototype.slice.call(arguments);throw console.log.apply(console,e),new Error(e.join(""))},exportAsObject:function(e){var t=this,n={};this.recursive(function(e){n[e.relPath(t)]=e.text()},e);var r={base:t.path(),data:n};return r},importFromObject:function(e){"string"==typeof e&&(e=JSON.parse(e));var e=e.data;for(var t in e)this.rel(t).text(e[t])}},Object.defineProperty(u.prototype,"act",{get:function(){return this._act?this._act:(this._act={},this._act.path=this.fs.resolveLink(this._path),this._act.fs=this.rootFS.resolveFS(this._act.path),t.is(this._act,{fs:o,path:n.Absolute}),this._act)}}),u}),e("RootFS",["assert","FSClass","PathUtil","SFile"],function(e,t,n,r){var i=function(n){e.is(n,t),this.mount(null,n)},o=i.prototype,a={err:function(e,t){throw new Error(e+": "+t)},fstab:function(){return this._fstab=this._fstab||[]},unmount:function(t){e.is(arguments,[n.AbsDir]);var r=this.fstab();console.log(r);for(var i=0;i<r.length;i++)if(r[i].mountPoint==t)return r.splice(i,1),!0;return!1},availFSTypes:function(){return t.availFSTypes()},mount:function(n,r,i){if("string"==typeof r){var o=e(t.availFSTypes()[r],"fstype "+r+" is undefined.");r=o(n,i||{})}e.is(r,t),r.mounted(this,n),this.fstab().unshift(r)},resolveFS:function(r){e.is(r,n.Absolute);var i;return this.fstab().forEach(function(e){i||e.inMyFS(r)&&(i=e)}),i||this.err(r,"Cannot resolve"),e.is(i,t)},get:function(t){return e.is(t,n.Absolute),new r(this.resolveFS(t),t)},addObserver:function(){this.observers=this.observers||[];var t,n;if(2==arguments.length)t=arguments[0],n=arguments[1];else{if(1!=arguments.length)throw new Error("Invalid argument spec");t="",n=arguments[0]}e.is(t,String),e.is(n,Function);var r=this.observers,i={path:t,handler:n,remove:function(){var e=r.indexOf(this);r.splice(e,1)}};return this.observers.push(i),i},notifyChanged:function(e,t){this.observers&&this.observers.forEach(function(r){n.startsWith(e,r.path)&&r.handler(e,t)})},getRootFS:function(){return this}};for(var s in a)o[s]=a[s];return i}),e("zip",["SFile","FileSaver.min","Util","DeferredUtil"],function(e,t,n,r){var i={};return i.setJSZip=function(e){i.JSZip=e,r.external.Promise||(r.external.Promise=e.external.Promise)},"undefined"!=typeof JSZip&&i.setJSZip(JSZip),i.zip=function(t,n,o){function s(e,t){return t.each(function(t){var n=r.resolve();return o.progress&&(n=o.progress(t)),n.then(function(){if(t.isDir()){var n=e.folder(t.name().replace(/[\/\\]$/,""));return s(n,t)}return t.getContent(function(n){e.file(t.name(),n.toArrayBuffer())})})})}e.is(n)||(o=n),o=o||{};var u=new i.JSZip;return s(u,t).then(function(){return r.resolve(u.generateAsync({type:"arraybuffer",compression:"DEFLATE"}))}).then(function(r){return e.is(n)?n.setBytes(r):void a(new Blob([r],{type:"application/zip"}),t.name().replace(/[\/\\]$/,"")+".zip")})},i.unzip=function(t,n,o){var a,s={};o=o||{},e.is(t)&&(a=t.getContent(),t=a.toArrayBuffer()),o.onCheckFile||(o.onCheckFile=function(e){return o.overwrite?e:e.exists()?!1:e});var u=new i.JSZip;return r.resolve(u.loadAsync(t)).then(function(){return r.each(u.files,function(t,i){var a,u;return r.resolve(i.async("arraybuffer")).then(function(e){return a=e,u=n.rel(i.name),o.progress?r.resolve(o.progress(u)):void 0}).then(function(){if(console.log("Inflating",i.name),!u.isDir()){var t={file:u,status:"uploaded"};s[u.path()]=t;var n=FS.Content.bin(a,u.contentType()),r=o.onCheckFile(u,n);return r===!1&&(t.status="cancelled",u=null),e.is(r)&&(u.path()!==r.path()&&(t.redirectedTo=r),u=r),u?u.setContent(n):void 0}})})}).then(function(){return console.log("unzip done",s),s})},i}),e("FS",["FSClass","NativeFS","LSFS","WebFS","PathUtil","Env","assert","SFile","RootFS","Content","zip","DeferredUtil"],function(e,t,n,r,i,o,a,s,u,c,l,f){var p={};p.assert=a,p.Content=c,p.Class=e,p.DeferredUtil=f,p.Env=o,p.LSFS=n,p.NativeFS=t,p.PathUtil=i,p.RootFS=u,p.SFile=s,p.WebFS=r,p.zip=l,"object"==typeof window&&(window.FS=p);var h,d=new o({});return p.addFSType=e.addFSType,p.availFSTypes=e.availFSTypes,p.setEnvProvider=function(e){d=e},p.getEnvProvider=function(){return d},p.setEnv=function(e,t){if("object"==typeof e)for(var n in e)d.set(n,e[n]);else d.set(e,t)},p.getEnv=function(e){return"string"==typeof e?d.get(e):d.value},p.init=function(e){h||(e||("object"==typeof process?e=new t:"object"==typeof localStorage?e=new n(localStorage):"function"==typeof importScripts&&(self.addEventListener("message",function(e){var t=e.data;switch("string"==typeof t&&(t=JSON.parse(t)),t.type){case"upload":p.get(t.base).importFromObject(t.data);break;case"observe":h.observe(t.path,function(e,t){self.postMessage(JSON.stringify({type:"changed",path:e,content:p.get(e).text(),meta:t}))})}}),e=n.ramDisk())),h=new u(e))},p.getRootFS=function(){return p.init(),h},p.get=function(){return p.init(),h.get.apply(h,arguments)},p.expandPath=function(){return d.expandPath.apply(d,arguments)},p.resolve=function(e,t){return p.init(),s.is(e)?e:(e=d.expandPath(e),t&&!i.isAbsolutePath(e)?(t=d.expandPath(t),p.get(t).rel(e)):p.get(e))},p.mount=function(){return p.init(),h.mount.apply(h,arguments)},p.unmount=function(){return p.init(),h.unmount.apply(h,arguments)},p.isFile=function(e){return s.is(e)},p});var s;return t(["FS"],function(e){s=e}),void 0===window.FS&&(window.FS=s),s}),requireSimulator.setName("assert"),define(["FS"],function(e){return e.assert}),requireSimulator.setName("DeferredUtil"),define(["FS"],function(e){return e.DeferredUtil}),requireSimulator.setName("Klass"),define(["assert"],function(e){function t(e){var t=/function[^\(]*\(([^\)]*)\)/,n=t.exec(e+"");return n?n[1].replace(/\s/g,"").split(","):[]}function n(e){if("object"!=typeof e)return!1;if(!e)return!1;var t={configurable:1,enumerable:1,value:1,writable:1,get:1,set:1},n=0;for(var r in e){if(!t[r])return!1;n+=t[r]}return n}var r={};return r.define=function(i){function o(t){i.$fields&&e.is(t,i.$fields)}function a(e){if(!f)return e;var n=t(e);return n[0]!==f?e:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(d),e.apply(d,t)}}function s(e){if(!l)return e;if(n(e)){for(var r in e)e[r]=s(e[r]);return e}if("function"!=typeof e)return e;var i=t(e);return i[0]!==l?e:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),e.apply(this,t)}}var u,c;i.$parent?(c=i.$parent,u=Object.create(c.prototype),u.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return c.prototype[t].apply(this,e)}):u={};var l,f;i.$this&&(l=i.$this),i.$singleton&&(f=i.$singleton);var p,h=s(i.$)||function(e){if(e&&"object"==typeof e)for(var t in e)this[t]=e[t]};h instanceof Array&&(p=h,h=function(){for(var e=Array.prototype.slice.call(arguments),t=0;t<p.length;t++)e.length>0&&(this[p[t]]=e.shift())});var d;d=function(){if(!(this instanceof d)){var e=Object.create(u);return h.apply(e,arguments),o(e),e}h.apply(this,arguments),o(this)},c&&(d.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift();return c.prototype[n].apply(t,e)}),d.inherit=function(e){return e.$parent=d,r.define(e)},d.prototype=u;for(var m in i)"$"!=m[0]&&("static$"==m.substring(0,7)?d[m.substring(7)]=a(i[m]):n(i[m])?Object.defineProperty(u,m,s(i[m])):u[m]=s(i[m]));return u.$=h,Object.defineProperty(u,"$bind",{get:function(){return this.__bounded||(this.__bounded=new r.Binder(this)),this.__bounded}}),d},r.Function=function(){throw new Exception("Abstract")},r.opt=e.opt,r.Binder=r.define({$this:"t",$:function(e,t){for(var n in t)(function(n){"function"==typeof t[n]&&(e[n]=function(){var e=Array.prototype.slice.call(arguments);return t[n].apply(t,e)})})(n)}}),r}),requireSimulator.setName("Tonyu.Thread"),define(["DeferredUtil","Klass"],function(e,t){var n={enterC:{},exitC:0},r=1;try{window.cnts=n}catch(i){}var o=t.define({$:function(){this.frame=null,this._isDead=!1,this.cnt=0,this._isWaiting=!1,this.fSuspended=!1,this.tryStack=[],this.preemptionTime=60,this.onEndHandlers=[],this.onTerminateHandlers=[],this.id=r++,this.age=0},isAlive:function(){return!this.isDead()},isDead:function(){return this._isDead=this._isDead||null==this.frame||this._threadGroup&&(this._threadGroup.objectPoolAge!=this.tGrpObjectPoolAge||this._threadGroup.isDeadThreadGroup())},setThreadGroup:function(e){this._threadGroup=e,this.tGrpObjectPoolAge=e.objectPoolAge},isWaiting:function(){return this._isWaiting},suspend:function(){this.fSuspended=!0,this.cnt=0},enter:function(e){this.frame={prev:this.frame,func:e}},apply:function(e,t,n){n||(n=[]);var r;if("string"==typeof t&&(r=e["fiber$"+t],!r))throw new Error("メソッド"+t+"が見つかりません");if("function"==typeof t&&(r=t.fiber,!r)){var i=t.methodInfo?t.methodInfo.name:t.name;throw new Error("メソッド"+i+"は待機可能メソッドではありません")}n=[this].concat(n);var o=0;return this.enter(function(t){switch(o){case 0:r.apply(e,n),o=1;break;case 1:t.termStatus="success",t.notifyEnd(t.retVal),n[0].exit(),o=2}})},notifyEnd:function(e){this.onEndHandlers.forEach(function(t){t(e)}),this.notifyTermination({status:"success",value:e})},notifyTermination:function(e){this.onTerminateHandlers.forEach(function(t){t(e)
})},on:function(e,t){("end"===e||"success"===e)&&this.onEndHandlers.push(t),"terminate"===e&&(this.onTerminateHandlers.push(t),this.handleEx&&delete this.handleEx)},promise:function(){var t=this;return e.funcPromise(function(e,n){t.on("terminate",function(t){"success"===t.status?e(t.value):n("exception"===t.status?t.exception:new Error(t.status))})})},then:function(e,t){return t?this.proimse().then(e,t):this.proimse().then(e)},fail:function(e){return this.promise().fail(e)},gotoCatch:function(e){var t=this;if(0==t.tryStack.length)return t.termStatus="exception",t.kill(),void(t.handleEx?t.handleEx(e):t.notifyTermination({status:"exception",exception:e}));t.lastEx=e;for(var n=t.tryStack.pop();t.frame;){if(n.frame===t.frame){t.catchPC=n.catchPC;break}t.frame=t.frame.prev}},startCatch:function(){var e=this,t=e.lastEx;return e.lastEx=null,t},exit:function(e){this.frame=this.frame?this.frame.prev:null,this.retVal=e},enterTry:function(e){var t=this;t.tryStack.push({frame:t.frame,catchPC:e})},exitTry:function(){var e=this;e.tryStack.pop()},waitEvent:function(e,t){var n=this;if(n.suspend(),e.on){var r;t=t.concat(function(){n.lastEvent=arguments,n.retVal=arguments[0],r.remove(),n.steps()}),r=e.on.apply(e,t)}},runAsync:function(e){var t=this,n=function(){t.retVal=arguments,t.steps()},r=function(){for(var e="",n=0;n<arguments.length;n++)e+=arguments[n]+",";0==e.length&&(e="Async fail");var r=new Error(e);r.args=arguments,t.gotoCatch(r),t.steps()};t.suspend(),setTimeout(function(){e(n,r)},0)},waitFor:function(t){var n=this;return n._isWaiting=!0,n.suspend(),t instanceof o&&(t=t.promise()),e.ensureDefer(t).then(function(e){n.retVal=e,n.stepsLoop()}).fail(function(e){n.gotoCatch(n.wrapError(e)),n.stepsLoop()})},wrapError:function(e){if(e instanceof Error)return e;var t=new Error(e);return t.original=e,t},resume:function(e){this.retVal=e,this.steps()},steps:function(){var e=this;if(!e.isDead()){var t=Tonyu.currentThread;for(Tonyu.currentThread=e,e.cnt=e.preemptionTime,e.preempted=!1,e.fSuspended=!1;e.cnt>0&&e.frame;)try{for(;e.cnt-->0&&e.frame;)e.frame.func(e);e.preempted=!e.fSuspended&&e.isAlive()}catch(n){e.gotoCatch(n)}Tonyu.currentThread=t}},stepsLoop:function(){var e=this;e.steps(),e.preempted&&setTimeout(function(){e.stepsLoop()},0)},kill:function(){var e=this;e._isDead=!0,e.frame=null,e.termStatus||(e.termStatus="killed",e.notifyTermination({status:"killed"}))},clearFrame:function(){this.frame=null,this.tryStack=[]}});return o}),requireSimulator.setName("Tonyu.Iterator"),define(["Klass"],function(e){function t(e,t){if(e.tonyuIterator)return e.tonyuIterator(t);if(e instanceof Array)return 1==t?new n(e):new r(e);if(e instanceof Object)return 1==t?new i(e):new o(e);throw console.log(e),new Error(e+" is not iterable")}var n=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.set[this.i],this.i++,!0)}}),r=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.i,this[1]=this.set[this.i],this.i++,!0)}}),i=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push(t);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i],this.i++,!0)}}),o=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push([t,e[t]]);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i][0],this[1]=this.elems[this.i][1],this.i++,!0)}});return t}),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert","Tonyu.Thread","Tonyu.Iterator","DeferredUtil"],function(e,t,n,r){return Tonyu=function(){function i(){var e=new t;return e.handleEx=s,e}function o(e){return r.funcPromise(function(t){setTimeout(t,e)})}function a(){return r.funcPromise(function(e){requestAnimationFrame(e)})}function s(e){if(!Tonyu.onRuntimeError)throw"undefined"==typeof $LASTPOS&&($LASTPOS=0),alert("エラー! at "+$LASTPOS+" メッセージ  : "+e),console.log(e.stack),e;Tonyu.onRuntimeError(e)}function u(t,n){return e.is(arguments,[String,Object]),l(klass.getMeta(t),n)}function c(e,t){return e?l(Object.create(e.prototype),t):l({},t)}function l(e,t){if(t&&"object"==typeof t)for(var n in t)e[n]=t[n];return e}function f(e,t){M[e]=t}function p(e){return M[e]}function h(e){var t=e.split("."),n=k;if(t.forEach(function(e){n&&(n=n[e])}),!n&&1==t.length){var r;for(var i in k){var o=k[i][e];if(o){if(n)throw new Error("曖昧なクラス名： "+i+"."+e+", "+r);n=o,r=i+"."+e}}}return n}function d(e,t){if("function"!=typeof t)return t;var n=function(){return t.apply(e,arguments)};return n.methodInfo=Tonyu.extend({thiz:e},t.methodInfo||{}),t.fiber&&(n.fiber=function(){return t.fiber.apply(e,arguments)},n.fiber.methodInfo=Tonyu.extend({thiz:e},t.fiber.methodInfo||{})),n}function m(e,t,n,r){if(!e)throw new Error(r+"(="+e+")のメソッド "+t+"を呼び出せません");var i=e[t];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+t+"(="+i+")はメソッドではありません");return i.apply(e,n)}function g(e,t,n){if("function"!=typeof e)throw new Error(n+"は関数ではありません");return e.apply({},t)}function v(e,t){if(e!=e||null==e)throw new Error(t+"(="+e+")は初期化されていません");return e}function y(e){for(var t=[],n=1;n<e.length;n++)t[n-1]=e[n];return t}function b(e){throw new Error("クラス名"+e+"はnewをつけて呼び出して下さい。")}function T(e){throw console.log("Not a tonyu object: ",e),new Error(e+" is not a tonyu object")}function w(e,t){return e in t}function S(e){var t=h(e);if(!t)throw new Error(e+" というクラスはありません");Tonyu.runMode=!0;var n,r=new t;(n=Tonyu.currentProject)&&(n.runningObj=r),$LASTPOS=0}function x(){var e=performance.now();if(e-D>1e3)throw A(1e4),new Error("無限ループをストップしました"+(e-P));P=e}function A(e){D=performance.now()+(e||0)}function E(e,t){return e?e instanceof t?!0:"function"==typeof e.getClassInfo&&t.meta?e.getClassInfo().includesRec[t.meta.fullName]:!1:!1}"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return Date.now()});klass=function(){throw alert("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again."),new Error("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again.")},klass.addMeta=u,klass.removeMeta=function(e){delete C[e]},klass.getMeta=function(e){if("function"==typeof e)return e.meta;if("string"==typeof e){var t=C[e];return t||(C[e]=t={}),t}},klass.ensureNamespace=function(e,t){var n,r=t.split("."),i=e;for(n=0;n<r.length;n++){var o=r[n];i[o]||(i[o]={}),i=i[o]}return i},Function.prototype.constructor=function(){throw new Error("This method should not be called")},klass.propReg=/^__([gs]et)ter__(.*)$/,klass.define=function(e){function t(e,n){if(n=n||{},n.isShim)return e;if(n.path=n.path||[],n.path.push(e),e.isShim)throw console.log("chkmeta::ctx",n),new Error("Shim found "+e.extenderFullName);if(e.superclass&&t(e.superclass,n),!e.includes)throw console.log("chkmeta::ctx",n),new Error("includes not found");return e.includes.forEach(function(e){t(e,n)}),n.path.pop(),e}function n(e,n){if(!e.prototype.hasOwnProperty("getClassInfo"))throw new Error("NO");if(!e.meta)throw console.log("metanotfound",e),new Error("meta not found");return t(e.meta,n),e}function r(e,t){var r=!t.init,i=t.includesRec;if(i[s])return e;i[s]=!0,a.forEach(function(n){e=n.extendFrom(e,l(t,{init:!1}))});var o="function"==typeof h?h(e):h;"undefined"!=typeof Profiler&&Profiler.profile(o,s);var m=o.initialize;delete o.initialize;var g;g=m?function(){this instanceof g||b(s),m.apply(this,arguments)}:e?function(){this instanceof g||b(s),e.apply(this,arguments)}:function(){this instanceof g||b(s)},g.prototype=c(e,{constructor:g}),g.meta=r?{isShim:!0,extenderFullName:s}:u(s,{fullName:s,shortName:f,namespace:p,decls:d,superclass:t.nonShimParent?t.nonShimParent.meta:null,includesRec:i,includes:a.map(function(e){return e.meta})}),g.meta.func=g,g.methods=o;var v=g.prototype,y={},T=klass.propReg;for(var w in o)if(!w.match(/^fiber\$/)){v[w]=o[w];var S="fiber$"+w;if(o[S]&&(v[S]=o[S],v[S].methodInfo=v[S].methodInfo||{name:w,klass:g,fiber:!0},v[w].fiber=v[S]),"__dummy"!==w&&!v[w])throw console.log("WHY!",v[w],v,w),new Error("WHY!"+w);v[w].methodInfo=v[w].methodInfo||{name:w,klass:g};var x=T.exec(w);x&&(y[x[2]]=y[x[2]]||{},y[x[2]][x[1]]=v[w])}v.isTonyuObject=!0;for(var w in y)Object.defineProperty(v,w,y[w]);return v.getClassInfo=function(){return g.meta},n(g,{isShim:r})}var i,o=e.superclass,a=e.includes,s=e.fullName,f=e.shortName,p=e.namespace,h=e.methods,d=e.decls,m=klass.ensureNamespace(Tonyu.classes,p),g=r(o,{init:!0,initFullName:s,includesRec:o?l({},o.meta.includesRec):{},nonShimParent:o});return g.extendFrom=r,m[f]=g,i=g,n(g,{isShim:!1})},klass.isSourceChanged=function(e){return e=e.meta||e,e.src&&e.src.tonyu?e.nodeTimestamp?e.src.tonyu.lastUpdate()>e.nodeTimestamp:!0:!1},klass.shouldCompile=function(e){if(e=e.meta||e,e.hasSemanticError)return!0;if(klass.isSourceChanged(e))return!0;for(var t=klass.getDependingClasses(e),n=0;n<t.length;n++)if(klass.shouldCompile(t[n]))return!0},klass.getDependingClasses=function(e){e=e.meta||e;var t=[];return e.superclass&&(t=[e.superclass]),e.includes&&(t=t.concat(e.includes)),t};var P,M={},k={},C={},D=performance.now();return setInterval(A,16),Tonyu={thread:i,klass:klass,bless:c,extend:l,globals:M,classes:k,classMetas:C,setGlobal:f,getGlobal:p,getClass:h,timeout:o,animationFrame:a,bindFunc:d,not_a_tonyu_object:T,is:E,hasKey:w,invokeMethod:m,callFunc:g,checkNonNull:v,run:S,iterator:n,checkLoop:x,resetLoopCheck:A,DeferredUtil:r,VERSION:1550554142697,A:y}}()}),requireSimulator.setName("PathUtil"),define(["FS"],function(e){return e.PathUtil}),requireSimulator.setName("FileList"),define("FileList",[],function(){return FileList}),requireSimulator.setName("exceptionCatcher"),define([],function(){var e={};return e.f=function(t){if("function"==typeof t){if(t.isTrcf)return t;var n=function(){if(!e.handleException||e.enter)return t.apply(this,arguments);try{return e.enter=!0,t.apply(this,arguments)}catch(n){e.handleException(n)}finally{e.enter=!1}};return n.isTrcf=!0,n}if("object"==typeof t){for(var r in t)t[r]=e.f(t[r]);return t}},e}),requireSimulator.setName("UI"),define(["Util","exceptionCatcher"],function(e,t){var n={},r=t.f;return n=function(){function t(){l.forEach(function(e){e()}),setTimeout(r(t),50)}function i(e){return e instanceof Array?o(e):"string"==typeof e?s(e):e}function o(e){var t=e[0],n=1,r=$("<"+t+">");for("object"!=typeof e[n]||e[n]instanceof Array||e[n]instanceof $||(a(r,e[n],t),n++);n<e.length;)r.append(i(e[n])),n++;return r}function a(t,i){function o(e,n){if(n)if("enterkey"==e)t.on("keypress",r(function(e){13==e.which&&n.apply(t,arguments)}));else if("realtimechange"==e){var o,a=!0;l.push(function(){var e;e="checkbox"==i.type?!!t.prop("checked"):t.val(),(a||o!=e)&&(n.apply(t,[e,o]),o=e),a=!1})}else t.on(e,r(n))}i.$var&&(f[i.$var]=t),i.$edit&&("string"==typeof i.$edit&&(i.$edit={name:i.$edit,type:n.types.String}),i.on||(i.on={}),i.on.realtimechange=r(function(e){p.writeToModel(i.$edit,e,t)}),f[i.$edit.name]||(f[i.$edit.name]=t),p.push({jq:t,params:i}));for(var a in i)if("on"==a)for(var s in i.on)o(s,i.on[s]);else"css"==a&&null!=i[a]?t.css(i[a]):e.startsWith(a,"$")||null==i[a]||t.attr(a,i[a])}function s(e){return $(document.createTextNode(e))}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var l=[],f={},p=[],h=i(u);return h.$edits=p,h.$vars=f,$.data(h,"edits",p),$.data(h,"vars",f),p.load=function(e){p.model=e,p.forEach(function(e){p.writeToJq(e.params.$edit,e.jq)}),p.validator.on.validate.call(p.validator,p.model)},p.writeToJq=function(e,t){var n=p.model;if(n){for(var r=e.name,i=r.split("."),o=0;o<i.length;o++)n=n[i[o]];n=e.type.toVal(n),"checkbox"==t.attr("type")?t.prop("checked",!!n):t.val(n)}},p.validator={errors:{},show:function(){if(f.validationMessage){f.validationMessage.empty();for(var e in this.errors)f.validationMessage.append(n("div",this.errors[e].mesg))}if(f.OKButton){var t=!0;for(var e in this.errors)t=!1;f.OKButton.attr("disabled",!t)}},on:{validate:function(){}},addError:function(e,t,n){this.errors[e]={mesg:t,jq:n},this.show()},removeError:function(e){delete this.errors[e],this.show()},allOK:function(){for(var e in this.errors)delete this.errors[e];this.show()},isValid:function(){var e=!0;for(var t in this.errors)e=!1;return e}},p.writeToModel=function(e,t,n){var r=p.model;if(r){var i=e.name;try{t=e.type.fromVal(t)}catch(o){return void p.validator.addError(i,o,n)}p.validator.removeError(i);for(var a=i.split("."),s=0;s<a.length;s++)s==a.length-1?p.on.writeToModel(i,t)||(r[a[s]]=t):r=r[a[s]];p.validator.on.validate.call(p.validator,p.model)}},p.on={},p.on.writeToModel=function(){},l.length>0&&setTimeout(r(t),50),h},n.types={String:{toVal:function(e){return e},fromVal:function(e){return e}},Number:{toVal:function(e){return e+""},fromVal:function(e){return parseFloat(e)}}},n}),requireSimulator.setName("FileMenu"),define(["UI","FS","DeferredUtil"],function(e,t,n){var r=function(){var t={on:{}};return t.on.validateName=function(e){if(!e)return{ok:!1,reason:"ファイル名を入力してください"};var n=t.on.getCurDir(),r=n.rel(e);return{ok:!0,file:r}},t.on.displayName=function(e){return e.name()},t.on.close=function(){},t.on.open=function(e){"object"==typeof t.fileList&&t.fileList.select(e)},t.on.ls=function(){"object"==typeof t.fileList&&t.fileList.ls()},t.on.getCurFile=function(){if("object"==typeof t.fileList)return t.fileList.curFile();throw"on.getCurFile is missing"},t.on.getCurDir=function(){if("object"==typeof t.fileList)return t.fileList.curDir();throw"on.getCurDir is missing"},t.on.createContent=function(e){return e.text("")},t.onMenuStart=function(){},t.dialog=function(e,n,r){return t.dialogOpt({title:e,name:n,onend:r})},t.dialogOpt=function(n){var r=n.title,i=n.name||"",o=n.onend||function(){};t.d||(t.d=e(["div"],{title:r},"ファイル名を入力してください",["br"],["input",{$var:"name",on:{enterkey:function(){t.d.$vars.done()},realtimechange:function(e){t.d.$vars.chg(e)}}}],["br"],["div",{$var:"extra"}],["div",{$var:"msg"}],["button",{$var:"b",on:{click:function(){t.d.$vars.done()}}},"OK"])),t.d.attr({title:r});var a=t.d.$vars;a.name.val(i),t.d.dialog({title:r});var s=null;a.done=function(){s&&s.ok&&(o(s.file),t.d.dialog("close"))},a.chg=function(e){s=t.on.validateName(e,n),s.ok&&s.file.exists()&&(s={ok:!1,reason:e+"は存在します"}),s.ok?(a.msg.css({color:"blue"}),a.msg.text(s.note||""),a.b.removeAttr("disabled")):(a.msg.css({color:"red"}),a.msg.text(s.reason),a.b.attr("disabled",!0))},a.extra.empty(),n.extraUI&&n.extraUI(a.extra)},t.create=function(){t.onMenuStart("create"),t.dialogOpt({title:"新規作成",action:"create",onend:function(e){e.exists()||(t.on.createContent(e),t.on.ls(),t.on.open(e))}})},t.mv=function(){t.onMenuStart("mv");var e=t.on.getCurFile();if(e){var r=t.on.displayName(e);t.dialogOpt({title:"名前変更",name:r,action:"mv",extraUI:t.on.mvExtraUI,onend:function(r){return r?n.then(function(){return t.on.mv?t.on.mv(e,r):void 0}).then(function(n){if(n!==!1){var i=e.text();e.rm(),t.on.close(e),e=r,r.text(i),t.on.ls(),t.on.open(e)}}):void 0}})}},t.rm=function(){t.onMenuStart("rm");var e=t.on.getCurFile();e&&confirm(e.name()+"を削除しますか？")&&(e.rm(),t.on.ls(),t.on.close(e))},t};return r}),requireSimulator.setName("Platform"),define([],function(){var e={},t=window.navigator.userAgent.toLowerCase();return e.tablet=-1!=t.indexOf("windows")&&-1!=t.indexOf("touch")||-1!=t.indexOf("ipad")||-1!=t.indexOf("android")&&-1==t.indexOf("mobile")||-1!=t.indexOf("firefox")&&-1!=t.indexOf("tablet")||-1!=t.indexOf("kindle")||-1!=t.indexOf("silk")||-1!=t.indexOf("playbook"),e.mobile=-1!=t.indexOf("windows")&&-1!=t.indexOf("phone")||-1!=t.indexOf("iphone")||-1!=t.indexOf("ipod")||-1!=t.indexOf("android")&&-1!=t.indexOf("mobile")||-1!=t.indexOf("firefox")&&-1!=t.indexOf("mobile")||-1!=t.indexOf("blackberry"),e}),requireSimulator.setName("WebSite"),define(["FS","Platform"],function(e,t){var n,r=e.PathUtil,i=document.location.href,o=!!i.match(/html\/dev\//)&&!!i.match(/localhost:3/),a=location.protocol;switch(a.match(/^http/)||(a="https:"),window.WebSite_runType){case"IDE":return n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},n.builtinAssetNames={"images/Ball.png":1,"images/base.png":1,"images/Sample.png":1,"images/neko.png":1,"images/mapchip.png":1,"images/inputPad.png":1},n.pluginTop||(n.pluginTop=n.top+"/js/plugins"),n.sampleImg=n.top+"/images",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.mp3Disabled=n.isNW,n.tonyuHome="/Tonyu/",n.PathSep="/",n.isNW?(n.noconcat=!0,n.PathSep=require("path").sep,n.cwd=r.directorify(process.cwd().replace(/\\/g,"/")),n.tonyuHome=process.env.TONYU_HOME?r.directorify(process.env.TONYU_HOME):r.rel(n.cwd,"fs/Tonyu/"),n.logdir=process.env.TONYU_LOGDIR,n.wwwDir=r.rel(n.cwd,"www/"),n.platform=process.platform,n.ffmpeg=r.rel(n.cwd,"win32"==n.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),n.pkgInfo=require(r.rel(n.cwd,"package.json")),n.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):n.pkgInfo&&n.pkgInfo.config&&n.pkgInfo.config.prjDirs?n.pkgInfo.config.prjDirs.map(function(e){return e=r.directorify(e),r.isAbsolute(e)?e:r.rel(n.cwd,e)}):[r.rel(n.cwd,"Projects/"),r.rel(n.tonyuHome,"Projects/")],n.kernelDir=r.rel(n.wwwDir,"Kernel/")):(n.wwwDir=a+"//"+location.host+"/",n.projects=[r.rel(n.tonyuHome,"Projects/")]),n.kernelDir=r.rel(n.wwwDir,"Kernel/"),n.compiledKernel="Kernel/js/concat.js",i.match(/localhost\/tonyu2/)?(n.wwwDir=a+"//"+location.host+"/tonyu2/",n.kernelDir=n.wwwDir+"Kernel/",n.compiledKernel=n.kernelDir+"js/concat.js",n.uploadTmpUrl=a+"//localhost/tsite/tonyu/e/cgi-bin/uploadTmp.cgi",n.newVersionUrl=a+"//localhost/tsite/tonyu/project/newVersion.cgi"):(n.uploadTmpUrl=a+"//edit.tonyu.jp/cgi-bin/uploadTmp.cgi",n.newVersionUrl=a+"//www.tonyu.jp/project/newVersion.cgi"),n.version=2,n.hoge="fuga",e.setEnvProvider(new e.Env(n)),window.WebSite=n;case"singleHTML":if(n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},"object"==typeof BuiltinAssets)for(var s in BuiltinAssets)n.urlAliases[s]=BuiltinAssets[s];return n.tonyuHome="/Tonyu/",n.projects=[r.rel(n.tonyuHome,"Projects/")],n.scriptServer=i.match(/localhost\/tonyu2/)?"http://localhost/tonyu2/":"https://edit.tonyu.jp/",n.pluginTop=n.scriptServer+"js/plugins",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.PathSep="/",n.compiledKernel=n.scriptServer+"Kernel/js/concat.js",e.setEnvProvider(new e.Env(n)),window.WebSite=n;case"multiHTML":return n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},n.tonyuHome="/Tonyu/",n.pluginTop=n.top+"/js/plugins",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.PathSep="/",n.mp3Disabled=n.isNW,n.isNW&&(n.PathSep=require("path").sep,n.cwd=r.directorify(process.cwd().replace(/\\/g,"/")),n.platform=process.platform),e.setEnvProvider(new e.Env(n)),window.WebSite=n}if(i.match(/jsrun\.it/))n={urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:o,pluginTop:"https://edit.tonyu.jp/js/plugins",removeJSOutput:!0};else if(i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)||i.match(/\/html\/((dev)|(build))\//))n={urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:o};else if(i.match(/bitarrow/)||i.match(/localhost.*pub/)){n={};var u=n;n.serverType="BA",u.runtime="../../../runtime/",u.urlAliases={"images/base.png":u.runtime+"images/base.png","images/Sample.png":u.runtime+"images/Sample.png","images/neko.png":u.runtime+"images/neko.png","images/inputPad.png":u.runtime+"images/inputPad.png","images/mapchip.png":u.runtime+"images/mapchip.png","images/sound.png":u.runtime+"images/sound.png","images/sound_ogg.png":u.runtime+"images/sound_ogg.png","images/sound_mp3.png":u.runtime+"images/sound_mp3.png","images/sound_mp4.png":u.runtime+"images/sound_mp4.png","images/sound_m4a.png":u.runtime+"images/sound_m4a.png","images/sound_mid.png":u.runtime+"images/sound_mid.png","images/sound_wav.png":u.runtime+"images/sound_wav.png","images/ecl.png":u.runtime+"images/ecl.png"}}else n={urlAliases:{},top:".",devMode:o};if("object"==typeof BuiltinAssets)for(var s in BuiltinAssets)n.urlAliases[s]=BuiltinAssets[s];n.builtinAssetNames={"images/Ball.png":1,"images/base.png":1,"images/Sample.png":1,"images/neko.png":1,"images/mapchip.png":1,"images/inputPad.png":1};var c=window.navigator.userAgent.toLowerCase();return n.tablet=-1!=c.indexOf("windows")&&-1!=c.indexOf("touch")||-1!=c.indexOf("ipad")||-1!=c.indexOf("android")&&-1==c.indexOf("mobile")||-1!=c.indexOf("firefox")&&-1!=c.indexOf("tablet")||-1!=c.indexOf("kindle")||-1!=c.indexOf("silk")||-1!=c.indexOf("playbook"),n.mobile=-1!=c.indexOf("windows")&&-1!=c.indexOf("phone")||-1!=c.indexOf("iphone")||-1!=c.indexOf("ipod")||-1!=c.indexOf("android")&&-1!=c.indexOf("mobile")||-1!=c.indexOf("firefox")&&-1!=c.indexOf("mobile")||-1!=c.indexOf("blackberry"),n.pluginTop||(n.pluginTop=n.top+"/js/plugins"),n.disableROM={},(i.match(/\.appspot\.com/)||i.match(/localhost:888[87]/))&&(n.serverType="GAE"),i.match(/localhost:3000/)&&(n.serverType="Node"),n.serverTop=i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)?n.top+"/exe":n.top+"/edit",n.sampleImg=n.top+"/images",n.blobPath=n.serverTop+"/serveBlob",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.mp3Disabled=n.isNW,n.tonyuHome="/Tonyu/",n.url={getDirInfo:n.serverTop+"/getDirInfo",getFiles:n.serverTop+"/File2LSSync",putFiles:n.serverTop+"/LS2FileSync"},n.PathSep="/",n.isNW?(n.PathSep=require("path").sep,n.cwd=r.directorify(process.cwd().replace(/\\/g,"/")),n.tonyuHome=process.env.TONYU_HOME?r.directorify(process.env.TONYU_HOME):r.rel(n.cwd,"fs/Tonyu/"),n.logdir=process.env.TONYU_LOGDIR,n.wwwDir=r.rel(n.cwd,"www/"),n.platform=process.platform,n.ffmpeg=r.rel(n.cwd,"win32"==n.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),n.pkgInfo=require(r.rel(n.cwd,"package.json")),n.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):n.pkgInfo&&n.pkgInfo.config&&n.pkgInfo.config.prjDirs?n.pkgInfo.config.prjDirs.map(function(e){return e=r.directorify(e),r.isAbsolute(e)?e:r.rel(n.cwd,e)}):[r.rel(n.cwd,"Projects/"),r.rel(n.tonyuHome,"Projects/")],n.kernelDir=r.rel(n.wwwDir,"Kernel/")):(n.wwwDir=a+"//"+location.host+"/",n.projects=[r.rel(n.tonyuHome,"Projects/")]),(i.match(/edit\.tonyu\.jp/)||i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/))&&(n.kernelDir=a+"//"+location.host+"/Kernel/"),n.compiledKernel=i.match(/edit\.tonyu\.jp/)||i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/)||n.isNW?n.kernelDir+"js/concat.js":"BA"===n.serverType?n.runtime+"lib/tonyu/kernel.js":"https://edit.tonyu.jp/Kernel/js/concat.js",i.match(/localhost\/tonyu2/)?(n.wwwDir=a+"//"+location.host+"/tonyu2/",n.kernelDir=n.wwwDir+"Kernel/",n.compiledKernel=n.kernelDir+"js/concat.js",n.uploadTmpUrl=a+"//localhost/tsite/tonyu/e/cgi-bin/uploadTmp.cgi",n.newVersionUrl=a+"//localhost/tsite/tonyu/project/newVersion.cgi"):(n.uploadTmpUrl=a+"//edit.tonyu.jp/cgi-bin/uploadTmp.cgi",n.newVersionUrl=a+"//www.tonyu.jp/project/newVersion.cgi"),i.match(/((index)|(project))2/)&&(n.version=2,n.devMode=n.isNW?!0:!1),e.setEnvProvider(new e.Env(n)),window.WebSite=n}),requireSimulator.setName("Shell"),define(["FS","assert"],function(e,t){function n(t,n){var i=r(t);if(e.SFile.is(i)||console.log(i," is not file"),n&&!i.exists())throw new Error(i+": no such file or directory");return i}function r(t){if("string"!=typeof t)return t;var n=i.cwd;return o.isAbsolutePath(t)?e.resolve(t,n):n.rel(t)}var i={},o=t(e.PathUtil);return i.newCommand=function(e,t){this[e]=t},i.cd=function(e){return i.cwd=n(e,!0),i.pwd()},i.vars=Object.create(e.getEnv()),i.mount=function(t,n){if(!t||!t.t){var r=[];for(var i in e.getRootFS().availFSTypes())r.push(i);return void sh.err("-t=("+r.join("|")+") should be specified.")}e.mount(n,t.t,t)},i.unmount=function(t){e.unmount(t)},i.fstab=function(){var t=e.getRootFS(),n=t.fstab(),r=this;n.forEach(function(e){r.echo(e.fstype()+"	"+(e.mountPoint||"<Default>"))})},i.resolve=n,i.pwd=function(){return i.cwd+""},i.ls=function(e){return e=e?n(e,!0):i.cwd,e.ls()},i.cp=function(e,t,r){r||(r={}),r.v&&(i.echo("cp",e,t),r.echo=i.echo.bind(i));var o=n(e,!0),a=n(t);return o.copyTo(a,r)},i.ln=function(e,t,r){var i=n(t),o=n(e,!0);if(i.isDir()&&i.exists()&&(i=i.rel(o.name())),i.exists())throw new Error(i+" exists");return i.link(o,r)},i.rm=function(e,t){if(t||(t={}),t.notrash)return e=n(e,!1),e.removeWithoutTrash(),1;if(e=n(e,!0),e.isDir()&&t.r){var r=e,o=0;return r.each(function(e){e.exists()&&(o+=i.rm(e,t))}),r.rm(),o+1}return e.rm(),1},i.mkdir=function(e){if(e=n(e,!1),e.exists())throw new Error(e+" : exists");return e.mkdir()},i.cat=function(e){return e=n(e,!0),i.echo(e.getContent(function(t){return e.isText()?t.toPlainText():t.toURL()}))},i.resolve=function(e){return e||(e="."),e=n(e)},i.grep=function(e,t,r){function o(e,t,n){r.res&&r.res.push({file:e,lineNo:t,line:n}),i.echo(e+"("+t+"): "+n)}return t=n(t,!0),r||(r={}),r.res||(r.res=[]),t.isDir()?t.each(function(t){i.grep(e,t,r)}):"string"==typeof e&&t.lines().forEach(function(n,r){n.indexOf(e)>=0&&o(t,r+1,n)}),r.res},i.touch=function(e){return e=n(e),e.text(e.exists()?e.text():""),1},i.setout=function(e){i.outUI=e},i.echo=function(){return $.when.apply($,arguments).then(function(){console.log.apply(console,arguments),i.outUI&&i.outUI.log&&i.outUI.log.apply(i.outUI,arguments)})},i.err=function(e){console.log.apply(console,arguments),e&&e.stack&&console.log(e.stack),i.outUI&&i.outUI.err&&i.outUI.err.apply(i.outUI,arguments)},i.clone=function(){var e=Object.create(this);return e.vars=Object.create(this.vars),e},i.getvar=function(e){return this.vars[e]||process&&process.env[e]},i.get=i.getvar,i.set=function(e,t){return this.vars[e]=t},i.strcat=function(){if(1==arguments.length)return arguments[0];for(var e="",t=0;t<arguments.length;t++)e+=arguments[t];return e},i.exists=function(e){return e=this.resolve(e),e.exists()},i.dl=function(e){return e=this.resolve(e||"."),e.download()},i.zip=function(){var t=this,n=Array.prototype.slice.call(arguments).map(function(e){return"string"==typeof e?t.resolve(e):e});return e.zip.zip.apply(e.zip,n)},i.unzip=function(){var t=this,n=Array.prototype.slice.call(arguments).map(function(e){return"string"==typeof e?t.resolve(e):e});return e.zip.unzip.apply(e.zip,n)},i.prompt=function(){},i.ASYNC={r:"SH_ASYNC"},i.help=function(){for(var e in i){var t=i[e];"function"==typeof t&&i.echo(e+(t.description?" - "+t.description:""))}},window.sh||(window.sh=i),"object"==typeof process?(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()},sh.cd(process.cwd().replace(/\\/g,"/"))):sh.cd("/"),i}),requireSimulator.setName("Log"),define(["FS","WebSite","Shell"],function(e,t,n){function r(e,t){return e="00000000000000"+e,e.substring(e.length-t)}function i(e){return e.replace(/\n/g,"\n|")}var o={},a=t.logdir?e.resolve("${logdir}"):null,s=a&&a.exists();if(o.todayDir=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return a.rel(t+"/").rel(n+"/").rel(r+"/")},o.curFile=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return o.todayDir().rel(t+"-"+n+"-"+r+".log")},o.curProject=function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),i=e.getSeconds();return o.todayDir().rel("Project/").rel(r(t,2)+"_"+r(n,2)+"_"+r(i,2)+"/")},o.dumpProject=function(e){if(s){var t=o.curProject();n.cp(e,t),o.append("Dumped project to "+t.path())}},!t.logging&&!t.isNW){var u=e.get("/var/log/");u.exists()&&u.fs.storage===localStorage&&u.removeWithoutTrash({r:!0})}return o.append=function(e){if(s){var t=o.curFile(),n=t.exists()?t.text():"";t.text(n+e+"\n")}},o.d=function(e,t){o.append(new Date+": ["+e+"]"+i(t))},o.e=function(e,t){o.append(new Date+": ERROR["+e+"]"+i(t))},o}),requireSimulator.setName("showErrorPos"),define(["Log","FS"],function(e,t){return function(n,r,i){function o(){$.data(n,"opened")&&(n.dialog("close"),$.data(n,"opened",!1))}function a(){i.jump&&(i.jump(u,l,f),o())}i=i||{};var s,u,c;if(!r)return void o();var l,f;r.isTError?(s=r.mesg,u=r.src,c=r.pos,l=r.row+1,f=r.col+1):(u={name:function(){return"不明"},text:function(){return null}},c=0,s=r),"object"==typeof c&&(l=c.row,f=c.col),n.empty();var p=$("<div>").text(s+" 場所："+u.name()+("number"==typeof l?":"+l+":"+f:""));"number"==typeof l&&"number"==typeof f&&p.append($("<button>").text("エラー箇所に移動").click(a)),n.append(p),n.append($("<div>").attr("class","quickFix")),console.log("src=",u);var h=u.text();if(h&&"object"==typeof c){for(var d=0,m=h.split(/\n/),g=0;g<m.length&&g+1<c.row;g++)d+=m[g].length;d+=c.col,c=d}var v=$("<pre>");return v.append($("<span>").text(h.substring(0,c))),v.append($("<img>").attr("src",t.expandPath("${sampleImg}/ecl.png"))),v.append($("<span>").text(h.substring(c))),n.append(v),n.attr("title","エラー"),n.dialog({width:600,height:400}),$.data(n,"opened",!0),e.d("error",s+"\nat "+u+":"+r.pos+"\n"+h.substring(0,r.pos)+"##HERE##"+h.substring(r.pos)),n}}),requireSimulator.setName("source-map"),function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("source-map",[],t):"object"==typeof exports?exports.sourceMap=t():e.sourceMap=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={exports:{},id:r,loaded:!1};return e[r].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){t.SourceMapGenerator=n(1).SourceMapGenerator,t.SourceMapConsumer=n(7).SourceMapConsumer,t.SourceNode=n(10).SourceNode},function(e,t,n){function r(e){e||(e={}),this._file=o.getArg(e,"file",null),this._sourceRoot=o.getArg(e,"sourceRoot",null),this._skipValidation=o.getArg(e,"skipValidation",!1),this._sources=new a,this._names=new a,this._mappings=new s,this._sourcesContents=null}var i=n(2),o=n(4),a=n(5).ArraySet,s=n(6).MappingList;r.prototype._version=3,r.fromSourceMap=function(e){var t=e.sourceRoot,n=new r({file:e.file,sourceRoot:t});return e.eachMapping(function(e){var r={generated:{line:e.generatedLine,column:e.generatedColumn}};null!=e.source&&(r.source=e.source,null!=t&&(r.source=o.relative(t,r.source)),r.original={line:e.originalLine,column:e.originalColumn},null!=e.name&&(r.name=e.name)),n.addMapping(r)}),e.sources.forEach(function(t){var r=e.sourceContentFor(t);null!=r&&n.setSourceContent(t,r)}),n},r.prototype.addMapping=function(e){var t=o.getArg(e,"generated"),n=o.getArg(e,"original",null),r=o.getArg(e,"source",null),i=o.getArg(e,"name",null);this._skipValidation||this._validateMapping(t,n,r,i),null!=r&&(r=String(r),this._sources.has(r)||this._sources.add(r)),null!=i&&(i=String(i),this._names.has(i)||this._names.add(i)),this._mappings.add({generatedLine:t.line,generatedColumn:t.column,originalLine:null!=n&&n.line,originalColumn:null!=n&&n.column,source:r,name:i})},r.prototype.setSourceContent=function(e,t){var n=e;null!=this._sourceRoot&&(n=o.relative(this._sourceRoot,n)),null!=t?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[o.toSetString(n)]=t):this._sourcesContents&&(delete this._sourcesContents[o.toSetString(n)],0===Object.keys(this._sourcesContents).length&&(this._sourcesContents=null))
},r.prototype.applySourceMap=function(e,t,n){var r=t;if(null==t){if(null==e.file)throw new Error('SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.');r=e.file}var i=this._sourceRoot;null!=i&&(r=o.relative(i,r));var s=new a,u=new a;this._mappings.unsortedForEach(function(t){if(t.source===r&&null!=t.originalLine){var a=e.originalPositionFor({line:t.originalLine,column:t.originalColumn});null!=a.source&&(t.source=a.source,null!=n&&(t.source=o.join(n,t.source)),null!=i&&(t.source=o.relative(i,t.source)),t.originalLine=a.line,t.originalColumn=a.column,null!=a.name&&(t.name=a.name))}var c=t.source;null==c||s.has(c)||s.add(c);var l=t.name;null==l||u.has(l)||u.add(l)},this),this._sources=s,this._names=u,e.sources.forEach(function(t){var r=e.sourceContentFor(t);null!=r&&(null!=n&&(t=o.join(n,t)),null!=i&&(t=o.relative(i,t)),this.setSourceContent(t,r))},this)},r.prototype._validateMapping=function(e,t,n,r){if(!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0&&!t&&!n&&!r||e&&"line"in e&&"column"in e&&t&&"line"in t&&"column"in t&&e.line>0&&e.column>=0&&t.line>0&&t.column>=0&&n))throw new Error("Invalid mapping: "+JSON.stringify({generated:e,source:n,original:t,name:r}))},r.prototype._serializeMappings=function(){for(var e,t,n,r,a=0,s=1,u=0,c=0,l=0,f=0,p="",h=this._mappings.toArray(),d=0,m=h.length;m>d;d++){if(t=h[d],e="",t.generatedLine!==s)for(a=0;t.generatedLine!==s;)e+=";",s++;else if(d>0){if(!o.compareByGeneratedPositionsInflated(t,h[d-1]))continue;e+=","}e+=i.encode(t.generatedColumn-a),a=t.generatedColumn,null!=t.source&&(r=this._sources.indexOf(t.source),e+=i.encode(r-f),f=r,e+=i.encode(t.originalLine-1-c),c=t.originalLine-1,e+=i.encode(t.originalColumn-u),u=t.originalColumn,null!=t.name&&(n=this._names.indexOf(t.name),e+=i.encode(n-l),l=n)),p+=e}return p},r.prototype._generateSourcesContent=function(e,t){return e.map(function(e){if(!this._sourcesContents)return null;null!=t&&(e=o.relative(t,e));var n=o.toSetString(e);return Object.prototype.hasOwnProperty.call(this._sourcesContents,n)?this._sourcesContents[n]:null},this)},r.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return null!=this._file&&(e.file=this._file),null!=this._sourceRoot&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e},r.prototype.toString=function(){return JSON.stringify(this.toJSON())},t.SourceMapGenerator=r},function(e,t,n){function r(e){return 0>e?(-e<<1)+1:(e<<1)+0}function i(e){var t=1===(1&e),n=e>>1;return t?-n:n}var o=n(3),a=5,s=1<<a,u=s-1,c=s;t.encode=function(e){var t,n="",i=r(e);do t=i&u,i>>>=a,i>0&&(t|=c),n+=o.encode(t);while(i>0);return n},t.decode=function(e,t,n){var r,s,l=e.length,f=0,p=0;do{if(t>=l)throw new Error("Expected more digits in base 64 VLQ value.");if(s=o.decode(e.charCodeAt(t++)),-1===s)throw new Error("Invalid base64 digit: "+e.charAt(t-1));r=!!(s&c),s&=u,f+=s<<p,p+=a}while(r);n.value=i(f),n.rest=t}},function(e,t){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("");t.encode=function(e){if(e>=0&&e<n.length)return n[e];throw new TypeError("Must be between 0 and 63: "+e)},t.decode=function(e){var t=65,n=90,r=97,i=122,o=48,a=57,s=43,u=47,c=26,l=52;return e>=t&&n>=e?e-t:e>=r&&i>=e?e-r+c:e>=o&&a>=e?e-o+l:e==s?62:e==u?63:-1}},function(e,t){function n(e,t,n){if(t in e)return e[t];if(3===arguments.length)return n;throw new Error('"'+t+'" is a required argument.')}function r(e){var t=e.match(g);return t?{scheme:t[1],auth:t[2],host:t[3],port:t[4],path:t[5]}:null}function i(e){var t="";return e.scheme&&(t+=e.scheme+":"),t+="//",e.auth&&(t+=e.auth+"@"),e.host&&(t+=e.host),e.port&&(t+=":"+e.port),e.path&&(t+=e.path),t}function o(e){var n=e,o=r(e);if(o){if(!o.path)return e;n=o.path}for(var a,s=t.isAbsolute(n),u=n.split(/\/+/),c=0,l=u.length-1;l>=0;l--)a=u[l],"."===a?u.splice(l,1):".."===a?c++:c>0&&(""===a?(u.splice(l+1,c),c=0):(u.splice(l,2),c--));return n=u.join("/"),""===n&&(n=s?"/":"."),o?(o.path=n,i(o)):n}function a(e,t){""===e&&(e="."),""===t&&(t=".");var n=r(t),a=r(e);if(a&&(e=a.path||"/"),n&&!n.scheme)return a&&(n.scheme=a.scheme),i(n);if(n||t.match(v))return t;if(a&&!a.host&&!a.path)return a.host=t,i(a);var s="/"===t.charAt(0)?t:o(e.replace(/\/+$/,"")+"/"+t);return a?(a.path=s,i(a)):s}function s(e,t){""===e&&(e="."),e=e.replace(/\/$/,"");for(var n=0;0!==t.indexOf(e+"/");){var r=e.lastIndexOf("/");if(0>r)return t;if(e=e.slice(0,r),e.match(/^([^\/]+:\/)?\/*$/))return t;++n}return Array(n+1).join("../")+t.substr(e.length+1)}function u(e){return e}function c(e){return f(e)?"$"+e:e}function l(e){return f(e)?e.slice(1):e}function f(e){if(!e)return!1;var t=e.length;if(9>t)return!1;if(95!==e.charCodeAt(t-1)||95!==e.charCodeAt(t-2)||111!==e.charCodeAt(t-3)||116!==e.charCodeAt(t-4)||111!==e.charCodeAt(t-5)||114!==e.charCodeAt(t-6)||112!==e.charCodeAt(t-7)||95!==e.charCodeAt(t-8)||95!==e.charCodeAt(t-9))return!1;for(var n=t-10;n>=0;n--)if(36!==e.charCodeAt(n))return!1;return!0}function p(e,t,n){var r=e.source-t.source;return 0!==r?r:(r=e.originalLine-t.originalLine,0!==r?r:(r=e.originalColumn-t.originalColumn,0!==r||n?r:(r=e.generatedColumn-t.generatedColumn,0!==r?r:(r=e.generatedLine-t.generatedLine,0!==r?r:e.name-t.name))))}function h(e,t,n){var r=e.generatedLine-t.generatedLine;return 0!==r?r:(r=e.generatedColumn-t.generatedColumn,0!==r||n?r:(r=e.source-t.source,0!==r?r:(r=e.originalLine-t.originalLine,0!==r?r:(r=e.originalColumn-t.originalColumn,0!==r?r:e.name-t.name))))}function d(e,t){return e===t?0:e>t?1:-1}function m(e,t){var n=e.generatedLine-t.generatedLine;return 0!==n?n:(n=e.generatedColumn-t.generatedColumn,0!==n?n:(n=d(e.source,t.source),0!==n?n:(n=e.originalLine-t.originalLine,0!==n?n:(n=e.originalColumn-t.originalColumn,0!==n?n:d(e.name,t.name)))))}t.getArg=n;var g=/^(?:([\w+\-.]+):)?\/\/(?:(\w+:\w+)@)?([\w.]*)(?::(\d+))?(\S*)$/,v=/^data:.+\,.+$/;t.urlParse=r,t.urlGenerate=i,t.normalize=o,t.join=a,t.isAbsolute=function(e){return"/"===e.charAt(0)||!!e.match(g)},t.relative=s;var y=function(){var e=Object.create(null);return!("__proto__"in e)}();t.toSetString=y?u:c,t.fromSetString=y?u:l,t.compareByOriginalPositions=p,t.compareByGeneratedPositionsDeflated=h,t.compareByGeneratedPositionsInflated=m},function(e,t,n){function r(){this._array=[],this._set=Object.create(null)}var i=n(4),o=Object.prototype.hasOwnProperty;r.fromArray=function(e,t){for(var n=new r,i=0,o=e.length;o>i;i++)n.add(e[i],t);return n},r.prototype.size=function(){return Object.getOwnPropertyNames(this._set).length},r.prototype.add=function(e,t){var n=i.toSetString(e),r=o.call(this._set,n),a=this._array.length;(!r||t)&&this._array.push(e),r||(this._set[n]=a)},r.prototype.has=function(e){var t=i.toSetString(e);return o.call(this._set,t)},r.prototype.indexOf=function(e){var t=i.toSetString(e);if(o.call(this._set,t))return this._set[t];throw new Error('"'+e+'" is not in the set.')},r.prototype.at=function(e){if(e>=0&&e<this._array.length)return this._array[e];throw new Error("No element indexed by "+e)},r.prototype.toArray=function(){return this._array.slice()},t.ArraySet=r},function(e,t,n){function r(e,t){var n=e.generatedLine,r=t.generatedLine,i=e.generatedColumn,a=t.generatedColumn;return r>n||r==n&&a>=i||o.compareByGeneratedPositionsInflated(e,t)<=0}function i(){this._array=[],this._sorted=!0,this._last={generatedLine:-1,generatedColumn:0}}var o=n(4);i.prototype.unsortedForEach=function(e,t){this._array.forEach(e,t)},i.prototype.add=function(e){r(this._last,e)?(this._last=e,this._array.push(e)):(this._sorted=!1,this._array.push(e))},i.prototype.toArray=function(){return this._sorted||(this._array.sort(o.compareByGeneratedPositionsInflated),this._sorted=!0),this._array},t.MappingList=i},function(e,t,n){function r(e){var t=e;return"string"==typeof e&&(t=JSON.parse(e.replace(/^\)\]\}'/,""))),null!=t.sections?new a(t):new i(t)}function i(e){var t=e;"string"==typeof e&&(t=JSON.parse(e.replace(/^\)\]\}'/,"")));var n=s.getArg(t,"version"),r=s.getArg(t,"sources"),i=s.getArg(t,"names",[]),o=s.getArg(t,"sourceRoot",null),a=s.getArg(t,"sourcesContent",null),u=s.getArg(t,"mappings"),l=s.getArg(t,"file",null);if(n!=this._version)throw new Error("Unsupported version: "+n);r=r.map(String).map(s.normalize).map(function(e){return o&&s.isAbsolute(o)&&s.isAbsolute(e)?s.relative(o,e):e}),this._names=c.fromArray(i.map(String),!0),this._sources=c.fromArray(r,!0),this.sourceRoot=o,this.sourcesContent=a,this._mappings=u,this.file=l}function o(){this.generatedLine=0,this.generatedColumn=0,this.source=null,this.originalLine=null,this.originalColumn=null,this.name=null}function a(e){var t=e;"string"==typeof e&&(t=JSON.parse(e.replace(/^\)\]\}'/,"")));var n=s.getArg(t,"version"),i=s.getArg(t,"sections");if(n!=this._version)throw new Error("Unsupported version: "+n);this._sources=new c,this._names=new c;var o={line:-1,column:0};this._sections=i.map(function(e){if(e.url)throw new Error("Support for url field in sections not implemented.");var t=s.getArg(e,"offset"),n=s.getArg(t,"line"),i=s.getArg(t,"column");if(n<o.line||n===o.line&&i<o.column)throw new Error("Section offsets must be ordered and non-overlapping.");return o=t,{generatedOffset:{generatedLine:n+1,generatedColumn:i+1},consumer:new r(s.getArg(e,"map"))}})}var s=n(4),u=n(8),c=n(5).ArraySet,l=n(2),f=n(9).quickSort;r.fromSourceMap=function(e){return i.fromSourceMap(e)},r.prototype._version=3,r.prototype.__generatedMappings=null,Object.defineProperty(r.prototype,"_generatedMappings",{get:function(){return this.__generatedMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__generatedMappings}}),r.prototype.__originalMappings=null,Object.defineProperty(r.prototype,"_originalMappings",{get:function(){return this.__originalMappings||this._parseMappings(this._mappings,this.sourceRoot),this.__originalMappings}}),r.prototype._charIsMappingSeparator=function(e,t){var n=e.charAt(t);return";"===n||","===n},r.prototype._parseMappings=function(){throw new Error("Subclasses must implement _parseMappings")},r.GENERATED_ORDER=1,r.ORIGINAL_ORDER=2,r.GREATEST_LOWER_BOUND=1,r.LEAST_UPPER_BOUND=2,r.prototype.eachMapping=function(e,t,n){var i,o=t||null,a=n||r.GENERATED_ORDER;switch(a){case r.GENERATED_ORDER:i=this._generatedMappings;break;case r.ORIGINAL_ORDER:i=this._originalMappings;break;default:throw new Error("Unknown order of iteration.")}var u=this.sourceRoot;i.map(function(e){var t=null===e.source?null:this._sources.at(e.source);return null!=t&&null!=u&&(t=s.join(u,t)),{source:t,generatedLine:e.generatedLine,generatedColumn:e.generatedColumn,originalLine:e.originalLine,originalColumn:e.originalColumn,name:null===e.name?null:this._names.at(e.name)}},this).forEach(e,o)},r.prototype.allGeneratedPositionsFor=function(e){var t=s.getArg(e,"line"),n={source:s.getArg(e,"source"),originalLine:t,originalColumn:s.getArg(e,"column",0)};if(null!=this.sourceRoot&&(n.source=s.relative(this.sourceRoot,n.source)),!this._sources.has(n.source))return[];n.source=this._sources.indexOf(n.source);var r=[],i=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",s.compareByOriginalPositions,u.LEAST_UPPER_BOUND);if(i>=0){var o=this._originalMappings[i];if(void 0===e.column)for(var a=o.originalLine;o&&o.originalLine===a;)r.push({line:s.getArg(o,"generatedLine",null),column:s.getArg(o,"generatedColumn",null),lastColumn:s.getArg(o,"lastGeneratedColumn",null)}),o=this._originalMappings[++i];else for(var c=o.originalColumn;o&&o.originalLine===t&&o.originalColumn==c;)r.push({line:s.getArg(o,"generatedLine",null),column:s.getArg(o,"generatedColumn",null),lastColumn:s.getArg(o,"lastGeneratedColumn",null)}),o=this._originalMappings[++i]}return r},t.SourceMapConsumer=r,i.prototype=Object.create(r.prototype),i.prototype.consumer=r,i.fromSourceMap=function(e){var t=Object.create(i.prototype),n=t._names=c.fromArray(e._names.toArray(),!0),r=t._sources=c.fromArray(e._sources.toArray(),!0);t.sourceRoot=e._sourceRoot,t.sourcesContent=e._generateSourcesContent(t._sources.toArray(),t.sourceRoot),t.file=e._file;for(var a=e._mappings.toArray().slice(),u=t.__generatedMappings=[],l=t.__originalMappings=[],p=0,h=a.length;h>p;p++){var d=a[p],m=new o;m.generatedLine=d.generatedLine,m.generatedColumn=d.generatedColumn,d.source&&(m.source=r.indexOf(d.source),m.originalLine=d.originalLine,m.originalColumn=d.originalColumn,d.name&&(m.name=n.indexOf(d.name)),l.push(m)),u.push(m)}return f(t.__originalMappings,s.compareByOriginalPositions),t},i.prototype._version=3,Object.defineProperty(i.prototype,"sources",{get:function(){return this._sources.toArray().map(function(e){return null!=this.sourceRoot?s.join(this.sourceRoot,e):e},this)}}),i.prototype._parseMappings=function(e){for(var t,n,r,i,a,u=1,c=0,p=0,h=0,d=0,m=0,g=e.length,v=0,y={},b={},T=[],w=[];g>v;)if(";"===e.charAt(v))u++,v++,c=0;else if(","===e.charAt(v))v++;else{for(t=new o,t.generatedLine=u,i=v;g>i&&!this._charIsMappingSeparator(e,i);i++);if(n=e.slice(v,i),r=y[n])v+=n.length;else{for(r=[];i>v;)l.decode(e,v,b),a=b.value,v=b.rest,r.push(a);if(2===r.length)throw new Error("Found a source, but no line and column");if(3===r.length)throw new Error("Found a source and line, but no column");y[n]=r}t.generatedColumn=c+r[0],c=t.generatedColumn,r.length>1&&(t.source=d+r[1],d+=r[1],t.originalLine=p+r[2],p=t.originalLine,t.originalLine+=1,t.originalColumn=h+r[3],h=t.originalColumn,r.length>4&&(t.name=m+r[4],m+=r[4])),w.push(t),"number"==typeof t.originalLine&&T.push(t)}f(w,s.compareByGeneratedPositionsDeflated),this.__generatedMappings=w,f(T,s.compareByOriginalPositions),this.__originalMappings=T},i.prototype._findMapping=function(e,t,n,r,i,o){if(e[n]<=0)throw new TypeError("Line must be greater than or equal to 1, got "+e[n]);if(e[r]<0)throw new TypeError("Column must be greater than or equal to 0, got "+e[r]);return u.search(e,t,i,o)},i.prototype.computeColumnSpans=function(){for(var e=0;e<this._generatedMappings.length;++e){var t=this._generatedMappings[e];if(e+1<this._generatedMappings.length){var n=this._generatedMappings[e+1];if(t.generatedLine===n.generatedLine){t.lastGeneratedColumn=n.generatedColumn-1;continue}}t.lastGeneratedColumn=1/0}},i.prototype.originalPositionFor=function(e){var t={generatedLine:s.getArg(e,"line"),generatedColumn:s.getArg(e,"column")},n=this._findMapping(t,this._generatedMappings,"generatedLine","generatedColumn",s.compareByGeneratedPositionsDeflated,s.getArg(e,"bias",r.GREATEST_LOWER_BOUND));if(n>=0){var i=this._generatedMappings[n];if(i.generatedLine===t.generatedLine){var o=s.getArg(i,"source",null);null!==o&&(o=this._sources.at(o),null!=this.sourceRoot&&(o=s.join(this.sourceRoot,o)));var a=s.getArg(i,"name",null);return null!==a&&(a=this._names.at(a)),{source:o,line:s.getArg(i,"originalLine",null),column:s.getArg(i,"originalColumn",null),name:a}}}return{source:null,line:null,column:null,name:null}},i.prototype.hasContentsOfAllSources=function(){return this.sourcesContent?this.sourcesContent.length>=this._sources.size()&&!this.sourcesContent.some(function(e){return null==e}):!1},i.prototype.sourceContentFor=function(e,t){if(!this.sourcesContent)return null;if(null!=this.sourceRoot&&(e=s.relative(this.sourceRoot,e)),this._sources.has(e))return this.sourcesContent[this._sources.indexOf(e)];var n;if(null!=this.sourceRoot&&(n=s.urlParse(this.sourceRoot))){var r=e.replace(/^file:\/\//,"");if("file"==n.scheme&&this._sources.has(r))return this.sourcesContent[this._sources.indexOf(r)];if((!n.path||"/"==n.path)&&this._sources.has("/"+e))return this.sourcesContent[this._sources.indexOf("/"+e)]}if(t)return null;throw new Error('"'+e+'" is not in the SourceMap.')},i.prototype.generatedPositionFor=function(e){var t=s.getArg(e,"source");if(null!=this.sourceRoot&&(t=s.relative(this.sourceRoot,t)),!this._sources.has(t))return{line:null,column:null,lastColumn:null};t=this._sources.indexOf(t);var n={source:t,originalLine:s.getArg(e,"line"),originalColumn:s.getArg(e,"column")},i=this._findMapping(n,this._originalMappings,"originalLine","originalColumn",s.compareByOriginalPositions,s.getArg(e,"bias",r.GREATEST_LOWER_BOUND));if(i>=0){var o=this._originalMappings[i];if(o.source===n.source)return{line:s.getArg(o,"generatedLine",null),column:s.getArg(o,"generatedColumn",null),lastColumn:s.getArg(o,"lastGeneratedColumn",null)}}return{line:null,column:null,lastColumn:null}},t.BasicSourceMapConsumer=i,a.prototype=Object.create(r.prototype),a.prototype.constructor=r,a.prototype._version=3,Object.defineProperty(a.prototype,"sources",{get:function(){for(var e=[],t=0;t<this._sections.length;t++)for(var n=0;n<this._sections[t].consumer.sources.length;n++)e.push(this._sections[t].consumer.sources[n]);return e}}),a.prototype.originalPositionFor=function(e){var t={generatedLine:s.getArg(e,"line"),generatedColumn:s.getArg(e,"column")},n=u.search(t,this._sections,function(e,t){var n=e.generatedLine-t.generatedOffset.generatedLine;return n?n:e.generatedColumn-t.generatedOffset.generatedColumn}),r=this._sections[n];return r?r.consumer.originalPositionFor({line:t.generatedLine-(r.generatedOffset.generatedLine-1),column:t.generatedColumn-(r.generatedOffset.generatedLine===t.generatedLine?r.generatedOffset.generatedColumn-1:0),bias:e.bias}):{source:null,line:null,column:null,name:null}},a.prototype.hasContentsOfAllSources=function(){return this._sections.every(function(e){return e.consumer.hasContentsOfAllSources()})},a.prototype.sourceContentFor=function(e,t){for(var n=0;n<this._sections.length;n++){var r=this._sections[n],i=r.consumer.sourceContentFor(e,!0);if(i)return i}if(t)return null;throw new Error('"'+e+'" is not in the SourceMap.')},a.prototype.generatedPositionFor=function(e){for(var t=0;t<this._sections.length;t++){var n=this._sections[t];if(-1!==n.consumer.sources.indexOf(s.getArg(e,"source"))){var r=n.consumer.generatedPositionFor(e);if(r){var i={line:r.line+(n.generatedOffset.generatedLine-1),column:r.column+(n.generatedOffset.generatedLine===r.line?n.generatedOffset.generatedColumn-1:0)};return i}}}return{line:null,column:null}},a.prototype._parseMappings=function(){this.__generatedMappings=[],this.__originalMappings=[];for(var e=0;e<this._sections.length;e++)for(var t=this._sections[e],n=t.consumer._generatedMappings,r=0;r<n.length;r++){var i=n[r],o=t.consumer._sources.at(i.source);null!==t.consumer.sourceRoot&&(o=s.join(t.consumer.sourceRoot,o)),this._sources.add(o),o=this._sources.indexOf(o);var a=t.consumer._names.at(i.name);this._names.add(a),a=this._names.indexOf(a);var u={source:o,generatedLine:i.generatedLine+(t.generatedOffset.generatedLine-1),generatedColumn:i.generatedColumn+(t.generatedOffset.generatedLine===i.generatedLine?t.generatedOffset.generatedColumn-1:0),originalLine:i.originalLine,originalColumn:i.originalColumn,name:a};this.__generatedMappings.push(u),"number"==typeof u.originalLine&&this.__originalMappings.push(u)}f(this.__generatedMappings,s.compareByGeneratedPositionsDeflated),f(this.__originalMappings,s.compareByOriginalPositions)},t.IndexedSourceMapConsumer=a},function(e,t){function n(e,r,i,o,a,s){var u=Math.floor((r-e)/2)+e,c=a(i,o[u],!0);return 0===c?u:c>0?r-u>1?n(u,r,i,o,a,s):s==t.LEAST_UPPER_BOUND?r<o.length?r:-1:u:u-e>1?n(e,u,i,o,a,s):s==t.LEAST_UPPER_BOUND?u:0>e?-1:e}t.GREATEST_LOWER_BOUND=1,t.LEAST_UPPER_BOUND=2,t.search=function(e,r,i,o){if(0===r.length)return-1;var a=n(-1,r.length,e,r,i,o||t.GREATEST_LOWER_BOUND);if(0>a)return-1;for(;a-1>=0&&0===i(r[a],r[a-1],!0);)--a;return a}},function(e,t){function n(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function r(e,t){return Math.round(e+Math.random()*(t-e))}function i(e,t,o,a){if(a>o){var s=r(o,a),u=o-1;n(e,s,a);for(var c=e[a],l=o;a>l;l++)t(e[l],c)<=0&&(u+=1,n(e,u,l));n(e,u+1,l);var f=u+1;i(e,t,o,f-1),i(e,t,f+1,a)}}t.quickSort=function(e,t){i(e,t,0,e.length-1)}},function(e,t,n){function r(e,t,n,r,i){this.children=[],this.sourceContents={},this.line=null==e?null:e,this.column=null==t?null:t,this.source=null==n?null:n,this.name=null==i?null:i,this[u]=!0,null!=r&&this.add(r)}var i=n(1).SourceMapGenerator,o=n(4),a=/(\r?\n)/,s=10,u="$$$isSourceNode$$$";r.fromStringWithSourceMap=function(e,t,n){function i(e,t){if(null===e||void 0===e.source)s.add(t);else{var i=n?o.join(n,e.source):e.source;s.add(new r(e.originalLine,e.originalColumn,i,t,e.name))}}var s=new r,u=e.split(a),c=function(){var e=u.shift(),t=u.shift()||"";return e+t},l=1,f=0,p=null;return t.eachMapping(function(e){if(null!==p){if(!(l<e.generatedLine)){var t=u[0],n=t.substr(0,e.generatedColumn-f);return u[0]=t.substr(e.generatedColumn-f),f=e.generatedColumn,i(p,n),void(p=e)}i(p,c()),l++,f=0}for(;l<e.generatedLine;)s.add(c()),l++;if(f<e.generatedColumn){var t=u[0];s.add(t.substr(0,e.generatedColumn)),u[0]=t.substr(e.generatedColumn),f=e.generatedColumn}p=e},this),u.length>0&&(p&&i(p,c()),s.add(u.join(""))),t.sources.forEach(function(e){var r=t.sourceContentFor(e);null!=r&&(null!=n&&(e=o.join(n,e)),s.setSourceContent(e,r))}),s},r.prototype.add=function(e){if(Array.isArray(e))e.forEach(function(e){this.add(e)},this);else{if(!e[u]&&"string"!=typeof e)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);e&&this.children.push(e)}return this},r.prototype.prepend=function(e){if(Array.isArray(e))for(var t=e.length-1;t>=0;t--)this.prepend(e[t]);else{if(!e[u]&&"string"!=typeof e)throw new TypeError("Expected a SourceNode, string, or an array of SourceNodes and strings. Got "+e);this.children.unshift(e)}return this},r.prototype.walk=function(e){for(var t,n=0,r=this.children.length;r>n;n++)t=this.children[n],t[u]?t.walk(e):""!==t&&e(t,{source:this.source,line:this.line,column:this.column,name:this.name})},r.prototype.join=function(e){var t,n,r=this.children.length;if(r>0){for(t=[],n=0;r-1>n;n++)t.push(this.children[n]),t.push(e);t.push(this.children[n]),this.children=t}return this},r.prototype.replaceRight=function(e,t){var n=this.children[this.children.length-1];return n[u]?n.replaceRight(e,t):"string"==typeof n?this.children[this.children.length-1]=n.replace(e,t):this.children.push("".replace(e,t)),this},r.prototype.setSourceContent=function(e,t){this.sourceContents[o.toSetString(e)]=t},r.prototype.walkSourceContents=function(e){for(var t=0,n=this.children.length;n>t;t++)this.children[t][u]&&this.children[t].walkSourceContents(e);for(var r=Object.keys(this.sourceContents),t=0,n=r.length;n>t;t++)e(o.fromSetString(r[t]),this.sourceContents[r[t]])},r.prototype.toString=function(){var e="";return this.walk(function(t){e+=t}),e},r.prototype.toStringWithSourceMap=function(e){var t={code:"",line:1,column:0},n=new i(e),r=!1,o=null,a=null,u=null,c=null;return this.walk(function(e,i){t.code+=e,null!==i.source&&null!==i.line&&null!==i.column?((o!==i.source||a!==i.line||u!==i.column||c!==i.name)&&n.addMapping({source:i.source,original:{line:i.line,column:i.column},generated:{line:t.line,column:t.column},name:i.name}),o=i.source,a=i.line,u=i.column,c=i.name,r=!0):r&&(n.addMapping({generated:{line:t.line,column:t.column}}),o=null,r=!1);for(var l=0,f=e.length;f>l;l++)e.charCodeAt(l)===s?(t.line++,t.column=0,l+1===f?(o=null,r=!1):r&&n.addMapping({source:i.source,original:{line:i.line,column:i.column},generated:{line:t.line,column:t.column},name:i.name})):t.column++}),this.walkSourceContents(function(e,t){n.setSourceContent(e,t)}),{code:t.code,map:n}},t.SourceNode=r}])}),requireSimulator.setName("IndentBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert","source-map"],function(e,t){var n=function(e){var t={},n=[],r=0,i=0;return e.split("\n").forEach(function(e){n.push(r),r+=e.length+1}),n.push(r),t.getRC=function(e){for(;;){if(0>i)return{row:1,col:1};if(i+1>=n.length)return{row:n.length,col:1};if(e<n[i])i--;else{if(!(n[i+1]<=e))return{row:i+1,col:e-n[i]+1};i++}}},t};return IndentBuffer=function(r){r=r||{};var i=function(){function e(e){r++;var i=t[r];if(null==i&&!e)throw console.log(t),new Error(r+"th null param: fmt="+n);return i}for(var t=arguments,n=t[0],r=0;;){var o=n.indexOf("%");if(0>o){i.print(n);break}i.print(n.substring(0,o)),o++;var a=n.charAt(o);if("s"==a){var s=e();"string"==typeof s||"number"==typeof s||(null==s?s="null":s.text&&(i.addMapping(s),s=s.text)),i.print(s),o++}else if("d"==a){var u=e();if("number"!=typeof u)throw new Error(u+" is not a number: fmt="+n);i.print(u),o++}else if("n"==a)i.ln(),o++;else if("{"==a)i.indent(),o++;else if("}"==a)i.dedent(),o++;else if("%"==a)i.print("%"),o++;else if("f"==a)e()(i),o++;else if("l"==a){var c=e();i.print(i.toLiteral(c)),o++}else if("v"==a){var l=e();if(!l)throw new Error("Null %v");if("object"!=typeof l)throw new Error("nonobject %v:"+l);i.addMapping(l),i.visitor.visit(l),o++}else if("z"==a){var f=e();if("val"in f)return void i.print(f.val);f.inited||i.lazy(f),f.print(),o++}else if("j"==a){var p=e(),h=p[0],d=p[1],m=!1;if(!d||!d.forEach)throw console.log(d),new Error(d+" is not array. cannot join fmt:"+n);d.forEach(function(e){m&&i.printf(h),m=!0,i.visitor.visit(e)}),o++}else"D"==a?(e(!0),o++):o+=2;n=n.substring(o)}};return i.addMapping=function(e){if(i.srcFile){var t;"number"==typeof e.row&&"number"==typeof e.col?t={row:e.row,col:e.col}:"number"==typeof e.pos&&(t=i.srcRCM.getRC(e.pos)),t&&i.srcmap.addMapping({generated:{line:i.bufRow,column:i.bufCol},source:i.srcFile+"",original:{line:t.row,column:t.col}})}},i.setSrcFile=function(e){i.srcFile=e,i.srcRCM=n(e.text()),i.srcmap.setSourceContent(e.path(),e.text())},i.print=function(e){i.buf+=e;var t=(e+"").split("\n");t.forEach(function(e,n){n<t.length-1?(i.bufCol+=e.length+1,i.bufRow++,i.bufCol=1):i.bufCol+=e.length})},i.dstFile=r.dstFile,i.mapFile=r.mapFile,i.printf=i,i.buf="",i.bufRow=1,i.bufCol=1,i.srcmap=new t.SourceMapGenerator,i.lazy=function(t){return t||(t={}),r.fixLazyLength?(t.length=t.length||r.fixLazyLength,t.pad=t.pad||" ",t.gen=function(){for(var e="",n=0;n<t.length;n++)e+=t.pad;return e}(),t.puts=[],i.useLengthPlace=!0):(t.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),t.reg=new RegExp(t.gen,"g"),e(!i.useLengthPlace,"GENERETID cannot be used")),t.inited=!0,t.put=function(t){if(this.val=t+"",this.puts){for(this.val.length>this.length&&(i.lazyOverflow=!0);this.val.length<this.length;)this.val+=this.pad;var n=this;this.puts.forEach(function(t){var r=i.buf.length;i.buf=i.buf.substring(0,t)+n.val+i.buf.substring(t+n.length),e.eq(r,i.buf.length)})}return this.reg&&(i.buf=i.buf.replace(this.reg,t)),this.val},t.print=function(){this.puts&&this.puts.push(i.buf.length),i.print(this.gen)},t},i.ln=function(){i.print("\n"+i.indentBuf)},i.indent=function(){i.indentBuf+=i.indentStr,i.print("\n"+i.indentBuf)},i.dedent=function(){var e=i.indentStr.length;if(!i.buf.substring(i.buf.length-e).match(/^\s*$/))throw console.log(i.buf),new Error("Non-space truncated ");i.buf=i.buf.substring(0,i.buf.length-e),i.indentBuf=i.indentBuf.substring(0,i.indentBuf.length-e)},i.toLiteral=function(e,t){if(t||(t="'"),"string"!=typeof e)throw console.log("no literal ",e),new Error("toLiteral:"+e+" is not a literal");return e=e.replace(/\\/g,"\\\\"),e=e.replace(/\r/g,"\\r"),e=e.replace(/\n/g,"\\n"),e="'"==t?e.replace(/'/g,"\\'"):e.replace(/"/g,'\\"'),t+e+t},i.indentBuf="",i.indentStr="  ",i.close=function(){return i.mapStr=i.srcmap.toString(),i.mapFile&&i.dstFile&&(i.mapFile.text(i.mapStr),i.printf("%n//# sourceMappingURL=%s%n",i.mapFile.relPath(i.dstFile.up()))),i.dstFile&&i.dstFile.text(i.buf),i.buf},i}}),requireSimulator.setName("disp"),"function"!=typeof define&&(define=require("requirejs").define),define(["IndentBuffer"],function(e){return disp=function(t){function n(e){if(null==e)return r("null%n");if("string"==typeof e)return r("'%s'%n",e);if("number"==typeof e)return r("%s%n",e);if("function"==typeof e)return r("func%n");r(e instanceof Array?"[%{":"{%{");var t="";for(var i in e)r(t+i+":"),n(e[i]);r(e instanceof Array?"%}]%n":"%}}%n")}var r=e();return n(t),r.buf}}),requireSimulator.setName("Parser"),"function"!=typeof define&&(define=require("requirejs").define),define(["disp"],function(){return Parser=function(){function e(e,t){var n;for(n in t)e[n]=t[n];return e}function t(e){this.parse=i.options.traceTap?function(t){console.log("tap: name="+this.name+"  pos="+(t?t.pos:"?"));var n=e.apply(this,[t]),r="NOIMG";return n.src&&n.src.str&&(r=n.src.str.substring(n.pos-3,n.pos)+"^"+n.src.str.substring(n.pos,n.pos+3)),n.src&&n.src.tokens&&(r=n.src.tokens[n.pos-1]+"["+n.src.tokens[n.pos]+"]"+n.src.tokens[n.pos+1]),console.log("/tap: name="+this.name+" pos="+(t?t.pos:"?")+"->"+(n?n.pos:"?")+" "+r+" res="+(n?n.success:"?")),n}:e}function n(e,t){if(null==e)throw t+" is null!";return e}function r(e,t){null!=e&&(this.src={maxPos:0,global:t},"string"==typeof e&&(this.src.str=e),e instanceof Array&&(this.src.tokens=e),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:t,StringParser:o,nc:n};i.dispTbl=function(e){var t="",n={};if(!e)return t;for(var r in e){var i=e[r].name;n[i]||(n[i]=""),n[i]+=r}for(var i in n)t+=n[i]+"->"+i+",";return t},t.create=function(e){return new t(e)},i.create=t.create,e(t.prototype,{except:function(e){var n=this;return this.ret(t.create(function(t){return e.apply({},t.result)&&(t.success=!1),t}).setName("(except "+n.name+")"))},noFollow:function(e){var r=this;return n(e,"p"),this.ret(t.create(function(t){var n=e.parse(t);return t.success=!n.success,t}).setName("("+r.name+" noFollow "+e.name+")"))},andNoUnify:function(e){n(e,"next");var r=this,i=t.create(function(t){var n=r.parse(t);if(!n.success)return n;var i=e.parse(n);return i.success&&(i.result=n.result.concat(i.result)),i});return i.setName("("+this.name+" "+e.name+")")},and:function(e){var n=this.andNoUnify(e);if(!this._first)return n;var r=this._first.tbl,o={};for(var a in r)o[a]=r[a].andNoUnify(e);return n=t.fromFirst(this._first.space,o),n.setName("("+this.name+" >> "+e.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+n.name+" tbl="+i.dispTbl(o)),n},retNoUnify:function(e){var n,r=this;n="function"==typeof e?t.create(function(t){var n=t.clone();return n.result=[e.apply({},t.result)],n}).setName("retfunc"):e;var i=t.create(function(e){var t=r.parse(e);return t.success?n.parse(t):t}).setName("("+this.name+" >= "+n.name+")");return i},ret:function(e){if(!this._first)return this.retNoUnify(e);var n=this._first.tbl,r={};for(var o in n)r[o]=n[o].retNoUnify(e);return res=t.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+e.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(e,n){if(!i.options.optimizeFirst)return this;if(null==e)throw"Space is null2!";if("string"==typeof n){for(var r={},o=0;o<n.length;o++)r[n.substring(o,o+1)]=this;return t.fromFirst(e,r).setName("(fst "+this.name+")")}if(null==n)return t.fromFirst(e,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof n)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(e){if(!i.options.optimizeFirst)return this;"string"==typeof e&&(e=[e]);var n={};if(e){var r=this;e.forEach(function(e){n[e]=r})}else n.ALL=this;return t.fromFirstTokens(n).setName("(fstT "+this.name+")")},unifyFirst:function(n){function r(e,t){return e?t?e.orNoUnify(t).checkTbl():e:t}function o(){var e=n._first.tbl,t={};for(var i in a)t[i]=1;for(var i in e)t[i]=1;delete t.ALL,(a.ALL||e.ALL)&&(a.ALL=r(a.ALL,e.ALL));for(var i in t)a[i]&&e[i]?a[i]=r(a[i],e[i]):a[i]&&!e[i]?a[i]=r(a[i],e.ALL):!a[i]&&e[i]&&(a[i]=r(a.ALL,e[i]))}var a={};this.checkTbl(),n.checkTbl(),e(a,this._first.tbl),o();var s=t.fromFirst(this._first.space,a).setName("("+this.name+")U("+n.name+")");return i.options.verboseFirst&&console.log("Created unify name="+s.name+" tbl="+i.dispTbl(a)),s},or:function(e){return n(e,"other"),this._first&&e._first&&this._first.space&&this._first.space===e._first.space?this.unifyFirst(e):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+e.name+" "+this._first+" - "+e._first),this.orNoUnify(e))
},orNoUnify:function(e){var n=this,r=t.create(function(t){var r=n.parse(t);if(r.success)return r;var i=e.parse(t);return i});return r.name="("+this.name+")|("+e.name+")",r},setName:function(e){return this.name=e,this._first,this},profile:function(e){return i.options.profile&&(this.parse=this.parse.profile(e||this.name)),this},repN:function(e){var n=this;e||(e=0);var r=t.create(function(t){for(var r=t,i=[];;){var o=n.parse(r);if(!o.success){var a;return i.length>=e?(a=r.clone(),a.result=[i],a.success=!0,a):(a=t.clone(),a.success=!1,a)}i.push(o.result[0]),r=o}});return r.setName("("+n.name+" * "+e+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var e=this;return t.create(function(t){var n=e.parse(t);return n.success?n:(t=t.clone(),t.success=!0,t.result=[null],t)}).setName("("+e.name+")?")},sep1:function(e,t){var r=this;n(r,"value"),n(e,"sep");var i=e.and(r).ret(function(e,n){return t?n:{sep:e,value:n}});return r.and(i.rep0()).ret(function(e,n){var r;if(t){var i=[e];for(r in n)i.push(n[r]);return i}return{head:e,tails:n}}).setName("(sep1 "+r.name+"~~"+e.name+")")},sep0:function(e){return this.sep1(e,!0).opt().ret(function(e){return e?e:[]})},tap:function(e){return this},retN:function(e){return this.ret(function(){return arguments[e]})},parseStr:function(e,t){var n=new r(e,t);return this.parse(n)},checkTbl:function(){if(!this._first)return this;var e=this._first.tbl;for(var t in e)if(!e[t].parse)throw this.name+": tbl."+t+" is not a parser :"+e[t];return this}}),e(r.prototype,{clone:function(){var e=new r;return e.src=this.src,e.pos=this.pos,e.result=this.result.slice(),e.success=this.success,e},updateMaxPos:function(e){e>this.src.maxPos&&(this.src.maxPos=e)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),t.fromFirst=function(e,n){if("TOKEN"==e)return t.fromFirstTokens(n);var r=t.create(function(t){var r=e.parse(t),o=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+o+" tbl="+(n[o]?n[o].name:"-")),n[o]?n[o].parse(r):n.ALL?n.ALL.parse(r):(r.success=!1,r)});return r._first={space:e,tbl:n},r.checkTbl(),r},t.fromFirstTokens=function(e){var n=t.create(function(t){var n=t.src.tokens[t.pos],r=n?n.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(e[r]?e[r].name:"-")),null!=r&&e[r]?e[r].parse(t):e.ALL?e.ALL.parse(t):(t.success=!1,t)});return n._first={space:"TOKEN",tbl:e},n.checkTbl(),n};var o={empty:t.create(function(e){var t=e.clone();return t.success=!0,t.result=[null],t}).setName("E"),fail:t.create(function(e){return e.success=!1,e}).setName("F"),str:function(e){return this.strLike(function(t,n){return t.substring(n,n+e.length)===e?{len:e.length}:null}).setName(e)},reg:function(e){return(e+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(e+"")),this.strLike(function(t,n){var r=e.exec(t.substring(n));return r?(r.len=r[0].length,r):null}).setName(e+"")},strLike:function(n){return t.create(function(t){var r=t.src.str;if(null==r)throw"strLike: str is null!";var o=t.pos,a=n(r,o,t);if(i.options.traceToken&&console.log("pos="+o+" r="+a),a){i.options.traceToken&&console.log("str:succ"),a.pos=o,a.src=t.src;var s=t.clone();return e(s,{pos:o+a.len,success:!0,result:[a]}),t.updateMaxPos(s.pos),s}return i.options.traceToken&&console.log("str:fail"),t.success=!1,t}).setName("STRLIKE")},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)}};o.eof=o.strLike(function(e,t){return t==e.length?{len:0}:null}).setName("EOF"),i.StringParser=o;var a={token:function(e){return t.create(function(t){var n=t.src.tokens[t.pos];return t.success=!1,n?(n.type==e&&(t=t.clone(),t.updateMaxPos(t.pos),t.pos++,t.success=!0,t.result=[n]),t):t}).setName(e).firstTokens(e)},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)},eof:t.create(function(e){var t=e.pos>=e.src.tokens.length;return e.success=t,t&&(e=e.clone(),e.result=[{type:"EOF"}]),e}).setName("EOT")};return i.TokensParser=a,i.lazy=function(e){var n=null;return t.create(function(t){if(n||(n=e()),!n)throw e+" returned null!";return this.name=e.name,n.parse(t)}).setName("LZ")},i.addRange=function(e,t){if(null==t)return e;if("number"!=typeof e.pos)return e.pos=t.pos,e.len=t.len,e;var n=t.pos+t.len,r=e.pos+e.len;return t.pos<e.pos&&(e.pos=t.pos),n>r&&(e.len=n-e.pos),e},i.setRange=function(e){if(null!=e&&"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e){var t=i.getRange(e);if(null!=t)return e;for(var n in e)if(e.hasOwnProperty(n)){var r=i.setRange(e[n]);i.addRange(e,r)}return e}},i.getRange=function(e){return null==e?null:"number"!=typeof e.pos?null:"number"==typeof e.len?e:null},i}()}),requireSimulator.setName("Grammar"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return Grammar=function(){function t(e){return"string"==typeof e?r.get(e):e}var n=e,r=null;return r=function(n){var i={};return i.ands=function(){for(var i=t(arguments[0]),o=1;o<arguments.length;o++)i=i.and(t(arguments[o]));i=i.tap(n),r.defs[n]=i;var a={};return a.autoNode=function(){var t=i.ret(function(){for(var t={type:n},r=0;r<arguments.length;r++){var i=arguments[r],o=e.setRange(i);e.addRange(t,o),t["-element"+r]=i}t.toString=function(){return"("+this.type+")"}}).setName(n);return r.defs[n]=t},a.ret=function(t){if(0==arguments.length)return i;if("function"==typeof t)return r.defs[n]=i.ret(t);for(var o=[],a=function(e){return e},s=0;s<arguments.length;s++){if("function"==typeof arguments[s]){a=arguments[s];break}o[s]=arguments[s]}var u=i.ret(function(){var t={type:n};t[Grammar.SUBELEMENTS]=[];for(var r=0;r<arguments.length;r++){var i=arguments[r],s=e.setRange(i);e.addRange(t,s),o[r]&&(t[o[r]]=i),t[Grammar.SUBELEMENTS].push(i)}return t.toString=function(){return"("+this.type+")"},a(t)}).setName(n);return r.defs[n]=u},a},i.ors=function(){for(var e=t(arguments[0]),i=1;i<arguments.length;i++)e=e.or(t(arguments[i]));return r.defs[n]=e.setName(n)},i},r.defs={},r.get=function(e){return r.defs[e]?r.defs[e]:n.lazy(function(){var t=r.defs[e];if(!t)throw"grammar named '"+e+"' is undefined";return t}).setName("(Lazy of "+e+")")},r},Grammar.SUBELEMENTS="[SUBELEMENTS]",Grammar}),requireSimulator.setName("XMLBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return XMLBuffer=function(t){var n;return n=function(r,i){if(null!=r&&"string"!=typeof r&&"number"!=typeof r){var o=e.getRange(r);if(o)for(;n.srcLen<o.pos;)n.src(t.substring(n.srcLen,o.pos));if(null!=r){if(i&&n.startTag("attr_"+i),r.type&&n.startTag(r.isToken?"token_"+r.type:r.type+""),r.text)n.src(o.text);else{var a=n.orderByPos(r);a.forEach(function(e){e.name&&e.name.match(/^-/)?n(e.value):n(e.value,e.name)})}if(o)for(;n.srcLen<o.pos+o.len;)n.src(t.substring(n.srcLen,o.pos+o.len));r.type&&n.endTag(r.isToken?"token_"+r.type:""+r.type),i&&n.endTag("attr_"+i)}}},n.orderByPos=XMLBuffer.orderByPos,n.src=function(e){n.buf+=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),n.srcLen+=e.length},n.tag=function(e){n.buf+=e},n.startTag=function(e){n.tag(e.match(/^[a-zA-Z_0-9]+$/)?"<"+e+">":"<token>")},n.endTag=function(e){n.tag(e.match(/^[a-zA-Z_0-9]+$/)?"</"+e+">":"</token>")},n.buf="",n.srcLen=0,n},XMLBuffer.orderByPos=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&null!=e[n]&&"string"!=typeof e[n]&&"number"!=typeof e[n]&&"number"==typeof e[n].pos&&t.push(isNaN(parseInt(n))&&!(n+"").match(/^-/)?{name:n,value:e[n]}:{value:e[n]});return t=t.sort(function(e,t){return e.value.pos-t.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",XMLBuffer}),requireSimulator.setName("TError"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return TError=function(e,t,n){if("string"==typeof t)return{isTError:!0,mesg:e,src:{name:function(){return t},text:function(){return t}},pos:n,toString:function(){return this.mesg+" at "+t+":"+this.pos},raise:function(){throw this}};var r=null;if(t&&t.src&&(r=t,t=r.src.tonyu),"function"!=typeof t.name)throw"src="+t+" should be file object";var i;if("function"==typeof t.text){var o=t.text();"string"==typeof o&&(i=TError.calcRowCol(o,n))}return{isTError:!0,mesg:e,src:t,pos:n,row:i.row,col:i.col,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.row+":"+this.col},raise:function(){throw this}}},TError.calcRowCol=function(e,t){var n,r,i=e.split("\n"),o=0;for(n=0;n<i.length;n++)if(o+=i[n].length+1,o>t){r=t-(o-i[n].length);break}return{row:n,col:r}},TError}),requireSimulator.setName("TT"),define(["Grammar","XMLBuffer","IndentBuffer","disp","Parser","TError"],function(e,t,n,r,i){return TT=function(){function e(e,t){var n,i;"string"==typeof e?(n=s.str(e),e.length>0&&(i=e.substring(0,1)),t||(t=e)):(n=s.reg(e),t||(t=e+""));var o=f.and(n).ret(function(e,n){var i={};if(i.pos=n.pos,"number"!=typeof i.pos)throw"no pos for "+t+" "+r(n);if(i.len=n.len,i.text=n.src.str.substring(i.pos,i.pos+i.len),"string"!=typeof i.text)throw"no text("+i.text+") for "+t+" "+r(n);return i.toString=function(){return this.text},i.isToken=!0,i});return i&&(o=o.first(f,i)),o.setName(t)}function t(t,n,r){"string"==typeof r&&(r=e(r)),p[t]=o(p[t],r.ret(function(e){return e.type=n,e}).setName(n))}function n(e,n,r,i){n==u&&(n=r);for(var o=1;e>=o;o*=2)0!=(e&o)&&t(e&o,n,r,i);h[n]=i}function o(e,t){return e?e.or(t):t}function a(e){var t=i.StringParser.parse(d,e);return t.success||console.log("Stopped at "+e.substring(t.src.maxPos-5,t.src.maxPos+5)),t}var s=i.StringParser,u="SAMENAME",c=1,l=2,f=s.reg(/^(\s*(\/\*\/?([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),p={},h={},d=i.create(function(e){for(var t=l,n=[];;){if(e=p[t].parse(e),!e.success)break;var r=e.result[0];t=h[r.type],n.push(r)}return e=f.parse(e),e.success=e.src.maxPos==e.src.str.length,e.result[0]=n,e}),m={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,__typeof:!0,"for":!0,"else":!0,"super":!0,"while":!0,"continue":!0,"break":!0,"do":!0,"switch":!0,"case":!0,"default":!0,"try":!0,"catch":!0,"finally":!0,"throw":!0,of:!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,_thread:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},g=e(/^[0-9][xb]?[0-9a-f\.]*/i).ret(function(e){return e.type="number",e.value=e.text-0,e}).first(f,"0123456789"),v=e({exec:function(e){var t=e.substring(0,1);if('"'!==t&&"'"!==t)return!1;for(var n=1;n<e.length;n++){var r=e.substring(n,n+1);if(r===t)return[e.substring(0,n+1)];"\\"===r&&n++}return!1},toString:function(){return"literal"}}).first(f,"\"'"),y=e({exec:function(e){if("/"!==e.substring(0,1))return!1;for(var t=1;t<e.length;t++){var n=e.substring(t,t+1);if("/"===n){var r=/^[ig]*/.exec(e.substring(t+1));return[e.substring(0,t+1+r[0].length)]}if("\n"==n)return!1;"\\"===n&&t++}return!1},toString:function(){return"regex"}}).first(f,"/");n(l|c,"number",g,c),n(l,"regex",y,c),n(l|c,"literal",v,c),n(l|c,u,"++",c),n(l|c,u,"--",c),n(l|c,u,"!==",l),n(l|c,u,"===",l),n(l|c,u,">>>",l),n(l|c,u,"+=",l),n(l|c,u,"-=",l),n(l|c,u,"*=",l),n(l|c,u,"/=",l),n(l|c,u,"%=",l),n(l|c,u,">=",l),n(l|c,u,"<=",l),n(l|c,u,"!=",l),n(l|c,u,"==",l),n(l|c,u,">>",l),n(l|c,u,"<<",l),n(l|c,u,"&&",l),n(l|c,u,"||",l),n(l|c,u,"(",l),n(l|c,u,")",c),n(l|c,u,"[",l),n(l|c,u,"]",c),n(l|c,u,"{",l),n(l|c,u,"}",c),n(l|c,u,">",l),n(l|c,u,"<",l),n(l|c,u,"^",l),n(l|c,u,"+",l),n(l|c,u,"-",l),n(l|c,u,".",l),n(l|c,u,"?",l),n(l|c,u,"=",l),n(l|c,u,"*",l),n(l|c,u,"%",l),n(c,u,"/",l),n(c|l,u,"^",l),n(c|l,u,"~",l),n(c|l,u,"\\",l),n(c|l,u,":",l),n(c|l,u,";",l),n(c|l,u,",",l),n(l|c,u,"!",l),n(l|c,u,"&",l),n(l|c,u,"|",l);var b=e(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(e){return e.type="constructor"==e.text?"tk_constructor":m.hasOwnProperty(e.text)?e.text:"symbol",e}).first(f);for(var T in m)h[T]=l;return h.tk_constructor=l,h.symbol=c,p[l]=o(p[l],b),p[c]=o(p[c],b),{parse:a,extension:"js",reserved:m}}()}),requireSimulator.setName("ExpressionParser"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return ExpressionParser=function(){function t(e,t){var n={};return n.eq=function(n){return e==n.type()&&t==n.prio()},n.type=function(t){return t?t==e:e},n.prio=function(){return t},n.toString=function(){return"["+e+":"+t+"]"},n}function n(e){var t={},n=e;return t.add=function(e){n=n?n.or(e):e},t.get=function(){return n},t}function r(){var r=n(),i={};return i.reg=function(n,i,o){var a=t(n,i);r.add(o.ret(e.create(function(e){return e.opType=a,e})).setName("(opType "+a+" "+o.name+")"))},i.get=function(){return r.get()},i.parse=function(e){return i.get().parse(e)},i}function i(e,t){return}function o(e,t){var n,r=t;if(i(t," start minprio= "+e),t=s.parse(t),i(t," prefixorelem "+e),!t.isSuccess())return t;if(n=t.opType,n.type("prefix")){var c=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return t;var f=a.mkPrefix.def(c,t.result[0]);if(r=t.clone(),r.result=[f],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(r=t.clone(),t=u.parse(t),!t.isSuccess())return r;for(;;){if(i(t,"st:pi"),i(r,"res:ex"),n=t.opType,n.prio()<e)return r.nextPostfixOrInfix=t,r;if(n.type("postfix")){var f=a.mkPostfix.def(r.result[0],t.result[0]);if(r=t.clone(),r.result=[f],i(t,"185"),t=u.parse(t),!t.isSuccess())return r}else if(n.type("infixl")){var p=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var f=a.mkInfixl.def(r.result[0],p,t.result[0]);if(r=t.clone(),r.result=[f],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("infixr")){var p=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var f=a.mkInfixr.def(r.result[0],p,t.result[0]);if(r=t.clone(),r.result=[f],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("trifixr")){var h=r.result[0],d=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var m=t.result[0],t=l[n.prio()].parse(t);if(!t.isSuccess())return r;var g=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var v=t.result[0],f=a.mkTrifixr.def(h,d,m,g,v);if(r=t.clone(),r.result=[f],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else{var p=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var f=a.mkInfix.def(r.result[0],p,t.result[0]);if(r=t.clone(),r.result=[f],!t.nextPostfixOrInfix)return r;if(t=t.nextPostfixOrInfix,n.prio()==t.opType.prio())return r.success=!1,r}}}var a={},s=r(),u=r(),c=n(),l=[];return a.element=function(e){s.reg("element",-1,e),c.add(e)},a.getElement=function(){return c.get()},a.prefix=function(e,t){s.reg("prefix",e,t)},a.postfix=function(e,t){u.reg("postfix",e,t)},a.infixl=function(e,t){u.reg("infixl",e,t)},a.infixr=function(e,t){u.reg("infixr",e,t)},a.infix=function(e,t){u.reg("infix",e,t)},a.trifixr=function(e,t,n){u.reg("trifixr",e,t),l[e]=n},a.custom=function(){},a.mkInfix=function(e){a.mkInfix.def=e},a.mkInfix.def=function(t,n,r){return e.setRange({type:"infix",op:n,left:t,right:r})},a.mkInfixl=function(e){a.mkInfixl.def=e},a.mkInfixl.def=function(t,n,r){return e.setRange({type:"infixl",op:n,left:t,right:r})},a.mkInfixr=function(e){a.mkInfixr.def=e},a.mkInfixr.def=function(t,n,r){return e.setRange({type:"infixr",op:n,left:t,right:r})},a.mkPrefix=function(e){a.mkPrefix.def=e},a.mkPrefix.def=function(t,n){return e.setRange({type:"prefix",op:t,right:n})},a.mkPostfix=function(e){a.mkPostfix.def=e},a.mkPostfix.def=function(t,n){return e.setRange({type:"postfix",left:t,op:n})},a.mkTrifixr=function(e){a.mkTrifixr.def=e},a.mkTrifixr.def=function(t,n,r,i,o){return e.setRange({type:"trifixr",left:t,op1:n,mid:r,op2:i,right:o})},a.build=function(){return a.built=e.create(function(e){return o(0,e)}).setName("ExpBuilt"),a.built},a.lazy=function(){return e.create(function(e){return a.built.parse(e)})},a}}),requireSimulator.setName("TonyuLang"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","TT","disp","Parser","ExpressionParser","TError"],function(e,t,n,r,i,o,a,s){return TonyuLang=function(){function n(e){return function(){return arguments[e]}}function u(e){return e.sep0(m(","),!0).and(m(",").opt()).ret(function(e){return e})}function c(e,t){var n=[];if(e&&!e.args)throw i(e);if(e){var r=o.getRange(e);o.addRange(n,r),e.args.forEach(function(e){n.push(e)})}return t.forEach(function(e){var t=o.getRange(e);o.addRange(n,t),n.push(e.obj)}),n}function l(e,t,n){var r={type:"infix",left:e,op:t,right:n};return o.setRange(r),r.toString=function(){return"("+e+t+n+")"},r}var f=o,p={},h=e(),d=h.get,m=(f.StringParser,f.TokensParser.token),g=m("number").ret(function(e){if(e.type="number","string"!=typeof e.text)throw"No text for "+i(e);if(e.value=e.text-0,isNaN(e.value))throw"No value for "+i(e);return e}),v=m("symbol"),y=m("symbol");for(var b in r.reserved){var T=m(b);T instanceof o.Parser&&"constructor"!==b&&(y=y.or(T))}var w=m("==="),S=m("!=="),x=m("=="),A=m("!="),E=m(">="),P=m("<="),M=m(">"),k=m("<"),C=m("&&"),D=m("||"),R=m("&"),L=m("|"),N=m("^"),B=m(">>"),_=m("<<"),O=m(">>>"),I=m("-"),F=m("+"),j=m("*"),V=m("/"),$=m("%"),U=m("="),W=m("literal"),q=m("regex"),G=a(),Z=h("arrayElem").ands(m("["),G.lazy(),m("]")).ret(null,"subscript"),z=h("argList").ands(m("("),u(G.lazy()),m(")")).ret(null,"args"),H=h("member").ands(m("."),y).ret(null,"name"),J=h("parenExpr").ands(m("("),G.lazy(),m(")")).ret(null,"expr"),K=h("varAccess").ands(v).ret("name"),Q=d("funcExpr").firstTokens(["function","\\"]),Y=h("funcExprArg").ands(Q).ret("obj"),X=d("objlit").firstTokens("{"),et=h("objlitArg").ands(X).ret("obj"),tt=et.or(Y),nt=z.and(tt.rep0()).ret(function(e,t){return c(e,t)}).or(tt.rep1().ret(function(e){return c(null,e)})),rt=(z.or(et),h("call").ands(nt).ret("args")),it=h("scall").ands(nt).ret("args"),ot=h("newExpr").ands(m("new"),K,rt.opt()).ret(null,"klass","params"),at=h("superExpr").ands(m("super"),m(".").and(v).ret(n(1)).opt(),it).ret(null,"name","params"),st=m("true").or(m("false")).or(m("null")).or(m("undefined")).or(m("_thread")).or(m("this")).or(m("arguments")).ret(function(e){return e.type="reservedConst",e});G.element(g),G.element(st),G.element(q),G.element(W),G.element(J),G.element(ot),G.element(at),G.element(Q),G.element(X),G.element(d("arylit").firstTokens("[")),G.element(K);var ut=0;G.infixr(ut,U),G.infixr(ut,m("+=")),G.infixr(ut,m("-=")),G.infixr(ut,m("*=")),G.infixr(ut,m("/=")),G.infixr(ut,m("%=")),G.infixr(ut,m("|=")),G.infixr(ut,m("&=")),ut++,G.trifixr(ut,m("?"),m(":")),ut++,G.infixl(ut,D),ut++,G.infixl(ut,C),ut++,G.infixl(ut,L),ut++,G.infixl(ut,N),ut++,G.infixl(ut,R),ut++,G.infix(ut,m("instanceof")),G.infix(ut,m("is")),G.infix(ut,w),G.infix(ut,S),G.infix(ut,x),G.infix(ut,A),G.infix(ut,E),G.infix(ut,P),G.infix(ut,M),G.infix(ut,k),ut++,G.infixl(ut,O),G.infixl(ut,_),G.infixl(ut,B),ut++,G.postfix(ut+3,m("++")),G.postfix(ut+3,m("--")),G.infixl(ut,I),G.infixl(ut,F),ut++,G.infixl(ut,j),G.infixl(ut,V),G.infixl(ut,$),ut++,G.prefix(ut,m("typeof")),G.prefix(ut,m("__typeof")),G.prefix(ut,m("delete")),G.prefix(ut,m("++")),G.prefix(ut,m("--")),G.prefix(ut,m("+")),G.prefix(ut,m("-")),G.prefix(ut,m("!")),G.prefix(ut,m("~")),ut++,ut++,G.postfix(ut,rt),G.postfix(ut,H),G.postfix(ut,Z),G.mkInfixl(l),G.mkInfixr(l);{var ct=G.build().setName("expr").profile(),n=function(e){return function(){return arguments[e]}},lt=d("stmt").firstTokens();h("exprstmt").ands(ct,m(";")).ret("expr")}h("compound").ands(m("{"),lt.rep0(),m("}")).ret(null,"stmts");var ft=m("else").and(lt).ret(n(1)),pt=(h("return").ands(m("return"),ct.opt(),m(";")).ret(null,"value"),h("if").ands(m("if"),m("("),ct,m(")"),lt,ft.opt()).ret(null,null,"cond",null,"then","_else"),h("forin").ands(m("var").opt(),v.sep1(m(","),!0),m("in").or(m("of")),ct).ret("isVar","vars","inof","set")),ht=h("normalFor").ands(lt,ct.opt(),m(";"),ct.opt()).ret("init","cond",null,"next"),dt=ht.or(pt),mt=(h("for").ands(m("for"),m("("),dt,m(")"),"stmt").ret(null,null,"inFor",null,"loop"),h("while").ands(m("while"),m("("),ct,m(")"),"stmt").ret(null,null,"cond",null,"loop"),h("do").ands(m("do"),"stmt",m("while"),m("("),ct,m(")"),m(";")).ret(null,"loop",null,null,"cond",null,null),h("case").ands(m("case"),ct,m(":"),lt.rep0()).ret(null,"value",null,"stmts")),gt=h("default").ands(m("default"),m(":"),lt.rep0()).ret(null,null,"stmts"),vt=(h("switch").ands(m("switch"),m("("),ct,m(")"),m("{"),mt.rep1(),gt.opt(),m("}")).ret(null,null,"value",null,null,"cases","defs"),h("break").ands(m("break"),m(";")).ret("brk"),h("continue").ands(m("continue"),m(";")).ret("cont"),h("finally").ands(m("finally"),"stmt").ret(null,"stmt"),h("catch").ands(m("catch"),m("("),v,m(")"),"stmt").ret(null,null,"name",null,"stmt"),h("catches").ors("catch","finally")),yt=(h("try").ands(m("try"),"stmt",vt.rep1()).ret(null,"stmt","catches"),h("throw").ands(m("throw"),ct,m(";")).ret(null,"ex"),h("typeExpr").ands(v).ret("name")),bt=h("typeDecl").ands(m(":"),yt).ret(null,"vtype"),Tt=h("varDecl").ands(v,bt.opt(),m("=").and(ct).ret(n(1)).opt()).ret("name","typeDecl","value"),wt=(h("varsDecl").ands(m("var"),Tt.sep1(m(","),!0),m(";")).ret(null,"decls"),h("paramDecl").ands(v,bt.opt()).ret("name","typeDecl")),St=h("paramDecls").ands(m("("),u(wt),m(")")).ret(null,"params"),xt=h("setterDecl").ands(m("="),wt).ret(null,"value");h("funcDeclHead").ands(m("nowait").opt(),m("function").or(m("fiber")).or(m("tk_constructor")).or(m("\\")).opt(),v.or(m("new")),xt.opt(),St.opt(),bt.opt()).ret("nowait","ftype","name","setter","params","rtype");h("funcDecl").ands("funcDeclHead","compound").ret("head","body"),h("nativeDecl").ands(m("native"),v,m(";")).ret(null,"name"),h("ifWait").ands(m("ifwait"),"stmt",ft.opt()).ret(null,"then","_else"),h("empty").ands(m(";")).ret(null);lt=h("stmt").ors("return","if","for","while","do","break","continue","switch","ifWait","try","throw","nativeDecl","funcDecl","compound","exprstmt","varsDecl","empty"),h("funcExprHead").ands(m("function").or(m("\\")),v.opt(),St.opt()).ret(null,"name","params");var At=(h("funcExpr").ands("funcExprHead","compound").ret("head","body"),h("jsonElem").ands(v.or(W),m(":").or(m("=")).and(ct).ret(function(e,t){return t}).opt()).ret("key","value")),Et=(h("objlit").ands(m("{"),u(At),m("}")).ret(null,"elems"),h("arylit").ands(m("["),u(ct),m("]")).ret(null,"elems"),h("extends").ands(m("extends"),v.or(m("null")),m(";")).ret(null,"superclassName")),Pt=h("includes").ands(m("includes"),v.sep1(m(","),!0),m(";")).ret(null,"includeClassNames"),Mt=h("program").ands(Et.opt(),Pt.opt(),lt.rep0(),o.TokensParser.eof).ret("ext","incl","stmts");for(var kt in h.defs)h.defs[kt].profile();return p.parse=function(e){str="string"==typeof e?e:e.text(),str+="\n";var t=r.parse(str);if(!t.isSuccess())throw s("文法エラー(Token)",e,t.src.maxPos);var n=t.result[0],i=f.TokensParser.parse(Mt,n);if(i.isSuccess()){var o=i.result[0];return o}var a=n[i.src.maxPos],u=a?a.pos+a.len:str.length;throw s("文法エラー",e,u)},p.genXML=function(e,n){var r=t(e);return r(n),r.buf},p.extension="tonyu",p}()}),requireSimulator.setName("Visitor"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Visitor=function(e){var t={funcs:e,path:[]};return t.visit=function(n){try{t.path.push(n),t.debug&&console.log("visit ",n.type,n.pos);var r=n?e[n.type]:null;if(r)return r.call(t,n);if(t.def)return t.def.call(t,n)}finally{t.path.pop()}},t.replace=function(e){return t.def||(t.def=function(e){if("object"==typeof e)for(var n in e)e[n]&&"object"==typeof e[n]&&(e[n]=t.visit(e[n]));return e}),t.visit(e)},t}}),requireSimulator.setName("fixIndent"),define("fixIndent",[],function(){return fixIndent}),requireSimulator.setName("HttpHelper"),define("HttpHelper",[],function(){return HttpHelper}),requireSimulator.setName("Arrow"),Arrow=function(){var e={};return e.show=function(e){function t(){e.addClass("tutorial-highlight"),setTimeout(n,200)}function n(){e.removeClass("tutorial-highlight"),o-->0?setTimeout(t,200):r()}function r(){o=0,$.data(e[0],"blinking","f")}if("string"==typeof e&&(e=$(e)),0==e.length)return!1;var i=$.data(e[0],"blinking");if("t"!=i){$.data(e[0],"blinking","t");var o=3;t(),e.click(function(){r()})}},e.showOld=function(e){function t(){r&&(r.attr({src:"images/arrow"+i+".png"}),i=(i+1)%4)}if("string"==typeof e&&(e=$(e)),0==e.length)return!1;var n=e.offset(),r=$("<img>").attr({src:"images/arrow0.png"}).css({font:"40px",position:"absolute",left:n.left,top:n.top+e.height(),color:"red",zIndex:1e3,"z-index":1e3}).appendTo("body"),i=0;return setInterval(t,250),e.click(function(){r&&(r.remove(),r=null)}),!0},e}(),define("Arrow",[],function(){return Arrow}),requireSimulator.setName("Wiki"),define(["HttpHelper","Arrow","Util","WebSite","Log","UI","FS"],function(e,t,n,r,i,o,a){return Wiki=function(n,s,u){function c(e){function t(e){e.stopPropagation(),e.preventDefault()}function n(e){if(u.editMode){var t=e.originalEvent,n=t.dataTransfer.files[0];if(!n.type.match(/image\/(png|gif|jpg)/)[1])return e.stopPropagation(),e.preventDefault(),!1;var r=new FileReader;return r.onload=function(){var e=r.result;s.text(e),i.empty().append(o("img",{src:e}))},r.readAsDataURL(n),e.stopPropagation(),e.preventDefault(),!1}}var i,s;if(f.builtinImages[e])return $("<div>").append($("<img>").attr("src",r.top+"/doc/images/"+e));i=o("div",{style:"margin:10px; padding:10px; border:solid black 1px;",on:{dragover:t,dragenter:t,drop:n}},"ここに画像ファイル(png/gif/jpg)をドラッグ＆ドロップして追加");var c=a.get(r.tonyuHome);return s=c.rel("doc/images/").rel(e),s.exists()&&i.empty().append(o("img",{src:s.text()})),i}function l(e,t,n){function r(){for(var a=[];;){var s=e.indexOf(t,o),u=e.indexOf(n,o);if(u>=0&&(0>s||s>u)){a.push(e.substring(o,u)),o=u;break}if(0>s){a.push(e.substring(o)),o=e.length;break}a.push(e.substring(o,s)),o=s+t.length;var c=r();c.hasBrace=!0,o<e.length&&(o+=n.length),a.push(c)}return i(a),a}function i(e){return e.split=function(e,t){if(1==t)return this;var n=[],r=i([]);return this.forEach(function(o){if("string"==typeof o){var a=o.indexOf(e);if(n.length>=t&&(a=-1),a>=0){if(a>0){var s=o.substring(0,a);r.push(s)}if(a+=e.length,n.push(1!=r.length?r:r[0]),r=i([]),a<o.length){var s=o.substring(a);r.push(s)}}else r.push(o)}else r.push(o)}),n.push(1!=r.length?r:r[0]),n},e.text=function(e){var r=this.hasBrace&&e?t:"";return this.forEach(function(e){r+="string"==typeof e?e:e.text(!0)}),r+=this.hasBrace&&e?n:""},e.toString=function(){return this.text(!0)},e}var o=0;return r(0)}var f={},p={figures:"図",plists:"リスト"},h="line_marker_",d={},m=[],g=".txt";if(u||(u={}),s&&!s.isDir())throw s+": not a dir";var v,y;f.on=d,f.cd=function(e){v=e,y=v.rel("toc.json")},s&&f.cd(s),f.encodeURL=function(e){return encodeURI(e).replace(/%/g,"")},f.parse=function(n,i,o){function a(e){m[e]={};var t=1,n=function(n,r){var i=m[e][n];return i||(i={refs:[]},m[e][n]=i),r&&(i.no=t++,i.name=p[e]+i.no,i.refs.forEach(function(e){e.text(i.name)})),i};return n}function s(e){function t(e){for(null==e&&(e=0);m.ul>e;)m.ul--,g.exit()}g.lineNo=m.lineNo;var n=0;if(e.match(/^-+/)&&(n=RegExp.lastMatch.length),n>m.ul)for(;n>m.ul;)m.ul++,g.enter("<ul>");else t(n);if(e=e.substring(n),n>0&&g.enter("<li>"),e.match(/^\*+/)){var r=RegExp.rightContext,i="h"+RegExp.lastMatch.length;g.enter("<"+i+">"),d(r),g.exit()}else if(e.match(/^$/))t(),g.p($("<p>"));else if(e.match(/^<<toc(.*)/))m.toc=[m.name],m.blocks.push({name:"toc",exit:function(){y&&!y.isReadOnly()&&y.obj(m.toc),m.toc=null}});else if(e.match(/^<<code(.*)/)){var o=RegExp.$1;if(o=o.replace(/^ */,""),o.length>0){var a,s,u=o.split(/ /,2);if(2==u.length){s=u[0],a=u[1];var c=b(a,!0);g.p($("<div>").addClass("plist").text(c.name+" "+s))}else g.p($("<div>").addClass("plist").text(u))}g.enter("<pre>"),m.blocks.push({name:"code",exit:function(){g.exit()}})}else if(e.match(/^>>/)){var l=m.blocks.pop();l&&l.exit&&l.exit(m)}else if(e.match(/^@@@@(.*)/)){if(m.pclose)g.exit();else{if(RegExp.$1.length>0){var c=b(RegExp.$1,!0);g.p($("<div>").addClass("plist").text(c.name))}g.enter("<pre>")}m.pclose=!m.pclose}else d(e),g.p("\n");n>0&&g.exit(),m.lineNo++}function d(e){function n(e){var n,i=e.text();if(i.match(/^@blink ([^>]+)>([^\s]+)/)){caption=RegExp.$1;var a=RegExp.$2;n=$("<span>").addClass("clickable").text(caption).hover(function(){var e;parent&&parent.Arrow&&(e=parent.Arrow),t&&(e=t),e&&e.show(a)})}else if(i.match(/^@plistref (.*)/)){var s=RegExp.$1,l=b(s);n=$("<strong>").text(l.name),l.refs.push(n)}else if(i.match(/^@editadd/))g.p($("<img>").attr("src",r.top+"/images/editAdd.png"));else if(i.match(/^@figref (.*)/)){var l=v(RegExp.$1);n=$("<strong>").text(l.name),l.refs.push(n)}else if(i.match(/^@cfrag (.*)/)){var h=RegExp.$1;n=$("<code>"),g.enter(n),d(h),g.exit()}else if(i.match(/^@arg (.*)/)){var y=RegExp.$1;n=$("<i>"),g.enter(n),d(y),g.exit()}else{var T=e.split(">",2);if(2==T.length?(i=T[1]+"",caption=T[0]):caption=i,m.toc&&m.toc.push(i),i.match(/\.(png|jpg|gif)$/)&&!i.match(/^http/)){var l=v(i,!0);n=$("<div>").addClass("figure").append(c(i)),g.enter(n),g.enter($("<div>")),g.p(p.figures+l.no+"."),d(caption),g.exit(),g.exit()}else if(i.match(/^https?:\/\//))n=$("<a>").attr({href:i,target:"ext"}).text(caption);else{var w=f.resolveFile(i);if(w.exists()||!w.isReadOnly()&&u.editMode){if(u.useAnchor){var S=w.relPath(o.up()).replace(/\.txt$/,".html");S=f.encodeURL(S),n=$("<a>").attr({href:S}).text(caption)}else n=$("<span>").addClass("clickable").text(caption).click(function(){f.show(w)});w.exists()||n.addClass("notexist")}else n=$("<span>").text(caption)}}g.p(n)}var i="string"==typeof e?l(e,m.beginMark,m.endMark):e;i.forEach(function(e){"string"==typeof e?g.p(e):n(e)})}var m={},g=e({lineMark:h});m.out=g,m.name=i,m.lines=n.split(/\r?\n/),m.lineNo=0,m.ul=0,m.beginMark="[[",m.endMark="]]",m.blocks=[];var v=a("figures"),b=a("plists"),T=[];y&&y.exists()&&(T=y.obj());var w=T.indexOf(i);if(w>=0){var S="",x=T[w-1];x&&(S+="[[前へ>"+x+"]]");var A=T[w+1];A&&(S+=" - [[次へ>"+A+"]]");var E=T[0];0!=w&&(S+=" - [[目次>"+E+"]]"),m.lines.unshift(S),m.lines.push(S)}return m.lines.forEach(s),g.buf},f.resolveFile=function(e){var t;return t=e.isDir?e:v&&"/"!=e.substring(0,1)?v.rel(e+g):a.get(e)},f.show=function(e){var t=f.resolveFile(e);u.editMode||i.d("wiki","show "+t),f.cd(t.up());var r=t.truncExt(g);if(!t.exists()&&!t.isReadOnly()&&u.editMode){var o=m[m.length-1];t.text(o?"[["+o.truncExt(g)+"]]\n":"")}if(t.exists()){var a=f.parse(t.text(),r,t);n.empty(),n.scrollTop(0),n.append(a),n.append($("<div>").css({height:"100px"}).text("")),d.show&&d.show.apply(f,[t,r]),m.push(t)}else alert(e+" というページはありません")},f.back=function(){var e=m.pop();e&&show(e)};var b;return f.highlightLine=function(e){var t=$("#"+h+"-"+e);if(0!=t.length){b&&b.removeClass("wiki-cur-line"),b=t.next(),b.addClass("wiki-cur-line");var r=t.position().top,i=n;0>r&&i.scrollTop(i.scrollTop()+(r-10)/2);var o=i.height()-100;r>o&&i.scrollTop(i.scrollTop()+(r-o+10)/2)}},f.builtinImages={"50_100.png":1,"50_160.png":1,"50_300.png":1,"apple1apple2.png":1,"coords.png":1,"copy60_100.png":1,"firstRunRes.png":1,"firstVarRes.png":1,"itadaki.png":1,"noWaitCat.png":1,"runtimeError.png":1,"sample.png":1,"sayonara.png":1,"syntaxError.png":1},f}}),requireSimulator.setName("ObjectMatcher"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return ObjectMatcher=function(){function e(e,t){var n={};return n[i]=e,t&&(n[o]=t),n}function t(e){return e&&e[i]}function n(e,t,r){if(e===t)return!0;if(null==e)return!1;if("string"==typeof e&&t instanceof RegExp)return e.match(t);if("function"==typeof t)return t(e,r);if("object"==typeof t){for(var a in t)if(a!=i){var s=a==o?e:e[a],u=t[a];if(!n(s,u,r))return!1}return t[i]&&(r[t[i]]=e),!0}return!1}var r={},i="$var",o="$this";r.v=e,r.isVar=t;for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s=0;s<a.length;s++){var u=a.substring(s,s+1);r[u]=e(u)}return r.match=function(e,t){var r={};return n(e,t,r)?r:null},r}()}),requireSimulator.setName("context"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return context=function(){function e(e,n){var r={};for(var i in e)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=t[i],t[i]=t.ovrFunc(t[i],e[i])):(r[i]=t[i],t[i]=e[i]);
var o=n(t);for(var i in r)t[i]=r[i];return o}var t={};t.ovrFunc=function(e,t){return t.parent=e,t},t.enter=e;var n={};t.clear=function(){for(var e in t)n[e]||delete t[e]};for(var r in t)n[r]=!0;return t}}),requireSimulator.setName("Tonyu.Compiler"),define(["Tonyu","ObjectMatcher","TError"],function(e){function t(e,t){var n={type:e};if(t)for(var r in t)n[r]=t[r];return n.name||(n.name=o("_"+e+"_")),n}function n(e){return e?e.type:null}function r(e){var t=function(){};return t.prototype=e,new t}function i(e,t){if(!e)throw t+" is null";return e}function o(e){return e+(d++ +"").replace(/\./g,"")}function a(e,t,n){t._id||(t._id=++h);var r=e[t._id];if(r||(r=e[t._id]={node:t}),r.node!==t)throw console.log("NOMATCH",r.node,t),new Error("annotation node not match!");if(n)for(var i in n)r[i]=n[i];return r}function s(e,t){return e.substring(t.pos,t.pos+t.len)}function u(e,t){var n=null;return c(e).forEach(function(e){n||(n=e.decls.methods[t])}),n}function c(e){function t(i){if(!n[i.fullName]){if(n[i.fullName]=!0,i.isShim)throw console.log(e,"contains shim ",i),new Error("Contains shim");r.push(i),i.superclass&&t(i.superclass),i.includes&&i.includes.forEach(t)}}var n={},r=[];return t(e),r}function l(e){var t=[];if(!e.head)return t;e.head.setter&&t.push(e.head.setter.value);var n=e.head.params?e.head.params.params:null;if(n&&!n.forEach)throw new Error(e+" is not array ");return n&&(t=t.concat(n)),t}var f={};e.Compiler=f;var p={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PROP:"property",PARAM:"param",GLOBAL:"global",CLASS:"class",MODULE:"module"};f.ScopeTypes=p;var h=1,d=1;return f.newScopeType=t,f.getScopeType=n,f.newScope=r,f.nullCheck=i,f.genSym=o,f.extend=function(e,t){for(var n in t)e[n]=t[n];return e},f.annotation=a,f.getSource=s,f.getField=function(t,n){if(t instanceof Function)return null;var r=null;return c(t).forEach(function(e){r||(r=e.decls.fields[n])}),"string"==typeof r.vtype&&(r.vtype=e.classMetas[r.vtype]||window[r.vtype]),r},f.getMethod=u,f.getDependingClasses=c,f.getParams=l,f}),requireSimulator.setName("Tonyu.Compiler.JSGenerator"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler","assert"],function(e,t,n,r,i,o,a,s,u,c){return u.JSGenerator=function(){function e(e,D){function R(e){return u.getSource(K,e)}function L(t,n){return C(e.annotation,t,n)}function N(e){return"string"==typeof e?w+(D.aliases[e]||e):e.builtin?e.fullName:w+e.fullName}function B(e){var t=[];return e.forEach(function(e){t.push(N(e))}),t}function _(e,t){return function(){X.enter(e,function(){v.visit(t)})}}function O(e,r,i){var o=k(r);if(o==ot.THVAR)Q.printf("%s",t);else if(o==ot.FIELD||o==ot.PROP)Q.printf("%s.%s",n,e);else if(o==ot.METHOD)i&&i.noBind?Q.printf("%s.%s",n,e):Q.printf("%s(%s,%s.%s)",g,n,n,e);else if(o==ot.CLASS)Q.printf("%s",N(e));else if(o==ot.GLOBAL)Q.printf("%s%s",S,e);else{if(o!=ot.PARAM&&o!=ot.LOCAL&&o!=ot.NATIVE&&o!=ot.MODULE)throw console.log("Unknown scope type: ",o),new Error("Unknown scope type: "+o);Q.printf("%s",e)}return r}function I(e){return function(){F.apply(this,[e])}}function F(e){"compound"==e.type?X.enter({noWait:!0},function(){Q.printf("%j%n",["%n",e.stmts])}):v.visit(e)}function j(t){return function(){X.noLastPos||Q.printf("%s%s=%s;//%s%n",D.options.compiler.commentLastPos?"//":"",h,nt.add(e,t.pos),e.fullName+":"+t.pos)}}function V(){X.enter({},function(){if(ut){Y("define(function (require) {%{");var t={Tonyu:1};for(var n in e.decls.amds)t[n]=1;if(e.superclass){var n=e.superclass.shortName;t[n]=1}(e.includes||[]).forEach(function(e){var n=e.shortName;t[n]=1});for(var n in e.decls.softRefClasses)t[n]=1;for(var n in t)Y("var %s=require('%s');%n",n,n)}Y((ut?"return ":"")+"Tonyu.klass.define({%{"),Y("fullName: %l,%n",e.fullName),Y("shortName: %l,%n",e.shortName),Y("namespace: %l,%n",e.namespace),e.superclass&&Y("superclass: %s,%n",N(e.superclass)),Y("includes: [%s],%n",B(e.includes).join(",")),Y("methods: function (%s) {%{",P),Y("return {%{");for(var r in it){et&&console.log("method1",r);var i=it[r];i.params||console.log("MYSTERY2",i.params,it,e,D),X.enter({noWait:!0,threadAvail:!1},function(){W(i)}),et&&console.log("method2",r),i.nowait||X.enter({noWait:!1,threadAvail:!0},function(){U(i)}),et&&console.log("method3",r)}Y("__dummy: false%n"),Y("%}};%n"),Y("%}},%n"),Y("decls: %s%n",JSON.stringify($(e))),Y("%}});"),ut&&Y("%n%}});")})}function $(e){var t={methods:{},fields:{}};for(var n in e.decls.methods)t.methods[n]={nowait:!!e.decls.methods[n].nowait};for(var n in e.decls.fields){var r=e.decls.fields[n],i={};r.vtype&&(i.vtype="string"==typeof r.vtype?r.vtype:r.vtype.fullName||r.vtype.name),t.fields[n]=i}return t}function U(e){function r(){X.enter({method:e,noWait:!0,threadAvail:!0},function(){a.forEach(function(e){Y("%v%n",e)})})}function i(){X.enter({method:e,finfo:e,pc:1},function(){s.forEach(function(e){Y("%v%n",e)})})}if(!H(e)){var o=e.stmts,a=[],s=[],u=a,c=!0;c?o.forEach(function(e){L(e).fiberCallRequired&&(u=s),u.push(e)}):s=o,Y("%s%s :function %s(%j) {%{"+A+"var %s=%s;%n%svar %s=%s;%nvar %s=0;%n%f%n%f%n",f,e.name,G(e.pos,"f_"+e.name),[",",[lt].concat(e.params)],n,x,e.useArgs?"":"//",l,"Tonyu.A(arguments)",p,z(e),r),s.length>0?Y("%s.enter(function %s(%s) {%{if (%s.lastEx) %s=%s.catchPC;%nfor(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}});%n",t,G(e.pos,"ent_"+e.name),t,t,p,t,d,m,d,p,i,t,n):Y("%s.retVal=%s;return;%n",t,n),Y("%}},%n")}}function W(e){function t(){X.enter({method:e,finfo:e},function(){e.stmts.forEach(function(e){Y("%v%n",e)})})}var r=H(e)?"initialize":e.name;e.params||console.log("MYSTERY",e.params),Y("%s :function %s(%j) {%{"+A+"var %s=%s;%n%f%n%f%}},%n",r,G(e.pos,r),[",",e.params],n,x,z(e),t)}function q(e){function t(){X.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){Y("%v%n",e)})})}var n=L(e).info;Q.printf("(function %s(%j) {%{%f%n%f%}})",n.name,[",",n.params],z(n),t)}function G(t,n){return n||(n=at++ +""),"_trc_"+e.shortName+"_"+n}function Z(e){function t(){X.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){Y("%v%n",e)})})}var n=L(e).info;Q.printf("function %s(%j) {%{%f%n%f%}}",n.name,[",",n.params],z(n),t)}function z(e){function t(){X.enter({},function(){for(var t in e.locals.varDecls)Q.printf("var %s;%n",t);for(var t in e.locals.subFuncDecls)Z(e.locals.subFuncDecls[t])})}return t}function H(e){return tt.match(e,{ftype:"constructor"})||tt.match(e,{name:"new"})}var J=e.src.tonyu,K=J.text(),Q=D.codeBuffer||o({fixLazyLength:6});Q.setSrcFile(J);var Y=Q.printf,X=a(),et=!1,tt=r,nt=D.traceTbl,rt=e.decls,it=(rt.fields,rt.methods),ot=(rt.natives,M),at=0,st=D.options.compiler.diagnose,ut=D.options.compiler.genAMD,ct=!D.options.compiler.noLoopCheck,lt={type:"THNode"};v=Q.visitor=s({THNode:function(){Q.printf(t)},dummy:function(e){Q.printf("",e)},literal:function(e){Q.printf("%s",e.text)},paramDecl:function(e){Q.printf("%v",e.name)},paramDecls:function(e){Q.printf("(%j)",[", ",e.params])},funcDeclHead:function(e){Q.printf("function %v %v",e.name,e.params)},funcDecl:function(){},"return":function(e){if(X.inTry)throw i("現実装では、tryの中にreturnは書けません",J,e.pos);if(X.noWait)X.threadAvail?e.value?Q.printf("%s.retVal=%v;return;%n",t,e.value):Q.printf("%s.retVal=%s;return;%n",t,n):e.value?Q.printf("return %v;",e.value):Q.printf("return %s;",n);else if(e.value){var r=L(e.value).fiberCall;r?Q.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%s.exit(%s.retVal);return;%n",n,f,r.N,[", ",[lt].concat(r.A)],p,X.pc,X.pc++,t,t):Q.printf("%s.exit(%v);return;",t,e.value)}else Q.printf("%s.exit(%s);return;",t,n)},program:function(e){genClass(e.stmts)},number:function(e){Q.printf("%s",e.value)},reservedConst:function(e){"this"==e.text?Q.printf("%s",n):"arguments"==e.text&&X.threadAvail?Q.printf("%s",l):e.text==t?Q.printf("%s",X.threadAvail?t:"null"):Q.printf("%s",e.text)},varDecl:function(e){var r=L(e),i=r.varInMain?n+".":"";if(e.value){var o=!X.noWait&&L(e).fiberCall;o?(c.is(X.pc,Number),Q.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%s%v=%s.retVal;%n",n,f,o.N,[", ",[lt].concat(o.A)],p,X.pc,X.pc++,i,e.name,t)):Q.printf("%s%v = %v;%n",i,e.name,e.value)}},varsDecl:function(e){var t=e.decls.filter(function(e){return e.value});t.length>0&&(j(e)(),t.forEach(function(e){Q.printf("%v",e)}))},jsonElem:function(e){e.value?Q.printf("%v: %v",e.key,e.value):Q.printf("%v: %f",e.key,function(){O(e.key.text,L(e).scopeInfo,L(e))})},objlit:function(e){Q.printf("{%j}",[",",e.elems])},arylit:function(e){Q.printf("[%j]",[",",e.elems])},funcExpr:function(e){q(e)},parenExpr:function(e){Q.printf("(%v)",e.expr)},varAccess:function(e){{var t=e.name.text;O(t,L(e).scopeInfo,L(e))}},exprstmt:function(e){var r={};if(j(e)(),X.noWait||(r=L(e).fiberCall||{}),"noRet"==r.type)Q.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{",n,f,r.N,[", ",[lt].concat(r.A)],p,X.pc,X.pc++);else if("ret"==r.type)Q.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",n,f,r.N,[", ",[lt].concat(r.A)],p,X.pc,X.pc++,r.L,r.O,t);else if("noRetSuper"==r.type){var i=P;Q.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{",i,f,r.S.name.text,n,[", ",[lt].concat(r.A)],p,X.pc,X.pc++)}else if("retSuper"==r.type){var i=P;Q.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",i,f,r.S.name.text,n,[", ",[lt].concat(r.A)],p,X.pc,X.pc++,r.L,r.O,t)}else Q.printf("%v;",e.expr)},infix:function(e){var t=e.op.text;if(st){if("+"==t||"-"==t||"*"==t||"/"==t||"%"==t)return void Q.printf("%s(%v,%l)%v%s(%v,%l)",T,e.left,R(e.left),e.op,T,e.right,R(e.right));if("+="==t||"-="==t||"*="==t||"/="==t||"%="==t)return void Q.printf("%v%v%s(%v,%l)",e.left,e.op,T,e.right,R(e.right))}"is"===e.op.type?Q.printf("Tonyu.is(%v,%v)",e.left,e.right):Q.printf("%v%v%v",e.left,e.op,e.right)},trifixr:function(e){Q.printf("%v%v%v%v%v",e.left,e.op1,e.mid,e.op2,e.right)},prefix:function(e){if("__typeof"===e.op.text){var t=L(e.right);return void(t.vtype?Q.printf("%l",t.vtype.name||t.vtype.fullName||"No type name?"):Q.printf("%l","Any"))}Q.printf("%v %v",e.op,e.right)},postfix:function(e){var t=L(e);if(st){if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=k(i);return void(o==ot.FIELD||o==ot.PROP||o==ot.METHOD?Q.printf("%s(%s, %l, [%j], %l )",y,n,r.name,[",",r.args],"this"):Q.printf("%s(%v, [%j], %l)",b,e.left,[",",r.args],R(e.left)))}if(t.othersMethodCall){var a=t.othersMethodCall;return void Q.printf("%s(%v, %l, [%j], %l )",y,a.target,a.name,[",",a.args],R(a.target))}if(t.memberAccess){var s=t.memberAccess;return void Q.printf("%s(%v,%l).%s",T,s.target,R(s.target),s.name)}}else if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=k(i);if(o==ot.METHOD)return void Q.printf("%s.%s(%j)",n,r.name,[",",r.args])}Q.printf("%v%v",e.left,e.op)},"break":function(e){if(X.noWait)Q.printf("break;%n");else{if(X.inTry&&X.exitTryOnJump)throw i("現実装では、tryの中にbreak;は書けません",J,e.pos);if(!X.closestBrk)throw i("break； は繰り返しの中で使います",J,e.pos);Q.printf("%s=%z; break;%n",p,X.closestBrk)}},"continue":function(e){if(X.noWait)Q.printf("continue;%n");else{if(X.inTry&&X.exitTryOnJump)throw i("現実装では、tryの中にcontinue;は書けません",J,e.pos);if("number"==typeof X.closestCnt)Q.printf("%s=%s; break;%n",p,X.closestCnt);else{if(!X.closestCnt)throw i("continue； は繰り返しの中で使います",J,e.pos);Q.printf("%s=%z; break;%n",p,X.closestCnt)}}},"try":function(e){var n=L(e);if(!X.noWait&&(n.fiberCallRequired||n.hasJump||n.hasReturn)){if(1!=e.catches.length||"catch"!=e.catches[0].type)throw i("現実装では、catch節1個のみをサポートしています",J,e.pos);var r=e.catches[0],o={},a={};Q.printf("%s.enterTry(%z);%n",t,o),Q.printf("%f",_({inTry:!0,exitTryOnJump:!0},e.stmt)),Q.printf("%s.exitTry();%n",t),Q.printf("%s=%z;break;%n",p,a),Q.printf("%}case %f:%{",function(){Q.print(o.put(X.pc++))}),Q.printf("%s=%s.startCatch();%n",r.name.text,t),Q.printf("%v%n",r.stmt),Q.printf("%}case %f:%{",function(){Q.print(a.put(X.pc++))})}else X.enter({noWait:!0},function(){Q.printf("try {%{%f%n%}} ",I(e.stmt)),e.catches.forEach(v.visit)})},"catch":function(e){Q.printf("catch (%s) {%{%f%n%}}",e.name.text,I(e.stmt))},"throw":function(e){Q.printf("throw %v;%n",e.ex)},"switch":function(e){if(X.noWait)Q.printf("switch (%v) {%{%j"+(e.defs?"%n%v":"%D")+"%n%}}",e.value,["%n",e.cases],e.defs);else{var t=e.cases.map(function(){return Q.lazy()});e.defs&&t.push(Q.lazy());var n=Q.lazy();Q.printf("switch (%v) {%{%f%n%}}%nbreak;%n",e.value,function(){var r=0;e.cases.forEach(function(e){Q.printf("%}case %v:%{%s=%z;break;%n",e.value,p,t[r]),r++}),e.defs?Q.printf("%}default:%{%s=%z;break;%n",p,t[r]):Q.printf("%}default:%{%s=%z;break;%n",p,n)}),X.enter({closestBrk:n},function(){var r=0;e.cases.forEach(function(e){Q.printf("%}case %f:%{%j%n",function(){Q.print(t[r].put(X.pc++))},["%n",e.stmts]),r++}),e.defs&&Q.printf("%}case %f:%{%j%n",function(){Q.print(t[r].put(X.pc++))},["%n",e.defs.stmts]),Q.printf("case %f:%n",function(){Q.print(n.put(X.pc++))})})}},"case":function(e){Q.printf("%}case %v:%{%j",e.value,["%n",e.stmts])},"default":function(e){Q.printf("%}default:%{%j",["%n",e.stmts])},"while":function(e){j(e)();var t=L(e);if(X.noWait||!t.fiberCallRequired&&!t.hasReturn)X.enter({noWait:!0},function(){Q.printf("while (%v) {%{"+(ct?"Tonyu.checkLoop();%n":"")+"%f%n%}}",e.cond,I(e.loop))});else{var n=Q.lazy(),r=X.pc++,i="reservedConst"==e.cond.type&&"true"==e.cond.text;Q.printf("%}case %d:%{"+(i?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",r,e.cond,p,n,_({closestBrk:n,closestCnt:r,exitTryOnJump:!1},e.loop),p,r,function(){Q.print(n.put(X.pc++))})}},"do":function(e){j(e)();var t=L(e);if(X.noWait||!t.fiberCallRequired&&!t.hasReturn)X.enter({noWait:!0},function(){Q.printf("do {%{"+(ct?"Tonyu.checkLoop();%n":"")+"%f%n%}} while (%v);%n",I(e.loop),e.cond)});else{var n=Q.lazy(),r=Q.lazy(),i=X.pc++;Q.printf("%}case %d:%{%f%n%}case %f:%{if (%v) { %s=%s; break; }%n%}case %f:%{",i,_({closestBrk:n,closestCnt:r,exitTryOnJump:!1},e.loop),function(){Q.print(r.put(X.pc++))},e.cond,p,i,function(){Q.print(n.put(X.pc++))})}},"for":function(e){function t(e,t,n){return function(){n.forEach(function(t,n){var r=L(t);O(t.text,r.scopeInfo,r),Q.printf("=%s[%s];%n",e,n)})}}j(e)();var n=L(e);if("forin"==e.inFor.type){var r=L(e.inFor).iterName;if(X.noWait||!n.fiberCallRequired&&!n.hasReturn)X.enter({noWait:!0},function(){Q.printf("%s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%f%n%}}",r,E,e.inFor.set,e.inFor.vars.length,r,t(r,e.inFor.isVar,e.inFor.vars),I(e.loop))});else{var i=Q.lazy(),o=X.pc++;Q.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",r,E,e.inFor.set,e.inFor.vars.length,o,r,p,i,t(r,e.inFor.isVar,e.inFor.vars),_({closestBrk:i,closestCnt:o,exitTryOnJump:!1},e.loop),p,o,function(e){e.print(i.put(X.pc++))})}}else if(X.noWait||!n.fiberCallRequired&&!n.hasReturn)X.enter({noWait:!0},function(){"varsDecl"==e.inFor.init.type||"exprstmt"==e.inFor.init.type?Q.printf("%vfor (; %v ; %v) {%{"+(ct?"Tonyu.checkLoop();%n":"")+"%v%n%}}",e.inFor.init,e.inFor.cond,e.inFor.next,e.loop):Q.printf("%v%nwhile(%v) {%{"+(ct?"Tonyu.checkLoop();%n":"")+"%v%n%v;%n%}}",e.inFor.init,e.inFor.cond,e.loop,e.inFor.next)});else{var i=Q.lazy(),a=Q.lazy(),o=X.pc++;Q.printf("%v%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%}case %f:%{%v;%n%s=%s;break;%n%}case %f:%{",e.inFor.init,o,e.inFor.cond,p,i,_({closestBrk:i,closestCnt:a,exitTryOnJump:!1},e.loop),function(e){e.print(a.put(X.pc++))},e.inFor.next,p,o,function(e){e.print(i.put(X.pc++))})}},"if":function(e){j(e)();var t=L(e);if(!X.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)){var n=Q.lazy(),r=Q.lazy();e._else?Q.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",e.cond,p,r,e.then,p,n,function(){Q.print(r.put(X.pc++))},e._else,function(){Q.print(n.put(X.pc++))}):Q.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",e.cond,p,n,e.then,function(){Q.print(n.put(X.pc++))})}else X.enter({noWait:!0},function(){e._else?Q.printf("if (%v) {%{%f%n%}} else {%{%f%n%}}",e.cond,I(e.then),I(e._else)):Q.printf("if (%v) {%{%f%n%}}",e.cond,I(e.then))})},ifWait:function(e){X.noWait?e._else&&Q.printf("%v",e._else):Q.printf("%v",e.then)},empty:function(){Q.printf(";%n")},call:function(e){Q.printf("(%j)",[",",e.args])},objlitArg:function(e){Q.printf("%v",e.obj)},argList:function(e){Q.printf("%j",[",",e.args])},newExpr:function(e){var t=e.params;t?Q.printf("new %v%v",e.klass,t):Q.printf("new %v",e.klass)},scall:function(e){Q.printf("[%j]",[",",e.args])},superExpr:function(e){var t;e.name?(t=e.name.text,Q.printf("%s.prototype.%s.apply( %s, %v)",P,t,n,e.params)):Q.printf("%s.apply( %s, %v)",P,n,e.params)},arrayElem:function(e){Q.printf("[%v]",e.subscript)},member:function(e){Q.printf(".%s",e.name)},symbol:function(e){Q.print(e.text)},normalFor:function(e){Q.printf("%v; %v; %v",e.init,e.cond,e.next)},compound:function(e){var t=L(e);!X.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)?Q.printf("%j",["%n",e.stmts]):X.enter({noWait:!0},function(){Q.printf("{%{%j%n%}}",["%n",e.stmts])})},"typeof":function(){Q.printf("typeof ")},"instanceof":function(){Q.printf(" instanceof ")},is:function(){Q.printf(" instanceof ")},regex:function(e){Q.printf("%s",e.text)}});var ft=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>>",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];ft.forEach(function(e){v.funcs[e]=function(){Q.printf("%s",e)}}),v.def=function(e){throw console.log("Err node="),console.log(e),new Error(e.type+" is not defined in visitor:compiler2")},v.cnt=0,V(),ut?(e.src.js=e.src.tonyu.up().rel(e.src.tonyu.truncExt()+".js"),e.src.js.text(Q.buf)):e.src.js=Q.buf,delete e.jsNotUpToDate,et&&console.log("method4",Q.buf);var pt=Q.close();return e.src.map=Q.mapStr,pt}{var t="_thread",n="_this",l="_arguments",f="fiber$",p="__pc",h="$LASTPOS",d="__cnt",m=100,g="Tonyu.bindFunc",y="Tonyu.invokeMethod",b="Tonyu.callFunc",T="Tonyu.checkNonNull",w="Tonyu.classes.",S="Tonyu.globals.",x="this",A='"use strict";%n',E="Tonyu.iterator",P="__superClass",M=u.ScopeTypes,k=u.getScopeType,C=u.annotation;u.getMethod,u.getDependingClasses,u.getParams}return{genJS:e}}()}),requireSimulator.setName("Tonyu.Compiler.Semantics"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(e,t,n,r,i,o,a,s,u){return u.Semantics=function(){function t(e){var t=this;if(e&&"object"==typeof e){var n;if(n=e instanceof Array?e:e[Grammar.SUBELEMENTS],!n){n=[];for(var r in e)n.push(e[r])}n.forEach(function(e){t.visit(e)})}}function o(e,o){function a(n){function r(t,n){n=n||t,f[t+""]={node:n,klass:e.fullName,name:t+"",pos:n.pos}}var a,u=o.options.compiler.defaultSuperClass,d=0;if((a=g.match(n,{ext:{superclassName:{text:g.N,pos:g.P}}}))&&(u=a.N,d=a.P,"null"==u&&(u=null)),e.includes=[],(a=g.match(n,{incl:{includeClassNames:g.C}}))&&a.C.forEach(function(t){var n=t.text,r=t.pos,a=o.classes[o.aliases[n]||n];if(!a)throw i("クラス "+n+"は定義されていません",c,r);e.includes.push(a)}),"Array"==u)e.superclass={name:"Array",fullName:"Array",builtin:!0};else if(u){var m=o.classes[o.aliases[u]||u];if(!m)throw i("親クラス "+u+"は定義されていません",c,d);e.superclass=m}else delete e.superclass;e.directives={};var v=s({varDecl:function(e){r(e.name,e)},nativeDecl:function(){},funcDecl:function(){},funcExpr:function(){},"catch":function(){},exprstmt:function(t){"literal"===t.expr.type&&t.expr.text.match(/^.field strict.$/)&&(e.directives.field_strict=!0)},forin:function(e){var t=e.isVar;t&&e.vars.forEach(function(e){r(e)})}});v.def=t,v.visit(n.stmts),n.stmts.forEach(function(t){if("funcDecl"==t.type){var n=t.head,r="function";n.ftype&&(r=n.ftype.text);var i=n.name.text,o=n.params?"":n.setter?"__setter__":"__getter__";i=o+i,p[i]={nowait:!!n.nowait||""!==o,ftype:r,name:i,klass:e.fullName,head:n,pos:n.pos,stmts:t.body.stmts,node:t}}else"nativeDecl"==t.type?h[t.name.text]=t:l.stmts.push(t)})}var u,c=e.src.tonyu;e.hasSemanticError=!0,e.src&&e.src.js&&(e.jsNotUpToDate=!0),e.node&&e.nodeTimestamp==c.lastUpdate()&&(u=e.node),u||(console.log("Parse "+c),u=n.parse(c),e.nodeTimestamp=c.lastUpdate());var l={name:"main",stmts:[],pos:0,isMain:!0},f={},p={main:l},h={},d={},m={};e.decls={fields:f,methods:p,natives:h,amds:d,softRefClasses:m},e.node=u;var g=r;a(u)}function c(n,o){function c(e){return u.getSource($,e)}function T(e,t){return m(n.annotation,e,t)}function w(t){if(!t.builtin){var n=Z,r=t.decls;r||console.log("DECLNUL",t);var i;for(i in r.fields){var o=r.fields[i];n[i]=f(G.FIELD,{klass:t.fullName,name:i,info:o}),o.node&&T(o.node,{info:o})}for(i in r.methods){var o=r.methods[i],a=e.klass.propReg.exec(i);a?n[a[2]]=f(G.PROP,{klass:t.fullName,name:a[2],info:o}):n[i]=f(G.METHOD,{klass:t.fullName,name:i,info:o}),o.node&&T(o.node,{info:o})}}}function S(){var e=Z;v(n).forEach(w);var t=n.decls;for(var r in t.natives)e[r]=f(G.NATIVE,{name:"native::"+r,value:window[r]});for(var r in b)e[r]=f(G.NATIVE,{name:"native::"+r,value:window[r]});for(var r in o.aliases){var i=o.aliases[r];e[r]=f(G.CLASS,{name:r,fullName:i,info:o.classes[i]})}}function x(){var e=v(n);for(var t in n.decls.methods){var r=n.decls.methods[t];e.forEach(function(e){var n=e.decls.methods[t];n&&n.nowait&&(r.nowait=!0)})}}function A(e){return g(n,e)}function E(e){return p(z.scope[e])==G.METHOD&&!A(e).nowait}function P(e){if("varAccess"==e.type||"postfix"==e.type&&("member"==e.op.type||"arrayElem"==e.op.type))return"varAccess"==e.type&&T(e,{noBind:!0}),!0;throw console.log("LVal",e),i("'"+c(e)+"'は左辺には書けません．",V,e.pos)}function M(e){var t=e;e+="";var r=z.scope[e],a=p(r);if(!a){if(o.amdPaths&&o.amdPaths[e])a=G.MODULE,n.decls.amds[e]=o.amdPaths[e];else{var s=e.match(/^\$/);if((o.options.compiler.field_strict||n.directives.field_strict)&&!s)throw new i(e+"は宣言されていません（フィールドの場合，明示的に宣言してください）．",V,t.pos);a=s?G.GLOBAL:G.FIELD}var c={name:e};a==G.FIELD&&(c.klass=n.name,n.decls.fields[e]=n.decls.fields[e]||{},u.extend(n.decls.fields[e],{klass:n.fullName,name:e})),r=Z[e]=f(a,c)}return a==G.CLASS&&(n.decls.softRefClasses[e]=r),r}function k(e){var t={varDecls:{},subFuncDecls:{}};return z.enter({locals:t},function(){nt.visit(e)}),t}function C(e,t){e.forEach(function(e){T(e,t)})}function D(e){z.method&&(z.method.fiberCallRequired=!0),C(e,{fiberCallRequired:!0})}function R(e){var t=(e.name+"",M(e.name)),n=p(t);n===G.NATIVE?T(e,{resolvedType:t.value}):n===G.CLASS&&T(e,{resolvedType:t.info})}function L(e,t){z.enter({scope:t},function(){rt.visit(e)})}function N(e,t){var n=e.locals;for(var r in n.varDecls){var i=f(G.LOCAL,{declaringFunc:e});t[r]=i,T(n.varDecls[r],{scopeInfo:i})}for(var r in n.subFuncDecls){var i=f(G.LOCAL,{declaringFunc:e});t[r]=i,T(n.subFuncDecls[r],{scopeInfo:i})}}function B(e){e.forEach(function(e){e.typeDecl&&R(e.typeDecl.vtype)})}function _(e){z.enter({isMain:e.isMain,finfo:e},function(){e.locals=k(e.stmts),e.params=y(e)}),B(e.params)}function O(e){var t,n,r=e.body,i=e.head.name?e.head.name.text:"anonymous_"+e.pos;n=(t=U.match(e,{head:{params:{params:U.P}}}))?t.P:[];var o={},a=h(z.scope);return z.enter({finfo:o},function(){n.forEach(function(e){var t=f(G.PARAM,{declaringFunc:o});T(e,{scopeInfo:t}),a[e.name.text]=t}),o.locals=k(r),N(o,a),L(r,a)}),o.scope=a,o.name=i,o.params=n,B(o.params),T(e,{info:o}),I(o.locals,a),o}function I(e,t){z.enter({scope:t},function(){for(var t in e.subFuncDecls)O(e.subFuncDecls[t])})}function F(e){var t=h(z.scope);return e.params.forEach(function(r,i){var o=f(G.PARAM,{klass:n.name,name:e.name,no:i,declaringFunc:e});t[r.name.text]=o,T(r,{scopeInfo:o,declaringFunc:e})}),N(e,t),z.enter({method:e,finfo:e,noWait:!1},function(){L(e.stmts,t)}),e.scope=t,I(e.locals,t),t}function j(){z.enter({scope:Z},function(){for(var e in q){H&&console.log("anon method1",e);var t=q[e];_(t),F(t)}})}n.hasSemanticError=!0;var V=n.src.tonyu,$=V.text(),U=r,W=(o.traceTbl,n.decls),q=(W.fields,W.methods),G=(W.natives,W.amds,l),Z={},z=a(),H=!1,J={type:"postfix",left:{type:"postfix",left:U.T,op:{type:"member",name:{text:U.N}}},op:{type:"call",args:U.A}},K={type:"postfix",left:U.T,op:{type:"member",name:{text:U.N}}},Q=fiberCallTmpl={type:"postfix",left:{type:"varAccess",name:{text:U.N}},op:{type:"call",args:U.A}},Y={expr:fiberCallTmpl},X={expr:{type:"infix",op:U.O,left:U.L,right:fiberCallTmpl}},et={expr:{type:"superExpr",params:{args:U.A},$var:"S"}},tt={expr:{type:"infix",op:U.O,left:U.L,right:{type:"superExpr",params:{args:U.A},$var:"S"}}};n.annotation={};var nt=s({varDecl:function(e){z.isMain?(T(e,{varInMain:!0}),T(e,{declaringClass:n})):(z.locals.varDecls[e.name.text]=e,T(e,{declaringFunc:z.finfo}))},funcDecl:function(e){z.locals.subFuncDecls[e.head.name.text]=e},funcExpr:function(){},"catch":function(e){z.locals.varDecls[e.name.text]=e},exprstmt:function(){},forin:function(e){var t=e.isVar;e.vars.forEach(function(e){t&&(z.isMain?(T(e,{varInMain:!0}),T(e,{declaringClass:n})):(z.locals.varDecls[e.text]=e,T(e,{declaringFunc:z.finfo})))});var r=d("_it_");T(e,{iterName:r}),z.locals.varDecls[r]=e}});nt.def=t;var rt=s({varAccess:function(e){{var t=M(e.name);p(t)}T(e,{scopeInfo:t})},funcDecl:function(){},funcExpr:function(e){O(e)},objlit:function(e){var t=this,n={};e.elems.forEach(function(e){var r;if(r="literal"==e.key.type?e.key.text.substring(1,e.key.text.length-1):e.key.text,n[r])throw i("オブジェクトリテラルのキー名'"+r+"'が重複しています",V,e.pos);n[r]=1,t.visit(e)})},jsonElem:function(e){if(e.value)this.visit(e.value);else{if("literal"==e.key.type)throw i("オブジェクトリテラルのパラメタに単独の文字列は使えません",V,e.pos);var t=M(e.key);T(e,{scopeInfo:t})}},"do":function(e){var t=this;z.enter({brkable:!0,contable:!0},function(){t.def(e)})},"switch":function(e){var t=this;z.enter({brkable:!0},function(){t.def(e)})},"while":function(e){var t=this;z.enter({brkable:!0,contable:!0},function(){t.def(e)}),D(this.path)},"for":function(e){var t=this;z.enter({brkable:!0,contable:!0},function(){t.def(e)})},forin:function(e){e.vars.forEach(function(e){var t=M(e);T(e,{scopeInfo:t})}),this.visit(e.set)},ifWait:function(e){var t="_thread",n=this,r=h(z.scope);r[t]=f(G.THVAR),z.enter({scope:r},function(){n.visit(e.then)}),e._else&&n.visit(e._else),D(this.path)},"try":function(e){z.finfo.useTry=!0,this.def(e)},"return":function(e){var t;z.noWait||((t=U.match(e.value,fiberCallTmpl))&&E(t.N)&&(T(e.value,{fiberCall:t}),D(this.path)),C(this.path,{hasReturn:!0})),this.visit(e.value)},"break":function(e){if(!z.brkable)throw i("break； は繰り返しまたはswitch文の中で使います.",V,e.pos);z.noWait||C(this.path,{hasJump:!0})},"continue":function(e){if(!z.contable)throw i("continue； は繰り返しの中で使います.",V,e.pos);z.noWait||C(this.path,{hasJump:!0})},reservedConst:function(e){"arguments"==e.text&&(z.finfo.useArgs=!0)},postfix:function(e){var t;if(this.visit(e.left),this.visit(e.op),t=U.match(e,Q)){var n=T(e.left).scopeInfo;T(e,{myMethodCall:{name:t.N,args:t.A,scopeInfo:n}})}else(t=U.match(e,J))?T(e,{othersMethodCall:{target:t.T,name:t.N,args:t.A}}):(t=U.match(e,K))&&T(e,{memberAccess:{target:t.T,name:t.N}})},infix:function(e){var t=e.op.text;("="==t||"+="==t||"-="==t||"*="==t||"/="==t||"%="==t)&&P(e.left),this.def(e)},exprstmt:function(e){var t,r;if("objlit"===e.expr.type)throw i("オブジェクトリテラル単独の式文は書けません．",V,e.pos);if(!z.noWait&&(t=U.match(e,Y))&&E(t.N))t.type="noRet",T(e,{fiberCall:t}),D(this.path);else if(!z.noWait&&(t=U.match(e,X))&&E(t.N))t.type="ret",T(e,{fiberCall:t}),D(this.path);else if(!z.noWait&&(t=U.match(e,et))&&t.S.name){if(r=A(t.S.name.text),!r)throw new Error("メソッド"+t.S.name.text+" はありません。");r.nowait||(t.type="noRetSuper",t.superclass=n.superclass,T(e,{fiberCall:t}),D(this.path))}else if(!z.noWait&&(t=U.match(e,tt))&&t.S.name){if(r=A(t.S.name.text),!r)throw new Error("メソッド"+t.S.name.text+" はありません。");r.nowait||(t.type="retSuper",t.superclass=n.superclass,T(e,{fiberCall:t}),D(this.path))}this.visit(e.expr)},varDecl:function(e){var t;!z.noWait&&(t=U.match(e.value,fiberCallTmpl))&&E(t.N)&&(t.type="varDecl",T(e,{fiberCall:t}),D(this.path)),this.visit(e.value),this.visit(e.typeDecl)},typeExpr:function(e){R(e)}});rt.def=t,S(),x(),j(),delete n.hasSemanticError}var l=u.ScopeTypes,f=u.newScopeType,p=u.getScopeType,h=u.newScope,d=u.genSym,m=u.annotation,g=u.getMethod,v=u.getDependingClasses,y=u.getParams,b={Array:1,String:1,Boolean:1,Number:1,Void:1,Object:1,RegExp:1,Error:1,Date:1};return{initClassDecls:o,annotate:c}}()}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/(_trc_[A-Za-z0-9_]*).*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(e){var t=e.stack;if("string"!=typeof t)return!1;for(var n=t.split(/\n/),r=[],i=0;i<n.length;i++){var o=pat.exec(n[i]);if(o){var a=o[1],s=o[2],u=o[3];r.push({fname:a,row:s,col:u})}}return console.log("StackTrace.get",r),r},trc}),requireSimulator.setName("Tonyu.TraceTbl"),define(["Tonyu","FS","TError","StackTrace"],function(e,t,n,r){return e.TraceTbl=function(){var e={},i=1e6,o=1,a=1e4,s={},u=[],c={};e.add=function(e,t){var n=e.src.tonyu,r=n.path(),l=s[r];void 0==l&&(l=o++,o>a&&(o=0),s[r]=l,u[l]=r),c[r]=e,t>=i&&(t=i-1);var f=l*i+t;return f};var l={};return e.decodeOLD=function(e){var r=e%i,o=(e-r)/i,a=u[o];if(a){var s=t.get(a),l=c[a];return n("Trace info",l||s,r)}return null},e.srcMap=l,e.decode=function(e){var t=new RegExp("LASTPOS="+e+";//(.*)\r?\n");console.log("pat=",t);for(var n in l){var r=t.exec(l[n]);if(r)return r[1];console.log("pat=",t,"Not found in ",n)}},e.find=function(e){var t=r.get(e),n=t[0];if(!n)return null;var i=new RegExp("LASTPOS=[0-9]+;//(.*)\r?");for(var o in l){console.log("Finding ",n.fname," in ",o);var a=l[o].indexOf(n.fname);if(a>=0){console.log("fname found at ",a);var s=l[o].split(/\n/),u=n.row-1;console.log("Scan from row=",u);for(var c=u;c>=0&&(console.log("row ",c,s[c]),null!=s[c]);c--){var f=i.exec(s[c]);if(f)return f[1]}console.log("Not found LASTPOS pat")}else console.log("Not found in ",o)}},e.addSource=function(e,t){l[e]=t},e}()}),requireSimulator.setName("compiledProject"),define(["DeferredUtil","WebSite","assert"],function(e,t,n){var r=function(r,i){return n.is(arguments,[String,String]),{getNamespace:function(){return r},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(t){var n=e.directPromise(),r=this.getNamespace();return this.getDependingProjects().forEach(function(e){e.getNamespace()!=r&&(n=n.then(function(){return e.loadClasses(t)}))}),n},loadClasses:function(e){console.log("Loading compiled classes ns=",r,"url=",i);var n=i+("BA"===t.serverType?"?"+Math.random():""),o=(window.navigator.userAgent.toLowerCase(),this);return this.loadDependingClasses(e).then(function(){return o.requirejs(n)}).then(function(){console.log("Done Loading compiled classes ns=",r,"url=",n,Tonyu.classes)})},requirejs:function(t){return e.promise(function(e){var n=document.getElementsByTagName("head")[0]||document.documentElement,r=document.createElement("script");"string"==typeof tonyu_app_version&&(t+="?"+tonyu_app_version),r.src=t;var i=!1;r.onload=r.onreadystatechange=function(){i||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(i=!0,console.log("Done load ",t),r.onload=r.onreadystatechange=null,n&&r.parentNode&&n.removeChild(r),e())},n.insertBefore(r,n.firstChild)})},loadClassesOLD:function(e){console.log("Load compiled classes ns=",r,"url=",i);var n=new $.Deferred,o=document.getElementsByTagName("head")[0]||document.documentElement,a=document.createElement("script");a.src=i+("BA"===t.serverType?"?"+Math.random():"");var s=!1;return a.onload=a.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,a.onload=a.onreadystatechange=null,o&&a.parentNode&&o.removeChild(a),console.log("Done Load compiled classes ns=",r,"url=",i,Tonyu.classes),n.resolve())
},this.loadDependingClasses(e).then(function(){o.insertBefore(a,o.firstChild)}),n.promise()}}};return r}),requireSimulator.setName("TypeChecker"),"function"!=typeof define&&(define=require("requirejs").define),define(["Visitor","Tonyu.Compiler","context"],function(e,t,n){function r(e){var t=this;if(e&&"object"==typeof e){var n;if(n=e instanceof Array?e:e[Grammar.SUBELEMENTS],!n){n=[];for(var r in e)n.push(e[r])}n.forEach(function(e){t.visit(e)})}}var i=t.ScopeTypes,o=(t.newScopeType,t.getScopeType,t.newScope,t.genSym,t.annotation),a=(t.getMethod,t.getDependingClasses,t.getParams,{});return a.checkTypeDecl=function(t){function n(e,n){return o(t.annotation,e,n)}var i=e({varDecl:function(e){if(e.value&&this.visit(e.value),e.name&&e.typeDecl){var t=n(e.typeDecl.vtype);console.log("var typeis",e.name+"",e.typeDecl.vtype,t.resolvedType);var r=n(e),i=r.scopeInfo,o=r.info;i?(console.log("set var type",e.name+"",t.resolvedType),i.vtype=t.resolvedType):o&&(console.log("set fld type",e.name+"",t.resolvedType),o.vtype=t.resolvedType)}},paramDecl:function(e){if(e.name&&e.typeDecl){console.log("param typeis",e.name+"",e.typeDecl.vtype+"");var t=n(e.typeDecl.vtype),r=n(e),i=r.scopeInfo;i&&t.resolvedType&&(console.log("set param type",e.name+"",e.typeDecl.vtype+""),i.vtype=t.resolvedType)}},funcDecl:function(e){var t=e.head,r=n(e).info;t.rtype&&(console.log("ret typeis",t.name+"",t.rtype.vtype+""),r.rtype=t.rtype.vtype),this.visit(t),this.visit(e.body)}});i.def=r,i.visit(t.node)},a.checkExpr=function(a){function s(e,t){return o(a.annotation,e,t)}function u(e){c.visit(e);var t=s(e);return t.vtype}{var c=e({number:function(e){s(e,{vtype:Number})},literal:function(e){s(e,{vtype:String})},postfix:function(e){var n=s(e);if(n.memberAccess){var r=n.memberAccess,i=u(r.target);if(i){var o=t.getField(i,r.name);console.log("GETF",i,r.name,o),o&&o.vtype&&s(e,{vtype:o.vtype})}}else this.visit(e.left),this.visit(e.op)},varAccess:function(e){var t=s(e),n=t.scopeInfo;if(n)if(n.vtype)console.log("VA typeof",e.name+":",n.vtype),s(e,{vtype:n.vtype});else if(n.type===i.FIELD){var r;if(r=a.decls.fields[e.name+""],!r)return void console.log("TC Warning: fld not found",a,e.name+"");var o=r.vtype;o?(s(e,{vtype:o}),console.log("VA typeof",e.name+":",o)):console.log("VA vtype not found",e.name+":",r)}else n.type===i.PROP}});n()}c.def=r,c.visit(a.node)},a}),requireSimulator.setName("ProjectCompiler"),define(["Tonyu","Tonyu.Compiler.JSGenerator","Tonyu.Compiler.Semantics","Tonyu.TraceTbl","FS","assert","DeferredUtil","compiledProject","source-map","TypeChecker"],function(e,t,n,r,i,o,a,s,u){var c=function(r){function l(t){var n=h.env;return t||(t={}),t.visited||(t={visited:{},classes:n.classes=n.classes||e.classMetas,options:t}),t}function f(e){function t(t){var n=t.superclass,i=n?[n]:[];return t.includes&&(i=i.concat(t.includes)),i=i.filter(function(t){return t&&e[t.fullName]&&!t.builtin&&!r[t.fullName]})}function n(e){function n(e){if(o.push(e.fullName),a[e.fullName])throw TError("次のクラス間に循環参照があります: "+o.join("->"),"不明",0);a[e.fullName]=!0}function r(){var e=o.pop();delete a[e]}function i(e){n(e);var o=t(e);o.forEach(i),r()}var o=[],a={};i(e)}var r={},i=[],o=0;for(var a in e)r[a]=!1,o++;for(;i.length<o;){var s=i.length;for(var a in e)if(!r[a]){var u=e[a],c=t(u);0==c.length&&(i.push(u),r[a]=!0)}if(i.length==s){var l=[];for(var a in e)if(!r[a]){l=n(e[a])||[];break}throw TError("次のクラス間に循環参照があります: "+l.join("->"),"不明",0)}}return i}function p(e){console.log("evalFile: "+e.path());var t=new Function(e.text());return d.addSource(e.path(),t+""),a.directPromise(t())}o(i.isFile(r)&&r.isDir(),"projectCompiler: "+r+" is not dir obj");var h={env:{}},d=e.TraceTbl,m=a.throwF;return h.env.traceTbl=d,h.EXT=".tonyu",h.getDir=function(){return r},h.getOptionsFile=function(){var e=r.rel("options.json");return e},h.getOptions=function(){var e=h.env;e.options={};var t=h.getOptionsFile();return t.exists()&&(e.options=t.obj()),h.fixOptions(e.options),e.options},h.fixOptions=function(e){e.compiler||(e.compiler={})},h.setOptions=function(e){h.getOptionsFile().obj(e)},h.getEXT=function(){var e=h.getOptions();return h.EXT=e.language&&"js"!=e.language?"."+e.language:".tonyu",h.EXT},h.resolve=function(e){if(e instanceof Array){var t=[];return e.forEach(function(e){t.push(h.resolve(e))}),t}if("string"==typeof e)return i.resolve(e,r.path());if(!e||!e.isDir)throw new Error("Cannot TPR.resolve: "+e);return e},h.shouldCompile=function(){var t=h.getOutputFile();if(!t.exists())return console.log("Should compile: ",t.name()+" does not exist."),!0;if(t.isReadOnly())return!1;var n=t.lastUpdate();if(n<e.VERSION)return console.log("Should compile: ",t.name()+" last="+new Date(n)+" < Tonyu.ver="+new Date(e.VERSION)),!0;var r=h.sourceFiles(h.getNamespace());for(var i in r){var o=r[i],a=o.lastUpdate();if(a>n)return console.log("Should compile: ",o.name()+" last="+new Date(a)),!0}var s=h.getOptionsFile();return s.exists()&&s.lastUpdate()>n?(console.log("Should compile: ",s.name()+" last="+new Date(s.lastUpdate())),!0):!1},h.getClassName=function(e){if(o(i.isFile(e)),r.contains(e))return h.getNamespace()+"."+e.truncExt(h.EXT);var t;return h.getDependingProjects().forEach(function(n){t||(t=n.getClassName(e))}),t},h.getName=function(){return r.name().replace(/\/$/,"")},h.getNamespace=function(){var e=h.getOptions();return o(e.compiler.namespace,"namespace not specified opt="+JSON.stringify(e))},h.getPublishedURL=function(){return h._publishedURL?h._publishedURL:a.requirejs(["Auth"]).then(function(e){return e.publishedURL(h.getName()+"/")}).then(function(e){return h._publishedURL=e,e})},h.getOutputFile=function(){var e=h.getOptions(),t=h.resolve(o(e.compiler.outputFile,"outputFile should be specified in options"));if(t.isDir())throw new Error("out: directory style not supported");return t},h.requestRebuild=function(){var e=this.env,t=this.getNamespace();for(var n in e.classes){var r=e.classes[n];r.namespace==t&&(console.log("REQRB","remove env.classes.",n),delete e.classes[n])}},h.removeOutputFile=function(){this.getOutputFile().rm()},h.loadDependingClasses=function(e){var t=a.directPromise(),n=h.getNamespace();return h.getDependingProjects().forEach(function(r){r.getNamespace()!=n&&(t=t.then(function(){return r.loadClasses(e)}))}),t},h.loadClasses=function(t){e.runMode=!1,h.showProgress("LoadClasses: "+r.name()),console.log("LoadClasses: "+r.path()),t=l(t);var n=t.visited||{};return n[h.path()]?a.directPromise():(n[h.path()]=!0,h.loadDependingClasses(t).then(function(){return h.shouldCompile()}).then(function(e){if(e)return h.compile(t);var n=h.getOutputFile("js");return h.showProgress("Eval "+n.name()),p(n)}))},h.compile=function(t){e.runMode=!1,h.showProgress("Compile: "+r.name()),console.log("Compile: "+r.path()),t=l(t);var i,o,a,s,u,c,p,d,g=h.getNamespace();return h.loadDependingClasses(t).then(m(function(){i=t.classes,o=t.options,a=h.env,a.aliases={},a.parsedNode=a.parsedNode||{},a.classes=i;for(var e in i){var n=i[e];a.aliases[n.shortName]=n.fullName}return h.showProgress("scan sources")})).then(m(function(){s={},u=!!o.noIncremental,c=h.sourceFiles(g);for(var t in c){var n=c[t],r=g+"."+t;i[r]||(console.log("Class",r,"is added."),u=!0);var l=e.klass.getMeta(r);s[r]=i[r]=l,e.extend(l,{fullName:r,shortName:t,namespace:g}),l.src=l.src||{},l.src.tonyu=n,a.aliases[t]=r}return h.showProgress("update check")})).then(m(function(){for(var t in i)s[t]&&s[t].src&&!s[t].src.js&&(console.log("Class",t,"has no js src"),u=!0),s[t]||i[t].namespace!=g||(console.log("Class",t,"is removed"),e.klass.removeMeta(t),u=!0);if(u)d=s;else{d={};for(var t in s)e.klass.shouldCompile(s[t])&&(d[t]=s[t])}return console.log("compilingClasses",d),h.showProgress("initClassDecl")})).then(m(function(){for(var e in d)console.log("initClassDecl: "+e),n.initClassDecls(d[e],a);return h.showProgress("order")})).then(m(function(){p=f(s),p.forEach(function(e){d[e.fullName]&&(console.log("annotate :"+e.fullName),n.annotate(e,a))});try{}catch(e){console.log("Error in Typecheck(It doesnt matter because Experimental)",e.stack)}return h.showProgress("genJS")})).then(m(function(){return h.genJS(p.filter(function(e){return d[e.fullName]||e.jsNotUpToDate}))})).then(m(function(){var e=h.getOptions().compiler;return e.genAMD?void 0:h.concatJS(p)}))},h.genJS=function(e){var n=h.env;return a.each(e,function(e){return console.log("genJS :"+e.fullName),t.genJS(e,n),h.showProgress("genJS :"+e.fullName)})},h.concatJS=function(e){var t=h.getOutputFile();h.showProgress("generate :"+t.name()),console.log("generate :"+t);var n=new u.SourceNode(null,null,t.path());e.forEach(function(e){var t,r=null;if("string"==typeof e.src.js)t=e.src.js+"\n";else{if(!i.isFile(e.src.js))throw new Error("Src for "+e.fullName+" not generated ");r=e.src.js.path(),t=e.src.js.text()+"\n"}var o;o=e.src.map?u.SourceNode.fromStringWithSourceMap(t,new u.SourceMapConsumer(e.src.map)):new u.SourceNode(null,null,r,t),n.add(o)});var r=t.sibling(t.name()+".map"),o=n.toStringWithSourceMap();return t.text(o.code+"\n//# sourceMappingURL="+r.name()),r.text(o.map+""),p(t)},h.getDependingProjects=function(){var e=h.getOptions(),t=e.compiler.dependingProjects||[];return t.map(function(e){if("string"==typeof e){var t=h.resolve(e);return c(t)}return"object"==typeof e?s(e.namespace,i.expandPath(e.compiledURL)):void 0})},h.dir=r,h.path=function(){return r.path()},h.sourceFiles=function(e){function t(e){if(e.endsWith(h.EXT)){var t=e.truncExt(h.EXT);r[t]=e}}for(var n=h.sourceDirs(e),r={},i=n.length-1;i>=0;i--)n[i].recursive(t);return r},h.sourceDir=function(){return r},h.sourceDirs=function(e){var t=h.getDependingProjects(),n=[r];return t.forEach(function(t){var r=t.getNamespace();if(!e||r==e){var i=t.sourceDir();i&&n.push(i)}}),n},h.decodeTrace=function(e){var t=e.split(":"),n=t[0],r=parseInt(t[1]),i=n.split("."),o=i.pop(),a=i.join(".");if(a==h.getNamespace()){var s=h.sourceFiles(a);for(var u in s)if(o==u)return TError("Trace info",s[u],r)}},h.showProgress=function(){},h.setAMDPaths=function(e){h.env.amdPaths=e},h.genXML=function(e){requirejs(["XMLBuffer"],function(t){var n=h.env.classes[e];if(!n)throw new Error("Class "+e+" not found");if(!n.node)throw new Error("Node not found compile it");var r=t(n.src.tonyu.text());r(n.node),console.log(r.buf)})},h};return"object"==typeof sh&&(sh.tonyuc=function(e){var t=c(sh.resolve(e));return t.compile()}),c}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(e){var t=function(e,t){this.options=t||{},this.img=e,this.height=e.height,this.width=e.width;var n=this.newImage(e.width,e.height),r=n.getContext("2d");r.drawImage(e,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,e.width,e.height).data,this.base=this.getPixel(0,0)};return e.extend(t.prototype,{newImage:function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n},getPixel:function(e,t){var n=this.pixels,r=4*(e+t*this.width),i=n[0+r],o=n[1+r],a=n[2+r],s=n[3+r];return 256*(256*(256*s+a)+o)+i},setPixel:function(e,t,n){var r=4*(e+t*this.width);this.pixels[0+r]=255&n,n=(n-(255&n))/256,this.pixels[1+r]=255&n,n=(n-(255&n))/256,this.pixels[2+r]=255&n,n=(n-(255&n))/256,this.pixels[3+r]=255&n},parse:function(){try{for(var e=[],t=0;t<this.height;t++)for(var n=0;n<this.width;n++){var r=this.getPixel(n,t);r!=this.base&&e.push(this.parse1Pattern(n,t))}return e}catch(i){if(i.isParseError)return console.log("parse error! "+i),[{image:this.img,x:0,y:0,width:this.width,height:this.height}];throw i}},parse1Pattern:function(e,t){function n(e){return e}function r(e,t,n){return{toString:function(){return"at ("+e+","+t+") :"+n},isParseError:!0}}for(var i=this.getPixel(e,t),o=e,a=t,s=this.base,u=this.width,c=this.height;u>o;){var l=this.getPixel(o,a);if(l!=i)break;o++}if(o>=u||this.getPixel(o,a)!=s)throw r(o,a,n(this.getPixel(o,a))+"!="+n(s));for(o--;c>a&&this.getPixel(o,a)==i;)a++;if(a>=c||this.getPixel(o,a)!=s)throw r(o,a,n(this.getPixel(o,a))+"!="+n(s));a--;var f=e+1,p=t+1,h=o-f,d=a-p;if(h*d==0)throw r(o,a,"w*h==0");for(var m=this.newImage(h,d),g=m.getContext("2d"),v=g.getImageData(0,0,h,d),y=v.data,b=0,T=p;a>T;T++)for(var w=f;o>w;w++){var S=this.getPixel(w,T);S==i?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S)}g.putImageData(v,0,0);for(var x=p-1;a>=x;x++)for(var A=f-1;o>=A;A++)this.setPixel(A,x,s);return this.options.boundsInSrc?{x:f,y:p,width:h,height:d}:{image:m,x:0,y:0,width:h,height:d}}}),t}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu","FS"],function(e,t,n,r){var i={};return i.resolve=function(n,i,o){o=o||{};var a=r.isFile(i)?i:i.getDir();if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,n){return e[n]}),e.urlAliases[n]&&(n=e.urlAliases[n]),t.startsWith(n,"ls:")){var s=n.substring("ls:".length);if(!a)throw new Error("Basedir not specified");var u=a.rel(s);if(!u.exists())throw new Error("Resource file not found: "+u);if(e.mp3Disabled&&s.match(/\.(mp3|mp4|m4a)$/)){var c=a.rel(s.replace(/\.(mp3|mp4|m4a)$/,".ogg"));c.exists()&&(u=c)}if(n=u.getURL(),o.asFile)return u}return n},n.Assets=i,i}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets","assert"],function(e,t,n,r){function i(e){var t=[];return e.forEach(function(e){e&&""!=e.url&&t.push(e)}),t}var o,a={};return o=function(t,o,s){s||(s={}),t=i(t);var u=[],c=t.length;0==c&&setTimeout(function(){var e=[];e.names={},o(e)},0),t.forEach(function(t,i){function l(){var n,a;if("single"==t.type)u[i]=[{image:this,x:0,y:0,width:this.width,height:this.height}];else if((n=t.pwidth)&&(a=t.pheight)){for(var s=0,l=0,f=this.width,p=this.height,h=[];;){var d=n,m=a;if(s+n>f&&(d=f-s),l+a>p&&(m=p-l),h.push({image:this,x:s,y:l,width:d,height:m}),s+=n,s+n>f&&(s=0,l+=a,l+a>p))break}u[i]=h}else{var g=new e(this);u[i]=g.parse()}if(u[i].name=t.name,r.is(u[i],Array),c--,0==c){var v=[],y={};u.forEach(function(e){y[e.name]=v.length,v=v.concat(e)}),v.names=y,o(v)}}console.log("loading",t,i);var f=t.url,p=f;if(a[p])return void l.apply(a[p],[]);f=n.resolve(f,s.prj||s.baseDir);var h=$("<img>");h.load(function(){a[p]=this,l.apply(this,[])}),h.attr("src",f)})},o.load=o,o.parse1=function(t,n,i){var o,a,s;if((o=t.pwidth)&&(a=t.pheight)){for(var u=0,c=0,l=n.width,f=n.height,p=[];;)if(p.push({image:this,x:u,y:c,width:o,height:a}),u+=o,u+o>l&&(u=0,c+=a,c+a>f))break;s=p}else{var h=new e(n,i);s=h.parse()}return s.name=t.name,r.is(s,Array)},window.ImageList=o,o}),requireSimulator.setName("Auth"),define(["WebSite"],function(e){var t={};return t.currentUser=function(t){$.ajax({type:"get",url:e.serverTop+"/currentUser",data:{withCsrfToken:!0},success:function(e){console.log("auth.currentUser",e),e=JSON.parse(e);var n=e.user;"null"==n&&(n=null),console.log("user",n,"csrfToken",e.csrfToken),t(n,e.csrfToken)}})},t.assertLogin=function(n){t.currentUser(function(t,r){return t?n.success(t,r):(window.onLoggedIn=n.success,void n.showLoginLink(e.serverTop+"/login"))})},window.Auth=t,t}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(e,t,n){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(e,n,r,i){var o=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(e){alert(e)}),o.append("theFile",r),o.append("user",e),o.append("project",n),o.append("fileName",r.name),$.ajax({type:"get",url:t.serverTop+"/blobURL",success:function(e){$.ajax({url:e,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){console.log("Res = "+e),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(e){if(n.startsWith(e,i)){var t=e.split("/");return{user:t[1],project:t[2],fileName:t[3]}}},r.url=function(e,n,r){return t.blobPath+e+"/"+n+"/"+r},r.uploadToExe=function(e,n){var r=e.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?n.success():(n.progress||(n.progress=function(e){console.log("uploadBlobToExe cnt=",e)}),void r.forEach(function(e){var r={csrfToken:n.csrfToken};for(var o in e)r[o]=e[o];$.ajax({type:"get",url:t.serverTop+"/uploadBlobToExe",data:r,success:function(){return i--,0==i?n.success():void n.progress(i)},error:n.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function e(t,n){if("string"==typeof t){var r=new Image,i=null,o=null,a=function(e){e&&(o=e),o&&i&&o(i)};return r.onload=function(){i=e(r,n),a()},r.src=t,a}var s=n.width,u=n.height,c=n.getContext("2d"),l=t.width,f=t.height,p=u/f*l,h=s/l*f;h>u&&(h=u),p>s&&(p=s),c.clearRect(0,0,s,u);var d=Math.floor((s-p)/2),m=Math.floor((u-h)/2);return c.drawImage(t,0,0,l,f,d,m,p,h),{left:d,top:m,width:p,height:h,src:t}}return e}),requireSimulator.setName("Content"),define(["FS"],function(e){return e.Content}),requireSimulator.setName("thumbnail"),define(["ImageRect","Content"],function(e){function t(t){try{var o=Tonyu.globals.$Screen.buf[0],a=$("<canvas>").attr({width:i,height:HEIGHT});e(o,a[0]);var s=a[0].toDataURL(),u=t.getResource(),c=t.getDir(),l=n.file(t);l.text(s);for(var f={name:r,pwidth:i,pheight:HEIGHT,url:"ls:"+l.relPath(c)},p=u.images,h=!1,d=0;d<p.length;d++)p[d].name==r&&(p[d]=f,h=!0);h||p.push(f),t.setResource(u),console.log("setRSRC",u)}catch(m){console.log("Create thumbnail failed",m),console.log(m.stack)}}var n={},r="$icon_thumbnail",i=200;return HEIGHT=200,n.set=function(e,n){setTimeout(function(){t(e)},n)},n.get=function(e){var t=n.file(e);return t.exists()?t.text():null},n.file=function(e){var t=e.getDir(),n=t.rel("images/").rel("icon_thumbnail.png");return n},n}),requireSimulator.setName("plugins"),define(["WebSite"],function(e){function t(e){var t=window;return e.split(".").forEach(function(e){t&&(t=t[e])}),t}function n(e){return"function"==typeof e&&(e={onload:e}),e||(e={}),e.onload||(e.onload=function(){}),e}var r={},i={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"},gif:{src:"gif-concat.js",detection:/GIFWriter/,symbol:"GIF"},jquery_ui:{src:"jquery-ui.js",detection:/\$InputBox/,symbol:"$.ui"}};return r.installed=i,r.detectNeeded=function(e,t){for(var n in i){var r=i[n].detection.exec(e);r&&(t[n]=1)}return t},r.loaded=function(e){var n=i[e];if(!n)throw new Error("plugin not found: "+e);return t(n.symbol)},r.loadAll=function(e,t){function o(){u>=a.length?t.onload():r.load(a[u++],o)}t=n(t);var a=[];for(var s in e)i[s]&&!r.loaded(s)&&a.push(s);var u=0;console.log("loading plugins",a),setTimeout(o,0)},r.load=function(t,r){var o=i[t];if(!o)throw new Error("plugin not found: "+t);r=n(r);var a,s=e.pluginTop+"/"+o.src;if("undefined"==typeof requireSimulator?"function"==typeof requirejs&&(a=requirejs):requireSimulator.real&&(a=requireSimulator.real.requirejs),a)s=s.replace(/\.js$/,""),console.log("Loading plugin via requirejs",s),a([s],function(e){!window[o.symbol]&&e&&(window[o.symbol]=e),r.onload(e)});else{console.log("Loading plugin via <script>",s);var u=document.createElement("script");u.src=s,u.onload=r.onload,document.body.appendChild(u)}},r.request=function(e){if(!r.loaded(e)){var t=new Error("Plugin "+e+" required");t.pluginName=e}},r}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","ProjectCompiler","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","Blob","thumbnail","WebSite","plugins","Tonyu.Compiler.Semantics","Tonyu.Compiler.JSGenerator","DeferredUtil","compiledProject"],function(e,t,n,r,i,o,a,s,u,c,l,f,p,h,d){return e.Project=function(n,i){{var f=t(n);e.extend({},f)}f.EXT=".tonyu",f.NSP_KER="kernel",f.NSP_USR="user";var p;p=i?t(i):d(f.NSP_KER,c.compiledKernel);var m=e.TraceTbl,g={classes:e.classMetas,traceTbl:m,options:{compiler:{}}};return f.env=g,f.dumpJS=function(e){function t(e){console.log("Class "+e+":\n"+g.classes[e].src.js)}if(e)t(e);else for(var e in g.classes)t(e)},f.stop=function(){var e=f.runningThread;e&&e.kill();var t=f.runningObj;return t&&t.stop?t.stop():void 0},f.rawRun=function(e){if(c.removeJSOutput){var t=f.getOutputFile();t.exists()&&t.rm()}return f.loadClasses().then(h.throwF(function(){f.fixBootRunClasses(),f.runScriptMode||u.set(f,2e3),f.rawBoot(e)}))},f.getResource=function(){var t=n.rel("res.json");if(t.exists()){var r=t.obj(),i=!1;for(var o in r)for(var a=r[o],s=a.length-1;s>=0;s--)a[s].url||(a.splice(s,1),i=!0);return i&&f.setResource(r),r}return e.defaultResource},f.hasSoundResource=function(){var e=f.getResource();return e&&e.sounds&&e.sounds.length>0},f.setResource=function(e){var t=n.rel("res.json");t.obj(e)},f.getThumbnail=function(){return u.get(f)},f.convertBlobInfos=function(e){function t(n){if("object"==typeof n)for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];if("url"==i){var a;(a=s.isBlobURL(o))&&(n[i]=[s.BLOB_PATH_EXPR,e,r,a.fileName].join("/"))}t(o)}}var n=f.getResource(),r=f.getName();t(n),f.setResource(n)},f.getBlobInfos=function(){function e(t){if("object"==typeof t)for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if("url"==r){var o;(o=s.isBlobURL(i))&&n.push(o)}e(i)}}var t=f.getResource(),n=[];return e(t),n},f.loadResource=function(t){var n=f.getResource();o(n.images,function(n){var r=e.getGlobal("$Sprites");r&&r.setImageList(n);for(var i in n.names)e.setGlobal(i,n.names[i]);t&&t()})},f.getOptions=function(){g.options=null;var t=n.rel("options.json");return t.exists()&&(g.options=t.obj()),g.options&&!g.options.run&&(g.options=null),g.options||(g.options=e.defaultOptions),f.fixOptions(g.options),g.options},f.fixOptions=function(e){e.compiler||(e.compiler={}),e.compiler.commentLastPos=f.runScriptMode||a.isAvailable(),e.plugins||(e.plugins={},n.each(function(t){t.endsWith(f.EXT)&&l.detectNeeded(t.text(),e.plugins)}))},f.requestPlugin=function(e){if(!l.loaded(e)){var t=f.getOptions();t.plugins[e]=1,f.setOptions(t);var n=new Error("必要なプラグイン"+e+"を追加しました。もう一度実行してください");throw n.pluginName=e,n}},f.loadPlugins=function(e){var t=f.getOptions();return l.loadAll(t.plugins,e)},f.fixBootRunClasses=function(){var e=f.getOptions();if(e.run){var t=f.fixClassName(e.run.mainClass),n=f.fixClassName(e.run.bootClass);(t!=e.run.mainClass||n!=e.run.bootClass)&&(e.run.mainClass=t,e.run.bootClass=n,f.setOptions(e))}},f.fixClassName=function(t){if(e.getClass(t))return t;var n,r=t.split("."),i=r.pop();return n=f.NSP_USR+"."+i,e.getClass(n)?n:(n=f.NSP_KER+"."+i,e.getClass(n)?n:t)},f.getNamespace=function(){var e=f.getOptions();return e.compiler&&e.compiler.namespace?e.compiler.namespace:f.isKernelEditable()?f.NSP_KER:f.NSP_USR},f.getDependingProjects=function(){return[p]},f.getOutputFile=function(){var e=f.getOptions();return e.compiler.outputFile?r.resolve(e.compiler.outputFile):n.rel("js/concat.js")},f.setOptions=function(e){e&&(g.options=e);var t=n.rel("options.json"),r=t.exists()?t.text():"",i=JSON.stringify(g.options);r!=i&&(console.log("update option",r,i),t.text(i))},f.rawBoot=function(t){f.showProgress("Running "+t),f.initCanvas(),e.run(t)},f.initCanvas=function(){e.globals.$mainCanvas=$("canvas")},f.srcExists=function(e,t){var n=null;return t.recursive(function(t){t.truncExt(f.EXT)===e&&(n=t)}),n},f.isKernel=function(t){return i?f.srcExists(t,i):g.classes[f.NSP_KER+"."+t]||e.getClass(f.NSP_KER+"."+t)},f.isKernelEditable=function(){return g.options.kernelEditable},f.renameClassName=function(e,t){return f.compile({noIncremental:!0}).then(function(){var n=f.env.classes;for(var r in n){var i=n[r],o=i.src?i.src.tonyu:null,a=i.annotation,s=[];if(a&&o){console.log("Check",r);for(var u in a)try{var c=a[u],l=c.scopeInfo;if(l&&"class"==l.type&&l.name==e){var p=c.node.pos,h=c.node.len,d=o.text().substring(p,p+h);d==e&&(s.push({pos:p,len:h}),console.log(o.path(),p,h,o.text().substring(p-5,p+h+5),"->",t))}}catch(m){console.log(m)}s=s.sort(function(e,t){return t.pos-e.pos}),console.log(o.path(),s);var g=o.text(),v=g;s.forEach(function(e){g=g.substring(0,e.pos)+t+g.substring(e.pos+e.len)}),v==g||o.isReadOnly()||(console.log("Refact:",o.path(),g),o.text(g))}else console.log("No Check",r)}})},f.showProgress=function(e){return console.log("PROGRESS",e),"undefined"!=typeof SplashScreen&&SplashScreen.progress(e),h.promise(function(e){setTimeout(e,0)})},f}}),requireSimulator.setName("Shell2"),define(["Shell","UI","FS","Util"],function(e,t,n,r){var i={};i.show=function(e){var t=i.embed(e);t.dialog({width:600,height:500})},i.embed=function(){i.d||(i.d=t("div",{title:"Shell"},["div",{$var:"inner"},"Type 'help' to show commands.",["br"]]),i.inner=i.d.$vars.inner,e.prompt());var n=i.d;return n},e.cls=function(){i.d.$vars.inner.empty()},e.prompt=function(){function n(e){return 9==e.which?(e.stopPropagation(),e.preventDefault(),a(),!1):void(13==e.which&&(l.empty(),o(u.val())))}function o(){var n=u.val().replace(/^ */,"").replace(/ *$/,"");if(0!=n.length){var r=n.split(/ +/),i=r.shift(),o=e[i];if("function"!=typeof o)return c.append(i+": command not found.");try{var a=[],s=null;r.forEach(function(e){var t=/^-([A-Za-z_0-9]+)(=(.*))?/.exec(e);t?(s||(s={}),s[t[1]]=null!=t[3]?t[3]:1):(s&&a.push(s),s=null,a.push(e))}),s&&a.push(s);var l=o.apply(e,a);if(l===e.ASYNC)return;if("object"==typeof l)if(l instanceof Array){var f=t("table"),p=null,h=0;l.forEach(function(e){p||(p=t("tr").appendTo(f)),p.append(t("td",e)),h++,h%3==0&&(p=null)}),f.appendTo(c)}else c.append(JSON.stringify(l));else c.append(l);e.prompt()}catch(d){e.err(d),e.prompt()}}}function a(){var t=u.val(),n=t.split(" "),i=n.pop(),o=[];if(0==n.length)for(var a in e)"function"==typeof e[a]&&r.startsWith(a,i)&&o.push(a);else{var s=e.resolve(i,!1);if(!s)return;var c=s.isDir()?s:s.up();c.each(function(e){r.startsWith(e.path(),s.path())&&o.push(e.name())})}if(1==o.length){var f=i.split("/");f.pop(),f.push(o[0]),n.push(f.join("/")),u.val(n.join(" ")),l.empty()}else l.text(o.join(", "))}var s=t("div",["input",{$var:"cmd",size:40,on:{keydown:n}}],["pre",{$var:"out","class":"shell out"},["div",{$var:"cand","class":"shell cand"}]]),u=s.$vars.cmd,c=s.$vars.out,l=s.$vars.cand;return e.setout({log:function(){return $.when.apply($,arguments).then(function(){for(var e=[],n=0;n<arguments.length;n++)e.push(arguments[n]);c.append(e[0]instanceof $?e[0]:t("span",e.join(" ")+"\n"))})},err:function(e){c.append(t("div",{"class":"shell error"},e,["br"],["pre",e.stack]))}}),s.appendTo(i.inner),u.focus(),i.inner.closest(".ui-dialog-content").scrollTop(i.inner.height()),e.ASYNC},e.window=function(){i.show(e.cwd)},e.atest=function(e,t,n){console.log(e,t,n)};var o=e.cat;return e.cat=function(n){return n=e.resolve(n,!0),n.contentType().match(/^image\//)?n.getContent(function(n){e.echo(t("img",{src:n.toURL()}))}):o.apply(e,arguments)},i}),requireSimulator.setName("GlobalDialog"),define(["UI","Klass"],function(e,t){return GlobalDialog=t.define({$this:"t",$:["prj"],show:function(e){e.opt=e.prj.getOptions(),e.createDOM(),e.load(),e.dom.dialog({width:800,height:500})},load:function(e){e.opt.run||(e.opt.run={}),e.opt.run.globals||(e.opt.run.globals={});var t=e.opt.run.globals,n=[];for(var r in t)n.push({key:r,value:JSON.stringify(t[r])});e.editor.keyvalueeditor("reset",n)},createDOM:function(t){if(t.dom)return t.dom;t.dom=e("div",{title:"グローバル変数設定"},["ul",["li","実行時に，これらのグローバル変数が指定した値に初期化されます．"],["li","「値」欄には文字列またはJSON形式で記入してください．"]],["div",{$var:"editor",css:{height:"350px","overflow-y":"scroll"}}],["div",["button",{on:{click:t.$bind.save}},"保存"]]),t.vars=$.data(t.dom,"vars"),console.log(t.vars,t.dom.$vars),t.editor=t.vars.editor;var n={placeHolderKey:"グローバル変数名",placeHolderValue:"値",toggleButton:null,deleteButton:'<img class="deleteButton" src="images/delete.png">'};return t.editor.keyvalueeditor("init",n),t.editor.on("change",".keyvalueeditor-key",function(){var e=this.value;return e.match(/^[a-zA-Z0-9_$]+$/)?(e.match(/^\$/)||(this.value="$"+this.value),void t.getValuesA()):void alert("変数名には半角英数字を使ってください")}),t.editor.on("change",".keyvalueeditor-value",function(e){var n=this.value;try{var r=JSON.parse(n);this.value=JSON.stringify(r)}catch(i){var o=JSON.stringify(n);o==='"'+n+'"'?this.value=o:(alert('解釈できない値です．この値をそのまま文字列として登録したい場合，前後をダブルクォーテーションで囲ってください．\nダブルクォーテーション自身を文字列に含める場合は \\" と書いてください．\n\\自身を文字列に含める場合は \\\\ と書いてください．\n'),e.stopPropagation())}t.getValuesA()}),t.dom},save:function(e){var t=e.getValuesA();t&&(e.opt.run.globals=t,e.prj.setOptions(e.opt),e.dom.dialog("close"))},getValuesA:function(e){try{return e.getValues()}catch(t){console.error(t.stack),alert(t)}},getValues:function(e){var t=e.editor.keyvalueeditor("getValues"),n={};return t.forEach(function(e){if(e.key in n)throw new Error("変数名'"+e.key+"'が重複しています．");if(!e.key.match(/^\$[a-zA-Z0-9_$]*$/))throw new Error("変数名'"+e.key+"'はグローバル変数名として使えません．");try{n[e.key]=JSON.parse(e.value)}catch(t){n[e.key]=e.value}}),n}})}),requireSimulator.setName("ProjectOptionsEditor"),define(["UI","GlobalDialog"],function(e,t){return function(n){function r(){o.show()}var i=n.getOptions();n.odiag||(n.odiag=e("div",{title:"プロジェクト オプション"},["h5","コンパイラ"],["div",["input",{type:"checkbox",$edit:"compiler.diagnose"}],"診断モード(速度が落ちますが，プログラムの不具合を見つけやすくします)"],["div",["input",{type:"checkbox",$edit:"compiler.noLoopCheck"}],"無限ループチェックをしない（チェックすると速度が速くなることがあります）"],["div",["input",{type:"checkbox",$edit:"compiler.field_strict"}],"フィールド宣言を明示的に行う(var n; のような宣言が必要になります)"],["div","デフォルトの親クラス",["input",{$edit:"compiler.defaultSuperClass"}]],["h5","実行"],["div","Main クラス",["input",{$edit:"run.mainClass"}]],["div","Boot クラス",["input",{$edit:"run.bootClass"}]],["div","グローバル変数",["button",{on:{click:r}},"編集..."]],["h5","開発"],["div",["input",{type:"checkbox",$edit:"kernelEditable"}],"Kernelの開発を行う"],["div",{$var:"validationMessage",css:{color:"red"}}]));var o=new t(n);n.odiag.$edits.load(i),n.odiag.dialog({width:600,buttons:{OK:function(){n.odiag.dialog("close"),n.setOptions(),n.requestRebuild()}}})}}),requireSimulator.setName("copyToKernel"),requirejs(["Shell","FS","WebSite"],function(e,t,n){e.copyToKernel=function(r){var i=t.get(n.tonyuHome),o=i.rel("Kernel/");if(r)return e.cp(r,o.rel(r));var a=0;return o.each(function(t){var n=e.cwd.rel(t.name());n.exists()&&(a+=e.cp(n,o))}),a}}),requireSimulator.setName("KeyEventChecker"),define([],function(){var e={};return e.down=function(t,n,r){t instanceof $||(t=$(t)),t.bind("keydown",function(i){return e.is(i,n)?r.call(t[0],i):void 0})},e.is=function(e,t){t=t.toLowerCase(),e=e.originalEvent||e;var n="";return e.altKey&&(n+="alt+"),e.ctrlKey&&(n+="ctrl+"),e.shiftKey&&(n+="shift+"),n+=e.keyCode>=112&&e.keyCode<=123?"f"+(e.keyCode-111):String.fromCharCode(e.keyCode),n=n.toLowerCase(),t==n},e}),requireSimulator.setName("IFrameDialog"),define([],function(){var e={};return e.create=function(e,t){t=t||{title:"help",topPage:"index"},t.height||(t.height=.7*$(window).height()),t.width||(t.width=500);var n=$("<iframe>").attr({"class":"wikiDialog",frameBorder:0,src:e}),r=$("<div>").attr({"class":"wikiDialog",title:t.title}).append(n);return{show:function(){r.dialog({width:t.width,height:t.height,resize:function(){}})}}},e}),requireSimulator.setName("PicoAudio");var PicoAudio=function(){function e(e,t){this.debug=!1,this.isStarted=!1,this.isPlayed=!1,this.isTonyu2=!0,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!0,reverbVolume:1.5,isChorus:!0,chorusVolume:.5,isCC111:!0,loop:!1,isSkipBeginning:this.isTonyu2,isSkipEnding:!0,holdOnValue:64,maxPoly:-1,maxPercPoly:-1,isOfflineRendering:!1,isSameDrumSoundOverlap:!1},this.trigger={isNoteTrigger:!0,noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:50,updateBufMaxTime:150,updateIntervalTime:0,latencyLimitTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.playData=null,this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1,this.onSongEndListener=null;for(var n=0;17>n;n++)this.channels.push([0,0,1]);e&&this.init(e,t),"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return Date.now()
}),Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991)}return e.prototype.init=function(e,t){this.isStarted=!0;var n=window.AudioContext||window.webkitAudioContext;if(this.context=e?e:new n,t&&t.whitenoise)this.whitenoise=t.whitenoise;else{this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate);for(var r=123456789,i=362436069,o=521288629,a=8867512,s=0;2>s;s++)for(var u=0;u<this.context.sampleRate;u++){var c=r^r<<11;r=i,i=o,o=a;var l=a=this.w^this.w>>>19^(c^c>>>8);l=Math.abs(l)/2147483648%2,this.whitenoise.getChannelData(s)[u]=2*l-1}}if(this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,t&&t.impulseResponse)this.impulseResponse=t.impulseResponse;else{var f=3.5*this.context.sampleRate;this.impulseResponse=this.context.createBuffer(2,f,this.context.sampleRate);for(var s=0;2>s;s++)for(var p=this.impulseResponse.getChannelData(s),u=0;f>u;u++){var h=(f-u)/f,d=u/this.context.sampleRate,l=u/f,m=(.03>d?0:h)*(d>=.03&&.031>d?2*h:h)*(d>=.04&&.042>d?1.5*h:h)*(d>=.05&&.054>d?1.25*h:h)*Math.random()*.2*Math.pow(h-.03,4);p[u]=m}}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!0,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0),this.isTonyu2&&(this.settings.isReverb=t?t.settings.isReverb:this.measurePerformanceReverb())},e.prototype.createNote=function(e){var t=this.createBaseNote(e,!1,!0,!1,!0);if(t.isGainValueZero)return null;var n=t.oscillator,r=t.gainNode,i=t.stopGainNode,o=!1,a=!1,s=this;switch(this.channels[t.channel][0]/10||e.instrument){case.1:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",r.gain.value*=1.5;break;case.2:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",r.gain.value*=.8;break;case.3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:n.type="sawtooth";break;case.4:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",r.gain.value*=1.5;break;default:n.type="square"}switch(("sine"==n.type||"triangle"==n.type)&&!o&&t.stop-t.start>.01&&(a=!0),this.channels[t.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:o=!0,r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,t.start),r.gain.linearRampToValueAtTime(0,t.start+.2),s.stopAudioNode(n,t.start+.2,i);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,t.start);var u=(128-e.pitch)/64;r.gain.setTargetAtTime(0,t.start,2.5*u*u),s.stopAudioNode(n,t.stop,i,a);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,t.start),r.gain.linearRampToValueAtTime(0,t.start+1+4*t.velocity),s.stopAudioNode(n,t.stop,i,a);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:r.gain.value*=1,r.gain.setValueAtTime(r.gain.value,t.start),r.gain.linearRampToValueAtTime(.95*r.gain.value,t.start+.1),r.gain.setValueAtTime(.95*r.gain.value,t.start+.1),r.gain.linearRampToValueAtTime(0,t.start+2+10*t.velocity),s.stopAudioNode(n,t.stop,i,a);break;case 119:r.gain.value=0,s.stopAudioNode(n,t.stop,i,a);var c=this.createBaseNote(e,!0,!0);if(c.isGainValueZero)break;c.oscillator.playbackRate.setValueAtTime((e.pitch+1)/128,t.start),c.gainNode.gain.setValueAtTime(0,t.start),c.gainNode.gain.linearRampToValueAtTime(1.3,t.start+2),s.stopAudioNode(c.oscillator,t.stop,c.stopGainNode);break;default:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,t.start),s.stopAudioNode(n,t.stop,i,a)}return function(){s.stopAudioNode(n,0,i,!0),c&&c.oscillator&&s.stopAudioNode(c.oscillator,0,c.stopGainNode,!0)}},e.prototype.createPercussionNote=function(e){var t=this.createBaseNote(e,!0,!1);if(t.isGainValueZero)return null;var n=t.oscillator,r=t.gainNode,i=t.stopGainNode,o=t.start,a=1,s=this.createBaseNote(e,!1,!1,!0),u=s.oscillator,c=s.gainNode,l=s.stopGainNode,f=e.nextSameNoteOnInterval,p=this;o<this.context.currentTime&&(o=this.context.currentTime);var h=0,d=0;switch(e.pitch){case 35:case 36:n.playbackRate.value=.25,r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.7*a,o+.004),r.gain.linearRampToValueAtTime(0,o+.008),h=.008,u.frequency.setValueAtTime(35==e.pitch?90:160,o),u.frequency.linearRampToValueAtTime(40,o+.08),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(3*a,o+.02),c.gain.linearRampToValueAtTime(0,o+.08),d=.08;break;case 37:n.playbackRate.value=.26,r.gain.setValueAtTime(1.5*a,o),r.gain.linearRampToValueAtTime(0,o+.041),h=.041,u.frequency.setValueAtTime(330,o),u.frequency.linearRampToValueAtTime(120,o+.02),c.gain.setValueAtTime(a,o),c.gain.linearRampToValueAtTime(0,o+.02),d=.02;break;case 38:case 40:var m=38==e.pitch?.25:.2;n.playbackRate.value=.7,r.gain.setValueAtTime(a,o),r.gain.linearRampToValueAtTime(0,o+m),h=m,u.frequency.setValueAtTime(38==e.pitch?140:200,o),u.frequency.linearRampToValueAtTime(38==e.pitch?100:160,o+.1),c.gain.setValueAtTime(2*a,o),c.gain.linearRampToValueAtTime(0,o+.1),d=.1;break;case 39:n.playbackRate.value=.5,r.gain.setValueAtTime(1.3*a,o),r.gain.linearRampToValueAtTime(0,o+.01),r.gain.setValueAtTime(1.3*a,o+.0101),r.gain.linearRampToValueAtTime(0,o+.02),r.gain.setValueAtTime(1.3*a,o+.0201),r.gain.linearRampToValueAtTime(0,o+.09),h=.09,u.type="triangle",u.frequency.setValueAtTime(180,o),c.gain.setValueAtTime(.8*a,o),c.gain.linearRampToValueAtTime(0,o+.01),c.gain.setValueAtTime(.8*a,o+.0101),c.gain.linearRampToValueAtTime(0,o+.02),c.gain.setValueAtTime(.8*a,o+.0201),c.gain.linearRampToValueAtTime(0,o+.03),d=.11;break;case 41:case 43:case 45:case 47:case 48:case 50:var m=e.pitch-41+(e.pitch>=48?1:0);n.playbackRate.value=.3+m/45,r.gain.setValueAtTime(1.5*a,o),r.gain.linearRampToValueAtTime(0,o+.02),h=.02,u.frequency.setValueAtTime(90+15*m,o),u.frequency.linearRampToValueAtTime(30+7.5*m,o+.5-m/35),c.gain.setValueAtTime(1.5*a,o),c.gain.linearRampToValueAtTime(0,o+.5-m/35),d=.5-m/35;break;case 42:case 44:n.playbackRate.value=1,42==e.pitch?r.gain.setValueAtTime(.8*a,o):(r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.8*a,o+.014)),r.gain.linearRampToValueAtTime(0,o+.08),h=.08,c.gain.value=0,d=0;break;case 46:n.playbackRate.setValueAtTime(.35,o),n.playbackRate.linearRampToValueAtTime(.6,o+.1),n.playbackRate.linearRampToValueAtTime(1,o+.3),r.gain.setValueAtTime(1.1*a,o),r.gain.setTargetAtTime(0,o,.3),h=1.5,c.gain.value=0,d=0;break;case 49:case 57:var g=49==e.pitch?.3:.5,v=49==e.pitch?.4:.7;n.playbackRate.setValueAtTime(g,o),n.playbackRate.linearRampToValueAtTime(v,o+.15),n.playbackRate.linearRampToValueAtTime(.9,o+.4),r.gain.setValueAtTime(1.3*a,o),r.gain.setTargetAtTime(0,o,.35),h=2,c.gain.value=0,d=0;break;case 51:case 59:n.playbackRate.value=1,r.gain.setValueAtTime(.9*a,o),r.gain.setTargetAtTime(0,o,.35),h=2,u.type="triangle";var y=51==e.pitch?372:400;u.frequency.setValueAtTime(y,o),c.gain.setValueAtTime(.4*a,o),c.gain.setTargetAtTime(0,o,.35),d=2;break;case 52:n.playbackRate.setValueAtTime(.17,o),n.playbackRate.linearRampToValueAtTime(.25,o+.1),n.playbackRate.linearRampToValueAtTime(.5,o+.6),r.gain.setValueAtTime(1.3*a,o),r.gain.setTargetAtTime(0,o,.35),h=2,u.type="triangle",u.frequency.setValueAtTime(382,o),c.gain.setValueAtTime(.2*a,o),c.gain.setTargetAtTime(0,o,.35),d=2;break;case 53:n.playbackRate.setValueAtTime(.6,o),r.gain.setValueAtTime(a,o),r.gain.setTargetAtTime(0,o,.3),h=2,u.type="triangle",u.frequency.setValueAtTime(377,o),c.gain.setValueAtTime(.5*a,o),c.gain.setTargetAtTime(0,o,.35),d=2;break;case 55:n.playbackRate.setValueAtTime(.5,o),n.playbackRate.linearRampToValueAtTime(.8,o+.1),n.playbackRate.linearRampToValueAtTime(1,o+.6),r.gain.setValueAtTime(1.5*a,o),r.gain.setTargetAtTime(0,o,.3),h=1.75,c.gain.value=0,d=0;break;case 54:case 56:n.playbackRate.setValueAtTime(1,o);var b=54==e.pitch?1:.4,m=54==e.pitch?.01:0;r.gain.setValueAtTime(a*b/2,o),r.gain.linearRampToValueAtTime(a*b,o+m),r.gain.setTargetAtTime(0,o+m,.05),h=.3,u.frequency.setValueAtTime(54==e.pitch?6e3:495,o);var b=54==e.pitch?1:2;c.gain.setValueAtTime(a*b/2,o),c.gain.linearRampToValueAtTime(a*b,o+m),c.gain.setTargetAtTime(0,o+m,.05),d=.3;break;case 58:n.playbackRate.setValueAtTime(.6,o),n.playbackRate.linearRampToValueAtTime(1,o+.8);var m=40;r.gain.setValueAtTime(1.5*a,o),c.gain.setValueAtTime(.5*a,o);for(var T=0;m>T;T++)r.gain.linearRampToValueAtTime(.1*a*(m-T)/m,o+T/m*.8),r.gain.linearRampToValueAtTime(1.5*a*(m-(T+1))/m,o+(T+.99)/m*.8),c.gain.linearRampToValueAtTime(.025*a*(m-T)/m,o+T/m*.8),c.gain.linearRampToValueAtTime(.25*a*(m-(T+1))/m,o+(T+.99)/m*.8);r.gain.linearRampToValueAtTime(0,o+.8),c.gain.linearRampToValueAtTime(0,o+.8),h=.8,u.type="triangle",u.frequency.setValueAtTime(1e3,o),d=.8;break;case 80:n.playbackRate.value=1,r.gain.setValueAtTime(.5*a,o),r.gain.setTargetAtTime(0,o,.015),h=.2,u.type="triangle",u.frequency.setValueAtTime(6e3,o),c.gain.setValueAtTime(2.5*a,o),c.gain.setTargetAtTime(0,o,.02),d=.3;break;case 81:n.playbackRate.value=5,r.gain.setValueAtTime(.5*a,o),r.gain.setTargetAtTime(0,o,.08),h=.75,u.type="triangle",u.frequency.setValueAtTime(6e3,o),c.gain.setValueAtTime(2.5*a,o),c.gain.setTargetAtTime(0,o,.18),d=1;break;case 60:case 61:case 62:case 63:case 64:var w=e.pitch,g=60==w?700:61==w?282:62==w?385:63==w?295:210,m=60==w?.08:61==w?.1:62==w?.03:63==w?.12:.15;n.playbackRate.value=.03,r.gain.setValueAtTime(1.2*a,o),h=.03,u.frequency.setValueAtTime(.97*g,o),u.frequency.linearRampToValueAtTime(g,o+m),c.gain.setValueAtTime(1.8*a,o),c.gain.linearRampToValueAtTime(0,o+m),d=m;break;case 65:case 66:var m=65==e.pitch?.22:.25;n.playbackRate.setValueAtTime(65==e.pitch?.25:.22,o),n.playbackRate.linearRampToValueAtTime(65==e.pitch?.2:.18,o+m),r.gain.setValueAtTime(1.3*a,o),r.gain.linearRampToValueAtTime(.2*a,o+m/3.5),r.gain.linearRampToValueAtTime(0,o+m),h=m,u.type="triangle",u.frequency.setValueAtTime(65==e.pitch?203.3:145.52,o),u.frequency.linearRampToValueAtTime(65==e.pitch?190:136,o+.1),c.gain.setValueAtTime(3.2*a,o),c.gain.setTargetAtTime(0,o,.08),d=1;break;case 67:case 68:n.playbackRate.value=1,r.gain.setValueAtTime(.5*a,o),r.gain.linearRampToValueAtTime(.1*a,o+.02),r.gain.linearRampToValueAtTime(0,o+.08),h=.08,u.type="triangle",u.frequency.setValueAtTime(67==e.pitch?1430:1055,o),c.gain.setValueAtTime(2*a,o),c.gain.setTargetAtTime(0,o,.06),d=.75;break;case 69:n.playbackRate.value=1,r.gain.setValueAtTime(.3*a,o),r.gain.linearRampToValueAtTime(.8*a,o+.03),r.gain.linearRampToValueAtTime(0,o+.08),h=.08,c.gain.value=0,d=0;break;case 70:n.playbackRate.value=1,r.gain.setValueAtTime(1.2*a,o),r.gain.linearRampToValueAtTime(0,o+.06),h=.06,c.gain.value=0,d=0;break;case 71:case 72:r.gain.value=0,h=0;var m=71==e.pitch?.07:.4;u.type="triangle",u.frequency.setValueAtTime(71==e.pitch?2408:2105,o),c.gain.setValueAtTime(0,o);for(var T=0;74*m>T;T++)c.gain.linearRampToValueAtTime(2.5*a,o+(T+.2)/75),c.gain.linearRampToValueAtTime(.5*a,o+(T+.9)/75);c.gain.linearRampToValueAtTime(0,o+m),d=m;break;case 73:case 74:var m=73==e.pitch?.05:.35;n.playbackRate.setValueAtTime(73==e.pitch?.2:.2,o),n.playbackRate.linearRampToValueAtTime(73==e.pitch?.7:.5,o+m),r.gain.value=.2*a;for(var T=0;100*m>T;T++)r.gain.setValueAtTime(.4*a,o+T/100),r.gain.setValueAtTime(.9*a,o+(T+.7)/100);h=m,c.gain.value=0,d=0;break;case 75:r.gain.value=0,h=0,u.frequency.setValueAtTime(2181,o),c.gain.setValueAtTime(0,o),c.gain.setValueAtTime(2*a,o+.005),c.gain.linearRampToValueAtTime(1*a,o+.015),c.gain.linearRampToValueAtTime(1.5*a,o+.025),c.gain.linearRampToValueAtTime(0,o+.08),d=.1;break;case 76:case 77:n.playbackRate.value=.1,r.gain.setValueAtTime(1.2*a,o),r.gain.linearRampToValueAtTime(0,o+.015),h=.015,u.frequency.setValueAtTime(76==e.pitch?800:600,o),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(3*a,o+.005),c.gain.setTargetAtTime(0,o+.005,.02),d=.2;break;case 78:case 79:r.gain.value=0,h=0;var m=.18,y=78==e.pitch?750:270;u.frequency.setValueAtTime(y,o),u.frequency.linearRampToValueAtTime(y,o+m/3),78==e.pitch&&u.frequency.linearRampToValueAtTime(.9*y,o+m),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(1.5*a,o+.005),c.gain.linearRampToValueAtTime(.5*a,o+.02),c.gain.linearRampToValueAtTime(3*a,o+.04),c.gain.linearRampToValueAtTime(2*a,o+m/4*3),c.gain.linearRampToValueAtTime(0,o+m),d=m;break;case 27:n.playbackRate.value=1,r.gain.setValueAtTime(1*a,o),r.gain.linearRampToValueAtTime(0,o+.002),h=.002,u.frequency.setValueAtTime(1500,o),u.frequency.linearRampToValueAtTime(280,o+.015),u.frequency.linearRampToValueAtTime(0,o+.07),c.gain.setValueAtTime(1.9*a,o),c.gain.linearRampToValueAtTime(0,o+.07),d=.07;break;case 28:n.playbackRate.value=1,r.gain.setValueAtTime(1.3*a,o),r.gain.linearRampToValueAtTime(0,o+.01),r.gain.setValueAtTime(1.1*a,o+.0101),r.gain.linearRampToValueAtTime(0,o+.02),r.gain.setValueAtTime(.9*a,o+.0201),r.gain.setTargetAtTime(0,o+.0201,.03),h=.2,c.gain.value=0,d=0;break;case 29:case 30:var S=29==e.pitch?.05:.07,x=29==e.pitch?.06:.09,A=29==e.pitch?.07:.11,E=29==e.pitch?.1:.15,P=29==e.pitch?.25:.4,M=29==e.pitch?.1:.06,v=29==e.pitch?.3:.2,k=29==e.pitch?.18:.12;n.playbackRate.setValueAtTime(M,o),n.playbackRate.linearRampToValueAtTime(v,o+S),n.playbackRate.linearRampToValueAtTime(0,o+x),n.playbackRate.linearRampToValueAtTime(v,o+A),n.playbackRate.linearRampToValueAtTime(k,o+E),n.playbackRate.linearRampToValueAtTime(0,o+P),r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.4*a,o+S),r.gain.linearRampToValueAtTime(.1*a,o+A),r.gain.linearRampToValueAtTime(.3*a,o+E),r.gain.linearRampToValueAtTime(0,o+P),h=P;var C=29==e.pitch?500:400,D=29==e.pitch?1950:1200,R=29==e.pitch?430:250;u.frequency.setValueAtTime(C,o),u.frequency.linearRampToValueAtTime(D,o+S),u.frequency.linearRampToValueAtTime(0,o+x),u.frequency.linearRampToValueAtTime(D,o+A),u.frequency.linearRampToValueAtTime(R,o+E),u.frequency.linearRampToValueAtTime(0,o+P),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(.7*a,o+S),c.gain.linearRampToValueAtTime(.2*a,o+A),c.gain.linearRampToValueAtTime(.6*a,o+E),c.gain.linearRampToValueAtTime(0,o+P),d=P;break;case 31:n.playbackRate.setValueAtTime(.4,o),n.playbackRate.linearRampToValueAtTime(.5,o+.015),r.gain.setValueAtTime(1.2*a,o),r.gain.setTargetAtTime(0,o,.035),h=.3,u.frequency.setValueAtTime(3140,o),c.gain.setValueAtTime(1.2*a,o),c.gain.setTargetAtTime(0,o,.012),d=.3;break;case 32:r.gain.value=0,h=0,u.type="square",u.frequency.setValueAtTime(333,o),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(4*a,o+.0016),c.gain.linearRampToValueAtTime(0,o+.0032),d=.0032;break;case 33:case 34:n.playbackRate.setValueAtTime(.17,o),n.playbackRate.linearRampToValueAtTime(.22,o+.01),r.gain.setValueAtTime(1.5*a,o),r.gain.setTargetAtTime(0,o,.015),h=.3,34==e.pitch?(u.frequency.setValueAtTime(2040,o),c.gain.setValueAtTime(1*a,o),c.gain.setTargetAtTime(0,o,.12),d=1.1):(c.gain.value=0,d=0);break;case 82:n.playbackRate.value=1,r.gain.setValueAtTime(.5*a,o),r.gain.linearRampToValueAtTime(a,o+.02),r.gain.linearRampToValueAtTime(0,o+.07),h=.07,c.gain.value=0,d=0;break;case 83:n.playbackRate.value=1,r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(1.2*a,o+.015),r.gain.setTargetAtTime(0,o+.015,.06),h=.5,u.type="triangle",u.frequency.setValueAtTime(2709,o),u.frequency.linearRampToValueAtTime(2657,o+.3),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(.7*a,o+.025),c.gain.setTargetAtTime(0,o+.025,.07),d=.5;break;case 84:var L=!1;n.playbackRate.value=1;for(var T=0;28>T;T++)r.gain.setValueAtTime(.1*a,o+T/24*.45),r.gain.setTargetAtTime(0,o+T/24*.45,.01),u.frequency.setValueAtTime(1380*(1+(L?(24-T)/24:T/24)),o+T/24*.45),c.gain.setValueAtTime(a*(.2+T/24),o+T/24*.45),c.gain.setTargetAtTime(0,o+T/24*.45,27==T?.2:.01);h=.5,d=1.5;break;case 85:n.playbackRate.setValueAtTime(.35,o),r.gain.setValueAtTime(1.3*a,o),r.gain.setTargetAtTime(0,o,.01),h=.1,u.frequency.setValueAtTime(1730,o),c.gain.setValueAtTime(.5*a,o),c.gain.setTargetAtTime(0,o,.01),d=.1;break;case 86:case 87:n.playbackRate.setValueAtTime(.02,o),n.playbackRate.linearRampToValueAtTime(.015,o+.5),r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(2*a,o+.005),r.gain.setTargetAtTime(0,o+.005,86==e.pitch?.03:.06),h=.5,u.frequency.setValueAtTime(88,o),u.frequency.linearRampToValueAtTime(86,o+.3),c.gain.setValueAtTime(2.5*a,o),c.gain.setTargetAtTime(0,o,86==e.pitch?.1:.3),d=86==e.pitch?.5:1.5;break;default:n.playbackRate.value=e.pitch/69*2,h=.05,d=0}return this.settings.isSameDrumSoundOverlap||-1==f||(h>f&&(h=f),d>f&&(d=f)),p.stopAudioNode(n,o+h,i),p.stopAudioNode(u,o+d,l),e.drumStopTime=e.startTime+(h>=d?h:d),function(){p.stopAudioNode(n,0,i,!0),p.stopAudioNode(u,0,l,!0)}},e.prototype.createBaseNote=function(e,t,n,r,i){var o=this.settings,a=this.context,s=this.states.startTime,u=this,c=r?0:e.channel||0,l=e.velocity*Number(r?1:null!=this.channels[c][2]?this.channels[c][2]:1)*o.generateVolume,f=!0;if(0>=l)return{isGainValueZero:!0};var p=l*((e.expression?e.expression[0].value:100)/127),h=a.createGain();if(h.gain.value=p,n?e.expression?e.expression.forEach(function(e){var t=l*(e.value/127);t>0&&(f=!1),h.gain.setValueAtTime(t,e.time+s)}):!1:p>0&&(f=!1),f)return{isGainValueZero:!0};var d=e.startTime+s,m=e.stopTime+s,g=o.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),v=t?a.createBufferSource():a.createOscillator(),y=a.createStereoPanner?a.createStereoPanner():a.createPanner?a.createPanner():{pan:{setValueAtTime:function(){}}},b=a.createGain(),T=a.createGain();if(!a.createStereoPanner&&a.createPanner){var w=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;w>1&&(w=1);var S=90*w,x=Math.sin(S*(Math.PI/180)),A=-Math.cos(S*(Math.PI/180));y.panningModel="equalpower",y.setPosition(x,0,A)}else if(a.createStereoPanner){var w=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;w>1&&(w=1),y.pan.value=w}if(t?(v.loop=!0,v.buffer=this.whitenoise):(v.type=e.type||"sine",v.detune.value=0,v.frequency.value=g,e.pitchBend?e.pitchBend.forEach(function(t){v.frequency.setValueAtTime(o.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),t.time+s)}):!1),a.createStereoPanner||a.createPanner){var E=!0;a.createStereoPanner?e.pan?e.pan.forEach(function(e){if(E)return void(E=!1);var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1),y.pan.setValueAtTime(t,e.time+s)}):!1:a.createPanner&&(y.positionX?e.pan?e.pan.forEach(function(e){if(E)return void(E=!1);var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1);var n=90*t,r=Math.sin(n*(Math.PI/180)),i=-Math.cos(n*(Math.PI/180));y.positionX.setValueAtTime(r,e.time+s),y.positionY.setValueAtTime(0,e.time+s),y.positionZ.setValueAtTime(i,e.time+s)}):!1:e.pan?e.pan.forEach(function(e){if(E)return void(E=!1);var t=setTimeout(function(){u.clearFunc("pan",t);var n=64==e.value?0:e.value/127*2-1;n>1&&(n=1);var r=90*n,i=Math.sin(r*(Math.PI/180)),o=-Math.cos(r*(Math.PI/180));y.setPosition(i,0,o)},1e3*(e.time+s-a.currentTime));u.pushFunc({pan:t,stopFunc:function(){clearTimeout(t)}})}):!1),v.connect(y),y.connect(h)}else v.connect(h);if(h.connect(b),b.connect(T),T.connect(this.masterGainNode),this.masterGainNode.connect(a.destination),!t&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){var P=a.createOscillator(),M=a.createGain();E=!0,e.modulation?e.modulation.forEach(function(e){if(E)return void(E=!1);var t=e.value/127;t>1&&(t=1),M.gain.setValueAtTime(10*g/440*t,e.time+s)}):!1;var k=e.modulation?e.modulation[0].value/127:0;k>1&&(k=1),M.gain.value=10*g/440*k,P.frequency.value=6,P.connect(M),M.connect(v.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var C=this.convolver,D=a.createGain();E=!0,e.reverb?e.reverb.forEach(function(e){if(E)return void(E=!1);var t=e.value/127;t>1&&(t=1),D.gain.setValueAtTime(t,e.time+s)}):!1;var R=e.reverb?e.reverb[0].value/127:0;R>1&&(R=1),D.gain.value=R,b.connect(T),T.connect(D),D.connect(C)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var L=this.chorusDelayNode,N=a.createGain();E=!0,e.chorus?e.chorus.forEach(function(e){if(E)return void(E=!1);var t=e.value/127;t>1&&(t=1),N.gain.setValueAtTime(t,e.time+s)}):!1;var B=e.chorus?e.chorus[0].value/127:0;B>1&&(B=1),N.gain.value=B,b.connect(T),T.connect(N),N.connect(L)}return P&&(P.start(d),this.stopAudioNode(P,m,M)),v.start(d),t||r||i||this.stopAudioNode(v,m,T),{start:d,stop:m,pitch:g,channel:c,velocity:l,oscillator:v,panNode:y,gainNode:b,stopGainNode:T,isGainValueZero:!1}},e.prototype.startWebMIDI=function(){var e,t=this;if(navigator.requestMIDIAccess){var n=this.settings.WebMIDIPortSysEx,r=function(r){e=r.outputs,t.settings.WebMIDIPortOutputs=e;var i;return-1==t.settings.WebMIDIPort?t.settings.WebMIDIPortOutputs.forEach(function(e){i||(i=e)}):i=t.settings.WebMIDIPortOutputs.get(settings.WebMIDIPort),t.settings.WebMIDIPortOutput=i,t.settings.WebMIDIPortSysEx=n,i&&(i.open(),t.initStatus()),e},i=function(e){console.log(e),n&&(n=!1,navigator.requestMIDIAccess({sysex:n}).then(r).catch(i))};navigator.requestMIDIAccess({sysex:n}).then(r).catch(i),window.addEventListener("unload",function(){for(var e=0;16>e;e++){t.settings.WebMIDIPortOutput.send([176+e,120,0]);for(var n=0;128>n;n++)t.settings.WebMIDIPortOutput.send([128+e,n,0])}})}},e.prototype.initStatus=function(e,t){if(!this.settings.isWebMIDI||null==this.states.webMIDIWaitState){this.stop(e);var n=this.states.webMIDIStopTime;if(this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:this.states.updateBufTime,updateBufMaxTime:this.states.updateBufMaxTime,updateIntervalTime:this.states.updateIntervalTime,latencyLimitTime:this.states.latencyLimitTime,noteOnAry:[],noteOffAry:[]},this.states.webMIDIStopTime=n,this.settings.isWebMIDI&&!t){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var r=0;16>r;r++)this.settings.WebMIDIPortOutput.send([192+r,0]),this.settings.WebMIDIPortOutput.send([224+r,0,64]),this.settings.WebMIDIPortOutput.send([176+r,100,0]),this.settings.WebMIDIPortOutput.send([176+r,101,0]),this.settings.WebMIDIPortOutput.send([176+r,6,2]),this.settings.WebMIDIPortOutput.send([176+r,100,1]),this.settings.WebMIDIPortOutput.send([176+r,96,0]),this.settings.WebMIDIPortOutput.send([176+r,97,64]),this.settings.WebMIDIPortOutput.send([176+r,7,100]),this.settings.WebMIDIPortOutput.send([176+r,10,64]),this.settings.WebMIDIPortOutput.send([176+r,11,127]),this.settings.WebMIDIPortOutput.send([176+r,98,0]),this.settings.WebMIDIPortOutput.send([176+r,99,0]),this.settings.WebMIDIPortOutput.send([176+r,122,0])}}},e.prototype.stop=function(e){var t=this.states,n=this;if(0!=t.isPlaying&&(t.isPlaying=!1,t.stopTime=this.context.currentTime,t.stopFuncs.forEach(function(e){e.stopFunc()}),t.stopFuncs=[],t.playIndices.forEach(function(e,t,n){n[t]=0}),t.noteOnAry=[],t.noteOffAry=[],this.settings.isWebMIDI)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;t.webMIDIStopTime=this.context.currentTime,setTimeout(function(){for(var e=0;16>e;e++)n.settings.WebMIDIPortOutput.send([176+e,120,0])},1e3)}},e.prototype.play=function(e){var t=this.context,n=this.settings,r=this.trigger,i=this.states,o=this;if(1!=i.isPlaying){if(n.isWebMIDI&&!e){if("completed"!=i.webMIDIWaitState){if("waiting"!=i.webMIDIWaitState){i.webMIDIWaitState="waiting";var a=1e3-1e3*(t.currentTime-i.webMIDIStopTime);0==i.webMIDIStopTime&&(a=1e3),setTimeout(function(){o.states.webMIDIWaitState="completed",o.states.isPlaying=!1,o.play()},a)}return}i.webMIDIWaitState=null}var s=this.context.currentTime;if(this.isPlayed=!0,i.isPlaying=!0,i.startTime=i.startTime||i.stopTime?i.startTime+s-i.stopTime:s,i.stopFuncs=[],this.settings.isSkipBeginning){var u=this.firstNoteOnTime;-i.startTime+s<u&&this.setStartTime(u+i.startTime-s)}var c,l=function(){o.clearFunc("rootTimeout",c);var e=o.settings.isCC111&&-1!=o.cc111Time?o.lastNoteOffTime:o.getTime(Number.MAX_SAFE_INTEGER);e-t.currentTime+i.startTime<=0?(r.songEnd(),o.onSongEnd()):(c=setTimeout(l,1),o.pushFunc({rootTimeout:c,stopFunc:function(){clearTimeout(c)}}))},f=this.settings.isCC111&&-1!=this.cc111Time?this.lastNoteOffTime:this.getTime(Number.MAX_SAFE_INTEGER),p=1e3*(f-t.currentTime+i.startTime);c=setTimeout(l,p),o.pushFunc({rootTimeout:c,stopFunc:function(){clearTimeout(c)}});var h=performance.now(),d=performance.now(),m=1e3*t.currentTime,g=0,v=0,y=0;!function b(e){var a=performance.now(),s=a-e,u=a,c=1e3*t.currentTime;g+=u-d,v+=c-m,d=u,m=c;var l=g-v;if(o.states.latencyTime=l,l>=100?(o.states.latencyLimitTime+=l,v+=100):-100>=l?v=g:o.states.latencyLimitTime>0&&(o.states.latencyLimitTime-=.04*s,o.states.latencyLimitTime<0&&(o.states.latencyLimitTime=0)),o.states.updateIntervalTime=s,s+=o.isFirefox()&&!o.isAndroid()?12:8,o.states.updateBufTime<s?o.states.updateBufTime=s:(o.states.updateBufTime-=.001*o.states.updateBufTime,o.states.updateBufTime>100&&(o.states.updateBufTime-=.01*o.states.updateBufTime),o.states.updateBufMaxTime>150&&(o.states.updateBufMaxTime-=.002*o.states.updateBufMaxTime),o.states.updateBufMaxTime>10&&o.states.updateBufMaxTime<140&&(o.states.updateBufMaxTime+=.003*o.states.updateBufMaxTime)),o.states.updateBufTime>o.states.updateBufMaxTime){if(s>=900&&o.states.latencyLimitTime<=150)o.states.updateBufMaxTime+=s;else{var f=s-o.states.updateBufMaxTime;o.states.updateBufTime=o.states.updateBufMaxTime,o.states.updateBufMaxTime<10?(o.states.updateBufTime=o.states.updateBufMaxTime,o.states.updateBufMaxTime*=1.25):o.states.updateBufMaxTime+=f/2}o.states.updateBufMaxTime>1100&&(o.states.updateBufMaxTime=1100)}o.states.latencyLimitTime>200&&(v=g,o.states.latencyLimitTime-=5,o.states.latencyLimitTime>1e3&&(o.states.latencyLimitTime=1e3),o.states.updateBufMaxTime=1,o.states.updateBufTime=1,s=1);for(var p=0;16>p;p++){for(var h=o.playData.channels[p].notes,T=o.states.playIndices[p];T<h.length;T++){var w=h[T],S=t.currentTime-i.startTime;if(!(S>=w.stopTime||0==y&&S>w.startTime+.05||S+w.startTime<0)){if(S<w.startTime-o.states.updateBufTime/1e3)break;if(!n.isWebMIDI){if(o.states.stopFuncs.length>=350&&o.states.updateBufTime<1e3&&(o.states.updateBufTime=o.isFirefox()&&!o.isAndroid()?12:8,o.states.updateBufMaxTime=o.states.updateBufTime),-1!=o.settings.maxPoly||-1!=o.settings.maxPercPoly){var x=0,A=0;if(o.states.stopFuncs.forEach(function(e){e.note&&(9!=e.note.channel?w.start>=e.note.start&&w.start<e.note.stop&&x++:w.start==e.note.start&&A++)}),9!=w.channel&&x>=o.settings.maxPoly||9==w.channel&&A>=o.settings.maxPercPoly)continue}var E=9!=w.channel?o.createNote(w):o.createPercussionNote(w);if(!E)continue;o.pushFunc({note:w,stopFunc:E})}o.states.noteOnAry.push(w)}}o.states.playIndices[p]=T}for(var P=o.states.noteOnAry,M=o.states.noteOffAry,k=0;k<P.length;k++){var C=P[k],D=t.currentTime-i.startTime;C.startTime-D<=0&&(0==k?P.shift():k==P.length-1?P.pop():P.splice(k,1),M.push(C),r.isNoteTrigger&&r.noteOn(C),k--)}for(var k=0;k<M.length;k++){var C=M[k],D=t.currentTime-i.startTime;(9!=C.channel&&C.stopTime-D<=0||9==C.channel&&C.drumStopTime-D<=0)&&(0==k?M.shift():k==M.length-1?M.pop():M.splice(k,1),o.clearFunc("note",C),r.isNoteTrigger&&r.noteOff(C),k--)}if(n.isWebMIDI&&null!=n.WebMIDIPortOutput){for(var R=o.playData.messages,L=o.playData.smfData,T=o.states.playIndices[16];T<R.length;T++){var N=R[T],S=t.currentTime-i.startTime;if(!(S>N.time+1)){if(S<N.time-1)break;var B=N.smfPtrLen,_=N.smfPtr,O=N.time,I=L[_];if(255!=I)try{if(240==I||247==I){if(n.WebMIDIPortSysEx){var F=o.variableLengthToInt(L,_+1,_+1+4),j=_+1+F[1],V=j+F[0],$=new Uint8Array(1+F[0]);$[0]=I;for(var U=V-j,k=0;U>k;k++)$[k+1]=L[j+k];n.WebMIDIPortOutput.send($,1e3*(O-t.currentTime+window.performance.now()/1e3+i.startTime))}}else{for(var W=[],k=0;B>k;k++)W.push(L[_+k]);n.WebMIDIPortOutput.send(W,1e3*(O-t.currentTime+window.performance.now()/1e3+i.startTime))}}catch(q){console.log(q,_,B,O,I)}}}o.states.playIndices[16]=T}if(0==y){var G=setInterval(function(){a=b(a)},1);!function(e){o.pushFunc({rootTimeout:e,stopFunc:function(){clearInterval(e)}})}(G)}return y++,a}(h)}},e.prototype.setData=function(e){if(this.debug)var t=performance.now();if(this.states.isPlaying&&this.stop(),this.playData=e,this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming,this.firstNoteOnTime=e.firstNoteOnTime,this.lastNoteOffTime=e.lastNoteOffTime,this.initStatus(),this.debug){var n=performance.now();console.log("setData time",n-t)}return this},e.prototype.getMasterVolume=function(){return this.settings.masterVolume},e.prototype.setMasterVolume=function(e){this.settings.masterVolume=e,this.masterGainNode.gain.value=this.settings.masterVolume},e.prototype.isLoop=function(){return this.settings.loop},e.prototype.setLoop=function(e){this.settings.loop=e},e.prototype.isWebMIDI=function(){return this.settings.isWebMIDI},e.prototype.setWebMIDI=function(e){this.settings.isWebMIDI=e},e.prototype.isCC111=function(){return this.settings.isCC111},e.prototype.setCC111=function(e){this.settings.isCC111=e},e.prototype.setStartTime=function(e){this.states.startTime-=e},e.prototype.setOnSongEndListener=function(e){this.onSongEndListener=e},e.prototype.onSongEnd=function(){if(this.onSongEndListener){var e=this.onSongEndListener();if(e)return}this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.cc111Time),this.play(!0))},e.prototype.isReverb=function(){return this.settings.isReverb},e.prototype.setReverb=function(e){this.settings.isReverb=e},e.prototype.getReverbVolume=function(){return this.settings.reverbVolume},e.prototype.setReverbVolume=function(e){this.settings.reverbVolume=e},e.prototype.isChorus=function(){return this.settings.isChorus},e.prototype.setChorus=function(e){this.settings.isChorus=e},e.prototype.getChorusVolume=function(){return this.settings.chorusVolume},e.prototype.setChorusVolume=function(e){this.settings.chorusVolume=e},e.prototype.isAndroid=function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("android")&&-1==e.indexOf("windows")},e.prototype.isFirefox=function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("firefox")},e.prototype.isArmv7l=function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("armv7l")},e.prototype.measurePerformanceReverb=function(){for(var e=5e5,t=performance.now(),n=0;e>n&&!(performance.now()-t>=500);n++);return this.debug&&console.log("measurePerformanceReverb",n,performance.now()-t),e>n?!1:!0
},e.prototype.getTime=function(e){var t=0,n=this.tempoTrack.length-1,r=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].timing)return this.tempoTrack[this.tempoTrack.length-1].time;for(;;){r=Math.floor(t+(n-t)/2);var i=this.tempoTrack[r].timing;if(i>e)n=r-1;else{if(!(e>i))break;t=r+1}if(t>n){i>e&&r--;break}}}if(r>=0)var o=this.tempoTrack[r],a=o.time,s=o.timing,u=o.value;else var a=0,s=0,u=120;return a+=60/u/this.settings.resolution*(e-s)},e.prototype.getTiming=function(e){var t=0,n=this.tempoTrack.length-1,r=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].time)return this.tempoTrack[this.tempoTrack.length-1].timing;for(;;){r=Math.floor(t+(n-t)/2);var i=this.tempoTrack[r].time;if(i>e)n=r-1;else{if(!(e>i))break;t=r+1}if(t>n){i>e&&r--;break}}}if(r>=0)var o=this.tempoTrack[r],a=o.time,s=o.timing,u=o.value;else var a=0,s=0,u=120;return s+=(e-a)/(60/u/this.settings.resolution)},e.prototype.parseSMF=function(e){if(this.debug){console.log(e);var t=performance.now()}var n=this,r=new Uint8Array(e);if(77!=r[0]||84!=r[1]||104!=r[2]||100!=r[3])return"Not Sandard MIDI File.";var i=new Object,o=4,a=new Object;a.size=this.getInt(r,4,8),a.format=r[9],a.trackcount=this.getInt(r,10,12),a.timemanage=r[12],a.resolution=this.getInt(r,12,14),o+=4+a.size;for(var s=new Array,u=new Array,c=new Array,l=-1,f=-1,p=Number.MAX_SAFE_INTEGER,h=Number.MAX_SAFE_INTEGER,d=0,m=0,g=this.settings.isWebMIDI?17:16,v=0;g>v;v++){var y=new Object;c.push(y),y.indices=new Int32Array(Math.floor(r.length/8)),y.indicesLength=0,y.indicesHead=-1,y.indicesFoot=0,y.indicesCur=0,y.indicesPre=0,y.notes=[]}if(this.debug)var b=performance.now();var T=0;if(this.settings.isWebMIDI)var w=[];for(var S=0;S<a.trackcount;S++){if(77!=r[o]||84!=r[o+1]||114!=r[o+2]||107!=r[o+3])return"Irregular SMF.";o+=4;var x=o+4+this.getInt(r,o,o+4);o+=4;for(var A=0,E=120,P=0,M=0,k=1;x>o;){if(null!=k){var C=this.variableLengthToInt(r,o,o+5),D=C[0];A+=D,o+=C[1]}if(this.settings.isWebMIDI)var R=o,L=60/E/a.resolution*(A-P)+M;switch(Math.floor(r[o]/16)){case 8:case 9:case 10:case 11:case 14:k=r[o];var N=c[15&k];this.chIndicesSplice(N,A,o,3),o+=3;break;case 12:case 13:k=r[o];var N=c[15&k];this.chIndicesSplice(N,A,o,2),o+=2;break;case 15:switch(r[o]){case 240:case 247:var C=this.variableLengthToInt(r,o+1,o+1+4);if(C[0]>=7&&127==r[o+2]&&127==r[o+3]&&4==r[o+4]&&1==r[o+5])for(var v=0;16>v;v++){var N=c[v];this.chIndicesSplice(N,A,o,C[0])}o+=1+C[1]+C[0];break;case 241:o+=2;break;case 242:o+=3;break;case 243:o+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:o+=1;break;case 255:switch(r[o+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:A+=(this.settings.isSkipEnding?0:a.resolution)-D;break;case 81:for(var v=0;16>v;v++){var N=c[v];this.chIndicesSplice(N,A,o,6)}M+=60/E/a.resolution*(A-P),P=A,E=6e7/(65536*r[o+3]+256*r[o+4]+r[o+5]),s.push({timing:A,time:M,value:E});break;case 84:break;case 88:u.push({timing:A,value:[r[o+3],Math.pow(2,r[o+4])]});break;case 89:case 127:}var C=this.variableLengthToInt(r,o+2,o+2+4);o+=2+C[1]+C[0]}break;default:if(null==k)return"Irregular SMF.";o--,r[o]=k,k=null}this.settings.isWebMIDI&&null!=k&&this.chIndicesSplice(c[16],A,R,o-R)}!this.settings.isSkipEnding&&A>T&&(T=A);for(var v=0;v<c.length;v++)c[v].indicesCur=c[v].indicesHead,c[v].indicesPre=c[v].indicesHead}if(this.debug)var B=performance.now();for(var N=0;16>N;N++){for(var y=c[N],_=2,O=0,I=64,F=127,j=100,V=0,$=0,U=this.isTonyu2?0:10,W=0,q=127,G=127,Z=127,z=127,H=0,J=127,E=120,P=0,M=0,K=[],Q=y.indicesHead,Y=y.indices,X=new Array(128);-1!=Q;){var A=Y[Q],o=Y[Q+2],et=Y[Q+3],L=60/E/a.resolution*(A-P)+M;switch(Math.floor(r[o]/16)){case 8:K.some(function(e,t){var i=y.notes[e];return i.pitch==r[o+1]&&null==i.stop?($>=n.settings.holdOnValue?null==i.holdBeforeStop&&(i.holdBeforeStop=[{timing:A,time:L,value:$}]):(i.stop=A,i.stopTime=L,t==K.length-1?K.pop():0==t?K.shift():K.splice(t,1)),A>d&&(d=A,m=L),!0):void 0});break;case 9:if(0!=r[o+2]){n.settings.resolution=a.resolution;var tt={start:A,stop:null,startTime:L,stopTime:null,pitch:r[o+1],pitchBend:[{timing:A,time:L,value:O}],pan:[{timing:A,time:L,value:I}],expression:[{timing:A,time:L,value:F*(J/127)}],velocity:r[o+2]/127*(j/127),modulation:[{timing:A,time:L,value:V}],holdBeforeStop:null,reverb:[{timing:A,time:L,value:U}],chorus:[{timing:A,time:L,value:W}],instrument:H,channel:N,nextSameNoteOnInterval:-1,drumStopTime:2},nt=X[r[o+1]];nt&&(nt.nextSameNoteOnInterval=L-nt.startTime),X[r[o+1]]=tt,K.some(function(e,t){var n=y.notes[e];n.pitch==r[o+1]&&null==n.stop&&(n.stop=A,n.stopTime=L,t==K.length-1?K.pop():0==t?K.shift():K.splice(t,1))}),K.push(y.notes.length),y.notes.push(tt),p>A&&(p=A,h=L)}else K.some(function(e,t){var i=y.notes[e];return i.pitch==r[o+1]&&null==i.stop?($>=n.settings.holdOnValue?null==i.holdBeforeStop&&(i.holdBeforeStop=[{timing:A,time:L,value:$}]):(i.stop=A,i.stopTime=L,t==K.length-1?K.pop():0==t?K.shift():K.splice(t,1)),A>d&&(d=A,m=L),!0):void 0});break;case 10:break;case 11:switch(r[o+1]){case 1:V=r[o+2],K.forEach(function(e){var t=y.notes[e];t.modulation.push({timing:A,time:L,value:V})});break;case 6:0==Z&&0==z&&(_=r[o+2],_>24&&(_=24));break;case 7:j=r[o+2];break;case 10:I=r[o+2],K.forEach(function(e){var t=y.notes[e];t.pan.push({timing:A,time:L,value:I})});break;case 11:F=r[o+2],K.forEach(function(e){var t=y.notes[e];t.expression.push({timing:A,time:L,value:F*(J/127)})});break;case 64:if($=r[o+2],$<this.settings.holdOnValue)for(var v=K.length-1;v>=0;v--){var rt=K[v],tt=y.notes[rt];null==tt.stop&&null!=tt.holdBeforeStop&&(tt.stop=A,tt.stopTime=L,v==K.length-1?K.pop():0==v?K.shift():K.splice(v,1))}break;case 91:U=r[o+2],K.forEach(function(e){var t=y.notes[e];t.reverb.push({timing:A,time:L,value:U})});break;case 93:W=r[o+2],K.forEach(function(e){var t=y.notes[e];t.chorus.push({timing:A,time:L,value:W})});break;case 98:q=r[o+2];break;case 99:G=r[o+2];break;case 100:Z=r[o+2];break;case 101:z=r[o+2];break;case 111:-1==l&&(l=A,f=L)}break;case 12:H=r[o+1];break;case 13:break;case 14:O=(128*r[o+2]+r[o+1]-8192)/8192*_,K.forEach(function(e){var t=y.notes[e];t.pitchBend.push({timing:A,time:L,value:O})});break;case 15:switch(r[o]){case 240:case 247:if(127==r[o+1]&&127==r[o+2]&&4==r[o+3]&&1==r[o+4]){var it=r[o+6];it>127&&(it=127),J=it,K.forEach(function(e){var t=y.notes[e];t.expression.push({timing:A,time:L,value:F*(J/127)})})}break;case 255:switch(r[o+1]){case 81:M+=60/E/a.resolution*(A-P),P=A,E=6e7/(65536*r[o+3]+256*r[o+4]+r[o+5])}}break;default:return"Error parseSMF."}Q=et}y.nowNoteOnIdxAry=K,this.debug||delete y.indices}for(var N=0;16>N;N++){for(var y=c[N],K=c[N].nowNoteOnIdxAry,v=K.length-1;v>=0;v--){var tt=y.notes[K[v]];if(null==tt.stop){tt.stop=d,tt.stopTime=m;var ot=["pitchBend","pan","expression","modulation","reverb","chorus"];ot.forEach(function(e){for(var t=tt[e],n=t.length-1;n>=1;n--){var r=t[n];r.timing>d&&(n==t.length-1?t.pop():0==n?t.shift():t.splice(n,1))}}),v==K.length-1?K.pop():0==v?K.shift():K.splice(v,1)}}delete y.nowNoteOnIdxAry}if(this.settings.isSkipEnding&&(T=d),s.push({timing:T,time:60/E/a.resolution*(T-P)+M,value:120}),this.settings.isWebMIDI)for(var y=c[16],E=120,P=0,M=0,Q=y.indicesHead,Y=y.indices;-1!=Q;){var A=Y[Q],at=Y[Q+1],o=Y[Q+2],et=Y[Q+3],L=60/E/a.resolution*(A-P)+M;switch(r[o]){case 255:switch(r[o+1]){case 81:M+=60/E/a.resolution*(A-P),P=A,E=6e7/(65536*r[o+3]+256*r[o+4]+r[o+5])}}w.push({time:L,tick:A,smfPtr:o,smfPtrLen:at}),Q=et}if(i.header=a,i.tempoTrack=s,i.beatTrack=u,i.channels=c,i.songLength=T,i.cc111Tick=l,i.cc111Time=f,i.firstNoteOnTiming=p,i.firstNoteOnTime=h,i.lastNoteOffTiming=d,i.lastNoteOffTime=m,this.settings.isWebMIDI&&(i.messages=w,i.smfData=new Uint8Array(r)),this.debug){var st=performance.now();console.log("parseSMF time",st-t),console.log("parseSMF(0/2) time",b-t),console.log("parseSMF(1/2) time",B-t),console.log("parseSMF(2/2) time",st-B),console.log(i)}return i},e.prototype.getInt=function(e,t,n){for(var r=0,i=t;n>i;i++)r=(r<<8)+e[i];return r},e.prototype.variableLengthToInt=function(e,t,n){for(var r=t,i=0;n-1>r&&e[r]>=128;)t+4>r&&(i=(i<<7)+(e[r]-128)),r++;return i=(i<<7)+e[r],r++,[i,r-t]},e.prototype.chIndicesSplice=function(e,t,n,r){var i=e.indices;if(i.length<=e.indicesLength+4){if(this.debug)var o=performance.now();for(var a=new Int32Array(Math.floor(2*i.length)),s=i.length-1;s>=0;s--)a[s]=i[s];e.indices=i=a,this.debug&&console.log("malloc",performance.now()-o,a.length)}if(e.indicesLength>=4&&t<i[e.indicesFoot])for(;-1!=e.indicesCur;){if(t<i[e.indicesCur]){e.indicesCur==e.indicesHead?e.indicesHead=e.indicesLength:i[e.indicesPre+3]=e.indicesLength,i[e.indicesLength]=t,i[e.indicesLength+1]=r,i[e.indicesLength+2]=n,i[e.indicesLength+3]=e.indicesCur,e.indicesPre=e.indicesLength,e.indicesLength+=4;break}e.indicesPre=e.indicesCur,e.indicesCur=i[e.indicesCur+3]}else e.indicesLength>=4?i[e.indicesFoot+3]=e.indicesLength:e.indicesHead=0,e.indicesFoot=e.indicesLength,i[e.indicesLength]=t,i[e.indicesLength+1]=r,i[e.indicesLength+2]=n,i[e.indicesLength+3]=-1,e.indicesLength+=4},e.prototype.stopAudioNode=function(e,t,n,r){var i=t<=this.context.currentTime;if(i)if(r)var o=this.context.currentTime,a=this.context.currentTime+.005;else var a=this.context.currentTime;else var o=t-.005,a=t;try{r?(e.stop(a),n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(1,o),n.gain.linearRampToValueAtTime(0,a)):e.stop(a)}catch(s){n.gain.cancelScheduledValues(0),r?(n.gain.setValueAtTime(1,o),n.gain.linearRampToValueAtTime(0,a)):n.gain.setValueAtTime(0,a)}},e.prototype.pushFunc=function(e){(e.note||e.rootTimeout||e.pan||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)},e.prototype.clearFunc=function(e,t){if("note"==e||"rootTimeout"==e||"pan"==e||this.trigger.isNoteTrigger){var n=this;n.states.stopFuncs.some(function(n,r,i){return n[e]==t?(0==r?i.shift():r==i.length-1?i.pop():i.splice(r,1),!0):void 0})}},e}();define("PicoAudio",[],function(){return PicoAudio}),requireSimulator.setName("T2MediaLib");var T2MediaLib=function(){var e=function(e){this.context=null,this.picoAudio=null,this.soundDataAry=[],this.bgmPlayerMax=16,this.bgmPlayerAry=[],this.masterVolume=1,this.seMasterVolume=1,this.bgmMasterVolume=1,this.playingAudio=null,this.audioVolume=1,this.audioTempo=1,this.audioDataAry={data:[]},this.seSources=[],this.init(e)};return e.prototype.init=function(e){if(!this.inited&&(this.inited=!0,!this.disabled&&(e?this.context=e:window.AudioContext?this.context=new AudioContext:window.webkitAudioContext?this.context=new webkitAudioContext:(this.context=null,console.log("Your browser does not support yet Web Audio API")),this.context)))for(var t=0;t<this.bgmPlayerMax;t++)this.bgmPlayerAry[t]=new T2MediaLib_BGMPlayer(this,t)},e.prototype.allClearSoundData=function(){var e=this.soundDataAry;for(var t in e)delete e[t]},e.prototype.clearSoundData=function(e){var t=this.soundDataAry;delete t[e]},e.prototype.allRemoveDecodedSoundData=function(){var e=this.soundDataAry;for(var t in e){var n=e[t];null!=n&&(n.isDecodeComplete()||n.isDecoding())&&n.removeDecodedData()}},e.prototype.removeDecodedSoundData=function(e){var t=this.soundDataAry[e];null!=t&&(t.isDecodeComplete()||t.isDecoding())&&t.removeDecodedData()},e.prototype.getMasterVolume=function(){return this.masterVolume},e.prototype.setMasterVolume=function(e){this.masterVolume=e;for(var t=0;t<this.bgmPlayerMax;t++){var n=this.bgmPlayerAry[t];n instanceof T2MediaLib_BGMPlayer&&n.onChangeBGMMasterVolume()}},e.prototype.createSoundFromArray=function(e,t,n){this.soundDataAry[e]=new T2MediaLib_SoundData;for(var r=this.context,i=null!=t&&null!=n?2:1,o=r.createBuffer(i,array.length,r.sampleRate),a=o.getChannelData(0),s=null!=n?o.getChannelData(1):null,u=0;u<array.length;u++)a[u]=t[u];if(s)for(var u=0;u<array.length;u++)s[u]=n[u];this.soundDataAry[e].onDecodeComplete(o)},e.prototype.loadSound=function(e,t,n){if(this.soundDataAry[e]=new T2MediaLib_SoundData,!this.context||this.disabled)return this.soundDataAry[e].onError("FUNC_DISABLED_ERROR"),null;(t.match(/\.(midi?)$/)||t.match(/^data:audio\/mid/))&&null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.context)),"object"==typeof WebSite&&WebSite.mp3Disabled&&(t=t.replace(/\.(mp3|mp4|m4a)$/,".ogg"));var r=this,i=new XMLHttpRequest;if(i.onload=function(){if(200===i.status||0===i.status){var t=i.response;t instanceof ArrayBuffer?(r.soundDataAry[e].onLoadComplete(t),n&&n.succ&&n.succ(e)):(r.soundDataAry[e].onError("XHR_RESPONSE_ERROR"),n&&n.err&&n.err(e,r.soundDataAry[e].errorID))}else r.soundDataAry[e].onError("XHR_STATUS_ERROR"),n&&n.err&&n.err(e,r.soundDataAry[e].errorID)},i.onerror=function(t){console.log(t+""),r.soundDataAry[e].onError("XHR_ERROR"),n&&n.err&&n.err(e,r.soundDataAry[e].errorID)},this.soundDataAry[e].onLoad(t),t.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer)i={onload:i.onload},i.response=Util.Base64_To_ArrayBuffer(t.replace(/^data:audio\/[a-zA-Z0-9\-]+;base64,/i,"")),i.status=200,i.onload();else{i.open("GET",t,!0),i.responseType="arraybuffer";try{i.send(null)}catch(o){this.soundDataAry[e].onError("FILE_NOT_FOUND")}}},e.prototype.decodeSound=function(e,t){var n=this.soundDataAry[e];if(null!=n&&null!=n.fileData&&n.isLoadComplete()&&!n.isDecodeComplete()){if(null==n.decodedCallbacksAry&&(n.decodedCallbacksAry=[]),t)if(null!=t.bgmPlayerId){var r=n.decodedCallbacksAry.some(function(e,r){return t.bgmPlayerId==e.bgmPlayerId?(n.decodedCallbacksAry[r]=t,!0):!1});r||n.decodedCallbacksAry.push(t)}else n.decodedCallbacksAry.push(t);if(!n.isDecoding()){n.onDecode();var i=n.fileData.slice(0);if(n.url.match(/\.(midi?)$/)||n.url.match(/^data:audio\/mid/)){null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.context));var o=new Uint8Array(i),a=this.picoAudio.parseSMF(o);"string"==typeof a?(console.log("T2MediaLib: Error parseSMF()",a),this.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,this.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null):(this.soundDataAry[e].onDecodeComplete(a),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)}else if(n.url.match(/\.mzo$/)||n.url.match(/^data:audio\/mzo/)){console.log("Loading mzo");var s=this,u=new Mezonet(this.context),c=Array.prototype.slice.call(new Uint8Array(i));u.load(c),u.toAudioBuffer().then(function(t){console.log("MZO loaded",t),s.soundDataAry[e].isDecoding()&&(s.soundDataAry[e].onDecodeComplete(t.decodedData),s.soundDataAry[e].loopStart=t.loopStart,n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)},function(t){t instanceof Error?console.log("T2MediaLib: "+t.message,n.url):console.log("T2MediaLib: Error decodeMZO()",n.url),s.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,s.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null})}else{var s=this,l=function(t){s.soundDataAry[e].isDecoding()&&(s.soundDataAry[e].onDecodeComplete(t),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)},f=function(t){t instanceof Error?console.log("T2MediaLib: "+t.message,n.url):console.log("T2MediaLib: Error decodeAudioData()",n.url),s.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,s.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null};this.context.decodeAudioData(i,l,f)}}}},e.prototype.activate=function(){if(this.init(),this.context){if(!this.isContextResumed&&this.context.resume){var e=this;this.context.resume().then(function(){e.isContextResumed=!0})}if(!this.isActivated){this.isActivated=!0;for(var t=this.context.createBuffer(1,Math.floor(this.context.sampleRate/32),this.context.sampleRate),n=t.getChannelData(0),r=0;r<n.length;r++)n[r]=0;var i=this.context.createBufferSource();i.buffer=t,i.connect(this.context.destination),i.start=i.start||i.noteOn,i.start(0)}}},e.prototype.getSoundFileData=function(e){var t=this.soundDataAry[e];return t?t.fileData:null},e.prototype.getSoundDecodedData=function(e){var t=this.soundDataAry[e];return t?t.decodedData:null},e.prototype.getCurrentTime=function(){return this.context?this.context.currentTime:null},e.prototype.playSE=function(e,t,n,r,i,o,a,s,u,c){if(!this.context)return null;var l=this.soundDataAry[e];if(null==l)return null;if(!l.isDecodeComplete()){var f=this,p={};return p.succ=function(e){f.playSE(e,t,n,r,i,o,a,s,u,c)},p.err=function(){},this.decodeSound(e,p),null}var h=l.decodedData;if(!(h instanceof AudioBuffer))return null;null==t&&(t=1),null==n&&(n=0),r||(r=1),i?i>h.duration?i=h.duration:0>i&&(i=0):i=0,durationStart=c,c||(durationStart=86400),o||(o=!1),a?0>a?a=0:a>h.duration&&(a=h.duration):a=l.loopStart||0,s?0>s?s=0:s>h.duration&&(s=h.duration):s=h.duration,u=u||0;var d=this.context.createBufferSource();this.context.createGain=this.context.createGain||this.context.createGainNode;var m=this.context.createGain(),g=this.context.createPanner();d.buffer=h,d.loop=o,d.loopStart=a,d.loopEnd=s,d.playbackRate.value=r,d.connect(m),m.connect(g),g.connect(this.context.destination),g.panningModel="equalpower",-1>n?n=-1:n>1&&(n=1);var v=90*n,y=Math.sin(v*(Math.PI/180)),b=-Math.cos(v*(Math.PI/180));(-1===n||1===n)&&(b=0),g.positionX?(g.positionX.value=y,g.positionY.value=0,g.positionZ.value=b):g.setPosition(y,0,b),m.gain.value=t*this.seMasterVolume*this.masterVolume;var T;T=o&&s-a>0&&i>s?s:i,d.gainNode=m,d.volumeValue=t,d.panNode=g,d.panValue=n,d.playStartTime=this.context.currentTime+u,d.playOffset=T,d.plusTime=T,d.start=d.start||d.noteOn,d.stop=d.stop||d.noteOff,d.start(u,i,durationStart),o&&null!=c&&d.stop(u+c);var w=this;return w.seSources.push(d),d.onended=function(){d.onended=null;var e=w.seSources.indexOf(d);e>=0&&w.seSources.splice(e,1)},d},e.prototype.stopSE=function(e){if(!(e instanceof AudioBufferSourceNode))return null;try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}return e},e.prototype.stopAllSE=function(){var e=this;this.seSources.forEach(function(t){e.stopSE(t)})},e.prototype.getSEMasterVolume=function(){return this.seMasterVolume},e.prototype.setSEMasterVolume=function(e){this.seMasterVolume=e},e.prototype.getSEVolume=function(e){return e instanceof AudioBufferSourceNode?source.volumeValue:null},e.prototype.setSEVolume=function(e,t){return e instanceof AudioBufferSourceNode?(e.gainNode.gain.value=t*this.seMasterVolume*this.masterVolume,source.volumeValue=t,e):null},e.prototype.getSERate=function(e){return e instanceof AudioBufferSourceNode?e.playbackRate.value:null},e.prototype.setSERate=function(e,t){return e instanceof AudioBufferSourceNode?void(e.playbackRate.value=t):null},e.prototype.getSEPan=function(e){return e instanceof AudioBufferSourceNode?e.panValue:null},e.prototype.setSEPan=function(e,t){if(!(e instanceof AudioBufferSourceNode))return null;var n=e.panNode;-1>t?t=-1:t>1&&(t=1);var r=90*t,i=Math.sin(r*(Math.PI/180)),o=Math.cos(r*(Math.PI/180));(-1===t||1===t)&&(o=0),n.positionX?(n.positionX.value=i,n.positionY.value=0,n.positionZ.value=o):n.setPosition(i,0,o),e.panValue=t},e.prototype.isSELoop=function(e){return e instanceof AudioBufferSourceNode?e.loop:null},e.prototype.setSELoop=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loop=t):null},e.prototype.getSELoopStartTime=function(e){return e instanceof AudioBufferSourceNode?e.loopStart:null},e.prototype.setSELoopStartTime=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopStart=t):null},e.prototype.getSELoopEndTime=function(e){return e instanceof AudioBufferSourceNode?e.loopEnd:null},e.prototype.setSELoopEndTime=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopEnd=t):null},e.prototype.playBGM=function(e,t,n,r,i,o){if(!this.context)return null;var a=this._getBgmPlayer(e);return a?a.playBGM(t,n,r,i,o):null},e.prototype.stopBGM=function(e){var t=this._getBgmPlayer(e);return t?t.stopBGM():null},e.prototype.pauseBGM=function(e){var t=this._getBgmPlayer(e);return t?t.pauseBGM():null},e.prototype.resumeBGM=function(e){var t=this._getBgmPlayer(e);return t?t.resumeBGM():null},e.prototype.getBGMMasterVolume=function(){return this.bgmMasterVolume},e.prototype.setBGMMasterVolume=function(e){this.bgmMasterVolume=e;for(var t=0;t<this.bgmPlayerMax;t++){var n=this.bgmPlayerAry[t];n instanceof T2MediaLib_BGMPlayer&&n.onChangeBGMMasterVolume()}},e.prototype.getBGMVolume=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMVolume():null},e.prototype.setBGMVolume=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMVolume(t):null},e.prototype.getBGMTempo=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMTempo():null},e.prototype.setBGMTempo=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMTempo(t):null},e.prototype.getBGMPan=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMPan():null},e.prototype.setBGMPan=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMPan(t):null},e.prototype.isBGMLoop=function(e){var t=this._getBgmPlayer(e);return t?t.isBGMLoop():null},e.prototype.setBGMLoop=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoop(t):null},e.prototype.getBGMLoopStartTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLoopStartTime():null},e.prototype.setBGMLoopStartTime=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoopStartTime(t):null},e.prototype.getBGMLoopEndTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLoopEndTime():null},e.prototype.setBGMLoopEndTime=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoopEndTime(t):null},e.prototype.getBGMCurrentTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMCurrentTime():null},e.prototype.getBGMLength=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLength():null},e.prototype.getPlayingBGMName=function(e){var t=this._getBgmPlayer(e);return t?t.getPlayingBGMName():null},e.prototype.setOnBGMEndListener=function(e,t){var n=this._getBgmPlayer(e);return n?n.setOnBGMEndListener(t):null},e.prototype.getPlayingBGMState=function(e){var t=this._getBgmPlayer(e);return t?t.getPlayingBGMState():null},e.prototype.getBGMPicoAudio=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMPicoAudio():null},e.prototype.getBGMPlayerMax=function(){return this.bgmPlayerMax},e.prototype.allStopBGM=function(){for(var e=0;e<this.bgmPlayerMax;e++)this.stopBGM(e)},e.prototype.allResetBGM=function(){for(var e=0;e<this.bgmPlayerMax;e++)this.stopBGM(e),this.setBGMVolume(e,1),this.setBGMTempo(e,1),this.setBGMPan(e,0);this.setMasterVolume(1),this.setSEMasterVolume(1),this.setBGMMasterVolume(1)},e.prototype._getBgmPlayer=function(e){if(0>e||this.bgmPlayerMax<=e)return null;var t=this.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t:null},e.prototype.loadAudio=function(e,t){var n=new Audio(t);n.play(),this.audioDataAry.data[e]=null;var r=this;n.addEventListener("loadstart",function(){if(!r.context)return null;var e=r.context.createMediaElementSource(n);e.connect(r.context.destination)},!1),n.addEventListener("canplay",function(){this.audioDataAry.data[e]=n},!1),n.load()},e.prototype.playAudio=function(e,t,n){var r=this.audioDataAry.data[e];return r?(n||(n=0),this.playingAudio instanceof Audio&&(this.playingAudio.pause(),this.playingAudio.currentTime=0),this.playingAudio=r,r.loop=t,r.volume=this.audioVolume,r.currentTime=n,r.play(),r):null},e.prototype.stopAudio=function(){var e=this.playingAudio;return e instanceof Audio?(e.pause(),e.currentTime=0,this.playingAudio=null,e):null},e.prototype.pauseAudio=function(){var e=this.playingAudio;return e?(e.pause(),e):null},e.prototype.resumeAudio=function(){var e=this.playingAudio;return e?(e.play(),e):null},e.prototype.setAudioVolume=function(e){this.audioVolume=e,this.playingAudio instanceof Audio&&(this.playingAudio.volume=e)},e.prototype.setAudioTempo=function(e){this.audioTempo=e,this.playingAudio instanceof Audio&&(this.playingAudio.playbackRate=e)},e.prototype.setAudioPosition=function(e){this.playingAudio instanceof Audio&&(this.playingAudio.currentTime=e)},e.prototype.getAudioData=function(e){return this.audioDataAry.data[e]},e.prototype.getAudioCurrentTime=function(){return this.playingAudio instanceof Audio?this.playingAudio.currentTime:null},e.prototype.getAudioLength=function(){return this.playingAudio instanceof Audio?this.playingAudio.duration:null},e}(),T2MediaLib_BGMPlayer=function(){var e=function(e,t){this.t2MediaLib=e,this.id=t,this.playingBGMState="stop",this.playingBGMStatePending=null,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1,this.bgmPan=0,this.picoAudio=null,this.picoAudioSetDataBGMName=null,this.PICO_AUDIO_VOLUME_COEF=1};return e.prototype.playBGM=function(e,t,n,r,i){this.stopBGM();var o=this.t2MediaLib.soundDataAry[e];if(null==o)return null;if(!o.isDecodeComplete()){var a=this,s={};return s.bgmPlayerId=this.id,s.succ=function(){var o=a.playingBGMStatePending;a._setPlayingBGMState("stop",!0),"stop"!=o&&a.playingBGMName==e&&a.playBGM(e,t,n,r,i),"pause"==o&&a.pauseBGM()},s.err=function(){a._setPlayingBGMState("stop",!0)},this.playingBGMName=e,this._setPlayingBGMState("decoding",!0),this._setPlayingBGMState("play"),this.t2MediaLib.decodeSound(e,s),this}var u=o.decodedData;if(u instanceof AudioBuffer)this.playingBGM=this.t2MediaLib.playSE(e,this.bgmVolume,this.bgmPan,this.bgmTempo,n,t,r,i);else if(u instanceof Object){if(this._initPicoAudio(),e!=this.picoAudioSetDataBGMName?(this.picoAudio.setData(u),this.picoAudioSetDataBGMName=e):this.picoAudio.initStatus(),this.picoAudio.setLoop(t),this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*this.bgmVolume*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume),n){var c=this.picoAudio.getTime(Number.MAX_SAFE_INTEGER);n>c?n=c:0>n&&(n=0)}else n=0;this.picoAudio.setStartTime(n),this.picoAudio.play(),this.playingBGM=this.picoAudio}return this.playingBGMName=e,this.bgmPause=0,this._setPlayingBGMState("play"),this},e.prototype.stopBGM=function(){var e=this.playingBGM;if(e instanceof PicoAudio)this.picoAudio.stop();else if(e instanceof AudioBufferSourceNode)try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}return this.playingBGM=null,this.playingBGMName=null,this._setPlayingBGMState("stop"),this},e.prototype.pauseBGM=function(){var e=this.playingBGM;if(e instanceof PicoAudio)0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseCurrentTime=e.context.currentTime,e.stop(),this.bgmPause=1);else if(e instanceof AudioBufferSourceNode&&0===this.bgmPause){this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=this.t2MediaLib.getSELoopStartTime(e),this.bgmPauseLoopEnd=this.t2MediaLib.getSELoopEndTime(e),this.bgmPauseLoop=this.t2MediaLib.isSELoop(e),this.bgmPauseCurrentTime=e.context.currentTime,this.bgmPauseTempo=this.bgmTempo;try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}this.bgmPause=1}return"stop"!=this.playingBGMState&&this._setPlayingBGMState("pause"),this},e.prototype.resumeBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?1===this.bgmPause&&(e.play(),this.bgmPause=0):e instanceof AudioBufferSourceNode&&1===this.bgmPause&&(e=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd)),this},e.prototype.onChangeBGMMasterVolume=function(){this.setBGMVolume(this.getBGMVolume())},e.prototype.getBGMVolume=function(){return this.bgmVolume},e.prototype.setBGMVolume=function(e){var t=this.playingBGM;return this.bgmVolume=e,t instanceof PicoAudio?this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*e*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume):t instanceof AudioBufferSourceNode&&(t.gainNode.gain.value=e*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume),this},e.prototype.getBGMTempo=function(){return this.bgmTempo},e.prototype.setBGMTempo=function(e){var t=this.playingBGM;return(0>=e||isNaN(e))&&(e=1),t instanceof AudioBufferSourceNode&&0===this.bgmPause&&(t.plusTime-=(this.t2MediaLib.context.currentTime-t.playStartTime)*(e-this.bgmTempo)),this.bgmTempo=e,this.t2MediaLib.setSERate(t,e),this},e.prototype.getBGMPan=function(){return this.bgmPan},e.prototype.setBGMPan=function(e){var t=this.playingBGM;return this.bgmPan=e,t instanceof AudioBufferSourceNode&&this.t2MediaLib.setSEPan(t,e),this},e.prototype.isBGMLoop=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.isLoop():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoop:this.t2MediaLib.isSELoop(e):null},e.prototype.setBGMLoop=function(e){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.setLoop(e):t instanceof AudioBufferSourceNode&&(1===this.bgmPause?this.bgmPauseLoop=e:this.t2MediaLib.setSELoop(t,e)),this},e.prototype.getBGMLoopStartTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?0:e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopStart:this.t2MediaLib.getSELoopStartTime(e):null},e.prototype.setBGMLoopStartTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return this.t2MediaLib.setSELoopStartTime(t,e);this.bgmPauseLoopStart=e}return this},e.prototype.getBGMLoopEndTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.getBGMLength():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopEnd:this.t2MediaLib.getSELoopEndTime(e):null},e.prototype.setBGMLoopEndTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return this.t2MediaLib.setSELoopEndTime(t,e);this.bgmPauseLoopEnd=e}return this},e.prototype.getBGMCurrentTime=function(){var e=this.playingBGM;if(e instanceof PicoAudio){var t;return t=0===this.bgmPause?this.picoAudio.context.currentTime-this.picoAudio.states.startTime:this.bgmPauseTime}if(e instanceof AudioBufferSourceNode){var t,n,r,i,o,a,s;return 0===this.bgmPause?(r=this.t2MediaLib.context.currentTime,i=this.bgmTempo):(r=this.bgmPauseCurrentTime,i=this.bgmPauseTempo),n=(r-e.playStartTime)*i+e.plusTime,e.loop&&(e.loopEnd-e.loopStart>0?n<e.loopStart?(o=0,a=0,s=e.buffer.duration):(o=e.loopStart,a=e.loopStart,s=e.loopEnd-e.loopStart):(s=e.buffer.duration,o=0,a=0)),e.loop?t=(n-a)%s+o:(t=n,t>e.buffer.duration&&(t=e.buffer.duration)),t}return null},e.prototype.getBGMLength=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.getTime(Number.MAX_SAFE_INTEGER):e instanceof AudioBufferSourceNode?e.buffer.duration:null},e.prototype.getPlayingBGMName=function(){return this.playingBGMName},e.prototype.setOnBGMEndListener=function(e){null!=this.picoAudio&&this.picoAudio.setOnSongEndListener(e)},e.prototype.getPlayingBGMState=function(){return this.playingBGMState},e.prototype.getBGMPicoAudio=function(){return this._initPicoAudio(),this.picoAudio},e.prototype._setPlayingBGMState=function(e,t){t||"decoding"!=this.playingBGMState?(this.playingBGMState=e,this.playingBGMStatePending=null):this.playingBGMStatePending=e},e.prototype._initPicoAudio=function(){null==this.picoAudio&&(0==this.id&&(this.picoAudio=this.t2MediaLib.picoAudio),null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.t2MediaLib.context,this.t2MediaLib.picoAudio)))},e}(),T2MediaLib_SoundData=function(){var e=function(){this.state="none",this.errorID=null,this.url=null,this.fileData=null,this.decodedData=null,this.decodedCallbacksAry=null};return e.prototype.onLoad=function(e){this.state="loading",this.url=e},e.prototype.onLoadComplete=function(e){this.state="loaded",this.fileData=e
},e.prototype.onDecode=function(){this.state="decoding"},e.prototype.onDecodeComplete=function(e){this.state="decoded",this.decodedData=e},e.prototype.onError=function(e){this.state="error",this.errorID=e},e.prototype.isLoadComplete=function(){switch(this.state){case"loaded":case"decoding":case"decoded":return!0}return!1},e.prototype.isDecoding=function(){return"decoding"==this.state},e.prototype.isDecodeComplete=function(){return"decoded"==this.state},e.prototype.removeDecodedData=function(){this.state="loaded",this.decodedData=null},e}();define("T2MediaLib",[],function(){return T2MediaLib}),requireSimulator.setName("UIDiag"),define(["UI"],function(e){function t(e,t){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"undefined"!=typeof $&&e instanceof $?{title:e.title||t,body:e}:e}var n={};return n.confirm=function(n){function r(e){return function(){o.resolve(e),i.dialog("close"),i.remove()}}n=t(n,"確認");var i=e("div",{title:n.title},["div",n.body],["button",{on:{click:r(!0)}},"OK"],["button",{on:{click:r(!1)}},"キャンセル"]).dialog({width:"auto",close:r(!1)}),o=$.Deferred();return o.promise()},n.alert=function(n){function r(e){return function(){o.resolve(e),i.dialog("close"),i.remove()}}n=t(n,"確認");var i=e("div",{title:n.title},["div",n.body],["button",{on:{click:r(!0)}},"OK"]).dialog({width:"auto",close:r(!1)}),o=$.Deferred();return o.promise()},n.open=function(e,t,r,i,o,a,s){return n.prompt({title:e,body:t},r,{left:i,top:o,width:a,height:s})},n.getStatus=function(){return n.status},n.getText=function(){return n.resultValue},n.prompt=function(r,i,o){function a(){n.status=1;var e=u.$vars.val.val();n.resultValue=e,c.resolve(e),u.dialog("close"),u.remove()}function s(){n.status=2,u.dialog("close"),u.remove(),c.resolve()}r=t(r,"入力"),o=o||{},position="number"==typeof o.left&&"number"==typeof o.top?{my:"left top",at:"left+"+o.left+" top+"+o.top,of:"body"}:{of:"body",at:"center",my:"center"};var u=e("div",{title:r.title},["div",r.body],["input",{on:{enterkey:a},$var:"val",value:i}],["br"],["button",{on:{click:a}},"OK"],["button",{on:{click:s}},"キャンセル"]).dialog({width:o.width||"auto",height:o.height||"auto",position:position,close:function(){u.dialog("close"),c.resolve()}});setTimeout(function(){u.$vars.val.focus()},10),n.status=0;var c=$.Deferred();return c.promise()},"undefined"!=typeof window&&(window.UIDiag=n),n}),requireSimulator.setName("SEnv"),define("SEnv",["Klass","assert"],function(e){var t,n,r=10,i=32,o=32,a=96,s=48e3,u=99,c=100,l=101,f=102,p=103,h=104,d=105,m=106,g=107,v=108,y=109,b=110,T=111,w=112,S=113,x=114,A=115,E=116,P=117,M=118,k=119,C=120,D=255,R=0,L=16,N=16,B=256,_=function(e,t){return Math.trunc(O(e,"x")/O(t,"y"))},O=function(e,t){if(e!==e)throw new Error(t+": Not a number!");if("number"!=typeof e)throw console.error(e),new Error(t+": Not a not a number but not a number!");return e},I=(Math.abs.bind(Math),function(e){return e>=128?e-256:e}),F=function(e,t){for(var n=[],r=t;e[r];r++)n.push(e[r]);return n},j=function(e,t){var n=e[t];return n+=256*e[t+1],n+=65536*e[t+2],n+=16777216*e[t+3],n>=2147483648&&(n-=4294967296),n},V=Number,$=5,U=65536>>$,W=111860.78125,q=[3421,3228,3047,2876,2715,2562,2419,2283,2155,2034,1920,1812,1711,1614,1524,1438,1358,1281,1210,1142,1078,1017,960,906,855,807,762,719,679,641,605,571,539,509,480,453,428,404,381,360,339,320,302,285,269,254,240,227,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,71,67,64,60,57,53,50,48,45,42,40,38,36,34,32,30,28,27,25,24,22,21,20,19,18,17,16,15,14],G=1,Z=2,z=null,H=!1,J=!0,K="psPlay",Q="psStop",Y="psWait",X=[],et=[],tt=e.define(n={$this:"t",$fields:{Pos:V,PrevPos:V,RPos:V,SccCount:Array,Steps:Array,SccWave:Array,WaveDat:Array,wdata2:Array,BeginPlay:Boolean,SeqTime:V,SeqTime120:V,WavOutMode:Boolean,EShape:Array,EVol:Array,EBaseVol:Array,ESpeed:Array,ECount:Array,Oct:Array,MCount:Array,MPoint:Array,MPointC:Array,Resting:Array,PlayState:Array,Slur:Array,Sync:Array,Detune:Array,PorStart:Array,PorEnd:Array,PorLen:Array,LfoV:Array,LfoA:Array,LfoC:Array,LfoD:Array,LfoDC:Array,LfoSync:Array,Fading:V,CurWav:Array,L2WL:Array,PCMW:Array,Delay:V,Tempo:V,ComStr:String,WFilename:String,EnvDat:Array,WriteMaxLen:V,soundMode:Array},load:function(e,t){function n(e){if(0==e.length)throw new Error("Out of data");return e.shift()}function r(e){if(e.length<4)throw new Error("Out of data");var t=e.shift(),n=1;return n<<=8,t+=e.shift()*n,n<<=8,t+=e.shift()*n,n<<=8,t+=e.shift()*n}var i=(r(t),n(t));e.MPoint=chdatas=[];for(var o=0;i>o;o++){var a=[];chdatas.push(a);for(var s=r(t),u=0;s>u;u++)a.push(n(t))}},loadWDT:function(e,t){if(!t)return requirejs(["Tones.wdt"],function(t){e.loadWDT(t)});var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){var t=n.response;if(t){var r=new Uint8Array(t);console.log("Loading wdt",r.length);for(var i=0,o=0;96>o;o++)for(var a=0;32>a;a++)e.WaveDat[o][a]=r[i++];for(var o=0;16>o;o++)for(var a=0;32>a;a++)e.EnvDat[o][a]=r[i++];console.log("Loading wdt done")}},n.send(null)},getPlayPos:function(){var e=this.context.currentTime-this.playStartTime,t=Math.floor(e*this.sampleRate);return t%s},setSound:function(e,t,n,r){switch(e.soundMode[t]=J,n){case G:e.Steps[t]=r;break;case Z:e.EVol[t]=r}},InitSin:function(){var e;for(e=0;U>e;e++)et[e]=Math.trunc(127*Math.sin(6.2831852*e/U))},InitEnv:function(e){var t,n;for(e.EnvDat=[],t=0;L>t;t++)for(e.EnvDat[t]=[],n=0;o>n;n++)e.EnvDat[t][n]=Math.floor((o-1-n)/2)},ConvM2T:function(e){var t;for(X=[],t=0;96>t;t++)X[t]=Math.trunc(65536*W/q[t]*65536/e.sampleRate)},InitWave:function(e){var t,n;for(e.WaveDat=[],t=0;a>t;t++)for(e.WaveDat[t]=[],n=0;i/2>n;n++)e.WaveDat[t][n]=103,e.WaveDat[t][n+_(i,2)]=153},$:function(e,t,n){var i;for(n=n||{},e.useScriptProcessor=n.useScriptProcessor,e.useFast=n.useFast,e.resolution=n.resolution||120,e.context=t,e.sampleRate=e.context.sampleRate,e.Delay=2e3,e.Pos=e.PrevPos=e.RPos=e.SeqTime=e.SeqTime120=0,e.BeginPlay=!1,e.InitWave(),e.InitEnv(),e.InitSin(),e.ConvM2T(),e.wdata2=[],e.PCMW=[],e.L2WL=[],e.Sync=[],e.ECount=[],e.MCount=[],i=0;N>i;i++)e.PCMW[i]=z;for(e.Steps=[],e.SccWave=[],e.SccCount=[],e.EShape=[],e.EVol=[],e.EBaseVol=[],e.MPoint=[],e.MPointC=[],e.ESpeed=[],e.PlayState=[],e.Detune=[],e.LfoV=[],e.LfoD=[],e.LfoDC=[],e.PorStart=[],e.PorEnd=[],e.PorLen=[],e.soundMode=[],e.CurWav=[],e.Oct=[],e.Resting=[],e.Slur=[],e.Sync=[],e.LfoV=[],e.LfoA=[],e.LfoC=[],e.LfoD=[],e.LfoDC=[],e.LfoSync=[],i=0;r>i;i++)e.LfoV[i]=0,e.LfoA[i]=0,e.LfoC[i]=0,e.LfoD[i]=0,e.LfoDC[i]=0,e.LfoSync[i]=0,e.Slur[i]=e.Sync[i]=0,e.PorStart[i]=e.PorEnd[i]=e.PorLen[i]=0,e.ECount[i]=0,e.MCount[i]=0,e.Resting[i]=0,e.Steps[i]=0,e.SccWave[i]=e.WaveDat[0],e.SccCount[i]=0,e.EShape[i]=e.EnvDat[0],e.EVol[i]=0,e.EBaseVol[i]=128,e.MPoint[i]=z,e.MPointC[i]=0,e.ESpeed[i]=5,e.PlayState[i]=Q,e.Detune[i]=0,e.LfoV[i]=0,e.SelWav(i,0),e.LfoD[i]=0,e.LfoDC[i]=0,e.Oct[i]=4,e.soundMode[i]=H;e.Fading=B,e.timeLag=2e3,e.WriteMaxLen=2e4,e.WavOutMode=H,e.label2Time=[],e.PC2Time=[],e.WFilename="",e.Tempo=120,e.ComStr="",e.performance={writtenSamples:0,elapsedTime:0},e.loadWDT()},getBuffer:function(){var e=1;return this.buf?this.buf:(this.buf=this.context.createBuffer(e,s,this.sampleRate),this.buf)},playNode:function(){if(!this.isSrcPlaying){var e=this.context.createBufferSource();e.buffer=this.getBuffer(),"function"==typeof e.noteOn&&e.noteOn(0),e.connect(this.context.destination),e.start(),e.loop=!0,e.playStartTime=this.playStartTime=this.context.currentTime,this.bufSrc=e,this.isSrcPlaying=!0}},startRefreshLoop:function(e){function t(){if(e.isSrcPlaying)for(var t=0,o=Math.floor(e.getPlayPos()/n);;){if(t++>s/n)throw new Error("Mugen "+o);var a=Math.floor(i/n);if(o===a)break;e.refreshPSG(r,i,n),i=(i+n)%s}}if(null==e.refreshTimer){for(var n=e.resolution,r=e.getBuffer().getChannelData(0),i=0,o=0;s>o;o+=n)e.refreshPSG(r,o,n);e.refreshTimer=setInterval(t,16)}},stopRefreshLoop:function(e){null!=e.refreshTimer&&(clearInterval(e.refreshTimer),delete e.refreshTimer)},stopNode:function(){this.isSrcPlaying&&(this.bufSrc.stop(),this.isSrcPlaying=!1)},Play1Sound:function(e,t,n,i){if(!e.soundMode[t])return n==u?void(e.Resting[t]=J):void(0>t||t>=r||0>n||n>95||(e.Resting[t]=H,i||(e.ECount[t]=0,e.Sync[t]&&(e.SccCount[t]=0),e.LfoSync[t]!=R&&(e.LfoC[t]=0)),e.CurWav[t]<a?e.Steps[t]=X[n]+e.Detune[t]*_(X[n],2048):e.L2WL[t]>=2&&(e.Steps[t]=_(1073741824>>>e.L2WL[t]-2,_(X[36],65536))*_(X[n],65536)),e.PorLen[t]=-1))},Play1Por:function(e,t,n,i,o){0>t||t>=r||0>i||i>95||0>n||n>95||(e.Resting[t]=H,e.PorStart[t]=X[n]+e.Detune[t]*_(X[n],2048),e.PorEnd[t]=X[i]+e.Detune[t]*_(X[i],2048),o||(e.ECount[t]=0))},StopMML:function(e,t){0>t||t>=r||(e.WaitMML(t),e.PlayState[t]=Q,e.MCount[t]=e.SeqTime+1)},allWaiting:function(e){for(var t=0;r>t;t++)if(e.PlayState[t]==K)return!1;return!0},handleAllState:function(e){for(var t=!0,n=!0,i=0;r>i;i++)switch(e.PlayState[i]){case K:t=!1;case Y:n=!1}if(t&&!n)for(var i=0;r>i;i++)e.RestartMML(i);return n},allStopped:function(e){for(var t=0;r>t;t++)if(e.PlayState[t]!=Q)return!1;return!0},RestartMML:function(e,t){0>t||t>=r||e.PlayState[t]==Y&&(e.PlayState[t]=K,e.MCount[t]=e.SeqTime+1)},restartIfAllWaiting:function(e){if(e.allWaiting())for(var t=0;r>t;t++)e.RestartMML(t)},WaitMML:function(e,t){0>t||t>=r||(e.PlayState[t]=Y,e.MCount[t]=e.SeqTime+1)},Start:function(e){e.Stop(),e.Rewind(),e.BeginPlay=J,e.startRefreshLoop(),e.playNode()},Rewind:function(e){var t;for(e.SeqTime=0,t=0;r>t;t++)e.soundMode[t]=H,e.MPointC[t]=0,e.PlayState[t]=K,e.MCount[t]=e.SeqTime},Stop:function(e){e.BeginPlay&&(e.stopNode(),e.stopRefreshLoop())},wavOut:function(e){e.Stop(),e.Rewind();for(var t=[],n=e.resolution,r=0;n>r;r++)t.push(0);var i=[];e.writtenSamples=0,e.WavOutMode=!0,e.label2Time=[],e.loopStart=null,e.PC2Time=[];var o=-1,a=e.wavOutSpeed||10;return new Promise(function(t){function r(){for(var s=(new Date).getTime()+a;(new Date).getTime()<=s;){for(var u=0;n>u;u++)i.push(0);e.refreshPSG(i,i.length-n,n),e.writtenSamples+=n;var c=Math.floor(e.writtenSamples/e.sampleRate);if(c>o&&(o=c),e.allStopped())return e.WavOutMode=!1,void t(i)}setTimeout(r,0)}setTimeout(r,0)})},toAudioBuffer:function(e){return e.wavOut().then(function(t){for(var n=e.context.createBuffer(1,t.length,e.sampleRate),r=n.getChannelData(0),i=0;i<r.length;i++)r[i]=t[i];var o={decodedData:n};return e.loopStart&&(o.loopStart=e.loopStart[0]/e.loopStart[1]),o})},SelWav:function(e,t,n){e.CurWav[t]=n,a>n?(e.SccWave[t]=e.WaveDat[n],e.L2WL[t]=5,e.Sync[t]=H):e.PCMW[n-a]!=z&&(e.SccWave[t]=e.PCMW[n-a].Start,e.L2WL[t]=e.PCMW[n-a].Log2Len,e.Sync[t]=J)},RegPCM:function(e,t,n){console.log("[STUB]regpcm",t.map(function(e){return String.fromCharCode(e)}),n)},refreshPSG:function(e,n,i,o){var a,s,R,L,N,V,U,W,q,G=0,Z=0,Q=0,Y=0;q=0,N=J,t++;var X=(e.sampleRate/22050,44100/e.sampleRate),tt=(new Date).getTime();if(e.allStopped())for(var a=i;i+o>=a;a++)n[a]=0;else{var nt=[],rt=e.SeqTime;for(s=0;r>s;s++)if(e.MPoint[s][e.MPointC[s]]==z&&e.StopMML(s),e.PlayState[s]==K)for(e.PorLen[s]>0&&(Y=e.MCount[s]-rt,e.Steps[s]=_(e.PorStart[s],e.PorLen[s])*Y+_(e.PorEnd[s],e.PorLen[s]*(e.PorLen[s]-Y))),Z=e.soundMode[s]?e.EVol[s]:e.Resting[s]?0:e.EShape[s][e.ECount[s]>>>11]*e.EVol[s]*e.EBaseVol[s],e.Fading<B&&(Z*=_(e.Fading,B)),nt[s]=Z,e.ECount[s]+e.ESpeed[s]*(o/2)<65536&&(e.ECount[s]+=e.ESpeed[s]*(o/2)),W=0;e.MCount[s]<=rt;){var it=e.MPointC[s];0==s&&(e.PC2Time[it]=e.writtenSamples),V=e.MPoint[s][it+1],U=e.MPoint[s][it+2];var ot=e.MPoint[s][it];if(ot>=0&&96>ot||ot===u)e.Play1Sound(s,ot,e.Slur[s]),e.Slur[s]||(e.LfoDC[s]=e.LfoD[s]),e.Slur[s]=H,e.MCount[s]+=2*(V+256*U),e.MPointC[s]+=3;else switch(ot){case m:e.Play1Por(s,V,U,e.Slur[s]),e.Slur[s]=H,e.MCount[s]+=2*(e.MPoint[s][it+3]+256*e.MPoint[s][it+4]),e.PorLen[s]=e.MCount[s]-rt,e.MPointC[s]+=5;break;case p:e.Tempo=V+256*U,e.MPointC[s]+=3;break;case c:e.EVol[s]=V,e.MPointC[s]+=2;break;case k:e.EBaseVol[s]=V,e.MPointC[s]+=2;break;case l:e.ESpeed[s]=V,e.MPointC[s]+=2;break;case f:e.SelWav(s,V),e.MPointC[s]+=2;break;case S:for(e.MPointC[s]+=34,a=0;32>a;a++)e.WaveDat[V][a]=e.MPoint[s][it+2+a];break;case g:e.EShape[s]=e.EnvDat[V],e.MPointC[s]+=2;break;case x:for(e.MPointC[s]+=34,a=0;32>a;a++)R=e.MPoint[s][it+2+a],R>15&&(R=15),e.EnvDat[V][a]=R;break;case h:if(e.WavOutMode){if(0==s){var at=e.MPointC[s]+j(e.MPoint[s],it+1),st=e.PC2Time[at];"number"==typeof st&&st<e.writtenSamples&&(e.loopStart=[st,e.sampleRate],console.log("@jump","ofs=",e.loopStart))}e.MPointC[s]+=5}else e.MPointC[s]+=j(e.MPoint[s],it+1);W++,W>1&&(console.log("Jumpsafe!"),e.StopMML(s),e.MCount[s]=rt+1);break;case C:e.WavOutMode&&0==s&&(e.label2Time[V]=[e.writtenSamples,e.sampleRate],console.log("@label",V,e.MPointC[s],e.writtenSamples+"/"+e.sampleRate)),e.MPointC[s]+=2;break;case d:e.Slur[s]=J,e.MPointC[s]+=1;break;case v:e.WaitMML(s),e.MPointC[s]+=1;break;case y:e.ComStr=F(e.MPoint[s],it+1),e.MPointC[s]+=e.ComStr.length+2;break;case T:e.WFilename=F(e.MPoint[s],it+1),e.MPointC[s]+=e.WFilename.length+2;break;case w:e.MPointC[s]+=1;break;case b:e.Detune[s]=I(V),e.MPointC[s]+=2;break;case A:e.LfoSync[s]=V,e.LfoV[s]=65536*U,e.LfoA[s]=e.MPoint[s][it+3],e.LfoD[s]=0,e.MPointC[s]+=4;break;case M:e.LfoD[s]=V*e.sampleRate,e.MPointC[s]+=2;break;case E:e.Sync[s]=1==V,e.MPointC[s]+=2;break;case P:var ut=F(e.MPoint[s],it+1);e.RegPCM(ut,e.MPoint[s][it+1+ut.length+1]),e.MPointC[s]+=ut.length+3;break;case D:e.StopMML(s);break;default:throw new Error("Invalid opcode"+ot)}}e.handleAllState(),e.SeqTime+=Math.floor(e.Tempo*(o/120)*X);for(var ct=i;i+o>ct;ct++)n[ct]=0;for(s=0;r>s;s++)if(e.PlayState[s]==K)for(var ct=i;i+o>ct;ct++)N=!N,G=n[ct],Z=nt[s],Z>0&&(a=O(e.SccCount[s]>>>32-e.L2WL[s]),L=O(e.SccWave[s][a]),O(Z),G+=L*Z/67108864-Z/524288,e.Sync[s]?(e.SccCount[s]<2*-e.Steps[s]||e.SccCount[s]>=0)&&(e.SccCount[s]+=e.Steps[s]):e.SccCount[s]+=e.Steps[s],0!=e.LfoV[s]&&(e.LfoDC[s]>0?e.LfoDC[s]-=e.Tempo:(e.SccCount[s]+=et[e.LfoC[s]>>>16+$]*_(e.Steps[s],512)*_(e.LfoA[s],256),N&&(e.LfoC[s]+=e.LfoV[s])))),G>1&&(G=1),-1>G&&(G=-1),n[ct]=G,0==s&&(e.WaveDat[95][31&Q]=Math.floor(78*Math.random()+90)),Q++;e.performance.elapsedTime+=(new Date).getTime()-tt,e.performance.writtenSamples+=o,e.performance.writeRate=e.performance.writtenSamples/(e.performance.elapsedTime/1e3*e.sampleRate)}}}),nt={};for(var rt in n){var it=/\bt\s*\.\s*([a-zA-Z0-9]+)\b/g;if("function"==typeof n[rt]){{var ot=n[rt]+"";ot.replace(it,function(e,t){n.$fields[t]||null==nt[t]&&(nt[t]=1)})}nt[rt]=0}}return console.log(nt),tt}),requireSimulator.setName("Tones.wdt"),define([],function(){return"data:application/octet-stream;base64,UFBQUFBQUFBQUFBQUFBQULm5ubm5ubm5ubm5ubm5ublnZ2dnZ6einUdETExBTHyao6OZnpNASWqZmJqZMENshm1LOjA6UFZOMys4RVBfZ3iHmKCvwMfUzLGpr8XPxbSSoGdnVUpBQD9BSUpKTlJjfK7BxL+xoHxiVkpPaIGToK1oYVZORkA5NDQ0NjpBSVZgbHuKlaOrrq6tq6Sfk4d8dopORUtVYGJobGdQRTw7RmF4jLO6uK+cmZmZmZqalY6MTkxOS0tLS0tLS0tLS0tLTH2uxc7SzruegVFQUE9PT05GSUdHRkZGRkZGz8/MzMzOz87Oz3dERUVFRUXOztDQSSdPa2xsa2tra2ttbW1ta4yx29rb3MGkim5WQSUlJScnR0lJSUlJSkpKSUlJSUlJSUlKvLy8u7y8u75GRkdHR0fs7OwPSqmfUEtJRTg4ODY2LysrKSkoKh4eHh4eHh4eH05OT09PT09PT09PT09PUFBQUFBQUFBQUFBPT0+4tra2Z2dbOTg7R2eIpK2kmIlsVUxHSlhwhJ+xq6OZmZmZjYiVioFsUS0iICo2TmCClaCzsaVrTEpccZGuurazsK+pop9cY1eRfGtfVUc/dZKecWhtomFjX3aBgXFgVUlAUYeY1ipFVWNseIKMkpmiqK2wubu+wMTFxcbGy8vQ0tHR0tR3iGBXbElAqKuOUk9Yk5OvuLm5ubSgcFZLTGpukpRma2dnZ2dnfpeZl4dwalBOZ2egtbOZeGVmcYKdrbWwrZmZZ2dnZ0c5MzMxMTEzNTk8Z5mZmZmZmcnJx8fGxsXDv7NKQUBUZW1tZV1dY3eUoKqrq5+cnai6xMXAtaWdk4p3YDA8TFZhZ3J8hI6fqrW/z9fs1rypnY2AcWFSRz80LSkgPEFGTlBWV1xdYmhscHN3eHyChoqRlZmeoKKlrbC1usHGv7WupaOak4+IiIR+eXhzbmtnYF1bxsZUUU5JQzs4NmBgYGBhwMC/v7/Dw8PExMPDw2NiZWVlZWVlZWVlYWFlV1dWVlRRVFJSUlTFxcXExMPDw8PDxFBQVFRUVldTVFfHx8fGxcS/v7u5tLCtp6Cal5KOhIB7cm5oYFdOPjgqxauxqZoXipOUZ2eTQ0GIlW2up6+VztDWSXKrpVCoTIOkyz5AQUFBQ0NBP0BGS1FdaHF3goePmaCps7u/xMXFxccjIChdZWBcRx8cGh0rRF11jaW80uBzs6ez29zOqY1qPmxmVjNBPmegtLy1u7iajYyUo6uqpJ+XkY2NjYyKiISZZ2dohIRYW4SEVleUq7q6sI1EREtlkZFbXJOrvr68sZeZmJhnZ2dnZ7a4QUNDP8vR0c/Oy8tFR0eZmZmZmZmZmShmg6q4qYqTpbq7uLWzq6igoJ6Xko2BdmNROC01SkMqAOH3/v/73wDh+v//+eoA6Pj+//nqAOj4///46gDk9vxnZ2dnqKqtgHl1gJSdnZV3cHOCjZyjoJyYl5SUmZmZmUNBRUdLVFhicHt+fn5+fn5+fn5+fn2BiJSns7/ExsbFcHBwcHBtbW1sbGxsbW1sbG1ubXzBw3M1HyApamxtbWzPz8/Oz8nBs5R7Zl1FOTw4RFJgc4mgvsXLy1dSUltix3FwcHBwc3V1dXV1dXNxcXFy1tYgIiJ2dnZ2dnZ1cXFxXDooNVowKDBcMCk1Q1BdeI2kvt3q4Ljd5tyx3+jcqH1mX19mZ2eZmYQ8PkZHSldddYKPlJmZmZmZmZmZmZmTjGdnZ3l4eHl5bFVMSklUgKSxsbawmqqzy76Yk7O+tLCtUTowLVKPsMHS1dHOzMfDtauZgWBFPDEzMTE+XICTjoFnZ2dnW09LXU5FVmNzhJOerrqnj4S/uJmZmZmZmZmZmb5RUElMTrXQ3N3cyYZwbHWOo8HV3dvBnZWOj5mgq7G4fX18gMG/e3h4eXl5fHx8gcG8gjAvLi4uLi4xMTAwL31HxMXGxsbFxcXFxURBPz8/QMPDxMTDw0ZDQ0FGRkdHR5q50OPcv62YhHV2j6u1qo5xVUpUcImKe2dSQCMcL0ZleGtcPDEuJygzYGNjZWZmZ567w8XAqaCOj4+SlJWUlIxlZWVHNjAkJTFQX2BgYGBfYp2qsbGwqJmRjoN8dXJubGdnZ2dUTEtQVFhfZWhxfI2vwMbJyb6qZ1pSRUaZmZmZgIePoLvQ29GwdrDQ3NS+nmFBKyMvT5JPLiQvRF9weH+uvsTEuqBYo7nAwL6vd2FQR0dHandqSklJSUlJSldshv8SfP8NaP7/DAz/B/0DA8T/yw/r++4PbfcSEvX4FBpaUWfJe7Cfqatnq2erqZ9KO5N952qZW4d2c3WGxlCZmdJnZ2dnZ2dnZ2dnZ2dnZ2dnmZmZmZmZmZmZmZmZmZmZmWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZmenJR5d4KSlYRmVlBRUVJnr8fHwbSrpaKelHllZWVugWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlnZ2dnbmBfYmuOvsC5qJKHhIB+fXx8fXFnVVaan5mZmWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlnZ2dnZ2dnZ2dnZ2dnZ2dnmZmZmZmZmZmZmZmZmZmZmWdnZ2dhWoGRhltYZXyap6mfc3FmYXycqa6kj4J9fYGMZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlzdTw6Oz8/Pz9FR0pPV2Fqc36JjZqgqrC2vL+/vnd3c5pROjQxKycrKysuMDAxNj44ODtKk7zL0NS/jK/A0Mm4Z2dnZ2dnZ2dnZ2dnZ2dnZ5KtwdDMwamNZmdnZ2dnZ2eKg2dfaGt5eYS4mnBmY2VnZ2dna4+rq6t+bnZ2oKOnmLCwZ0k8Ozs7PEBLUltsj6q0ury6mX1RSpi5uFBKh6u5S05Ma2trampqTE5OTk5OecnJysvLra+urq60yc7OzspwcHJy1NbX2NjY1tR1cnV1c3Nzubm2tkNBQUNxcHJycaurq2dnZ2dmY2NqxsbExV9fX2HGycbGxkVEPkA8Ozs7Ii5L/+sAGi9FYXecvtXh7PX5/v7+/v7++/Dr3LAoDRMjIiUCIy8rPDRHUU9GHhMZIDUKCkQqGhoKCQwREy88PoSMnIynoLuoz7i8l6eCcnxXZjlOGE9BbmGCopfGp7iZQUNFTHagya6TcEVDQUFBW2iBmai5xc/Gua2VfWtWTkc7Ozs8tLS0trS0Ojo4ODk5uLi4tra2tbW2tra4tbW1tT5WaHFzbF1QODlLbp21w8/Rz8/Pz9DR0dHR0c65h1Y+coOgu8TDuZ13YEA0MDM/VG2Hmaq1wMXGxsO1p5SAc206c3NzlaeooIhYQzpAZnZ1dsPBwMDBwcHBwHV3dnM7O09wlMXav5d2XUs1IjtGXHWPorDF2MOtmYFxW0s6LygkZ2doMzMzMTNlZWhnlZWVlZWV0NDS0NDQ0NDPmJmZmWeYXC8tLS0tLispKTxlfJGcnaq1uriulJK4trWYlbq4qGdnZ2dnZ2dnZ2dnZ2dnZ2eZqL7Hyb+xnJSEfTEpQJyaZ2dnZ2evsLS5Tjw8RU5PZ5mZmZmZmWhdXF+ZmZmZmZlnZ2eAl56VaFJFQ0VKZ2dnmZmZmZmZmZmZmZmZmZmZmWJnZ2dnZ2dnZ2dnZ2dnZ2eZtb6+saOVh3x5cVQ/QUxfNEFOXWVrc36Hj5yjpaijeJejtsDFys/V1tfX1tXV1SuaUTpYVlZ5WlxdXDAwMWA+ODg7SpO5xtDOz6TQ0Mq8rspnUVFMS1ZztsbHvq+djU9PUGF2iZior7i+wMHDxsnKP1BmZWA4NCozO1eInrPBxYaGg7+/moJRQDAkIyMkKTNbWldXV2d2dmc4ODg5OnmvxcTExMSxV1hYWFiImZmZilqCipRyj5uHomxkmX19hY2giWeHZmSMg5RnmIGZpYFmDw4LCgoJCAcHBgYFBQQEAwMDAgICAgICAgICAgICAgAPDgsKCQkJCAgIBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwEODg4ODg4ODg0MDAwMDAwMDAwLCwsLCwsLCwoKCgoKAgUICgsNDg8PDw8PDw8ODg0NDAwLCwsKCgoJCQgICAcPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQ8PDw8ODg4ODg4ODg4ODg4ODg0NDAwLCgoJCAgGBQQCAQAAAAUHCQoLCwwMDA0NDQ0ODg4ODg0NDQ0NDAwMDAwMDAwBAQECAgIDAwMDBAQFBAQFBQYHBwgJCQoLCwwNDg4ODg8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgYGBgUFBQUFBAQDAwICAgIBAQEBAAAPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQEAAA8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgYGBgUFBQUFBAQDAwICAgIBAQEBAAAPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQEAAA8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgcGBgYGBQUFBQYHCAgHCAgBAQEBAAA="}),requireSimulator.setName("runtime"),requirejs(["ImageList","PicoAudio","T2MediaLib","Tonyu","UIDiag","SEnv","Tones.wdt"],function(e,t,n,r,i,o){console.log("runtimes loaded",arguments),window.PicoAudio||(window.PicoAudio=t),window.T2MediaLib||(window.T2MediaLib=n),window.Mezonet||(window.Mezonet=o)}),requireSimulator.setName("difflib"),__whitespace={" ":!0,"	":!0,"\n":!0,"\f":!0,"\r":!0},difflib={defaultJunkFunction:function(e){return __whitespace.hasOwnProperty(e)},stripLinebreaks:function(e){return e.replace(/^[\n\r]*|[\n\r]*$/g,"")},stringAsLines:function(e){for(var t=e.indexOf("\n"),n=e.indexOf("\r"),r=t>-1&&n>-1||0>n?"\n":"\r",i=e.split(r),o=0;o<i.length;o++)i[o]=difflib.stripLinebreaks(i[o]);return i},__reduce:function(e,t,n){if(null!=n)var r=n,i=0;else{if(!t)return null;var r=t[0],i=1}for(;i<t.length;i++)r=e(r,t[i]);return r},__ntuplecomp:function(e,t){for(var n=Math.max(e.length,t.length),r=0;n>r;r++){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return e.length==t.length?0:e.length<t.length?-1:1},__calculate_ratio:function(e,t){return t?2*e/t:1},__isindict:function(e){return function(t){return e.hasOwnProperty(t)}},__dictget:function(e,t,n){return e.hasOwnProperty(t)?e[t]:n},SequenceMatcher:function(e,t,n){this.set_seqs=function(e,t){this.set_seq1(e),this.set_seq2(t)},this.set_seq1=function(e){e!=this.a&&(this.a=e,this.matching_blocks=this.opcodes=null)},this.set_seq2=function(e){e!=this.b&&(this.b=e,this.matching_blocks=this.opcodes=this.fullbcount=null,this.__chain_b())},this.__chain_b=function(){for(var e=this.b,t=e.length,n=this.b2j={},r={},i=0;i<e.length;i++){var o=e[i];if(n.hasOwnProperty(o)){var a=n[o];t>=200&&100*a.length>t?(r[o]=1,delete n[o]):a.push(i)}else n[o]=[i]}for(var o in r)r.hasOwnProperty(o)&&delete n[o];var s=this.isjunk,u={};if(s){for(var o in r)r.hasOwnProperty(o)&&s(o)&&(u[o]=1,delete r[o]);for(var o in n)n.hasOwnProperty(o)&&s(o)&&(u[o]=1,delete n[o])}this.isbjunk=difflib.__isindict(u),this.isbpopular=difflib.__isindict(r)},this.find_longest_match=function(e,t,n,r){for(var i=this.a,o=this.b,a=this.b2j,s=this.isbjunk,u=e,c=n,l=0,f=null,p={},h=[],d=e;t>d;d++){var m={},g=difflib.__dictget(a,i[d],h);for(var v in g)if(g.hasOwnProperty(v)){if(f=g[v],n>f)continue;if(f>=r)break;m[f]=k=difflib.__dictget(p,f-1,0)+1,k>l&&(u=d-k+1,c=f-k+1,l=k)}p=m}for(;u>e&&c>n&&!s(o[c-1])&&i[u-1]==o[c-1];)u--,c--,l++;for(;t>u+l&&r>c+l&&!s(o[c+l])&&i[u+l]==o[c+l];)l++;for(;u>e&&c>n&&s(o[c-1])&&i[u-1]==o[c-1];)u--,c--,l++;for(;t>u+l&&r>c+l&&s(o[c+l])&&i[u+l]==o[c+l];)l++;return[u,c,l]},this.get_matching_blocks=function(){if(null!=this.matching_blocks)return this.matching_blocks;for(var e,t,n,r,i,o,a,s,u,c=this.a.length,l=this.b.length,f=[[0,c,0,l]],p=[];f.length;)i=f.pop(),e=i[0],t=i[1],n=i[2],r=i[3],u=this.find_longest_match(e,t,n,r),o=u[0],a=u[1],s=u[2],s&&(p.push(u),o>e&&a>n&&f.push([e,o,n,a]),t>o+s&&r>a+s&&f.push([o+s,t,a+s,r]));p.sort(difflib.__ntuplecomp);var h=j1=k1=block=0,d=[];for(var m in p)p.hasOwnProperty(m)&&(block=p[m],i2=block[0],j2=block[1],k2=block[2],h+k1==i2&&j1+k1==j2?k1+=k2:(k1&&d.push([h,j1,k1]),h=i2,j1=j2,k1=k2));return k1&&d.push([h,j1,k1]),d.push([c,l,0]),this.matching_blocks=d,this.matching_blocks},this.get_opcodes=function(){if(null!=this.opcodes)return this.opcodes;var e=0,t=0,n=[];this.opcodes=n;var r,i,o,a,s,u=this.get_matching_blocks();for(var c in u)u.hasOwnProperty(c)&&(r=u[c],i=r[0],o=r[1],a=r[2],s="",i>e&&o>t?s="replace":i>e?s="delete":o>t&&(s="insert"),s&&n.push([s,e,i,t,o]),e=i+a,t=o+a,a&&n.push(["equal",i,e,o,t]));return n},this.get_grouped_opcodes=function(e){e||(e=3);var t=this.get_opcodes();t||(t=[["equal",0,1,0,1]]);var n,r,i,o,a,s;"equal"==t[0][0]&&(n=t[0],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],t[0]=[r,Math.max(i,o-e),o,Math.max(a,s-e),s]),"equal"==t[t.length-1][0]&&(n=t[t.length-1],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],t[t.length-1]=[r,i,Math.min(o,i+e),a,Math.min(s,a+e)]);var u=e+e,c=[],l=[];for(var f in t)t.hasOwnProperty(f)&&(n=t[f],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],"equal"==r&&o-i>u&&(c.push([r,i,Math.min(o,i+e),a,Math.min(s,a+e)]),l.push(c),c=[],i=Math.max(i,o-e),a=Math.max(a,s-e)),c.push([r,i,o,a,s]));return!c||1==c.length&&"equal"==c[0][0]||l.push(c),l},this.ratio=function(){return matches=difflib.__reduce(function(e,t){return e+t[t.length-1]},this.get_matching_blocks(),0),difflib.__calculate_ratio(matches,this.a.length+this.b.length)},this.quick_ratio=function(){var e,t;if(null==this.fullbcount){this.fullbcount=e={};for(var n=0;n<this.b.length;n++)t=this.b[n],e[t]=difflib.__dictget(e,t,0)+1}e=this.fullbcount;for(var r={},i=difflib.__isindict(r),o=numb=0,n=0;n<this.a.length;n++)t=this.a[n],numb=i(t)?r[t]:difflib.__dictget(e,t,0),r[t]=numb-1,numb>0&&o++;return difflib.__calculate_ratio(o,this.a.length+this.b.length)},this.real_quick_ratio=function(){var e=this.a.length,t=this.b.length;return _calculate_ratio(Math.min(e,t),e+t)},this.isjunk=n?n:difflib.defaultJunkFunction,this.a=this.b=null,this.set_seqs(e,t)}},define("difflib",[],function(){return difflib}),requireSimulator.setName("diffview"),diffview={buildView:function(e){function t(e,t){var n=document.createElement(e);return n.className=t,n}function n(e,t){var n=document.createElement(e);return n.appendChild(document.createTextNode(t)),n}function r(e,t,n){var r=document.createElement(e);return r.className=t,r.appendChild(document.createTextNode(n)),r}function i(e,i,o,a,s){return o>i?(e.appendChild(n("th",(i+1).toString())),e.appendChild(r("td",s,a[i].replace(/\t/g,"    "))),i+1):(e.appendChild(document.createElement("th")),e.appendChild(t("td","empty")),i)}function o(e,t,i,o,a){e.appendChild(n("th",null==t?"":(t+1).toString())),e.appendChild(n("th",null==i?"":(i+1).toString())),e.appendChild(r("td",a,o[null!=t?t:i].replace(/\t/g,"    ")))}var a=e.baseTextLines,s=e.newTextLines,u=e.opcodes,c=e.baseTextName?e.baseTextName:"Base Text",l=e.newTextName?e.newTextName:"New Text",f=e.contextSize,p=0==e.viewType||1==e.viewType?e.viewType:0;if(null==a)throw"Cannot build diff view; baseTextLines is not defined.";if(null==s)throw"Cannot build diff view; newTextLines is not defined.";if(!u)throw"Canno build diff view; opcodes is not defined.";var h=document.createElement("thead"),d=document.createElement("tr");h.appendChild(d),p?(d.appendChild(document.createElement("th")),d.appendChild(document.createElement("th")),d.appendChild(r("th","texttitle",c+" vs. "+l))):(d.appendChild(document.createElement("th")),d.appendChild(r("th","texttitle",c)),d.appendChild(document.createElement("th")),d.appendChild(r("th","texttitle",l))),h=[h];for(var m,g=[],v=0;v<u.length;v++){code=u[v],change=code[0];for(var y=code[1],b=code[2],T=code[3],w=code[4],S=Math.max(b-y,w-T),x=[],A=[],E=0;S>E;E++){if(f&&u.length>1&&(v>0&&E==f||0==v&&0==E)&&"equal"==change){var P=S-(0==v?1:2)*f;if(P>1){if(x.push(d=document.createElement("tr")),y+=P,T+=P,E+=P-1,d.appendChild(n("th","...")),p||d.appendChild(r("td","skip","")),d.appendChild(n("th","...")),d.appendChild(r("td","skip","")),v+1==u.length)break;continue}}x.push(d=document.createElement("tr")),p?"insert"==change?o(d,null,T++,s,change):"replace"==change?(A.push(m=document.createElement("tr")),b>y&&o(d,y++,null,a,"delete"),w>T&&o(m,null,T++,s,"insert")):"delete"==change?o(d,y++,null,a,change):o(d,y++,T++,a,change):(y=i(d,y,b,a,change),T=i(d,T,w,s,change))}for(var E=0;E<x.length;E++)g.push(x[E]);for(var E=0;E<A.length;E++)g.push(A[E])}g.push(d=r("th","author","diff view generated by ")),d.setAttribute("colspan",p?3:4),d.appendChild(m=n("a","jsdifflib")),m.setAttribute("href","http://github.com/cemerick/jsdifflib"),h.push(d=document.createElement("tbody"));for(var v in g)g.hasOwnProperty(v)&&d.appendChild(g[v]);d=t("table","diff"+(p?" inlinediff":""));for(var v in h)h.hasOwnProperty(v)&&d.appendChild(h[v]);return d}},define("diffview",[],function(){return diffview}),requireSimulator.setName("DiffDialog"),define(["UI","difflib","diffview"],function(e,t,n){var r={};return r.show=function(e,t,n){var i=r.embed(e,t,n);i.dialog({width:600,height:500})},r.embed=function(i,o){function a(e){return e&&!e.isDir()&&e.exists()}if(!r.d){var s={fromVal:function(e){return""==e?null:FS.get(e)},toVal:function(e){return e?e.path():""}};r.d=e("div",{title:"比較"},["div",["input",{style:"background-color: #f88;",$edit:{name:"baseFile",type:s},size:60}],["br"],["input",{style:"background-color: #8f8;",$var:"newFile",$edit:{name:"newFile",type:s},size:60}]],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){r.done()}}},"比較"],["div",{$var:"diffoutput",css:{height:"350px",overflow:"scroll"}}])}var u=r.d,c={baseFile:i,newFile:o};return u.$edits.load(c),u.$edits.validator.on.validate=function(e){a(e.newFile)?a(e.baseFile)?this.allOK():this.addError("base",i+"は存在しないか，ディレクトリです"):this.addError("new",o+"は存在しないか，ディレクトリです")},r.done=function(){for(var e=t.stringAsLines(c.baseFile.text()),r=t.stringAsLines(c.newFile.text()),i=new t.SequenceMatcher(e,r),o=i.get_opcodes(),a=u.$vars.diffoutput[0];a.firstChild;)a.removeChild(a.firstChild);contextSize=null,a.appendChild(n.buildView({baseTextLines:e,newTextLines:r,opcodes:o,baseTextName:c.baseFile+"",newTextName:c.newFile+"",contextSize:contextSize,viewType:1}))},a(c.baseFile)&&a(c.newFile)&&r.done(),u},r}),requireSimulator.setName("KernelDiffDialog"),define(["UI","DiffDialog","Shell"],function(e,t){function n(e,n){return function(){t.show(e,n)}}var r={};return r.show=function(e,t,n){var i=r.embed(e,t,n);i.dialog({width:250,height:400})},r.embed=function(t,i){r.d||(r.d=e("div",{title:"Kernel比較"},["div",{$var:"out"}],["button",{$var:"OKButton",on:{click:function(){r.refresh()}}},"更新"]));var o=r.d;return r.refresh=function(){var r=o.$vars.out;r.empty(),i.each(function(o){var a=t.rel(o.relPath(i));o.endsWith(".tonyu")&&a.exists()&&r.append(o.text()==a.text()?e("div",o.name(),"(同一)"):e("div",["a",{href:"javascript:;",on:{click:n(a,o)}},o.name()]))})},r.refresh(),o},r}),requireSimulator.setName("requestFragment"),define(["WebSite"],function(e){var t={};return t.ajax=function(t){function n(e){return t.redirectTo&&(e.redirectTo=t.redirectTo),e}function r(){$.ajax({type:"post",url:e.serverTop+"/runFragments",data:n({id:s}),success:function(e){return"string"==typeof e&&e.match(/^notCompleted:([\-\d]+)\/([\-\d]+)$/)?(console.log("notcomp",e),l*=2,void setTimeout(r,l)):void t.success(e)},error:t.error,complete:t.complete})}var i=t.THRESH||8e5,o=t.data;if("object"!=typeof o)throw"Data should be object: "+o;if(o=JSON.stringify(o),!t.redirectTo&&("GAE"!=e.serverType||o.length<i))return $.ajax(t);for(var a=[],s=Math.random();o.length>0;)a.push(o.substring(0,i)),o=o.substring(i);var u=a.length,c=0,l=1e3;a.forEach(function(i,o){$.ajax({type:"post",url:e.serverTop+"/sendFragment",data:n({id:s,seq:o,len:u,content:i}),success:function(e){console.log("sendFrag",e,o),c++,c>=u&&setTimeout(r,l)},error:t.error})})},t}),requireSimulator.setName("Sync"),define(["FS","Shell","requestFragment","WebSite"],function(e,t,n,r){function i(e){return e&&e.isDir}var o={};return t.sync=function(){function e(e){return function(){e&&e.apply({},arguments),t.prompt()}}var n,r,a,s=function(){},u=0;return("string"==typeof arguments[u]||i(arguments[u]))&&(n=t.resolve(arguments[u],!0),u++,("string"==typeof arguments[u]||i(arguments[u]))&&(r=t.resolve(arguments[u],!1),u++)),"object"==typeof arguments[u]&&(a=arguments[u],u++),"function"==typeof arguments[u]&&(s=arguments[u],u++),n||(r=n=t.cwd),a&&a.onend&&(a.onend=e(a.onend)),r||(r=n),t.echo("sync args=",n,r,a,s),o.sync(n,r,a,e(s)),t.ASYNC},o.sync=function(){function e(e,n){t.echo("Status: "+e+" param:",n),h.onstatus&&h.onstatus(e,n)}function o(){h.onerror&&h.onerror.apply(this,arguments)}function a(){var t={base:p.path(),excludes:JSON.stringify(h.excludes)};e("getDirInfo",t),$.ajax({type:"get",url:r.serverTop+"/getDirInfo",data:t,success:s,error:o})}function s(n){h.v&&t.echo("getDirInfo",n);var i=f,a=n.data;for(var s in a){var c=i.rel(s),d=c.exists({includeTrashed:!0})&&c.metaInfo(),m=a[s];l(c,s,d,m)}f.recursive(function(e){var t=e.exists({includeTrashed:!0})&&e.metaInfo(),n=e.relPath(f),r=a[n];l(e,n,t,r)},{includeTrashed:!0,excludes:h.excludes}),h.v&&(t.echo("uploads:",g),t.echo("downloads:",v));var y={base:p.path(),paths:JSON.stringify(v)};e("File2LSSync",y),$.ajax({type:"post",url:r.serverTop+"/File2LSSync",data:y,success:u,error:o})}function u(i){t.echo("dlData=",i),h.v&&t.echo("dlData:",i);var a=f;if(!h.test){for(var s in i.data){var u=a.rel(s),l=i.data[s];l.trashed?u.exists()&&u.rm():u.text(l.text),delete l.text,u.metaInfo(l)}var d={base:p.path(),data:JSON.stringify(g)};d.pathInfo="/LS2FileSync",e("LS2FileSync",d),n.ajax({type:"post",url:r.serverTop+"/LS2FileSync",data:d,success:c,error:o})}}function c(e){h.v&&t.echo("LS2FileSync res=",e);
var n=[];for(var r in g)n.push(r);e={msg:e,uploads:n,downloads:v},"function"==typeof d&&d(e)}function l(e,n,r,i){if(!y[n])if(y[n]=1,i&&(!r||r.lastUpdate<i.lastUpdate))v.push(n),h.v&&t.echo((r?"":"New")+"Download "+e+" trash="+!!i.trashed);else if(r&&(!i||r.lastUpdate>i.lastUpdate)){var o=r.trashed?{}:{text:e.text()},a=e.metaInfo();for(var s in a)o[s]=a[s];g[n]=o,h.v&&t.echo((i?"":"New")+"Upload "+e+" trash="+!!r.trashed)}}var f,p,h,d,m=0;if(i(arguments[m])&&(f=arguments[m],m++,i(arguments[m])&&(p=arguments[m],m++)),"object"==typeof arguments[m]&&(h=arguments[m],m++),"function"==typeof arguments[m]&&(d=arguments[m],m++),!f)throw"Sync.sync: Local dir must be specified as file object";p||(p=f),h||(h={}),!d&&h.onend&&(d=h.onend),h.test&&(h.v=1),a();var g={},v=[],y={}},t.rsh=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return $.ajax({url:r.serverTop+"/rsh",data:{args:JSON.stringify(e)},success:function(e){t.echo(e)},error:function(e,n,r){t.err(r)},complete:function(){t.prompt()}}),t.ASYNC},o}),requireSimulator.setName("searchDialog"),define(["UI","Shell"],function(e,t){var n={};return n.show=function(e,t){var r=n.embed(e,t);r.dialog({width:600})},n.embed=function(r,i){n.d||(n.d=e("div",{title:"検索"},["div",["span","検索語"],["input",{$edit:"word",on:{enterkey:function(){n.d.start()}}}]],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){n.d.start()}}},"検索"],["div",{style:"overflow-y:scroll; height:200px"},["table",{$var:"searchRes"}]]));var o=n.d,a={word:""};return o.$edits.load(a),o.start=function(){o.$vars.searchRes.empty();var n=t.grep(a.word,r);n.forEach(function(t){function n(){i&&i(t)}t.file.name().match(/^concat\.js/)||o.$vars.searchRes.append(e("tr",["td",{on:{click:n}},t.file.name()+"("+t.lineNo+")"],["td",{on:{click:n}},t.line]))})},o},n}),requireSimulator.setName("syncWithKernel"),requirejs(["Shell","FS","WebSite"],function(e,t,n){e.syncWithKernel=function(r){var i=t.get(n.tonyuHome),o=i.rel("Kernel/");if(r){var a=e.resolve(r),s=o.rel(r);return a.lastUpdate()>s.lastUpdate()?(e.cp(a,s,{v:1}),1):a.lastUpdate()<s.lastUpdate()?(e.cp(s,a,{v:1}),1):0}var u=0;return o.each(function(t){var n=e.resolve(t.name());n.exists()&&(u+=e.syncWithKernel(t.name()))}),u}}),requireSimulator.setName("ImageDetailEditor"),define(["UI","ImageList","ImageRect","PatternParser","WebSite","Assets"],function(e,t,n,r,i,o){function a(t){return e("input",{type:"radio",name:"type",value:t,on:{click:function(){s(t)}}})}function s(e){switch(e){case"single":return R?(D=1,C=1,w(),S(),p(),!1):!1;case"rc":return T();case"wh":return S()}}function u(){R&&(R.url=F.url.val())}function c(){F.theForm[0].type.value="rc"}function l(){F.theForm[0].type.value="wh"}function f(){F.theForm[0].type.value="single"}function p(){var e=F.cv[0].getContext("2d"),t=B;t&&L&&(e.clearRect(t.left,t.top,t.width,t.height),e.drawImage(L,0,0,M,k,t.left,t.top,t.width,t.height),h())}function h(){var e=t.parse1(R,L,{boundsInSrc:!0}),n=F.cv[0].getContext("2d");e.forEach(function(e){y(n,m(e))}),_=e}function d(e,t){return t.left<=e.x&&e.x<=t.left+t.width&&t.top<=e.y&&e.y<=t.top+t.height}function m(e){var t={},n=B.width/M,r=B.height/k;return t.left=B.left+e.x*n,t.top=B.top+e.y*r,t.width=e.width*n,t.height=e.height*r,t}function g(e){var t=F.cv[0].getContext("2d"),n=F.cv.offset(),r={x:e.pageX-n.left,y:e.pageY-n.top};return _?void _.forEach(function(e,n){var i=m(e);if(d(r,i)){var o=_[V];if(o){var a=m(o);y(t,a)}V=n,y(t,i,"#ff0")}}):void console.log("cvMouse")}function v(){var e=_[V];if(e){var t=O+"+"+V;F.patName.val(t),P(t)}}function y(e,t,n){e.strokeStyle=n||"#f0f",e.beginPath(),e.moveTo(t.left,t.top),e.lineTo(t.left+t.width,t.top),e.lineTo(t.left+t.width,t.top+t.height),e.lineTo(t.left,t.top+t.height),e.closePath(),e.stroke()}function b(e,t){return e===e?e:t}function T(){return"rc"!=F.theForm[0].type.value?!1:R?(D=b(parseInt(F.cols.val()),D),C=b(parseInt(F.rows.val()),C),w(),p(),!1):!1}function w(){return R?(R.type="wh",R.pwidth=b(Math.floor(M/D),M),R.pheight=b(Math.floor(k/C),k),console.log("calcWH",R),F.pwidth.val(R.pwidth),void F.pheight.val(R.pheight)):!1}function S(){return"wh"!=F.theForm[0].type.value?!1:R?(R.type="wh",R.pwidth=b(parseInt(F.pwidth.val()),R.pwidth),R.pheight=b(parseInt(F.pheight.val()),R.pheight),x(),p(),!1):!1}function x(){return R?(D=b(Math.floor(M/R.pwidth),D),C=b(Math.floor(k/R.pheight),C),F.rows.val(C),void F.cols.val(D)):!1}function A(){if(!R)return!1;delete R.pwidth,delete R.pheight,R.type="t1",F.theForm[0].type.value="t1";try{p()}catch(e){alert(e)}return!1}function E(){return I.dialog("close"),N&&N(),!1}function P(e){if(i.isNW){var t=require("nw.gui"),n=t.Clipboard.get();n.set(e,"text")}}var M,k,C,D,R,L,N,B,_,O,I=e("div",{title:"画像詳細"},["div",["div","URL:",["input",{$var:"url",size:40,on:{change:u}}],["a",{$var:"openImg",target:"img"},"画像を確認..."]],["canvas",{$edit:"cv",width:500,height:250,on:{mousemove:g,mousedown:v}}]],["form",{$var:"theForm"},["div",a("single"),"１枚絵"],["div",a("rc"),"分割数指定：",["input",{$var:"cols",size:5,on:{realtimechange:T,focus:c}}],"x",["input",{$var:"rows",size:5,on:{realtimechange:T,focus:c}}]],["div",a("wh"),"1パターンの大きさ指定：",["input",{$var:"pwidth",size:5,on:{realtimechange:S,focus:l}}],"x",["input",{$var:"pheight",size:5,on:{realtimechange:S,focus:l}}]],["div",a("t1"),"Tonyu1互換",["button",{on:{click:A}},"解析"]],["div","パターン番号:",["input",{$var:"patName"}]],["button",{on:{click:E}},"OK"]]),F=I.$vars,j={},V=-1;return j.show=function(e,t,r,i){i||(i={}),N=i.onclose,R=e,O=r,I.dialog({width:600,height:520}),F.url.val(R.url);var a=o.resolve(R.url,t);F.openImg.attr("href",a),n(a,F.cv[0])(function(e){B=e,console.log(e),L=e.src,M=L.width,k=L.height,"single"==R.type?f():R.pwidth&&R.pheight?(F.pwidth.val(R.pwidth),F.pheight.val(R.pheight),x(),l()):F.theForm[0].type.value="t1",h()})},j}),requireSimulator.setName("OggConverter"),define(["FS","WebSite"],function(e,t){var n,r={};return t.isNW&&(n=require("child_process").spawn),r.convert=function(r){if(t.isNW){var i=e.get(t.ffmpeg);i.exists()&&(console.log("Convert ogg->mp3 ",r.path()),r.each(function(e){if(e.endsWith(".mp3")||e.endsWith(".mp4")||e.endsWith(".m4a")){var t;e.endsWith(".mp3")&&(t=".mp3"),e.endsWith(".mp4")&&(t=".mp4"),e.endsWith(".m4a")&&(t=".m4a");var r=e.up().rel(e.truncExt(t)+".ogg");if(!r.exists()){console.log("running",i.path(),"-i",e.path(),r.path());var o=n(i.path(),["-i",e.path(),r.path()]);o.stdin.end()}}}))}},r}),requireSimulator.setName("ResEditor"),define(["FS","Tonyu","UI","ImageList","Blob","Auth","WebSite","ImageDetailEditor","Util","OggConverter","Assets"],function(e,t,n,r,i,o,a,s,u,c,l){function f(e,t){if("string"==typeof e){var n=new Image;return n.onload=function(){f(n,t)},n.src=e,n}var r=t.width,i=t.height,o=t.getContext("2d"),a=e.width,s=e.height,u=i/s*a,c=r/a*s;c>i&&(c=i),u>r&&(u=r),o.clearRect(0,0,r,i);var l=Math.floor((r-u)/2),p=Math.floor((i-c)/2);o.drawImage(e,0,0,a,s,l,p,u,c)}var p=function(t,r){function p(e){function n(e){return a.urlAliases[e]||e}try{return u.endsWith(e,".ogg")?e=n("images/sound_ogg.png"):u.endsWith(e,".mp3")?e=n("images/sound_mp3.png"):u.endsWith(e,".mzo")?e=n("images/sound_mzo.png"):u.endsWith(e,".mp4")?e=n("images/sound_mp4.png"):u.endsWith(e,".m4a")?e=n("images/sound_m4a.png"):u.endsWith(e,".mid")||u.endsWith(e,".midi")?e=n("images/sound_mid.png"):u.endsWith(e,".wav")&&(e=n("images/sound_wav.png")),l.resolve(e,t)}catch(r){return a.urlAliases["images/ecl.png"]}}function h(u,c){function m(e){e.stopPropagation(),e.preventDefault();for(var r=e.originalEvent,s=r.dataTransfer.files,u=new Array(s.length),c=s.length,l=[],f=[],p=0;p<s.length;p++){var h=s[p],d=h.type;h.name.match(/\.mzo$/)&&(d="audio/mzo");var m="GAE"==a.serverType&&h.size>3e5;if(d.match(v.contentType)){var g=h.name.replace(v.extPattern,"").replace(/\W/g,"_"),y="";h.name.match(v.extPattern)&&(y=RegExp.lastMatch.toLowerCase());var b,T=S.rel(g+y),x="ls:"+T.relPath(t.getDir()),A=w.some(function(e){b=e;var t=e.url.replace(v.extPattern,""),n=t.substring(t.lastIndexOf("/")+1,t.length);return n==g});if(A)c--,h.existsFile=b,f.push(h);else{var k=v.newItem(g);if(k.url=x,M(k),w.push(k),m)o.assertLogin({showLoginLink:function(e){D.css("border","solid red 2px").empty().append(n("div","大きい"+v.name+"を追加するには，ログインが必要です：",["a",{href:e,target:"login",style:"color: blue;"},"ログインする"]))},success:function(e){D.text("アップロード中...");var n=t.getName();i.upload(e,n,h,{success:function(){D.text(C),k.url="${blobPath}/"+e+"/"+n+"/"+h.name,E(k)}})}});else{var R=0,L=new FileReader;L.temp_file=h,L.temp_itemName=g,L.temp_itemExt=y,L.temp_v=k,L.onloadend=function(e){var n=e.target,r=n.result;if(null==n.error&&null!=r){var i=S.rel(n.temp_itemName+n.temp_itemExt);i.setBytes(r),n.temp_v.url="ls:"+i.relPath(t.getDir());for(var o=0;o<s.length;o++)if(s[o]==n.temp_file){u[o]=n.temp_v;break}}R++,R==c&&P(u)},L.readAsArrayBuffer(h)}}}else c--,l.push(h)}if(l.length>0){var N="このファイルは追加できません：\n";l.forEach(function(e){e&&(N+=e.name+"\n")}),alert(N)}if(f.length>0){var N="同じ名前のファイルが既に登録されています：\n";f.forEach(function(e){if(e){var t=e.existsFile.url,n=t.substring(t.lastIndexOf("/")+1,t.length);N+=e.name+" ⇒ "+n+"("+e.existsFile.name+") と重複\n"}}),alert(N)}return!1}function g(e){e.stopPropagation(),e.preventDefault()}function A(i){function o(){"sound"!=r&&s.show(i,t,i.name,{onclose:function(){t.setResource(b),h()}})}function a(){for(var n=T.length-1;n>=0;n--)if(T[n].name==i.name){try{var r=l.resolve(T[n].url,t,{asFile:1});e.isFile(r)&&S.contains(r)&&(console.log(r.path()," is removed."),r.rm())}catch(o){}T.splice(n,1);break}d("del",i.name.substring(1))}function u(){for(var e=T.length-1;e>=1;e--)if(T[e]===i){T.splice(e,1),T.splice(e-1,0,i);break}d()}function c(){for(var e=T.length-2;e>=0;e--)if(T[e]===i){T.splice(e,1),T.splice(e+1,0,i);break}d()}var m=n("div",{style:"float:left;",id:i.name.substring(1)},["canvas",{$var:"c",width:100,height:100,"class":"clickable",on:{click:o}}],["div",{style:"float:right;"},["button",{on:{click:a}},"×"],["br"],["button",{on:{click:u}},"←"],["br"],["button",{on:{click:c}},"→"]],["div",["input",{$var:"name",size:12,value:i.name}]]);f(p(i.url),m.$vars.c[0]);var g=m.$vars;return g.data=i,m}function E(e){T.push(e||v.newItem()),d()}function P(e){e.forEach(function(e){e&&T.push(e||v.newItem())}),d()}function M(e){for(var t=e.name,n=t,r=1,i=w.length-1;i>=0;i--){var o=w[i];o.name!=n||(n=t+"_"+r,r++,i=w.length)}e.name=n}if("del"==u){var k=$("#"+c);b=t.getResource(),T=b[v.key],w=T.slice(),x.some(function(e,t){return e[0].id==c?(x.splice(t,1),!0):void 0}),k.removeAttr("id"),k.remove()}else if(y.empty(),b=t.getResource(),T=b[v.key],w=T.slice(),x=[],"close"!=u){var C="ここに"+v.name+"ファイル("+v.exts.join("/")+")をドラッグ＆ドロップして追加",D=n("div",{style:"margin:10px; padding:10px; border:solid blue 2px;",on:{dragover:g,dragenter:g,drop:m}},C).appendTo(y),R=n("div").appendTo(y);T.forEach(function(e){var t=A(e,T);x.push(t),t.appendTo(R)}),y.append(n("div",{style:"clear:left;"},["button",{on:{click:function(){E()}}},"追加"],["button",{on:{click:function(){y.dialog("close")}}},"完了"]))}}function d(e,n){x.forEach(function(e){var t=e.$vars,n=t.data;n.name=t.name.val()}),console.log(b),t.setResource(b),h(e,n)}function m(){var e=b[v.key];o.currentUser(function(n,o){if(n){var s=[];e.forEach(function(e){var t,n;(t=i.isBlobURL(e.url))&&(s.push(t.fileName),n=t.fileName.replace(/\.(mp3|mp4|m4a)$/,".ogg"),n!=t.fileName&&s.push(n))});var u={user:n,project:t.getName(),mediaType:r,csrfToken:o,retainFileNames:JSON.stringify(s)};console.log("retainBlobs",u),$.ajax({url:a.serverTop+"/retainBlobs",type:"get",data:u})}});var n={};S.exists()&&S.each(function(e){n["ls:"+e.relPath(t.getDir())]=e}),b=t.getResource(),e.forEach(function(e){delete n[e.url],delete n[e.url.replace(/\.(mp3|mp4|m4a)$/,".ogg")]}),console.log(n)}var g={image:{name:"画像",exts:["png","gif","jpg"],path:"images/",key:"images",extPattern:/\.(png|gif|jpe?g)$/i,contentType:/image\/(png|gif|jpe?g)/,newItem:function(e){var t={type:"single"};return e&&(t.name="$pat_"+e),t}},sound:{name:"音声",exts:["mp3","ogg","mp4","m4a","mid","wav","mzo"],path:"sounds/",key:"sounds",extPattern:/\.(mp3|ogg|mp4|m4a|midi?|wav|mzo)$/i,contentType:/((audio\/(mp3|ogg|x-m4a|midi?|wav|mzo))|(video\/mp4))/,newItem:function(e){var t={};return e&&(t.name="$se_"+e),t}}},v=g[r||"image"],y=n("div",{title:v.name+"リスト"});y.css({height:"200px","overflow-v":"scroll"});var b=t.getResource(),T=b[v.key],w=T.slice(),S=t.getDir().rel(v.path),x=[];return b||t.setResource({images:[],sounds:[]}),h(),y.dialog({modal:!0,width:800,height:500,close:function(){d("close"),m(),"sound"==r&&S.exists()&&c.convert(S)}})};return p}),requireSimulator.setName("MainClassDialog"),define(["UI"],function(e){var t={};return t.show=function(e,n){var r=t.embed(e,n);return r.dialog({width:600}),r},t.embed=function(n,r){r||(r={}),t.d||(t.d=e("div",{title:"実行するクラスを選択"},["div",["select",{$var:"mainClass"}],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){t.d.done(!1)}}},"OK"],["button",{$var:"RunButton",on:{click:function(){t.d.done(!0)}}},"実行"]]));var i=t.d,o=t.d.$vars;n.getDir();var a=n.getOptions();return i.done=function(e){a.run.mainClass=o.mainClass.val(),n.setOptions(a),r.on&&r.on.done&&r.on.done(o.mainClass.val(),e),i.dialog("close")},i},t}),requireSimulator.setName("NWMenu"),function(){function e(e,t,n){var r=require("nw.gui"),i=new r.Menu,o=new r.MenuItem({label:e||"Cut",click:function(){document.execCommand("cut"),console.log("Menu:","cutted to clipboard")}}),a=new r.MenuItem({label:t||"Copy",click:function(){document.execCommand("copy"),console.log("Menu:","copied to clipboard")}}),s=new r.MenuItem({label:n||"Paste",click:function(){document.execCommand("paste"),console.log("Menu:","pasted to textarea")}});return i.append(o),i.append(a),i.append(s),i}var t;if("object"!=typeof process)return{};var n=new e;$(document).on("contextmenu",function(e){e.preventDefault();var r={left:0,top:0};t&&(r=parent.$(t).offset(),console.log(r)),n.popup(e.originalEvent.x+Math.floor(r.left),e.originalEvent.y+Math.floor(r.top))});try{var r=require("nw.gui");win=r.Window.get();var i=new r.Menu({type:"menubar"});i.createMacBuiltin("My App"),win.menu=i}catch(o){console.log(o.message)}return parent&&parent.$("iframe").each(function(){var e=this.contentDocument||this.contentWindow.document;e===document&&(t=this)}),{}}(),requireSimulator.setName("extLink"),define(["WebSite","UI","PathUtil","Util","assert"],function(e,t,n,r,i){function o(e,n,r){r=r||{};var i=a(e,r);return t("a",i,n)}function a(t,n){var r=e.platform;n=n||{},n.on=n.on||{};var i=n.on&&n.on.click||function(){};return"win32"==r?(n.href="javascript:;",n.on.click=s("start",t,i)):"darwin"==r?(n.href="javascript:;",n.on.click=s("open",t,i)):(n.href=t,n.on.click=i,n.target="_new"),n}function s(e,t,n){return function(){u(e+" "+t),n&&n()}}var u=e.isNW?require("child_process").exec:function(){};return o.all=function(){e.isNW&&$("a").each(function(){var e=(location.protocol+"//"+location.host+"/",$(this)),t=e.attr("href");if(t.match(/^http/)){var n=i.is(a(t),{href:String,on:{click:Function}});e.attr("href",n.href),e.click(n.on.click)}})},o}),requireSimulator.setName("mkrun"),define(["FS","Util","assert","WebSite","plugins","Shell","Tonyu"],function(e,t,n,r,i,o,a){var s={};return o.mkrun=function(t){return s.run(a.currentProject,e.get(t))},s.run2=function(t,i,o){var a;switch(i){case"prj":a=this.tmpDir().rel("prj.zip");case"zip":dest=this.tmpDir().rel(t.getDir().name());break;case"dir":dest=o.dest}return n(dest,"dest is not set"),console.log("mkrun2",dest,a),s.run(t,dest,o).then(function(){switch(i){case"zip":return e.zip.zip(dest,o).finally(function(){return dest.rm({r:1})});case"prj":return e.zip.zip(dest,a,o).then(function(){return a.getContent(function(e){var t=new FormData,n=r.uploadTmpUrl;return t.append("content",new Blob([e.toBin(ArrayBuffer)],{type:e.contentType}),a.name()),$.ajax({url:n,method:"POST",data:t,processData:!1,contentType:!1})})}).then(function(e){if(console.log(e),!e.match(/^[\w\d\.]+\.zip$/))throw new Error("アップロード失敗: "+e);return{tmpFileName:e}}).finally(function(e){return dest.rm({r:1}).then(function(){a.rm()}).then(function(){return e})})}})},s.tmpDir=function(){var t="/mkram/";s.mounted||e.mount(t,e.LSFS.ramDisk()),s.mounted=!0;var n=e.get(t);return n.exists()&&n.rm({r:1}),n},s.run=function(n,a,s){function u(){a.rel("Readme.txt").text("このフォルダは、Webサーバにアップロードしないと正常に動作しない可能性があります。\n詳しくは\nhttps://www.tonyu.jp/tonyu2/runtime.html\nを御覧ください。\n")}function c(e){var t=b.rel(e);t.exists()&&t.copyTo(a.rel(e))}function l(){m("res.json",T),m("options.json",w);var e=b.rel("maps/");e.exists()&&e.recursive(function(e){m(e.relPath(b),e.obj())});var t=b.rel("static/");t.exists()&&t.recursive(function(e){m(e.relPath(b))}),a.rel("js/files.js").text(S+"}")}function f(){var e=x.rel("html/runtimes/index.html");return e.text(function(t){return t=t.replace(/TONYU_APP_VERSION/g,Math.floor(1e5*Math.random())),a.rel(e.name()).text(t)})}function p(){var t=b.rel("js/concat.js"),n=b.rel("js/concat.js.map"),i=e.get(r.kernelDir).rel("js/concat.js"),o=A.rel("gen/runScript2_concat.js");return $.when(n.exists()&&n.copyTo(a.rel("js/concat.js.map")),t.copyTo(a.rel("js/concat.js")),i.copyTo(a.rel("js/kernel.js")),o.copyTo(a.rel("js/runScript2_concat.js")))}function h(){var e=A.rel("plugins/");if(w.plugins){var t=[];for(var n in w.plugins){var r=e.rel(i.installed[n].src);t.push(r.copyTo(a.rel("js/plugins/")))}return $.when.apply($,t)}}function d(){return $.when(A.rel("lib/jquery-1.10.1.js").copyTo(a.rel("js/lib/")),A.rel("lib/require.js").copyTo(a.rel("js/lib/")))}function m(e,t){if(null==t){var n=b.rel(e);if(".json"!==n.ext())return n.isText()?(t=n.text(),void(S+="	dir.rel('"+e+"').text("+JSON.stringify(t)+");\n")):(t=n.dataURL(),void(S+="	dir.rel('"+e+"').dataURL("+JSON.stringify(t)+");\n"));t=n.obj()}S+="	dir.rel('"+e+"').obj("+JSON.stringify(t)+");\n"}function g(e){for(var n in e){var r=e[n].url;if(t.startsWith(r,"ls:")){var i=r.substring("ls:".length);e[n].url=i}}}function v(){var e={"images/Ball.png":1,"images/base.png":1,"images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},t=[];for(var n in T.images){var r=T.images[n].url;if(e[r]&&!b.rel(r).exists()){var i=x.rel(r);i.exists()?t.push(i.copyTo(a.rel(r))):o.echo(i+" not exists!")}}return $.when.apply($,t)}function y(){b.copyTo(a.rel("src/"))}s=s||{};var b=n.getDir(),T=n.getResource(),w=n.getOptions(),S="function loadFiles(dir){\n   if (WebSite.isNW) return;\n",x=e.get(r.wwwDir),A=x.rel("js/");return console.log("jsDir",A),s.copySrc&&y(),$.when(v(),g(T.images),g(T.sounds),l(),p(),h(),d(),c("images/"),c("sounds/"),f(),u())},s}),requireSimulator.setName("zip"),define(["FS"],function(e){return e.zip}),requireSimulator.setName("mkrunDiag"),define(["UI","extLink","mkrun","Tonyu","zip","DeferredUtil"],function(e,t,n,r,i,o){var a={};return a.show=function(e,t,n){var r=a.embed(e,t,n);r.dialog({width:800,height:400})},a.embed=function(r,i){i=i||{};var s=i.dest,u=i.onComplete||function(){},c={click:function(){"dir"===h.value?l.dest.prop("disabled",!1):l.dest.prop("disabled",!0)}};a.d||(a.d=e("div",{title:"ランタイム作成"},["form",{action:"javascript:;",$var:"form",name:"mkrunform"},["h1","出力方法"],["div",["input",{type:"radio",name:"outtype",value:"zip",on:c}],["label",{"for":"outtype"},"ZIP圧縮したものを保存する"]],["div",["input",{type:"radio",name:"outtype",value:"prj",on:c}],["label",{"for":"outtype"},"プロジェクトボードにアップロードする"]],["div",{$var:"folder"},["input",{type:"radio",name:"outtype",value:"dir",on:c}],["label",{"for":"dest"},"次のフォルダに出力："],["br"],["input",{$var:"dest",id:"dest",$edit:"dest",size:60}]],["h1","オプション"],["div",["input",{id:"src",$edit:"src",type:"checkbox"}],["label",{"for":"src"},"ソースを添付する"],["div",{"class":"srcwarn"},"ソースを添付すると，アップロードしたファイルをプロジェクトボード上で直接編集できます．"]],["button",{$var:"OKButton",on:{click:function(){a.run()}}},"作成"],["span",{$var:"progress"}]]));var l=a.d.$vars;l.OKButton.prop("disabled",!1),i.dest?l.folder.show():l.folder.hide();var f={dest:s&&s.path?s.path():s||"",src:!0,zip:!0},p=l.form[0],h=p.outtype;return l.dest.prop("disabled",!0),h.value="zip",a.d.$edits.load(f),a.run=function(){function s(){var e=FS.get(f.dest),t=require("nw.gui");t.Shell.showItemInFolder(e.path().replace(/\//g,"\\"))}var c=h.value;a.d.$vars.OKButton.prop("disabled",!0);var p={copySrc:f.src};return p.progress=function(e){return l.progress.text(e.name()),o.timeout(0)},"dir"===c&&(p.dest=FS.get(FS.PathUtil.directorify(f.dest))),n.run2(r,c,p).then(function(n){switch(c){case"dir":UIDiag.alert(e("div",["p",["a",{href:"javascript:;",style:"color: blue;",on:{click:s}},f.dest],"にランタイムを作成しました。"],["p","次のいずれかの方法でWebアプリとして公開することができます。"],["ul",["li","フォルダをお手持ちのWebサーバにアップロードする"],["li","上のフォルダをZIPで圧縮したものを",t("http://www.tonyu.jp/project/","プロジェクトボード",{style:"color: blue;"}),"にアップロードする"]]),{width:"auto"});break;case"zip":UIDiag.alert(e("div",["p","ランタイムを作成しました。"],["p","次のいずれかの方法でWebアプリとして公開することができます。"],["ul",["li","解凍したフォルダをお手持ちのWebサーバにアップロードする"],["li","保存したZIPファイルを",t("http://www.tonyu.jp/project/","プロジェクトボード",{style:"color: blue;"}),"にアップロードする"]]),{width:"auto"});break;case"prj":var r;r=e("div",["p",["strong","まだアップロードは完了していません"]],["p",t(WebSite.newVersionUrl+"?tmpFile="+n.tmpFileName,"新規バージョンページ",{style:"color: blue;",on:{click:function(){r.$vars.button.prop("disabled",!1)}}}),"に必要事項を記入して，アップロードを完了させてください"],["button",{$var:"button",on:{click:function(){r.dialog("close"),r.remove()}}},"OK"]),r.$vars.button.prop("disabled",!0),r.dialog()}u({type:c,config:f}),a.d.$vars.OKButton.prop("disabled",!1),a.d.dialog&&a.d.dialog("close"),i.onEnd&&i.onEnd()}).then(function(){},function(e){console.error(e),alert(e)})},a.d},a}),requireSimulator.setName("LSFS"),define(["FS"],function(e){return e.LSFS}),requireSimulator.setName("WebFS"),define(["FS"],function(e){return e.WebFS}),requireSimulator.setName("DiagAdjuster"),define([],function(){var e=function(e){this.diagElem=e,this.rszt=null,this.margin=30,this.timeout=100};return e.prototype.handleResize=function(){var e=this;this.rszt&&clearTimeout(this.rszt),this.rszt=setTimeout(function(){var t=e.diagElem.closest(".ui-dialog"),n=t.find(".ui-dialog-titlebar"),r=t.width(),i=t.height(),o=n.height(),a=e.margin,s={w:r-a,h:i-o-a};e.diagElem.css({width:s.w,height:s.h}),e.afterResize(e.diagElem)},this.timeout)},e.prototype.handleResizeF=function(){var e=this;return function(){e.handleResize()}},e.prototype.afterResize=function(){},e}),requireSimulator.setName("exportAsScriptTags"),define(["FS","Util","WebSite"],function(e,t,n){function r(e){return e=e.replace(/&(#?[\w\d]+;)/g,function(e,t){return"&amp;"+t}),e=e.replace(/<(\s*)\/(\s*)script(\s*)>/gi,function(e,t,n,r){return"&lt;"+t+"/"+n+"script"+r+"&gt;"})}var i=function(e,t){function i(e,t){var n=e.split("\n"),r="";return n.forEach(function(e){for(;;){if(!(e.length>t)){r+=e+"\n";break}r+=e.substring(0,t)+"\\\n",e=e.substring(t)}return r}),r}function o(e){try{var t=JSON.parse(e);return JSON.stringify(t,null,4)}catch(n){return e}}t=t||{};var a=t.excludes||{},s=t.includeJSScript,u="";if(u+="<script>WebSite_runType='singleHTML';</script>\n",s){var c=e.rel("res.json"),l=c.obj(),f="https://edit.tonyu.jp/";l.images.forEach(function(e){n.builtinAssetNames[e.url]&&(u+='<script src="'+f+e.url+'.js"></script>\n')}),u+='<script src="'+f+'js/lib/jquery-1.10.1.js" type="text/javascript"></script>\n',u+='<script src="'+f+'js/gen/runScript_concat.min.js" type="text/javascript"></script>\n'}u+="<div id='splash' style='position:relative'>\n",u+="<!--ここに，ロード中に表示する内容を記述できます。-->\n",u+="<!--You can write here what you want to show while loading. -->\n",u+="<div class='progress'>\n",u+="<!-- ここにロード中の進捗が表示されます．表示したくない場合はこのdiv要素を削除してください。 -->\n",u+="<!-- This shows progress. If you don't want to shot, remove this element -->\n",u+="</div>\n",u+="</div>\n",u+="<!--\n",u+="Open this site when editing this game:\n",u+="https://edit.tonyu.jp/index.html?importFromHTML=1\n",u+="-->\n";var p=[],h=[];return e.recursive(function(t){var n=t.relPath(e);if(!a[n]){if(t.endsWith(".json")&&n.indexOf("maps/")<0)return void h.push(t);if(!t.endsWith(".tonyu"))return void p.push(t);var i=" data-lastupdate='"+t.lastUpdate()+"' ";u+="<script language='text/tonyu' type='text/tonyu' data-filename='"+n+"'"+i+">",u+=r(t.text()),u+="</script>\n\n"}},{excludes:["files/"]}),h.forEach(function(t){var n=t.relPath(e),r=" data-lastupdate='"+t.lastUpdate()+"' ";u+="<script language='text/tonyu' type='text/tonyu' data-filename='"+n+"'"+r+">\n",u+=o(t.text()),u+="</script>\n\n"}),p.forEach(function(t){var n=t.relPath(e),r=" data-lastupdate='"+t.lastUpdate()+"' ";u+="<script language='text/tonyu' type='text/tonyu' data-filename='"+n+"' data-wrap='80'"+r+">",u+=i(t.text(),80),u+="</script>\n\n"}),u};return i}),requireSimulator.setName("ExportHTMLDialog"),define(["exportAsScriptTags","UI","Klass"],function(e,t,n){return ExportHTMLDialog=n.define({$this:"t",$:["prj"],show:function(t,n){var r=t.prj.getDir();t.createDOM(),t.dom.dialog({width:800,height:400}),setTimeout(function(){var i=e(r,n);t.prog.val(i)},0)},createDOM:function(e){return e.dom?e.dom:(e.dom=t("div",{title:"HTML生成"},["div","このHTMLをjsdo.itやcodepenなどのJS共有サイトに張り付けて実行できます．"],["textarea",{$var:"prog",rows:20,cols:60,placeholder:"Please wait..."}]),e.prog=e.dom.$vars.prog,e.dom)}})}),requireSimulator.setName("RunDialog"),define(["Klass","UI"],function(e,t){return RunDialog=e.define({$this:"t",$:function(e,n){e.param=n;var r=t("div",{id:"runArea",style:"text-align : center ;overflow:hidden;","class":"runArea"},["canvas",{$var:"cv",id:"cv",width:465,height:465,"class":"tonyu-canvas",style:" margin-left : auto ; margin-right : auto ;"}]);e.dom=r,e.canvas=r.$vars.cv},show:function(e,t){var n=e.dom,r=e.param,i=r.desktopEnv;t&&(i.runDialog={}),e.size=i.runDialog||(i.runDialog={});var o=e.size;e.cv=n.$vars.cv,o.width=o.width||($(window).width()-100)/2-20,o.height=o.height||r.screenH-20,!e.shownOnce||t?(console.log("DIag::show",o),n.dialog({width:o.width,height:o.height,position:o.top?{my:"left top",at:"left+"+o.left+" top+"+o.top}:{my:"right top",at:"right-10 bottom+10",of:$("#navBar")},resize:function(t,r){o.width=n.width(),o.height=n.height(),e.resizeCanvas(n.width(),n.height()),r&&(o.width=r.size.width,o.height=r.size.height,o.left=r.position.left,o.top=r.position.top,e.modified=!0)},drag:function(t,n){n&&(o.left=n.position.left,o.top=n.position.top,e.modified=!0)},close:function(){e.opened=!1,e.param.onClose()}}),e.shownOnce=!0):n.dialog(),e.opened=!0,$(".ui-dialog-titlebar-close").blur(),e.resizeCanvas(n.width(),n.height()),console.log("Diag",o)},resizeCanvas:function(e,t,n){console.log("canvas size",t,n),e.cv.attr("height",n).attr("width",t)}})}),requireSimulator.setName("ide/editor"),requirejs(["Util","Tonyu","FS","PathUtil","FileList","FileMenu","showErrorPos","fixIndent","Wiki","Tonyu.Project","Shell","Shell2","ProjectOptionsEditor","copyToKernel","KeyEventChecker","IFrameDialog","runtime","KernelDiffDialog","Sync","searchDialog","StackTrace","syncWithKernel","UI","ResEditor","WebSite","exceptionCatcher","Tonyu.TraceTbl","Log","MainClassDialog","DeferredUtil","NWMenu","ProjectCompiler","compiledProject","mkrunDiag","zip","LSFS","WebFS","extLink","DiagAdjuster","ExportHTMLDialog","RunDialog","GlobalDialog"],function(e,t,n,r,i,o,a,s,u,c,l,f,p,h,m,g,v,y,b,T,w,S,x,A,E,P,M,k,C,D,R,L,N,B,_,O,I,F,j,V,U){$(function(){function u(e){var t=tt.getOptions();t.compiler.diagnose!=e&&(t.compiler.diagnose=e,tt.setOptions(t))}function f(){var e=$(window).height()-$("#navBar").height();e-=20,at.screenH=e,$("#progs pre").css("height",e+"px"),$("#fileItemList").height(e)}function h(){ut.ls(curProjectDir),v()}function v(){curProjectDir.each(function(e){if(e.endsWith(nt)){var t=e.truncExt(nt);it.indexOf(t)<0&&it.push(t)}});var e;for(e=it.length-1;e>=0;e--){var t=curProjectDir.rel(it[e]+nt);t.exists()||it.splice(e,1)}$("#runMenu").empty(),e=0,it.forEach(function(t){var n=e;"string"!=typeof t&&(console.log(t),alert("not a string: "+t)),n>=15||($("#runMenu").append($("<li>").append($("<a>").attr("href","#").text(t+"を実行"+(0==e?"(F9)":"")).click(K(function(){"string"!=typeof t&&(console.log(t),alert("not a string2: "+t)),N(t),n>0&&(it.splice(n,1),it.unshift(t),v(),J())})))),e++)}),$("#runMenu").append($("<li>").append($("<a>").attr("href","#").text("停止(F2)").click(K(function(){R()})))),$("#runMenu").append($("<li>").append($("<a>").attr("href","#").text("実行するファイルを選択...").click(K(function(){var e=C.show(tt,{on:{done:function(e,t){var n=it.indexOf(e);n>0&&(it.splice(n,1),it.unshift(e),v(),J()),t&&N(e)}}});e.$vars.mainClass.empty(),it.forEach(function(t){e.$vars.mainClass.append(x("option",{value:t},t))})})))),$("#exportToJsdoit").attr("href","javascript:;").click(function(){ot.show({excludes:{"js/concat.js":1,"js/concat.js.map":1},includeJSScript:!0})}),$("#exportToExe").attr("href","exportToExe.html?dir="+curProjectDir.path())}function y(e){var t=e.name();return e.isDir()?t:e.endsWith(nt)?e.truncExt(nt):null}function b(e,t){var n=!1;return e.match(/^[a-z]/)&&(e=e.substring(0,1).toUpperCase()+e.substring(1),n=!0),e.match(/^[A-Z_][a-zA-Z0-9_]*$/)?tt.isKernel(e)?tt.getOptions().kernelEditable?{ok:!0,file:curProjectDir.rel(e+nt),note:"create"==t.action?"Kernelから"+e+"をコピーします":""}:{ok:!1,reason:e+"はシステムで利用されている名前なので使用できません"}:n?{ok:!0,file:curProjectDir.rel(e+nt),note:"先頭を大文字("+e+") にして作成します．"}:{ok:!0,file:curProjectDir.rel(e+nt)}:{ok:!1,reason:"名前は，半角英数字とアンダースコア(_)のみが使えます．先頭は英大文字にしてください．"}}function w(){var e=ut.curFile();return e?st[e.path()]:null}function S(){var e=w();return e?e.editor:null}function M(e){var t=S();switch(e){case"run":t&&t.blur(),a($("#errorPos")),Q&&($("#runAreaParent").show().attr("class","col-xs-12"),$("#mainArea").hide(),f()),ht.opened||ht.show();break;case"compile_error":"undefined"!=typeof SplashScreen&&SplashScreen.hide();break;case"runtime_error":"undefined"!=typeof SplashScreen&&SplashScreen.hide();break;case"edit":ht.modified&&(delete ht.modified,J()),Q&&($("#runAreaParent").hide(),$("#mainArea").show())}}function D(e){return e&&ft?void alert("他のコマンド("+ft+")が実行されているのでお待ちください．\nしばらくたってもこのメッセージが出る場合，一旦Homeに戻ってください．"):(ft=e,e)}function R(){return D("stop")?$.when(tt.stop()).then(function(){M("edit")}).finally(function(){D()}):void 0}function N(e){return D("run")?$.when(tt.stop()).then(function(){return _(e)}).finally(function(){D()}):void 0}function _(e){if("string"!=typeof e){if(0==it.length)return void alert("ファイルを作成してください");e=it[0]}"string"!=typeof e&&(console.log(e),alert("not a string3: "+e)),G(),tt.initCanvas=function(){M("run"),t.globals.$mainCanvas=ht.canvas},k.dumpProject(curProjectDir),"undefined"!=typeof SplashScreen&&SplashScreen.show();var n=tt.getOptions();return n.run.mainClass!=e&&(n.run.mainClass=e,tt.setOptions()),et.touch(),tt.rawRun(n.run.bootClass).catch(function(e){e.isTError?(console.log("showErr: run"),a($("#errorPos"),e,{jump:O}),M("compile_error")):t.onRuntimeError(e)}).finally(function(){"undefined"!=typeof SplashScreen&&SplashScreen.hide()})}function O(e,t,n){ut.select(e);var r=w();r&&setTimeout(function(){var e=S();e&&e.gotoLine(t,n)},50)}function j(e){var t=st[e.path()];if(t){t.editor.destroy(),t.dom.remove(),delete st[e.path()];var n;for(var r in st)n=!0;n||$("#welcome").show()}}function W(e){var t=e.getCursorPosition(),n=e.getValue(),r=s(n);n!=r&&(e.setValue(r),e.clearSelection(),e.moveCursorTo(t.row,t.column))}function q(){for(var e in st){var t=st[e],n=t.file,r=t.editor;n.exists()&&r&&(r.setValue(n.text()),r.clearSelection())}}function G(){var e=w();if(e){var t=e.file,n=e.editor;
if(t&&n&&!t.isReadOnly()){W(n);var r=t.text(),i=n.getValue();r!=i&&(t.text(i),e.lastTimeStamp=t.lastUpdate())}ut.setModified(!1)}}function Z(){var e=w();e&&e.file.exists()&&(e.lastTimeStamp<e.file.lastUpdate()&&(e.editor.setValue(e.file.text()),e.editor.clearSelection(),e.lastTimeStamp=e.file.lastUpdate()),ut.setModified(e.file.text()!=e.editor.getValue()))}function z(e){if(!e.isDir()){$("#welcome").hide(),G(),dt&&dt.hide();var t=st[e.path()];if(t)t.lastTimeStamp<t.file.lastUpdate()&&(t.editor.setValue(t.file.text()),t.editor.clearSelection(),t.lastTimeStamp=t.file.lastUpdate()),t.dom.show(),t.editor.focus(),dt=t.dom;else{var n=$("<pre>").css("height",at.screenH+"px").text(e.text()).appendTo("#progs"),r=ace.edit(n[0]);window.lastEditor=r,r.setFontSize("number"==typeof rt.editorFontSize?rt.editorFontSize:16),r.setTheme("ace/theme/eclipse"),r.getSession().setMode("ace/mode/tonyu"),t=st[e.path()]={file:e,editor:r,dom:n},n.click(K(function(){M("edit")})),r.setReadOnly(!1),r.clearSelection(),r.focus();try{r.commands.removeCommand("toggleFoldWidget"),r.setOptions({fixedWidthGutter:!0})}catch(i){}dt=n}t.lastTimeStamp=t.file.lastUpdate()}}function H(){var e,t=curProjectDir.rel(".desktop");return e=t.exists()?t.obj():{},e.runMenuOrd||(e.runMenuOrd=[]),rt=e}function J(){var e=curProjectDir.rel(".desktop");e.obj(rt)}E.isNW||n.mount(location.protocol+"//"+location.host+"/",new I),"projectBoard"===E.serverType&&$.ajax("../../../a.php?Test/test").then(function(e){console.log("Session",e)}),$.get("https://edit.tonyu.jp/doc/welcome_edit.html?a").then(function(e){$("#welcome").append(e)});var K=P.f;$LASTPOS=0;var Q=E.mobile||n.get(E.tonyuHome).rel("mobile.txt").exists();Q&&($("#fileViewer").hide(),$("#runAreaParent").hide(),$("#mainArea").attr("class","col-xs-12"),$("#fileSel").show());{var Y;n.get(E.tonyuHome)}E.kernelDir&&!r.isURL(E.kernelDir)&&(Y=n.get(E.kernelDir),Y.exists()&&L(Y).loadClasses().fail(function(e){console.log(e),alert("Kernel compile error!")}));var X=e.getQueryString("dir","/Tonyu/Projects/SandBox/"),et=curProjectDir=n.get(X),tt=c(curProjectDir);t.globals.$currentProject=tt,t.currentProject=tt;var nt=tt.EXT,rt=H(),it=rt.runMenuOrd,ot=new V(tt);t.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32},{name:"$pat_mapchip",url:"images/mapchip.png",pwidth:32,pheight:32},{name:"$pat_inputPad",url:"images/inputPad.png"}],sounds:[]},location.href.match(/^file/)&&t.defaultResource.images.splice(1,1),t.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:"Main",bootClass:"Boot",globals:{$defaultFPS:60,$imageSmoothingDisabled:!0}},kernelEditable:!1,version:t.VERSION},u(!1);var at={screenH:200,onClose:R,desktopEnv:rt};f();var st={};m.down(document,"F9",K(N)),m.down(document,"F2",K(R)),m.down(document,"ctrl+s",K(function(e){return G(),e.stopPropagation(),e.preventDefault(),!1})),$(window).resize(K(f)),$("body")[0].spellcheck=!1,l.cd(curProjectDir);var ut=i($(Q?"#fileSel":"#fileItemList"),{topDir:curProjectDir,on:{select:K(z),displayName:y}}),ct=o();ct.fileList=ut,$("#newFile").click(K(ct.create)),$("#mvFile").click(K(ct.mv)),$("#rmFile").click(K(ct.rm)),$("#closeFile").click(K(function(){var e=w();e&&j(e.file)})),$("#runDialog").click(K(function(){ht.show(!0)})),ct.on.close=j,ct.on.ls=h,ct.on.validateName=b,ct.on.createContent=function(e){var t=tt.isKernel(e.truncExt(nt));e.text(t?t.text():"")},ct.on.displayName=function(e){var t=y(e);return t?t:e.name()};var lt;ct.on.mvExtraUI=function(e){lt=x("div",["input",{type:"checkbox",$var:"chk",checked:"true",value:"chked"}],"プログラム中のクラス名も変更する"),e.append(lt)},ct.on.mv=function(e,t){return lt?$.when(G()).then(function(){if(lt.$vars.chk.prop("checked")){var n=e.truncExt(nt),r=t.truncExt(nt);return tt.renameClassName(n,r)}}).then(function(){return lt=null,q()}).catch(function(e){return alert("プログラム内にエラーがあります．エラーを修正するか，「プログラム中のクラス名も変更する」のチェックを外してもう一度やり直してください．"),console.log(e),!1}).finally(function(){"object"==typeof SplashScreen&&SplashScreen.hide()}):void 0},K(ct.on),ut.ls(curProjectDir),v();var ft,pt,ht=new U(at);pt=function(e){alert(e),pt=function(){}},window.onerror=P.handleException=t.onRuntimeError=function(e){t.globals.$lastError=e;var n,r=tt.env.traceTbl,i=r.find(e)||r.decode($LASTPOS);if(i&&(n=tt.decodeTrace(i)),console.log("onRunTimeError:stackTrace1",e.stack,n,$LASTPOS),n){if(n.mesg=e,e.pluginName)alert(e.message);else{{a($("#errorPos"),n,{jump:O})}M("runtime_error"),$("#errorPos").find(".quickFix").append(x("button",{on:{click:function(){var t=x("pre",e.stack),n=t.html().replace(/_trc_([\w]*)/g,function(e){return"<strong>"+e+"</strong>"});t.html(n),$("#errorPos").find(".quickFix").append(t)}}},"トレース表示"))}R()}else x("div",{title:"Error"},e+"",["pre",e.stack]).dialog({width:800}),R()},$("#mapEditor").click(K(function(){console.log("run map"),N("MapEditor")})),$("#search").click(K(function(){console.log("src diag"),T.show(curProjectDir,function(e){ut.select(e.file),setTimeout(function(){var t=S();t&&t.gotoLine(e.lineNo)},50)})})),setInterval(Z,1e3);var dt;d=function(){t.currentProject.dumpJS.apply(this,arguments)},$("#mkrun").click(K(function(){var e;E.isNW?(e=rt&&rt.runtimeConfig?rt.runtimeConfig.dest:n.get(E.cwd).rel("Runtimes/").rel(curProjectDir.name()),B.show(tt,{dest:e,onComplete:function(e){"dir"===e.type&&rt&&(rt.runtimeConfig=e.config,J())}})):B.show(tt,{hiddenFolder:!0,onEnd:function(){}})})),$("#imgResEditor").click(K(function(){window.curResEditor&&window.curResEditor.dialog("close"),window.curResEditor=A(tt,"image")})),$("#soundResEditor").click(K(function(){window.curResEditor&&window.curResEditor.dialog("close"),window.curResEditor=A(tt,"sound")})),$("#prjOptEditor").click(K(function(){p(tt)}));var mt=null;if($("#refHelp").click(K(function(){mt||(mt=g.create(E.top+"/doc/index.html")),mt.show()})),window.startTutorial=K(function(){mt||(mt=g.create(E.top+"/doc/tutorial.html")),mt.show()}),"object"==typeof progBar&&progBar.clear(),$("#rmPRJ").click(K(function(){"DELETE"==prompt(curProjectDir+"内のファイルをすべて削除しますか？削除する場合はDELETE と入力してください．","")&&(l.rm(curProjectDir,{r:1}),document.location.href="index.html")})),$("#mvPRJ").click(K(function(){var e=prompt("新しいプロジェクトの名前を入れてください",curProjectDir.name().replace(/\//g,""));if(e&&""!=e){e.match(/\/$/)||(e+="/");var t=curProjectDir.up().rel(e);if(t.exists())return void alert(t+" はすでに存在します");l.cp(curProjectDir,t),l.rm(curProjectDir,{r:1}),document.location.href="project.html?dir="+t}})),$("#editorEditor").click(K(function(){var e=S(),t=prompt("エディタの文字の大きさ",rt.editorFontSize||16);rt.editorFontSize=parseInt(t),e&&e.setFontSize(rt.editorFontSize||16),J()})),$("#openFolder").click(K(function(){var e=et,t=require("nw.gui");t.Shell.showItemInFolder(e.path().replace(/\//g,require("path").sep))})),l.curFile=function(){return ut.curFile()},ct.onMenuStart=G,SplashScreen.hide(),tt.getBlobInfos().length>0){var gt=x("div",{title:"ログイン"},["div","このプロジェクトを正常に動作させるにはログインが必要です"]);Auth.assertLogin({showLoginLink:function(e){gt.append(x("a",{href:e,target:"login",style:"font-size: 20px;"},"ログインする"))},success:function(){gt.dialog("close")}}),gt.dialog({modal:!0})}F.all()})}),requireSimulator.setName()});