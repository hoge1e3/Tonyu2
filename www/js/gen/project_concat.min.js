function FileList(e,t){function n(e){var t=$();if(!e)return t;var n=e.path();return v.find(h?"option":"span").each(function(){var e=$(this);e.data("filename")==n&&(t=e)}),t}function r(e){if((!m.on.select||!m.on.select(e))&&e)if(d=!1,e.isDir())a(e);else{var t=e.up();l.path()!=t.path()?(p=e,a(t)):(n(p).removeClass("selected"),p=e,n(p).addClass("selected"))}}function i(e){p&&(d=e,n(p).text(s(p,e)))}function o(){return d}function a(n){if("string"==typeof n&&(n=FS.get(n)),n&&(l=n,g.text(n.name()).attr({title:n.path()})),l&&l.isDir()){v.empty(),h&&(e.empty(),e.append($("<option>").text("Select...")));var i=l.up();i&&!l.equals(t.topDir)&&(h?e.append($("<option>").attr("value",i.path()).text("[Up]")):$(h?"<option>":"<li>").append($("<span>").addClass("fileItem").text("[Up]")).appendTo(v).click(function(){r(i)})),p&&!p.exists()&&(p=null),l.each(function(t){var n=u(t);if(n){var i=p&&p.path()==t.path();if(h)e.append($("<option>").attr("value",t.path()).text(s(t)));else{var o=$("<span>").addClass("fileItem").text(s(t)).data("filename",t.path());i&&o.addClass("selected"),console.log("Add file item ",t,h),$("<li>").append(o).appendTo(v).click(function(){r(t)})}}})}}function s(e,t){return(t?"*":"")+(e.isReadOnly()?"[RO]":"")+u(e)}function u(e){return m.on.displayName?m.on.displayName.apply(m,arguments):e.name()}function c(){return p}function f(){return l}var l=null,p=null,d=!1,h="select"==e[0].tagName.toLowerCase();t||(t={});var m={select:r,ls:a,on:t.on?t.on:{},curFile:c,curDir:f,setModified:i,isModified:o},g=$("<div>"),v=$("<div>");return h?e.change(function(){this.value&&r(FS.get(this.value))}):e.append(g).append(v),m}function fixIndent(e,t){function n(){for(var e="",n=0;h>n;n++)e+=t;return e}t||(t="    ");var r={"{":1,"}":-1},i=[];try{var o=TT.parse(e),a=o.result[0];a.forEach(function(e){r[e.type]&&(i[u.row]||(i[u.row]=""),i[u.row]+=e.type)})}catch(s){for(var u={row:0,col:0},c=e.length,f=0;c>f;f++){var l=e.substring(f,f+1);r[l]?(i[u.row]||(i[u.row]=""),i[u.row]+=l):"\n"==l?(u.row++,u.col=0):u.col++}}var p="",d=e.split("\n"),h=0,m=0;return d.forEach(function(e){var t=0,r=0;e=e.replace(/^\s*/,""),null!=i[m]&&(i[m].match(/^(\}*)/),r=RegExp.$1.length,i[m].match(/(\{*)$/),t=RegExp.$1.length),h-=r,e=n()+e,h+=t,p+=e+"\n",m++}),p=p.replace(/\n$/,"")}function HttpHelper(e){var t={},n=e.lineMark;return t.buf=$("<div>"),t.bufs=[t.buf],t.maxLineNo=-1,t.cur=function(){return t.bufs[t.bufs.length-1]},t.p=function(e){"string"==typeof e&&(e=e.length>0?$("<span>").text(e):null),t.cur()?(t.lineNo>t.maxLineNo&&(t.maxLineNo=t.lineNo,t.cur().append($("<a>").attr({id:n+"-"+t.lineNo,name:n+"-"+t.lineNo}))),e&&t.cur().append(e)):console.log("Warning - Stack underflow")},t.enter=function(e){"string"==typeof e&&(e=$(e)),t.bufs.push(e)},t.exit=function(){var e=t.bufs.pop();t.p(e)},t.h=function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},t}!function(){var e={};return e.def=function(t,n,r){var i=e.getModuleInfo(e.curName);i.type=r,e.setReqs(i,t),i.func=function(){return n.apply(this,e.getObjs(t))},e.loadIfAvailable(i)},define=function(t,n){e.def(t,n,"define")},require=requirejs=function(t,n){e.def(t,n,"require")},e.setReqs=function(t,n){n.forEach(function(n){var r=e.getModuleInfo(n);r.loaded||(t.reqs[n]=r,r.revReqs[t.name]=t)})},e.getModuleInfo=function(t){var n=e.modules;return n[t]||(n[t]={name:t,reqs:{},revReqs:{}}),n[t]},e.doLoad=function(t){var n=e.getModuleInfo(t);if(n.loaded)return n.obj;n.loaded=!0;var r=null;if(n.func)r=n.func();else{var i=t.split(/\./);r=function(){return this}(),i.forEach(function(e){r&&(r=r[e])}),null==r&&console.log("Warning: No obj for "+t)}if("define"==n.type&&null==r)throw"No obj for "+t;n.obj=r;for(var o in n.revReqs)e.notifyLoaded(n.revReqs[o],n.name);return r},e.notifyLoaded=function(t,n){delete t.reqs[n],e.loadIfAvailable(t)},e.loadIfAvailable=function(t){for(var n in t.reqs)return;e.doLoad(t.name)},e.getObjs=function(t){var n=[];return t.forEach(function(t){var r=e.doLoad(t);n.push(r)}),n},e.modules={},e.setName=function(t){e.curName&&(e.getModuleInfo(e.curName).func||e.doLoad(e.curName)),t&&(e.curName=t)},requireSimulator=e,e}(),requireSimulator.setName("Util"),Util=function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var r=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=r.exec(window.location.href);return null==i?n:t(i[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function r(e,t){return e.substring(0,t.length)===t}function i(e){function t(t){throw console.log(t),console.log(e,c),new Error(t)}e=e.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=e.length,o=0,a=0;if(!i)return new ArrayBuffer(0);r=Math.floor(i/4*3),"="==e.charAt(i-1)&&(r-=1),"="==e.charAt(i-2)&&(r-=1);for(var s=new ArrayBuffer(r),u=new Uint8Array(s),c=0,f=0;r>f&&(a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),o=a<<2,c++,a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|a>>4&3,o=(15&a)<<4,c++,f++,!(f>=r))&&(a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|a>>2&15,o=(3&a)<<6,c++,f++,!(f>=r));)a=n[e.charCodeAt(c)],void 0===a&&t("Invalid letter: "+e.charCodeAt(c)),u[f]=o|a,c++,f++;return s}function o(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(e),i=r.length,o=0,a=0,s=0;i>s&&(a=r[s],n+=t[a>>2],o=(3&a)<<4,s++,!(s>=i))&&(a=r[s],n+=t[o|a>>4],o=(15&a)<<2,s++,!(s>=i));)a=r[s],n+=t[o|a>>6],n+=t[63&a],s++;var u=i%3;return u&&(n+=t[o]),1==u?n+="==":2==u&&(n+="="),n}return{getQueryString:e,endsWith:n,startsWith:r,Base64_To_ArrayBuffer:i,Base64_From_ArrayBuffer:o}}(),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Tonyu=function(){function e(){function e(){return null!=x&&w}function t(){return E}function n(){N=!0,T=0}function r(e){x={prev:x,func:e}}function i(e,t,n){n||(n=[]);var i;"string"==typeof t&&(i=e["fiber$"+t]),"function"==typeof t&&(i=t.fiber),n=[b].concat(n);var o=0;r(function(){switch(o){case 0:i.apply(e,n),o=1;break;case 1:c(),o=2}})}function a(){if(x)try{x.func(b)}catch(e){s(e)}}function s(e){if(0==b.tryStack.length)return v(),void o(e);b.lastEx=e;for(var t=b.tryStack.pop();x;){if(t.frame===x){b.catchPC=t.catchPC;break}x=x.prev}}function u(){var e=b.lastEx;return b.lastEx=null,e}function c(e){x=x?x.prev:null,b.retVal=e}function f(e){b.tryStack.push({frame:x,catchPC:e})}function l(){b.tryStack.pop()}function p(e,t){if(n(),e.on){var r;t=t.concat(function(){b.lastEvent=arguments,b.retVal=arguments[0],r.remove(),g()}),r=e.on.apply(e,t)}}function d(e){var t=function(){b.retVal=arguments,g()},r=function(){for(var e="",t=0;t<arguments.length;t++)e+=arguments[t]+",";0==e.length&&(e="Async fail");var n=new Error(e);n.args=arguments,s(n),g()};e(t,r),n()}function h(t){E=!0,n(),t&&t.addTerminatedListener&&t.addTerminatedListener(function(){if(E=!1,b.group)b.group.notifyResume();else if(e())try{b.steps()}catch(t){o(t)}})}function m(e){b.group=e,e&&e.add(b)}function g(){var t=Tonyu.currentThread;for(Tonyu.currentThread=b,T=S,b.preempted=!1,N=!1;T-->0&&x;)a();b.preempted=!N&&e(),Tonyu.currentThread=t}function v(){w=!1,x=null}function y(){x=null,tryStack=[]}var b={enter:r,apply:i,exit:c,steps:g,step:a,isAlive:e,isWaiting:t,suspend:n,retVal:0,tryStack:[],kill:v,waitFor:h,setGroup:m,enterTry:f,exitTry:l,startCatch:u,waitEvent:p,runAsync:d,clearFrame:y},x=null,w=!0,T=0,E=!1,N=!1;return b}function t(e){var t={},n=[];return t.addTerminatedListener=function(e){n.push(e)},setTimeout(function(){n.forEach(function(e){e()})},e),t}function n(){var e={},t=[];return e.addTerminatedListener=function(e){t.push(e)},requestAnimationFrame(function(){t.forEach(function(e){e()})}),e}function r(){var e=[],t=[],n=!1;return e.addTerminatedListener=function(e){n?setTimeout(e,0):t.push(e)},e.receiver=function(){n=!0;for(var t=0;t<arguments.length;t++)e[t]=arguments[t];e.notify()},e.notify=function(){t.forEach(function(e){e()})},e}function i(){function t(e){e.group=u,p?p.push(e):c.push(e)}function n(n,r,i){r||(r="main");var o=e();return o.apply(n,r,i),t(o),o}function r(){try{i()}catch(e){o(e)}}function i(){function e(e){e.isWaiting()||(l=!1,e.steps())}for(var t=c.length-1;t>=0;t--){var n=c[t];n.isAlive()&&n.group===u||c.splice(t,1)}for(l=!0,p=[],c.forEach(e);p.length>0;)w=p,p=[],w.forEach(function(t){c.push(t),e(t)});p=null}function a(){f=!1}function s(){}var u,c=[],f=!0,l=!1,p=null;return u={add:t,addObj:n,steps:r,kill:a,notifyResume:s,threads:c}}function o(e){if(!Tonyu.onRuntimeError)throw alert("エラー! at "+$LASTPOS+" メッセージ  : "+e),e;Tonyu.onRuntimeError(e)}function a(e){if(e===Function)return null;if("function"==typeof e)e.constructor=null;else if("object"==typeof e)for(var t in e)e[t]=a(e[t]);return e}function s(){var e,t,n=[];if(1==arguments.length)t=arguments[0];else if(2==arguments.length&&"function"==typeof arguments[0])e=arguments[0],t=arguments[1];else if(2==arguments.length&&arguments[0]instanceof Array)n=arguments[0],t=arguments[1];else{if(3!=arguments.length)throw console.log(arguments),"Invalid argument spec";if(e=arguments[0],!e)throw console.log(arguments[2]),new Error("No parent class ");n=arguments[1],t=arguments[2]}t=a(t);var r=t.initialize?t.initialize:e?function(){e.apply(this,arguments)}:function(){};delete t.initialize,r.methods=t,n.forEach(function(e){if(!e.methods)throw e+" Does not have methods";for(var n in e.methods)n in t||(t[n]=e.methods[n])}),r.prototype=c(e,t),r.prototype.isTonyuObject=!0,u(r,{superclass:e?e.meta:null,includes:n.map(function(e){return e.meta})});var i=s.getMeta(r);return r.prototype.getClassInfo=function(){return i},r}function u(e,t){e.meta=e.meta||{},f(e.meta,t)}function c(e,t){return e?f(new e,t):t}function f(e,t){if(t&&"object"==typeof t)for(var n in t)e[n]=t[n];return e}function l(e,t){E[e]=t}function p(e){return E[e]}function d(e){var t=e.split("."),n=N;if(t.forEach(function(e){n&&(n=n[e])}),!n&&1==t.length){var r;for(var i in N){var o=N[i][e];if(o){if(n)throw new Error("曖昧なクラス名： "+i+"."+e+", "+r);n=o,r=i+"."+e}}}return n}function h(e,t){var n=function(){return t.apply(e,arguments)};return n.methodInfo=Tonyu.extend({thiz:e},t.methodInfo||{}),t.fiber&&(n.fiber=function(){return t.fiber.apply(e,arguments)},n.fiber.methodInfo=Tonyu.extend({thiz:e},t.fiber.methodInfo||{})),n}function m(e,t,n,r){if(!e)throw new Error(r+"(="+e+")のメソッド "+t+"を呼び出せません");var i=e[t];if("function"!=typeof i)throw new Error(("this"==r?"":r+".")+t+"(="+i+")はメソッドではありません");return i.apply(e,n)}function g(e,t,n){if("function"!=typeof e)throw new Error(n+"は関数ではありません");return e.apply({},t)}function v(e,t){if(e!=e||null==e)throw new Error(t+"(="+e+")は初期化されていません");return e}function y(e){for(var t=[],n=1;n<e.length;n++)t[n-1]=e[n];return t}function b(){throw new Error("クラス名はnewをつけて呼び出して下さい。")}function x(e){throw console.log("Not a tonyu object: ",e),new Error(e+" is not a tonyu object")}function T(e,t){return e in t}var S=60;s.addMeta=u,s.getMeta=function(e){return e.meta},s.ensureNamespace=function(e,t){var n,r=t.split("."),i=e;for(n=0;n<r.length;n++){var o=r[n];i[o]||(i[o]={}),i=i[o]}return i},s.define=function(e){var t=e.superclass,n=e.includes,r=e.fullName,i=e.shortName,o=e.namespace,f=e.methods,l=e.decls,p=s.ensureNamespace(Tonyu.classes,o),d=a(f),h=d.initialize;delete d.initialize;var m;m=h?t?function(){this instanceof m||b(),Tonyu.runMode?h.apply(this,arguments):t.apply(this,arguments)}:function(){this instanceof m||b(),Tonyu.runMode&&h.apply(this,arguments)}:t?function(){this instanceof m||b(),t.apply(this,arguments)}:function(){this instanceof m||b()},p[i]=m,m.methods=d,n.forEach(function(e){if(!e.methods)throw e+" Does not have methods";for(var t in e.methods)t in d||(d[t]=e.methods[t])});var g={},v=/^__([gs]et)ter__(.*)$/;for(var y in d)if(!y.match(/^fiber\$/)){d["fiber$"+y]&&(d[y].fiber=d["fiber$"+y],d[y].fiber.methodInfo={name:y,klass:m,fiber:!0}),d[y].methodInfo={name:y,klass:m};var x=v.exec(y);x&&(g[x[2]]=g[x[2]]||{},g[x[2]][x[1]]=d[y])}m.prototype=c(t,d),m.prototype.isTonyuObject=!0;for(var y in g)Object.defineProperty(m.prototype,y,g[y]);u(m,{fullName:r,shortName:i,namepsace:o,decls:l,superclass:t?t.meta:null,func:m,includes:n.map(function(e){return e.meta})});var w=s.getMeta(m);return m.prototype.getClassInfo=function(){return w},m};var E={},N={};return Tonyu={thread:e,threadGroup:i,klass:s,bless:c,extend:f,globals:E,classes:N,setGlobal:l,getGlobal:p,getClass:d,timeout:t,animationFrame:n,asyncResult:r,bindFunc:h,not_a_tonyu_object:x,hasKey:T,invokeMethod:m,callFunc:g,checkNonNull:v,VERSION:1446514162440,A:y}}()}),requireSimulator.setName("WebSite"),define([],function(){var e,t=document.location.href,n=!!t.match(/html\/dev\//)&&!!t.match(/localhost:3/);e=t.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:n,pluginTop:"http://tonyuedit.appspot.com/js/plugins",removeJSOutput:!0}:t.match(/tonyuexe\.appspot\.com/)||t.match(/localhost:8887/)||t.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:n}:{urlAliases:{},top:"../..",devMode:n};var r=window.navigator.userAgent.toLowerCase();return e.tablet=-1!=r.indexOf("windows")&&-1!=r.indexOf("touch")||-1!=r.indexOf("ipad")||-1!=r.indexOf("android")&&-1==r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("tablet")||-1!=r.indexOf("kindle")||-1!=r.indexOf("silk")||-1!=r.indexOf("playbook"),e.mobile=-1!=r.indexOf("windows")&&-1!=r.indexOf("phone")||-1!=r.indexOf("iphone")||-1!=r.indexOf("ipod")||-1!=r.indexOf("android")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("blackberry"),e.pluginTop||(e.pluginTop=e.top+"/js/plugins"),e.disableROM={},t.match(/tonyuedit\.appspot\.com/)||t.match(/localhost:8888/),(t.match(/\.appspot\.com/)||t.match(/localhost:888[87]/))&&(e.serverType="GAE"),t.match(/localhost:3000/)&&(e.serverType="Node"),e.serverTop=t.match(/tonyuexe\.appspot\.com/)||t.match(/localhost:8887/)?e.top+"/exe":e.top+"/edit",e.sampleImg=e.top+"/images",e.blobPath=e.serverTop+"/serveBlob",e.isNW="object"==typeof process&&process.__node_webkit,e.mp3Disabled=e.isNW,e.tonyuHome="/Tonyu/",e.url={getDirInfo:e.serverTop+"/getDirInfo",getFiles:e.serverTop+"/File2LSSync",putFiles:e.serverTop+"/LS2FileSync"},e.isNW&&(e.cwd=process.cwd().replace(/\\/g,"/").replace(/\/?$/,"/"),e.tonyuHome=process.env.TONYU_HOME?process.env.TONYU_HOME.replace(/\\/g,"/").replace(/\/?$/,"/"):e.cwd+"fs/Tonyu/",e.logdir="/var/log/Tonyu/",e.kernelDir=e.cwd+"www/Kernel/",e.ffmpeg=e.cwd+"ffmpeg/bin/ffmpeg.exe"),e.compiledKernel=t.match(/tonyuedit\.appspot\.com/)||t.match(/localhost:888/)||e.isNW?e.top+"/Kernel/js/concat.js":"http://tonyuexe.appspot.com/Kernel/js/concat.js",window.WebSite=e}),requireSimulator.setName("assert"),define([],function(){function e(t){if(t instanceof Array){var n=[];return t.forEach(function(t){n=n.concat(e(t))}),n}return[t]}var t=function(t){this.failMesg=e(t||"Assertion failed: ")};t.prototype={fail:function(){var t=$a(arguments);throw t=e(t),t=this.failMesg.concat(t),console.log.apply(console,t),new Error(t.join(" "))},subAssertion:function(){var n=$a(arguments);return n=e(n),new t(this.failMesg.concat(n))},assert:function(e,t){return e||this.fail(t),e},eq:function(e,t){return e!==t&&this.fail(e,"!==",t),e},is:function(e,t){var n=t,r=e;if(null==n)return n;if(n._assert_func)return n._assert_func.apply(this,[r]),e;if(this.assert(null!=e,[e,"should be ",n]),n instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&n instanceof global.Array){e&&"number"==typeof e.length||this.fail(e,"should be array:");for(var i=this,o=0;o<n.length;o++){var a=i.subAssertion("failed at ",e,"[",o,"]: ");a.is(r[o],n[o])}return e}if(n===String||"string"==n)return this.assert("string"==typeof r,[r,"should be a string "]),e;if(n===Number||"number"==n)return this.assert("number"==typeof r,[r,"should be a number"]),e;if(n instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&n instanceof global.RegExp)return this.is(r,String),this.assert(n.exec(r),[r,"does not match to",n]),e;if("function"==typeof n)return this.assert(r instanceof n,[r,"should be ",n]),e;if(n&&"object"==typeof n){for(var s in n){var a=this.subAssertion("failed at ",e,".",s,":");a.is(e[s],n[s])}return e}this.fail("Invaild type: ",n)},ensureError:function(e,t){try{e()}catch(n){return"string"==typeof t&&r(n+""===t,e+" thrown an error "+n+" but expected:"+t),void console.log("Error thrown successfully: ",n.message)}this.fail(e,"should throw an error",t)}},$a=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t};var n=new t,r=function(){try{return n.assert.apply(n,arguments)}catch(e){throw new Error(e.message)}};return r.is=function(){try{return n.is.apply(n,arguments)}catch(e){throw new Error(e.message)}},r.eq=function(){try{return n.eq.apply(n,arguments)}catch(e){throw new Error(e.message)}},r.ensureError=function(){try{return n.ensureError.apply(n,arguments)}catch(e){throw new Error(e.message)}},r.fail=n.fail.bind(n),r.f=function(e){return{_assert_func:e}},r.and=function(){var e=$a(arguments);return r(e instanceof Array),r.f(function(t){for(var n=this,r=0;r<e.length;r++)n.is(t,e[r])})},r}),requireSimulator.setName("PathUtil"),define(["assert"],function(e){function t(t,n){return e.is(arguments,[String,String]),t.substring(t.length-n.length)===n}function n(e,t){return e.substring(0,t.length)===t}var r,i=/^([a-zA-Z]):/,o=e.f(function(e){this.is(e,String),this.assert(r.isPath(e),[e," is not a path"])}),a=e.f(function(e){this.is(e,String),this.assert(r.isAbsolutePath(e),[e," is not a absolute path"])}),s=e.f(function(e){this.is(e,String),this.assert(!r.isAbsolutePath(e),[e," is not a relative path"])}),u=e.and(c,a),c=e.f(function(e){this.is(e,o),this.assert(r.isDir(e),[e," is not a directory path"])}),f=e.f(function(e){this.is(e,o),this.assert(!r.isDir(e),[e," is not a file path"])}),l="/";return r={Path:o,Absolute:a,Relative:s,Dir:c,File:f,AbsDir:u,SEP:l,endsWith:t,startsWith:n,hasDriveLetter:function(e){return i.exec(e)},isPath:function(t){return e.is(arguments,[String]),!t.match(/\/\//)},isRelativePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&!r.isAbsolutePath(t)},isAbsolutePath:function(t){return e.is(arguments,[String]),r.isPath(t)&&(r.startsWith(t,l)||r.hasDriveLetter(t))},isDir:function(n){return e.is(arguments,[o]),t(n,l)},splitPath:function(t){e.is(arguments,[o]);var n=t.split(l);return""==n[n.length-1]&&(n[n.length-2]+=l,n.pop()),n},name:function(t){return e.is(arguments,[String]),r.splitPath(t).pop()},ext:function(t){e.is(arguments,[String]);var n=r.name(t),i=/\.[a-zA-Z0-9]+$/.exec(n);return i?i[0]:null},truncExt:function(t,n){e.is(t,String);var i=r.name(t);return n=n||r.ext(t),e.is(n,String),i.substring(0,i.length-n.length)},truncSEP:function(t){return e.is(arguments,[o]),r.isDir(t)?t.substring(0,t.length-1):t},endsWith:function(n,i){return e.is(arguments,[String,String]),t(r.name(n),i)},parent:function(t){return e.is(arguments,[String]),r.up(t)},rel:function(t,n){e.is(arguments,[u,s]);var i=r.splitPath(n),o=t;o=o.replace(/\/$/,"");var a=r;return i.forEach(function(e){".."==e||"../"==e?o=a.up(o):(o=o.replace(/\/$/,""),o+=l+("."==e||"./"==e?"":e))}),o},relPath:function(t,n){return e.is(arguments,[u,u]),t.substring(0,n.length)!=n?"../"+r.relPath(t,this.up(n)):t.substring(n.length)},up:function(t){if(e.is(arguments,[o]),t==l)return null;var n=r.splitPath(t);return n.pop(),n.join(l)+l}}}),requireSimulator.setName("Env"),define(["assert","PathUtil"],function(e,t){var n=function(e){this.value=e};return n.prototype={expand:function(t){e.is(t,String);var n=this;return t.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,t){return n.get(t)})},expandPath:function(n){return e.is(n,String),n=this.expand(n),n=n.replace(/\/+/g,"/"),e.is(n,t.Path)},get:function(e){return this.value[e]},set:function(e,t){this.value[e]=t}},n}),requireSimulator.setName("SFileNW"),define(["WebSite","Env"],function(e,t){function n(e){this._path=u(e)}function r(e,t){for(var n in t)e[n]=t[n]}function i(e,t){return e.substring(e.length-t.length)===t}function o(e,t){return e.substring(0,t.length)===t}function a(e){return!m&&o(e,p)||m&&e.match(h)}function s(e){return i(e,p)?e.substring(0,e.length-1):e}function u(e,t){if(t=t||process.cwd(),t=t.replace(/\\/g,p),e=e.replace(/\\/g,p),m&&o(e,p)){var n=t,r=h.exec(n);if(!r)throw new Error(t+" : should have drive letter");e=r[0]+e}else a(e)||(e=s(t)+p+e);var u=e.split(p),c=[];u.forEach(function(e){return""!=e&&"."!=e?".."==e?void c.pop():void c.push(e):void 0});var f=c.join(p);if(m||(f=p+f),!a(f))throw new Error(f+": is not absolute. hasDriverLetter="+m);return f=s(f),i(e,p)&&(f+=p),f}var c={};if(!e.isNW)return{};var f=require("fs"),l=new t(e),p="/",d=JSON,h=/^([a-zA-Z]):/,m=h.exec(process.cwd()),g={".png":"image/png",".jpg":"image/jpg",".gif":"image/gif",".jpeg":"image/jpg",".mp3":"audio/mp3",".ogg":"audio/ogg"};c.resolve=function(e,t){return e=l.expandPath(e),c.get(u(e,t))},c.expandPath=function(){return l.expandPath.apply(l,arguments)},r(n.prototype,{isSFile:function(){return!0},text:function(){if(0==arguments.length)return this.isDir()?d.stringify(this.metaInfo()):this.isBinary()?this.readDataURLFromBin():f.readFileSync(this.path(),{encoding:"utf8"});var e=this.up();e&&e.mkdir(),this.isBinary()?this.writeBinFromDataURL(arguments[0]):f.writeFileSync(this.path(),arguments[0])},lines:function(){return this.text().split("\n")},readDataURLFromBin:function(){var e=this.dataHeader();if(b=f.readFileSync(this.path()),b[0]==e.charCodeAt(0)&&b[1]==e.charCodeAt(1)&&b[2]==e.charCodeAt(2)&&b[3]==e.charCodeAt(3)&&b[4]==e.charCodeAt(4))return b.toString("utf8");var t=b.toString("base64");return e+t},writeBinFromDataURL:function(e){var t=this.dataHeader(),n=e.substring(t.length),r=new Buffer(n,"base64"),i=f.createWriteStream(this.path());i.write(r),i.end()},isBinary:function(){return g[this.ext()]},dataHeader:function(){var e=this.isBinary();return"data:"+e+";base64,"},obj:function(){return 0==arguments.length?d.parse(this.text()):void this.text(d.stringify(arguments[0]))},isReadOnly:function(){return!1},rm:function(){return this.isDir()?f.rmdirSync(this.path()):f.unlinkSync(this.path())},path:function(){return this._path},pathTS:function(){return s(this.path())},name:function(){var e=this.pathTS(),t="";return i(this.path(),p)&&(t=p),e.split(p).pop()+t},ext:function(){var e=this.name(),t=/\.[a-zA-Z0-9]+$/.exec(e);return t?t[0]:null},truncExt:function(e){var t=this.name();return t.substring(0,t.length-e.length)},endsWith:function(e){return i(this.name(),e)},exists:function(){return f.existsSync(this.path())},each:function(e,t){if(t||(t={}),!this.isDir())throw new Error(this+" cannot each. not a dir.");if(this.exists()){var n=this.pathTS(),r=f.readdirSync(this.path()),i=this;r.forEach(function(r){if(".dirinfo"!=r||t.includeDirInfo){var o=f.statSync(n+p+r),a=o.isDirectory()?p:"",s=i.rel(r+a);e(s)}})}},ls:function(){var e=[];return this.each(function(t){e.push(t.name())}),e},parent:function(){return this.up()},recursive:function(e){this.each(function(t){t.isDir()?t.recursive(e):e(t)})},toString:function(){return this.path()},rel:function(e){return new n(this.pathTS()+p+e)},mkdir:function(){if(this.exists()){if(this.isDir())return;throw new Error(this+" is a file. not a dir.")}var e=this.up();e&&e.mkdir(),f.mkdirSync(this.path())},relPath:function(e){var t=e.path?e.path():e;if(t.substring(t.length-1)!=p)throw new Error(t+" is not a directory.");return this.path().substring(0,t.length)!=t?"../"+this.relPath(e.up()):this.path().substring(t.length)},equals:function(e){return e instanceof n&&e.path()==this.path()},lastModified:function(){return this.stat().mtime.getTime()},lastUpdate:function(){return this.lastModified()},up:function(){var e=this.pathTS(),t=e.split(p);return t.pop(),e=t.join(p),""==e?null:new n(e+p)},copyFrom:function(e,t){this.isDir()||(this.text(e.text()),t.a&&file.metaInfo(e.metaInfo()))},isDir:function(){return this.exists()?this.stat().isDirectory():i(this.path(),p)},stat:function(){return f.statSync(this.path())},metaInfo:function(){if(this.isDir()){var e={};return this.each(function(t){e[t.name()]=t.metaInfo()}),e}return{lastUpdate:this.lastUpdate()}}}),c.get=function(e){if(null==e)throw new Error("FS.get: null path");return e instanceof n?e:new n(e)};var v="DONOTEXPORT";return c.exportDir=function(e,t){function n(r){var o=r.relPath(e);if(i[o]=r.text(),t.keepCR||(i[o]=i[o].replace(/\r/g,"")),r.isDir()){if(r.rel(v).exists())return;r.each(n)}}t||(t={}),"string"==typeof e&&(e=c.get(e));var r={base:e.path()},i=r.data={};return n(e),r},c}),requireSimulator.setName("extend"),define([],function(){return function(e,t){for(var n in t)e[n]=t[n]}}),requireSimulator.setName("DataURL"),define(["extend","assert"],function(e,t){function n(e){return e instanceof ArrayBuffer||"undefined"!=typeof Buffer&&e instanceof Buffer}function r(e){function t(t){throw console.log(t),console.log(e,f),new Error(t)}e=e.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var r,i=e.length,a=0,s=0;if(!i)return new o(0);r=Math.floor(i/4*3),"="==e.charAt(i-1)&&(r-=1),"="==e.charAt(i-2)&&(r-=1);for(var u=new o(r),c="undefined"!=typeof Buffer?u:new Uint8Array(u),f=0,l=0;r>l&&(s=n[e.charCodeAt(f)],void 0===s&&t("Invalid letter: "+e.charCodeAt(f)),a=s<<2,f++,s=n[e.charCodeAt(f)],void 0===s&&t("Invalid letter: "+e.charCodeAt(f)),c[l]=a|s>>4&3,a=(15&s)<<4,f++,l++,!(l>=r))&&(s=n[e.charCodeAt(f)],void 0===s&&t("Invalid letter: "+e.charCodeAt(f)),c[l]=a|s>>2&15,a=(3&s)<<6,f++,l++,!(l>=r));)s=n[e.charCodeAt(f)],void 0===s&&t("Invalid letter: "+e.charCodeAt(f)),c[l]=a|s,f++,l++;return u}function i(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=new Uint8Array(e),i=r.length,o=0,a=0,s=0;i>s&&(a=r[s],n+=t[a>>2],o=(3&a)<<4,s++,!(s>=i))&&(a=r[s],n+=t[o|a>>4],o=(15&a)<<2,s++,!(s>=i));)a=r[s],n+=t[o|a>>6],n+=t[63&a],s++;var u=i%3;return u&&(n+=t[o]),1==u?n+="==":2==u&&(n+="="),n}var o="undefined"!=typeof Buffer?Buffer:ArrayBuffer,a=function(e,r){"string"==typeof e?(this.url=e,this.dataURL2bin(e)):e&&n(e.buffer)?(this.buffer=e.buffer,t.is(r,String),this.contentType=r,this.bin2dataURL(this.buffer,this.contentType)):n(e)?(this.buffer=e,t.is(r,String),this.contentType=r,this.bin2dataURL(this.buffer,this.contentType)):t.fail("Invalid args: ",arguments)};return e(a.prototype,{bin2dataURL:function(e,r){t(n(e)),t.is(r,String);var o=this.dataHeader(r),a=i(e);return t.is(a,String),this.url=o+a},dataURL2bin:function(e){t.is(arguments,[String]);var n=/data:([^;]+);base64,(.*)$/i,i=n.exec(e);return t(i,["malformed dataURL:",e]),this.contentType=i[1],this.buffer=r(i[2]),t.is(this.buffer,o)},dataHeader:function(e){return t.is(arguments,[String]),"data:"+e+";base64,"},toString:function(){return t.is(this.url,String)}}),a}),requireSimulator.setName("Contents"),define(["DataURL"],function(e){var t={convert:function(t,n){var r;if("string"==typeof t&&(r=String),t instanceof e&&(r=e),t instanceof ArrayBuffer&&(r=ArrayBuffer),r==n)return t;throw new Error("Cannot convert from "+r+" to "+n)}};return t}),requireSimulator.setName("SFile"),define(["Contents","extend","assert","PathUtil"],function(e,t,n,r){var i=function(e,t){n.is(t,r.Absolute),n(e&&e.getReturnTypes),this._path=t,this.fs=e,this.isDir()&&!r.isDir(t)&&(this._path+=r.SEP)};return i.is=function(e){return e&&"function"==typeof e.isSFile&&e.isSFile()},i.prototype={isSFile:function(){return!0},_clone:function(){return this.fs.getRootFS().get(this.path())},_resolve:function(e){var t;return i.is(e)?t=e:(n.is(e,r.Absolute),t=this.fs.getRootFS().get(e)),this.wrapper?this.wrapper.wrap(t):t},contains:function(e){return n(i.is(e),e+" shoud be a SFile object."),this.isDir()?r.startsWith(e.path(),this.path()):!1},path:function(){return this._path},name:function(){return r.name(this.path())},truncExt:function(e){return r.truncExt(this.path(),e)},ext:function(){return r.ext(this.path())},relPath:function(e){var t=e.path?e.path():e;return r.relPath(this.path(),n.is(t,r.Absolute))},up:function(){var e=this.path(),t=r.up(e);return null==t?null:this._resolve(t)},rel:function(e){n.is(e,r.Relative),this.assertDir();var t=this.path();return this._resolve(r.rel(t,e))},startsWith:function(e){return r.startsWith(this.name(),e)},endsWith:function(e){return r.endsWith(this.name(),e)},equals:function(e){return e&&"function"==typeof e.path&&e.path()==this.path()},toString:function(){return this.path()},touch:function(){this.fs.touch(this.path())},isReadOnly:function(){this.fs.isReadOnly(this.path())},isTrashed:function(){var e=this.metaInfo();return e?e.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(e){return this.fs.getMetaInfo(this.path(),e)},setMetaInfo:function(e,t){return this.fs.setMetaInfo(this.path(),e,t)},lastUpdate:function(){return n(this.exists()),this.metaInfo().lastUpdate},exists:function(e){e=e||{};var t=this.fs.exists(this.path(),e);return t||e.noFollowLink?t:this.resolveLink().exists({noFollowLink:!0})},rm:function(e){if(e=e||{},!this.exists({noFollowLink:!0})){var t=this.resolveLink();if(!this.equals(t))return t.rm(e)}this.isDir()&&(e.recursive||e.r)&&this.each(function(t){t.rm(e)});var n=this.path();this.fs.rm(n,e)},removeWithoutTrash:function(e){e=e||{},e.noTrash=!0,this.rm(e)},isDir:function(){return this.fs.isDir(this.path())},text:function(){var e=this.resolveLink();return this.equals(e)?arguments.length>0?void this.setText(arguments[0]):this.getText():e.text.apply(e,arguments)},setText:function(e){n.is(e,String),this.fs.setContent(this.path(),e)},getText:function(){return this.fs.getContent(this.path(),{type:String})},lines:function(){return this.text().split("\n")
},obj:function(){var e=this;if(0==arguments.length){var t=e.text();return t?JSON.parse(t):null}e.text(JSON.stringify(n.is(arguments[0],Object)))},copyFrom:function(e,t){var r=this,t=t||{},i=e.isDir(),o=r.isDir();if(!i&&o&&(r=r.rel(e.name()),assert(!r.isDir(),r+" exists as an directory."),o=!1),i&&!o)this.err("Cannot move dir to file");else{if(!i&&!o){var a=e.getText(),s=r.setText(a);return t.a&&r.setMetaInfo(e.getMetaInfo()),s}n(i&&o);e.each(function(e){r.rel(e.name()).copyFrom(e,t)})}},moveFrom:function(e,t){var n=this.copyFrom(e,t);return e.rm({recursive:!0}),n},assertDir:function(){return n.is(this.path(),r.Dir),this},each:function(e,t){var n=this.assertDir();n.listFiles(t).forEach(e)},recursive:function(e,t){var n=this.assertDir();n.each(function(t){t.isDir()?t.recursive(e):e(t)},t)},listFiles:function(e){n(null==e||"object"==typeof e);var t=this.assertDir(),r=this.resolveLink();if(!this.equals(r))return r.listFiles.apply(r,arguments);var i,o=this.path();"function"==typeof e&&(i=e),e=t.convertOptions(e),i||(i=e.order);for(var a=this.fs.opendir(o,e),s=[],u=0;u<a.length;u++){var c=a[u];e.excludes[o+c]||s.push(t.rel(c))}return"function"==typeof i&&s.sort&&s.sort(i),s},ls:function(e){n(null==e||"object"==typeof e);var t=this.assertDir(),r=t.listFiles(e);return r.map(function(e){return e.name()})},convertOptions:function(e){var t=(this.assertDir(),this.path());if(e||(e={}),e.excludes||(e.excludes={}),e.excludes instanceof Array){var i={};e.excludes.forEach(function(e){r.startsWith(e,"/")?i[e]=1:i[t+e]=1}),e.excludes=i}return n.is(e,{excludes:{}})},mkdir:function(){this.touch()},link:function(e,t){e=this._resolve(n(e)),this.fs.link(this.path(),e.path(),t)},resolveLink:function(){var e=this.fs.resolveLink(this.path());return n.is(e,r.Absolute),this._resolve(e)},isLink:function(){return this.fs.isLink(this.path())}},i}),requireSimulator.setName("FS"),define(["WebSite","SFileNW","Env","PathUtil","assert","SFile"],function(e,t,n,r,i,o){function a(e,t){if(t)for(var n in t)e[n]=t[n]}function s(e,t){return e.substring(e.length-t.length)===t}function u(e,t){return e.substring(0,t.length)===t}function c(){return(new Date).getTime()}function f(e){var t=e.split(j);return""==t[t.length-1]&&(t[t.length-2]+=j,t.pop()),t}function l(e){for(var t in C){var n=e.substring(0,t.length),r=e.substring(t.length);if(n==t)return{rom:C[t],rel:r}}return null}function p(e){return g(e)?P:localStorage}function d(e,t){var n=p(e),r=l(e);if(2!=arguments.length)return r?r.rom[r.rel]:n[e];if(r)throw new Error(e+" is Read only.");return null!=t?n[e]=t:void delete n[e]}function h(e){var t=p(e),n=l(e);return n?n.rel in n.rom:e in t}function m(e,t,n,r){if(null==e)throw new Error("putDir: Null path");if(!S(e))throw new Error("Not a directory : "+e);r==k?P[e]=t:d(e,JSON.stringify(t));var i=w(e);if(null!=i){var o=v(i,r);y(o,i,E(e),n,r)}}function g(e){return"ALL"==A?!0:"object"==typeof A&&A?e in A:!1}function v(e,t){if(null==e)throw new Error("getDir: Null path");s(e,j)||(e+=j);var n={},r={};if(t&k&&(r=P[e]||{}),t&M)try{var i=d(e);i&&(n=JSON.parse(i))}catch(o){console.log("dinfo err : "+e+" - "+n)}a(n,r),a(n,$[e]);for(var u in n)"number"==typeof n[u]&&(n[u]={lastUpdate:n[u]});return n}function y(e,t,n,r,i){e[n]||(e[n]={},r&&(e[n].trashed=!0)),r||delete e[n].trashed,e[n].lastUpdate=c(),m(t,e,r,i)}function b(e,t,n,r){e[n]&&(e[n]={lastUpdate:c(),trashed:!0},m(t,e,!0,r))}function x(e,t,n,r){e[n]&&(delete e[n],m(t,e,!0,r))}function w(e){if(e==j)return null;var t=f(e);return t[t.length-1]="",t.join(j)}function T(e){return u(e,j)}function S(e){return s(e,j)}function E(e){var t=f(e);return t[t.length-1]}if(t&&t.get)return"object"==typeof window&&(window.FS=t),t;var N=new n(e),k=1,M=2,L=3,P={},A=null;("undefined"==typeof localStorage||null==localStorage)&&(console.log("FS: Using RAMDisk"),A="ALL");var D={};"object"==typeof window&&(window.FS=D),D.ramDisk=P,D.ramDiskUsage=A;var C={},$={},j="/";D.roms=C,D.romParents=$,D.endsWith=s,D.splitPath=f,D.orderByNewest=function(e,t){if(!(e&&t&&e.lastUpdate&&t.lastUpdate))return 0;var n=e.lastUpdate(),r=t.lastUpdate();return r>n?1:n>r?-1:0},D.orderByName=function(e,t){return e.name&&t.name&&(e=e.name(),t=t.name()),e>t?1:t>e?-1:0},D.orderByNumberedName=function(e,t){function n(e){for(var t=[],n=/^[0-9]*/,r=/^[^0-9]*/;e&&(e.match(r),t.push(RegExp.lastMatch),e=e.replace(r,""));){e.match(n);var i=parseInt(RegExp.lastMatch);t.push(i),e=e.replace(n,"")}return t}e.name&&t.name&&(e=e.name(),t=t.name());var r,i=n(e),o=n(t);for(r=0;r<i.length;r++){if(r>=o.length)return 1;if(i[r]>o[r])return 1;if(i[r]<o[r])return-1}return r<o.length?-1:0},D.importDir=function(e){var t=D.get(e.base);e.confirm||t.mkdir();var n=e.data,r=[];for(var i in n){var o=t.path()+i,a=D.get(o);if(r.push("["+(a.isReadOnly()?"ro":a.exists()?"exists":"new")+"]"+o),!a.isReadOnly()&&!e.confirm)if(a.isDir()){var s=v(o,M),u=JSON.parse(n[i]);for(var c in u)s[c]=u[c];m(o,s,!1,M)}else d(o,n[i])}return r},D.mountROM=function(e){console.log("ROM mouted on ",e.base),C[e.base]=e.data;var t=f(e.base),n=t.pop(),r=t.join(j)+j;$[r]||($[r]={}),$[r][n]={lastUpdate:(new Date).getTime()}};var _="DONOTEXPORT";return D.exportDir=function(e,t){function n(r){var o=r.relPath(e);if(i[o]=r.text(),t.keepCR||(i[o]=i[o].replace(/\r/g,"")),r.isDir()){if(r.rel(_).exists())return;r.each(n)}}t||(t={}),"string"==typeof e&&(e=D.get(e));var r={base:e.path()},i=r.data={};return n(e),r},D.expandPath=function(){return N.expandPath.apply(N,arguments)},D.resolve=function(e,t){return o.is(e)?e:(e=N.expandPath(e),t&&!r.isAbsolutePath(e)?(t=N.expandPath(t),D.get(t).rel(e)):D.get(e))},D.get=function(e,t){if(t||(t={}),null==e)throw new Error("FS.get: Null path");if(e.isDir)return e;if(t.topDir&&!u(e,t.topDir))throw new Error(e+" is out of securtyDomain");if(!T(e))throw new Error(e+": Path must starts with '/'");var n,r=w(e),i=E(e);if(S(e)){var o=n={};o.files=function(e,t){var n=[];return o.each(function(e){n.add(e)},t),n},o.each=function(e,t){o.ls(t).forEach(function(t){var n=o.rel(t);e(n)})},o.recursive=function(e,t){o.each(function(t){t.isDir()?t.recursive(e):e(t)},t)},o.listFiles=function(t){var n;"function"==typeof t&&(n=t),t=o.convertOptions(t),n||(n=t.order);var r=v(e,L),i=[];for(var a in r)(t.includeTrashed||!r[a].trashed)&&(t.excludes[e+a]||i.push(o.rel(a)));return"function"==typeof n&&i.sort&&i.sort(n),i},o.ls=function(e){var t=o.listFiles(e),n=[];return t.forEach(function(e){n.push(e.name())}),n},o.convertOptions=function(t){if(t||(t={}),t.excludes||(t.excludes={}),t.excludes instanceof Array){var n={};t.excludes.forEach(function(t){u(t,"/")?n[t]=1:n[e+t]=1}),t.excludes=n}return t},o.isDir=function(){return!0},o.rel=function(e){var n=f(e),r=o.path();return r=r.replace(/\/$/,""),n.forEach(function(e){".."==e||"../"==e?r=w(r):(r=r.replace(/\/$/,""),r+=j+("."==e||"./"==e?"":e))}),D.get(r,t)},o.rm=function(){if(!o.exists())throw new Error(e+": No such dir.");var t=o.ls();if(t.length>0)throw new Error(e+": Directory not empty");if(null!=r){var n=o.mediaType(),a=v(r,n);b(a,r,i,n)}},o.removeWithoutTrash=function(){var t=o.mediaType();if(o.each(function(e){e.removeWithoutTrash()},{includeTrashed:!0}),d(e,null),null!=r){var n=v(r,t);x(n,r,i,t)}},o.mkdir=function(){o.touch()},o.text=function(){return d(e)},o.obj=function(){return JSON.parse(o.text())},o.exists=function(){if("/"==e)return!0;var t=v(r,L);return t&&t[i]&&!t[i].trashed},o.mediaType=function(){return P[e]&&!localStorage[e]?k:M}}else{var a=n={};a.isDir=function(){return!1},a.rm=function(){if(!a.exists())throw new Error(e+": No such file.");if(d(e,null),null!=r){var t=a.mediaType(),n=v(r,t);b(n,r,i,t)}},a.removeWithoutTrash=function(){if(!a.exists()&&!a.isTrashed())throw new Error(e+": No such file.");if(d(e,null),null!=r){var t=a.mediaType(),n=v(r,t);x(n,r,i,t)}},a.text=function(){return 0==arguments.length?d(e):(d(e,arguments[0]),void a.touch())},a.lines=function(){return a.text().split("\n")},a.obj=function(){if(0==arguments.length){var e=a.text();return e?JSON.parse(e):null}a.text(JSON.stringify(arguments[0]))},a.copyFrom=function(e,t){a.text(e.text()),t.a&&a.metaInfo(e.metaInfo())},a.exists=function(){return h(e)},a.useRAMDisk=function(){return"ALL"==A?a:(A=A||{},A[e]=!0,a)},a.mediaType=function(){return g(e)?k:M}}return n.relPath=function(t){var r=t.path?t.path():t;if(r.substring(r.length-1)!=j)throw new Error(r+" is not a directory.");return e.substring(0,r.length)!=r?"../"+n.relPath(t.up()):e.substring(r.length)},n.isTrashed=function(){var e=n.metaInfo();return e?e.trashed:!1},n.metaInfo=function(){if(null!=r){var e;if(0==arguments.length)return e=v(r,L),e[i];var t=n.mediaType();e=v(r,t),e[i]=arguments[0],m(r,e,e[i].trashed,t)}return{}},n.lastUpdate=function(){return n.metaInfo().lastUpdate},n.up=function(){return null==r?null:D.get(r,t)},n.path=function(){return e},n.name=function(){return i},n.truncExt=function(e){return i.substring(0,i.length-e.length)},n.touch=function(){if(null!=r){var e=n.mediaType(),t=v(r,e);y(t,r,i,!1,e)}},n.isReadOnly=function(){var t=l(e);return!!t},n.startsWith=function(e){return u(i,e)},n.endsWith=function(e){return s(i,e)},n.equals=function(t){return t&&"function"==typeof t.path&&t.path()==e},n.toString=function(){return e},n.isSFile=function(){return!0},n},D.scan=function(){for(var e in localStorage)if(T(e)){var t=w(e);if(null!=t){var n=v(t,M),r=E(e);y(n,t,r,n[r]&&n[r].trashed,M)}}},D.dump=function(){for(var e in localStorage)console.log(e)},D.ls=function(e){return D.get(e).ls()},D}),requireSimulator.setName("FileList"),requireSimulator.setName("exceptionCatcher"),define([],function(){var e={};return e.f=function(t){if("function"==typeof t){if(t.isTrcf)return t;var n=function(){if(!e.handleException||e.enter)return t.apply(this,arguments);try{return e.enter=!0,t.apply(this,arguments)}catch(n){e.handleException(n)}finally{e.enter=!1}};return n.isTrcf=!0,n}if("object"==typeof t){for(var r in t)t[r]=e.f(t[r]);return t}},e}),requireSimulator.setName("UI"),define(["Util","exceptionCatcher"],function(e,t){var n={},r=t.f;return n=function(){function t(){f.forEach(function(e){e()}),setTimeout(r(t),10)}function i(e){return e instanceof Array?o(e):"string"==typeof e?s(e):e}function o(e){var t=e[0],n=1,r=$("<"+t+">");for("object"!=typeof e[n]||e[n]instanceof Array||e[n]instanceof $||(a(r,e[n],t),n++);n<e.length;)r.append(i(e[n])),n++;return r}function a(t,i){function o(e,n){if(n)if("enterkey"==e)t.on("keypress",r(function(e){13==e.which&&n.apply(t,arguments)}));else if("realtimechange"==e){var o,a=!0;f.push(function(){var e;e="checkbox"==i.type?!!t.prop("checked"):t.val(),(a||o!=e)&&(n.apply(t,[e,o]),o=e),a=!1})}else t.on(e,r(n))}i.$var&&(l[i.$var]=t),i.$edit&&("string"==typeof i.$edit&&(i.$edit={name:i.$edit,type:n.types.String}),i.on||(i.on={}),i.on.realtimechange=r(function(e){p.writeToModel(i.$edit,e,t)}),l[i.$edit.name]||(l[i.$edit.name]=t),p.push({jq:t,params:i}));for(var a in i)if("on"==a)for(var s in i.on)o(s,i.on[s]);else"css"==a&&null!=i[a]?t.css(i[a]):e.startsWith(a,"$")||null==i[a]||t.attr(a,i[a])}function s(e){return $("<span>").text(e)}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var f=[],l={},p=[],d=i(u);return d.$edits=p,d.$vars=l,p.load=function(e){p.model=e,p.forEach(function(e){p.writeToJq(e.params.$edit,e.jq)})},p.writeToJq=function(e,t){var n=p.model;if(n){for(var r=e.name,i=r.split("."),o=0;o<i.length;o++)n=n[i[o]];n=e.type.toVal(n),"checkbox"==t.attr("type")?t.prop("checked",!!n):t.val(n)}},p.validator={errors:{},show:function(){if(l.validationMessage){l.validationMessage.empty();for(var e in this.errors)l.validationMessage.append(n("div",this.errors[e].mesg))}if(l.OKButton){var t=!0;for(var e in this.errors)t=!1;l.OKButton.attr("disabled",!t)}},on:{validate:function(){}},addError:function(e,t,n){this.errors[e]={mesg:t,jq:n},this.show()},removeError:function(e){delete this.errors[e],this.show()},allOK:function(){for(var e in this.errors)delete this.errors[e];this.show()},isValid:function(){var e=!0;for(var t in this.errors)e=!1;return e}},p.writeToModel=function(e,t,n){var r=p.model;if(r){var i=e.name;try{t=e.type.fromVal(t)}catch(o){return void p.validator.addError(i,o,n)}p.validator.removeError(i);for(var a=i.split("."),s=0;s<a.length;s++)s==a.length-1?p.on.writeToModel(i,t)||(r[a[s]]=t):r=r[a[s]];p.validator.on.validate.call(p.validator,p.model)}},p.on={},p.on.writeToModel=function(){},f.length>0&&setTimeout(r(t),10),d},n.types={String:{toVal:function(e){return e},fromVal:function(e){return e}},Number:{toVal:function(e){return e+""},fromVal:function(e){return parseFloat(e)}}},n}),requireSimulator.setName("FileMenu"),define(["UI","FS"],function(e){var t=function(){var t={on:{}};return t.on.validateName=function(e){if(!e)return{ok:!1,reason:"ファイル名を入力してください"};var n=t.on.getCurDir(),r=n.rel(e);return{ok:!0,file:r}},t.on.displayName=function(e){return e.name()},t.on.close=function(){},t.on.open=function(e){"object"==typeof t.fileList&&t.fileList.select(e)},t.on.ls=function(){"object"==typeof t.fileList&&t.fileList.ls()},t.on.getCurFile=function(){if("object"==typeof t.fileList)return t.fileList.curFile();throw"on.getCurFile is missing"},t.on.getCurDir=function(){if("object"==typeof t.fileList)return t.fileList.curDir();throw"on.getCurDir is missing"},t.on.createContent=function(e){return e.text("")},t.onMenuStart=function(){},t.dialog=function(e,n,r){return t.dialogOpt({title:e,name:n,onend:r})},t.dialogOpt=function(n){var r=n.title,i=n.name||"",o=n.onend||function(){};t.d||(t.d=e(["div"],{title:r},"ファイル名を入力してください",["br"],["input",{$var:"name",on:{enterkey:function(){t.d.$vars.done()},realtimechange:function(e){t.d.$vars.chg(e)}}}],["br"],["div",{$var:"extra"}],["div",{$var:"msg"}],["button",{$var:"b",on:{click:function(){t.d.$vars.done()}}},"OK"])),t.d.attr({title:r});var a=t.d.$vars;a.name.val(i),t.d.dialog({title:r});var s=null;a.done=function(){s&&s.ok&&(o(s.file),t.d.dialog("close"))},a.chg=function(e){s=t.on.validateName(e,n),s.ok&&s.file.exists()&&(s={ok:!1,reason:e+"は存在します"}),s.ok?(a.msg.css({color:"blue"}),a.msg.text(s.note||""),a.b.removeAttr("disabled")):(a.msg.css({color:"red"}),a.msg.text(s.reason),a.b.attr("disabled",!0))},a.extra.empty(),n.extraUI&&n.extraUI(a.extra)},t.create=function(){t.onMenuStart("create"),t.dialogOpt({title:"新規作成",action:"create",onend:function(e){e.exists()||(t.on.createContent(e),t.on.ls(),t.on.open(e))}})},t.mv=function(){t.onMenuStart("mv");var e=t.on.getCurFile();if(e){var n=t.on.displayName(e);t.dialogOpt({title:"名前変更",name:n,action:"mv",extraUI:t.on.mvExtraUI,onend:function(n){if(n&&(!t.on.mv||t.on.mv(e,n)!==!1)){var r=e.text();e.rm(),t.on.close(e),e=n,n.text(r),t.on.ls(),t.on.open(e)}}})}},t.rm=function(){t.onMenuStart("rm");var e=t.on.getCurFile();e&&confirm(e.name()+"を削除しますか？")&&(e.rm(),t.on.ls(),t.on.close(e))},t};return t}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite"],function(e,t,n){function r(e,t){var n=i(e);if(t&&!n.exists())throw n+": no such file or directory";return n}function i(n){if("string"!=typeof n)return n;if(t.startsWith(n,"/"))return e.get(n);var r=o.cwd;return r.rel(n)}var o={cwd:e.get("/")};return o.cd=function(e){return o.cwd=r(e,!0),o.pwd()},o.resolve=r,o.pwd=function(){return o.cwd+""},o.ls=function(e){return e=e?r(e,!0):o.cwd,e.ls()},o.cp=function(e,t,n){n||(n={}),n.v&&o.echo("cp",e,t);var i=r(e,!0),a=r(t);if(i.isDir()&&a.isDir()){var s=0;return i.recursive(function(e){var t=e.relPath(i),r=a.rel(t);(n.test||n.v)&&o.echo((r.exists()?"[ovr]":"[new]")+r+"<-"+e),n.test||r.copyFrom(e,n),s++}),s}if(i.isDir()||a.isDir()){if(!i.isDir()&&a.isDir())return a.rel(i.name()).text(i.text()),1;throw"Cannot copy directory "+i+" to file "+a}return a.text(i.text()),1},o.rm=function(e,t){if(t||(t={}),t.notrash)return e=r(e,!1),e.removeWithoutTrash(),1;if(e=r(e,!0),e.isDir()&&t.r){var n=e,i=0;return n.each(function(e){e.exists()&&(i+=o.rm(e,t))}),n.rm(),i+1}return e.rm(),1},o.cat=function(e){e=r(e,!0),o.echo(e.text())},o.resolve=function(e){return e||(e="."),e=r(e)},o.grep=function(e,t,n){function i(e,t,r){n.res&&n.res.push({file:e,lineNo:t,line:r}),o.echo(e+"("+t+"): "+r)}return t=r(t,!0),n||(n={}),n.res||(n.res=[]),t.isDir()?t.each(function(t){o.grep(e,t,n)}):"string"==typeof e&&t.lines().forEach(function(n,r){n.indexOf(e)>=0&&i(t,r+1,n)}),n.res},o.touch=function(e){return e=r(e),e.text(e.exists()?e.text():""),1},o.setout=function(e){o.outUI=e},o.echo=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.log&&o.outUI.log.apply(o.outUI,arguments)},o.err=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.err&&o.outUI.err.apply(o.outUI,arguments)},o.prompt=function(){},o.ASYNC={r:"SH_ASYNC"},o.help=function(){for(var e in o){var t=o[e];"function"==typeof t&&o.echo(e+(t.description?" - "+t.description:""))}},sh=o,n.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),o}),requireSimulator.setName("Log"),define(["FS","WebSite","Shell"],function(e,t,n){function r(e,t){return e="00000000000000"+e,e.substring(e.length-t)}function i(e){return e.replace(/\n/g,"\n|")}var o={},a=t.logdir?e.resolve("${logdir}"):null,s=a&&a.exists();if(o.todayDir=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return a.rel(t+"/").rel(n+"/").rel(r+"/")},o.curFile=function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,r=e.getDate();return o.todayDir().rel(t+"-"+n+"-"+r+".log")},o.curProject=function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),i=e.getSeconds();return o.todayDir().rel("Project/").rel(r(t,2)+"_"+r(n,2)+"_"+r(i,2)+"/")},o.dumpProject=function(e){if(s){var t=o.curProject();n.cp(e,t),o.append("Dumped project to "+t.path())}},!t.logging&&!t.isNW){var u=e.get("/var/log/");u.exists()&&u.removeWithoutTrash()}return o.append=function(e){if(s){var t=o.curFile(),n=t.exists()?t.text():"";t.text(n+e+"\n")}},o.d=function(e,t){o.append(new Date+": ["+e+"]"+i(t))},o.e=function(e,t){o.append(new Date+": ERROR["+e+"]"+i(t))},o}),requireSimulator.setName("showErrorPos"),define(["Log","FS"],function(e,t){return function(n,r){function i(){n.empty()}var o,a,s;if(!r)return void i();var u,c;r.isTError?(o=r.mesg,a=r.src,s=r.pos,u=r.row+1,c=r.col+1):(a={name:function(){return"不明"},text:function(){return null}},s=0,o=r),"object"==typeof s&&(u=s.row,c=s.col),i();var f=$("<div>").text(o+" 場所："+a.name()+("number"==typeof u?":"+u+":"+c:""));n.append(f),n.append($("<div>").attr("class","quickFix")),console.log("src=",a);var l=a.text();if(l&&"object"==typeof s){for(var p=0,d=l.split(/\n/),h=0;h<d.length&&h+1<s.row;h++)p+=d[h].length;p+=s.col,s=p}var m=$("<pre>");m.append($("<span>").text(l.substring(0,s))),m.append($("<img>").attr("src",t.expandPath("${sampleImg}/ecl.png"))),m.append($("<span>").text(l.substring(s))),n.append(m),n.attr("title","エラー");var g=n.dialog({width:600,height:400});return e.d("error",o+"\nat "+a+":"+r.pos+"\n"+l.substring(0,r.pos)+"!!HERE!!"+l.substring(r.pos)),g}}),requireSimulator.setName("IndentBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return IndentBuffer=function(){var e=function(){function t(){i++;var e=n[i];if(null==e)throw console.log(n),new Error(i+"th null param: fmt="+r);return e}for(var n=arguments,r=n[0],i=0;;){var o=r.indexOf("%");if(0>o){e.buf+=r;break}e.buf+=r.substring(0,o),o++;var a=r.charAt(o);if("s"==a){var s=t();"string"==typeof s||"number"==typeof s||(null==s?s="null":s.text&&(s=s.text)),e.buf+=s,o++}else if("d"==a){var u=t();if("number"!=typeof u)throw new Error(u+" is not a number: fmt="+r);e.buf+=u,o++}else if("n"==a)e.ln(),o++;else if("{"==a)e.indent(),o++;else if("}"==a)e.dedent(),o++;else if("%"==a)e.buf+="%";else if("f"==a)t()(e),o++;else if("l"==a){var c=t();e.buf+=e.toLiteral(c),o++}else if("v"==a){var f=t();if(!f)throw new Error("Null %v");if("object"!=typeof f)throw new Error("nonobject %v:"+f);e.visitor.visit(f),o++}else if("z"==a){var l=t();if("val"in l)return void(e.buf+=l.val);l.gen||e.lazy(l),e.buf+=l.gen,o++}else if("j"==a){var p=t(),d=p[0],h=p[1],m=!1;if(!h||!h.forEach)throw console.log(h),new Error(h+" is not array. cannot join fmt:"+r);h.forEach(function(t){m&&e.printf(d),m=!0,e.visitor.visit(t)}),o++}else"D"==a?(t(),o++):o+=2;r=r.substring(o)}};return e.print=function(t){e.buf+=t},e.printf=e,e.buf="",e.lazy=function(t){return t||(t={}),t.gen=("GENERETID"+Math.random()+"DITERENEG").replace(/\W/g,""),t.reg=new RegExp(t.gen,"g"),t.put=function(t){return this.val=t,e.buf=e.buf.replace(this.reg,t),t},t},e.ln=function(){e.buf+="\n"+e.indentBuf},e.indent=function(){e.indentBuf+=e.indentStr,e.buf+="\n"+e.indentBuf},e.dedent=function(){var t=e.indentStr.length;if(!e.buf.substring(e.buf.length-t).match(/^\s*$/))throw console.log(e.buf),new Error("Non-space truncated ");e.buf=e.buf.substring(0,e.buf.length-t),e.indentBuf=e.indentBuf.substring(0,e.indentBuf.length-t)},e.toLiteral=function(e,t){return t||(t="'"),e=e.replace(/\\/g,"\\\\"),e=e.replace(/\r/g,"\\r"),e=e.replace(/\n/g,"\\n"),e="'"==t?e.replace(/'/g,"\\'"):e.replace(/"/g,'\\"'),t+e+t},e.indentBuf="",e.indentStr="  ",e}}),requireSimulator.setName("disp"),"function"!=typeof define&&(define=require("requirejs").define),define(["IndentBuffer"],function(e){return disp=function(t){function n(e){if(null==e)return r("null%n");if("string"==typeof e)return r("'%s'%n",e);if("number"==typeof e)return r("%s%n",e);if("function"==typeof e)return r("func%n");r(e instanceof Array?"[%{":"{%{");var t="";for(var i in e)r(t+i+":"),n(e[i]);r(e instanceof Array?"%}]%n":"%}}%n")}var r=e();return n(t),r.buf}}),requireSimulator.setName("Parser"),"function"!=typeof define&&(define=require("requirejs").define),define(["disp"],function(){return Parser=function(){function e(e,t){var n;for(n in t)e[n]=t[n];return e}function t(e){this.parse=i.options.traceTap?function(t){console.log("tap: name="+this.name+"  pos="+(t?t.pos:"?"));var n=e.apply(this,[t]),r="NOIMG";return n.src&&n.src.str&&(r=n.src.str.substring(n.pos-3,n.pos)+"^"+n.src.str.substring(n.pos,n.pos+3)),n.src&&n.src.tokens&&(r=n.src.tokens[n.pos-1]+"["+n.src.tokens[n.pos]+"]"+n.src.tokens[n.pos+1]),console.log("/tap: name="+this.name+" pos="+(t?t.pos:"?")+"->"+(n?n.pos:"?")+" "+r+" res="+(n?n.success:"?")),n}:e}function n(e,t){if(null==e)throw t+" is null!";return e}function r(e,t){null!=e&&(this.src={maxPos:0,global:t},"string"==typeof e&&(this.src.str=e),e instanceof Array&&(this.src.tokens=e),this.pos=0,this.result=[],this.success=!0)}var i={consoleBuffer:"",options:{traceTap:!1,optimizeFirst:!0,profile:!1,verboseFirst:!1,traceFirstTbl:!1},Parser:t,StringParser:o,nc:n};i.dispTbl=function(e){var t="",n={};if(!e)return t;for(var r in e){var i=e[r].name;n[i]||(n[i]=""),n[i]+=r}for(var i in n)t+=n[i]+"->"+i+",";return t},t.create=function(e){return new t(e)},i.create=t.create,e(t.prototype,{except:function(e){var n=this;return this.ret(t.create(function(t){return e.apply({},t.result)&&(t.success=!1),t}).setName("(except "+n.name+")"))},noFollow:function(e){var r=this;return n(e,"p"),this.ret(t.create(function(t){var n=e.parse(t);return t.success=!n.success,t}).setName("("+r.name+" noFollow "+e.name+")"))},andNoUnify:function(e){n(e,"next");var r=this,i=t.create(function(t){var n=r.parse(t);if(!n.success)return n;var i=e.parse(n);return i.success&&(i.result=n.result.concat(i.result)),i});return i.setName("("+this.name+" "+e.name+")")},and:function(e){var n=this.andNoUnify(e);if(!this._first)return n;var r=this._first.tbl,o={};for(var a in r)o[a]=r[a].andNoUnify(e);return n=t.fromFirst(this._first.space,o),n.setName("("+this.name+" >> "+e.name+")"),i.options.verboseFirst&&console.log("Created aunify name="+n.name+" tbl="+i.dispTbl(o)),n},retNoUnify:function(e){var n,r=this;n="function"==typeof e?t.create(function(t){var n=t.clone();return n.result=[e.apply({},t.result)],n}).setName("retfunc"):e;var i=t.create(function(e){var t=r.parse(e);return t.success?n.parse(t):t}).setName("("+this.name+" >= "+n.name+")");return i},ret:function(e){if(!this._first)return this.retNoUnify(e);var n=this._first.tbl,r={};for(var o in n)r[o]=n[o].retNoUnify(e);return res=t.fromFirst(this._first.space,r),res.setName("("+this.name+" >>= "+e.name+")"),i.options.verboseFirst&&console.log("Created runify name="+res.name+" tbl="+i.dispTbl(r)),res},first:function(e,n){if(!i.options.optimizeFirst)return this;if(null==e)throw"Space is null2!";if("string"==typeof n){for(var r={},o=0;o<n.length;o++)r[n.substring(o,o+1)]=this;return t.fromFirst(e,r).setName("(fst "+this.name+")")}if(null==n)return t.fromFirst(e,{ALL:this}).setName("(fst "+this.name+")");if("object"==typeof n)throw"this._first={space: space, tbl:ct}";return this},firstTokens:function(e){if(!i.options.optimizeFirst)return this;"string"==typeof e&&(e=[e]);var n={};if(e){var r=this;e.forEach(function(e){n[e]=r})}else n.ALL=this;return t.fromFirstTokens(n).setName("(fstT "+this.name+")")},unifyFirst:function(n){function r(e,t){return e?t?e.orNoUnify(t).checkTbl():e:t}function o(){var e=n._first.tbl,t={};for(var i in a)t[i]=1;for(var i in e)t[i]=1;delete t.ALL,(a.ALL||e.ALL)&&(a.ALL=r(a.ALL,e.ALL));for(var i in t)a[i]&&e[i]?a[i]=r(a[i],e[i]):a[i]&&!e[i]?a[i]=r(a[i],e.ALL):!a[i]&&e[i]&&(a[i]=r(a.ALL,e[i]))}var a={};this.checkTbl(),n.checkTbl(),e(a,this._first.tbl),o();var s=t.fromFirst(this._first.space,a).setName("("+this.name+")U("+n.name+")");return i.options.verboseFirst&&console.log("Created unify name="+s.name+" tbl="+i.dispTbl(a)),s},or:function(e){return n(e,"other"),this._first&&e._first&&this._first.space&&this._first.space===e._first.space?this.unifyFirst(e):(i.options.verboseFirst&&console.log("Cannot unify"+this.name+" || "+e.name+" "+this._first+" - "+e._first),this.orNoUnify(e))},orNoUnify:function(e){var n=this,r=t.create(function(t){var r=n.parse(t);if(r.success)return r;var i=e.parse(t);return i});return r.name="("+this.name+")|("+e.name+")",r},setName:function(e){return this.name=e,this._first,this},profile:function(e){return i.options.profile&&(this.parse=this.parse.profile(e||this.name)),this},repN:function(e){var n=this;e||(e=0);var r=t.create(function(t){for(var r=t,i=[];;){var o=n.parse(r);if(!o.success){var a;return i.length>=e?(a=r.clone(),a.result=[i],a.success=!0,a):(a=t.clone(),a.success=!1,a)}i.push(o.result[0]),r=o}});return r.setName("("+n.name+" * "+e+")")},rep0:function(){return this.repN(0)},rep1:function(){return this.repN(1)},opt:function(){var e=this;return t.create(function(t){var n=e.parse(t);return n.success?n:(t=t.clone(),t.success=!0,t.result=[null],t)}).setName("("+e.name+")?")},sep1:function(e,t){var r=this;n(r,"value"),n(e,"sep");var i=e.and(r).ret(function(e,n){return t?n:{sep:e,value:n}});return r.and(i.rep0()).ret(function(e,n){var r;if(t){var i=[e];for(r in n)i.push(n[r]);return i}return{head:e,tails:n}}).setName("(sep1 "+r.name+"~~"+e.name+")")},sep0:function(e){return this.sep1(e,!0).opt().ret(function(e){return e?e:[]})},tap:function(e){return this},retN:function(e){return this.ret(function(){return arguments[e]})},parseStr:function(e,t){var n=new r(e,t);return this.parse(n)},checkTbl:function(){if(!this._first)return this;var e=this._first.tbl;for(var t in e)if(!e[t].parse)throw this.name+": tbl."+t+" is not a parser :"+e[t];return this}}),e(r.prototype,{clone:function(){var e=new r;return e.src=this.src,e.pos=this.pos,e.result=this.result.slice(),e.success=this.success,e},updateMaxPos:function(e){e>this.src.maxPos&&(this.src.maxPos=e)},isSuccess:function(){return this.success},getGlobal:function(){return this.src.global||(this.src.global={}),this.src.global}}),t.fromFirst=function(e,n){if("TOKEN"==e)return t.fromFirstTokens(n);var r=t.create(function(t){var r=e.parse(t),o=r.src.str.substring(r.pos,r.pos+1);return i.options.traceFirstTbl&&console.log(this.name+": first="+o+" tbl="+(n[o]?n[o].name:"-")),n[o]?n[o].parse(r):n.ALL?n.ALL.parse(r):(r.success=!1,r)});return r._first={space:e,tbl:n},r.checkTbl(),r},t.fromFirstTokens=function(e){var n=t.create(function(t){var n=t.src.tokens[t.pos],r=n?n.type:null;return i.options.traceFirstTbl&&console.log(this.name+": firstT="+r+" tbl="+(e[r]?e[r].name:"-")),null!=r&&e[r]?e[r].parse(t):e.ALL?e.ALL.parse(t):(t.success=!1,t)});return n._first={space:"TOKEN",tbl:e},n.checkTbl(),n};var o={empty:t.create(function(e){var t=e.clone();return t.success=!0,t.result=[null],t}).setName("E"),fail:t.create(function(e){return e.success=!1,e}).setName("F"),str:function(e){return this.strLike(function(t,n){return t.substring(n,n+e.length)===e?{len:e.length}:null}).setName(e)},reg:function(e){return(e+"").match(/^\/\^/)||console.log("Waring regex should have ^ at the head:"+(e+"")),this.strLike(function(t,n){var r=e.exec(t.substring(n));return r?(r.len=r[0].length,r):null}).setName(e+"")},strLike:function(n){return t.create(function(t){var r=t.src.str;if(null==r)throw"strLike: str is null!";var o=t.pos,a=n(r,o,t);if(i.options.traceToken&&console.log("pos="+o+" r="+a),a){i.options.traceToken&&console.log("str:succ"),a.pos=o,a.src=t.src;var s=t.clone();return e(s,{pos:o+a.len,success:!0,result:[a]}),t.updateMaxPos(s.pos),s}return i.options.traceToken&&console.log("str:fail"),t.success=!1,t}).setName("STRLIKE")},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)}};o.eof=o.strLike(function(e,t){return t==e.length?{len:0}:null}).setName("EOF"),i.StringParser=o;var a={token:function(e){return t.create(function(t){var n=t.src.tokens[t.pos];return t.success=!1,n?(n.type==e&&(t=t.clone(),t.updateMaxPos(t.pos),t.pos++,t.success=!0,t.result=[n]),t):t}).setName(e).firstTokens(e)},parse:function(e,t,n){var i=new r(t,n);return e.parse(i)},eof:t.create(function(e){var t=e.pos>=e.src.tokens.length;return e.success=t,t&&(e=e.clone(),e.result=[{type:"EOF"}]),e}).setName("EOT")};return i.TokensParser=a,i.lazy=function(e){var n=null;return t.create(function(t){if(n||(n=e()),!n)throw e+" returned null!";return this.name=e.name,n.parse(t)}).setName("LZ")},i.addRange=function(e,t){if(null==t)return e;if("number"!=typeof e.pos)return e.pos=t.pos,e.len=t.len,e;var n=t.pos+t.len,r=e.pos+e.len;return t.pos<e.pos&&(e.pos=t.pos),n>r&&(e.len=n-e.pos),e},i.setRange=function(e){if(null!=e&&"string"!=typeof e&&"number"!=typeof e&&"boolean"!=typeof e){var t=i.getRange(e);if(null!=t)return e;for(var n in e)if(e.hasOwnProperty(n)){var r=i.setRange(e[n]);i.addRange(e,r)}return e}},i.getRange=function(e){return null==e?null:"number"!=typeof e.pos?null:"number"==typeof e.len?e:null},i}()}),requireSimulator.setName("Grammar"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return Grammar=function(){function t(e){return"string"==typeof e?r.get(e):e}var n=e,r=null;return r=function(n){var i={};return i.ands=function(){for(var i=t(arguments[0]),o=1;o<arguments.length;o++)i=i.and(t(arguments[o]));i=i.tap(n),r.defs[n]=i;var a={};return a.autoNode=function(){var t=i.ret(function(){for(var t={type:n},r=0;r<arguments.length;r++){var i=arguments[r],o=e.setRange(i);e.addRange(t,o),t["-element"+r]=i}t.toString=function(){return"("+this.type+")"}}).setName(n);return r.defs[n]=t},a.ret=function(t){if(0==arguments.length)return i;if("function"==typeof t)return r.defs[n]=i.ret(t);for(var o=[],a=function(e){return e},s=0;s<arguments.length;s++){if("function"==typeof arguments[s]){a=arguments[s];break}o[s]=arguments[s]}var u=i.ret(function(){var t={type:n};t[Grammar.SUBELEMENTS]=[];for(var r=0;r<arguments.length;r++){var i=arguments[r],s=e.setRange(i);e.addRange(t,s),o[r]&&(t[o[r]]=i),t[Grammar.SUBELEMENTS].push(i)}return t.toString=function(){return"("+this.type+")"},a(t)}).setName(n);return r.defs[n]=u},a},i.ors=function(){for(var e=t(arguments[0]),i=1;i<arguments.length;i++)e=e.or(t(arguments[i]));return r.defs[n]=e.setName(n)},i},r.defs={},r.get=function(e){return r.defs[e]?r.defs[e]:n.lazy(function(){var t=r.defs[e];if(!t)throw"grammar named '"+e+"' is undefined";return t}).setName("(Lazy of "+e+")")},r},Grammar.SUBELEMENTS="[SUBELEMENTS]",Grammar}),requireSimulator.setName("XMLBuffer"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return XMLBuffer=function(t){var n;
return n=function(r,i){if(null!=r&&"string"!=typeof r&&"number"!=typeof r){var o=e.getRange(r);if(o)for(;n.srcLen<o.pos;)n.src(t.substring(n.srcLen,o.pos));if(null!=r){if(i&&n.tag("<attr_"+i+">"),r.type&&n.tag("<"+r.type+">"),r.text)n.src(o.text);else{var a=n.orderByPos(r);a.forEach(function(e){e.name&&e.name.match(/^-/)?n(e.value):n(e.value,e.name)})}if(o)for(;n.srcLen<o.pos+o.len;)n.src(t.substring(n.srcLen,o.pos+o.len));r.type&&n.tag("</"+r.type+">"),i&&n.tag("</attr_"+i+">")}}},n.orderByPos=XMLBuffer.orderByPos,n.src=function(e){n.buf+=e.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;"),n.srcLen+=e.length},n.tag=function(e){n.buf+=e},n.buf="",n.srcLen=0,n},XMLBuffer.orderByPos=function(e){var t=[];if(e[XMLBuffer.SUBELEMENTS])e[XMLBuffer.SUBELEMENTS].forEach(function(e){t.push(e)});else for(var n in e)e.hasOwnProperty(n)&&null!=e[n]&&"string"!=typeof e[n]&&"number"!=typeof e[n]&&"number"==typeof e[n].pos&&t.push(isNaN(parseInt(n))&&!(n+"").match(/-/)?{name:n,value:e[n]}:{value:e[n]});return t=t.sort(function(e,t){return e.value.pos-t.value.pos})},XMLBuffer.SUBELEMENTS="[SUBELEMENTS]",XMLBuffer}),requireSimulator.setName("TError"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return TError=function(e,t,n){if("string"==typeof t)return{isTError:!0,mesg:e,src:{name:function(){return t},text:function(){return t}},pos:n,toString:function(){return this.mesg+" at "+t+":"+this.pos},raise:function(){throw this}};var r=null;if(t&&t.src&&(r=t,t=r.src.tonyu),"function"!=typeof t.name)throw"src="+t+" should be file object";var i;if("function"==typeof t.text){var o=t.text();"string"==typeof o&&(i=TError.calcRowCol(o,n))}return{isTError:!0,mesg:e,src:t,pos:n,row:i.row,col:i.col,klass:r,toString:function(){return this.mesg+" at "+this.src.name()+":"+this.row+":"+this.col},raise:function(){throw this}}},TError.calcRowCol=function(e,t){var n,r,i=e.split("\n"),o=0;for(n=0;n<i.length;n++)if(o+=i[n].length+1,o>t){r=t-(o-i[n].length);break}return{row:n,col:r}},TError}),requireSimulator.setName("TT"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","disp","Parser","TError"],function(e,t,n,r,i){return TT=function(){function e(e,t){var n,i;"string"==typeof e?(n=s.str(e),e.length>0&&(i=e.substring(0,1)),t||(t=e)):(n=s.reg(e),t||(t=e+""));var o=l.and(n).ret(function(e,n){var i={};if(i.pos=n.pos,"number"!=typeof i.pos)throw"no pos for "+t+" "+r(n);if(i.len=n.len,i.text=n.src.str.substring(i.pos,i.pos+i.len),"string"!=typeof i.text)throw"no text("+i.text+") for "+t+" "+r(n);return i.toString=function(){return this.text},i});return i&&(o=o.first(l,i)),o.setName(t)}function t(t,n,r){"string"==typeof r&&(r=e(r)),p[t]=o(p[t],r.ret(function(e){return e.type=n,e}).setName(n))}function n(e,n,r,i){n==u&&(n=r);for(var o=1;e>=o;o*=2)0!=(e&o)&&t(e&o,n,r,i);d[n]=i}function o(e,t){return e?e.or(t):t}function a(e){var t=((new Date).getTime(),i.StringParser.parse(h,e));return t.success||console.log("Stopped at "+e.substring(t.src.maxPos-5,t.src.maxPos+5)),t}var s=i.StringParser,u="SAMENAME",c=1,f=2,l=s.reg(/^(\s*(\/\*([^\/]|[^*]\/|\r|\n)*\*\/)*(\/\/.*\r?\n)*)*/).setName("space"),p={},d={},h=i.create(function(e){for(var t=f,n=[];;){if(e=p[t].parse(e),!e.success)break;var r=e.result[0];t=d[r.type],n.push(r)}return e=l.parse(e),e.success=e.src.maxPos==e.src.str.length,e.result[0]=n,e}),m={"function":!0,"var":!0,"return":!0,"typeof":!0,"if":!0,"for":!0,"else":!0,"super":!0,"while":!0,"break":!0,"do":!0,"switch":!0,"try":!0,"catch":!0,"finally":!0,"throw":!0,"in":!0,fiber:!0,"native":!0,"instanceof":!0,"new":!0,is:!0,"true":!0,"false":!0,"null":!0,"this":!0,undefined:!0,usethread:!0,constructor:!0,ifwait:!0,nowait:!0,_thread:!0,arguments:!0,"delete":!0,"extends":!0,includes:!0},g=e(/^[0-9\.]+/).ret(function(e){return e.type="number",e.value=parseInt(e.text),e}).first(l,"0123456789"),v=e({exec:function(e){var t=e.substring(0,1);if('"'!==t&&"'"!==t)return!1;for(var n=1;n<e.length;n++){var r=e.substring(n,n+1);if(r===t)return[e.substring(0,n+1)];"\\"===r&&n++}return!1},toString:function(){return"literal"}}).first(l,"\"'"),y=e({exec:function(e){if("/"!==e.substring(0,1))return!1;for(var t=1;t<e.length;t++){var n=e.substring(t,t+1);if("/"===n){var r=/^[ig]*/.exec(e.substring(t+1));return[e.substring(0,t+1+r[0].length)]}if("\n"==n)return!1;"\\"===n&&t++}return!1},toString:function(){return"regex"}}).first(l,"/");n(f|c,"number",g,c),n(f,"regex",y,c),n(f|c,"literal",v,c),n(f|c,u,"++",c),n(f|c,u,"--",c),n(f|c,u,"!==",f),n(f|c,u,"===",f),n(f|c,u,"+=",f),n(f|c,u,"-=",f),n(f|c,u,"*=",f),n(f|c,u,"/=",f),n(f|c,u,"%=",f),n(f|c,u,">=",f),n(f|c,u,"<=",f),n(f|c,u,"!=",f),n(f|c,u,"==",f),n(f|c,u,">>",f),n(f|c,u,"<<",f),n(f|c,u,"&&",f),n(f|c,u,"||",f),n(f|c,u,"(",f),n(f|c,u,")",c),n(f|c,u,"[",f),n(f|c,u,"]",c),n(f|c,u,"{",f),n(f|c,u,"}",c),n(f|c,u,">",f),n(f|c,u,"<",f),n(f|c,u,"+",f),n(f|c,u,"-",f),n(f|c,u,".",f),n(f|c,u,"?",f),n(f|c,u,"=",f),n(f|c,u,"*",f),n(f|c,u,"%",f),n(c,u,"/",f),n(c|f,u,"^",f),n(c|f,u,"~",f),n(c|f,u,"\\",f),n(c|f,u,":",f),n(c|f,u,";",f),n(c|f,u,",",f),n(f|c,u,"!",f),n(f|c,u,"&",f),n(f|c,u,"|",f);var b=e(/^[a-zA-Z_$][a-zA-Z0-9_$]*/,"symresv_reg").ret(function(e){return e.type="constructor"==e.text?"tk_constructor":m.hasOwnProperty(e.text)?e.text:"symbol",e}).first(l);for(var x in m)d[x]=f;return d.tk_constructor=f,d.symbol=c,p[f]=o(p[f],b),p[c]=o(p[c],b),{parse:a,extension:"js"}}()}),requireSimulator.setName("ExpressionParser"),"function"!=typeof define&&(define=require("requirejs").define),define(["Parser"],function(e){return ExpressionParser=function(){function t(e,t){var n={};return n.eq=function(n){return e==n.type()&&t==n.prio()},n.type=function(t){return t?t==e:e},n.prio=function(){return t},n.toString=function(){return"["+e+":"+t+"]"},n}function n(e){var t={},n=e;return t.add=function(e){n=n?n.or(e):e},t.get=function(){return n},t}function r(){var r=n(),i={};return i.reg=function(n,i,o){var a=t(n,i);r.add(o.ret(e.create(function(e){return e.opType=a,e})).setName("(opType "+a+" "+o.name+")"))},i.get=function(){return r.get()},i.parse=function(e){return i.get().parse(e)},i}function i(e,t){return}function o(e,t){var n,r=t;if(i(t," start minprio= "+e),t=s.parse(t),i(t," prefixorelem "+e),!t.isSuccess())return t;if(n=t.opType,n.type("prefix")){if(pre=t.result[0],t=o(n.prio(),t),!t.isSuccess())return t;var c=a.mkPrefix.def(pre,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(r=t.clone(),t=u.parse(t),!t.isSuccess())return r;for(;;){if(i(t,"st:pi"),i(r,"res:ex"),n=t.opType,n.prio()<e)return r.nextPostfixOrInfix=t,r;if(n.type("postfix")){var c=a.mkPostfix.def(r.result[0],t.result[0]);if(r=t.clone(),r.result=[c],i(t,"185"),t=u.parse(t),!t.isSuccess())return r}else if(n.type("infixl")){var l=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var c=a.mkInfixl.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("infixr")){var l=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var c=a.mkInfixr.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else if(n.type("trifixr")){var p=r.result[0],d=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var h=t.result[0],t=f[n.prio()].parse(t);if(!t.isSuccess())return r;var m=t.result[0];if(t=o(n.prio(),t),!t.isSuccess())return r;var g=t.result[0],c=a.mkTrifixr.def(p,d,h,m,g);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;t=t.nextPostfixOrInfix}else{var l=t.result[0];if(t=o(n.prio()+1,t),!t.isSuccess())return r;var c=a.mkInfix.def(r.result[0],l,t.result[0]);if(r=t.clone(),r.result=[c],!t.nextPostfixOrInfix)return r;if(t=t.nextPostfixOrInfix,n.prio()==t.opType.prio())return r.success=!1,r}}}var a={},s=r(),u=r(),c=n(),f=[];return a.element=function(e){s.reg("element",-1,e),c.add(e)},a.getElement=function(){return c.get()},a.prefix=function(e,t){s.reg("prefix",e,t)},a.postfix=function(e,t){u.reg("postfix",e,t)},a.infixl=function(e,t){u.reg("infixl",e,t)},a.infixr=function(e,t){u.reg("infixr",e,t)},a.infix=function(e,t){u.reg("infix",e,t)},a.trifixr=function(e,t,n){u.reg("trifixr",e,t),f[e]=n},a.custom=function(){},a.mkInfix=function(e){a.mkInfix.def=e},a.mkInfix.def=function(t,n,r){return e.setRange({type:"infix",op:n,left:t,right:r})},a.mkInfixl=function(e){a.mkInfixl.def=e},a.mkInfixl.def=function(t,n,r){return e.setRange({type:"infixl",op:n,left:t,right:r})},a.mkInfixr=function(e){a.mkInfixr.def=e},a.mkInfixr.def=function(t,n,r){return e.setRange({type:"infixr",op:n,left:t,right:r})},a.mkPrefix=function(e){a.mkPrefix.def=e},a.mkPrefix.def=function(t,n){return e.setRange({type:"prefix",op:t,right:n})},a.mkPostfix=function(e){a.mkPostfix.def=e},a.mkPostfix.def=function(t,n){return e.setRange({type:"postfix",left:t,op:n})},a.mkTrifixr=function(e){a.mkTrifixr.def=e},a.mkTrifixr.def=function(t,n,r,i,o){return e.setRange({type:"trifixr",left:t,op1:n,mid:r,op2:i,right:o})},a.build=function(){return a.built=e.create(function(e){return o(0,e)}).setName("ExpBuilt"),a.built},a.lazy=function(){return e.create(function(e){return a.built.parse(e)})},a}}),requireSimulator.setName("TonyuLang"),"function"!=typeof define&&(define=require("requirejs").define),define(["Grammar","XMLBuffer","IndentBuffer","TT","disp","Parser","ExpressionParser","TError"],function(e,t,n,r,i,o,a,s){return TonyuLang=function(){function n(e){return function(){return arguments[e]}}function u(e,t){var n=[];if(e&&!e.args)throw i(e);if(e){var r=o.getRange(e);o.addRange(n,r),e.args.forEach(function(e){n.push(e)})}return t.forEach(function(e){var t=o.getRange(e);o.addRange(n,t),n.push(e.obj)}),n}function c(e,t,n){var r={type:"infix",left:e,op:t,right:n};return o.setRange(r),r.toString=function(){return"("+e+t+n+")"},r}var f=o,l={},p=e(),d=p.get,h=(f.StringParser,f.TokensParser.token),m=h("number").ret(function(e){if(e.type="number","string"!=typeof e.text)throw"No text for "+i(e);if(e.value=parseFloat(e.text),isNaN(e.value))throw"No value for "+i(e);return e}),g=h("symbol"),v=h("==="),y=h("!=="),b=h("=="),x=h("!="),w=h(">="),T=h("<="),S=h(">"),E=h("<"),N=h("&&"),k=h("||"),M=h("-"),L=h("+"),P=h("*"),A=h("/"),D=h("%"),C=h("="),$=h("literal"),j=h("regex"),_=a(),O=p("arrayElem").ands(h("["),_.lazy(),h("]")).ret(null,"subscript"),F=p("argList").ands(h("("),_.lazy().sep0(h(","),!0),h(")")).ret(null,"args"),R=p("member").ands(h("."),g).ret(null,"name"),B=p("parenExpr").ands(h("("),_.lazy(),h(")")).ret(null,"expr"),I=p("varAccess").ands(g).ret("name"),q=d("funcExpr").firstTokens(["function","\\"]),U=p("funcExprArg").ands(q).ret("obj"),W=d("objlit").firstTokens("{"),G=p("objlitArg").ands(W).ret("obj"),z=G.or(U),V=F.and(z.rep0()).ret(function(e,t){return u(e,t)}).or(z.rep1().ret(function(e){return u(null,e)})),K=(F.or(G),p("call").ands(V).ret("args")),J=p("scall").ands(V).ret("args"),H=p("newExpr").ands(h("new"),I,K.opt()).ret(null,"klass","params"),X=p("superExpr").ands(h("super"),h(".").and(g).ret(n(1)).opt(),J).ret(null,"name","params"),Z=h("true").or(h("false")).or(h("null")).or(h("undefined")).or(h("_thread")).or(h("this")).or(h("arguments")).ret(function(e){return e.type="reservedConst",e});_.element(m),_.element(Z),_.element(j),_.element($),_.element(B),_.element(H),_.element(X),_.element(q),_.element(W),_.element(d("arylit").firstTokens("[")),_.element(I);var Y=0;_.infixr(Y,C),_.infixr(Y,h("+=")),_.infixr(Y,h("-=")),_.infixr(Y,h("*=")),_.infixr(Y,h("/=")),_.infixr(Y,h("%=")),_.infixr(Y,h("|=")),_.infixr(Y,h("&=")),Y++,_.trifixr(Y,h("?"),h(":")),Y++,_.infixl(Y,k),Y++,_.infixl(Y,N),Y++,_.infix(Y,h("instanceof")),_.infix(Y,h("is")),_.infix(Y,v),_.infix(Y,y),_.infix(Y,b),_.infix(Y,x),_.infix(Y,w),_.infix(Y,T),_.infix(Y,S),_.infix(Y,E),Y++,_.postfix(Y+3,h("++")),_.postfix(Y+3,h("--")),_.infixl(Y,M),_.infixl(Y,L),Y++,_.infixl(Y,P),_.infixl(Y,A),_.infixl(Y,D),Y++,_.prefix(Y,h("typeof")),_.prefix(Y,h("delete")),_.prefix(Y,h("++")),_.prefix(Y,h("--")),_.prefix(Y,h("+")),_.prefix(Y,h("-")),_.prefix(Y,h("!")),Y++,Y++,_.postfix(Y,K),_.postfix(Y,R),_.postfix(Y,O),_.mkInfixl(c),_.mkInfixr(c);{var Q=_.build().setName("expr").profile(),n=function(e){return function(){return arguments[e]}},et=d("stmt").firstTokens();p("exprstmt").ands(Q,h(";")).ret("expr")}p("compound").ands(h("{"),et.rep0(),h("}")).ret(null,"stmts");var tt=h("else").and(et).ret(n(1)),nt=(p("return").ands(h("return"),Q.opt(),h(";")).ret(null,"value"),p("if").ands(h("if"),h("("),Q,h(")"),et,tt.opt()).ret(null,null,"cond",null,"then","_else"),p("forin").ands(h("var").opt(),g.sep1(h(","),!0),h("in"),Q).ret("isVar","vars",null,"set")),rt=p("normalFor").ands(et,Q.opt(),h(";"),Q.opt()).ret("init","cond",null,"next"),it=rt.or(nt),ot=(p("for").ands(h("for"),h("("),it,h(")"),"stmt").ret(null,null,"inFor",null,"loop"),p("while").ands(h("while"),h("("),Q,h(")"),"stmt").ret(null,null,"cond",null,"loop"),p("break").ands(h("break"),h(";")).ret("brk"),p("finally").ands(h("finally"),"stmt").ret(null,"stmt"),p("catch").ands(h("catch"),h("("),g,h(")"),"stmt").ret(null,null,"name",null,"stmt"),p("catches").ors("catch","finally")),at=(p("try").ands(h("try"),"stmt",ot.rep1()).ret(null,"stmt","catches"),p("throw").ands(h("throw"),Q,h(";")).ret(null,"ex"),g),st=p("typeDecl").ands(h(":"),at).ret(null,"vtype"),ut=p("varDecl").ands(g,st.opt(),h("=").and(Q).ret(n(1)).opt()).ret("name","vtype","value"),ct=(p("varsDecl").ands(h("var"),ut.sep1(h(","),!0),h(";")).ret(null,"decls"),p("paramDecl").ands(g,st.opt()).ret("name","vtype")),ft=p("paramDecls").ands(h("("),ct.sep0(h(","),!0),h(")")).ret(null,"params"),lt=p("setterDecl").ands(h("="),ct).ret(null,"value");p("funcDeclHead").ands(h("nowait").opt(),h("function").or(h("fiber")).or(h("tk_constructor")).or(h("\\")).opt(),g.or(h("new")),lt.opt(),ft.opt(),st.opt()).ret("nowait","ftype","name","setter","params","rtype");p("funcDecl").ands("funcDeclHead","compound").ret("head","body"),p("nativeDecl").ands(h("native"),g,h(";")).ret(null,"name"),p("ifWait").ands(h("ifwait"),"stmt",tt.opt()).ret(null,"then","_else");et=p("stmt").ors("return","if","for","while","break","ifWait","try","throw","nativeDecl","funcDecl","compound","exprstmt","varsDecl"),p("funcExprHead").ands(h("function").or(h("\\")),g.opt(),ft.opt()).ret(null,"name","params");var pt=(p("funcExpr").ands("funcExprHead","compound").ret("head","body"),p("jsonElem").ands(g.or($),h(":").and(Q).ret(function(e,t){return t}).opt()).ret("key","value")),dt=(p("objlit").ands(h("{"),pt.sep0(h(","),!0),h("}")).ret(null,"elems"),p("arylit").ands(h("["),Q.sep0(h(","),!0),h("]")).ret(null,"elems"),p("extends").ands(h("extends"),g.or(h("null")),h(";")).ret(null,"superclassName")),ht=p("includes").ands(h("includes"),g.sep1(h(","),!0),h(";")).ret(null,"includeClassNames"),mt=p("program").ands(dt.opt(),ht.opt(),et.rep0(),o.TokensParser.eof).ret("ext","incl","stmts");for(var gt in p.defs)p.defs[gt].profile();return l.parse=function(e){str="string"==typeof e?e:e.text(),str+="\n";var t=r.parse(str);if(!t.isSuccess())throw s("文法エラー(Token)",e,t.src.maxPos);var n=t.result[0],i=f.TokensParser.parse(mt,n);if(i.isSuccess()){var o=i.result[0];return o}var a=n[i.src.maxPos],u=a?a.pos+a.len:str.length;throw s("文法エラー",e,u)},l.genXML=function(e,n){var r=t(e);return r(n),r.buf},l.extension="tonyu",l}()}),requireSimulator.setName("Visitor"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return Visitor=function(e){var t={funcs:e,path:[]};return t.visit=function(n){try{t.path.push(n),t.debug&&console.log("visit ",n.type,n.pos);var r=n?e[n.type]:null;if(r)return r.call(t,n);if(t.def)return t.def.call(t,n)}finally{t.path.pop()}},t.replace=function(e){return t.def||(t.def=function(e){if("object"==typeof e)for(var n in e)e[n]&&"object"==typeof e[n]&&(e[n]=t.visit(e[n]));return e}),t.visit(e)},t}}),requireSimulator.setName("fixIndent"),requireSimulator.setName("HttpHelper"),requireSimulator.setName("Arrow"),Arrow=function(){var e={};return e.show=function(e){function t(){e.addClass("tutorial-highlight"),setTimeout(n,200)}function n(){e.removeClass("tutorial-highlight"),o-->0?setTimeout(t,200):r()}function r(){o=0,$.data(e[0],"blinking","f")}if("string"==typeof e&&(e=$(e)),0==e.length)return!1;var i=$.data(e[0],"blinking");if("t"!=i){$.data(e[0],"blinking","t");var o=3;t(),e.click(function(){r()})}},e.showOld=function(e){function t(){r&&(r.attr({src:"images/arrow"+i+".png"}),i=(i+1)%4)}if("string"==typeof e&&(e=$(e)),0==e.length)return!1;var n=e.offset(),r=$("<img>").attr({src:"images/arrow0.png"}).css({font:"40px",position:"absolute",left:n.left,top:n.top+e.height(),color:"red",zIndex:1e3,"z-index":1e3}).appendTo("body"),i=0;return setInterval(t,250),e.click(function(){r&&(r.remove(),r=null)}),!0},e}(),requireSimulator.setName("Wiki"),define(["HttpHelper","Arrow","Util","WebSite","Log","UI","FS"],function(e,t,n,r,i,o,a){return Wiki=function(n,s,u){function c(e){function t(e){e.stopPropagation(),e.preventDefault()}function n(e){if(u.editMode){var t=e.originalEvent,n=t.dataTransfer.files[0];if(!n.type.match(/image\/(png|gif|jpg)/)[1])return e.stopPropagation(),e.preventDefault(),!1;var r=new FileReader;return r.onload=function(){var e=r.result;s.text(e),i.empty().append(o("img",{src:e}))},r.readAsDataURL(n),e.stopPropagation(),e.preventDefault(),!1}}var i,s;if(l.builtinImages[e])return $("<div>").append($("<img>").attr("src",r.top+"/doc/images/"+e));i=o("div",{style:"margin:10px; padding:10px; border:solid black 1px;",on:{dragover:t,dragenter:t,drop:n}},"ここに画像ファイル(png/gif/jpg)をドラッグ＆ドロップして追加");var c=a.get(r.tonyuHome);return s=c.rel("doc/images/").rel(e),s.exists()&&i.empty().append(o("img",{src:s.text()})),i}function f(e,t,n){function r(){for(var a=[];;){var s=e.indexOf(t,o),u=e.indexOf(n,o);if(u>=0&&(0>s||s>u)){a.push(e.substring(o,u)),o=u;break}if(0>s){a.push(e.substring(o)),o=e.length;break}a.push(e.substring(o,s)),o=s+t.length;var c=r();c.hasBrace=!0,o<e.length&&(o+=n.length),a.push(c)}return i(a),a}function i(e){return e.split=function(e,t){if(1==t)return this;var n=[],r=i([]);return this.forEach(function(o){if("string"==typeof o){var a=o.indexOf(e);if(n.length>=t&&(a=-1),a>=0){if(a>0){var s=o.substring(0,a);r.push(s)}if(a+=e.length,n.push(1!=r.length?r:r[0]),r=i([]),a<o.length){var s=o.substring(a);r.push(s)}}else r.push(o)}else r.push(o)}),n.push(1!=r.length?r:r[0]),n},e.text=function(e){var r=this.hasBrace&&e?t:"";return this.forEach(function(e){r+="string"==typeof e?e:e.text(!0)}),r+=this.hasBrace&&e?n:""},e.toString=function(){return this.text(!0)},e}var o=0;return r(0)}var l={},p={figures:"図",plists:"リスト"},d="line_marker_",h={},m=[],g=".txt";if(u||(u={}),s&&!s.isDir())throw s+": not a dir";var v,y;l.on=h,l.cd=function(e){v=e,y=v.rel("toc.json")},s&&l.cd(s),l.encodeURL=function(e){return encodeURI(e).replace(/%/g,"")},l.parse=function(n,i,o){function a(e){m[e]={};var t=1,n=function(n,r){var i=m[e][n];return i||(i={refs:[]},m[e][n]=i),r&&(i.no=t++,i.name=p[e]+i.no,i.refs.forEach(function(e){e.text(i.name)})),i};return n}function s(e){function t(e){for(null==e&&(e=0);m.ul>e;)m.ul--,g.exit()}g.lineNo=m.lineNo;var n=0;if(e.match(/^-+/)&&(n=RegExp.lastMatch.length),n>m.ul)for(;n>m.ul;)m.ul++,g.enter("<ul>");else t(n);if(e=e.substring(n),n>0&&g.enter("<li>"),e.match(/^\*+/)){var r=RegExp.rightContext,i="h"+RegExp.lastMatch.length;g.enter("<"+i+">"),h(r),g.exit()}else if(e.match(/^$/))t(),g.p($("<p>"));else if(e.match(/^<<toc(.*)/))m.toc=[m.name],m.blocks.push({name:"toc",exit:function(){y&&!y.isReadOnly()&&y.obj(m.toc),m.toc=null}});else if(e.match(/^<<code(.*)/)){var o=RegExp.$1;if(o=o.replace(/^ */,""),o.length>0){var a,s,u=o.split(/ /,2);if(2==u.length){s=u[0],a=u[1];var c=b(a,!0);g.p($("<div>").addClass("plist").text(c.name+" "+s))}else g.p($("<div>").addClass("plist").text(u))}g.enter("<pre>"),m.blocks.push({name:"code",exit:function(){g.exit()}})}else if(e.match(/^>>/)){var f=m.blocks.pop();f&&f.exit&&f.exit(m)}else if(e.match(/^@@@@(.*)/)){if(m.pclose)g.exit();else{if(RegExp.$1.length>0){var c=b(RegExp.$1,!0);g.p($("<div>").addClass("plist").text(c.name))}g.enter("<pre>")}m.pclose=!m.pclose}else h(e),g.p("\n");n>0&&g.exit(),m.lineNo++}function h(e){function n(e){var n,i=e.text();if(i.match(/^@blink ([^>]+)>([^\s]+)/)){caption=RegExp.$1;var a=RegExp.$2;n=$("<span>").addClass("clickable").text(caption).hover(function(){var e;parent&&parent.Arrow&&(e=parent.Arrow),t&&(e=t),e&&e.show(a)})}else if(i.match(/^@plistref (.*)/)){var s=RegExp.$1,f=b(s);n=$("<strong>").text(f.name),f.refs.push(n)}else if(i.match(/^@editadd/))g.p($("<img>").attr("src",r.top+"/images/editAdd.png"));else if(i.match(/^@figref (.*)/)){var f=v(RegExp.$1);n=$("<strong>").text(f.name),f.refs.push(n)}else if(i.match(/^@cfrag (.*)/)){var d=RegExp.$1;n=$("<code>"),g.enter(n),h(d),g.exit()}else if(i.match(/^@arg (.*)/)){var y=RegExp.$1;n=$("<i>"),g.enter(n),h(y),g.exit()}else{var x=e.split(">",2);if(2==x.length?(i=x[1]+"",caption=x[0]):caption=i,m.toc&&m.toc.push(i),i.match(/\.(png|jpg|gif)$/)&&!i.match(/^http/)){var f=v(i,!0);n=$("<div>").addClass("figure").append(c(i)),g.enter(n),g.enter($("<div>")),g.p(p.figures+f.no+"."),h(caption),g.exit(),g.exit()}else if(i.match(/^https?:\/\//))n=$("<a>").attr({href:i,target:"ext"}).text(caption);else{var w=l.resolveFile(i);if(w.exists()||!w.isReadOnly()&&u.editMode){if(u.useAnchor){var T=w.relPath(o.up()).replace(/\.txt$/,".html");T=l.encodeURL(T),n=$("<a>").attr({href:T}).text(caption)}else n=$("<span>").addClass("clickable").text(caption).click(function(){l.show(w)});w.exists()||n.addClass("notexist")}else n=$("<span>").text(caption)}}g.p(n)}var i="string"==typeof e?f(e,m.beginMark,m.endMark):e;i.forEach(function(e){"string"==typeof e?g.p(e):n(e)})}var m={},g=e({lineMark:d});m.out=g,m.name=i,m.lines=n.split(/\r?\n/),m.lineNo=0,m.ul=0,m.beginMark="[[",m.endMark="]]",m.blocks=[];var v=a("figures"),b=a("plists"),x=[];y&&y.exists()&&(x=y.obj());var w=x.indexOf(i);if(w>=0){var T="",S=x[w-1];S&&(T+="[[前へ>"+S+"]]");var E=x[w+1];E&&(T+=" - [[次へ>"+E+"]]");var N=x[0];0!=w&&(T+=" - [[目次>"+N+"]]"),m.lines.unshift(T),m.lines.push(T)}return m.lines.forEach(s),g.buf},l.resolveFile=function(e){var t;return t=e.isDir?e:v&&"/"!=e.substring(0,1)?v.rel(e+g):a.get(e)},l.show=function(e){var t=l.resolveFile(e);u.editMode||i.d("wiki","show "+t),l.cd(t.up());var r=t.truncExt(g);if(!t.exists()&&!t.isReadOnly()&&u.editMode){var o=m[m.length-1];t.text(o?"[["+o.truncExt(g)+"]]\n":"")}if(t.exists()){var a=l.parse(t.text(),r,t);n.empty(),n.scrollTop(0),n.append(a),n.append($("<div>").css({height:"100px"}).text("")),h.show&&h.show.apply(l,[t,r]),m.push(t)}else alert(e+" というページはありません")},l.back=function(){var e=m.pop();e&&show(e)};var b;return l.highlightLine=function(e){var t=$("#"+d+"-"+e);if(0!=t.length){b&&b.removeClass("wiki-cur-line"),b=t.next(),b.addClass("wiki-cur-line");var r=t.position().top,i=n;0>r&&i.scrollTop(i.scrollTop()+(r-10)/2);var o=i.height()-100;r>o&&i.scrollTop(i.scrollTop()+(r-o+10)/2)}},l.builtinImages={"50_100.png":1,"50_160.png":1,"50_300.png":1,"apple1apple2.png":1,"coords.png":1,"copy60_100.png":1,"firstRunRes.png":1,"firstVarRes.png":1,"itadaki.png":1,"noWaitCat.png":1,"runtimeError.png":1,"sample.png":1,"sayonara.png":1,"syntaxError.png":1},l}}),requireSimulator.setName("Tonyu.Iterator"),define(["Tonyu"],function(){function e(e,t){var n={};if(e.tonyuIterator)return e.tonyuIterator(t);if(e instanceof Array)n.i=0,n.next=1==t?function(){return n.i>=e.length?!1:(this[0]=e[n.i],n.i++,!0)}:function(){return n.i>=e.length?!1:(this[0]=n.i,this[1]=e[n.i],n.i++,!0)};else{if(!(e instanceof Object))throw console.log(e),new Error(e+" is not iterable");n.i=0;var r=[];if(1==t){for(var i in e)r.push(i);n.next=function(){return n.i>=r.length?!1:(this[0]=r[n.i],n.i++,!0)}}else{for(var i in e)r.push([i,e[i]]);n.next=function(){return n.i>=r.length?!1:(this[0]=r[n.i][0],this[1]=r[n.i][1],n.i++,!0)}}}return n}return Tonyu.iterator=e,e}),requireSimulator.setName("ObjectMatcher"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return ObjectMatcher=function(){function e(e,t){var n={};return n[i]=e,t&&(n[o]=t),n}function t(e){return e&&e[i]}function n(e,t,r){if(e===t)return!0;if(null==e)return!1;if("string"==typeof e&&t instanceof RegExp)return e.match(t);if("function"==typeof t)return t(e,r);if("object"==typeof t){for(var a in t)if(a!=i){var s=a==o?e:e[a],u=t[a];if(!n(s,u,r))return!1}return t[i]&&(r[t[i]]=e),!0}return!1}var r={},i="$var",o="$this";r.v=e,r.isVar=t;for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s=0;s<a.length;s++){var u=a.substring(s,s+1);r[u]=e(u)}return r.match=function(e,t){var r={};return n(e,t,r)?r:null},r}()}),requireSimulator.setName("context"),"function"!=typeof define&&(define=require("requirejs").define),define([],function(){return context=function(){function e(e,n){var r={};for(var i in e)i.match(/^\$/)?(i=RegExp.rightContext,r[i]=t[i],t[i]=t.ovrFunc(t[i],e[i])):(r[i]=t[i],t[i]=e[i]);n(t);for(var i in r)t[i]=r[i]}var t={};return t.ovrFunc=function(e,t){return t.parent=e,t},t.enter=e,t}}),requireSimulator.setName("Tonyu.Compiler"),define(["Tonyu","ObjectMatcher","TError"],function(e){function t(e,t){var n={type:e};if(t)for(var r in t)n[r]=t[r];return n.name||(n.name=o("_"+e+"_")),n}function n(e){return e?e.type:null}function r(e){var t=function(){};return t.prototype=e,new t}function i(e,t){if(!e)throw t+" is null";return e}function o(e){return e+(d++ +"").replace(/\./g,"")}function a(e,t,n){t._id||(e._idseq||(e._idseq=0),t._id=++e._idseq);var r=e[t._id];if(r||(r=e[t._id]={node:t}),n)for(var i in n)r[i]=n[i];return r}function s(e,t){return e.substring(t.pos,t.pos+t.len)}function u(e,t){var n=null;return c(e).forEach(function(e){n||(n=e.decls.methods[t])}),n}function c(e){function t(e){n[e.fullName]||(n[e.fullName]=!0,r.push(e),e.superclass&&t(e.superclass),e.includes&&e.includes.forEach(t))}var n={},r=[];return t(e),r}function f(e){var t=[];if(!e.head)return t;e.head.setter&&t.push(e.head.setter.value);var n=e.head.params?e.head.params.params:null;if(n&&!n.forEach)throw e+" is not array ";return n&&(t=t.concat(n)),t}var l={};e.Compiler=l;var p={FIELD:"field",METHOD:"method",NATIVE:"native",LOCAL:"local",THVAR:"threadvar",PARAM:"param",GLOBAL:"global",CLASS:"class"};l.ScopeTypes=p;var d=1;return l.newScopeType=t,l.getScopeType=n,l.newScope=r,l.nullCheck=i,l.genSym=o,l.annotation=a,l.getSource=s,l.getMethod=u,l.getDependingClasses=c,l.getParams=f,l}),requireSimulator.setName("Tonyu.Compiler.JSGenerator"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(e,t,n,r,i,o,a,s,u){return u.JSGenerator=function(){function e(e,L){function P(e){return u.getSource(J,e)}function A(t,n){return M(e.annotation,t,n)}function D(e){return"string"==typeof e?x+(L.aliases[e]||e):e.builtin?e.fullName:x+e.fullName}function C(e){var t=[];return e.forEach(function(e){t.push(D(e))}),t}function $(e,t){return function(){Z.enter(e,function(){v.visit(t)})}}function j(e,r,i){var o=k(r);if(o==rt.THVAR)H.printf("%s",t);else if(o==rt.FIELD)H.printf("%s.%s",n,e);else if(o==rt.METHOD)i&&i.noBind?H.printf("%s.%s",n,e):H.printf("%s(%s,%s.%s)",m,n,n,e);else if(o==rt.CLASS)H.printf("%s",D(e));else if(o==rt.GLOBAL)H.printf("%s%s",w,e);else{if(o!=rt.PARAM&&o!=rt.LOCAL&&o!=rt.NATIVE)throw console.log("Unknown scope type: ",o),new Error("Unknown scope type: "+o);H.printf("%s",e)}return r}function _(e){return function(){O.apply(this,[e])}}function O(e){"compound"==e.type?Z.enter({noWait:!0},function(){H.printf("%j%n",["%n",e.stmts])}):v.visit(e)}function F(t){return function(){H.printf("%s%s=%s;//%s%n",L.options.compiler.commentLastPos?"//":"",p,et.add(e,t.pos),e.fullName+":"+t.pos)}}function R(){Z.enter({},function(){X("Tonyu.klass.define({%{"),X("fullName: %l,%n",e.fullName),X("shortName: %l,%n",e.shortName),X("namespace: %l,%n",e.namespace),e.superclass&&X("superclass: %s,%n",D(e.superclass)),X("includes: [%s],%n",C(e.includes).join(",")),X("methods: {%{");for(var t in nt){Y&&console.log("method1",t);var n=nt[t];Z.enter({noWait:!0,threadAvail:!1},function(){q(n)}),Y&&console.log("method2",t),n.nowait||Z.enter({noWait:!1,threadAvail:!0},function(){I(n)}),Y&&console.log("method3",t)}X("__dummy: false%n"),X("%}},%n"),X("decls: %s%n",JSON.stringify(B(e))),X("%}});")})}function B(e){var t={methods:{}};for(var n in e.decls.methods)t.methods[n]={nowait:!!e.decls.methods[n].nowait};return t}function I(e){function r(){Z.enter({method:e,noWait:!0,threadAvail:!0},function(){a.forEach(function(e){X("%v%n",e)})})}function i(){Z.enter({method:e,finfo:e,pc:1},function(){s.forEach(function(e){X("%v%n",e)})})}if(!V(e)){var o=e.stmts,a=[],s=[],u=a,p=!0;p?o.forEach(function(e){A(e).fiberCallRequired&&(u=s),u.push(e)}):s=o,X("%s%s :function %s(%j) {%{"+S+"var %s=%s;%n%svar %s=%s;%nvar %s=0;%n%f%n%f%n",f,e.name,W(e.pos,"f_"+e.name),[",",[at].concat(e.params)],n,T,e.useArgs?"":"//",c,"Tonyu.A(arguments)",l,z(e),r),s.length>0?X("%s.enter(function %s(%s) {%{if (%s.lastEx) %s=%s.catchPC;%nfor(var %s=%d ; %s--;) {%{switch (%s) {%{%}case 0:%{%f%s.exit(%s);return;%n%}}%n%}}%n%}});%n",t,W(e.pos,"ent_"+e.name),t,t,l,t,d,h,d,l,i,t,n):X("%s.retVal=%s;return;%n",t,n),X("%}},%n")}}function q(e){function t(){Z.enter({method:e,finfo:e},function(){e.stmts.forEach(function(e){X("%v%n",e)})})}var r=V(e)?"initialize":e.name;X("%s :function %s(%j) {%{"+S+"var %s=%s;%n%f%n%f%}},%n",r,W(e.pos,r),[",",e.params],n,T,z(e),t)}function U(e){function t(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){X("%v%n",e)})})}var n=A(e);H.printf("(function %s(%j) {%{%f%n%f%}})",n.name,[",",n.params],z(n),t)}function W(t,n){return n||(n=it++ +""),"_trc_"+e.shortName+"_"+n}function G(e){function t(){Z.enter({noWait:!0,threadAvail:!1,finfo:n},function(){e.body.stmts.forEach(function(e){X("%v%n",e)})})}var n=A(e);H.printf("function %s(%j) {%{%f%n%f%}}",n.name,[",",n.params],z(n),t)}function z(e){function t(){Z.enter({},function(){for(var t in e.locals.varDecls)H.printf("var %s;%n",t);for(var t in e.locals.subFuncDecls)G(e.locals.subFuncDecls[t])})}return t}function V(e){return Q.match(e,{ftype:"constructor"})||Q.match(e,{name:"new"})}var K=e.src.tonyu,J=K.text(),H=o(),X=H.printf,Z=a(),Y=!1,Q=r,et=L.traceTbl,tt=e.decls,nt=(tt.fields,tt.methods),rt=(tt.natives,N),it=0,ot=L.options.compiler.diagnose,at={type:"THNode"};v=H.visitor=s({THNode:function(){H.printf(t)},dummy:function(e){H.printf("",e)},literal:function(e){H.printf("%s",e.text)},paramDecl:function(e){H.printf("%v",e.name)},paramDecls:function(e){H.printf("(%j)",[", ",e.params])},funcDeclHead:function(e){H.printf("function %v %v",e.name,e.params)},funcDecl:function(){},"return":function(e){if(Z.inTry)throw i("現実装では、tryの中にreturnは書けません",K,e.pos);Z.noWait?Z.threadAvail?e.value?H.printf("%s.retVal=%v;return;%n",t,e.value):H.printf("%s.retVal=%s;return;%n",t,n):e.value?H.printf("return %v;",e.value):H.printf("return %s;",n):e.value?H.printf("%s.exit(%v);return;",t,e.value):H.printf("%s.exit(%s);return;",t,n)},program:function(e){genClass(e.stmts)},number:function(e){H.printf("%s",e.value)},reservedConst:function(e){"this"==e.text?H.printf("%s",n):"arguments"==e.text&&Z.threadAvail?H.printf("%s",c):e.text==t?H.printf("%s",Z.threadAvail?t:"null"):H.printf("%s",e.text)},varDecl:function(e){e.value?H.printf("%v = %v",e.name,e.value):H.printf("%v",e.name)},varsDecl:function(e){F(e)(),H.printf("%j;",[";",e.decls])},jsonElem:function(e){e.value?H.printf("%v: %v",e.key,e.value):H.printf("%v: %f",e.key,function(){j(e.key.text,A(e).scopeInfo,A(e))})},objlit:function(e){H.printf("{%j}",[",",e.elems])},arylit:function(e){H.printf("[%j]",[",",e.elems])},funcExpr:function(e){U(e)},parenExpr:function(e){H.printf("(%v)",e.expr)},varAccess:function(e){{var t=e.name.text;j(t,A(e).scopeInfo,A(e))}},exprstmt:function(r){var i={};if(F(r)(),Z.noWait||(i=A(r).fiberCall||{}),"noRet"==i.type)H.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{",n,f,i.N,[", ",[at].concat(i.A)],l,Z.pc,Z.pc++);
else if("ret"==i.type)H.printf("%s.%s%s(%j);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",n,f,i.N,[", ",[at].concat(i.A)],l,Z.pc,Z.pc++,i.L,i.O,t);else if("noRetSuper"==i.type){var o=D(e.superclass);H.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{",o,f,i.S.name.text,n,[", ",[at].concat(i.A)],l,Z.pc,Z.pc++)}else"retSuper"==i.type?H.printf("%s.prototype.%s%s.apply( %s, [%j]);%n%s=%s;return;%n%}case %d:%{%v%v%s.retVal;%n",o,f,i.S.name.text,n,[", ",[at].concat(i.A)],l,Z.pc,Z.pc++,i.L,i.O,t):H.printf("%v;",r.expr)},infix:function(e){var t=e.op.text;if(ot){if("+"==t||"-"==t||"*"==t||"/"==t||"%"==t)return void H.printf("%s(%v,%l)%v%s(%v,%l)",b,e.left,P(e.left),e.op,b,e.right,P(e.right));if("+="==t||"-="==t||"*="==t||"/="==t||"%="==t)return void H.printf("%v%v%s(%v,%l)",e.left,e.op,b,e.right,P(e.right))}H.printf("%v%v%v",e.left,e.op,e.right)},trifixr:function(e){H.printf("%v%v%v%v%v",e.left,e.op1,e.mid,e.op2,e.right)},prefix:function(e){H.printf("%v %v",e.op,e.right)},postfix:function(e){var t=A(e);if(ot){if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=k(i);return void(o==rt.FIELD||o==rt.METHOD?H.printf("%s(%s, %l, [%j], %l )",g,n,r.name,[",",r.args],"this"):H.printf("%s(%v, [%j], %l)",y,e.left,[",",r.args],P(e.left)))}if(t.othersMethodCall){var a=t.othersMethodCall;return void H.printf("%s(%v, %l, [%j], %l )",g,a.target,a.name,[",",a.args],P(a.target))}if(t.memberAccess){var s=t.memberAccess;return void H.printf("%s(%v,%l).%s",b,s.target,P(s.target),s.name)}}else if(t.myMethodCall){var r=t.myMethodCall,i=r.scopeInfo,o=k(i);if(o==rt.METHOD)return void H.printf("%s.%s(%j)",n,r.name,[",",r.args])}H.printf("%v%v",e.left,e.op)},"break":function(e){if(Z.noWait)H.printf("break;%n");else{if(Z.inTry&&Z.exitTryOnJump)throw i("現実装では、tryの中にbreak;は書けません",K,e.pos);if(!Z.closestBrk)throw i("break； は繰り返しの中で使います",K,e.pos);H.printf("%s=%z; break;%n",l,Z.closestBrk)}},"try":function(e){var n=A(e);if(!Z.noWait&&(n.fiberCallRequired||n.hasJump||n.hasReturn)){if(1!=e.catches.length||"catch"!=e.catches[0].type)throw i("現実装では、catch節1個のみをサポートしています",K,e.pos);var r=e.catches[0],o={},a={};H.printf("%s.enterTry(%z);%n",t,o),H.printf("%f",$({inTry:!0,exitTryOnJump:!0},e.stmt)),H.printf("%s.exitTry();%n",t),H.printf("%s=%z;break;%n",l,a),H.printf("%}case %f:%{",function(){H.print(o.put(Z.pc++))}),H.printf("%s=%s.startCatch();%n",r.name.text,t),H.printf("%s.exitTry();%n",t),H.printf("%v%n",r.stmt),H.printf("%}case %f:%{",function(){H.print(a.put(Z.pc++))})}else Z.enter({noWait:!0},function(){H.printf("try {%{%f%n%}} ",_(e.stmt)),e.catches.forEach(v.visit)})},"catch":function(e){H.printf("catch (%s) {%{%f%n%}}",e.name.text,_(e.stmt))},"throw":function(e){H.printf("throw %v;%n",e.ex)},"while":function(e){F(e)();var t=A(e);if(Z.noWait||!t.fiberCallRequired&&!t.hasReturn)Z.enter({noWait:!0},function(){H.printf("while (%v) {%{%f%n%}}",e.cond,_(e.loop))});else{var n=H.lazy(),r=Z.pc++,i="reservedConst"==e.cond.type&&"true"==e.cond.text;H.printf("%}case %d:%{"+(i?"%D%D%D":"if (!(%v)) { %s=%z; break; }%n")+"%f%n%s=%s;break;%n%}case %f:%{",r,e.cond,l,n,$({closestBrk:n,exitTryOnJump:!1},e.loop),l,r,function(){H.print(n.put(Z.pc++))})}},"for":function(e){function t(e,t,n){return function(){n.forEach(function(t,n){H.printf("%s=%s[%s];%n",t.text,e,n)})}}F(e)();var n=A(e);if("forin"==e.inFor.type){var r=A(e.inFor).iterName;if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){H.printf("%s=%s(%v,%s);%nwhile(%s.next()) {%{%f%n%f%n%}}",r,E,e.inFor.set,e.inFor.vars.length,r,t(r,e.inFor.isVar,e.inFor.vars),_(e.loop))});else{var i=H.lazy(),o=Z.pc++;H.printf("%s=%s(%v,%s);%n%}case %d:%{if (!(%s.next())) { %s=%z; break; }%n%f%n%f%n%s=%s;break;%n%}case %f:%{",r,E,e.inFor.set,e.inFor.vars.length,o,r,l,i,t(r,e.inFor.isVar,e.inFor.vars),$({closestBrk:i,exitTryOnJump:!1},e.loop),l,o,function(e){e.print(i.put(Z.pc++))})}}else if(Z.noWait||!n.fiberCallRequired&&!n.hasReturn)Z.enter({noWait:!0},function(){H.printf("%v%nwhile(%v) {%{%v%n%v;%n%}}",e.inFor.init,e.inFor.cond,e.loop,e.inFor.next)});else{var i=H.lazy(),o=Z.pc++;H.printf("%v;%n%}case %d:%{if (!(%v)) { %s=%z; break; }%n%f%n%v;%n%s=%s;break;%n%}case %f:%{",e.inFor.init,o,e.inFor.cond,l,i,$({closestBrk:i,exitTryOnJump:!1},e.loop),e.inFor.next,l,o,function(e){e.print(i.put(Z.pc++))})}},"if":function(e){F(e)();var t=A(e);if(!Z.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)){var n={},r={};e._else?H.printf("if (!(%v)) { %s=%z; break; }%n%v%n%s=%z;break;%n%}case %f:%{%v%n%}case %f:%{",e.cond,l,r,e.then,l,n,function(){H.print(r.put(Z.pc++))},e._else,function(){H.print(n.put(Z.pc++))}):H.printf("if (!(%v)) { %s=%z; break; }%n%v%n%}case %f:%{",e.cond,l,n,e.then,function(){H.print(n.put(Z.pc++))})}else Z.enter({noWait:!0},function(){e._else?H.printf("if (%v) {%{%f%n%}} else {%{%f%n%}}",e.cond,_(e.then),_(e._else)):H.printf("if (%v) {%{%f%n%}}",e.cond,_(e.then))})},ifWait:function(e){Z.noWait?e._else&&H.printf("%v",e._else):H.printf("%v",e.then)},call:function(e){H.printf("(%j)",[",",e.args])},objlitArg:function(e){H.printf("%v",e.obj)},argList:function(e){H.printf("%j",[",",e.args])},newExpr:function(e){var t=e.params;t?H.printf("new %v%v",e.klass,t):H.printf("new %v",e.klass)},scall:function(e){H.printf("[%j]",[",",e.args])},superExpr:function(t){var r;if(!e.superclass)throw new Error(e.fullName+"には親クラスがありません");t.name?(r=t.name.text,H.printf("%s.prototype.%s.apply( %s, %v)",D(e.superclass),r,n,t.params)):H.printf("%s.apply( %s, %v)",D(e.superclass),n,t.params)},arrayElem:function(e){H.printf("[%v]",e.subscript)},member:function(e){H.printf(".%v",e.name)},symbol:function(e){H.print(e.text)},normalFor:function(e){H.printf("%v; %v; %v",e.init,e.cond,e.next)},compound:function(e){var t=A(e);!Z.noWait&&(t.fiberCallRequired||t.hasJump||t.hasReturn)?H.printf("%j",["%n",e.stmts]):Z.enter({noWait:!0},function(){H.printf("{%{%j%n%}}",["%n",e.stmts])})},"typeof":function(){H.printf("typeof ")},"instanceof":function(){H.printf(" instanceof ")},is:function(){H.printf(" instanceof ")},regex:function(e){H.printf("%s",e.text)}});var st=["++","--","!==","===","+=","-=","*=","/=","%=",">=","<=","!=","==",">>","<<","&&","||",">","<","+","?","=","*","%","/","^","~","\\",":",";",",","!","&","|","-","delete"];return st.forEach(function(e){v.funcs[e]=function(){H.printf("%s",e)}}),v.def=function(e){throw console.log("Err node="),console.log(e),e.type+" is not defined in visitor:compiler2"},v.cnt=0,R(),e.src.js=H.buf,Y&&console.log("method4",H.buf),H.buf}{var t="_thread",n="_this",c="_arguments",f="fiber$",l="__pc",p="$LASTPOS",d="__cnt",h=100,m="Tonyu.bindFunc",g="Tonyu.invokeMethod",y="Tonyu.callFunc",b="Tonyu.checkNonNull",x="Tonyu.classes.",w="Tonyu.globals.",T="this",S='"use strict";%n',E="Tonyu.iterator",N=u.ScopeTypes,k=u.getScopeType,M=u.annotation;u.getMethod,u.getDependingClasses,u.getParams}return{genJS:e}}()}),requireSimulator.setName("Tonyu.Compiler.Semantics"),"function"!=typeof define&&(define=require("requirejs").define),define(["Tonyu","Tonyu.Iterator","TonyuLang","ObjectMatcher","TError","IndentBuffer","context","Visitor","Tonyu.Compiler"],function(e,t,n,r,i,o,a,s,u){return u.Semantics=function(){function e(e,t){function o(n){var r,o=t.options.compiler.defaultSuperClass,s=0;if((r=p.match(n,{ext:{superclassName:{text:p.N,pos:p.P}}}))&&(o=r.N,s=r.P,"null"==o&&(o=null)),e.includes=[],(r=p.match(n,{incl:{includeClassNames:p.C}}))&&r.C.forEach(function(n){var r=n.text,o=n.pos,s=t.classes[t.aliases[r]||r];if(!s)throw i("クラス "+r+"は定義されていません",a,o);e.includes.push(s)}),"Array"==o)e.superclass={name:"Array",fullName:"Array",builtin:!0};else if(o){var c=t.classes[t.aliases[o]||o];if(!c)throw i("親クラス "+o+"は定義されていません",a,s);e.superclass=c}n.stmts.forEach(function(e){if("funcDecl"==e.type){var t=e.head,n="function";t.ftype&&(n=t.ftype.text);var r=t.name.text,i=t.params?"":t.setter?"__setter__":"__getter__";r=i+r,f[r]={nowait:!!t.nowait||""!=i,ftype:n,name:r,head:t,pos:t.pos,stmts:e.body.stmts}}else"nativeDecl"==e.type?l[e.name.text]=e:u.stmts.push(e)})}var a=e.src.tonyu,s=n.parse(a),u={name:"main",stmts:[],pos:0},c={},f={main:u},l={};e.decls={fields:c,methods:f,natives:l},e.node=s;var p=r;o(s)}function t(e,t){function n(e){return u.getSource(F,e)}function y(t,n){return d(e.annotation,t,n)}function b(e){if(!e.builtin){var t=U,n=e.decls;for(var r in n.fields)t[r]=c(q.FIELD,{klass:e.name,name:r});for(var r in n.methods)t[r]=c(q.METHOD,{klass:e.name,name:r})}}function x(){var n=U;m(e).forEach(b);var r=e.decls;for(var i in r.natives)n[i]=c(q.NATIVE,{name:"native::"+i});for(var i in v)n[i]=c(q.NATIVE,{name:"native::"+i});for(var i in t.aliases)n[i]=c(q.CLASS,{name:i})}function w(){var t=m(e);for(var n in e.decls.methods){var r=e.decls.methods[n];t.forEach(function(e){var t=e.decls.methods[n];t&&t.nowait&&(r.nowait=!0)})}}function T(t){return h(e,t)}function S(e){if("varAccess"==e.type||"postfix"==e.type&&("member"==e.op.type||"arrayElem"==e.op.type))return"varAccess"==e.type&&y(e,{noBind:!0}),!0;throw console.log("LVal",e),i("'"+n(e)+"'は左辺には書けません．",O,e.pos)}function E(t){var n=W.scope[t],r=f(n);if(!r){var i=t.match(/^\$/);r=i?q.GLOBAL:q.FIELD;var o={name:t};i||(o.klass=e.name),n=U[t]=c(r,o)}return n}function N(e){var t=this;if(e&&"object"==typeof e){var n;if(n=e instanceof Array?e:e[Grammar.SUBELEMENTS],!n){n=[];for(var r in e)n.push(e[r])}n.forEach(function(e){t.visit(e)})}}function k(e){var t={varDecls:{},subFuncDecls:{}};return W.enter({locals:t},function(){Y.visit(e)}),t}function M(e,t){e.forEach(function(e){y(e,t)})}function L(e){W.method&&(W.method.fiberCallRequired=!0),M(e,{fiberCallRequired:!0})}function P(e,t){W.enter({scope:t},function(){Q.visit(e)})}function A(e,t){for(var n in e.varDecls)t[n]=c(q.LOCAL);for(var n in e.subFuncDecls)t[n]=c(q.LOCAL)}function D(e){e.locals=k(e.stmts),e.params=g(e)}function C(t){var n=l(W.scope);return t.params.forEach(function(r,i){n[r.name.text]=c(q.PARAM,{klass:e.name,name:t.name,no:i})}),A(t.locals,n),W.enter({method:t,finfo:t,noWait:!1},function(){P(t.stmts,n)}),t.scope=n,_(t.locals,n),n}function $(){W.enter({scope:U},function(){for(var e in I){G&&console.log("anon method1",e);var t=I[e];D(t),C(t)}})}function j(e){var t,n,r=e.body,i=e.head.name?e.head.name.text:"anonymous_"+e.pos;n=(t=R.match(e,{head:{params:{params:R.P}}}))?t.P:[];var o=l(W.scope);n.forEach(function(e){o[e.name.text]=c(q.PARAM)});var a=k(r,o);A(a,o);var s=y(e);W.enter({finfo:s},function(){P(r,o)});var u={scope:o,locals:a,name:i,params:n};return y(e,u),y(e,s),_(a,o),u}function _(e,t){W.enter({scope:t},function(){for(var t in e.subFuncDecls)j(e.subFuncDecls[t])})}var O=e.src.tonyu,F=O.text(),R=r,B=(t.traceTbl,e.decls),I=(B.fields,B.methods),q=(B.natives,o),U={},W=a(),G=!1,z={type:"postfix",left:{type:"postfix",left:R.T,op:{type:"member",name:{text:R.N}}},op:{type:"call",args:R.A}},V={type:"postfix",left:R.T,op:{type:"member",name:{text:R.N}}},K=fiberCallTmpl={type:"postfix",left:{type:"varAccess",name:{text:R.N}},op:{type:"call",args:R.A}},J={expr:fiberCallTmpl},H={expr:{type:"infix",op:R.O,left:R.L,right:fiberCallTmpl}},X={expr:{type:"superExpr",params:{args:R.A},$var:"S"}},Z={expr:{type:"infix",op:R.O,left:R.L,right:{type:"superExpr",params:{args:R.A},$var:"S"}}};e.annotation={};var Y=s({varDecl:function(e){W.locals.varDecls[e.name.text]=e},funcDecl:function(e){W.locals.subFuncDecls[e.head.name.text]=e},funcExpr:function(){},"catch":function(e){W.locals.varDecls[e.name.text]=e},exprstmt:function(){},forin:function(e){e.isVar;e.vars.forEach(function(t){W.locals.varDecls[t.text]=e});var t=p("_it_");y(e,{iterName:t}),W.locals.varDecls[t]=e}});Y.def=N;var Q=s({varAccess:function(e){var t=E(e.name.text);y(e,{scopeInfo:t})},funcDecl:function(){},funcExpr:function(e){j(e)},jsonElem:function(e){if(e.value)this.visit(e.value);else{var t=E(e.key.text);y(e,{scopeInfo:t})}},"do":function(e){var t=this;W.enter({jumpable:!0},function(){t.def(e)})},"switch":function(e){var t=this;W.enter({jumpable:!0},function(){t.def(e)})},"while":function(e){var t=this;W.enter({jumpable:!0},function(){t.def(e)}),L(this.path)},"for":function(e){var t=this;W.enter({jumpable:!0},function(){t.def(e)})},forin:function(e){e.vars.forEach(function(e){var t=E(e.text);y(e,{scopeInfo:t})}),this.visit(e.set)},ifWait:function(e){var t="_thread",n=this,r=l(W.scope);r[t]=c(q.THVAR),W.enter({scope:r},function(){n.visit(e.then)}),e._else&&n.visit(e._else),L(this.path)},"try":function(e){W.finfo.useTry=!0,this.def(e)},"return":function(e){W.noWait||M(this.path,{hasReturn:!0}),this.visit(e.value)},"break":function(e){if(!W.jumpable)throw i("break； は繰り返しの中で使います.",O,e.pos);W.noWait||M(this.path,{hasJump:!0})},"continue":function(e){if(!W.jumpable)throw i("continue； は繰り返しの中で使います.",O,e.pos);W.noWait||M(this.path,{hasJump:!0})},reservedConst:function(e){"arguments"==e.text&&(W.finfo.useArgs=!0)},postfix:function(e){var t;if(this.visit(e.left),this.visit(e.op),t=R.match(e,K)){var n=y(e.left).scopeInfo;y(e,{myMethodCall:{name:t.N,args:t.A,scopeInfo:n}})}else(t=R.match(e,z))?y(e,{othersMethodCall:{target:t.T,name:t.N,args:t.A}}):(t=R.match(e,V))&&y(e,{memberAccess:{target:t.T,name:t.N}})},infix:function(e){var t=e.op.text;("="==t||"+="==t||"-="==t||"*="==t||"/="==t||"%="==t)&&S(e.left),this.def(e)},exprstmt:function(t){var n,r;if(W.noWait||!(n=R.match(t,J))||f(W.scope[n.N])!=q.METHOD||T(n.N).nowait)if(W.noWait||!(n=R.match(t,H))||f(W.scope[n.N])!=q.METHOD||T(n.N).nowait){if(!W.noWait&&(n=R.match(t,X))&&n.S.name){if(r=T(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="noRetSuper",n.superclass=e.superclass,y(t,{fiberCall:n}),L(this.path))}else if(!W.noWait&&(n=R.match(t,Z))&&n.S.name){if(r=T(n.S.name.text),!r)throw new Error("メソッド"+n.S.name.text+" はありません。");r.nowait||(n.type="retSuper",n.superclass=e.superclass,y(t,{fiberCall:n}),L(this.path))}}else n.type="ret",y(t,{fiberCall:n}),L(this.path);else n.type="noRet",y(t,{fiberCall:n}),L(this.path);this.visit(t.expr)}});Q.def=N,x(),w(),$()}var o=u.ScopeTypes,c=u.newScopeType,f=u.getScopeType,l=u.newScope,p=u.genSym,d=u.annotation,h=u.getMethod,m=u.getDependingClasses,g=u.getParams,v={Array:1,String:1,Boolean:1,Number:1,Void:1,Object:1,RegExp:1,Error:1};return{initClassDecls:e,annotate:t}}()}),requireSimulator.setName("StackTrace"),define([],function(){var trc={},pat=/(_trc_[A-Za-z0-9_]*).*[^0-9]([0-9]+):([0-9]+)[\s\)]*\r?$/;return trc.isAvailable=function(){var scr="({\n    main :function _trc_func_17000000_0() {\n      var a=(this.t.x);\n    }\n}).main();\n",s;try{eval(scr)}catch(e){if(s=e.stack,"string"!=typeof s)return!1;for(var lines=s.split(/\n/),i=0;i<lines.length;i++){var p=pat.exec(lines[i]);if(p)return!0}}return!1},trc.get=function(e){var t=e.stack;if("string"!=typeof t)return!1;for(var n=t.split(/\n/),r=[],i=0;i<n.length;i++){var o=pat.exec(n[i]);if(o){var a=o[1],s=o[2],u=o[3];r.push({fname:a,row:s,col:u})}}return console.log("StackTrace.get",r),r},trc}),requireSimulator.setName("Tonyu.TraceTbl"),define(["Tonyu","FS","TError","StackTrace"],function(e,t,n,r){return e.TraceTbl=function(){var e={},i=1e6,o=1,a=1e4,s={},u=[],c={};e.add=function(e,t){var n=e.src.tonyu,r=n.path(),f=s[r];void 0==f&&(f=o++,o>a&&(o=0),s[r]=f,u[f]=r),c[r]=e,t>=i&&(t=i-1);var l=f*i+t;return l};var f={};return e.decodeOLD=function(e){var r=e%i,o=(e-r)/i,a=u[o];if(a){var s=t.get(a),f=c[a];return n("Trace info",f||s,r)}return null},e.srcMap=f,e.decode=function(e){var t=new RegExp("LASTPOS="+e+";//(.*)\r?\n");console.log("pat=",t);for(var n in f){var r=t.exec(f[n]);if(r)return r[1];console.log("pat=",t,"Not found in ",n)}},e.find=function(e){var t=r.get(e),n=t[0];if(!n)return null;var i=new RegExp("LASTPOS=[0-9]+;//(.*)\r?");for(var o in f){console.log("Finding ",n.fname," in ",o);var a=f[o].indexOf(n.fname);if(a>=0){console.log("fname found at ",a);var s=f[o].split(/\n/),u=n.row-1;console.log("Scan from row=",u);for(var c=u;c>=0&&(console.log("row ",c,s[c]),null!=s[c]);c--){var l=i.exec(s[c]);if(l)return l[1]}console.log("Not found LASTPOS pat")}else console.log("Not found in ",o)}},e.addSource=function(e,t){f[e]=t},e}()}),requireSimulator.setName("DeferredUtil"),define([],function(){var e;return e={directPromise:function(e){var t=new $.Deferred;return setTimeout(function(){t.resolve(e)},0),t.promise()},throwPromise:function(e){return d=new $.Deferred,setTimeout(function(){d.reject(e)},0),d.promise()},throwF:function(t){return function(){try{return t.apply(this,arguments)}catch(n){return e.throwPromise(n)}}}}}),requireSimulator.setName("compiledProject"),define([],function(){var e=function(e,t){return{getNamespace:function(){return e},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadClasses:function(n){console.log("Load compiled classes ns=",e,"url=",t);var r=new $.Deferred,i=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.src=t;var a=!1;return o.onload=o.onreadystatechange=function(){if(!(a||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState)){a=!0,o.onload=o.onreadystatechange=null,i&&o.parentNode&&i.removeChild(o),console.log("Done Load compiled classes ns=",e,"url=",t,Tonyu.classes);var s=Tonyu.classes;if(e.split(".").forEach(function(e){s&&(s=s[e])}),s)for(var u in s){var c=s[u],f=Tonyu.klass.getMeta(c);n.classes[f.fullName]=f}r.resolve()}},i.insertBefore(o,i.firstChild),r.promise()}}};return e}),requireSimulator.setName("ProjectCompiler"),define(["Tonyu","Tonyu.Compiler.JSGenerator","Tonyu.Compiler.Semantics","Tonyu.TraceTbl","FS","assert","SFile","DeferredUtil","compiledProject"],function(e,t,n,r,i,o,a,s,u){var c=function(r){function f(e){var t=d.env;return e||(e={}),e.visited||(e={visited:{},classes:t.classes=t.classes||{},options:e}),e}function l(e){function t(t){var n=t.superclass,i=n?[n]:[];return t.includes&&(i=i.concat(t.includes)),i=i.filter(function(t){return t&&e[t.fullName]&&!t.builtin&&!r[t.fullName]})}function n(e,r){if(console.log("detectloop",e.fullName),o[e.fullName]){console.log("Detected: ",e.fullName,o,o[e.fullName]);var i=e.fullName,a=[];do a.unshift(i),i=o[i];while(i!=e.fullName);return a.unshift(e.fullName),a}r&&(o[e.fullName]=r.fullName);var s,u=t(e);return u.forEach(function(t){if(!s){var r=n(t,e);r&&(s=r)}}),delete o[e.fullName],s}var r={},i=[],o={},a=0;for(var s in e)r[s]=!1,a++;for(;i.length<a;){var u=i.length;for(var s in e)if(!r[s]){var c=e[s],f=t(c);0==f.length&&(i.push(c),r[s]=!0)}if(i.length==u){var l=[];for(var s in e)if(!r[s]){l=n(e[s])||[];break}throw TError("次のクラス間に循環参照があります: "+l.join("->"),"不明",0)}}return i}function p(e){console.log("loading: "+e.path());var t=new Function(e.text());return h.addSource(e.path(),t+""),s.directPromise(t())}o(a.is(r)&&r.isDir(),"projectCompiler: "+r+" is not dir obj");var d={env:{}},h=e.TraceTbl,m=s.throwF;return d.env.traceTbl=h,d.EXT=".tonyu",d.getOptionsFile=function(){var e=r.rel("options.json");return e},d.getOptions=function(){var e=d.env;e.options={};var t=d.getOptionsFile();return t.exists()&&(e.options=t.obj()),d.fixOptions(e.options),e.options},d.setOptions=function(e){d.getOptionsFile().obj(e)},d.fixOptions=function(e){e.compiler||(e.compiler={})},d.resolve=function(e){if(e instanceof Array){var t=[];return e.forEach(function(e){t.push(d.resolve(e))}),t}if("string"==typeof e)return i.resolve(e,r.path());if(!e||!e.isDir)throw new Error("Cannot TPR.resolve: "+e);return e},d.shouldCompile=function(){var t=d.getOutputFile();if(!t.exists())return!0;if(t.isReadOnly())return!1;var n=t.lastUpdate();if(n<e.VERSION)return console.log("Should compile: ",t.name()+" last="+new Date(n)+" < Tonyu.ver="+new Date(e.VERSION)),!0;var r=d.sourceFiles(d.getNamespace());for(var i in r){var o=r[i],a=o.lastUpdate();if(a>n)return console.log("Should compile: ",o.name()+" last="+new Date(a)),!0}var s=d.getOptionsFile();return s.exists()&&s.lastUpdate()>n?(console.log("Should compile: ",s.name()+" last="+new Date(s.lastUpdate())),!0):!1},d.getClassName=function(e){if(o(a.is(e)),r.contains(e))return d.getNamespace()+"."+e.truncExt(d.EXT);var t;return d.getDependingProjects().forEach(function(n){t||(t=n.getClassName(e))}),t},d.getNamespace=function(){var e=d.getOptions();return o(e.compiler.namespace,"namespace not specified opt="+JSON.stringify(e))},d.getOutputFile=function(){var e=d.getOptions(),t=d.resolve(o(e.compiler.outputFile,"output file should be specified in options"));if(t.isDir())throw new Error("out: directory style not supported");return t},d.loadDependingClasses=function(e){var t=s.directPromise(),n=d.getNamespace();return d.getDependingProjects().forEach(function(r){r.getNamespace()!=n&&(t=t.then(function(){return r.loadClasses(e)}))}),t},d.loadClasses=function(t){function n(){var n=d.getNamespace(),r=e.classes;if(n.split(".").forEach(function(e){r&&(r=r[e])}),r)for(var i in r){var o=r[i],a=e.klass.getMeta(o);t.classes[a.fullName]=a}}e.runMode=!1,console.log("LoadClasses: "+r.path()),t=f(t);var i=t.visited||{};return i[d.path()]?s.directPromise():(i[d.path()]=!0,d.loadDependingClasses(t).then(function(){return d.shouldCompile()}).then(function(e){if(e)return d.compile(t);var r=d.getOutputFile("js");return p(r).then(m(n))}))},d.compile=function(t){e.runMode=!1,console.log("Compile: "+r.path()),t=f(t);var i=d.getNamespace();return d.loadDependingClasses(t).then(m(function(){var e=t.classes,r=(t.options,d.env);r.aliases={},r.classes=e;for(var o in e){var a=e[o];r.aliases[a.shortName]=a.fullName}var s={},u=d.sourceFiles(i);for(var c in u){var f=u[c],p=i+"."+c;s[p]=e[p]={fullName:p,shortName:c,namespace:i,src:{tonyu:f}},r.aliases[c]=p}for(var o in s)console.log("initClassDecl: "+o),n.initClassDecls(s[o],r);var h=l(s);h.forEach(function(e){console.log("annotate :"+e.fullName),n.annotate(e,r)}),d.concatJS(h)}))},d.concatJS=function(e){var n=d.env,r="";e.forEach(function(e){console.log("concatJS :"+e.fullName),t.genJS(e,n),r+=e.src.js+"\n"});var i=d.getOutputFile();i.text(r),p(i)},d.getDependingProjects=function(){var e=d.getOptions(),t=e.compiler.dependingProjects||[];return t.map(function(e){if("string"==typeof e){var t=d.resolve(e);return c(t)}return"object"==typeof e?u(e.namespace,i.expandPath(e.compiledURL)):void 0})},d.dir=r,d.path=function(){return r.path()},d.sourceFiles=function(e){function t(e){if(e.endsWith(d.EXT)){var t=e.truncExt(d.EXT);r[t]=e}}for(var n=d.sourceDirs(e),r={},i=n.length-1;i>=0;i--)n[i].recursive(t);return r},d.sourceDir=function(){return r},d.sourceDirs=function(e){var t=d.getDependingProjects(),n=[r];return t.forEach(function(t){var r=t.getNamespace();if(!e||r==e){var i=t.sourceDir();i&&n.push(i)}}),n},d.decodeTrace=function(e){var t=e.split(":"),n=t[0],r=parseInt(t[1]),i=n.split("."),o=i.pop(),a=i.join(".");if(a==d.getNamespace()){var s=d.sourceFiles(a);for(var u in s)if(o==u)return TError("Trace info",s[u],r)}},d};return"object"==typeof sh&&(sh.tonyuc=function(e){var t=c(sh.resolve(e));return t.compile()}),c}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(e){return e.klass({initialize:function(e,t){this.options=t||{},this.img=e,this.height=e.height,this.width=e.width;var n=this.newImage(e.width,e.height),r=n.getContext("2d");r.drawImage(e,0,0),this.ctx=r,this.pixels=this.ctx.getImageData(0,0,e.width,e.height).data,this.base=this.getPixel(0,0)},newImage:function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n},getPixel:function(e,t){var n=this.pixels,r=4*(e+t*this.width),i=n[0+r],o=n[1+r],a=n[2+r],s=n[3+r];return 256*(256*(256*s+a)+o)+i},setPixel:function(e,t,n){var r=4*(e+t*this.width);this.pixels[0+r]=255&n,n=(n-(255&n))/256,this.pixels[1+r]=255&n,n=(n-(255&n))/256,this.pixels[2+r]=255&n,n=(n-(255&n))/256,this.pixels[3+r]=255&n},parse:function(){try{for(var e=[],t=0;t<this.height;t++)for(var n=0;n<this.width;n++){var r=this.getPixel(n,t);r!=this.base&&e.push(this.parse1Pattern(n,t))}return e}catch(i){if(i.isParseError)return console.log("parse error! "+i),{image:this.img,x:0,y:0,width:this.width,height:this.height};throw i}},parse1Pattern:function(e,t){function n(e){return e}function r(e,t,n){return{toString:function(){return"at ("+e+","+t+") :"+n},isParseError:!0}}for(var i=this.getPixel(e,t),o=e,a=t,s=this.base,u=this.width,c=this.height;u>o;){var f=this.getPixel(o,a);if(f!=i)break;o++}if(o>=u||this.getPixel(o,a)!=s)throw r(o,a,n(this.getPixel(o,a))+"!="+n(s));for(o--;c>a&&this.getPixel(o,a)==i;)a++;if(a>=c||this.getPixel(o,a)!=s)throw r(o,a,n(this.getPixel(o,a))+"!="+n(s));a--;var l=e+1,p=t+1,d=o-l,h=a-p;if(console.log("PP",l,p,d,h,o,a),d*h==0)throw r(o,a,"w*h==0");for(var m=this.newImage(d,h),g=m.getContext("2d"),v=g.getImageData(0,0,d,h),y=v.data,b=0,x=p;a>x;x++)for(var w=l;o>w;w++){var T=this.getPixel(w,x);T==i?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&T,T=(T-(255&T))/256,y[b++]=255&T,T=(T-(255&T))/256,y[b++]=255&T,T=(T-(255&T))/256,y[b++]=255&T)}g.putImageData(v,0,0);for(var S=p-1;a>=S;S++)for(var E=l-1;o>=E;E++)this.setPixel(E,S,s);return this.options.boundsInSrc?{x:l,y:p,width:d,height:h}:{image:m,x:0,y:0,width:d,height:h}}})}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu"],function(e,t,n){var r={};return r.resolve=function(n,r){if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,n){return e[n]}),e.urlAliases[n]&&(n=e.urlAliases[n]),t.startsWith(n,"ls:")){var i=n.substring("ls:".length);if(!r)throw new Error("Basedir not specified");var o=r.rel(i);if(!o.exists())throw new Error("Resource file not found: "+o);if(e.mp3Disabled&&i.match(/\.mp3$/)){var a=r.rel(i.replace(/\.mp3$/,".ogg"));a.exists()&&(o=a)}n=o.text()}return n},n.Assets=r,r}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets"],function(e,t,n){function r(e){var t=[];return e.forEach(function(e){e&&""!=e.url&&t.push(e)}),t}var i,o={};return i=function(t,n,a){a||(a={}),t=r(t);var s=[],u=t.length;t.forEach(function(t,r){function c(){var i,o;if((i=t.pwidth)&&(o=t.pheight)){for(var a=0,c=0,f=this.width,l=this.height,p=[];;){var d=i,h=o;if(a+i>f&&(d=f-a),c+o>l&&(h=l-c),p.push({image:this,x:a,y:c,width:d,height:h}),a+=i,a+i>f&&(a=0,c+=o,c+o>l))break}s[r]=p}else{var m=new e(this);s[r]=m.parse()}if(s[r].name=t.name,u--,0==u){var g=[],v={};s.forEach(function(e){v[e.name]=g.length,g=g.concat(e)}),g.names=v,n(g)}}console.log("loading",t,r);var f=t.url,l=f;if(o[l])return void c.apply(o[l],[]);f=i.convURL(f,a.baseDir);var p=$("<img>");p.load(function(){o[l]=this,c.apply(this,[])}),p.attr("src",f)})},i.load=i,i.parse1=function(t,n,r){var i,o,a;if((i=t.pwidth)&&(o=t.pheight)){for(var s=0,u=0,c=n.width,f=n.height,l=[];;)if(l.push({image:this,x:s,y:u,width:i,height:o}),s+=i,s+i>c&&(s=0,u+=o,u+o>f))break;a=l}else{var p=new e(n,r);a=p.parse()}return a.name=t.name,a},i.convURL=function(e,t){return n.resolve(e,t)},window.ImageList=i,i}),requireSimulator.setName("typeCheck"),"function"!=typeof define&&(define=require("requirejs").define),define(["Visitor"],function(){return TypeCheck=function(){}}),requireSimulator.setName("Auth"),define(["WebSite"],function(e){var t={};return t.currentUser=function(t){$.ajax({type:"get",url:e.serverTop+"/currentUser",data:{withCsrfToken:!0},success:function(e){console.log("auth.currentUser",e),e=JSON.parse(e);var n=e.user;"null"==n&&(n=null),console.log("user",n,"csrfToken",e.csrfToken),t(n,e.csrfToken)}})},t.assertLogin=function(n){t.currentUser(function(t,r){return t?n.success(t,r):(window.onLoggedIn=n.success,void n.showLoginLink(e.serverTop+"/login"))})},window.Auth=t,t}),requireSimulator.setName("Blob"),define(["Auth","WebSite","Util"],function(e,t,n){var r={},i="${blobPath}";return r.BLOB_PATH_EXPR=i,r.upload=function(e,n,r,i){var o=new FormData(document.getElementById("fileinfo"));i.error&&(i.error=function(e){alert(e)}),o.append("theFile",r),o.append("user",e),o.append("project",n),o.append("fileName",r.name),$.ajax({type:"get",url:t.serverTop+"/blobURL",success:function(e){$.ajax({url:e,type:"POST",data:o,processData:!1,contentType:!1,success:function(e){console.log("Res = "+e),i.success.apply({},arguments)},error:i.error})}})},r.isBlobURL=function(e){if(n.startsWith(e,i)){var t=e.split("/");return{user:t[1],project:t[2],fileName:t[3]}}},r.url=function(e,n,r){return t.blobPath+e+"/"+n+"/"+r},r.uploadToExe=function(e,n){var r=e.getBlobInfos(),i=r.length;return console.log("uploadBlobToExe cnt=",i),0==i?n.success():(n.progress||(n.progress=function(e){console.log("uploadBlobToExe cnt=",e)}),void r.forEach(function(e){var r={csrfToken:n.csrfToken};for(var o in e)r[o]=e[o];$.ajax({type:"get",url:t.serverTop+"/uploadBlobToExe",data:r,success:function(){return i--,0==i?n.success():void n.progress(i)},error:n.error})}))},r}),requireSimulator.setName("ImageRect"),define([],function(){function e(t,n){if("string"==typeof t){var r=new Image,i=null,o=null,a=function(e){e&&(o=e),o&&i&&o(i)};return r.onload=function(){i=e(r,n),a()},r.src=t,a}var s=n.width,u=n.height,c=n.getContext("2d"),f=t.width,l=t.height,p=u/l*f,d=s/f*l;d>u&&(d=u),p>s&&(p=s),c.clearRect(0,0,s,u);var h=Math.floor((s-p)/2),m=Math.floor((u-d)/2);return c.drawImage(t,0,0,f,l,h,m,p,d),{left:h,top:m,width:p,height:d,src:t}}return e}),requireSimulator.setName("thumbnail"),define(["ImageRect"],function(e){function t(t){try{var i=Tonyu.globals.$Screen.buf[0],o=$("<canvas>").attr({width:100,height:100});e(i,o[0]);var a=o[0].toDataURL(),s=t.getResource(),u=t.getDir(),c=n.file(t);c.text(a);for(var f={name:r,pwidth:100,pheight:100,url:"ls:"+c.relPath(u)},l=s.images,p=!1,d=0;d<l.length;d++)l[d].name==r&&(l[d]=f,p=!0);p||l.push(f),t.setResource(s),console.log("setRSRC",s)}catch(h){console.log("Create thumbnail failed",h)}}var n={},r="$icon_thumbnail";return n.set=function(e,n){setTimeout(function(){t(e)},n)},n.get=function(e){var t=n.file(e);return t.exists()?t.text():null},n.file=function(e){var t=e.getDir(),n=t.rel("images/").rel("icon_thumbnail.png");return n},n}),requireSimulator.setName("plugins"),define(["WebSite"],function(e){function t(e){return"function"==typeof e&&(e={onload:e}),e||(e={}),e.onload||(e.onload=function(){}),e}var n={},r={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/T2Body/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return n.detectNeeded=function(e,t){for(var n in r){var i=r[n].detection.exec(e);i&&(t[n]=1)}return t},n.loaded=function(e){var t=r[e];if(!t)throw new Error("plugin not found: "+e);return window[t.symbol]},n.loadAll=function(e,i){function o(){u>=a.length?i.onload():n.load(a[u++],o)}i=t(i);var a=[];for(var s in e)r[s]&&!n.loaded(s)&&a.push(s);var u=0;console.log("loading plugins",a),o()},n.load=function(n,i){var o=r[n];if(!o)throw new Error("plugin not found: "+n);i=t(i);var a=e.pluginTop+"/"+o.src;location.href.match(/^file:/)?($("<script>").attr("src",a).appendTo("body"),setTimeout(i.onload,500)):$.getScript(a,i.onload)},n.request=function(e){if(!n.loaded(e)){var t=new Error("Plugin "+e+" required");t.pluginName=e}},n}),requireSimulator.setName("Tonyu.Project"),define(["Tonyu","ProjectCompiler","TError","FS","Tonyu.TraceTbl","ImageList","StackTrace","typeCheck","Blob","thumbnail","WebSite","plugins","Tonyu.Compiler.Semantics","Tonyu.Compiler.JSGenerator","DeferredUtil","compiledProject"],function(e,t,n,r,i,o,a,s,u,c,f,l,p,d,h,m){return e.Project=function(i,s){{var p=t(i);e.extend({},p),r.get(f.tonyuHome)}p.EXT=".tonyu",p.NSP_KER="kernel",p.NSP_USR="user";var d;d=s?t(s):m(p.NSP_KER,f.compiledKernel);var g=e.TraceTbl,v={classes:{},traceTbl:g,options:{compiler:{}}};return p.env=v,p.dumpJS=function(e){function t(e){console.log("Class "+e+":\n"+v.classes[e].src.js)}if(e)t(e);else for(var e in v.classes)t(e)},p.stop=function(){var e=p.runningThread;e&&e.kill();var t=p.runningObj;t&&t.stop&&t.stop()},p.rawRun=function(e){if(f.removeJSOutput){var t=p.getOutputFile();t.exists()&&t.rm()}return p.loadClasses().then(h.throwF(function(){p.fixBootRunClasses(),p.runScriptMode||c.set(p,2e3),p.rawBoot(e)}))},p.getResource=function(){var t=i.rel("res.json");if(t.exists()){var n=t.obj(),r=!1;for(var o in n)for(var a=n[o],s=a.length-1;s>=0;s--)a[s].url||(a.splice(s,1),r=!0);
return r&&p.setResource(n),n}return e.defaultResource},p.hasSoundResource=function(){var e=p.getResource();return e&&e.sounds&&e.sounds.length>0},p.setResource=function(e){var t=i.rel("res.json");t.obj(e)},p.getThumbnail=function(){return c.get(p)},p.convertBlobInfos=function(e){function t(n){if("object"==typeof n)for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];if("url"==i){var a;(a=u.isBlobURL(o))&&(n[i]=[u.BLOB_PATH_EXPR,e,r,a.fileName].join("/"))}t(o)}}var n=p.getResource(),r=p.getName();t(n),p.setResource(n)},p.getBlobInfos=function(){function e(t){if("object"==typeof t)for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if("url"==r){var o;(o=u.isBlobURL(i))&&n.push(o)}e(i)}}var t=p.getResource(),n=[];return e(t),n},p.loadResource=function(t){var n=p.getResource();o(n.images,function(n){var r=e.getGlobal("$Sprites");r&&r.setImageList(n);for(var i in n.names)e.setGlobal(i,n.names[i]);t&&t()})},p.getOptions=function(){v.options=null;var t=i.rel("options.json");return t.exists()&&(v.options=t.obj()),v.options&&!v.options.run&&(v.options=null),v.options||(v.options=e.defaultOptions),p.fixOptions(v.options),v.options},p.fixOptions=function(e){e.compiler||(e.compiler={}),e.compiler.commentLastPos=p.runScriptMode||a.isAvailable(),e.plugins||(e.plugins={},i.each(function(t){t.endsWith(p.EXT)&&l.detectNeeded(t.text(),e.plugins)}))},p.requestPlugin=function(e){if(!l.loaded(e)){var t=p.getOptions();t.plugins[e]=1,p.setOptions(t);var n=new Error("必要なプラグイン"+e+"を追加しました。もう一度実行してください");throw n.pluginName=e,n}},p.loadPlugins=function(e){var t=p.getOptions();l.loadAll(t.plugins,e)},p.fixBootRunClasses=function(){var e=p.getOptions();if(e.run){var t=p.fixClassName(e.run.mainClass),n=p.fixClassName(e.run.bootClass);(t!=e.run.mainClass||n!=e.run.bootClass)&&(e.run.mainClass=t,e.run.bootClass=n,p.setOptions(e))}},p.fixClassName=function(t){if(e.getClass(t))return t;var n,r=t.split("."),i=r.pop();return n=p.NSP_USR+"."+i,e.getClass(n)?n:(n=p.NSP_KER+"."+i,e.getClass(n)?n:t)},p.getNamespace=function(){var e=p.getOptions();return e.compiler&&e.compiler.namespace?e.compiler.namespace:p.isKernelEditable()?p.NSP_KER:p.NSP_USR},p.getDependingProjects=function(){return[d]},p.getOutputFile=function(){var e=p.getOptions();return e.compiler.outputFile?r.resolve(e.compiler.outputFile):i.rel("js/concat.js")},p.setOptions=function(e){e&&(v.options=e);var t=i.rel("options.json"),n=t.exists()?t.text():"",r=JSON.stringify(v.options);n!=r&&(console.log("update option",n,r),t.text(r))},p.rawBoot=function(t){var r=e.getClass(t);if(!r)throw n(t+" というクラスはありません","不明",0);e.runMode=!0;var i=new r,o=e.thread();o.apply(i,"main"),p.runningThread=o,p.runningObj=i,$LASTPOS=0,o.steps()},p.srcExists=function(e,t){var n=null;return t.recursive(function(t){t.truncExt(p.EXT)===e&&(n=t)}),n},p.isKernel=function(t){return s?p.srcExists(t,s):v.classes[p.NSP_KER+"."+t]||e.getClass(p.NSP_KER+"."+t)},p.isKernelEditable=function(){return v.options.kernelEditable},p.getDir=function(){return i},p.getName=function(){return i.name().replace(/\/$/,"")},p.renameClassName=function(e,t){p.compile();var n=p.env.classes;for(var r in n){var i=n[r],o=i.src?i.src.tonyu:null,a=i.annotation,s=[];if(a&&o){for(var u in a)try{var c=a[u],f=c.scopeInfo;if(f&&"class"==f.type&&f.name==e){var l=c.node.pos,d=c.node.len,h=o.text().substring(l,l+d);h==e&&(s.push({pos:l,len:d}),console.log(o.path(),l,d,o.text().substring(l-5,l+d+5),"->",t))}}catch(m){console.log(m)}s=s.sort(function(e,t){return t.pos-e.pos}),console.log(o.path(),s);var g=o.text(),v=g;s.forEach(function(e){g=g.substring(0,e.pos)+t+g.substring(e.pos+e.len)}),v==g||o.isReadOnly()||(console.log("Refact:",o.path(),g),o.text(g))}}},p}}),requireSimulator.setName("Shell2"),define(["Shell","UI","FS","Util"],function(e,t,n,r){var i={};return i.show=function(e){var t=i.embed(e);t.dialog({width:600,height:500})},i.embed=function(){i.d||(i.d=t("div",{title:"Shell"},["div",{$var:"inner"},"Type 'help' to show commands.",["br"]]),i.inner=i.d.$vars.inner,e.prompt());var n=i.d;return n},e.cls=function(){i.d.$vars.inner.empty()},e.prompt=function(){function n(e){return 9==e.which?(e.stopPropagation(),e.preventDefault(),a(),!1):void(13==e.which&&(f.empty(),o(u.val())))}function o(){var n=u.val().replace(/^ */,"").replace(/ *$/,"");if(0!=n.length){var r=n.split(/ +/),i=r.shift(),o=e[i];if("function"!=typeof o)return c.append(i+": command not found.");try{var a=[],s=null;r.forEach(function(e){var t=/^-([A-Za-z_0-9]+)(=(.*))?/.exec(e);t?(s||(s={}),s[t[1]]=null!=t[3]?t[3]:1):a.push(e)}),s&&a.push(s);var f=o.apply(e,a);if(f===e.ASYNC)return;if("object"==typeof f)if(f instanceof Array){var l=t("table"),p=null,d=0;f.forEach(function(e){p||(p=t("tr").appendTo(l)),p.append(t("td",e)),d++,d%3==0&&(p=null)}),l.appendTo(c)}else c.append(JSON.stringify(f));else c.append(f);e.prompt()}catch(h){e.err(h),e.prompt()}}}function a(){var t=u.val(),n=t.split(" "),i=n.pop(),o=[];if(0==n.length)for(var a in e)"function"==typeof e[a]&&r.startsWith(a,i)&&o.push(a);else{var s=e.resolve(i,!1);if(!s)return;var c=s.isDir()?s:s.up();c.each(function(e){r.startsWith(e.path(),s.path())&&o.push(e.name())})}if(1==o.length){var l=i.split("/");l.pop(),l.push(o[0]),n.push(l.join("/")),u.val(n.join(" ")),f.empty()}else f.text(o.join(", "))}var s=t("div",["input",{$var:"cmd",size:40,on:{keydown:n}}],["pre",{$var:"out","class":"shell out"},["div",{$var:"cand","class":"shell cand"}]]),u=s.$vars.cmd,c=s.$vars.out,f=s.$vars.cand;return e.setout({log:function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);c.append(e.join(" ")+"\n")},err:function(e){c.append(t("div",{"class":"shell error"},e,["br"],["pre",e.stack]))}}),s.appendTo(i.inner),u.focus(),i.inner.closest(".ui-dialog-content").scrollTop(i.inner.height()),e.ASYNC},e.window=function(){i.show(e.cwd)},e.atest=function(e,t,n){console.log(e,t,n)},i}),requireSimulator.setName("ProjectOptionsEditor"),define(["UI"],function(e){return function(t){var n=t.getOptions();t.odiag||(t.odiag=e("div",{title:"プロジェクト オプション"},["h5","コンパイラ"],["div",["input",{type:"checkbox",$edit:"compiler.diagnose"}],"診断モード(速度が落ちますが，プログラムの不具合を見つけやすくします)"],["div","デフォルトの親クラス",["input",{$edit:"compiler.defaultSuperClass"}]],["h5","実行"],["div","Main クラス",["input",{$edit:"run.mainClass"}]],["div","Boot クラス",["input",{$edit:"run.bootClass"}]],["h5","開発"],["div",["input",{type:"checkbox",$edit:"kernelEditable"}],"Kernelの開発を行う"],["div",{$var:"validationMessage",css:{color:"red"}}])),t.odiag.$edits.load(n),t.odiag.dialog({width:600,buttons:{OK:function(){t.odiag.dialog("close"),t.setOptions()}}})}}),requireSimulator.setName("copyToKernel"),requirejs(["Shell","FS","WebSite"],function(e,t,n){e.copyToKernel=function(r){var i=t.get(n.tonyuHome),o=i.rel("Kernel/");if(r)return e.cp(r,o.rel(r));var a=0;return o.each(function(t){var n=e.cwd.rel(t.name());n.exists()&&(a+=e.cp(n,o))}),a}}),requireSimulator.setName("KeyEventChecker"),define([],function(){var e={};return e.down=function(t,n,r){t instanceof $||(t=$(t)),t.bind("keydown",function(i){return e.is(i,n)?r.call(t[0],i):void 0})},e.is=function(e,t){t=t.toLowerCase(),e=e.originalEvent||e;var n="";return e.altKey&&(n+="alt+"),e.ctrlKey&&(n+="ctrl+"),e.shiftKey&&(n+="shift+"),n+=e.keyCode>=112&&e.keyCode<=123?"f"+(e.keyCode-111):String.fromCharCode(e.keyCode),n=n.toLowerCase(),t==n},e}),requireSimulator.setName("IFrameDialog"),define([],function(){var e={};return e.create=function(e,t){t=t||{title:"help",topPage:"index"},t.height||(t.height=.7*$(window).height()),t.width||(t.width=500);var n=$("<iframe>").attr({"class":"wikiDialog",frameBorder:0,src:e}),r=$("<div>").attr({"class":"wikiDialog",title:t.title}).append(n);return{show:function(){r.dialog({width:t.width,height:t.height,resize:function(){}})}}},e}),requireSimulator.setName("T2MediaLib");var T2MediaLib_BGMPlayer=function(e){this.id=e,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1};T2MediaLib_BGMPlayer.prototype.playBGM=function(e,t,n,r,i){if(!T2MediaLib.context)return null;var o=this.playingBGM;return o instanceof AudioBufferSourceNode&&o.stop(0),this.playingBGM=T2MediaLib.playSE(e,this.bgmVolume,this.bgmTempo,n,t,r,i),this.playingBGMName=e,this.bgmPause=0,this.playingBGM},T2MediaLib_BGMPlayer.prototype.stopBGM=function(){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?(e.stop(0),this.playingBGM=null,e):null},T2MediaLib_BGMPlayer.prototype.pauseBGM=function(){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?(0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=e.loopStart,this.bgmPauseLoopEnd=e.loopEnd,this.bgmPauseLoop=e.loop,this.bgmPauseCurrentTime=e.context.currentTime,this.bgmPauseTempo=T2MediaLib.bgmTempo,e.stop(0),this.bgmPause=1),e):null},T2MediaLib_BGMPlayer.prototype.resumeBGM=function(){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?(1===this.bgmPause&&(e=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd),this.bgmPause=0),e):null},T2MediaLib_BGMPlayer.prototype.setBGMVolume=function(e){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?(this.bgmVolume=e,void T2MediaLib.setSEVolume(t,e)):null},T2MediaLib_BGMPlayer.prototype.setBGMTempo=function(e){var t=this.playingBGM;return t instanceof AudioBufferSourceNode?(0===this.bgmPause&&(t.plusTime-=(T2MediaLib.context.currentTime-t.playStartTime)*(e-this.bgmTempo)),this.bgmTempo=e,void T2MediaLib.setSERate(t,e)):null},T2MediaLib_BGMPlayer.prototype.getBGMCurrentTime=function(){var e=this.playingBGM;if(!(e instanceof AudioBufferSourceNode))return null;var t,n,r,i,o,a,s;return 0===this.bgmPause?(r=T2MediaLib.context.currentTime,i=this.bgmTempo):(r=this.bgmPauseCurrentTime,i=this.bgmPauseTempo),n=(r-e.playStartTime)*i+e.plusTime,e.loop&&(e.loopEnd-e.loopStart>0?n<e.loopStart?(o=0,a=0,s=e.buffer.duration):(o=e.loopStart,a=e.loopStart,s=e.loopEnd-e.loopStart):(s=e.buffer.duration,o=0,a=0)),e.loop?t=(n-a)%s+o:(t=n,t>e.buffer.duration&&(t=e.buffer.duration)),t},T2MediaLib_BGMPlayer.prototype.getBGMLength=function(){var e=this.playingBGM;return e instanceof AudioBufferSourceNode?e.buffer.duration:null};var T2MediaLib={context:null,seDataAry:{data:[]},bgmPlayerMax:16,bgmPlayerAry:[],playingBGM:null,playingBGMName:null,bgmPause:0,bgmPauseTime:0,bgmPauseCurrentTime:0,bgmPauseTempo:0,bgmPauseLoop:!1,bgmPauseLoopStart:0,bgmPauseLoopEnd:0,bgmVolume:1,bgmTempo:1,playingAudio:null,audioVolume:1,audioTempo:1,audioDataAry:{data:[]},init:function(){if(!this.inited&&(this.inited=!0,!this.disabled&&(window.AudioContext?T2MediaLib.context=new AudioContext:window.webkitAudioContext?T2MediaLib.context=new webkitAudioContext:(T2MediaLib.context=null,console.log("Your browser does not support yet Web Audio API")),T2MediaLib.context)))for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.bgmPlayerAry[e]=new T2MediaLib_BGMPlayer(e)},allClearData:function(){var e=T2MediaLib.seDataAry.data;for(var t in e)delete e[t]},clearData:function(e){var t=T2MediaLib.seDataAry.data;delete t[e]},loadSEFromArray:function(e,t){for(var n=T2MediaLib.context,r=n.createBuffer(1,t.length,n.sampleRate),i=r.getChannelData(0),o=0;o<t.length;o++)i[o]=t[o];T2MediaLib.seDataAry.data[e]=r},loadSE:function(e,t,n){if(!T2MediaLib.context||T2MediaLib.disabled)return T2MediaLib.seDataAry.data[e]=-1,null;"object"==typeof WebSite&&WebSite.mp3Disabled&&(t=t.replace(/\.mp3$/,".ogg"));var r=new XMLHttpRequest;r.onload=function(){if(200===r.status||0===r.status){var i=r.response;if(i instanceof ArrayBuffer){var o=function(t){T2MediaLib.seDataAry.data[e]=t,n&&n.succ&&n.succ(e)},a=function(r){r instanceof Error?console.log("T2MediaLib: "+r.message,t):console.log("T2MediaLib: Error decodeAudioData()",t),T2MediaLib.seDataAry.data[e]=-4,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])};T2MediaLib.context.decodeAudioData(i,o,a)}else T2MediaLib.seDataAry.data[e]=-3,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])}else T2MediaLib.seDataAry.data[e]=-2,n&&n.err&&n.err(e,T2MediaLib.seDataAry.data[e])},r.onerror=function(t){n&&n.err&&n.err(e,t+"")},T2MediaLib.seDataAry.data[e]=null,t.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer?(r={onload:r.onload},r.response=Util.Base64_To_ArrayBuffer(t.replace(/^data:audio\/[a-zA-Z0-9]+;base64,/i,"")),r.status=200,r.onload()):(r.open("GET",t,!0),r.responseType="arraybuffer",r.send(null))},activate:function(){if(this.init(),!this.isActivated){this.isActivated=!0;for(var e=T2MediaLib.context,t=e.createBuffer(1,Math.floor(e.sampleRate/32),e.sampleRate),n=t.getChannelData(0),r=Math.floor(e.sampleRate/860),i=0;i<n.length;i++)n[i]=(r/2>i%r?.1:-.1)*(r>i?2:1);var o=e.createBufferSource();o.buffer=t,o.connect(e.destination),o.noteOn?o.noteOn(0):o.start&&o.start(0)}},playSE:function(e,t,n,r,i,o,a){if(!T2MediaLib.context)return null;var s=T2MediaLib.seDataAry.data[e];if(!(s instanceof AudioBuffer))return null;null===t&&(t=1),n||(n=1),r?r>s.duration?r=s.duration:0>r&&(r=0):r=0,i||(i=!1),o?0>o?o=0:o>s.duration&&(o=s.duration):o=0,a?0>a?a=0:a>s.duration&&(a=s.duration):a=s.duration;var u=T2MediaLib.context.createBufferSource();T2MediaLib.context.createGain=T2MediaLib.context.createGain||T2MediaLib.context.createGainNode;var c=T2MediaLib.context.createGain();u.buffer=s,u.loop=i,u.loopStart=o,u.loopEnd=a,u.playbackRate.value=n,u.connect(c),c.connect(T2MediaLib.context.destination);var f;return f=i&&a-o>0&&r>a?a:r,u.gainNode=c,u.playStartTime=T2MediaLib.context.currentTime,u.playOffset=f,u.plusTime=f,u.start=u.start||u.noteOn,u.stop=u.stop||u.noteOff,c.gain.value=t*t,r?i?u.start(0,r,86400):u.start(0,r):u.start(0),u.onended=function(){delete u.gainNode,u.onended=null},u},stopSE:function(e){return e instanceof AudioBufferSourceNode?(e.stop(0),e):null},setSEVolume:function(e,t){return e instanceof AudioBufferSourceNode?void(e.gainNode.gain.value=t*t):null},setSERate:function(e,t){return e instanceof AudioBufferSourceNode?void(e.playbackRate.value=t):null},getSEData:function(e){return T2MediaLib.seDataAry.data[e]},loadBGM:function(e,t,n){return T2MediaLib.loadSE(e,t,n)},playBGM:function(e,t,n,r,i,o){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var a=T2MediaLib.bgmPlayerAry[e];return a instanceof T2MediaLib_BGMPlayer?a.playBGM(t,n,r,i,o):null},stopBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.stopBGM():null},pauseBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.pauseBGM():null},resumeBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.resumeBGM():null},setBGMVolume:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMVolume(t):null},setBGMTempo:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var n=T2MediaLib.bgmPlayerAry[e];return n instanceof T2MediaLib_BGMPlayer?n.setBGMTempo(t):null},getBGMCurrentTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMCurrentTime():null},getBGMLength:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLength():null},getBGMData:function(e){return T2MediaLib.getSEData(e)},getBGMPlayerMax:function(){return T2MediaLib.bgmPlayerMax},allStopBGM:function(){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.stopBGM(e)},loadAudio:function(e,t){var n=new Audio(t);n.play(),T2MediaLib.audioDataAry.data[e]=null,n.addEventListener("loadstart",function(){if(!T2MediaLib.context)return null;var e=T2MediaLib.context.createMediaElementSource(n);e.connect(T2MediaLib.context.destination)},!1),n.addEventListener("canplay",function(){T2MediaLib.audioDataAry.data[e]=n},!1),n.load()},playAudio:function(e,t,n){var r=T2MediaLib.audioDataAry.data[e];return r?(n||(n=0),T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.pause(),T2MediaLib.playingAudio.currentTime=0),T2MediaLib.playingAudio=r,r.loop=t,r.volume=T2MediaLib.audioVolume,r.currentTime=n,r.play(),r):null},stopAudio:function(){var e=T2MediaLib.playingAudio;return e instanceof Audio?(e.pause(),e.currentTime=0,T2MediaLib.playingAudio=null,e):null},pauseAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.pause(),e):null},resumeAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.play(),e):null},setAudioVolume:function(e){T2MediaLib.audioVolume=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.volume=e)},setAudioTempo:function(e){T2MediaLib.audioTempo=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.playbackRate=e)},setAudioPosition:function(e){T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.currentTime=e)},getAudioData:function(e){return T2MediaLib.audioDataAry.data[e]},getAudioCurrentTime:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.currentTime:null},getAudioLength:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.duration:null}};requireSimulator.setName("runtime"),requirejs(["ImageList","T2MediaLib"],function(){}),requireSimulator.setName("difflib"),__whitespace={" ":!0,"	":!0,"\n":!0,"\f":!0,"\r":!0},difflib={defaultJunkFunction:function(e){return __whitespace.hasOwnProperty(e)},stripLinebreaks:function(e){return e.replace(/^[\n\r]*|[\n\r]*$/g,"")},stringAsLines:function(e){for(var t=e.indexOf("\n"),n=e.indexOf("\r"),r=t>-1&&n>-1||0>n?"\n":"\r",i=e.split(r),o=0;o<i.length;o++)i[o]=difflib.stripLinebreaks(i[o]);return i},__reduce:function(e,t,n){if(null!=n)var r=n,i=0;else{if(!t)return null;var r=t[0],i=1}for(;i<t.length;i++)r=e(r,t[i]);return r},__ntuplecomp:function(e,t){for(var n=Math.max(e.length,t.length),r=0;n>r;r++){if(e[r]<t[r])return-1;if(e[r]>t[r])return 1}return e.length==t.length?0:e.length<t.length?-1:1},__calculate_ratio:function(e,t){return t?2*e/t:1},__isindict:function(e){return function(t){return e.hasOwnProperty(t)}},__dictget:function(e,t,n){return e.hasOwnProperty(t)?e[t]:n},SequenceMatcher:function(e,t,n){this.set_seqs=function(e,t){this.set_seq1(e),this.set_seq2(t)},this.set_seq1=function(e){e!=this.a&&(this.a=e,this.matching_blocks=this.opcodes=null)},this.set_seq2=function(e){e!=this.b&&(this.b=e,this.matching_blocks=this.opcodes=this.fullbcount=null,this.__chain_b())},this.__chain_b=function(){for(var e=this.b,t=e.length,n=this.b2j={},r={},i=0;i<e.length;i++){var o=e[i];if(n.hasOwnProperty(o)){var a=n[o];t>=200&&100*a.length>t?(r[o]=1,delete n[o]):a.push(i)}else n[o]=[i]}for(var o in r)r.hasOwnProperty(o)&&delete n[o];var s=this.isjunk,u={};if(s){for(var o in r)r.hasOwnProperty(o)&&s(o)&&(u[o]=1,delete r[o]);for(var o in n)n.hasOwnProperty(o)&&s(o)&&(u[o]=1,delete n[o])}this.isbjunk=difflib.__isindict(u),this.isbpopular=difflib.__isindict(r)},this.find_longest_match=function(e,t,n,r){for(var i=this.a,o=this.b,a=this.b2j,s=this.isbjunk,u=e,c=n,f=0,l=null,p={},d=[],h=e;t>h;h++){var m={},g=difflib.__dictget(a,i[h],d);for(var v in g)if(g.hasOwnProperty(v)){if(l=g[v],n>l)continue;if(l>=r)break;m[l]=k=difflib.__dictget(p,l-1,0)+1,k>f&&(u=h-k+1,c=l-k+1,f=k)}p=m}for(;u>e&&c>n&&!s(o[c-1])&&i[u-1]==o[c-1];)u--,c--,f++;for(;t>u+f&&r>c+f&&!s(o[c+f])&&i[u+f]==o[c+f];)f++;for(;u>e&&c>n&&s(o[c-1])&&i[u-1]==o[c-1];)u--,c--,f++;for(;t>u+f&&r>c+f&&s(o[c+f])&&i[u+f]==o[c+f];)f++;return[u,c,f]},this.get_matching_blocks=function(){if(null!=this.matching_blocks)return this.matching_blocks;for(var e,t,n,r,i,o,a,s,u,c=this.a.length,f=this.b.length,l=[[0,c,0,f]],p=[];l.length;)i=l.pop(),e=i[0],t=i[1],n=i[2],r=i[3],u=this.find_longest_match(e,t,n,r),o=u[0],a=u[1],s=u[2],s&&(p.push(u),o>e&&a>n&&l.push([e,o,n,a]),t>o+s&&r>a+s&&l.push([o+s,t,a+s,r]));p.sort(difflib.__ntuplecomp);var d=j1=k1=block=0,h=[];for(var m in p)p.hasOwnProperty(m)&&(block=p[m],i2=block[0],j2=block[1],k2=block[2],d+k1==i2&&j1+k1==j2?k1+=k2:(k1&&h.push([d,j1,k1]),d=i2,j1=j2,k1=k2));return k1&&h.push([d,j1,k1]),h.push([c,f,0]),this.matching_blocks=h,this.matching_blocks},this.get_opcodes=function(){if(null!=this.opcodes)return this.opcodes;var e=0,t=0,n=[];this.opcodes=n;var r,i,o,a,s,u=this.get_matching_blocks();for(var c in u)u.hasOwnProperty(c)&&(r=u[c],i=r[0],o=r[1],a=r[2],s="",i>e&&o>t?s="replace":i>e?s="delete":o>t&&(s="insert"),s&&n.push([s,e,i,t,o]),e=i+a,t=o+a,a&&n.push(["equal",i,e,o,t]));return n},this.get_grouped_opcodes=function(e){e||(e=3);var t=this.get_opcodes();t||(t=[["equal",0,1,0,1]]);var n,r,i,o,a,s;"equal"==t[0][0]&&(n=t[0],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],t[0]=[r,Math.max(i,o-e),o,Math.max(a,s-e),s]),"equal"==t[t.length-1][0]&&(n=t[t.length-1],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],t[t.length-1]=[r,i,Math.min(o,i+e),a,Math.min(s,a+e)]);var u=e+e,c=[],f=[];for(var l in t)t.hasOwnProperty(l)&&(n=t[l],r=n[0],i=n[1],o=n[2],a=n[3],s=n[4],"equal"==r&&o-i>u&&(c.push([r,i,Math.min(o,i+e),a,Math.min(s,a+e)]),f.push(c),c=[],i=Math.max(i,o-e),a=Math.max(a,s-e)),c.push([r,i,o,a,s]));return!c||1==c.length&&"equal"==c[0][0]||f.push(c),f},this.ratio=function(){return matches=difflib.__reduce(function(e,t){return e+t[t.length-1]},this.get_matching_blocks(),0),difflib.__calculate_ratio(matches,this.a.length+this.b.length)},this.quick_ratio=function(){var e,t;if(null==this.fullbcount){this.fullbcount=e={};for(var n=0;n<this.b.length;n++)t=this.b[n],e[t]=difflib.__dictget(e,t,0)+1}e=this.fullbcount;for(var r={},i=difflib.__isindict(r),o=numb=0,n=0;n<this.a.length;n++)t=this.a[n],numb=i(t)?r[t]:difflib.__dictget(e,t,0),r[t]=numb-1,numb>0&&o++;return difflib.__calculate_ratio(o,this.a.length+this.b.length)},this.real_quick_ratio=function(){var e=this.a.length,t=this.b.length;return _calculate_ratio(Math.min(e,t),e+t)},this.isjunk=n?n:difflib.defaultJunkFunction,this.a=this.b=null,this.set_seqs(e,t)}},requireSimulator.setName("diffview"),diffview={buildView:function(e){function t(e,t){var n=document.createElement(e);return n.className=t,n}function n(e,t){var n=document.createElement(e);return n.appendChild(document.createTextNode(t)),n}function r(e,t,n){var r=document.createElement(e);return r.className=t,r.appendChild(document.createTextNode(n)),r}function i(e,i,o,a,s){return o>i?(e.appendChild(n("th",(i+1).toString())),e.appendChild(r("td",s,a[i].replace(/\t/g,"    "))),i+1):(e.appendChild(document.createElement("th")),e.appendChild(t("td","empty")),i)}function o(e,t,i,o,a){e.appendChild(n("th",null==t?"":(t+1).toString())),e.appendChild(n("th",null==i?"":(i+1).toString())),e.appendChild(r("td",a,o[null!=t?t:i].replace(/\t/g,"    ")))}var a=e.baseTextLines,s=e.newTextLines,u=e.opcodes,c=e.baseTextName?e.baseTextName:"Base Text",f=e.newTextName?e.newTextName:"New Text",l=e.contextSize,p=0==e.viewType||1==e.viewType?e.viewType:0;if(null==a)throw"Cannot build diff view; baseTextLines is not defined.";if(null==s)throw"Cannot build diff view; newTextLines is not defined.";if(!u)throw"Canno build diff view; opcodes is not defined.";var d=document.createElement("thead"),h=document.createElement("tr");d.appendChild(h),p?(h.appendChild(document.createElement("th")),h.appendChild(document.createElement("th")),h.appendChild(r("th","texttitle",c+" vs. "+f))):(h.appendChild(document.createElement("th")),h.appendChild(r("th","texttitle",c)),h.appendChild(document.createElement("th")),h.appendChild(r("th","texttitle",f))),d=[d];for(var m,g=[],v=0;v<u.length;v++){code=u[v],change=code[0];for(var y=code[1],b=code[2],x=code[3],w=code[4],T=Math.max(b-y,w-x),S=[],E=[],N=0;T>N;N++){if(l&&u.length>1&&(v>0&&N==l||0==v&&0==N)&&"equal"==change){var k=T-(0==v?1:2)*l;if(k>1){if(S.push(h=document.createElement("tr")),y+=k,x+=k,N+=k-1,h.appendChild(n("th","...")),p||h.appendChild(r("td","skip","")),h.appendChild(n("th","...")),h.appendChild(r("td","skip","")),v+1==u.length)break;continue}}S.push(h=document.createElement("tr")),p?"insert"==change?o(h,null,x++,s,change):"replace"==change?(E.push(m=document.createElement("tr")),b>y&&o(h,y++,null,a,"delete"),w>x&&o(m,null,x++,s,"insert")):"delete"==change?o(h,y++,null,a,change):o(h,y++,x++,a,change):(y=i(h,y,b,a,change),x=i(h,x,w,s,change))}for(var N=0;N<S.length;N++)g.push(S[N]);for(var N=0;N<E.length;N++)g.push(E[N])}g.push(h=r("th","author","diff view generated by ")),h.setAttribute("colspan",p?3:4),h.appendChild(m=n("a","jsdifflib")),m.setAttribute("href","http://github.com/cemerick/jsdifflib"),d.push(h=document.createElement("tbody"));for(var v in g)g.hasOwnProperty(v)&&h.appendChild(g[v]);h=t("table","diff"+(p?" inlinediff":""));for(var v in d)d.hasOwnProperty(v)&&h.appendChild(d[v]);return h}},requireSimulator.setName("DiffDialog"),define(["UI","difflib","diffview"],function(e,t,n){var r={};return r.show=function(e,t,n){var i=r.embed(e,t,n);i.dialog({width:600,height:500})},r.embed=function(i,o){function a(e){return e&&!e.isDir()&&e.exists()}if(!r.d){var s={fromVal:function(e){return""==e?null:FS.get(e)},toVal:function(e){return e?e.path():""}};r.d=e("div",{title:"比較"},["div",["input",{style:"background-color: #f88;",$edit:{name:"baseFile",type:s},size:60}],["br"],["input",{style:"background-color: #8f8;",$var:"newFile",$edit:{name:"newFile",type:s},size:60}]],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){r.done()}}},"比較"],["div",{$var:"diffoutput",css:{height:"350px",overflow:"scroll"}}])}var u=r.d,c={baseFile:i,newFile:o};return u.$edits.load(c),u.$edits.validator.on.validate=function(e){a(e.newFile)?a(e.baseFile)?this.allOK():this.addError("base",i+"は存在しないか，ディレクトリです"):this.addError("new",o+"は存在しないか，ディレクトリです")},r.done=function(){for(var e=t.stringAsLines(c.baseFile.text()),r=t.stringAsLines(c.newFile.text()),i=new t.SequenceMatcher(e,r),o=i.get_opcodes(),a=u.$vars.diffoutput[0];a.firstChild;)a.removeChild(a.firstChild);contextSize=null,a.appendChild(n.buildView({baseTextLines:e,newTextLines:r,opcodes:o,baseTextName:c.baseFile+"",newTextName:c.newFile+"",contextSize:contextSize,viewType:1}))},a(c.baseFile)&&a(c.newFile)&&r.done(),u},r}),requireSimulator.setName("KernelDiffDialog"),define(["UI","DiffDialog","Shell"],function(e,t){function n(e,n){return function(){t.show(e,n)}}var r={};return r.show=function(e,t,n){var i=r.embed(e,t,n);i.dialog({width:250,height:400})},r.embed=function(t,i){r.d||(r.d=e("div",{title:"Kernel比較"},["div",{$var:"out"}],["button",{$var:"OKButton",on:{click:function(){r.refresh()}}},"更新"]));var o=r.d;return r.refresh=function(){var r=o.$vars.out;r.empty(),i.each(function(o){var a=t.rel(o.relPath(i));o.endsWith(".tonyu")&&a.exists()&&r.append(o.text()==a.text()?e("div",o.name(),"(同一)"):e("div",["a",{href:"javascript:;",on:{click:n(a,o)}},o.name()]))})},r.refresh(),o},r}),requireSimulator.setName("requestFragment"),define(["WebSite"],function(e){var t={};return t.ajax=function(t){function n(e){return t.redirectTo&&(e.redirectTo=t.redirectTo),e}function r(){$.ajax({type:"post",url:e.serverTop+"/runFragments",data:n({id:s}),success:function(e){return"string"==typeof e&&e.match(/^notCompleted:([\-\d]+)\/([\-\d]+)$/)?(console.log("notcomp",e),f*=2,void setTimeout(r,f)):void t.success(e)},error:t.error,complete:t.complete})}var i=t.THRESH||8e5,o=t.data;if("object"!=typeof o)throw"Data should be object: "+o;if(o=JSON.stringify(o),!t.redirectTo&&("GAE"!=e.serverType||o.length<i))return $.ajax(t);for(var a=[],s=Math.random();o.length>0;)a.push(o.substring(0,i)),o=o.substring(i);var u=a.length,c=0,f=1e3;a.forEach(function(i,o){$.ajax({type:"post",url:e.serverTop+"/sendFragment",data:n({id:s,seq:o,len:u,content:i}),success:function(e){console.log("sendFrag",e,o),c++,c>=u&&setTimeout(r,f)},error:t.error})})},t}),requireSimulator.setName("Sync"),define(["FS","Shell","requestFragment","WebSite"],function(e,t,n,r){function i(e){return e&&e.isDir}var o={};return t.sync=function(){function e(e){return function(){e&&e.apply({},arguments),t.prompt()}}var n,r,a,s=function(){},u=0;return("string"==typeof arguments[u]||i(arguments[u]))&&(n=t.resolve(arguments[u],!0),u++,("string"==typeof arguments[u]||i(arguments[u]))&&(r=t.resolve(arguments[u],!1),u++)),"object"==typeof arguments[u]&&(a=arguments[u],u++),"function"==typeof arguments[u]&&(s=arguments[u],u++),n||(r=n=t.cwd),a&&a.onend&&(a.onend=e(a.onend)),r||(r=n),t.echo("sync args=",n,r,a,s),o.sync(n,r,a,e(s)),t.ASYNC},o.sync=function(){function e(e,n){t.echo("Status: "+e+" param:",n),d.onstatus&&d.onstatus(e,n)}function o(){d.onerror&&d.onerror.apply(this,arguments)}function a(){var t={base:p.path(),excludes:JSON.stringify(d.excludes)};e("getDirInfo",t),$.ajax({type:"get",url:r.serverTop+"/getDirInfo",data:t,success:s,error:o})}function s(n){d.v&&t.echo("getDirInfo",n);var i=l,a=n.data;for(var s in a){var c=i.rel(s),h=c.metaInfo(),m=a[s];f(c,s,h,m)}l.recursive(function(e){var t=e.metaInfo(),n=e.relPath(l),r=a[n];f(e,n,t,r)},{includeTrashed:!0,excludes:d.excludes}),d.v&&(t.echo("uploads:",g),t.echo("downloads:",v));var y={base:p.path(),paths:JSON.stringify(v)};e("File2LSSync",y),$.ajax({type:"post",url:r.serverTop+"/File2LSSync",data:y,success:u,error:o})}function u(i){t.echo("dlData=",i),d.v&&t.echo("dlData:",i);var a=l;if(!d.test){for(var s in i.data){var u=a.rel(s),f=i.data[s];f.trashed?u.exists()&&u.rm():u.text(f.text),delete f.text,u.metaInfo(f)}var h={base:p.path(),data:JSON.stringify(g)};h.pathInfo="/LS2FileSync",e("LS2FileSync",h),n.ajax({type:"post",url:r.serverTop+"/LS2FileSync",data:h,success:c,error:o})}}function c(e){d.v&&t.echo("LS2FileSync res=",e);var n=[];for(var r in g)n.push(r);e={msg:e,uploads:n,downloads:v},"function"==typeof h&&h(e)}function f(e,n,r,i){if(!y[n])if(y[n]=1,i&&(!r||r.lastUpdate<i.lastUpdate))v.push(n),d.v&&t.echo((r?"":"New")+"Download "+e+" trash="+!!i.trashed);else if(r&&(!i||r.lastUpdate>i.lastUpdate)){var o={text:e.text()},a=e.metaInfo();for(var s in a)o[s]=a[s];g[n]=o,d.v&&t.echo((i?"":"New")+"Upload "+e+" trash="+!!r.trashed)}}var l,p,d,h,m=0;if(i(arguments[m])&&(l=arguments[m],m++,i(arguments[m])&&(p=arguments[m],m++)),"object"==typeof arguments[m]&&(d=arguments[m],m++),"function"==typeof arguments[m]&&(h=arguments[m],m++),!l)throw"Sync.sync: Local dir must be specified as file object";p||(p=l),d||(d={}),!h&&d.onend&&(h=d.onend),d.test&&(d.v=1),a();var g={},v=[],y={}},t.rsh=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return $.ajax({url:r.serverTop+"/rsh",data:{args:JSON.stringify(e)},success:function(e){t.echo(e)},error:function(e,n,r){t.err(r)},complete:function(){t.prompt()}}),t.ASYNC},o}),requireSimulator.setName("searchDialog"),define(["UI","Shell"],function(e,t){var n={};return n.show=function(e,t){var r=n.embed(e,t);r.dialog({width:600})},n.embed=function(r,i){n.d||(n.d=e("div",{title:"検索"},["div",["span","検索語"],["input",{$edit:"word",on:{enterkey:function(){n.d.start()}}}]],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){n.d.start()}}},"検索"],["div",{style:"overflow-y:scroll; height:200px"},["table",{$var:"searchRes"}]]));var o=n.d,a={word:""};return o.$edits.load(a),o.start=function(){o.$vars.searchRes.empty();var n=t.grep(a.word,r);n.forEach(function(t){function n(){i&&i(t)}"concat.js"!=t.file.name()&&o.$vars.searchRes.append(e("tr",["td",{on:{click:n}},t.file.name()+"("+t.lineNo+")"],["td",{on:{click:n}},t.line]))})},o},n}),requireSimulator.setName("syncWithKernel"),requirejs(["Shell","FS","WebSite"],function(e,t,n){e.syncWithKernel=function(r){var i=t.get(n.tonyuHome),o=i.rel("Kernel/");if(r){var a=e.resolve(r),s=o.rel(r);return a.lastUpdate()>s.lastUpdate()?(e.cp(a,s,{v:1}),1):a.lastUpdate()<s.lastUpdate()?(e.cp(s,a,{v:1}),1):0}var u=0;return o.each(function(t){var n=e.resolve(t.name());n.exists()&&(u+=e.syncWithKernel(t.name()))
}),u}}),requireSimulator.setName("ImageDetailEditor"),define(["UI","ImageList","ImageRect","PatternParser","WebSite"],function(e,t,n,r,i){function o(t){return e("input",{type:"radio",name:"type",value:t})}function a(){L&&(L.url=_.url.val())}function s(){_.theForm[0].type.value="rc"}function u(){_.theForm[0].type.value="wh"}function c(){var e=_.cv[0].getContext("2d"),t=D;t&&P&&(e.clearRect(t.left,t.top,t.width,t.height),e.drawImage(P,0,0,E,N,t.left,t.top,t.width,t.height),f())}function f(){var e=t.parse1(L,P,{boundsInSrc:!0});console.log("drawFrame",e);var n=_.cv[0].getContext("2d");e.forEach(function(e){m(n,p(e))}),C=e}function l(e,t){return t.left<=e.x&&e.x<=t.left+t.width&&t.top<=e.y&&e.y<=t.top+t.height}function p(e){var t={},n=D.width/E,r=D.height/N;return t.left=D.left+e.x*n,t.top=D.top+e.y*r,t.width=e.width*n,t.height=e.height*r,t}function d(e){var t=_.cv[0].getContext("2d"),n=_.cv.offset(),r={x:e.pageX-n.left,y:e.pageY-n.top};return C?void C.forEach(function(e,n){var i=p(e);if(l(r,i)){var o=C[F];if(o){var a=p(o);m(t,a)}F=n,m(t,i,"#ff0")}}):void console.log("cvMouse")}function h(){var e=C[F];if(e){var t=$+"+"+F;_.patName.val(t),S(t)}}function m(e,t,n){e.strokeStyle=n||"#f0f",e.beginPath(),e.moveTo(t.left,t.top),e.lineTo(t.left+t.width,t.top),e.lineTo(t.left+t.width,t.top+t.height),e.lineTo(t.left,t.top+t.height),e.closePath(),e.stroke()}function g(e,t){return e===e?e:t}function v(){return"rc"!=_.theForm[0].type.value?!1:L?(M=g(parseInt(_.cols.val()),M),k=g(parseInt(_.rows.val()),k),y(),c(),!1):!1}function y(){return L?(L.pwidth=g(Math.floor(E/M),L.pwidth),L.pheight=g(Math.floor(N/k),L.pheight),_.pwidth.val(L.pwidth),void _.pheight.val(L.pheight)):!1}function b(){return"wh"!=_.theForm[0].type.value?!1:L?(L.pwidth=g(parseInt(_.pwidth.val()),L.pwidth),L.pheight=g(parseInt(_.pheight.val()),L.pheight),x(),c(),!1):!1}function x(){return L?(M=g(Math.floor(E/L.pwidth),M),k=g(Math.floor(N/L.pheight),k),_.rows.val(k),void _.cols.val(M)):!1}function w(){if(!L)return!1;delete L.pwidth,delete L.pheight,_.theForm[0].type.value="t1";try{c()}catch(e){alert(e)}return!1}function T(){return j.dialog("close"),A&&A(),!1}function S(e){if(i.isNW){var t=require("nw.gui"),n=t.Clipboard.get();n.set(e,"text")}}var E,N,k,M,L,P,A,D,C,$,j=e("div",{title:"画像詳細"},["div",["div","URL:",["input",{$var:"url",size:40,on:{change:a}}],["a",{$var:"openImg",target:"img"},"画像を確認..."]],["canvas",{$edit:"cv",width:500,height:250,on:{mousemove:d,mousedown:h}}]],["form",{$var:"theForm"},["div",o("rc"),"分割数指定：",["input",{$var:"cols",size:5,on:{realtimechange:v,focus:s}}],"x",["input",{$var:"rows",size:5,on:{realtimechange:v,focus:s}}]],["div",o("wh"),"1パターンの大きさ指定：",["input",{$var:"pwidth",size:5,on:{realtimechange:b,focus:u}}],"x",["input",{$var:"pheight",size:5,on:{realtimechange:b,focus:u}}]],["div",o("t1"),"Tonyu1互換",["button",{on:{click:w}},"解析"]],["div","パターン番号:",["input",{$var:"patName"}]],["button",{on:{click:T}},"OK"]]),_=j.$vars,O={},F=-1;return O.show=function(e,r,i,o){o||(o={}),A=o.onclose,L=e,$=i,j.dialog({width:600,height:520}),_.url.val(L.url);var a=t.convURL(L.url,r);_.openImg.attr("href",a),n(a,_.cv[0])(function(e){D=e,console.log(e),P=e.src,E=P.width,N=P.height,L.pwidth&&L.pheight?(_.pwidth.val(L.pwidth),_.pheight.val(L.pheight),x(),_.theForm[0].type.value="wh"):_.theForm[0].type.value="t1",f()})},O}),requireSimulator.setName("OggConverter"),define(["FS","WebSite"],function(e,t){var n,r={};return t.isNW&&(n=require("child_process").spawn),r.convert=function(r){if(t.isNW){var i=e.get(t.ffmpeg);i.exists()&&r.each(function(e){if(e.endsWith(".mp3")){var t=e.up().rel(e.truncExt(".mp3")+".ogg");if(!t.exists()){console.log("running",i.path(),"-i",e.path(),t.path());var r=n(i.path(),["-i",e.path(),t.path()]);r.stdin.end()}}})}},r}),requireSimulator.setName("ResEditor"),define(["FS","Tonyu","UI","ImageList","Blob","Auth","WebSite","ImageDetailEditor","Util","OggConverter"],function(e,t,n,r,i,o,a,s,u,c){function f(e,t){if("string"==typeof e){var n=new Image;return n.onload=function(){f(n,t)},n.src=e,n}var r=t.width,i=t.height,o=t.getContext("2d"),a=e.width,s=e.height,u=i/s*a,c=r/a*s;c>i&&(c=i),u>r&&(u=r),o.clearRect(0,0,r,i);var l=Math.floor((r-u)/2),p=Math.floor((i-c)/2);o.drawImage(e,0,0,a,s,l,p,u,c)}var l=function(e,t){function l(t){try{return(u.endsWith(t,".ogg")||u.endsWith(t,".mp3"))&&(t=a.urlAliases["images/sound.png"]),r.convURL(t,e.getDir())}catch(n){return a.urlAliases["images/ecl.png"]}}function p(){function r(t){eo=t.originalEvent;var r=eo.dataTransfer.files[0],s="GAE"==a.serverType&&r.size>3e5;if(!r.type.match(g.contentType)[1])return t.stopPropagation(),t.preventDefault(),!1;var u=r.name.replace(g.extPattern,"").replace(/\W/g,"_"),c="";r.name.match(g.extPattern)&&(c=RegExp.lastMatch);var f=g.newItem(u);if(s)o.assertLogin({showLoginLink:function(e){w.css("border","solid red 2px").empty().append(n("div","大きい"+g.name+"を追加するには，ログインが必要です：",["a",{href:e,target:"login",style:"color: blue;"},"ログインする"]))},success:function(t){w.text("アップロード中...");var n=e.getName();i.upload(t,n,r,{success:function(){w.text(m),f.url="${blobPath}/"+t+"/"+n+"/"+r.name,h(f)}})}});else{var l=new FileReader;l.onload=function(){var t=l.result,n=b.rel(u+c);n.text(t),f.url="ls:"+n.relPath(e.getDir()),h(f)},l.readAsDataURL(r)}return t.stopPropagation(),t.preventDefault(),!1}function u(e){e.stopPropagation(),e.preventDefault()}function c(r){function i(){"sound"!=t&&s.show(r,e.getDir(),r.name,{onclose:function(){e.setResource(y),p()}})}function o(){for(var e=T.length-1;e>=0;e--)if(T[e]===r){T.splice(e,1);break}d()}function a(){for(var e=T.length-1;e>=1;e--)if(T[e]===r){T.splice(e,1),T.splice(e-1,0,r);break}d()}function u(){for(var e=T.length-2;e>=0;e--)if(T[e]===r){T.splice(e,1),T.splice(e+1,0,r);break}d()}var c=n("div",{style:"float:left;"},["canvas",{$var:"c",width:100,height:100,"class":"clickable",on:{click:i}}],["div",{style:"float:right;"},["button",{on:{click:o}},"×"],["br"],["button",{on:{click:a}},"←"],["br"],["button",{on:{click:u}},"→"]],["div",["input",{$var:"name",size:12,value:r.name}]]);f(l(r.url),c.$vars.c[0]);var h=c.$vars;return h.data=r,c}function h(e){T.push(e||g.newItem()),d()}v.empty();var m="ここに"+g.name+"ファイル("+g.exts.join("/")+")をドラッグ＆ドロップして追加",w=n("div",{style:"margin:10px; padding:10px; border:solid blue 2px;",on:{dragover:u,dragenter:u,drop:r}},m).appendTo(v);y=e.getResource();var T=y[g.key];x=[];var S=n("div").appendTo(v);T.forEach(function(e){var t=c(e);x.push(t),t.appendTo(S)}),v.append(n("div",{style:"clear:left;"},["button",{on:{click:function(){h()}}},"追加"],["button",{on:{click:function(){v.dialog("close")}}},"完了"]))}function d(){x.forEach(function(e){var t=e.$vars,n=t.data;n.name=t.name.val()}),console.log(y),e.setResource(y),p()}function h(){var n=y[g.key];o.currentUser(function(r,o){if(r){var s=[];n.forEach(function(e){var t,n;(t=i.isBlobURL(e.url))&&(s.push(t.fileName),n=t.fileName.replace(/\.mp3$/,".ogg"),n!=t.fileName&&s.push(n))});var u={user:r,project:e.getName(),mediaType:t,csrfToken:o,retainFileNames:JSON.stringify(s)};console.log("retainBlobs",u),$.ajax({url:a.serverTop+"/retainBlobs",type:"get",data:u})}});var r={};b.each(function(t){r["ls:"+t.relPath(e.getDir())]=t}),y=e.getResource(),n.forEach(function(e){delete r[e.url],delete r[e.url.replace(/\.mp3$/,".ogg")]}),console.log(r);for(var s in r){var u=r[s];console.log(u+" is removed"),u.rm()}}var m={image:{name:"画像",exts:["png","gif","jpg"],path:"images/",key:"images",extPattern:/\.(png|gif|jpe?g)$/,contentType:/image\/(png|gif|jpe?g)/,newItem:function(e){var t={pwidth:32,pheight:32};return e&&(t.name="$pat_"+e),t}},sound:{name:"音声",exts:["mp3","ogg"],path:"sounds/",key:"sounds",extPattern:/\.(mp3|ogg)$/,contentType:/audio\/(mp3|ogg)/,newItem:function(e){var t={};return e&&(t.name="$se_"+e),t}}},g=m[t||"image"],v=n("div",{title:g.name+"リスト"});v.css({height:"200px","overflow-v":"scroll"});var y=e.getResource(),b=e.getDir().rel(g.path),x=[];y||e.setResource(),p(),v.dialog({modal:!0,width:800,height:500,close:function(){d(),h(),"sound"==t&&c.convert(b)}})};return l}),requireSimulator.setName("SoundDiag"),define(["T2MediaLib"],function(e){return SoundDiag={},SoundDiag.show=function(t){function n(){e.init(),e.disabled=!1,e.activate(),console.log("Sound ON"),o.remove(),t()}function r(){e.disabled=!0,console.log("Sound OFF"),o.remove(),t()}var i={fontSize:"2em"};t=t||function(){};var o=$("<div>").css({position:"absolute",left:100,top:100}).append($("<button>").css(i).text("Sound on").click(n)).append($("<button>").css(i).text("Sound off").click(r)).appendTo("body")},SoundDiag}),requireSimulator.setName("MainClassDialog"),define(["UI"],function(e){var t={};return t.show=function(e,n){var r=t.embed(e,n);return r.dialog({width:600}),r},t.embed=function(n,r){r||(r={}),t.d||(t.d=e("div",{title:"実行するクラスを選択"},["div",["select",{$var:"mainClass"}],["div",{$var:"validationMessage",css:{color:"red"}}],["button",{$var:"OKButton",on:{click:function(){t.d.done(!1)}}},"OK"],["button",{$var:"RunButton",on:{click:function(){t.d.done(!0)}}},"実行"]]));var i=t.d,o=t.d.$vars;n.getDir();var a=n.getOptions();return i.done=function(e){a.run.mainClass=o.mainClass.val(),n.setOptions(a),r.on&&r.on.done&&r.on.done(o.mainClass.val(),e),i.dialog("close")},i},t}),requireSimulator.setName("NWMenu"),function(){function e(e,t,n){var r=require("nw.gui"),i=new r.Menu,o=new r.MenuItem({label:e||"Cut",click:function(){document.execCommand("cut"),console.log("Menu:","cutted to clipboard")}}),a=new r.MenuItem({label:t||"Copy",click:function(){document.execCommand("copy"),console.log("Menu:","copied to clipboard")}}),s=new r.MenuItem({label:n||"Paste",click:function(){document.execCommand("paste"),console.log("Menu:","pasted to textarea")}});return i.append(o),i.append(a),i.append(s),i}var t;if("object"!=typeof process)return{};var n=new e;$(document).on("contextmenu",function(e){e.preventDefault();var r={left:0,top:0};t&&(r=parent.$(t).offset(),console.log(r)),n.popup(e.originalEvent.x+Math.floor(r.left),e.originalEvent.y+Math.floor(r.top))});try{var r=require("nw.gui");win=r.Window.get();var i=new r.Menu({type:"menubar"});i.createMacBuiltin("My App"),win.menu=i}catch(o){console.log(o.message)}return parent&&parent.$("iframe").each(function(){var e=this.contentDocument||this.contentWindow.document;e===document&&(t=this)}),{}}(),requireSimulator.setName("ide/editor"),requirejs(["Util","Tonyu","FS","FileList","FileMenu","showErrorPos","fixIndent","Wiki","Tonyu.Project","Shell","Shell2","ProjectOptionsEditor","copyToKernel","KeyEventChecker","IFrameDialog","runtime","KernelDiffDialog","Sync","searchDialog","StackTrace","syncWithKernel","UI","ResEditor","WebSite","exceptionCatcher","Tonyu.TraceTbl","SoundDiag","Log","MainClassDialog","DeferredUtil","NWMenu","ProjectCompiler","compiledProject"],function(e,t,n,r,i,o,a,s,u,c,f,l,p,h,m,g,v,y,b,x,w,T,S,E,N,k,M,L,P,A,D,C){$(function(){function s(e){var t=K.getOptions();t.compiler.diagnose!=e&&(t.compiler.diagnose=e,K.setOptions(t))}function f(){var e=$(window).height()-$("#navBar").height();e-=20,Z=e;var t=$("#runArea").width();$("#progs pre").css("height",e+"px"),console.log("canvas size",t,e),$("#cv").attr("height",e).attr("width",t),cv=$("#cv")[0].getContext("2d"),$("#fileItemList").height(e)}function p(){Q.ls(V),g()}function g(){V.each(function(e){if(e.endsWith(J)){var t=e.truncExt(J);X.indexOf(t)<0&&X.push(t)}});var e;for(e=X.length-1;e>=0;e--){var t=V.rel(X[e]+J);t.exists()||X.splice(e,1)}$("#runMenu").empty(),e=0,X.forEach(function(t){var n=e;"string"!=typeof t&&(console.log(t),alert("not a string: "+t)),n>=15||($("#runMenu").append($("<li>").append($("<a>").attr("href","#").text(t+"を実行"+(0==e?"(F9)":"")).click(U(function(){"string"!=typeof t&&(console.log(t),alert("not a string2: "+t)),D(t),n>0&&(X.splice(n,1),X.unshift(t),g(),q())})))),e++)}),$("#runMenu").append($("<li>").append($("<a>").attr("href","#").text("停止(F2)").click(U(function(){A()})))),$("#runMenu").append($("<li>").append($("<a>").attr("href","#").text("実行するファイルを選択...").click(U(function(){var e=P.show(K,{on:{done:function(e,t){var n=X.indexOf(e);n>0&&(X.splice(n,1),X.unshift(e),g(),q()),t&&D(e)}}});e.$vars.mainClass.empty(),X.forEach(function(t){e.$vars.mainClass.append(T("option",{value:t},t))})})))),$("#exportToJsdoit").attr("href","exportToJsdoit.html?dir="+V.path()),$("#exportToExe").attr("href","exportToExe.html?dir="+V.path())}function y(e){var t=e.name();return e.isDir()?t:e.endsWith(J)?e.truncExt(J):null}function x(e,t){var n=!1;return e.match(/^[a-z]/)&&(e=e.substring(0,1).toUpperCase()+e.substring(1),n=!0),e.match(/^[A-Z_][a-zA-Z0-9_]*$/)?K.isKernel(e)?K.getOptions().kernelEditable?{ok:!0,file:V.rel(e+J),note:"create"==t.action?"Kernelから"+e+"をコピーします":""}:{ok:!1,reason:e+"はシステムで利用されている名前なので使用できません"}:n?{ok:!0,file:V.rel(e+J),note:"先頭を大文字("+e+") にして作成します．"}:{ok:!0,file:V.rel(e+J)}:{ok:!1,reason:"名前は，半角英数字とアンダースコア(_)のみが使えます．先頭は英大文字にしてください．"}}function w(){var e=Q.curFile();return e?Y[e.path()]:null}function k(){var e=w();return e?e.editor:null}function M(e){var t=k();switch(e){case"run":t&&t.blur(),o($("#errorPos")),W&&($("#runAreaParent").show().attr("class","col-xs-12"),$("#mainArea").hide(),f());break;case"compile_error":"undefined"!=typeof SplashScreen&&SplashScreen.hide();break;case"runtime_error":"undefined"!=typeof SplashScreen&&SplashScreen.hide();break;case"edit":W&&($("#runAreaParent").hide(),$("#mainArea").show())}}function A(){K.stop(),M("edit")}function D(e){if(K.stop(),"string"!=typeof e){if(0==X.length)return void alert("ファイルを作成してください");e=X[0]}"string"!=typeof e&&(console.log(e),alert("not a string3: "+e)),F(),M("run"),L.dumpProject(V),"undefined"!=typeof SplashScreen&&SplashScreen.show();var n=K.getOptions();n.run.mainClass!=e&&(n.run.mainClass=e,K.setOptions()),K.rawRun(n.run.bootClass).fail(function(e){e.isTError?(console.log("showErr: run"),o($("#errorPos"),e),M("compile_error")):t.onRuntimeError(e)}).done(function(){"undefined"!=typeof SplashScreen&&SplashScreen.hide()})}function j(e){var t=Y[e.path()];t&&(t.editor.destroy(),t.dom.remove(),delete Y[e.path()])}function _(e){var t=e.getCursorPosition();e.setValue(a(e.getValue())),e.clearSelection(),e.moveCursorTo(t.row,t.column)}function O(){for(var e in Y){var t=Y[e],n=t.file,r=t.editor;n.exists()&&r&&(r.setValue(n.text()),r.clearSelection())}}function F(){var e=w();if(e){var t=e.file,n=e.editor;if(t&&n&&!t.isReadOnly()){_(n);var r=t.text(),i=n.getValue();r!=i&&t.text(i)}Q.setModified(!1)}}function R(){var e=w();if(e){var t=e.file,n=e.editor;Q.setModified(t.text()!=n.getValue())}}function B(e){if(!e.isDir()){F(),rt&&rt.hide();var t=Y[e.path()];if(t)t.dom.show(),t.editor.focus(),rt=t.dom;else{var n=$("<pre>").css("height",Z+"px").text(e.text()).appendTo("#progs"),r=ace.edit(n[0]);"number"==typeof H.editorFontSize&&r.setFontSize(H.editorFontSize),r.setTheme("ace/theme/eclipse"),r.getSession().setMode("ace/mode/tonyu"),Y[e.path()]={file:e,editor:r,dom:n},n.click(U(function(){M("edit")})),r.setReadOnly(!1),r.clearSelection(),r.focus(),rt=n}}}function I(){var e,t=V.rel(".desktop");return e=t.exists()?t.obj():{},e.runMenuOrd||(e.runMenuOrd=[]),H=e}function q(){var e=V.rel(".desktop");e.obj(H)}var U=N.f;$LASTPOS=0;var W=E.mobile||n.get(E.tonyuHome).rel("mobile.txt").exists();W&&($("#fileViewer").hide(),$("#runAreaParent").hide(),$("#mainArea").attr("class","col-xs-12"),$("#fileSel").show());{var G;n.get(E.tonyuHome)}E.kernelDir&&(G=n.get(E.kernelDir),G.exists()&&C(G).loadClasses());var z=e.getQueryString("dir","/Tonyu/Projects/SandBox/"),V=n.get(z),K=u(V);t.globals.$currentProject=K,t.currentProject=K;var J=K.EXT,H=I(),X=H.runMenuOrd;t.defaultResource={images:[{name:"$pat_base",url:"images/base.png",pwidth:32,pheight:32},{name:"$pat_sample",url:"images/Sample.png"},{name:"$pat_neko",url:"images/neko.png",pwidth:32,pheight:32},{name:"$pat_mapchip",url:"images/mapchip.png",pwidth:32,pheight:32},{name:"$pat_inputPad",url:"images/inputPad.png"}],sounds:[]},location.href.match(/^file/)&&t.defaultResource.images.splice(1,1),t.defaultOptions={compiler:{defaultSuperClass:"Actor"},run:{mainClass:"Main",bootClass:"Boot"},kernelEditable:!1},s(!1);var Z;f();var Y={};h.down(document,"F9",U(D)),h.down(document,"F2",U(A)),h.down(document,"ctrl+s",U(function(e){return F(),e.stopPropagation(),e.preventDefault(),!1})),$(window).resize(U(f)),$("body")[0].spellcheck=!1,c.cd(V);var Q=r($(W?"#fileSel":"#fileItemList"),{topDir:V,on:{select:U(B),displayName:y}}),et=i();et.fileList=Q,$("#newFile").click(U(et.create)),$("#mvFile").click(U(et.mv)),$("#rmFile").click(U(et.rm)),et.on.close=j,et.on.ls=p,et.on.validateName=x,et.on.createContent=function(e){var t=K.isKernel(e.truncExt(J));e.text(t?t.text():"")},et.on.displayName=function(e){var t=y(e);return t?t:e.name()};var tt;et.on.mvExtraUI=function(e){tt=T("div",["input",{type:"checkbox",$var:"chk",checked:"true",value:"chked"}],"プログラム中のクラス名も変更する"),e.append(tt)},et.on.mv=function(e,t){if(tt){var n=e.truncExt(J),r=t.truncExt(J);if(tt.$vars.chk.prop("checked")){F();try{K.renameClassName(n,r)}catch(i){return alert("プログラム内にエラーがあります．エラーを修正するか，「プログラム中のクラス名も変更する」のチェックを外してもう一度やり直してください．"),console.log(i),!1}}O(),tt=null}},U(et.on),Q.ls(V),g(),h.down(document,"Alt+Ctrl+D",function(){v.show(V,G)}),c.kernelDiff=function(){v.show(V,G)},c.kernelDiff.description="Compare Kernel file and this project.";var nt;nt=function(e){alert(e),nt=function(){}},window.onerror=N.handleException=t.onRuntimeError=function(e){t.globals.$lastError=e;var n,r=K.env.traceTbl,i=r.find(e)||r.decode($LASTPOS);if(i&&(n=K.decodeTrace(i)),console.log("onRunTimeError:stackTrace1",e.stack,n,$LASTPOS),n){if(n.mesg=e,e.pluginName)alert(e.message);else{var a=o($("#errorPos"),n);M("runtime_error"),$("#errorPos").find(".quickFix").append(T("button",{on:{click:function(){s(!0),a.dialog("close"),D()}}},"診断モードで実行しなおす"))}A()}else T("div",{title:"Error"},e,["pre",e.stack]).dialog({width:800}),A()},$("#mapEditor").click(U(function(){console.log("run map"),D("MapEditor")})),$("#search").click(U(function(){console.log("src diag"),b.show(V,function(e){Q.select(e.file),setTimeout(function(){var t=k();t&&t.gotoLine(e.lineNo)},50)})})),setInterval(R,1e3);var rt;d=function(){t.currentProject.dumpJS.apply(this,arguments)},$("#imgResEditor").click(U(function(){S(K,"image")})),$("#soundResEditor").click(U(function(){S(K,"sound")})),$("#prjOptEditor").click(U(function(){l(K)}));var it=null;if($("#refHelp").click(U(function(){it||(it=m.create(E.top+"/doc/index.html")),it.show()})),"object"==typeof progBar&&progBar.clear(),$("#rmPRJ").click(U(function(){"DELETE"==prompt(V+"内のファイルをすべて削除しますか？削除する場合はDELETE と入力してください．","")&&(c.rm(V,{r:1}),document.location.href="index.html")})),$("#mvPRJ").click(U(function(){var e=prompt("新しいプロジェクトの名前を入れてください",V.name().replace(/\//g,""));if(e&&""!=e){e.match(/\/$/)||(e+="/");var t=V.up().rel(e);if(t.exists())return void alert(t+" はすでに存在します");c.cp(V,t),c.rm(V,{r:1}),document.location.href="project.html?dir="+t}})),$("#editorEditor").click(U(function(){var e=k(),t=prompt("エディタの文字の大きさ",H.editorFontSize||12);H.editorFontSize=parseInt(t),e&&e.setFontSize(H.editorFontSize||12),q()})),c.curFile=function(){return Q.curFile()},et.onMenuStart=F,SplashScreen.hide(),K.getBlobInfos().length>0){var ot=T("div",{title:"ログイン"},["div","このプロジェクトを正常に動作させるにはログインが必要です"]);Auth.assertLogin({showLoginLink:function(e){ot.append(T("a",{href:e,target:"login",style:"font-size: 20px;"},"ログインする"))},success:function(){ot.dialog("close")}}),ot.dialog({modal:!0})}})}),requireSimulator.setName();