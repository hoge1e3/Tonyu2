!function(){var t={};return t.def=function(e,i,n){var r=t.getModuleInfo(t.curName);r.type=n,t.setReqs(r,e),r.func=function(){return i.apply(this,t.getObjs(e))},t.loadIfAvailable(r)},define=function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]&&(t.curName=e.shift());var i=e.shift(),n=e.shift();t.def(i,n,"define")},define.amd={jQuery:!0},requirejs=function(e,i){t.def(e,i,"require")},t.setReqs=function(e,i){i.forEach(function(i){var n=t.getModuleInfo(i);n.loaded||(e.reqs[i]=n,n.revReqs[e.name]=e)})},t.getModuleInfo=function(e){var i=t.modules;return i[e]||(i[e]={name:e,reqs:{},revReqs:{}}),i[e]},t.doLoad=function(e){var i=t.getModuleInfo(e);if(i.loaded)return i.obj;i.loaded=!0;var n=null;if(i.func)n=i.func();else{var r=e.split(/\./);n=function(){return this}(),r.forEach(function(t){n&&(n=n[t])}),null==n&&console.log("Warning: No obj for "+e)}if("define"==i.type&&null==n)throw"No obj for "+e;i.obj=n;for(var a in i.revReqs)t.notifyLoaded(i.revReqs[a],i.name);return n},t.notifyLoaded=function(e,i){delete e.reqs[i],t.loadIfAvailable(e)},t.loadIfAvailable=function(e){for(var i in e.reqs)return;t.doLoad(e.name)},t.getObjs=function(e){var i=[];return e.forEach(function(e){var n=t.doLoad(e);i.push(n)}),i},t.modules={},t.setName=function(e){t.curName&&(t.getModuleInfo(t.curName).func||t.doLoad(t.curName)),e&&(t.curName=e)},requireSimulator=t,t}(),requireSimulator.setName("extend"),define([],function(){return function(t,e){for(var i in e)t[i]=e[i]}}),requireSimulator.setName("assert"),define([],function(){function t(e){if(e instanceof Array){var i=[];return e.forEach(function(e){i=i.concat(t(e))}),i}return[e]}var e,i=function(e){this.failMesg=t(e||"Assertion failed: ")};i.prototype={_regedType:{},registerType:function(t,e){this._regedType[t]=e},MODE_STRICT:"strict",MODE_DEFENSIVE:"defensive",MODE_BOOL:"bool",fail:function(){var i=e(arguments),n=i.shift();if(i=t(i),i=this.failMesg.concat(n).concat(i).concat(["mode",this._mode]),console.log.apply(console,i),this.isDefensive())return n;if(this.isBool())return!1;throw new Error(i.join(" "))},subAssertion:function(){var n=e(arguments);return n=t(n),new i(this.failMesg.concat(n))},assert:function(t,e){return t?t:this.fail(t,e)},eq:function(t,e){return t!==e?this.fail(t,"!==",e):this.isBool()?!0:t},ne:function(t,e){return t===e?this.fail(t,"===",e):this.isBool()?!0:t},isset:function(t,e){return null==t?this.fail(t,(e||"")+" is null/undef"):this.isBool()?!0:t},is:function(t,e){var i=e,n=t;if(null==i)return this.fail(t,"assert.is: type must be set");if(i._assert_func)return i._assert_func.apply(this,[n]),this.isBool()?!0:t;if(this.assert(null!=t,[t,"should be ",i]),i instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&i instanceof global.Array){if(!t||"number"!=typeof t.length)return this.fail(t,"should be array:");for(var r=this,a=0;a<i.length;a++){var o=r.subAssertion("failed at ",t,"[",a,"]: ");null==i[a]&&console.log("WOW!7",n[a],i[a]),o.is(n[a],i[a])}return this.isBool()?!0:t}if(i===String||"string"==i)return this.assert("string"==typeof n,[n,"should be a string "]),this.isBool()?!0:t;if(i===Number||"number"==i)return this.assert("number"==typeof n,[n,"should be a number"]),this.isBool()?!0:t;if(i instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&i instanceof global.RegExp)return this.is(n,String),this.assert(i.exec(n),[n,"does not match to",i]),this.isBool()?!0:t;if(i===Function)return this.assert("function"==typeof n,[n,"should be a function"]),this.isBool()?!0:t;if("function"==typeof i)return this.assert(n instanceof i,[n,"should be ",i]),this.isBool()?!0:t;if(i&&"object"==typeof i){for(var s in i){var o=this.subAssertion("failed at ",t,".",s,":");o.is(t[s],i[s])}return this.isBool()?!0:t}if("string"==typeof i){var u=this._regedType[i];return u?this.is(t,u):this.isBool()?!0:t}return this.fail(t,"Invaild type: ",i)},ensureError:function(t,e){try{t()}catch(i){return"string"==typeof e&&r(i+""===e,t+" thrown an error "+i+" but expected:"+e),void console.log("Error thrown successfully: ",i.message)}this.fail(t,"should throw an error",e)},setMode:function(t){this._mode=t},isDefensive:function(){return this._mode===this.MODE_DEFENSIVE},isBool:function(){return this._mode===this.MODE_BOOL},isStrict:function(){return!this.isDefensive()&&!this.isBool()}},e=function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i]);return e};var n=new i,r=function(){try{return n.assert.apply(n,arguments)}catch(t){throw new Error(t.message)}};return["setMode","isDefensive","is","isset","ne","eq","ensureError"].forEach(function(t){r[t]=function(){try{return n[t].apply(n,arguments)}catch(e){throw console.log(e.stack),new Error(e.message)}}}),r.fail=n.fail.bind(n),r.MODE_STRICT=n.MODE_STRICT,r.MODE_DEFENSIVE=n.MODE_DEFENSIVE,r.MODE_BOOL=n.MODE_BOOL,r.f=function(t){return{_assert_func:t}},r.opt=function(t){return r.f(function(e){return null==e||e instanceof t})},r.and=function(){var t=e(arguments);return r(t instanceof Array),r.f(function(e){for(var i=this,n=0;n<t.length;n++)i.is(e,t[n])})},r}),requireSimulator.setName("PathUtil"),define(["assert"],function(t){function e(e,i){return t.is(arguments,[String,String]),e.substring(e.length-i.length)===i}function i(e,i){return t.is(arguments,[String,String]),e.substring(0,i.length)===i}var n,r=/^([a-zA-Z]):/,a=/^([a-z]+):\/\/\/?([^\/]+)\//,o=t.f(function(t){this.is(t,String),this.assert(n.isPath(t),[t," is not a path"])}),s=t.f(function(t){this.is(t,String),this.assert(n.isAbsolutePath(t),[t," is not a absolute path"])}),u=t.f(function(t){this.is(t,String),this.assert(!n.isAbsolutePath(t),[t," is not a relative path"])}),c=t.f(function(t){this.is(t,o),this.assert(n.isDir(t),[t," is not a directory path"])}),l=t.and(c,s),f=t.f(function(t){this.is(t,o),this.assert(!n.isDir(t),[t," is not a file path"])}),h="/";return n={Path:o,Absolute:s,Relative:u,Dir:c,File:f,AbsDir:l,SEP:h,endsWith:e,startsWith:i,hasDriveLetter:function(t){return r.exec(t)},isURL:function(t){var e=a.exec(t);if(e)return{protocol:e[1],hostPort:e[2],path:h+t.substring(e[0].length)}},isPath:function(){return t.is(arguments,[String]),!0},isRelativePath:function(e){return t.is(arguments,[String]),n.isPath(e)&&!n.isAbsolutePath(e)},isAbsolutePath:function(e){return t.is(arguments,[String]),n.isPath(e)&&(n.startsWith(e,h)||n.hasDriveLetter(e)||n.isURL(e))},isDir:function(i){return i=n.fixSep(i),t.is(arguments,[o]),e(i,h)},fixSep:function(e){return t.is(arguments,[String]),t.is(e.replace(/\\/g,"/"),o)},directorify:function(e){return e=n.fixSep(e),n.isDir(e)?e:t.is(e+h,c)},filify:function(e){return e=n.fixSep(e),n.isDir(e)?t.is(e.substring(0,e.length-1),f):e},splitPath:function(e){t.is(arguments,[o]);var i;if(i=this.isURL(e)){var n=this.splitPath(i.path);return n[0]=i.protocol+"://"+i.hostPort,n}e=e.replace(/\/+/g,h);var r=e.split(h);return""==r[r.length-1]&&(r[r.length-2]+=h,r.pop()),r},name:function(e){return t.is(arguments,[String]),n.splitPath(e).pop()},ext:function(e){t.is(arguments,[String]);var i=n.name(e),r=/\.[a-zA-Z0-9]+$/.exec(i);return r?r[0]:null},truncExt:function(e,i){t.is(e,String);var r=n.name(e);return i=i||n.ext(e),t.is(i,String),r.substring(0,r.length-i.length)},truncSEP:function(e){return t.is(arguments,[o]),n.isDir(e)?e.substring(0,e.length-1):e},endsWith:function(i,r){return t.is(arguments,[String,String]),e(n.name(i),r)},parent:function(e){return t.is(arguments,[String]),n.up(e)},rel:function(e,i){if(""==i)return e;t.is(arguments,[l,u]);var r=n.splitPath(i),a=e;a=a.replace(/\/$/,"");var o=n;return r.forEach(function(t){".."==t||"../"==t?a=o.up(a):(a=a.replace(/\/$/,""),a+=h+("."==t||"./"==t?"":t))}),a},relPath:function(e,i){return t.is(arguments,[s,s]),e.substring(0,i.length)!=i?"../"+n.relPath(e,this.up(i)):e.substring(i.length)},up:function(t){if(t=n.fixSep(t),t==h)return null;var e=n.splitPath(t);return e.pop(),e.join(h)+h}},n.isAbsolute=n.isAbsolutePath,n.isRelative=n.isRelativePath,"object"==typeof window&&(window.PathUtil=n),n}),requireSimulator.setName("MIMETypes"),define([],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".mp3":"audio/mp3",".ogg":"audio/ogg",".mp4":"video/mp4",".m4a":"audio/x-m4a",".mid":"audio/mid",".midi":"audio/mid",".wav":"audio/wav",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu"}}),requireSimulator.setName("FS2"),define(["extend","PathUtil","MIMETypes","assert"],function(t,e,i,n){function r(t){throw new Error(t+" is STUB!")}var a=function(){},o={};return a.addFSType=function(t,e){o[t]=e},a.availFSTypes=function(){return o},t(a.prototype,{err:function(t,e){throw new Error(t+": "+e)},fstype:function(){return"Unknown"},isReadOnly:function(){r("isReadOnly")},supportsSync:function(){return!0},resolveFS:function(t){return n(this.getRootFS()!==this),this.getRootFS().resolveFS(t)},mounted:function(t,e){this.rootFS=t,this.mountPoint=e},inMyFS:function(t){return!this.mountPoint||e.startsWith(t,this.mountPoint)},getRootFS:function(){return n(this.rootFS,"rootFS is not set")},getReturnTypes:function(){r("")},getContent:function(){r("getContent")},getContentAsync:function(){return this.supportsSync()||r("getContentAsync"),$.when(this.getContent.apply(this,arguments))},setContent:function(){r("")},setContentAsync:function(t,e,i){var n=this;return n.supportsSync()||r("setContentAsync"),$.when(e).then(function(e){return $.when(n.setContent(t,e,i))})},getMetaInfo:function(){r("")},setMetaInfo:function(){r("")},mkdir:function(){r("mkdir")},touch:function(){r("touch")},exists:function(){r("exists")},opendir:function(){r("opendir")},cp:function(t,i,r){n.is(arguments,[e.Absolute,e.Absolute]),this.assertExist(t),r=r||{};var a=this.isDir(t),o=this.getRootFS().resolveFS(i),s=o.isDir(i);if(a||s)throw new Error("only file to file supports");if(this.supportsSync()&&o.supportsSync()){var u=this.getContent(t),c=o.setContent(i,u);return r.a&&o.setMetaInfo(i,this.getMetaInfo(t)),c}return o.setContentAsync(i,this.getContentAsync(t)).then(function(e){return r.a?o.setMetaInfo(i,this.getMetaInfo(t)):e})},mv:function(t,e,i){return this.cp(t,e,i),this.rm(t,{r:!0})},rm:function(){r("")},link:function(t,e){throw new Error("ln "+e+" "+t+" : This FS not support link.")},getURL:function(){r("")}}),a.delegateMethods=function(t,i){for(var r in i)!function(r){n.ne(r,"inMyFS"),t[r]=function(){var t=arguments[0];n.is(t,e.Absolute);var a=this.resolveFS(t);return a!==this?a[r].apply(a,arguments):i[r].apply(this,arguments)}}(r)},a.delegateMethods(a.prototype,{assertWriteable:function(t){this.isReadOnly(t)&&this.err(t,"read only.")},getContentType:function(t,n){var r=(e.ext(t)+"").toLowerCase();return i[r]||(n||{}).def||"text/plain"},isText:function(t){var i=this.getContentType(t);return e.startsWith(i,"text")},assertExist:function(t,i){this.exists(t,i)||this.err(t,": No such "+(e.isDir(t)?"directory":"file"))},isDir:function(t){return e.isDir(t)},find:function(t,i){n.is(arguments,[e.Absolute]);var r=this.opendir(t,i),a=this,o=[t];return r.forEach(function(n){var r=e.rel(t,n);if(e.isDir(r)){var s=a.resolveFS(r);o=o.concat(s.find(r,i))}else o.push(r)}),o},resolveLink:function(t){n.is(t,e.Absolute);for(var i=t;i;i=e.up(i)){n(!this.mountPoint||e.startsWith(i,this.mountPoint),i+" is out of mountPoint. path="+t);var r=this.isLink(i);if(r){n(r!=i,"l==p=="+r);var a=e.rel(r,e.relPath(t,i));return n(a!=t,"np==path=="+a),n.is(this.getRootFS().resolveFS(a).resolveLink(a),e.Absolute)}if(this.exists(i))return t}return t},isLink:function(){return null}}),a}),requireSimulator.setName("WebSite"),define(["PathUtil"],function(t){var e,i=document.location.href,n=!!i.match(/html\/dev\//)&&!!i.match(/localhost:3/);e=i.match(/jsrun\.it/)?{urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:n,pluginTop:"http://tonyuedit.appspot.com/js/plugins",removeJSOutput:!0}:i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)||i.match(/\/html\/((dev)|(build))\//)?{urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:n}:{urlAliases:{},top:".",devMode:n};var r=window.navigator.userAgent.toLowerCase();return e.tablet=-1!=r.indexOf("windows")&&-1!=r.indexOf("touch")||-1!=r.indexOf("ipad")||-1!=r.indexOf("android")&&-1==r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("tablet")||-1!=r.indexOf("kindle")||-1!=r.indexOf("silk")||-1!=r.indexOf("playbook"),e.mobile=-1!=r.indexOf("windows")&&-1!=r.indexOf("phone")||-1!=r.indexOf("iphone")||-1!=r.indexOf("ipod")||-1!=r.indexOf("android")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("firefox")&&-1!=r.indexOf("mobile")||-1!=r.indexOf("blackberry"),e.pluginTop||(e.pluginTop=e.top+"/js/plugins"),e.disableROM={},i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:8888/),(i.match(/\.appspot\.com/)||i.match(/localhost:888[87]/))&&(e.serverType="GAE"),i.match(/localhost:3000/)&&(e.serverType="Node"),e.serverTop=i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)?e.top+"/exe":e.top+"/edit",e.sampleImg=e.top+"/images",e.blobPath=e.serverTop+"/serveBlob",e.isNW="object"==typeof process&&process.__node_webkit,e.mp3Disabled=e.isNW,e.tonyuHome="/Tonyu/",e.url={getDirInfo:e.serverTop+"/getDirInfo",getFiles:e.serverTop+"/File2LSSync",putFiles:e.serverTop+"/LS2FileSync"},e.isNW?(e.cwd=t.directorify(process.cwd()),e.tonyuHome=process.env.TONYU_HOME?t.directorify(process.env.TONYU_HOME):t.rel(e.cwd,"fs/Tonyu/"),e.logdir=process.env.TONYU_LOGDIR,e.wwwDir=t.rel(e.cwd,"www/"),e.platform=process.platform,e.ffmpeg=t.rel(e.cwd,"win32"==e.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),e.pkgInfo=require(t.rel(e.cwd,"package.json")),e.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):e.pkgInfo&&e.pkgInfo.config&&e.pkgInfo.config.prjDirs?e.pkgInfo.config.prjDirs.map(function(i){return i=t.directorify(i),t.isAbsolute(i)?i:t.rel(e.cwd,i)}):[t.rel(e.cwd,"Projects/"),t.rel(e.tonyuHome,"Projects/")],e.kernelDir=t.rel(e.wwwDir,"Kernel/")):(e.wwwDir=location.protocol+"//"+location.host+"/",e.projects=[t.rel(e.tonyuHome,"Projects/")]),(i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/))&&(e.kernelDir=location.protocol+"//"+location.host+"/Kernel/"),e.compiledKernel=i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/)||e.isNW?e.top+"/Kernel/js/concat.js":"http://tonyuexe.appspot.com/Kernel/js/concat.js",window.WebSite=e}),requireSimulator.setName("Util"),Util=function(){function t(t,i){null==i&&(i=""),t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+t+"=([^&#]*)"),r=n.exec(window.location.href);return null==r?i:e(r[1])}function e(t){return decodeURIComponent(t.replace(/\+/g,"%20"))}function i(t,e){return t.substring(t.length-e.length)===e}function n(t,e){return t.substring(0,e.length)===e}function r(t){function e(e){throw console.log(e),console.log(t,c),new Error(e)}t=t.replace(/[\n=]/g,"");var i=new Object;i[65]=0,i[66]=1,i[67]=2,i[68]=3,i[69]=4,i[70]=5,i[71]=6,i[72]=7,i[73]=8,i[74]=9,i[75]=10,i[76]=11,i[77]=12,i[78]=13,i[79]=14,i[80]=15,i[81]=16,i[82]=17,i[83]=18,i[84]=19,i[85]=20,i[86]=21,i[87]=22,i[88]=23,i[89]=24,i[90]=25,i[97]=26,i[98]=27,i[99]=28,i[100]=29,i[101]=30,i[102]=31,i[103]=32,i[104]=33,i[105]=34,i[106]=35,i[107]=36,i[108]=37,i[109]=38,i[110]=39,i[111]=40,i[112]=41,i[113]=42,i[114]=43,i[115]=44,i[116]=45,i[117]=46,i[118]=47,i[119]=48,i[120]=49,i[121]=50,i[122]=51,i[48]=52,i[49]=53,i[50]=54,i[51]=55,i[52]=56,i[53]=57,i[54]=58,i[55]=59,i[56]=60,i[57]=61,i[43]=62,i[47]=63;var n,r=t.length,a=0,o=0;if(!r)return new ArrayBuffer(0);n=Math.floor(r/4*3),"="==t.charAt(r-1)&&(n-=1),"="==t.charAt(r-2)&&(n-=1);for(var s=new ArrayBuffer(n),u=new Uint8Array(s),c=0,l=0;n>l&&(o=i[t.charCodeAt(c)],void 0===o&&e("Invalid letter: "+t.charCodeAt(c)),a=o<<2,c++,o=i[t.charCodeAt(c)],void 0===o&&e("Invalid letter: "+t.charCodeAt(c)),u[l]=a|o>>4&3,a=(15&o)<<4,c++,l++,!(l>=n))&&(o=i[t.charCodeAt(c)],void 0===o&&e("Invalid letter: "+t.charCodeAt(c)),u[l]=a|o>>2&15,a=(3&o)<<6,c++,l++,!(l>=n));)o=i[t.charCodeAt(c)],void 0===o&&e("Invalid letter: "+t.charCodeAt(c)),u[l]=a|o,c++,l++;return s}function a(t){for(var e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],i="",n=new Uint8Array(t),r=n.length,a=0,o=0,s=0;r>s&&(o=n[s],i+=e[o>>2],a=(3&o)<<4,s++,!(s>=r))&&(o=n[s],i+=e[a|o>>4],a=(15&o)<<2,s++,!(s>=r));)o=n[s],i+=e[a|o>>6],i+=e[63&o],s++;var u=r%3;return u&&(i+=e[a]),1==u?i+="==":2==u&&(i+="="),i}function o(t){if(t.__privatized)return t;var e={__privatized:!0};for(var i in t)!function(i){var n=t[i];i.match(/^_/)||"function"==typeof n&&(e[i]=function(){var e=n.apply(t,arguments);return e})}(i);return e}function s(){return"undefined"!=typeof Buffer}function u(t){return s()&&t instanceof Buffer}function c(t){return t instanceof ArrayBuffer||u(t)}function l(t){for(var e=[],i=0;i<t.length;i++)e.push("%"+("0"+t[i].toString(16)).slice(-2));try{return decodeURIComponent(e.join(""))}catch(n){throw console.log(e.join("")),n}}function f(t,e){for(var i=encodeURIComponent(t),n=/^%(..)/,r=[],a=0;a<i.length;a++){var o=n.exec(i.substring(a));o?(r.push(parseInt("0x"+o[1])),a+=o[0].length-1):r.push(i.charCodeAt(a))}return"undefined"!=typeof Buffer&&e===Buffer?new Buffer(r):new Uint8Array(r).buffer}return{getQueryString:t,endsWith:i,startsWith:n,Base64_To_ArrayBuffer:r,Base64_From_ArrayBuffer:a,utf8bytes2str:l,str2utf8bytes:f,privatize:o,hasNodeBuffer:s,isNodeBuffer:u,isBuffer:c}}(),requireSimulator.setName("DataURL"),define(["extend","assert","Util"],function(t,e,i){function n(t,e){function n(e){throw console.log(e),console.log(t,h),new Error(e)}var r=e;t=t.replace(/[\n=]/g,"");var a=new Object;a[65]=0,a[66]=1,a[67]=2,a[68]=3,a[69]=4,a[70]=5,a[71]=6,a[72]=7,a[73]=8,a[74]=9,a[75]=10,a[76]=11,a[77]=12,a[78]=13,a[79]=14,a[80]=15,a[81]=16,a[82]=17,a[83]=18,a[84]=19,a[85]=20,a[86]=21,a[87]=22,a[88]=23,a[89]=24,a[90]=25,a[97]=26,a[98]=27,a[99]=28,a[100]=29,a[101]=30,a[102]=31,a[103]=32,a[104]=33,a[105]=34,a[106]=35,a[107]=36,a[108]=37,a[109]=38,a[110]=39,a[111]=40,a[112]=41,a[113]=42,a[114]=43,a[115]=44,a[116]=45,a[117]=46,a[118]=47,a[119]=48,a[120]=49,a[121]=50,a[122]=51,a[48]=52,a[49]=53,a[50]=54,a[51]=55,a[52]=56,a[53]=57,a[54]=58,a[55]=59,a[56]=60,a[57]=61,a[43]=62,a[47]=63;var o,s=t.length,u=0,c=0;if(!s)return new r(0);o=Math.floor(s/4*3),"="==t.charAt(s-1)&&(o-=1),"="==t.charAt(s-2)&&(o-=1);for(var l=new r(o),f=i.isNodeBuffer(l)?l:new Uint8Array(l),h=0,p=0;o>p&&(c=a[t.charCodeAt(h)],void 0===c&&n("Invalid letter: "+t.charCodeAt(h)),u=c<<2,h++,c=a[t.charCodeAt(h)],void 0===c&&n("Invalid letter: "+t.charCodeAt(h)),f[p]=u|c>>4&3,u=(15&c)<<4,h++,p++,!(p>=o))&&(c=a[t.charCodeAt(h)],void 0===c&&n("Invalid letter: "+t.charCodeAt(h)),f[p]=u|c>>2&15,u=(3&c)<<6,h++,p++,!(p>=o));)c=a[t.charCodeAt(h)],void 0===c&&n("Invalid letter: "+t.charCodeAt(h)),f[p]=u|c,h++,p++;return e===Uint8Array?f:l}function r(t){for(var e=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=i.isNodeBuffer(t)?t:new Uint8Array(t),a=r.length,o=0,s=0,u=0;a>u&&(s=r[u],n+=e[s>>2],o=(3&s)<<4,u++,!(u>=a))&&(s=r[u],n+=e[o|s>>4],o=(15&s)<<2,u++,!(u>=a));)s=r[u],n+=e[o|s>>6],n+=e[63&s],u++;var c=a%3;return c&&(n+=e[o]),1==c?n+="==":2==c&&(n+="="),n}var a=i.hasNodeBuffer()?Buffer:ArrayBuffer,o=(i.isNodeBuffer,i.isBuffer),s=function(t,i){"string"==typeof t?(this.url=t,this.binType=i||a,this.dataURL2bin(t)):t&&o(t.buffer)?(this.buffer=t.buffer,e.is(i,String),this.contentType=i,this.bin2dataURL(this.buffer,this.contentType)):o(t)?(this.buffer=t,e.is(i,String),this.contentType=i,this.bin2dataURL(this.buffer,this.contentType)):(console.log(arguments),e.fail("Invalid args: ",arguments))};return s.isBuffer=o,t(s.prototype,{bin2dataURL:function(t,i){e(o(t)),e.is(i,String);var n=this.dataHeader(i),a=r(t);return e.is(a,String),this.url=n+a},dataURL2bin:function(t){e.is(arguments,[String]);var i=/^data:([^;]+);base64,/i,r=i.exec(t);return e(r,["malformed dataURL:",t]),this.contentType=r[1],this.buffer=n(t.substring(r[0].length),this.binType),e.is(this.buffer,this.binType)},dataHeader:function(t){return e.is(arguments,[String]),"data:"+t+";base64,"},toString:function(){return e.is(this.url,String)}}),s}),requireSimulator.setName("Content"),define(["DataURL","Util","assert"],function(t,e,i){var n=function(){},r=(e.isNodeBuffer,e.isBuffer);n.plainText=function(t,e){var i=new n;return i.contentType=e||"text/plain",i.plain=t,i},n.url=function(t){var e=new n;return e.url=t,e},n.buffer2ArrayBuffer=function(t){return e.isBuffer(t)?i(new Uint8Array(t).buffer,"n2a: buf is not set"):i(t,"n2a: a is not set")},n.arrayBuffer2Buffer=function(t){if(t instanceof ArrayBuffer){var e=new Buffer(new Uint8Array(t));return e}return i(t,"a2n: a is not set")},n.bin=function(t,a){i(a,"contentType should be set");var o=new n;if(t&&r(t.buffer))o.arrayBuffer=t.buffer;else if(e.isNodeBuffer(t))o.nodeBuffer=t;else{if(!(t instanceof ArrayBuffer))throw new Error(t+" is not a bin");o.arrayBuffer=t}return o.contentType=a,o};var a=n.prototype;return a.toBin=function(i){if(i=i||(e.hasNodeBuffer()?Buffer:ArrayBuffer),this.nodeBuffer)return i===Buffer?this.nodeBuffer:this.arrayBuffer=n.buffer2ArrayBuffer(this.nodeBuffer);if(this.arrayBuffer)return i===ArrayBuffer?this.arrayBuffer:this.nodeBuffer=n.arrayBuffer2Buffer(this.arrayBuffer);if(this.url){var r=new t(this.url,i);return this.setBuffer(r.buffer)}if(null!=this.plain)return this.setBuffer(e.str2utf8bytes(this.plain,i));throw new Error("No data")},a.setBuffer=function(t){return i(t,"b is not set"),e.isNodeBuffer(t)?this.nodeBuffer=t:this.arrayBuffer=t},a.toArrayBuffer=function(){return this.toBin(ArrayBuffer)},a.toNodeBuffer=function(){return this.toBin(Buffer)},a.toURL=function(){if(this.url)return this.url;if(this.arrayBuffer||null==this.plain||(this.arrayBuffer=e.str2utf8bytes(this.plain,ArrayBuffer)),this.arrayBuffer||this.nodeBuffer){var i=new t(this.arrayBuffer||this.nodeBuffer,this.contentType);return this.url=i.url}throw new Error("No data")},a.toPlainText=function(){if(null!=this.plain)return this.plain;if(this.url&&!this.hasBin()){var i=new t(this.url,ArrayBuffer);this.arrayBuffer=i.buffer}if(this.hasBin())return this.plain=e.utf8bytes2str(this.nodeBuffer||new Uint8Array(this.arrayBuffer));throw new Error("No data")},a.hasURL=function(){return this.url},a.hasPlainText=function(){return null!=this.plain},a.hasBin=function(){return this.nodeBuffer||this.arrayBuffer},a.hasNodeBuffer=function(){return this.nodeBuffer},a.hasArrayBuffer=function(){return this.arrayBuffer},n}),requireSimulator.setName("NativeFS"),define(["FS2","assert","PathUtil","extend","MIMETypes","DataURL","Content"],function(t,e,i,n,r,a,o){var s="object"==typeof process&&process.__node_webkit;if(!s)return function(){throw new Error("This system not suppert native FS")};var u=e,c=require("fs"),l=function(t){t&&(e.is(t,i.AbsDir),this.rootPoint=t)},f=i.hasDriveLetter(process.cwd());l.available=!0;var h=i.SEP,p=l.prototype=new t;return p.toNativePath=function(t){return this.rootPoint?(e.is(t,i.Absolute),e(this.inMyFS(t),t+" is not fs of "+this),i.rel(this.rootPoint,i.relPath(t,this.mountPoint||i.SEP))):t},p.arrayBuffer2Buffer=function(t){if(t instanceof ArrayBuffer){var e=new Buffer(new Uint8Array(t));return e}return t},t.addFSType("NativeFS",function(t,e){return new l(e.r)}),l.prototype.fstype=function(){return"Native"+(this.rootPoint?"("+this.rootPoint+")":"")},l.prototype.inMyFS=function(t){return this.mountPoint?i.startsWith(t,this.mountPoint):!(!!f^!!i.hasDriveLetter(t))},t.delegateMethods(l.prototype,{getReturnTypes:function(){return u.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(t,n){n=n||{},e.is(t,i.Absolute);var r=this.toNativePath(t);return this.assertExist(t),this.isText(t)?o.plainText(c.readFileSync(r,{encoding:"utf8"})):o.bin(c.readFileSync(r),this.getContentType(t))},setContent:function(t,n){e.is(arguments,[i.Absolute,o]);var r=i.up(t);r&&this.getRootFS().resolveFS(r).mkdir(r);var a=this.toNativePath(t);n.hasBin()||!n.hasPlainText()?c.writeFileSync(a,n.toNodeBuffer()):c.writeFileSync(a,n.toPlainText())},getMetaInfo:function(t,e){this.assertExist(t,e);var i=this.stat(t);return i.lastUpdate=i.mtime.getTime(),i},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(t){e.is(t,i.Absolute);var n=this.toNativePath(t);return c.statSync(n)},mkdir:function(t){if(u.is(arguments,[i.Absolute]),this.exists(t)){if(this.isDir(t))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(t);var e=i.up(t);e&&this.getRootFS().resolveFS(e).mkdir(e);var n=this.toNativePath(t);return c.mkdirSync(n),this.assertExist(n)},opendir:function(t){u.is(arguments,[String]);var e=this.toNativePath(t),n=i.truncSEP(e),r=c.readdirSync(e).map(function(t){var e=c.statSync(n+h+t),i=e.isDirectory()?h:"";return t+i}),a=[];return u.is(a.concat(r),Array)},rm:function(t,e){u.is(arguments,[i.Absolute]),e=e||{},this.assertExist(t);var n=this.toNativePath(t);return this.isDir(t)?c.rmdirSync(n):c.unlinkSync(n)},exists:function(t){var e=this.toNativePath(t);return c.existsSync(e)},isDir:function(t){return this.exists(t)?this.stat(t).isDirectory():i.isDir(t)},touch:function(t){!this.exists(t)&&this.isDir(t)?this.mkdir(t):this.exists(t)&&c.utimesSync(t,Date.now()/1e3,Date.now()/1e3)},getURL:function(t){return"file:///"+t.replace(/\\/g,"/")}}),l}),requireSimulator.setName("LSFS"),define(["FS2","PathUtil","extend","assert","Util","Content"],function(t,e,i,n,r,a){function o(){return(new Date).getTime()}var s=function(t,e){this.storage=t,this.options=e||{}},u=e.isDir.bind(e),c=e.up.bind(e),l=e.endsWith.bind(e),f=(e.Path,e.Absolute),h=e.SEP;return s.ramDisk=function(){var t={};return t[e.SEP]="{}",new s(t)},t.addFSType("localStorage",function(){return new s(localStorage)}),t.addFSType("ram",function(){return s.ramDisk()}),s.now=o,s.prototype=new t,s.prototype.resolveKey=function(t){return n.is(t,e.Absolute),this.mountPoint?e.SEP+e.relPath(t,this.mountPoint):t},s.prototype.getItem=function(t){n.is(t,e.Absolute);var i=this.resolveKey(t);return this.storage[i]},s.prototype.setItem=function(t,i){n.is(t,e.Absolute);var r=this.resolveKey(t);n(r.indexOf("..")<0),n(e.startsWith(r,e.SEP)),this.storage[r]=i},s.prototype.removeItem=function(t){n.is(t,e.Absolute);var i=this.resolveKey(t);delete this.storage[i]},s.prototype.itemExists=function(t){n.is(t,e.Absolute);var i=this.resolveKey(t);return i in this.storage},s.prototype.getDirInfo=function(t){if(n.is(arguments,[e.AbsDir]),null==t)throw new Error("getDir: Null path");l(t,h)||(t+=h),n(this.inMyFS(t));var i={};try{var r=this.getItem(t);r&&(i=JSON.parse(r))}catch(a){console.log("dinfo err : ",t,r)}return i},s.prototype.putDirInfo=function(t,i,r){if(n.is(arguments,[e.AbsDir,Object]),!u(t))throw new Error("Not a directory : "+t);n(this.inMyFS(t)),this.setItem(t,JSON.stringify(i));var a=c(t);if(null!=a&&this.inMyFS(a)){var o=this.getDirInfo(a);this._touch(o,a,e.name(t),r)}},s.prototype._touch=function(t,e,i,r){n.is(arguments,[Object,String,String]),n(this.inMyFS(e)),t[i]||(t[i]={},r&&(t[i].trashed=!0)),r||delete t[i].trashed,t[i].lastUpdate=o(),this.putDirInfo(e,t,r)},s.prototype.removeEntry=function(t,e,i){n.is(arguments,[Object,String,String]),t[i]&&(t[i]={lastUpdate:o(),trashed:!0},this.putDirInfo(e,t,!0))},s.prototype.removeEntryWithoutTrash=function(t,e,i){n.is(arguments,[Object,String,String]),t[i]&&(delete t[i],this.putDirInfo(e,t,!0))},s.prototype.isRAM=function(){return this.storage!==localStorage},s.prototype.fstype=function(){return this.isRAM()?"ramDisk":"localStorage"},t.delegateMethods(s.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return n.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(t){n.is(arguments,[f]),this.assertExist(t);var e;return e=this.isText(t)?a.plainText(this.getItem(t)):a.url(this.getItem(t))},setContent:function(t,e){n.is(arguments,[f,a]),this.assertWriteable(t),this.isText(t)?this.setItem(t,e.toPlainText()):this.setItem(t,e.toURL()),this.touch(t)},getMetaInfo:function(t){if(this.assertExist(t,{includeTrashed:!0}),n.is(arguments,[f]),t==e.SEP)return{};var i=n(e.up(t));if(!this.inMyFS(i))return{};var r=e.name(t);n.is(i,e.AbsDir);var a=this.getDirInfo(i);return n(a[r])},setMetaInfo:function(t,i){n.is(arguments,[String,Object]),this.assertWriteable(t);var r=n(e.up(t));if(this.inMyFS(r)){var a=this.getDirInfo(r),o=e.name(t);a[o]=i,this.putDirInfo(r,a,a[o].trashed)}},mkdir:function(t){n.is(arguments,[f]),this.assertWriteable(t),this.touch(t)},opendir:function(t,e){n.is(arguments,[String]),e=e||{};var i=this.getDirInfo(t),r=[];for(var a in i)n(i[a]),(!i[a].trashed||e.includeTrashed)&&r.push(a);return n.is(r,Array)},rm:function(t,i){n.is(arguments,[f]),i=i||{},this.assertWriteable(t);var r=e.up(t);if(null==r||!this.inMyFS(r))throw new Error(t+": cannot remove. It is root of this FS.");if(this.assertExist(t,{includeTrashed:i.noTrash}),e.isDir(t)){var a=this.opendir(t);a.length>0&&this.err(t,"Directory not empty"),i.noTrash&&this.removeItem(t)}else this.removeItem(t);var o=this.getDirInfo(r);i.noTrash?this.removeEntryWithoutTrash(o,r,e.name(t)):this.removeEntry(o,r,e.name(t))},exists:function(t,i){n.is(arguments,[f]),i=i||{};var r=e.name(t),a=e.up(t);
if(null==a||!this.inMyFS(a))return!0;var o=this.getDirInfo(a),s=o[r];return s&&s.trashed&&this.itemExists(t)&&this.isDir(t),!s&&this.itemExists(t),s&&!s.trashed&&!s.link&&!this.itemExists(t),s&&!i.includeTrashed&&(s=!s.trashed),!!s},link:function(t,i){n.is(arguments,[e.Absolute,e.Absolute]),this.assertWriteable(t),this.exists(t)&&this.err(t,"file exists"),e.isDir(t)&&!e.isDir(i)&&this.err(t," can not link to file "+i),!e.isDir(t)&&e.isDir(i)&&this.err(t," can not link to directory "+i);var r={};r.link=i,r.lastUpdate=o(),this.setMetaInfo(t,r),n(this.exists(t)),n(this.isLink(t))},isLink:function(t){if(n.is(arguments,[e.Absolute]),!this.exists(t))return null;var i=n(this.getMetaInfo(t));return i.link},touch:function(t){n.is(arguments,[f]),this.assertWriteable(t),this.itemExists(t)||(e.isDir(t)?this.setItem(t,"{}"):this.setItem(t,""));var i=c(t);if(null!=i)if(this.inMyFS(i)){var r=this.getDirInfo(i);this._touch(r,i,e.name(t),!1)}else n(this.getRootFS()!==this),this.getRootFS().resolveFS(i).touch(i)},getURL:function(t){return this.getContent(t).toURL()}}),s}),requireSimulator.setName("Env"),define(["assert","PathUtil"],function(t,e){var i=function(t){this.value=t};return i.prototype={expand:function(e){t.is(e,String);var i=this;return e.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,e){return i.get(e)})},expandPath:function(i){return t.is(i,String),i=this.expand(i),i=i.replace(/\/+/g,"/"),i=i.replace(/^[a-z][a-z]+:\//,function(t){return t+"/"}),t.is(i,e.Path)},get:function(t){return this.value[t]},set:function(t,e){this.value[t]=e}},i}),requireSimulator.setName("SFile"),define(["extend","assert","PathUtil","Util","Content","FS2"],function(t,e,i,n,r,a){var o=function(t,n){e.is(n,i.Absolute),this._path=n,this.rootFS=t,this.fs=t.resolveFS(n),this.act={},this.act.path=this.fs.resolveLink(n),this.act.fs=t.resolveFS(this.act.path),e.is(this.act,{fs:a,path:i.Absolute}),this.isDir()&&!i.isDir(n)&&(this._path+=i.SEP)};return o.is=function(t){return t&&"function"==typeof t.isSFile&&t.isSFile()},o.prototype={isSFile:function(){return!0},setPolicy:function(t){if(this.policy)throw new Error("policy already set");return this.policy=t,this._clone()},getPolicy:function(){return this.policy},_clone:function(){return this._resolve(this.path())},_resolve:function(t,r){var a;if(r=r||{},o.is(t))a=t;else{e.is(t,i.Absolute);var s,u=r.policy||this.policy;if(u&&(s=u.topDir)&&(s.path&&(s=s.path()),!i.startsWith(t,s)))throw new Error(t+": cannot access. Restricted to "+s);a=new o(this.rootFS,t),a.policy=u}return a.policy?n.privatize(a):a},contains:function(t){return e(o.is(t),t+" shoud be a SFile object."),this.isDir()?i.startsWith(t.path(),this.path()):!1},path:function(){return this._path},name:function(){return i.name(this.path())},truncExt:function(t){return i.truncExt(this.path(),t)},ext:function(){return i.ext(this.path())},relPath:function(t){var n=t.path?t.path():t;return i.relPath(this.path(),e.is(n,i.Absolute))},up:function(){var t=this.path(),e=i.up(t);return null==e?null:this._resolve(e)},rel:function(t){e.is(t,i.Relative),this.assertDir();var n=this.path();return this._resolve(i.rel(n,t))},startsWith:function(t){return i.startsWith(this.name(),t)},endsWith:function(t){return i.endsWith(this.name(),t)},equals:function(t){return t&&"function"==typeof t.path&&t.path()==this.path()},toString:function(){return this.path()},touch:function(){this.act.fs.touch(this.act.path)},isReadOnly:function(){return this.act.fs.isReadOnly(this.act.path)},isTrashed:function(){var t=this.metaInfo();return t?t.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(t){return this.act.fs.getMetaInfo(this.act.path,t)},setMetaInfo:function(t,e){return this.act.fs.setMetaInfo(this.act.path,t,e)},lastUpdate:function(){return e(this.exists()),this.metaInfo().lastUpdate},exists:function(t){t=t||{};var e=this.fs.exists(this.path(),t);return e||t.noFollowLink?e:this.act.fs.exists(this.act.path,{noFollowLink:!0})},rm:function(t){return t=t||{},this.isLink()?this.fs.rm(this.path(),t):(this.isDir()&&(t.recursive||t.r)&&this.each(function(e){e.rm(t)}),this.act.fs.rm(this.act.path,t))},removeWithoutTrash:function(t){t=t||{},t.noTrash=!0,this.rm(t)},isDir:function(){return this.act.fs.isDir(this.act.path)},text:function(){return arguments.length>0?void this.setText(arguments[0]):this.getText()},setText:function(t){e.is(t,String),this.isText()?this.act.fs.setContent(this.act.path,r.plainText(t)):this.act.fs.setContent(this.act.path,r.url(t))},getContent:function(t){return"function"==typeof t?this.act.fs.getContentAsync(this.act.path).then(t):this.act.fs.getContent(this.act.path)},setContent:function(t){return this.act.fs.setContentAsync(this.act.path,t)},getText:function(){return this.isText()?this.act.fs.getContent(this.act.path).toPlainText():this.act.fs.getContent(this.act.path).toURL()},isText:function(){return this.act.fs.isText(this.act.path)},contentType:function(){return this.act.fs.getContentType(this.act.path)},setBytes:function(t){return this.act.fs.setContent(this.act.path,r.bin(t,this.contentType()))},getBytes:function(t){return t=t||{},this.act.fs.getContent(this.act.path).toBin(t.binType)},getURL:function(){return this.act.fs.getURL(this.act.path)},lines:function(){return this.text().replace(/\r/g,"").split("\n")},obj:function(){var t=this;if(0==arguments.length){var i=t.text();return i?JSON.parse(i):null}t.text(JSON.stringify(e.is(arguments[0],Object)))},copyFrom:function(t,e){return t.copyTo(this,e)},copyTo:function(t,i){e(t&&t.isSFile(),t+" is not a file");var n=this,i=i||{},r=n.isDir(),a=t.isDir();if(!r&&a&&(t=t.rel(n.name()),e(!t.isDir(),t+" is a directory."),a=!1),r&&!a)this.err("Cannot move dir to file");else{if(!r&&!a){i.echo&&i.echo(n+" -> "+t);var o=this.act.fs.cp(this.act.path,t.getResolvedLinkPath(),i);return i.a&&t.setMetaInfo(n.getMetaInfo()),o}e(r&&a),n.each(function(e){t.rel(e.name()).copyFrom(e,i)})}},moveFrom:function(t,e){var i=this.copyFrom(t,e);return t.rm({recursive:!0}),i},assertDir:function(){return e.is(this.path(),i.Dir),this},each:function(t,e){var i=this.assertDir();i.listFiles(e).forEach(t)},recursive:function(t,e){var i=this.assertDir();i.each(function(e){e.isDir()?e.recursive(t):t(e)},e)},listFiles:function(t){e(null==t||"object"==typeof t);var i,n=this.assertDir(),r=this.path();"function"==typeof t&&(i=t),t=n.convertOptions(t),i||(i=t.order);for(var a=this.act.fs.opendir(this.act.path,t),o=[],s=0;s<a.length;s++){var u=a[s];t.excludes[r+u]||o.push(n.rel(u))}return"function"==typeof i&&o.sort&&o.sort(i),o},ls:function(t){e(null==t||"object"==typeof t);var i=this.assertDir(),n=i.listFiles(t);return n.map(function(t){return t.name()})},convertOptions:function(t){var n=(this.assertDir(),this.path());if(t||(t={}),t.excludes||(t.excludes={}),t.excludes instanceof Array){var r={};t.excludes.forEach(function(t){i.startsWith(t,"/")?r[t]=1:r[n+t]=1}),t.excludes=r}return e.is(t,{excludes:{}})},mkdir:function(){this.touch()},link:function(t,e){if(this.exists())throw new Error(this.path()+": exists.");return this.act.fs.link(this.act.path,t.path(),e)},resolveLink:function(){return this._resolve(this.act.path)},isLink:function(){return this.fs.isLink(this.path())},getResolvedLinkPath:function(){return this.act.path}},o}),requireSimulator.setName("RootFS"),define(["assert","FS2","PathUtil","SFile"],function(t,e,i,n){var r=function(i){t.is(i,e),this.mount(null,i)},a=r.prototype,o={err:function(t,e){throw new Error(t+": "+e)},fstab:function(){return this._fstab=this._fstab||[]},unmount:function(e){t.is(arguments,[i.AbsDir]);var n=this.fstab();console.log(n);for(var r=0;r<n.length;r++)if(n[r].mountPoint==e)return n.splice(r,1),!0;return!1},availFSTypes:function(){return e.availFSTypes()},mount:function(i,n,r){if("string"==typeof n){var a=t(e.availFSTypes()[n],"fstype "+n+" is undefined.");n=a(i,r||{})}t.is(n,e),n.mounted(this,i),this.fstab().unshift(n)},resolveFS:function(n){t.is(n,i.Absolute);var r;return this.fstab().forEach(function(t){r||t.inMyFS(n)&&(r=t)}),r||this.err(n,"Cannot resolve"),t.is(r,e)},get:function(e){return t.is(e,i.Absolute),new n(this.resolveFS(e),e)}};for(var s in o)a[s]=o[s];return r}),requireSimulator.setName("FS"),define(["FS2","WebSite","NativeFS","LSFS","PathUtil","Env","assert","SFile","RootFS"],function(t,e,i,n,r,a,o,s,u){var t={};"object"==typeof window&&(window.FS=t);var c,l=new a(e);return c=new u(e.isNW?new i:new n(localStorage)),t.getRootFS=function(){return c},t.get=function(){return c.get.apply(c,arguments)},t.expandPath=function(){return l.expandPath.apply(l,arguments)},t.resolve=function(e,i){return s.is(e)?e:(e=l.expandPath(e),i&&!r.isAbsolutePath(e)?(i=l.expandPath(i),t.get(i).rel(e)):t.get(e))},t.mount=function(){return c.mount.apply(c,arguments)},t.unmount=function(){return c.unmount.apply(c,arguments)},t}),requireSimulator.setName("plugins"),define(["WebSite"],function(t){function e(t){return"function"==typeof t&&(t={onload:t}),t||(t={}),t.onload||(t.onload=function(){}),t}var i={},n={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return i.installed=n,i.detectNeeded=function(t,e){for(var i in n){var r=n[i].detection.exec(t);r&&(e[i]=1)}return e},i.loaded=function(t){var e=n[t];if(!e)throw new Error("plugin not found: "+t);return window[e.symbol]},i.loadAll=function(t,r){function a(){u>=o.length?r.onload():i.load(o[u++],a)}r=e(r);var o=[];for(var s in t)n[s]&&!i.loaded(s)&&o.push(s);var u=0;console.log("loading plugins",o),setTimeout(a,0)},i.load=function(i,r){var a=n[i];if(!a)throw new Error("plugin not found: "+i);r=e(r);var o=t.pluginTop+"/"+a.src;location.href.match(/^file:/)?($("<script>").attr("src",o).appendTo("body"),setTimeout(r.onload,500)):$.getScript(o,r.onload)},i.request=function(t){if(!i.loaded(t)){var e=new Error("Plugin "+t+" required");e.pluginName=t}},i}),requireSimulator.setName("DeferredUtil"),define([],function(){var t;return t={ensureDefer:function(t){var e,i=new $.Deferred;return $.when(t).then(function(t){e?i.resolve(t):setTimeout(function(){i.resolve(t)},0)}).fail(function(t){e?i.reject(t):setTimeout(function(){i.reject(t)},0)}),e=!0,i.promise()},directPromise:function(t){var e=new $.Deferred;return setTimeout(function(){e.resolve(t)},0),e.promise()},then:function(e){return t.directPromise().then(e)},timeout:function(t){var e=new $.Deferred;return setTimeout(function(){e.resolve()},t),e.promise()},funcPromise:function(t){var e=new $.Deferred;return t(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise()},throwPromise:function(t){var e=new $.Deferred;return setTimeout(function(){e.reject(t)},0),e.promise()},throwF:function(e){return function(){try{return e.apply(this,arguments)}catch(i){return console.log(i,i.stack),t.throwPromise(i)}}},each:function(e,i){if(e instanceof Array)return t.loop(function(n){return n>=e.length?t.brk():$.when(i(e[n],n)).then(function(){return n+1})},0);var n=[];for(var r in e)n.push({k:r,v:e[r]});return t.each(n,function(t){return i(t.k,t.v)})},loop:function(e,i){return t.directPromise(i).then(t.throwF(function(){var i=e.apply(this,arguments);return i.DU_BRK?i.res:$.when(i).then(function(i){return t.loop(e,i)})}))},brk:function(t){return{DU_BRK:!0,res:t}}}}),requireSimulator.setName("compiledProject"),define(["DeferredUtil"],function(t){var e=function(e,i){return{getNamespace:function(){return e},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(e){var i=t.directPromise(),n=this.getNamespace();return this.getDependingProjects().forEach(function(t){t.getNamespace()!=n&&(i=i.then(function(){return t.loadClasses(e)}))}),i},loadClasses:function(t){console.log("Load compiled classes ns=",e,"url=",i);var n=new $.Deferred,r=document.getElementsByTagName("head")[0]||document.documentElement,a=document.createElement("script");a.src=i;var o=!1;return a.onload=a.onreadystatechange=function(){o||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(o=!0,a.onload=a.onreadystatechange=null,r&&a.parentNode&&r.removeChild(a),console.log("Done Load compiled classes ns=",e,"url=",i,Tonyu.classes),n.resolve())},this.loadDependingClasses(t).then(function(){r.insertBefore(a,r.firstChild)}),n.promise()}}};return e}),requireSimulator.setName("compiledTonyuProject"),define(["plugins","compiledProject"],function(t,e){var i=function(i,n,r){var a=e(i,n),o=e("kernel",WebSite.compiledKernel),s={getDir:function(){return r},getDependingProjects:function(){return[o]},getOptions:function(){var t=this.getDir().rel("options.json");return t.obj()},getResource:function(){var t=this.getDir().rel("res.json");return t.obj()},loadPlugins:function(e){var i=this.getOptions();return t.loadAll(i.plugins,e)},requestPlugin:function(){},run:function(t){var e={classes:Tonyu.classMetas};this.loadClasses(e).then(function(){Tonyu.run(t)})}};for(var u in s)a[u]=s[u];return a};return i}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite","PathUtil","assert"],function(t,e,i,n){function r(t,e){var i=a(t);if(e&&!i.exists())throw i+": no such file or directory";return i}function a(e){if("string"!=typeof e)return e;if(n.isAbsolutePath(e))return t.get(e);var i=o.cwd;return i.rel(e)}var o={};return o.cd=function(t){return o.cwd=r(t,!0),o.pwd()},o.mount=function(e,i){if(!e||!e.t){var n=[];for(var r in t.getRootFS().availFSTypes())n.push(r);return void sh.err("-t=("+n.join("|")+") should be specified.")}t.mount(i,e.t,e)},o.unmount=function(e){t.unmount(e)},o.fstab=function(){var e=t.getRootFS(),i=e.fstab(),n=this;i.forEach(function(t){n.echo(t.fstype()+"	"+(t.mountPoint||""))})},o.resolve=r,o.pwd=function(){return o.cwd+""},o.ls=function(t){return t=t?r(t,!0):o.cwd,t.ls()},o.cp=function(t,e,i){i||(i={}),i.v&&(o.echo("cp",t,e),i.echo=o.echo.bind(o));var n=r(t,!0),a=r(e);return n.copyTo(a,i)},o.ln=function(t,e,i){var n=r(e),a=r(t,!0);if(n.isDir()&&n.exists()&&(n=n.rel(a.name())),n.exists())throw new Error(n+" exists");return n.link(a,i)},o.rm=function(t,e){if(e||(e={}),e.notrash)return t=r(t,!1),t.removeWithoutTrash(),1;if(t=r(t,!0),t.isDir()&&e.r){var i=t,n=0;return i.each(function(t){t.exists()&&(n+=o.rm(t,e))}),i.rm(),n+1}return t.rm(),1},o.cat=function(t){return t=r(t,!0),o.echo(t.getContent(function(e){return t.isText()?e.toPlainText():e.toURL()}))},o.resolve=function(t){return t||(t="."),t=r(t)},o.grep=function(t,e,i){function n(t,e,n){i.res&&i.res.push({file:t,lineNo:e,line:n}),o.echo(t+"("+e+"): "+n)}return e=r(e,!0),i||(i={}),i.res||(i.res=[]),e.isDir()?e.each(function(e){o.grep(t,e,i)}):"string"==typeof t&&e.lines().forEach(function(i,r){i.indexOf(t)>=0&&n(e,r+1,i)}),i.res},o.touch=function(t){return t=r(t),t.text(t.exists()?t.text():""),1},o.setout=function(t){o.outUI=t},o.echo=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.log&&o.outUI.log.apply(o.outUI,arguments)},o.err=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.err&&o.outUI.err.apply(o.outUI,arguments)},o.prompt=function(){},o.ASYNC={r:"SH_ASYNC"},o.help=function(){for(var t in o){var e=o[t];"function"==typeof e&&o.echo(t+(e.description?" - "+e.description:""))}},sh=o,i.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),o}),requireSimulator.setName("Class"),define(["assert"],function(t){function e(){var e,i;2==arguments.length?(e=t.is(arguments[0],Function),i=t.is(arguments[1],Object)):1==arguments.length&&(e=Object,i=t.is(arguments[0],Object));var n=i.initialize||function(){},r=n.prototype;for(var a in i)r[a]=i[a];return r.callSuper=function(){for(var i=[],n=0;arguments.length;n++)i.push(arguments[n]);var r=t.is(i.shift(),String),a=t.is(e.prototype[r],Function);return a.apply(this,i)},n}return e}),requireSimulator.setName("Tonyu.Thread"),define(["DeferredUtil","Class"],function(t,e){var i={enterC:{},exitC:0};try{window.cnts=i}catch(n){}var r=e({initialize:function(){this.frame=null,this._isDead=!1,this.cnt=0,this._isWaiting=!1,this.fSuspended=!1,this.tryStack=[],this.preemptionTime=60,this.onEndHandlers=[],this.onTerminateHandlers=[],this.age=0},isAlive:function(){return!this.isDead()},isDead:function(){return this._isDead=this._isDead||null==this.frame||this._threadGroup&&(this._threadGroup.objectPoolAge!=this.tGrpObjectPoolAge||this._threadGroup.isDeadThreadGroup())},setThreadGroup:function(t){this._threadGroup=t,this.tGrpObjectPoolAge=t.objectPoolAge},isWaiting:function(){return this._isWaiting},suspend:function(){this.fSuspended=!0,this.cnt=0},enter:function(t){this.frame={prev:this.frame,func:t}},apply:function(t,e,i){i||(i=[]);var n;if("string"==typeof e&&(n=t["fiber$"+e],!n))throw new Error("メソッド"+e+"が見つかりません");"function"==typeof e&&(n=e.fiber),i=[this].concat(i);var r=0;return this.enter(function(e){switch(r){case 0:n.apply(t,i),r=1;break;case 1:e.termStatus="success",e.notifyEnd(e.retVal),i[0].exit(),r=2}})},notifyEnd:function(t){this.onEndHandlers.forEach(function(e){e(t)}),this.notifyTermination({status:"success",value:t})},notifyTermination:function(t){this.onTerminateHandlers.forEach(function(e){e(t)})},on:function(t,e){("end"===t||"success"===t)&&this.onEndHandlers.push(e),"terminate"===t&&(this.onTerminateHandlers.push(e),this.handleEx&&delete this.handleEx)},promise:function(){var e=this;return t.funcPromise(function(t,i){e.on("terminate",function(e){"success"===e.status?t(e.value):i("exception"===e.status?e.exception:new Error(e.status))})})},then:function(t,e){return e?this.proimse().then(t,e):this.proimse().then(t)},fail:function(t){return this.promise().fail(t)},gotoCatch:function(t){var e=this;if(0==e.tryStack.length)return e.termStatus="exception",e.kill(),void(e.handleEx?e.handleEx(t):e.notifyTermination({status:"exception",exception:t}));e.lastEx=t;for(var i=e.tryStack.pop();e.frame;){if(i.frame===e.frame){e.catchPC=i.catchPC;break}e.frame=e.frame.prev}},startCatch:function(){var t=this,e=t.lastEx;return t.lastEx=null,e},exit:function(t){this.frame=this.frame?this.frame.prev:null,this.retVal=t},enterTry:function(t){var e=this;e.tryStack.push({frame:e.frame,catchPC:t})},exitTry:function(){var t=this;t.tryStack.pop()},waitEvent:function(t,e){var i=this;if(i.suspend(),t.on){var n;e=e.concat(function(){i.lastEvent=arguments,i.retVal=arguments[0],n.remove(),i.steps()}),n=t.on.apply(t,e)}},runAsync:function(t){var e=this,i=function(){e.retVal=arguments,e.steps()},n=function(){for(var t="",i=0;i<arguments.length;i++)t+=arguments[i]+",";0==t.length&&(t="Async fail");var n=new Error(t);n.args=arguments,e.gotoCatch(n),e.steps()};e.suspend(),setTimeout(function(){t(i,n)},0)},waitFor:function(e){var i=this;return i._isWaiting=!0,i.suspend(),e instanceof r&&(e=e.promise()),t.ensureDefer(e).then(function(t){i.retVal=t,i.steps()}).fail(function(t){if(t instanceof Error)i.gotoCatch(t);else{var e=new Error(t);e.original=t,i.gotoCatch(e)}i.steps()})},resume:function(t){this.retVal=t,this.steps()},steps:function(){var t=this;if(!t.isDead()){var e=Tonyu.currentThread;for(Tonyu.currentThread=t,t.cnt=t.preemptionTime,t.preempted=!1,t.fSuspended=!1;t.cnt>0&&t.frame;)try{for(;t.cnt-->0&&t.frame;)t.frame.func(t);t.preempted=!t.fSuspended&&t.isAlive()}catch(i){t.gotoCatch(i)}Tonyu.currentThread=e}},kill:function(){var t=this;t._isDead=!0,t.frame=null,t.termStatus||(t.termStatus="killed",t.notifyTermination({status:"killed"}))},clearFrame:function(){this.frame=null,this.tryStack=[]}});return r}),requireSimulator.setName("Tonyu.Iterator"),define(["Class"],function(t){function e(t,e){if(t.tonyuIterator)return t.tonyuIterator(e);if(t instanceof Array)return 1==e?new i(t):new n(t);if(t instanceof Object)return 1==e?new r(t):new a(t);throw console.log(t),new Error(t+" is not iterable")}var i=t({initialize:function(t){this.set=t,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.set[this.i],this.i++,!0)}}),n=t({initialize:function(t){this.set=t,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.i,this[1]=this.set[this.i],this.i++,!0)}}),r=t({initialize:function(t){this.elems=[];for(var e in t)this.elems.push(e);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i],this.i++,!0)}}),a=t({initialize:function(t){this.elems=[];for(var e in t)this.elems.push([e,t[e]]);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i][0],this[1]=this.elems[this.i][1],this.i++,!0)}});return e}),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert","Tonyu.Thread","Tonyu.Iterator","DeferredUtil"],function(t,e,i,n){return Tonyu=function(){function r(){var t=new e;return t.handleEx=s,t}function a(t){return n.funcPromise(function(e){setTimeout(e,t)})}function o(){return n.funcPromise(function(t){requestAnimationFrame(t)})}function s(t){if(!Tonyu.onRuntimeError)throw"undefined"==typeof $LASTPOS&&($LASTPOS=0),alert("エラー! at "+$LASTPOS+" メッセージ  : "+t),console.log(t.stack),t;Tonyu.onRuntimeError(t)}function u(e,i){return t.is(arguments,[String,Object]),l(klass.getMeta(e),i)}function c(t,e){return t?l(Object.create(t.prototype),e):e}function l(t,e){if(e&&"object"==typeof e)for(var i in e)t[i]=e[i];return t}function f(t,e){A[t]=e}function h(t){return A[t]}function p(t){var e=t.split("."),i=P;if(e.forEach(function(t){i&&(i=i[t])}),!i&&1==e.length){var n;for(var r in P){var a=P[r][t];if(a){if(i)throw new Error("曖昧なクラス名： "+r+"."+t+", "+n);i=a,n=r+"."+t}}}return i}function d(t,e){if("function"!=typeof e)return e;var i=function(){return e.apply(t,arguments)};return i.methodInfo=Tonyu.extend({thiz:t},e.methodInfo||{}),e.fiber&&(i.fiber=function(){return e.fiber.apply(t,arguments)},i.fiber.methodInfo=Tonyu.extend({thiz:t},e.fiber.methodInfo||{})),i}function m(t,e,i,n){if(!t)throw new Error(n+"(="+t+")のメソッド "+e+"を呼び出せません");var r=t[e];if("function"!=typeof r)throw new Error(("this"==n?"":n+".")+e+"(="+r+")はメソッドではありません");return r.apply(t,i)}function g(t,e,i){if("function"!=typeof t)throw new Error(i+"は関数ではありません");return t.apply({},e)}function v(t,e){if(t!=t||null==t)throw new Error(e+"(="+t+")は初期化されていません");return t}function y(t){for(var e=[],i=1;i<t.length;i++)e[i-1]=t[i];return e}function b(t){throw new Error("クラス名"+t+"はnewをつけて呼び出して下さい。")}function T(t){throw console.log("Not a tonyu object: ",t),new Error(t+" is not a tonyu object")}function M(t,e){return t in e}function S(t){var e=p(t);if(!e)throw new Error(t+" というクラスはありません");Tonyu.runMode=!0;var i=new e,n=r();n.apply(i,"main");var a;(a=Tonyu.currentProject)&&(a.runningThread=n,a.runningObj=i),$LASTPOS=0,n.steps()}klass=function(){throw alert("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again."),new Error("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again.")},klass.addMeta=u,klass.removeMeta=function(t){delete L[t]},klass.getMeta=function(t){if("function"==typeof t)return t.meta;if("string"==typeof t){var e=L[t];return e||(L[t]=e={}),e}},klass.ensureNamespace=function(t,e){var i,n=e.split("."),r=t;for(i=0;i<n.length;i++){var a=n[i];r[a]||(r[a]={}),r=r[a]}return r},Function.prototype.constructor=function(){throw new Error("This method should not be called")},klass.define=function(t){var e=t.superclass,i=t.includes,n=t.fullName,r=t.shortName,a=t.namespace,o=t.methods,s=t.decls,l=klass.ensureNamespace(Tonyu.classes,a),f=o,h=f.initialize;delete f.initialize;var p;p=h?function(){this instanceof p||b(n),h.apply(this,arguments)}:e?function(){this instanceof p||b(n),e.apply(this,arguments)}:function(){this instanceof p||b(n)},l[r]=p,p.methods=f,i.forEach(function(t){if(!t.methods)throw t+" Does not have methods";for(var e in t.methods)e in f||(f[e]=t.methods[e])});var d={},m=/^__([gs]et)ter__(.*)$/;for(var g in f)if(!g.match(/^fiber\$/)){f["fiber$"+g]&&(f[g].fiber=f["fiber$"+g],f[g].fiber.methodInfo={name:g,klass:p,fiber:!0}),f[g].methodInfo={name:g,klass:p};var v=m.exec(g);v&&(d[v[2]]=d[v[2]]||{},d[v[2]][v[1]]=f[g])}p.prototype=c(e,f),p.prototype.isTonyuObject=!0;for(var g in d)Object.defineProperty(p.prototype,g,d[g]);p.meta=u(n,{fullName:n,shortName:r,namepsace:a,decls:s,superclass:e?e.meta:null,func:p,includes:i.map(function(t){return t.meta})});var y=klass.getMeta(p);return p.prototype.getClassInfo=function(){return y},p},klass.isSourceChanged=function(t){return t=t.meta||t,t.src&&t.src.tonyu?t.nodeTimestamp?t.src.tonyu.lastUpdate()>t.nodeTimestamp:!0:!1},klass.shouldCompile=function(t){if(t=t.meta||t,klass.isSourceChanged(t))return!0;for(var e=klass.getDependingClasses(t),i=0;i<e.length;i++)if(klass.shouldCompile(e[i]))return!0},klass.getDependingClasses=function(t){t=t.meta||t;var e=[];return t.superclass&&(e=[t.superclass]),t.includes&&(e=e.concat(t.includes)),e};var A={},P={},L={};return Tonyu={thread:r,klass:klass,bless:c,extend:l,globals:A,classes:P,classMetas:L,setGlobal:f,getGlobal:h,getClass:p,timeout:a,animationFrame:o,bindFunc:d,not_a_tonyu_object:T,hasKey:M,invokeMethod:m,callFunc:g,checkNonNull:v,run:S,iterator:i,VERSION:1500189381377,A:y}}()}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(t){var e=function(t,e){this.options=e||{},this.img=t,this.height=t.height,this.width=t.width;var i=this.newImage(t.width,t.height),n=i.getContext("2d");n.drawImage(t,0,0),this.ctx=n,this.pixels=this.ctx.getImageData(0,0,t.width,t.height).data,this.base=this.getPixel(0,0)};return t.extend(e.prototype,{newImage:function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i},getPixel:function(t,e){var i=this.pixels,n=4*(t+e*this.width),r=i[0+n],a=i[1+n],o=i[2+n],s=i[3+n];return 256*(256*(256*s+o)+a)+r},setPixel:function(t,e,i){var n=4*(t+e*this.width);this.pixels[0+n]=255&i,i=(i-(255&i))/256,this.pixels[1+n]=255&i,i=(i-(255&i))/256,this.pixels[2+n]=255&i,i=(i-(255&i))/256,this.pixels[3+n]=255&i},parse:function(){try{for(var t=[],e=0;e<this.height;e++)for(var i=0;i<this.width;i++){var n=this.getPixel(i,e);n!=this.base&&t.push(this.parse1Pattern(i,e))}return t}catch(r){if(r.isParseError)return console.log("parse error! "+r),[{image:this.img,x:0,y:0,width:this.width,height:this.height}];throw r}},parse1Pattern:function(t,e){function i(t){return t}function n(t,e,i){return{toString:function(){return"at ("+t+","+e+") :"+i},isParseError:!0}}for(var r=this.getPixel(t,e),a=t,o=e,s=this.base,u=this.width,c=this.height;u>a;){var l=this.getPixel(a,o);if(l!=r)break;a++}if(a>=u||this.getPixel(a,o)!=s)throw n(a,o,i(this.getPixel(a,o))+"!="+i(s));for(a--;c>o&&this.getPixel(a,o)==r;)o++;if(o>=c||this.getPixel(a,o)!=s)throw n(a,o,i(this.getPixel(a,o))+"!="+i(s));o--;var f=t+1,h=e+1,p=a-f,d=o-h;if(console.log("PP",f,h,p,d,a,o),p*d==0)throw n(a,o,"w*h==0");for(var m=this.newImage(p,d),g=m.getContext("2d"),v=g.getImageData(0,0,p,d),y=v.data,b=0,T=h;o>T;T++)for(var M=f;a>M;M++){var S=this.getPixel(M,T);S==r?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S,S=(S-(255&S))/256,y[b++]=255&S)}g.putImageData(v,0,0);for(var A=h-1;o>=A;A++)for(var P=f-1;a>=P;P++)this.setPixel(P,A,s);return this.options.boundsInSrc?{x:f,y:h,width:p,height:d}:{image:m,x:0,y:0,width:p,height:d}}}),e}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu"],function(t,e,i){var n={};return n.resolve=function(i,n){if(null==i&&(i=""),i=i.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,i){return t[i]}),t.urlAliases[i]&&(i=t.urlAliases[i]),e.startsWith(i,"ls:")){var r=i.substring("ls:".length);if(!n)throw new Error("Basedir not specified");var a=n.rel(r);if(!a.exists())throw new Error("Resource file not found: "+a);if(t.mp3Disabled&&r.match(/\.(mp3|mp4|m4a)$/)){var o=n.rel(r.replace(/\.(mp3|mp4|m4a)$/,".ogg"));o.exists()&&(a=o)}i=a.getURL()}return i},i.Assets=n,n}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets","assert"],function(t,e,i,n){function r(t){var e=[];return t.forEach(function(t){t&&""!=t.url&&e.push(t)}),e}var a,o={};return a=function(e,i,s){s||(s={}),e=r(e);var u=[],c=e.length;0==c&&setTimeout(function(){var t=[];t.names={},i(t)},0),e.forEach(function(e,r){function l(){var a,o;if("single"==e.type)u[r]=[{image:this,x:0,y:0,width:this.width,height:this.height}];else if((a=e.pwidth)&&(o=e.pheight)){for(var s=0,l=0,f=this.width,h=this.height,p=[];;){var d=a,m=o;if(s+a>f&&(d=f-s),l+o>h&&(m=h-l),p.push({image:this,x:s,y:l,width:d,height:m}),s+=a,s+a>f&&(s=0,l+=o,l+o>h))break}u[r]=p}else{var g=new t(this);u[r]=g.parse()}if(u[r].name=e.name,n.is(u[r],Array),c--,0==c){var v=[],y={};u.forEach(function(t){y[t.name]=v.length,v=v.concat(t)}),v.names=y,i(v)}}console.log("loading",e,r);var f=e.url,h=f;if(o[h])return void l.apply(o[h],[]);f=a.convURL(f,s.baseDir);var p=$("<img>");p.load(function(){o[h]=this,l.apply(this,[])}),p.attr("src",f)})},a.load=a,a.parse1=function(e,i,r){var a,o,s;if((a=e.pwidth)&&(o=e.pheight)){for(var u=0,c=0,l=i.width,f=i.height,h=[];;)if(h.push({image:this,x:u,y:c,width:a,height:o}),u+=a,u+a>l&&(u=0,c+=o,c+o>f))break;s=h}else{var p=new t(i,r);s=p.parse()}return s.name=e.name,n.is(s,Array)},a.convURL=function(t,e){return i.resolve(t,e)},window.ImageList=a,a}),requireSimulator.setName("PicoAudio");var PicoAudio=function(){function t(t,e){var i=window.AudioContext||window.webkitAudioContext;this.context=t?t:new i,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,hashLength:this.isAndroid()?25:50,hashBuffer:2,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!this.isAndroid(),reverbVolume:1.5,isChorus:!0,chorusVolume:.5,isCC111:!0,dramMaxPlayLength:.5,loop:!1},this.trigger={isNoteTrigger:!0,noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1;for(var n=0;17>n;n++)this.channels.push([0,0,1]);if(e&&e.whitenoise)this.whitenoise=e.whitenoise;else{this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate);for(var r=0;2>r;r++)for(var n=0;n<this.context.sampleRate;n++)this.whitenoise.getChannelData(r)[n]=2*Math.random()-1}if(this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,e&&e.impulseResponse)this.impulseResponse=e.impulseResponse;else{var a=3.5*this.context.sampleRate;this.impulseResponse=this.context.createBuffer(2,a,this.context.sampleRate);for(var r=0;2>r;r++)for(var o=this.impulseResponse.getChannelData(r),n=0;a>n;n++){var s=(a-n)/a,u=n/this.context.sampleRate,c=(.03>u?0:s)*(u>=.03&&.031>u?2*s:s)*(u>=.04&&.042>u?1.5*s:s)*(u>=.05&&.054>u?1.25*s:s)*Math.random()*.2*Math.pow(s-.03,4);o[n]=c}}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!1,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0),this.onSongEndListener=null}return t.prototype.createNote=function(t){var e=!1;if(t.channel)switch(this.channels[t.channel][1]/10||t.instrument){case.2:case 12:case 13:case 45:case 55:e=!0
}var i=this.createBaseNote(t,!0,!1,e),n=i.oscillator,r=i.gainNode,a=(i.panNode,i.noiseCutGainNode),o=!1,s=this;switch(this.channels[i.channel][0]/10||t.instrument){case.1:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",r.gain.value*=1.5;break;case.2:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",r.gain.value*=.8;break;case.3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:n.type="sawtooth";break;case.4:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",r.gain.value*=1.5;break;default:n.type="square"}switch(this.channels[i.channel][1]/10||t.instrument){case.2:case 12:case 13:case 45:case 55:o=!0,r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(0,i.start+.2),s.stopAudioNode(n,i.start+.5,r);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(.95*r.gain.value,i.start+.1),r.gain.setValueAtTime(.95*r.gain.value,i.start+.1),r.gain.linearRampToValueAtTime(0,i.start+1.5+3*i.velocity);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(0,i.start+1+4*i.velocity);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:r.gain.value*=1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(.95*r.gain.value,i.start+.1),r.gain.setValueAtTime(.95*r.gain.value,i.start+.1),r.gain.linearRampToValueAtTime(0,i.start+2+10*i.velocity);break;case 119:r.gain.value=0,s.stopAudioNode(n,0,r)}return("sine"==n.type||"triangle"==n.type)&&!o&&i.stop-i.start>.01&&(a.gain.setValueAtTime(1,i.stop-.005),a.gain.linearRampToValueAtTime(0,i.stop)),function(){s.stopAudioNode(n,0,r)}},t.prototype.createPercussionNote=function(t){var e=this.createBaseNote(t,!1),i=e.oscillator,n=e.gainNode,r=(e.panNode,e.start),a=(e.stop,e.velocity*((t.expression?t.expression[0].value:100)/127)),o=this.createBaseNote(t,!1,!0),s=o.oscillator,u=o.gainNode,c=(o.panNode,this);switch(t.pitch){case 35:case 36:n.gain.value=.6*a,i.playbackRate.value=.02,c.stopAudioNode(i,r+.07,n),u.gain.value=1.1*a,s.frequency.setValueAtTime(120,r),s.frequency.linearRampToValueAtTime(50,r+.07),c.stopAudioNode(s,r+.07,u);break;case 38:case 40:i.playbackRate.value=.7,c.stopAudioNode(i,r+.05,n),u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.05),s.frequency.setValueAtTime(300,r),s.frequency.linearRampToValueAtTime(200,r+.05),c.stopAudioNode(s,r+.05,u);break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,c.stopAudioNode(i,r+.1,n),s.type="square",u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(.01,r+.1),s.frequency.setValueAtTime(150+20*(t.pitch-40),r),s.frequency.linearRampToValueAtTime(50+20*(t.pitch-40),r+.1),c.stopAudioNode(s,r+.1,u);break;case 42:case 44:i.playbackRate.value=1.5,c.stopAudioNode(i,r+.02,n),c.stopAudioNode(s,0,u);break;case 46:i.playbackRate.value=1.5,c.stopAudioNode(i,r+.3,n),n.gain.setValueAtTime(.9*a,r),n.gain.linearRampToValueAtTime(0,r+.3),c.stopAudioNode(s,0,u);break;case 49:case 51:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,c.stopAudioNode(i,r+.5,n),n.gain.setValueAtTime(1*a,r),n.gain.linearRampToValueAtTime(0,r+.5),c.stopAudioNode(s,0,u);break;case 51:i.playbackRate.value=1.1,c.stopAudioNode(i,r+.4,n),n.gain.setValueAtTime(.8*a,r),n.gain.linearRampToValueAtTime(0,r+.4),c.stopAudioNode(s,0,u);break;case 59:i.playbackRate.value=1.8,c.stopAudioNode(i,r+.3,n),n.gain.setValueAtTime(.5*a,r),n.gain.linearRampToValueAtTime(0,r+.3),c.stopAudioNode(s,0,u);break;case 60:case 61:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(400-40*(t.pitch-60),r),s.frequency.linearRampToValueAtTime(450-40*(t.pitch-60),r+.1),c.stopAudioNode(s,r+.1,u);break;case 62:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.03),s.frequency.setValueAtTime(200,r),s.frequency.linearRampToValueAtTime(250,r+.03),c.stopAudioNode(s,r+.03,u);break;case 63:case 64:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(200-30*(t.pitch-63),r),s.frequency.linearRampToValueAtTime(250-30*(t.pitch-63),r+.1),c.stopAudioNode(s,r+.1,u);break;case 56:case 75:i.playbackRate.value=.01,c.stopAudioNode(i,r+.1,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(1e3+48*(t.pitch-56),r),c.stopAudioNode(s,r+.1,u);break;case 80:i.playbackRate.value=5,n.gain.setValueAtTime(.5*a,r),n.gain.linearRampToValueAtTime(0,r+.2),c.stopAudioNode(i,r+.05,n),s.type="triangle",u.gain.setValueAtTime(.7*a,r),u.gain.linearRampToValueAtTime(0,r+.2),s.frequency.setValueAtTime(6e3,r),c.stopAudioNode(s,r+.05,u);break;case 81:i.playbackRate.value=5,n.gain.setValueAtTime(.9*a,r),n.gain.linearRampToValueAtTime(0,r+.5),c.stopAudioNode(i,r+.5,n),s.type="triangle",u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.3),s.frequency.setValueAtTime(6e3,r),c.stopAudioNode(s,r+.3,u);break;default:i.playbackRate.value=t.pitch/69*2,c.stopAudioNode(i,r+.05,n),c.stopAudioNode(s,0,u)}return function(){c.stopAudioNode(i,0,n),c.stopAudioNode(s,0,u)}},t.prototype.createBaseNote=function(t,e,i,n){var r=this.settings,a=this.context,o=this.states.startTime,s=this.getTime(t.start)+o,u=this.getTime(t.stop)+o,c=r.basePitch*Math.pow(Math.pow(2,1/12),(t.pitch||69)-69),l=i?0:t.channel||0,f=t.velocity*Number(i?1:this.channels[l][2]||1)*r.generateVolume,h=9!=l?a.createOscillator():a.createBufferSource(),p=a.createStereoPanner?a.createStereoPanner():a.createPanner?a.createPanner():{pan:{setValueAtTime:function(){}}},d=a.createGain(),m=a.createGain(),g=this;if(!a.createStereoPanner&&a.createPanner){var v=t.pan&&64!=t.pan[0].value?t.pan[0].value/127*2-1:0;v>1&&(v=1);var y=90*v,b=Math.sin(y*(Math.PI/180)),T=-Math.cos(y*(Math.PI/180));p.panningModel="equalpower",p.setPosition(b,0,T)}else if(a.createStereoPanner){var v=t.pan&&64!=t.pan[0].value?t.pan[0].value/127*2-1:0;v>1&&(v=1),p.pan.value=v}if(d.gain.value=f*((t.expression?t.expression[0].value:100)/127),9!=l?(h.type=t.type||"sine",h.detune.value=0,h.frequency.value=c,t.pitchBend?t.pitchBend.forEach(function(e){h.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),t.pitch-69+e.value),g.getTime(e.timing)+o)}):!1):(h.loop=!0,h.buffer=this.whitenoise),e&&(t.expression?t.expression.forEach(function(t){d.gain.setValueAtTime(f*(t.value/127),g.getTime(t.timing)+o)}):!1),a.createStereoPanner||a.createPanner){var M=!0;a.createStereoPanner?t.pan?t.pan.forEach(function(t){if(M)return void(M=!1);var e=64==t.value?0:t.value/127*2-1;e>1&&(e=1),p.pan.setValueAtTime(e,g.getTime(t.timing)+o)}):!1:a.createPanner&&(p.positionX?t.pan?t.pan.forEach(function(t){if(M)return void(M=!1);var e=64==t.value?0:t.value/127*2-1;e>1&&(e=1);var i=90*e,n=Math.sin(i*(Math.PI/180)),r=-Math.cos(i*(Math.PI/180));p.positionX.setValueAtTime(n,g.getTime(t.timing)+o),p.positionY.setValueAtTime(0,g.getTime(t.timing)+o),p.positionZ.setValueAtTime(r,g.getTime(t.timing)+o)}):!1:t.pan?t.pan.forEach(function(t){if(M)return void(M=!1);var e=setTimeout(function(){g.clearFunc("pan",e);var i=64==t.value?0:t.value/127*2-1;i>1&&(i=1);var n=90*i,r=Math.sin(n*(Math.PI/180)),a=-Math.cos(n*(Math.PI/180));p.setPosition(r,0,a)},1e3*(g.getTime(t.timing)+o-a.currentTime));g.pushFunc({pan:e,stopFunc:function(){clearTimeout(e)}})}):!1),h.connect(p),p.connect(d)}else h.connect(d);if(d.connect(m),m.connect(this.masterGainNode),this.masterGainNode.connect(a.destination),9!=l&&t.modulation&&(t.modulation.length>=2||t.modulation[0].value>0)){var S=a.createOscillator(),A=a.createGain();M=!0,t.modulation?t.modulation.forEach(function(t){if(M)return void(M=!1);var e=t.value/127;e>1&&(e=1),A.gain.setValueAtTime(10*c/440*e,g.getTime(t.timing)+o)}):!1;var P=t.modulation?t.modulation[0].value/127:0;P>1&&(P=1),A.gain.value=10*c/440*P,S.frequency.value=6,S.connect(A),A.connect(h.frequency)}if(this.settings.isReverb&&t.reverb&&(t.reverb.length>=2||t.reverb[0].value>0)){var L=this.convolver,w=(this.masterGainNode,a.createGain());M=!0,t.reverb?t.reverb.forEach(function(t){if(M)return void(M=!1);var e=t.value/127;e>1&&(e=1),w.gain.setValueAtTime(e,g.getTime(t.timing)+o)}):!1;var x=t.reverb?t.reverb[0].value/127:0;x>1&&(x=1),w.gain.value=x,d.connect(w),w.connect(L)}if(this.settings.isChorus&&t.chorus&&(t.chorus.length>=2||t.chorus[0].value>0)){var B=this.chorusDelayNode,D=(this.masterGainNode,a.createGain());M=!0,t.chorus?t.chorus.forEach(function(t){if(M)return void(M=!1);var e=t.value/127;e>1&&(e=1),D.gain.setValueAtTime(e,g.getTime(t.timing)+o)}):!1;var E=t.chorus?t.chorus[0].value/127:0;E>1&&(E=1),D.gain.value=E,d.connect(D),D.connect(B)}return S&&(S.start(s),this.stopAudioNode(S,u,A)),h.start(s),9==l||i||n||this.stopAudioNode(h,u,d),{start:s,stop:u,pitch:c,channel:l,velocity:f,oscillator:h,panNode:p,gainNode:d,noiseCutGainNode:m}},t.prototype.startWebMIDI=function(){var t,e=this;if(navigator.requestMIDIAccess){var i=this.settings.WebMIDIPortSysEx,n=function(n){t=n.outputs,e.settings.WebMIDIPortOutputs=t;var r;return-1==e.settings.WebMIDIPort?e.settings.WebMIDIPortOutputs.forEach(function(t){r||(r=t)}):r=e.settings.WebMIDIPortOutputs.get(settings.WebMIDIPort),e.settings.WebMIDIPortOutput=r,e.settings.WebMIDIPortSysEx=i,r&&(r.open(),e.initStatus()),t},r=function(t){console.log(t),i&&(i=!1,navigator.requestMIDIAccess({sysex:i}).then(n).catch(r))};navigator.requestMIDIAccess({sysex:i}).then(n).catch(r),window.addEventListener("unload",function(){for(var t=0;16>t;t++){e.settings.WebMIDIPortOutput.send([176+t,120,0]);for(var i=0;128>i;i++)e.settings.WebMIDIPortOutput.send([128+t,i,0])}})}},t.prototype.initStatus=function(t,e){if(!this.settings.isWebMIDI||null==this.states.webMIDIWaitState){this.stop(t);var i=this.states.webMIDIStopTime;if(this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0},this.states.webMIDIStopTime=i,this.settings.isWebMIDI&&!e){if(t)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var n=0;16>n;n++)this.settings.WebMIDIPortOutput.send([192+n,0]),this.settings.WebMIDIPortOutput.send([224+n,0,64]),this.settings.WebMIDIPortOutput.send([176+n,100,0]),this.settings.WebMIDIPortOutput.send([176+n,101,0]),this.settings.WebMIDIPortOutput.send([176+n,6,2]),this.settings.WebMIDIPortOutput.send([176+n,100,1]),this.settings.WebMIDIPortOutput.send([176+n,96,0]),this.settings.WebMIDIPortOutput.send([176+n,97,64]),this.settings.WebMIDIPortOutput.send([176+n,7,100]),this.settings.WebMIDIPortOutput.send([176+n,10,64]),this.settings.WebMIDIPortOutput.send([176+n,11,127]),this.settings.WebMIDIPortOutput.send([176+n,98,0]),this.settings.WebMIDIPortOutput.send([176+n,99,0]),this.settings.WebMIDIPortOutput.send([176+n,122,0])}}},t.prototype.stop=function(t){var e=this.states,i=this;if(0!=e.isPlaying&&(e.isPlaying=!1,e.playIndex-=this.settings.hashBuffer+1,e.stopTime=this.context.currentTime,e.stopFuncs.forEach(function(t){t.stopFunc()}),e.stopFuncs=[],this.settings.isWebMIDI)){if(t)return;if(null==this.settings.WebMIDIPortOutput)return;e.webMIDIStopTime=this.context.currentTime,setTimeout(function(){for(var t=0;16>t;t++){i.settings.WebMIDIPortOutput.send([176+t,120,0]);for(var e=0;128>e;e++)i.settings.WebMIDIPortOutput.send([128+t,e,0])}},200)}},t.prototype.play=function(t){var e=this.context,i=this.settings,n=this.trigger,r=this.states,a=this.hashedDataList,o=this;if(1!=r.isPlaying){if(i.isWebMIDI&&!t){if("completed"!=r.webMIDIWaitState){if("waiting"!=r.webMIDIWaitState){r.webMIDIWaitState="waiting";var s=800-1e3*(e.currentTime-r.webMIDIStopTime);0==r.webMIDIStopTime&&(s=800),setTimeout(function(){o.states.webMIDIWaitState="completed",o.states.isPlaying=!1,o.play()},s)}return}r.webMIDIWaitState=null}{var u=this.context.currentTime;r.startTime}r.isPlaying=!0,r.startTime=r.startTime||r.stopTime?r.startTime+u-r.stopTime:u,r.stopFuncs=[];var c=this.getTime(this.firstNoteOnTiming);-r.startTime+u<c&&this.setStartTime(c+r.startTime-u);var l,f=function(){o.clearFunc("rootTimeout",l);var t=o.getTime(o.settings.isCC111&&-1!=o.cc111Time?o.lastNoteOffTiming:o.getTiming(Number.MAX_SAFE_INTEGER));t-e.currentTime+r.startTime<=0?o.onSongEnd():(l=setTimeout(f,1),o.pushFunc({rootTimeout:l,stopFunc:function(){clearTimeout(l)}}))},h=this.getTime(this.settings.isCC111&&-1!=this.cc111Time?this.lastNoteOffTiming:this.getTiming(Number.MAX_SAFE_INTEGER)),p=1e3*(h-e.currentTime+r.startTime);l=setTimeout(f,p),o.pushFunc({rootTimeout:l,stopFunc:function(){clearTimeout(l)}}),function d(t){if(r.playIndex=t,a&&a[t]&&a[t].forEach(function(t){i.isWebMIDI||o.pushFunc({note:t,stopFunc:9!=t.channel?o.createNote(t):o.createPercussionNote(t)});var a=setTimeout(function(){o.clearFunc("timeout",a),n.isNoteTrigger&&n.noteOn(t);var e=setTimeout(function(){o.clearFunc("timeout",e),o.clearFunc("note",t),n.isNoteTrigger&&n.noteOff(t)},9!=t.channel?1e3*(o.getTime(t.stop)-o.getTime(t.start)):1e3*o.settings.dramMaxPlayLength);o.pushFunc({timeout:e,stopFunc:function(){clearTimeout(e)}})},1e3*(o.getTime(t.start)-e.currentTime+r.startTime));o.pushFunc({timeout:a,stopFunc:function(){clearTimeout(a)}})}),i.isWebMIDI&&o.hashedMessageList&&o.hashedMessageList[t]&&o.hashedMessageList[t].forEach(function(t){if(null!=i.WebMIDIPortOutput&&255!=t.message[0]&&(o.settings.WebMIDIPortSysEx||240!=t.message[0]&&247!=t.message[0]))try{i.WebMIDIPortOutput.send(t.message,1e3*(o.getTime(t.timing)-e.currentTime+window.performance.now()/1e3+r.startTime))}catch(n){console.log(n,t.message)}}),t<a.length)if(t-Math.floor(1e3*(e.currentTime-r.startTime)/i.hashLength)<=i.hashBuffer)d(t+1);else{var s=setTimeout(function(){d(t+1),o.clearFunc("rootTimeout",s)},i.hashLength);o.pushFunc({rootTimeout:s,stopFunc:function(){clearTimeout(s)}})}else n.songEnd()}(r.playIndex||0)}},t.prototype.setData=function(t){this.states.isPlaying&&this.stop(),this.settings.resolution=t.header.resolution,this.settings.tempo=t.tempo||120,this.tempoTrack=t.tempoTrack,this.cc111Time=t.cc111Time,this.firstNoteOnTiming=t.firstNoteOnTiming,this.lastNoteOffTiming=t.lastNoteOffTiming;var e=this,i=[];if(t.channels.forEach(function(t){t.notes.forEach(function(t){var n=e.getTime(t.start)*(1e3/e.settings.hashLength);i[Math.floor(n)]||(i[Math.floor(n)]=[]),i[Math.floor(n)].push(t)})}),this.settings.isWebMIDI){var n=[];t.messages.forEach(function(t){var i=e.getTime(t.timing)*(1e3/e.settings.hashLength);n[Math.floor(i)]||(n[Math.floor(i)]=[]),n[Math.floor(i)].push(t)}),this.hashedMessageList=n}return this.hashedDataList=i,this.initStatus(),this},t.prototype.getMasterVolume=function(){return this.settings.masterVolume},t.prototype.setMasterVolume=function(t){this.settings.masterVolume=t,this.masterGainNode.gain.value=this.settings.masterVolume},t.prototype.isLoop=function(){return this.settings.loop},t.prototype.setLoop=function(t){this.settings.loop=t},t.prototype.isWebMIDI=function(){return this.settings.isWebMIDI},t.prototype.setWebMIDI=function(t){this.settings.isWebMIDI=t},t.prototype.isCC111=function(){return this.settings.isCC111},t.prototype.setCC111=function(t){this.settings.isCC111=t},t.prototype.setStartTime=function(t){this.states.startTime-=t,this.states.playIndex=Math.floor(1e3*t/this.settings.hashLength)},t.prototype.setOnSongEndListener=function(t){this.onSongEndListener=t},t.prototype.onSongEnd=function(){if(this.onSongEndListener){var t=this.onSongEndListener();if(t)return}this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.getTime(this.cc111Time)),this.play(!0))},t.prototype.isReverb=function(){return this.settings.isReverb},t.prototype.setReverb=function(t){this.settings.isReverb=t},t.prototype.getReverbVolume=function(){return this.settings.reverbVolume},t.prototype.setReverbVolume=function(t){this.settings.reverbVolume=t},t.prototype.isChorus=function(){return this.settings.isChorus},t.prototype.setChorus=function(t){this.settings.isChorus=t},t.prototype.getChorusVolume=function(){return this.settings.chorusVolume},t.prototype.setChorusVolume=function(t){this.settings.chorusVolume=t},t.prototype.isAndroid=function(){var t=navigator.userAgent.toLowerCase();return-1!=t.indexOf("android")&&-1==t.indexOf("windows")},t.prototype.getTime=function(t){var e=0,i=120,n=0,r=this;return this.tempoTrack.some(function(a){return t<a.timing?!0:(e+=60/i/r.settings.resolution*(a.timing-n),n=a.timing,void(i=a.value))}),e+=60/i/r.settings.resolution*(t-n)},t.prototype.getTiming=function(t){var e=0,i=120,n=0,r=this;return this.tempoTrack.some(function(a){return e+=60/i/r.settings.resolution*(a.timing-n),e>t?(e-=60/i/r.settings.resolution*(a.timing-n),n+=(t-e)/(60/i/r.settings.resolution),!0):(n=a.timing,void(i=a.value))}),n},t.prototype.parseSMF=function(t){function e(t){for(var e=0,i=0;i<t.length;i++)e=(e<<8)+t[i];return e}function i(t){for(var e=0,i=0;e<t.length-1&&t[e]>=128;)4>e&&(i=(i<<7)+(t[e]-128)),e++;return i=(i<<7)+t[e],e++,[i,e]}if(77!=t[0]||84!=t[1]||104!=t[2]||100!=t[3])return"Not Sandard MIDI File.";var n=new Object,r=4,a=new Object;a.size=e(t.subarray(4,8)),a.format=t[9],a.trackcount=e(t.subarray(10,12)),a.timemanage=t[12],a.resolution=e(t.subarray(12,14)),r+=4+a.size;for(var o=new Array,s=new Array,u=new Array,c=-1,l=Number.MAX_SAFE_INTEGER,f=0,h=0;16>h;h++){var p=new Object;u.push(p),p.messages=[],p.notes=[]}var d=0;if(this.settings.isWebMIDI)var m=[];for(var g=0;g<a.trackcount;g++){if(77!=t[r]||84!=t[r+1]||114!=t[r+2]||107!=t[r+3])return"Irregular SMF.";r+=4;var v=(new Object,r+4+e(t.subarray(r,r+4)));r+=4;for(var y=0,b=1;v>r;){if(null!=b){var T=i(t.subarray(r,r+5)),M=T[0];y+=M,y>1e8&&(y=1e8),r+=T[1]}if(this.settings.isWebMIDI)var S=r;var A,P={timing:y,mes:[]};switch(Math.floor(t[r]/16)){case 8:case 9:case 10:case 11:case 14:b=t[r],P.mes.push(t[r],t[r+1],t[r+2]);var L=u[15&b].messages;for(A=L.length-1;A>=0;A--){var w=L[A];if(y>=w.timing)break}A++,L.splice(A,0,P),r+=3;break;case 12:case 13:b=t[r],P.mes.push(t[r],t[r+1]);var L=u[15&b].messages;for(A=L.length-1;A>=0;A--){var w=L[A];if(y>=w.timing)break}A++,L.splice(A,0,P),r+=2;break;case 15:switch(t[r]){case 240:case 247:var T=i(t.subarray(r+1,r+1+4));if(T[0]>=7&&127==t[r+2]&&127==t[r+3]&&4==t[r+4]&&1==t[r+5])for(var h=0;16>h;h++){P.mes.push(t[r],T[0]-1,t[r+2],t[r+3],t[r+4],t[r+5],t[r+6],t[r+7]);var L=u[h].messages;for(A=L.length-1;A>=0;A--){var w=L[A];if(y>=w.timing)break}A++,L.splice(A,0,P)}r+=1+T[1]+T[0];break;case 241:r+=2;break;case 242:r+=3;break;case 243:r+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:r+=1;break;case 255:switch(t[r+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:y+=a.resolution-M;break;case 81:n.tempo=6e7/(65536*t[r+3]+256*t[r+4]+t[r+5]),o.push({timing:y,value:6e7/(65536*t[r+3]+256*t[r+4]+t[r+5])});break;case 84:break;case 88:s.push({timing:y,value:[t[r+3],Math.pow(2,t[r+4])]});break;case 89:case 127:}var T=i(t.subarray(r+2,r+2+4));r+=2+T[1]+T[0]}break;default:if(null==b)return"Irregular SMF.";r--,t[r]=b,b=null}if(this.settings.isWebMIDI&&null!=b){var x=t[S];if(240==x||247==x){if(this.settings.WebMIDIPortSysEx){var T=i(t.subarray(S+1,S+1+4)),B=S+1+T[1],D=B+T[0],E=new Uint8Array(1+T[0]);E[0]=x;for(var I=D-B,h=0;I>h;h++)E[h+1]=t[B+h];m.push({message:E,timing:y})}}else m.push({message:t.subarray(S,r),timing:y})}}y>d&&(d=y)}o.push({timing:d,value:120});for(var N=0;N<u.length;N++){for(var p=u[N],r=0,v=p.messages.length,G=2,k=0,O=64,_=127,R=100,C=0,V=0,F=0,W=127,j=127,U=127,q=127,$=null,z=127,K=[];v>r;){var P=p.messages[r],y=P.timing,H=p.messages[r].mes;switch(Math.floor(H[0]/16)){case 8:var h=0;K.some(function(t){var e=p.notes[t];return e.pitch==H[1]&&null==e.stop?(e.stop=y,K.splice(h,1),y>f&&(f=y),!0):void h++});break;case 9:if(0!=H[2]){var X={start:y,stop:null,pitch:H[1],pitchBend:[{timing:y,value:k}],pan:[{timing:y,value:O}],expression:[{timing:y,value:_*(z/127)}],velocity:H[2]/127*(R/127),modulation:[{timing:y,value:C}],reverb:[{timing:y,value:V}],chorus:[{timing:y,value:F}],instrument:$,channel:N};K.push(p.notes.length),p.notes.push(X),l>y&&(l=y)}else{var h=0;K.some(function(t){var e=p.notes[t];return e.pitch==H[1]&&null==e.stop?(e.stop=y,K.splice(h,1),y>f&&(f=y),!0):void h++})}break;case 10:break;case 11:switch(H[1]){case 1:C=H[2],K.forEach(function(t){var e=p.notes[t];e.modulation.push({timing:y,value:C})});break;case 6:0==U&&0==q&&(G=H[2],G>24&&(G=24));break;case 7:R=H[2];break;case 10:O=H[2],K.forEach(function(t){var e=p.notes[t];e.pan.push({timing:y,value:O})});break;case 11:_=H[2],K.forEach(function(t){var e=p.notes[t];e.expression.push({timing:y,value:_*(z/127)})});break;case 91:V=H[2],K.forEach(function(t){var e=p.notes[t];e.reverb.push({timing:y,value:V})});break;case 93:F=H[2],K.forEach(function(t){var e=p.notes[t];e.chorus.push({timing:y,value:F})});break;case 98:W=H[2];break;case 99:j=H[2];break;case 100:U=H[2];break;case 101:q=H[2];break;case 111:-1==c&&(c=y)}break;case 12:$=H[1];break;case 13:break;case 14:k=(128*H[2]+H[1]-8192)/8192*G,K.forEach(function(t){var e=p.notes[t];e.pitchBend.push({timing:y,value:k})});break;case 15:switch(H[0]){case 240:case 247:if(H[1]>=6&&127==H[2]&&127==H[3]&&4==H[4]&&1==H[5]){var Y=H[7];Y>127&&(Y=127),z=Y,K.forEach(function(t){var e=p.notes[t];e.expression.push({timing:y,value:_*(z/127)})})}}break;default:return"Error parseSMF."}r++}delete p.messages}return n.header=a,n.tempoTrack=o,n.beatTrack=s,n.channels=u,n.songLength=d,n.cc111Time=c,n.firstNoteOnTiming=l,n.lastNoteOffTiming=f,this.settings.isWebMIDI&&(n.messages=m),n},t.prototype.stopAudioNode=function(t,e,i){try{e>0?t.stop(e):(t.stop(this.context.currentTime+.005),i.gain.cancelScheduledValues(this.context.currentTime),i.gain.linearRampToValueAtTime(0,this.context.currentTime+.005))}catch(n){i.gain.cancelScheduledValues(e),0>=e&&i.gain.linearRampToValueAtTime(0,this.context.currentTime+.005)}},t.prototype.pushFunc=function(t){(t.note||t.rootTimeout||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(t)},t.prototype.clearFunc=function(t,e){if("note"==t||"rootTimeout"==t||this.trigger.isNoteTrigger){var i=this;i.states.stopFuncs.some(function(n,r){return n[t]==e?(i.states.stopFuncs.splice(r,1),!0):void 0})}},t}();requireSimulator.setName("T2MediaLib");var T2MediaLib_BGMPlayer=function(t){this.id=t,this.playingState="stop",this.playingStatePending=null,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1,this.bgmPan=0,this.picoAudio=null,this.picoAudioSetDataBGMName=null,this.PICO_AUDIO_VOLUME_COEF=1};T2MediaLib_BGMPlayer.prototype.playBGM=function(t,e,i,n,r){if(!T2MediaLib.context)return null;this.stopBGM();var a=T2MediaLib.soundDataAry[t];if(!a.isDecodeComplete()){if(!a.isDecoding()){var o=this,s={};s.succ=function(){var a=o.playingStatePending;o._setPlayingState("stop",!0),"stop"!=a&&o.playBGM(t,e,i,n,r),"pause"==a&&o.pauseBGM()},s.err=function(){o._setPlayingState("stop",!0)},this.playingBGMName=t,this._setPlayingState("decoding",!0),T2MediaLib.decodeSound(t,s)}return this}var u=a.decodedData;if(u instanceof AudioBuffer)this.playingBGM=T2MediaLib.playSE(t,this.bgmVolume,this.bgmPan,this.bgmTempo,i,e,n,r);else if(u instanceof Object){if(null==this.picoAudio&&(this.picoAudio=new PicoAudio(T2MediaLib.context,T2MediaLib.picoAudio)),t!=this.picoAudioSetDataBGMName?(this.picoAudio.setData(u),this.picoAudioSetDataBGMName=t):this.picoAudio.initStatus(),this.picoAudio.setLoop(e),this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*this.bgmVolume*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),i){var c=this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER));i>c?i=c:0>i&&(i=0)}else i=0;this.picoAudio.setStartTime(i),this.picoAudio.play(),this.playingBGM=this.picoAudio}return this.playingBGMName=t,this.bgmPause=0,this._setPlayingState("play"),this},T2MediaLib_BGMPlayer.prototype.stopBGM=function(){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.stop():t instanceof AudioBufferSourceNode&&t.stop(0),this.playingBGM=null,this.playingBGMName=null,this._setPlayingState("stop"),this},T2MediaLib_BGMPlayer.prototype.pauseBGM=function(){var t=this.playingBGM;return t instanceof PicoAudio?0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseCurrentTime=t.context.currentTime,t.stop(),this.bgmPause=1):t instanceof AudioBufferSourceNode&&0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=T2MediaLib.getSELoopStartTime(t),this.bgmPauseLoopEnd=T2MediaLib.getSELoopEndTime(t),this.bgmPauseLoop=T2MediaLib.isSELoop(t),this.bgmPauseCurrentTime=t.context.currentTime,this.bgmPauseTempo=this.bgmTempo,t.stop(0),this.bgmPause=1),"stop"!=this.playingState&&this._setPlayingState("pause"),this},T2MediaLib_BGMPlayer.prototype.resumeBGM=function(){var t=this.playingBGM;return t instanceof PicoAudio?1===this.bgmPause&&(t.play(),this.bgmPause=0):t instanceof AudioBufferSourceNode&&1===this.bgmPause&&(t=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd)),this},T2MediaLib_BGMPlayer.prototype.onChangeBGMMasterVolume=function(){this.setBGMVolume(this.getBGMVolume())},T2MediaLib_BGMPlayer.prototype.getBGMVolume=function(){return this.bgmVolume},T2MediaLib_BGMPlayer.prototype.setBGMVolume=function(t){var e=this.playingBGM;return this.bgmVolume=t,e instanceof PicoAudio?this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*t*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume):e instanceof AudioBufferSourceNode&&(e.gainNode.gain.value=t*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),this},T2MediaLib_BGMPlayer.prototype.getBGMTempo=function(){return this.bgmTempo},T2MediaLib_BGMPlayer.prototype.setBGMTempo=function(t){var e=this.playingBGM;return 0>=t&&(t=1),e instanceof AudioBufferSourceNode&&0===this.bgmPause&&(e.plusTime-=(T2MediaLib.context.currentTime-e.playStartTime)*(t-this.bgmTempo)),this.bgmTempo=t,T2MediaLib.setSERate(e,t),this},T2MediaLib_BGMPlayer.prototype.getBGMPan=function(){return this.bgmPan},T2MediaLib_BGMPlayer.prototype.setBGMPan=function(t){var e=this.playingBGM;return this.bgmPan=t,e instanceof AudioBufferSourceNode&&T2MediaLib.setSEPan(e,t),this},T2MediaLib_BGMPlayer.prototype.isBGMLoop=function(){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.isLoop():t instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoop:T2MediaLib.isSELoop(t):null},T2MediaLib_BGMPlayer.prototype.setBGMLoop=function(t){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.setLoop(t):e instanceof AudioBufferSourceNode&&(1===this.bgmPause?this.bgmPauseLoop=t:T2MediaLib.setSELoop(e,t)),this},T2MediaLib_BGMPlayer.prototype.getBGMLoopStartTime=function(){var t=this.playingBGM;return t instanceof PicoAudio?0:t instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopStart:T2MediaLib.getSELoopStartTime(t):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopStartTime=function(t){var e=this.playingBGM;if(e instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopStartTime(e,t);this.bgmPauseLoopStart=t}return this},T2MediaLib_BGMPlayer.prototype.getBGMLoopEndTime=function(){var t=this.playingBGM;return t instanceof PicoAudio?this.getBGMLength():t instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopEnd:T2MediaLib.getSELoopEndTime(t):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopEndTime=function(t){var e=this.playingBGM;if(e instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopEndTime(e,t);this.bgmPauseLoopEnd=t}return this},T2MediaLib_BGMPlayer.prototype.getBGMCurrentTime=function(){var t=this.playingBGM;if(t instanceof PicoAudio){var e;return e=0===this.bgmPause?this.picoAudio.getTime(this.picoAudio.getTiming(this.picoAudio.context.currentTime-this.picoAudio.states.startTime)):this.bgmPauseTime}if(t instanceof AudioBufferSourceNode){var e,i,n,r,a,o,s;return 0===this.bgmPause?(n=T2MediaLib.context.currentTime,r=this.bgmTempo):(n=this.bgmPauseCurrentTime,r=this.bgmPauseTempo),i=(n-t.playStartTime)*r+t.plusTime,t.loop&&(t.loopEnd-t.loopStart>0?i<t.loopStart?(a=0,o=0,s=t.buffer.duration):(a=t.loopStart,o=t.loopStart,s=t.loopEnd-t.loopStart):(s=t.buffer.duration,a=0,o=0)),t.loop?e=(i-o)%s+a:(e=i,e>t.buffer.duration&&(e=t.buffer.duration)),e}return null},T2MediaLib_BGMPlayer.prototype.getBGMLength=function(){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER)):t instanceof AudioBufferSourceNode?t.buffer.duration:null},T2MediaLib_BGMPlayer.prototype.getPlayingBGMName=function(){return this.playingBGMName},T2MediaLib_BGMPlayer.prototype.setOnBGMEndListener=function(t){null==this.picoAudio&&this.picoAudio.setOnSongEndListener(t)},T2MediaLib_BGMPlayer.prototype.getPlayingState=function(){return this.playingState},T2MediaLib_BGMPlayer.prototype._setPlayingState=function(t,e){e||"decoding"!=this.playingState?(this.playingState=t,this.playingStatePending=null):this.playingStatePending=t};var T2MediaLib_SoundData=function(){this.state="none",this.errorID=null,this.url=null,this.fileData=null,this.decodedData=null};T2MediaLib_SoundData.prototype.onLoad=function(t){this.state="loading",this.url=t},T2MediaLib_SoundData.prototype.onLoadComplete=function(t){this.state="loaded",this.fileData=t},T2MediaLib_SoundData.prototype.onDecode=function(){this.state="decoding"},T2MediaLib_SoundData.prototype.onDecodeComplete=function(t){this.state="decoded",this.decodedData=t},T2MediaLib_SoundData.prototype.onError=function(t){this.state="error",this.errorID=t},T2MediaLib_SoundData.prototype.isLoadComplete=function(){switch(this.state){case"loaded":case"decoding":case"decoded":return!0}return!1},T2MediaLib_SoundData.prototype.isDecoding=function(){return"decoding"==this.state},T2MediaLib_SoundData.prototype.isDecodeComplete=function(){return"decoded"==this.state},T2MediaLib_SoundData.prototype.getDecodedData=function(){return this.decodedData};var T2MediaLib={context:null,picoAudio:null,soundDataAry:[],bgmPlayerMax:16,bgmPlayerAry:[],masterVolume:1,seMasterVolume:1,bgmMasterVolume:1,playingAudio:null,audioVolume:1,audioTempo:1,audioDataAry:{data:[]},init:function(){if(!this.inited&&(this.inited=!0,!this.disabled&&(window.AudioContext?T2MediaLib.context=new AudioContext:window.webkitAudioContext?T2MediaLib.context=new webkitAudioContext:(T2MediaLib.context=null,console.log("Your browser does not support yet Web Audio API")),T2MediaLib.context))){for(var t=0;t<T2MediaLib.bgmPlayerMax;t++)T2MediaLib.bgmPlayerAry[t]=new T2MediaLib_BGMPlayer(t);T2MediaLib.picoAudio=new PicoAudio(T2MediaLib.context)}},allClearData:function(){var t=T2MediaLib.soundDataAry;for(var e in t)delete t[e]},clearData:function(t){var e=T2MediaLib.soundDataAry;delete e[t]},getMasterVolume:function(){return T2MediaLib.masterVolume},setMasterVolume:function(t){T2MediaLib.masterVolume=t;
for(var e=0;e<T2MediaLib.bgmPlayerMax;e++){var i=T2MediaLib.bgmPlayerAry[e];i instanceof T2MediaLib_BGMPlayer&&i.onChangeBGMMasterVolume()}},loadSoundFromArray:function(t,e,i){T2MediaLib.soundDataAry[t]=new T2MediaLib_SoundData;for(var n=T2MediaLib.context,r=null!=e&&null!=i?2:1,a=n.createBuffer(r,array.length,n.sampleRate),o=a.getChannelData(0),s=null!=i?a.getChannelData(1):null,u=0;u<array.length;u++)o[u]=e[u];if(s)for(var u=0;u<array.length;u++)s[u]=i[u];T2MediaLib.soundDataAry[t].onDecodeComplete(a)},loadSound:function(t,e,i){if(T2MediaLib.soundDataAry[t]=new T2MediaLib_SoundData,!T2MediaLib.context||T2MediaLib.disabled)return T2MediaLib.soundDataAry[t].onError("FUNC_DISABLED_ERROR"),null;"object"==typeof WebSite&&WebSite.mp3Disabled&&(e=e.replace(/\.(mp3|mp4|m4a)$/,".ogg"));var n=new XMLHttpRequest;n.onload=function(){if(200===n.status||0===n.status){var e=n.response;e instanceof ArrayBuffer?(T2MediaLib.soundDataAry[t].onLoadComplete(e),i&&i.succ&&i.succ(t)):(T2MediaLib.soundDataAry[t].onError("XHR_RESPONSE_ERROR"),i&&i.err&&i.err(t,T2MediaLib.soundDataAry[t]))}else T2MediaLib.soundDataAry[t].onError("XHR_STATUS_ERROR"),i&&i.err&&i.err(t,T2MediaLib.soundDataAry[t])},n.onerror=function(e){T2MediaLib.soundDataAry[t].onError("XHR_ERROR"),i&&i.err&&i.err(t,e+"")},T2MediaLib.soundDataAry[t].onLoad(e),e.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer?(n={onload:n.onload},n.response=Util.Base64_To_ArrayBuffer(e.replace(/^data:audio\/[a-zA-Z0-9]+;base64,/i,"")),n.status=200,n.onload()):(n.open("GET",e,!0),n.responseType="arraybuffer",n.send(null))},decodeSound:function(t,e){var i=T2MediaLib.soundDataAry[t];if(null!=i){var n=i.fileData;if(i.onDecode(),i.url.match(/\.(midi?)$/)||i.url.match(/^data:audio\/mid/)){null==T2MediaLib.picoAudio&&(T2MediaLib.picoAudio=new PicoAudio(T2MediaLib.context));var r=new Uint8Array(n),a=T2MediaLib.picoAudio.parseSMF(r);T2MediaLib.soundDataAry[t].onDecodeComplete(a),e&&e.succ&&e.succ(t)}else{var o=function(i){T2MediaLib.soundDataAry[t].onDecodeComplete(i),e&&e.succ&&e.succ(t)},s=function(i){i instanceof Error?console.log("T2MediaLib: "+i.message,url):console.log("T2MediaLib: Error decodeAudioData()",url),T2MediaLib.soundDataAry[t].onError("DECODE_ERROR"),e&&e.err&&e.err(t,T2MediaLib.soundDataAry[t])};T2MediaLib.context.decodeAudioData(n,o,s)}}},activate:function(){if(this.init(),!this.isActivated){this.isActivated=!0;for(var t=T2MediaLib.context,e=t.createBuffer(1,Math.floor(t.sampleRate/32),t.sampleRate),i=e.getChannelData(0),n=(Math.floor(t.sampleRate/860),0);n<i.length;n++)i[n]=0;var r=t.createBufferSource();r.buffer=e,r.connect(t.destination),r.noteOn?r.noteOn(0):r.start&&r.start(0)}},getSoundData:function(t){var e=T2MediaLib.soundDataAry[t];return e?e.getDecodedData():null},playSE:function(t,e,i,n,r,a,o,s){if(!T2MediaLib.context)return null;var u=T2MediaLib.soundDataAry[t];if(!u.isDecodeComplete()){var c={};return c.succ=function(){T2MediaLib.playSE(t,e,i,n,r,a,o,s)},c.err=function(){},T2MediaLib.decodeSound(t,c),null}var l=u.decodedData;if(!(l instanceof AudioBuffer))return null;null==e&&(e=1),null==i&&(i=0),n||(n=1),r?r>l.duration?r=l.duration:0>r&&(r=0):r=0,a||(a=!1),o?0>o?o=0:o>l.duration&&(o=l.duration):o=0,s?0>s?s=0:s>l.duration&&(s=l.duration):s=l.duration;var f=T2MediaLib.context.createBufferSource();T2MediaLib.context.createGain=T2MediaLib.context.createGain||T2MediaLib.context.createGainNode;var h=T2MediaLib.context.createGain(),p=T2MediaLib.context.createPanner();f.buffer=l,f.loop=a,f.loopStart=o,f.loopEnd=s,f.playbackRate.value=n,f.connect(h),h.connect(p),p.connect(T2MediaLib.context.destination),p.panningModel="equalpower",-1>i?i=-1:i>1&&(i=1);var d=90*i,m=Math.sin(d*(Math.PI/180)),g=-Math.cos(d*(Math.PI/180));(-1===i||1===i)&&(g=0),p.positionX?(p.positionX.value=m,p.positionY.value=0,p.positionZ.value=g):p.setPosition(m,0,g),h.gain.value=e*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume;var v;return v=a&&s-o>0&&r>s?s:r,f.gainNode=h,f.volumeValue=e,f.panNode=p,f.panValue=i,f.playStartTime=T2MediaLib.context.currentTime,f.playOffset=v,f.plusTime=v,f.start=f.start||f.noteOn,f.stop=f.stop||f.noteOff,r?a?f.start(0,r,86400):f.start(0,r):f.start(0),f.onended=function(){f.disconnect(),f.onended=null,delete f.gainNode,delete f.panNode},f},stopSE:function(t){return t instanceof AudioBufferSourceNode?(t.stop(0),t):null},getSEMasterVolume:function(){return T2MediaLib.seMasterVolume},setSEMasterVolume:function(t){T2MediaLib.seMasterVolume=t},getSEVolume:function(t){return t instanceof AudioBufferSourceNode?source.volumeValue:null},setSEVolume:function(t,e){return t instanceof AudioBufferSourceNode?(t.gainNode.gain.value=e*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume,source.volumeValue=e,t):null},getSERate:function(t){return t instanceof AudioBufferSourceNode?t.playbackRate.value:null},setSERate:function(t,e){return t instanceof AudioBufferSourceNode?void(t.playbackRate.value=e):null},getSEPan:function(t){return t instanceof AudioBufferSourceNode?t.panValue:null},setSEPan:function(t,e){if(!(t instanceof AudioBufferSourceNode))return null;var i=t.panNode;-1>e?e=-1:e>1&&(e=1);var n=90*e,r=Math.sin(n*(Math.PI/180)),a=Math.cos(n*(Math.PI/180));(-1===e||1===e)&&(a=0),i.positionX?(i.positionX.value=r,i.positionY.value=0,i.positionZ.value=a):i.setPosition(r,0,a),t.panValue=e},isSELoop:function(t){return t instanceof AudioBufferSourceNode?t.loop:null},setSELoop:function(t,e){return t instanceof AudioBufferSourceNode?void(t.loop=e):null},getSELoopStartTime:function(t){return t instanceof AudioBufferSourceNode?t.loopStart:null},setSELoopStartTime:function(t,e){return t instanceof AudioBufferSourceNode?void(t.loopStart=e):null},getSELoopEndTime:function(t){return t instanceof AudioBufferSourceNode?t.loopEnd:null},setSELoopEndTime:function(t,e){return t instanceof AudioBufferSourceNode?void(t.loopEnd=e):null},playBGM:function(t,e,i,n,r,a){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var o=T2MediaLib.bgmPlayerAry[t];return o instanceof T2MediaLib_BGMPlayer?o.playBGM(e,i,n,r,a):null},stopBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.stopBGM():null},pauseBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.pauseBGM():null},resumeBGM:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.resumeBGM():null},getBGMMasterVolume:function(){return T2MediaLib.bgmMasterVolume},setBGMMasterVolume:function(t){T2MediaLib.bgmMasterVolume=t;for(var e=0;e<T2MediaLib.bgmPlayerMax;e++){var i=T2MediaLib.bgmPlayerAry[e];i instanceof T2MediaLib_BGMPlayer&&i.onChangeBGMMasterVolume()}},getBGMVolume:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMVolume():null},setBGMVolume:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMVolume(e):null},getBGMTempo:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMTempo():null},setBGMTempo:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMTempo(e):null},getBGMPan:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMPan():null},setBGMPan:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMPan(e):null},isBGMLoop:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.isBGMLoop():null},setBGMLoop:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoop(e):null},getBGMLoopStartTime:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMLoopStartTime():null},setBGMLoopStartTime:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoopStartTime(e):null},getBGMLoopEndTime:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMLoopEndTime():null},setBGMLoopEndTime:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoopEndTime(e):null},getBGMCurrentTime:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMCurrentTime():null},getBGMLength:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getBGMLength():null},getPlayingBGMName:function(t){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var e=T2MediaLib.bgmPlayerAry[t];return e instanceof T2MediaLib_BGMPlayer?e.getPlayingBGMName():null},setOnBGMEndListener:function(t,e){if(0>t||T2MediaLib.bgmPlayerMax<=t)return null;var i=T2MediaLib.bgmPlayerAry[t];return i instanceof T2MediaLib_BGMPlayer?i.setOnBGMEndListener(e):null},getBGMPlayerMax:function(){return T2MediaLib.bgmPlayerMax},allStopBGM:function(){for(var t=0;t<T2MediaLib.bgmPlayerMax;t++)T2MediaLib.stopBGM(t)},allResetBGM:function(){for(var t=0;t<T2MediaLib.bgmPlayerMax;t++)T2MediaLib.stopBGM(t),T2MediaLib.setBGMVolume(t,1),T2MediaLib.setBGMTempo(t,1),T2MediaLib.setBGMPan(t,0);T2MediaLib.setMasterVolume(1),T2MediaLib.setSEMasterVolume(1),T2MediaLib.setBGMMasterVolume(1)},loadAudio:function(t,e){var i=new Audio(e);i.play(),T2MediaLib.audioDataAry.data[t]=null,i.addEventListener("loadstart",function(){if(!T2MediaLib.context)return null;var t=T2MediaLib.context.createMediaElementSource(i);t.connect(T2MediaLib.context.destination)},!1),i.addEventListener("canplay",function(){T2MediaLib.audioDataAry.data[t]=i},!1),i.load()},playAudio:function(t,e,i){var n=T2MediaLib.audioDataAry.data[t];return n?(i||(i=0),T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.pause(),T2MediaLib.playingAudio.currentTime=0),T2MediaLib.playingAudio=n,n.loop=e,n.volume=T2MediaLib.audioVolume,n.currentTime=i,n.play(),n):null},stopAudio:function(){var t=T2MediaLib.playingAudio;return t instanceof Audio?(t.pause(),t.currentTime=0,T2MediaLib.playingAudio=null,t):null},pauseAudio:function(){var t=T2MediaLib.playingAudio;return t?(t.pause(),t):null},resumeAudio:function(){var t=T2MediaLib.playingAudio;return t?(t.play(),t):null},setAudioVolume:function(t){T2MediaLib.audioVolume=t,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.volume=t)},setAudioTempo:function(t){T2MediaLib.audioTempo=t,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.playbackRate=t)},setAudioPosition:function(t){T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.currentTime=t)},getAudioData:function(t){return T2MediaLib.audioDataAry.data[t]},getAudioCurrentTime:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.currentTime:null},getAudioLength:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.duration:null}};requireSimulator.setName("exceptionCatcher"),define([],function(){var t={};return t.f=function(e){if("function"==typeof e){if(e.isTrcf)return e;var i=function(){if(!t.handleException||t.enter)return e.apply(this,arguments);try{return t.enter=!0,e.apply(this,arguments)}catch(i){t.handleException(i)}finally{t.enter=!1}};return i.isTrcf=!0,i}if("object"==typeof e){for(var n in e)e[n]=t.f(e[n]);return e}},t}),requireSimulator.setName("UI"),define(["Util","exceptionCatcher"],function(t,e){var i={},n=e.f;return i=function(){function e(){l.forEach(function(t){t()}),setTimeout(n(e),50)}function r(t){return t instanceof Array?a(t):"string"==typeof t?s(t):t}function a(t){var e=t[0],i=1,n=$("<"+e+">");for("object"!=typeof t[i]||t[i]instanceof Array||t[i]instanceof $||(o(n,t[i],e),i++);i<t.length;)n.append(r(t[i])),i++;return n}function o(e,r){function a(t,i){if(i)if("enterkey"==t)e.on("keypress",n(function(t){13==t.which&&i.apply(e,arguments)}));else if("realtimechange"==t){var a,o=!0;l.push(function(){var t;t="checkbox"==r.type?!!e.prop("checked"):e.val(),(o||a!=t)&&(i.apply(e,[t,a]),a=t),o=!1})}else e.on(t,n(i))}r.$var&&(f[r.$var]=e),r.$edit&&("string"==typeof r.$edit&&(r.$edit={name:r.$edit,type:i.types.String}),r.on||(r.on={}),r.on.realtimechange=n(function(t){h.writeToModel(r.$edit,t,e)}),f[r.$edit.name]||(f[r.$edit.name]=e),h.push({jq:e,params:r}));for(var o in r)if("on"==o)for(var s in r.on)a(s,r.on[s]);else"css"==o&&null!=r[o]?e.css(r[o]):t.startsWith(o,"$")||null==r[o]||e.attr(o,r[o])}function s(t){return $("<span>").text(t)}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var l=[],f={},h=[],p=r(u);return p.$edits=h,p.$vars=f,h.load=function(t){h.model=t,h.forEach(function(t){h.writeToJq(t.params.$edit,t.jq)}),h.validator.on.validate.call(h.validator,h.model)},h.writeToJq=function(t,e){var i=h.model;if(i){for(var n=t.name,r=n.split("."),a=0;a<r.length;a++)i=i[r[a]];i=t.type.toVal(i),"checkbox"==e.attr("type")?e.prop("checked",!!i):e.val(i)}},h.validator={errors:{},show:function(){if(f.validationMessage){f.validationMessage.empty();for(var t in this.errors)f.validationMessage.append(i("div",this.errors[t].mesg))}if(f.OKButton){var e=!0;for(var t in this.errors)e=!1;f.OKButton.attr("disabled",!e)}},on:{validate:function(){}},addError:function(t,e,i){this.errors[t]={mesg:e,jq:i},this.show()},removeError:function(t){delete this.errors[t],this.show()},allOK:function(){for(var t in this.errors)delete this.errors[t];this.show()},isValid:function(){var t=!0;for(var e in this.errors)t=!1;return t}},h.writeToModel=function(t,e,i){var n=h.model;if(n){var r=t.name;try{e=t.type.fromVal(e)}catch(a){return void h.validator.addError(r,a,i)}h.validator.removeError(r);for(var o=r.split("."),s=0;s<o.length;s++)s==o.length-1?h.on.writeToModel(r,e)||(n[o[s]]=e):n=n[o[s]];h.validator.on.validate.call(h.validator,h.model)}},h.on={},h.on.writeToModel=function(){},l.length>0&&setTimeout(n(e),50),p},i.types={String:{toVal:function(t){return t},fromVal:function(t){return t}},Number:{toVal:function(t){return t+""},fromVal:function(t){return parseFloat(t)}}},i}),requireSimulator.setName("UIDiag"),define(["UI"],function(t){var e={};return e.confirm=function(e){function i(t){return function(){r.resolve(t),n.dialog("close"),n.remove()}}var n=t("div",{title:"確認"},["div",e],["button",{on:{click:i(!0)}},"OK"],["button",{on:{click:i(!1)}},"キャンセル"]).dialog({width:"auto",close:i(!1)}),r=$.Deferred();return r.promise()},e.alert=function(e){function i(t){return function(){r.resolve(t),n.dialog("close"),n.remove()}}var n=t("div",{title:"確認"},["div",e],["button",{on:{click:i(!0)}},"OK"]).dialog({width:"auto",close:i(!1)}),r=$.Deferred();return r.promise()},e.prompt=function(e,i){function n(){var t=a.$vars.val.val();o.resolve(t),a.dialog("close"),a.remove()}function r(){a.dialog("close"),a.remove(),o.resolve()}var a=t("div",{title:"入力"},["div",e],["input",{on:{enterkey:n},$var:"val",value:i}],["br"],["button",{on:{click:n}},"OK"],["button",{on:{click:r}},"キャンセル"]).dialog({width:"auto",close:function(){a.dialog("close"),o.resolve()}});setTimeout(function(){a.$vars.val.focus()},10);var o=$.Deferred();return o.promise()},"undefined"!=typeof window&&(window.UIDiag=e),e}),requireSimulator.setName("runtime"),requirejs(["ImageList","PicoAudio","T2MediaLib","Tonyu","UIDiag"],function(){}),requireSimulator.setName("runScript2"),requirejs(["FS","compiledTonyuProject","Shell","runtime","WebSite","LSFS","Tonyu","NativeFS"],function(t,e,i,n,r,a,o){$(function(){function n(){var t=navigator.userAgent.toLowerCase();return-1==t.indexOf("iphone")&&-1==t.indexOf("ipad")&&-1==t.indexOf("ipod")||window==window.parent?0:40}function s(){var t=n();l=$(window).width(),f=$(window).height(),h.attr({width:l-t,height:f-t})}function u(){o.currentProject=o.globals.$currentProject=T;var t=T.getOptions();T.runScriptMode=!0,T.run(t.run.bootClass)}SplashScreen={hide:function(){$("#splash").hide()},show:function(){},progress:function(t){$("#splash").text(t)}};var c=n(),l=$(window).width(),f=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var h=$("<canvas>").attr({width:l-c,height:f-c}).appendTo("body");$(window).resize(s);var p;if(r.isNW){var d=location.href.replace(/^file:\/\//,"");d.match(/^\/[a-z]:/i)&&(d=d.replace(/^\//,"")),d=t.get(d),d.isDir()||(d=d.up()),p=d.rel("data/")}else{var m=location.href.replace(/\?.*/,"").split(/\//),g=m.pop()||"runscript",v=m.pop()||"nobody",d=t.get(r.tonyuHome),y=t.get("/ram/");t.mount(y.path(),a.ramDisk()),p=y;var b=d.rel(v+"/"+g+"/");y.rel("files/").link(b)}loadFiles(p),i.cd(p),r.compiledKernel="js/kernel.js";var T=e("user","js/concat.js",p);u()})}),requireSimulator.setName();