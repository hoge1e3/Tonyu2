!function(e){e("function"==typeof define&&define.amd&&"function"==typeof requirejs?{requirejs:requirejs,define:define}:{})}(function(e){var t={};t.def=function(e,n,i){var r=t.getModuleInfo(t.curName);r.type=i,t.setReqs(r,e),r.func=function(){return n.apply(this,t.getObjs(e))},t.loadIfAvailable(r)};var n=function(){var e=Array.prototype.slice.call(arguments);"string"==typeof e[0]&&(t.curName=e.shift());var n=e.shift(),i=e.shift();t.def(n,i,"define")};n.amd={jQuery:!0};var i=function(e,n){t.def(e,n,"require")};i.isRequireSimulator=!0,t.setReqs=function(e,n){n.forEach(function(n){var i=t.getModuleInfo(n);i.loaded||(e.reqs[n]=i,i.revReqs[e.name]=e)})},t.getModuleInfo=function(e){var n=t.modules;return n[e]||(n[e]={name:e,reqs:{},revReqs:{}}),n[e]},t.doLoad=function(e){var n=t.getModuleInfo(e);if(n.loaded)return n.obj;n.loaded=!0;var i=null;if(n.func)i=n.func();else{var r=e.split(/\./);i=function(){return this}(),r.forEach(function(e){i&&(i=i[e])}),null==i&&console.log("Warning: No obj for "+e)}if("define"==n.type&&null==i)throw"No obj for "+e;n.obj=i;for(var a in n.revReqs)t.notifyLoaded(n.revReqs[a],n.name);return i},t.notifyLoaded=function(e,n){delete e.reqs[n],t.loadIfAvailable(e)},t.loadIfAvailable=function(e){for(var n in e.reqs)return;t.doLoad(e.name)},t.getObjs=function(e){var n=[];return e.forEach(function(e){var i=t.doLoad(e);n.push(i)}),n},t.modules={},t.setName=function(e){t.curName&&(t.getModuleInfo(t.curName).func||t.doLoad(t.curName)),e&&(t.curName=e)},t.real=e;var a=t;a.setName("FS"),n([],function(){var e,t,n={},i="REQJS_",a=0;n.def=function(e,t,i){var r=n.getModuleInfo(e);"function"==typeof t?(i=t,t=n.reqsFromFunc(i),n.setReqs(r,t),r.func=function(){var e={exports:{}},t=i(n.doLoad,e,e.exports);return t||e.exports}):(n.setReqs(r,t),r.func=function(){return i.apply(this,n.getObjs(t))}),n.loadIfAvailable(r)},e=function(e,t,i){n.def(e,t,i)},e.amd={},t=function(e,t){n.def(i+a++,e,t)},n.setReqs=function(e,t){t.forEach(function(t){var i=n.getModuleInfo(t);i.loaded||(e.reqs[t]=i,i.revReqs[e.name]=e)})},n.getModuleInfo=function(e){var t=n.modules;return t[e]=t[e]||{name:e,reqs:{},revReqs:{}}},n.doLoad=function(e){var t=n.getModuleInfo(e);if(t.loaded)return t.obj;t.loaded=!0;var i=t.func();null!=i||e.match(/^REQJS_/)||console.log("Warning: No obj for "+e),t.obj=i;for(var r in t.revReqs)n.notifyLoaded(t.revReqs[r],t.name);return i},n.notifyLoaded=function(e,t){delete e.reqs[t],n.loadIfAvailable(e)},n.loadIfAvailable=function(e){for(var t in e.reqs)return;n.doLoad(e.name)},n.getObjs=function(e){var t=[];return e.forEach(function(e){var i=n.doLoad(e);t.push(i)}),t},n.reqsFromFunc=function(e){var t=e+"",n=[];return t.replace(/require\s*\(\s*["']([^"']+)["']\s*\)/g,function(e,t){n.push(t)}),n},n.modules={},e("extend",[],function(){return function(e,t){for(var n in t)e[n]=t[n]}}),e("assert",[],function(){function e(t){if(t instanceof Array){var n=[];return t.forEach(function(t){n=n.concat(e(t))}),n}return[t]}var t,n=function(t){this.failMesg=e(t||"Assertion failed: ")};n.prototype={_regedType:{},registerType:function(e,t){this._regedType[e]=t},MODE_STRICT:"strict",MODE_DEFENSIVE:"defensive",MODE_BOOL:"bool",fail:function(){var n=t(arguments),i=n.shift();if(n=e(n),n=this.failMesg.concat(i).concat(n),console.log.apply(console,n),this.isDefensive())return i;if(this.isBool())return!1;throw new Error(n.join(" "))},subAssertion:function(){var i=t(arguments);return i=e(i),new n(this.failMesg.concat(i))},assert:function(e,t){return e?e:this.fail(e,t)},eq:function(e,t){return e!==t?this.fail(e,"!==",t):this.isBool()?!0:e},ne:function(e,t){return e===t?this.fail(e,"===",t):this.isBool()?!0:e},isset:function(e,t){return null==e?this.fail(e,(t||"")+" is null/undef"):this.isBool()?!0:e},is:function(e,t){var n=t,i=e;if(null==n)return this.fail(e,"assert.is: type must be set");if(n._assert_func)return n._assert_func.apply(this,[i]),this.isBool()?!0:e;if(this.assert(null!=e,[e,"should be ",n]),n instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&n instanceof global.Array){if(!e||"number"!=typeof e.length)return this.fail(e,"should be array:");for(var r=this,a=0;a<n.length;a++){var o=r.subAssertion("failed at ",e,"[",a,"]: ");null==n[a]&&console.log("WOW!7",i[a],n[a]),o.is(i[a],n[a])}return this.isBool()?!0:e}if(n===String||"string"==n)return this.assert("string"==typeof i,[i,"should be a string "]),this.isBool()?!0:e;if(n===Number||"number"==n)return this.assert("number"==typeof i,[i,"should be a number"]),this.isBool()?!0:e;if(n===Boolean||"boolean"==n)return this.assert("boolean"==typeof i,[i,"should be a boolean"]),this.isBool()?!0:e;if(n instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&n instanceof global.RegExp)return this.is(i,String),this.assert(n.exec(i),[i,"does not match to",n]),this.isBool()?!0:e;if(n===Function)return this.assert("function"==typeof i,[i,"should be a function"]),this.isBool()?!0:e;if("function"==typeof n)return this.assert(i instanceof n,[i,"should be ",n]),this.isBool()?!0:e;if(n&&"object"==typeof n){for(var s in n){var o=this.subAssertion("failed at ",e,".",s,":");o.is(e[s],n[s])}return this.isBool()?!0:e}if("string"==typeof n){var u=this._regedType[n];return u?this.is(e,u):this.isBool()?!0:e}return this.fail(e,"Invaild type: ",n)},ensureError:function(e,t){try{e()}catch(n){return"string"==typeof t&&r(n+""===t,e+" thrown an error "+n+" but expected:"+t),void console.log("Error thrown successfully: ",n.message)}this.fail(e,"should throw an error",t)},setMode:function(e){this._mode=e},isDefensive:function(){return this._mode===this.MODE_DEFENSIVE},isBool:function(){return this._mode===this.MODE_BOOL},isStrict:function(){return!this.isDefensive()&&!this.isBool()}},t=function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n]);return t};var i=new n,r=function(){try{return i.assert.apply(i,arguments)}catch(e){throw new Error(e.stack)}};return["setMode","isDefensive","is","isset","ne","eq","ensureError"].forEach(function(e){r[e]=function(){try{return i[e].apply(i,arguments)}catch(t){throw console.log(t.stack),new Error(t.message)}}}),r.fail=i.fail.bind(i),r.MODE_STRICT=i.MODE_STRICT,r.MODE_DEFENSIVE=i.MODE_DEFENSIVE,r.MODE_BOOL=i.MODE_BOOL,r.f=function(e){return{_assert_func:e}},r.opt=function(e){return r.f(function(t){return null==t||t instanceof e})},r.and=function(){var e=t(arguments);return r(e instanceof Array),r.f(function(t){for(var n=this,i=0;i<e.length;i++)n.is(t,e[i])})},r}),e("PathUtil",["assert"],function(e){function t(t,n){return e.is(arguments,[String,String]),t.substring(t.length-n.length)===n}function n(t,n){return e.is(arguments,[String,String]),t.substring(0,n.length)===n}var i,r=/^([a-zA-Z]):/,a=/^([a-z\-]+):\/\/\/?([^\/]+)\//,o=e.f(function(e){this.is(e,String),this.assert(i.isPath(e),[e," is not a path"])}),s=e.f(function(e){this.is(e,String),this.assert(i.isAbsolutePath(e),[e," is not a absolute path"])}),u=e.f(function(e){this.is(e,String),this.assert(!i.isAbsolutePath(e),[e," is not a relative path"])}),c=e.f(function(e){this.is(e,o),this.assert(i.isDir(e),[e," is not a directory path"])}),l=e.and(c,s),f=e.f(function(e){this.is(e,o),this.assert(!i.isDir(e),[e," is not a file path"])}),p="/";return i={Path:o,Absolute:s,Relative:u,Dir:c,File:f,AbsDir:l,SEP:p,endsWith:t,startsWith:n,hasDriveLetter:function(e){return r.exec(e)},isURL:function(e){var t=a.exec(e);if(t)return{protocol:t[1],hostPort:t[2],path:p+e.substring(t[0].length)}},isPath:function(){return e.is(arguments,[String]),!0},isRelativePath:function(t){return e.is(arguments,[String]),i.isPath(t)&&!i.isAbsolutePath(t)},isAbsolutePath:function(t){return e.is(arguments,[String]),i.isPath(t)&&(i.startsWith(t,p)||i.hasDriveLetter(t)||i.isURL(t))},isDir:function(n){return n=i.fixSep(n),e.is(arguments,[o]),t(n,p)},hasBackslashSep:function(e){return e.indexOf("\\")>=0},fixSep:function(t,n){return n=n||"/",e.is(arguments,[String]),e.is(t.replace(/[\\\/]/g,n),o)},directorify:function(t){return i.isDir(t)?t:e.is(t+p,c)},filify:function(t){return i.isDir(t)?e.is(t.substring(0,t.length-1),f):t},splitPath:function(t){e.is(arguments,[o]);var n;if(n=this.isURL(t)){var i=this.splitPath(n.path);return i[0]=n.protocol+"://"+n.hostPort,i}t=t.replace(/\/+/g,p);var r=t.split(p);return""==r[r.length-1]&&(r[r.length-2]+=p,r.pop()),r},name:function(t){return e.is(arguments,[String]),i.splitPath(t).pop()},ext:function(t){e.is(arguments,[String]);var n=i.name(t),r=/\.[a-zA-Z0-9]+$/.exec(n);return r?r[0]:null},truncExt:function(t,n){e.is(t,String);var r=i.name(t);return n=n||i.ext(t),e.is(n,String),r.substring(0,r.length-n.length)},truncSEP:function(t){return e.is(arguments,[o]),i.isDir(t)?t.substring(0,t.length-1):t},endsWith:function(n,r){return e.is(arguments,[String,String]),t(i.name(n),r)},parent:function(t){return e.is(arguments,[String]),i.up(t)},rel:function(t,n){if(""==n)return t;e.is(arguments,[l,u]);var r=i.splitPath(n),a=t;a=a.replace(/\/$/,"");var o=i;return r.forEach(function(e){".."==e||"../"==e?a=o.up(a):(a=a.replace(/\/$/,""),a+=p+("."==e||"./"==e?"":e))}),a},relPath:function(t,n){return e.is(arguments,[s,s]),t.substring(0,n.length)!=n?"../"+i.relPath(t,this.up(n)):t.substring(n.length)},up:function(e){if(e==p)return null;var t=i.splitPath(e);return t.pop(),t.join(p)+p}},["directorify","filify","splitPath","name","rel","relPath","up"].forEach(function(e){var t=i[e];i[e]=function(){var e=!1,n=Array.prototype.slice.call(arguments).map(function(t){return i.hasBackslashSep(t)?(e=!0,i.fixSep(t)):t}),r=t.apply(i,n);return e?i.fixSep(r,"\\"):r}}),i.isAbsolute=i.isAbsolutePath,i.isRelative=i.isRelativePath,"object"==typeof window&&(window.PathUtil=i),i}),e("MIMETypes",[],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".wav":"audio/x-wav",".mp3":"audio/mp3",".ogg":"audio/ogg",".midi":"audio/midi",".mid":"audio/midi",".mzo":"audio/mzo",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu",".c":"text/c",".dtl":"text/dolittle"}}),e("DeferredUtil",[],function(){var e,t="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:null,n=function(e){this.res=e};return e={isNativePromise:function(e){return e&&"function"==typeof e.then&&"function"!=typeof e.promise&&"function"==typeof e.catch},isJQPromise:function(e){return e&&"function"==typeof e.then&&"function"==typeof e.promise&&"function"==typeof e.fail},isPromise:function(e){return e&&"function"==typeof e.then&&("function"==typeof e.promise||"function"==typeof e.catch)},all:function(t){return e.promise(function(n,i){var r=[],a=t.length;t.forEach(function(t,o){e.resolve(t).then(function(e){r[o]=e,a--,0===a&&n(r)},i)})})},resolve:function(t){return e.config.useJQ&&e.isJQPromise(t)?t:!e.config.useJQ&&e.isNativePromise(t)?t:e.promise(function(n,i){e.isPromise(t)?t.then(n,i):n(t)})},throwNowIfRejected:function(t){var n,i,r=t.then(function(e){return n||(n="resolved"),e},function(t){return n?e.reject(t):(n="rejected",void(i=t))});if(n||(n="notyet"),"rejected"===n)throw i;return r},assertResolved:function(e){var t,n;if(e.then(function(e){t=e,n=!0}),!n)throw console.log(r),new Error("Promise not resolved");return t},ensureDefer:function(t){return e.promise(function(n,i){var r;e.resolve(t).then(function(e){r?n(e):setTimeout(function(){n(e)},0)}).fail(function(e){r?i(e):setTimeout(function(){i(e)},0)}),r=!0})},directPromise:function(t){return e.timeout(t,0)},then:function(t){return e.directPromise().then(t)},timeout:function(t,n){return e.promise(function(e){setTimeout(function(){e(n)},t||0)})},funcPromise:function(t){if(e.config.useJQ){var n=new $.Deferred;try{t(function(e){n.resolve(e)},function(e){n.reject(e)})}catch(i){n.reject(i)}return n.promise()}if(e.external.Promise)return new e.external.Promise(function(e,n){try{t(e,n)}catch(i){n(i)}});throw new Error("promise is not found")},reject:function(t){if(e.config.useJQ){var n=new $.Deferred;return n.reject(t),n.promise()}return new e.external.Promise(function(e,n){n(t)})},throwPromise:function(t){if(e.config.useJQ){var n=new $.Deferred;return setTimeout(function(){n.reject(t)},0),n.promise()}return new e.external.Promise(function(e,n){n(t)})},throwF:function(t){return function(){try{return t.apply(this,arguments)}catch(n){return console.log(n,n.stack),e.throwPromise(n)}}},each:function(t,n){if(t instanceof Array)return e.loop(function(i){return i>=t.length?e.brk():e.resolve(n(t[i],i)).then(function(){return i+1})},0);var i=[];for(var r in t)i.push({k:r,v:t[r]});return e.each(i,function(e){return n(e.k,e.v)})},loop:function(t,i){try{for(var r;;){if(i instanceof n)return e.when1(i.res);var a=!0,o=!1,s=t(i),u=e.resolve(s).then(function(r){return i=r,a=!1,i instanceof n?i.res:o?e.loop(t,i):void 0}).fail(function(e){a=!1,r=e});if(r)throw r;if(o=!0,a)return u}}catch(c){return e.reject(c)}},brk:function(e){return new n(e)},tryLoop:function(t,n){return e.loop(e.tr(t),n)},tryEach:function(t,n){return e.loop(t,e.tr(n))},documentReady:function(){return e.callbackToPromise(function(e){$(e)})},requirejs:function(n){if(!t.requirejs)throw new Error("requirejs is not loaded");return e.callbackToPromise(function(e){t.requirejs(n,e)})}},e.NOP=function(e){return e},e.E=function(){console.log("DUE",arguments),e.errorHandler.apply(e,arguments)},e.errorHandler=function(e){console.error.apply(console,arguments),alert(e)},e.setE=function(t){e.errorHandler=t},e.begin=e.try=e.tr=e.throwF,e.promise=e.callbackToPromise=e.funcPromise,e.when1=e.resolve,e.config={},t.$&&t.$.Deferred&&(e.config.useJQ=!0),e.external={Promise:t.Promise},t.DeferredUtil||(t.DeferredUtil=e),e}),e("FSClass",["extend","PathUtil","MIMETypes","assert","DeferredUtil"],function(e,t,n,i,r){function a(e){throw new Error(e+" is STUB!")}var o=function(){},s={};return o.addFSType=function(e,t){s[e]=t},o.availFSTypes=function(){return s},e(o.prototype,{err:function(e,t){throw new Error(e+": "+t)},fstype:function(){return"Unknown"},isReadOnly:function(){a("isReadOnly")},supportsSync:function(){return!0},resolveFS:function(e){return i(this.getRootFS()!==this),this.getRootFS().resolveFS(e)},mounted:function(e,t){this.rootFS=e,this.mountPoint=t},inMyFS:function(e){return!this.mountPoint||t.startsWith(e,this.mountPoint)},getRootFS:function(){return i(this.rootFS,"rootFS is not set")},getReturnTypes:function(){a("")},getContent:function(){a("getContent")},getContentAsync:function(){return this.supportsSync()||a("getContentAsync"),r.resolve(this.getContent.apply(this,arguments))},setContent:function(){a("")},setContentAsync:function(e,t,n){var i=this;return i.supportsSync()||a("setContentAsync"),r.resolve(t).then(function(t){return r.resolve(i.setContent(e,t,n))})},appendContent:function(){a("")},appendContentAsync:function(e,t,n){var i=this;return i.supportsSync()||a("appendContentAsync"),r.resolve(t).then(function(t){return r.resolve(i.appendContent(e,t,n))})},getMetaInfo:function(){a("")},setMetaInfo:function(){a("")},mkdir:function(){a("mkdir")},touch:function(){a("touch")},exists:function(){a("exists")},opendir:function(){a("opendir")},opendirAsync:function(){return this.supportsSync()||a("opendirAsync"),r.resolve(this.opendir.apply(this,arguments))},cp:function(e,n,r){i.is(arguments,[t.Absolute,t.Absolute]),this.assertExist(e),r=r||{};var a=this.isDir(e),o=this.getRootFS().resolveFS(n),s=o.isDir(n);if(a||s)throw new Error("only file to file supports");if(this.supportsSync()&&o.supportsSync()){var u=this.getContent(e),c=o.setContent(n,u);return r.a&&o.setMetaInfo(n,this.getMetaInfo(e)),c}return o.setContentAsync(n,this.getContentAsync(e)).then(function(t){return r.a?o.setMetaInfo(n,this.getMetaInfo(e)):t})},mv:function(e,t,n){return this.cp(e,t,n),this.rm(e,{r:!0})},rm:function(){a("")},link:function(e,t){throw new Error("ln "+t+" "+e+" : This FS not support link.")},getURL:function(){a("")}}),o.delegateMethods=function(e,n){for(var r in n)!function(r){i.ne(r,"inMyFS"),e[r]=function(){var e=arguments[0];i.is(e,t.Absolute);var a=this.resolveFS(e);return a!==this?(console.log("Invoked for other fs",this.mountPoint,a.mountPoint),a[r].apply(a,arguments)):n[r].apply(this,arguments)}}(r)},o.delegateMethods(o.prototype,{assertWriteable:function(e){this.isReadOnly(e)&&this.err(e,"read only.")},getContentType:function(e,i){var r=(t.ext(e)+"").toLowerCase();return n[r]||(i||{}).def||"application/octet-stream"},getBlob:function(e,t){var n=this.getContent(e);return t=t||{},t.blobType=t.blobType||Blob,t.binType=t.binType||ArrayBuffer,n.hasPlainText()?new t.blobType([n.toPlainText()],this.getContentType(e)):new t.blobType([n.toBin(t.binType)],this.getContentType(e))},isText:function(e){var n=this.getContentType(e);return t.startsWith(n,"text")},assertExist:function(e,n){this.exists(e,n)||this.err(e,": No such "+(t.isDir(e)?"directory":"file"))},isDir:function(e){return t.isDir(e)},find:function(e,n){i.is(arguments,[t.Absolute]);var r=this.opendir(e,n),a=this,o=[e];return r.forEach(function(i){var r=t.rel(e,i);if(t.isDir(r)){var s=a.resolveFS(r);o=o.concat(s.find(r,n))}else o.push(r)}),o},resolveLink:function(e){i.is(e,t.Absolute);for(var n=e;n;n=t.up(n)){i(!this.mountPoint||t.startsWith(n,this.mountPoint),n+" is out of mountPoint. path="+e);var r=this.isLink(n);if(r){i(r!=n,"l==p=="+r);var a=t.rel(r,t.relPath(e,n));return i(a!=e,"np==path=="+a),i.is(this.getRootFS().resolveFS(a).resolveLink(a),t.Absolute)}if(this.exists(n))return e}return e},isLink:function(){return null},opendirEx:function(e){i.is(e,t.AbsDir);var n=this.opendir(e),r=this,a={};return n.forEach(function(n){var i=t.rel(e,n);a[n]=r.getMetaInfo(i)}),a},getDirTree:function(e,n){n=n||{};var r=n.dest=n.dest||{};n.style=n.style||"flat-absolute",n.excludes=n.excludes||[],i.is(n.excludes,Array),n.base||(n.base=e),i.is(e,t.AbsDir);var a=this.opendirEx(e,n);if("no-recursive"==n.style)return a;var o=this;for(var s in a){var u=a[s],c=t.rel(e,s),l=t.relPath(c,n.base);switch(n.style){case"flat-relative":case"hierarchical":if(n.excludes.indexOf(l)>=0)continue;break;case"flat-absolute":if(n.excludes.indexOf(c)>=0)continue}if(o.isDir(c))switch(n.style){case"flat-absolute":case"flat-relative":o.getDirTree(c,n);break;case"hierarchical":n.dest={},r[s]=o.getDirTree(c,n)}else switch(n.style){case"flat-absolute":r[c]=u;break;case"flat-relative":r[l]=u;break;case"hierarchical":r[s]=u}}return r}}),o}),e("Util",[],function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+e+"=([^&#]*)"),r=i.exec(window.location.href);return null==r?n:t(r[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function i(e,t){return e.substring(0,t.length)===t}function r(e){if(e.__privatized)return e;var t={__privatized:!0};for(var n in e)!function(n){var i=e[n];n.match(/^_/)||"function"==typeof i&&(t[n]=function(){var t=i.apply(e,arguments);return t})}(n);return t}function a(e,t){for(var n in t||{})e[n]=t[n];return e}return{getQueryString:e,endsWith:n,startsWith:i,privatize:r,extend:a}});var o=o||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(e){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var t=e.document,n=t.createElementNS("http://www.w3.org/1999/xhtml","a"),i="download"in n,r=function(n){var i=t.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,e,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)},a=e.webkitRequestFileSystem,o=e.requestFileSystem||a||e.mozRequestFileSystem,s=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},u=0,c=function(t){var n=function(){"string"==typeof t?(e.URL||e.webkitURL||e).revokeObjectURL(t):t.remove()};e.chrome?n():setTimeout(n,10)},l=function(e,t,n){t=[].concat(t);for(var i=t.length;i--;){var r=e["on"+t[i]];if("function"==typeof r)try{r.call(e,n||e)}catch(a){s(a)}}},f=function(t,s){var f,p,h,m=this,d=t.type,g=!1,y=function(){l(m,["writestart","progress","write","writeend"])},v=function(){(g||!f)&&(f=(e.URL||e.webkitURL||e).createObjectURL(t)),p?p.location.href=f:void 0==e.open(f,"_blank")&&"undefined"!=typeof safari&&(e.location.href=f),m.readyState=m.DONE,y(),c(f)},T=function(e){return function(){return m.readyState!==m.DONE?e.apply(this,arguments):void 0}},b={create:!0,exclusive:!1};m.readyState=m.INIT,s||(s="download"),i?(f=(e.URL||e.webkitURL||e).createObjectURL(t),n.href=f,n.download=s,r(n),m.readyState=m.DONE,y(),c(f)):(e.chrome&&d&&"application/octet-stream"!==d&&(h=t.slice||t.webkitSlice,t=h.call(t,0,t.size,"application/octet-stream"),g=!0),a&&"download"!==s&&(s+=".download"),("application/octet-stream"===d||a)&&(p=e),o?(u+=t.size,o(e.TEMPORARY,u,T(function(e){e.root.getDirectory("saved",b,T(function(e){var n=function(){e.getFile(s,b,T(function(e){e.createWriter(T(function(n){n.onwriteend=function(t){p.location.href=e.toURL(),m.readyState=m.DONE,l(m,"writeend",t),c(e)},n.onerror=function(){var e=n.error;e.code!==e.ABORT_ERR&&v()},["writestart","progress","write","abort"].forEach(function(e){n["on"+e]=m["on"+e]}),n.write(t),m.abort=function(){n.abort(),m.readyState=m.DONE},m.readyState=m.WRITING}),v)}),v)};e.getFile(s,{create:!1},T(function(e){e.remove(),n()}),T(function(e){e.code===e.NOT_FOUND_ERR?n():v()}))}),v)}),v)):v())},p=f.prototype;return p.abort=function(){this.readyState=this.DONE,l(this,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,function(e,t){return new f(e,t)}}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&null!==module?module.exports=o:"undefined"!=typeof e&&null!==e&&null!=e.amd&&e("FileSaver.min",[],function(){return o}),e("Content",["assert","Util","FileSaver.min"],function(e,t,n){var i=function(){},r=t.extend;i.plainText=function(e,t){var n=new i;return n.contentType=t||"text/plain",n.plain=e,n},i.url=function(e){var t=new i;return t.url=e,t},i.buffer2ArrayBuffer=function(t){if(i.isBuffer(t)){var n=new Uint8Array(t),r=n.buffer;if(r instanceof ArrayBuffer)return r;var a=Array.prototype.slice.call(n);return e(new Uint8Array(a).buffer,"n2a: buf is not set")}return e(t,"n2a: a is not set")},i.arrayBuffer2Buffer=function(t){if(t instanceof ArrayBuffer){var n=new Buffer(new Uint8Array(t));return n}return e(t,"a2n: a is not set")},i.bin=function(t,n){e(n,"contentType should be set");var r=new i;if(t&&i.isBuffer(t.buffer))r.arrayBuffer=t.buffer;else if(i.isNodeBuffer(t))r.nodeBuffer=t;else{if(!(t instanceof ArrayBuffer))throw new Error(t+" is not a bin");r.arrayBuffer=t}return r.contentType=n,r},i.looksLikeDataURL=function(e){return e.match(/^data:/)},i.download=n;var a=i.prototype;a.toBin=function(e){if(e=e||(i.hasNodeBuffer()?Buffer:ArrayBuffer),this.nodeBuffer)return e===Buffer?this.nodeBuffer:this.arrayBuffer=i.buffer2ArrayBuffer(this.nodeBuffer);if(this.arrayBuffer)return e===ArrayBuffer?this.arrayBuffer:this.nodeBuffer=i.arrayBuffer2Buffer(this.arrayBuffer);if(this.url){var t=new s(this.url,e);return this.setBuffer(t.buffer)}if(null!=this.plain)return this.setBuffer(i.str2utf8bytes(this.plain,e));throw new Error("No data")},a.setBuffer=function(t){return e(t,"b is not set"),i.isNodeBuffer(t)?this.nodeBuffer=t:this.arrayBuffer=t},a.toArrayBuffer=function(){return this.toBin(ArrayBuffer)},a.toNodeBuffer=function(){return this.toBin(Buffer)},a.toURL=function(){if(this.url)return this.url;if(this.arrayBuffer||null==this.plain||(this.arrayBuffer=i.str2utf8bytes(this.plain,ArrayBuffer)),this.arrayBuffer||this.nodeBuffer){var e=new s(this.arrayBuffer||this.nodeBuffer,this.contentType);return this.url=e.url}throw new Error("No data")},a.toPlainText=function(){if(this.hasPlainText())return this.plain;if(this.url&&!this.hasBin()){var e=new s(this.url,ArrayBuffer);this.arrayBuffer=e.buffer}if(this.hasBin())return this.plain=i.utf8bytes2str(this.nodeBuffer||new Uint8Array(this.arrayBuffer));throw new Error("No data")},a.hasURL=function(){return this.url},a.hasPlainText=function(){return null!=this.plain},a.hasBin=function(){return this.nodeBuffer||this.arrayBuffer},a.hasNodeBuffer=function(){return this.nodeBuffer},a.hasArrayBuffer=function(){return this.arrayBuffer},a.toBlob=function(){return new Blob([this.toBin(ArrayBuffer)],{type:this.contentType})},a.download=function(e){i.download(this.toBlob(),e)},i.Base64_To_ArrayBuffer=function(e,t){function n(t){throw console.log(t),console.log(e,p),new Error(t)}var r=t||ArrayBuffer;e=e.replace(/[\n=]/g,"");var a=new Object;a[65]=0,a[66]=1,a[67]=2,a[68]=3,a[69]=4,a[70]=5,a[71]=6,a[72]=7,a[73]=8,a[74]=9,a[75]=10,a[76]=11,a[77]=12,a[78]=13,a[79]=14,a[80]=15,a[81]=16,a[82]=17,a[83]=18,a[84]=19,a[85]=20,a[86]=21,a[87]=22,a[88]=23,a[89]=24,a[90]=25,a[97]=26,a[98]=27,a[99]=28,a[100]=29,a[101]=30,a[102]=31,a[103]=32,a[104]=33,a[105]=34,a[106]=35,a[107]=36,a[108]=37,a[109]=38,a[110]=39,a[111]=40,a[112]=41,a[113]=42,a[114]=43,a[115]=44,a[116]=45,a[117]=46,a[118]=47,a[119]=48,a[120]=49,a[121]=50,a[122]=51,a[48]=52,a[49]=53,a[50]=54,a[51]=55,a[52]=56,a[53]=57,a[54]=58,a[55]=59,a[56]=60,a[57]=61,a[43]=62,a[47]=63;var o,s=e.length,u=0,c=0;if(!s)return new r(0);o=Math.floor(s/4*3),"="==e.charAt(s-1)&&(o-=1),"="==e.charAt(s-2)&&(o-=1);for(var l=new r(o),f=i.isNodeBuffer(l)?l:new Uint8Array(l),p=0,h=0;o>h&&(c=a[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),u=c<<2,p++,c=a[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c>>4&3,u=(15&c)<<4,p++,h++,!(h>=o))&&(c=a[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c>>2&15,u=(3&c)<<6,p++,h++,!(h>=o));)c=a[e.charCodeAt(p)],void 0===c&&n("Invalid letter: "+e.charCodeAt(p)),f[h]=u|c,p++,h++;return l},i.Base64_From_ArrayBuffer=function(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",i=new Uint8Array(e),r=i.length,a=0,o=0,s=0;r>s&&(o=i[s],n+=t[o>>2],a=(3&o)<<4,s++,!(s>=r))&&(o=i[s],n+=t[a|o>>4],a=(15&o)<<2,s++,!(s>=r));)o=i[s],n+=t[a|o>>6],n+=t[63&o],s++;var u=r%3;return u&&(n+=t[a]),1==u?n+="==":2==u&&(n+="="),n},i.hasNodeBuffer=function(){return"undefined"!=typeof Buffer},i.isNodeBuffer=function(e){return i.hasNodeBuffer()&&e instanceof Buffer},i.isBuffer=function(e){return e instanceof ArrayBuffer||i.isNodeBuffer(e)},i.utf8bytes2str=function(e){for(var t=[],n=0;n<e.length;n++)t.push("%"+("0"+e[n].toString(16)).slice(-2));return decodeURIComponent(t.join(""))},i.str2utf8bytes=function(e,t){for(var n=encodeURIComponent(e),i=/^%(..)/,r=[],a=0;a<n.length;a++){var o=i.exec(n.substring(a));o?(r.push(parseInt("0x"+o[1])),a+=o[0].length-1):r.push(n.charCodeAt(a))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(r):new Uint8Array(r).buffer};var o=i.hasNodeBuffer()?Buffer:ArrayBuffer,s=function(t,n){"string"==typeof t?(this.url=t,this.binType=n||o,this.dataURL2bin(t)):t&&i.isBuffer(t.buffer)?(this.buffer=t.buffer,e.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):i.isBuffer(t)?(this.buffer=t,e.is(n,String),this.contentType=n,this.bin2dataURL(this.buffer,this.contentType)):(console.log(arguments),e.fail("Invalid args: ",arguments))};return i.DataURL=s,r(s.prototype,{bin2dataURL:function(t,n){e(i.isBuffer(t)),e.is(n,String);var r=this.dataHeader(n),a=i.Base64_From_ArrayBuffer(t);return e.is(a,String),this.url=r+a},dataURL2bin:function(t){e.is(arguments,[String]);var n=/^data:([^;]+);base64,/i,r=n.exec(t);return e(r,["malformed dataURL:",t]),this.contentType=r[1],this.buffer=i.Base64_To_ArrayBuffer(t.substring(r[0].length),this.binType),e.is(this.buffer,this.binType)},dataHeader:function(t){return e.is(arguments,[String]),"data:"+t+";base64,"},toString:function(){return e.is(this.url,String)}}),i}),e("NativeFS",["FSClass","assert","PathUtil","extend","Content"],function(e,t,n,i,r){var a="object"==typeof process;if(!a)return function(){throw new Error("This system not support native FS")};var o=t,s=require("fs"),u=function(e){e&&(t.is(e,n.AbsDir),this.rootPoint=e)},c=n.hasDriveLetter(process.cwd());u.available=!0;var l=n.SEP,f=u.prototype=new e;return f.toNativePath=function(e){return this.rootPoint?(t.is(e,n.Absolute),t(this.inMyFS(e),e+" is not fs of "+this),n.rel(this.rootPoint,n.relPath(e,this.mountPoint||n.SEP))):e},f.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return e},e.addFSType("NativeFS",function(e,t){return new u(t.r)}),u.prototype.fstype=function(){return"Native"+(this.rootPoint?"("+this.rootPoint+")":"")},u.prototype.inMyFS=function(e){return this.mountPoint?n.startsWith(e,this.mountPoint):!(!!c^!!n.hasDriveLetter(e))},e.delegateMethods(u.prototype,{getReturnTypes:function(){return o.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(e,i){i=i||{},t.is(e,n.Absolute);var a=this.toNativePath(e);return this.assertExist(e),r.bin(s.readFileSync(a),this.getContentType(e))},setContent:function(e,i){t.is(arguments,[n.Absolute,r]);var a=n.up(e);a&&this.getRootFS().resolveFS(a).mkdir(a);var o=this.toNativePath(e);i.hasBin()||!i.hasPlainText()?s.writeFileSync(o,i.toNodeBuffer()):s.writeFileSync(o,i.toPlainText())},appendContent:function(e,i){t.is(arguments,[n.Absolute,r]);var a=n.up(e);a&&this.getRootFS().resolveFS(a).mkdir(a);var o=this.toNativePath(e);i.hasBin()||!i.hasPlainText()?s.appendFileSync(o,i.toNodeBuffer()):s.appendFileSync(o,i.toPlainText())},getMetaInfo:function(e,t){this.assertExist(e,t);var n=this.stat(e);return n.lastUpdate=n.mtime.getTime(),n},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(e){t.is(e,n.Absolute);var i=this.toNativePath(e);return s.statSync(i)},mkdir:function(e){if(o.is(arguments,[n.Absolute]),this.exists(e)){if(this.isDir(e))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(e);var t=n.up(e);t&&this.getRootFS().resolveFS(t).mkdir(t);var i=this.toNativePath(e);return s.mkdirSync(i),this.assertExist(i)},opendir:function(e,t){o.is(arguments,[String]),t=t||{};var i=this.toNativePath(e),r=n.truncSEP(i),a=s.readdirSync(i);t.nosep||(a=a.map(function(e){var t=s.statSync(r+l+e),n=t.isDirectory()?l:"";return e+n}));var u=[];return o.is(u.concat(a),Array)},rm:function(e,t){o.is(arguments,[n.Absolute]),t=t||{},this.assertExist(e);var i=this.toNativePath(e);return this.isDir(e)?s.rmdirSync(i):s.unlinkSync(i)
},exists:function(e){var t=this.toNativePath(e);return s.existsSync(t)},isDir:function(e){return this.exists(e)?this.stat(e).isDirectory():n.isDir(e)},touch:function(e){!this.exists(e)&&this.isDir(e)?this.mkdir(e):this.exists(e)&&s.utimesSync(e,Date.now()/1e3,Date.now()/1e3)},getURL:function(e){return"file:///"+e.replace(/\\/g,"/")}}),u}),e("LSFS",["FSClass","PathUtil","extend","assert","Util","Content"],function(e,t,n,i,r,a){function o(){return(new Date).getTime()}var s=function(e,t){i(e," new LSFS fail: no storage"),this.storage=e,this.options=t||{},this.options.useDirCache&&(this.dirCache={})},u=t.isDir.bind(t),c=t.up.bind(t),l=t.endsWith.bind(t),f=(t.Path,t.Absolute),p=t.SEP;return s.ramDisk=function(e){var n={};return n[t.SEP]="{}",e=e||{},"useDirCache"in e||(e.useDirCache=!0),new s(n,e)},e.addFSType("localStorage",function(e,t){return new s(localStorage,t)}),e.addFSType("ram",function(e,t){return s.ramDisk(t)}),s.now=o,s.prototype=new e,s.prototype.resolveKey=function(e){return i.is(e,t.Absolute),this.mountPoint?t.SEP+t.relPath(e,this.mountPoint):e},s.prototype.getItem=function(e){i.is(e,t.Absolute);var n=this.resolveKey(e);return this.storage[n]},s.prototype.setItem=function(e,n){i.is(e,t.Absolute);var r=this.resolveKey(e);i(r.indexOf("..")<0),i(t.startsWith(r,t.SEP)),this.storage[r]=n},s.prototype.removeItem=function(e){i.is(e,t.Absolute);var n=this.resolveKey(e);delete this.storage[n]},s.prototype.itemExists=function(e){i.is(e,t.Absolute);var n=this.resolveKey(e);return i(this.storage,"No storage"),n in this.storage},s.prototype.getDirInfo=function(e){if(i.is(arguments,[t.AbsDir]),null==e)throw new Error("getDir: Null path");if(l(e,p)||(e+=p),i(this.inMyFS(e)),this.dirCache&&this.dirCache[e])return this.dirCache[e];var n={};try{var r=this.getItem(e);r&&(n=JSON.parse(r))}catch(a){console.log("dinfo err : ",e,r)}return this.dirCache&&(this.dirCache[e]=n),n},s.prototype.putDirInfo=function(e,n,r){if(i.is(arguments,[t.AbsDir,Object]),!u(e))throw new Error("Not a directory : "+e);i(this.inMyFS(e)),this.dirCache&&(this.dirCache[e]=n),this.setItem(e,JSON.stringify(n));var a=c(e);if(null!=a&&this.inMyFS(a)){var o=this.getDirInfo(a);this._touch(o,a,t.name(e),r)}},s.prototype._touch=function(e,n,r,a){i.is(arguments,[Object,String,String]),i(this.inMyFS(n)),e[r]||(e[r]={},a&&(e[r].trashed=!0)),a||delete e[r].trashed,e[r].lastUpdate=o(),this.getRootFS().notifyChanged(t.rel(n,r),e[r]),this.putDirInfo(n,e,a)},s.prototype.removeEntry=function(e,t,n){i.is(arguments,[Object,String,String]),e[n]&&(e[n]={lastUpdate:o(),trashed:!0},this.putDirInfo(t,e,!0))},s.prototype.removeEntryWithoutTrash=function(e,t,n){i.is(arguments,[Object,String,String]),e[n]&&(delete e[n],this.putDirInfo(t,e,!0))},s.prototype.isRAM=function(){return this.storage!==localStorage},s.prototype.fstype=function(){return this.isRAM()?"ramDisk":"localStorage"},s.getUsage=function(){var e=0;for(var t in localStorage)"string"==typeof localStorage[t]&&(e+=localStorage[t].length);return e},s.getCapacity=function(){function e(){try{return localStorage[i+t]=n,t++,r+=n.length,!0}catch(e){return delete localStorage[i+t],!1}}var t=0,n="a",i="___checkls___",r=0,a=Math.pow(2,25);try{for(var o=0;10>o;o++)n+=n;for(var o in localStorage)o.substring(0,i.length)==i?delete localStorage[o]:"string"==typeof localStorage[o]&&(r+=localStorage[o].length);for(var s=r;e()&&n.length<a;)n+=n;for(;n.length>1024;)n=n.substring(n.length/2),e();return{using:s,max:r}}finally{for(var o=0;t>o;o++)delete localStorage[i+o]}},e.delegateMethods(s.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return i.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(e){i.is(arguments,[f]),this.assertExist(e);var t,n=this.getItem(e);return t=a.looksLikeDataURL(n)?a.url(n):a.plainText(n)},setContent:function(e,t){i.is(arguments,[f,a]),this.assertWriteable(e);var n=null;t.hasPlainText()&&(n=t.toPlainText(),a.looksLikeDataURL(n)&&(n=null)),null!=n?this.setItem(e,n):this.setItem(e,t.toURL()),this.touch(e)},getMetaInfo:function(e){if(this.assertExist(e,{includeTrashed:!0}),i.is(arguments,[f]),e==t.SEP)return{};var n=i(t.up(e));if(!this.inMyFS(n))return{};var r=t.name(e);i.is(n,t.AbsDir);var a=this.getDirInfo(n);return i(a[r])},setMetaInfo:function(e,n){i.is(arguments,[String,Object]),this.assertWriteable(e);var r=i(t.up(e));if(this.inMyFS(r)){var a=this.getDirInfo(r),o=t.name(e);a[o]=n,this.putDirInfo(r,a,a[o].trashed)}},mkdir:function(e){i.is(arguments,[f]),this.assertWriteable(e),this.touch(e)},opendir:function(e,t){i.is(arguments,[String]),t=t||{};var n=this.getDirInfo(e),r=[];for(var a in n)i(n[a]),(!n[a].trashed||t.includeTrashed)&&r.push(a);return i.is(r,Array)},rm:function(e,n){i.is(arguments,[f]),n=n||{},this.assertWriteable(e);var r=t.up(e);if(null==r||!this.inMyFS(r))throw new Error(e+": cannot remove. It is root of this FS.");if(this.assertExist(e,{includeTrashed:n.noTrash}),t.isDir(e)){var a=this.opendir(e);a.length>0&&this.err(e,"Directory not empty"),n.noTrash&&this.removeItem(e)}else this.removeItem(e);var o=this.getDirInfo(r);n.noTrash?this.removeEntryWithoutTrash(o,r,t.name(e)):this.removeEntry(o,r,t.name(e))},exists:function(e,n){i.is(arguments,[f]),n=n||{};var r=t.name(e),a=t.up(e);if(null==a||!this.inMyFS(a))return!0;var o=this.getDirInfo(a),s=o[r];return s&&s.trashed&&this.itemExists(e)&&this.isDir(e),!s&&this.itemExists(e),s&&!s.trashed&&!s.link&&!this.itemExists(e),s&&!n.includeTrashed&&(s=!s.trashed),!!s},link:function(e,n){i.is(arguments,[t.Absolute,t.Absolute]),this.assertWriteable(e),this.exists(e)&&this.err(e,"file exists"),t.isDir(e)&&!t.isDir(n)&&this.err(e," can not link to file "+n),!t.isDir(e)&&t.isDir(n)&&this.err(e," can not link to directory "+n);var r={};r.link=n,r.lastUpdate=o(),this.setMetaInfo(e,r),i(this.exists(e)),i(this.isLink(e))},isLink:function(e){if(i.is(arguments,[t.Absolute]),!this.exists(e))return null;var n=i(this.getMetaInfo(e));return n.link},touch:function(e){i.is(arguments,[f]),this.assertWriteable(e),this.itemExists(e)||(t.isDir(e)?(this.dirCache&&(this.dirCache[e]={}),this.setItem(e,"{}")):this.setItem(e,""));var n=c(e);if(null!=n)if(this.inMyFS(n)){var r=this.getDirInfo(n);this._touch(r,n,t.name(e),!1)}else i(this.getRootFS()!==this),this.getRootFS().resolveFS(n).touch(n)},getURL:function(e){return this.getContent(e).toURL()},opendirEx:function(e,n){i.is(e,t.AbsDir),n=n||{};var r={},a=this.getDirInfo(e);if(n.includeTrashed)return a;for(var o in a)a[o].trashed||(r[o]=a[o]);return r}}),s}),$.ajaxTransport("+binary",function(e,t,n){return window.FormData&&(e.dataType&&"binary"==e.dataType||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))?{send:function(t,n){var i=new XMLHttpRequest,r=e.url,a=e.type,o=e.async||!0,s=e.responseType||"blob",u=e.data||null,c=e.username||null,l=e.password||null;i.addEventListener("load",function(){var t={};t[e.dataType]=i.response,n(i.status,i.statusText,t,i.getAllResponseHeaders())}),i.open(a,r,o,c,l);for(var f in t)i.setRequestHeader(f,t[f]);i.responseType=s,i.send(u)},abort:function(){n.abort()}}:void 0}),e("jquery.binarytransport",function(){}),e("WebFS",["FSClass","jquery.binarytransport","DeferredUtil","Content","PathUtil"],function(e,t,n,i,r){var a=function(){},o=a.prototype=new e;return e.addFSType("web",function(){return new a}),o.fstype=function(){return"Web"},o.supportsSync=function(){return!1},o.inMyFS=function(e){return r.isURL(e)},e.delegateMethods(o,{exists:function(){return!0},getContentAsync:function(e){var t=this;return n.promise(function(n,r){$.get(e,function(r){var a=new FileReader;a.addEventListener("loadend",function(){n(i.bin(a.result,t.getContentType(e)))}),a.readAsArrayBuffer(r)},"binary").fail(r)})},getURL:function(e){return e}}),a}),e("Env",["assert","PathUtil"],function(e,t){var n=function(e){this.value=e};return n.prototype={expand:function(t){e.is(t,String);var n=this;return t.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,t){return n.get(t)})},expandPath:function(n){return e.is(n,String),n=this.expand(n),n=n.replace(/\/+/g,"/"),n=n.replace(/^[a-z][a-z]+:\//,function(e){return e+"/"}),e.is(n,t.Path)},get:function(e){return this.value[e]},set:function(e,t){this.value[e]=t}},n}),e("SFile",["extend","assert","PathUtil","Util","Content","FSClass","FileSaver.min","DeferredUtil"],function(e,t,n,i,r,a,o,s){var u=function(e,i){t.is(i,n.Absolute),this._path=i,this.rootFS=e,this.fs=e.resolveFS(i),this.isDir()&&!n.isDir(i)&&(this._path+=n.SEP)};return u.is=function(e){return e&&"function"==typeof e.isSFile&&e.isSFile()},u.prototype={isSFile:function(){return!0},setPolicy:function(e){if(this.policy)throw new Error("policy already set");return this.policy=e,this._clone()},getPolicy:function(){return this.policy},_clone:function(){return this._resolve(this.path())},_resolve:function(e,r){var a;if(r=r||{},u.is(e))a=e;else{t.is(e,n.Absolute);var o,s=r.policy||this.policy;if(s&&(o=s.topDir)&&(o.path&&(o=o.path()),!n.startsWith(e,o)))throw new Error(e+": cannot access. Restricted to "+o);a=new u(this.rootFS,e),a.policy=s}return a.policy?i.privatize(a):a},contains:function(e){return t(u.is(e),e+" shoud be a SFile object."),this.isDir()?n.startsWith(e.path(),this.path()):!1},path:function(){return this._path},name:function(){return n.name(this.path())},truncExt:function(e){return n.truncExt(this.path(),e)},ext:function(){return n.ext(this.path())},relPath:function(e){var i=e.path?e.path():e;return n.relPath(this.path(),t.is(i,n.Absolute))},up:function(){var e=this.path(),t=n.up(e);return null==t?null:this._resolve(t)},rel:function(e){t.is(e,n.Relative),this.assertDir();var i=this.path();return this._resolve(n.rel(i,e))},sibling:function(e){return this.up().rel(e)},startsWith:function(e){return n.startsWith(this.name(),e)},endsWith:function(e){return n.endsWith(this.name(),e)},equals:function(e){return e&&"function"==typeof e.path&&e.path()==this.path()},toString:function(){return this.path()},touch:function(){return this.act.fs.touch(this.act.path)},isReadOnly:function(){return this.act.fs.isReadOnly(this.act.path)},isTrashed:function(){var e=this.metaInfo();return e?e.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(e){return this.act.fs.getMetaInfo(this.act.path,e)},setMetaInfo:function(e,t){return this.act.fs.setMetaInfo(this.act.path,e,t)},getDirTree:function(e){return this.act.fs.getDirTree(this.act.path,e)},assertExists:function(){t(this.exists(),this.path()+" does not exist.")},lastUpdate:function(){return this.assertExists(),this.metaInfo().lastUpdate},exists:function(e){var t=Array.prototype.slice.call(arguments);if("function"==typeof t[0]){var n=t.shift();return s.resolve(this.exists.apply(this,t)).then(n)}e=e||{};var i=this.fs.exists(this.path(),e);return i||e.noFollowLink?i:this.act.fs.exists(this.act.path,{noFollowLink:!0})},rm:function(e){var t=this;if(e=e||{},this.isLink())return s.resolve(this.fs.rm(this.path(),e));var n;return n=this.isDir()&&(e.recursive||e.r)?this.each(function(t){return t.rm(e)}):s.resolve(),n.then(function(){return t.act.fs.rm(t.act.path,e)})},removeWithoutTrash:function(e){e=e||{},e.noTrash=!0,this.rm(e)},isDir:function(){return this.act.fs.isDir(this.act.path)},text:function(e){return"function"==typeof e?this.getText(e):arguments.length>0?this.setText(arguments[0]):this.getText()},setText:function(e){if(t.is(e,String),this.isDir())throw new Error("Cannot write to directory: "+this.path());var n=this.contentType({def:null});return s.throwNowIfRejected(null!==n&&!n.match(/^text/)&&r.looksLikeDataURL(e)?this.setContent(r.url(e)):this.setContent(r.plainText(e)))},appendText:function(e){return t.is(e,String),this.act.fs.appendContent(this.act.path,r.plainText(e))},getContent:function(e){return"function"==typeof e?this.act.fs.getContentAsync(this.act.path).then(e):this.act.fs.getContent(this.act.path)},setContent:function(e){if(this.isDir())throw new Error("Cannot write to directory: "+this.path());return this.act.fs.setContentAsync(this.act.path,e)},getText:function(e){function t(e){try{return e.toPlainText()}catch(t){return e.toURL()}}if("function"==typeof e){return this.getContent(t).then(e)}return t(this.act.fs.getContent(this.act.path))},getDataURL:function(e){return"function"==typeof e?this.getContent(function(e){return e.toURL()}):this.getContent().toURL()},setDataURL:function(e){return this.setContent(r.url(e))},dataURL:function(e){return"string"==typeof e?this.setDataURL(e):"function"==typeof e?this.getDataURL(e):this.getDataURL()},isText:function(){return this.act.fs.isText(this.act.path)},contentType:function(e){return this.act.fs.getContentType(this.act.path,e)},bytes:function(e){return r.isBuffer(e)?this.setBytes(e):this.getBytes()},setBytes:function(e){return this.act.fs.setContent(this.act.path,r.bin(e,this.contentType()))},getBytes:function(e){return e=e||{},this.act.fs.getContent(this.act.path).toBin(e.binType)},getURL:function(){return this.act.fs.getURL(this.act.path)},lines:function(e){return e instanceof Array?this.text(e.join("\n")):"function"==typeof e?this.text(function(t){return e(t.replace(/\r/g,"").split("\n"))}):this.text().replace(/\r/g,"").split("\n")},obj:function(){var e=this;if(0==arguments.length){var n=e.text();return n?JSON.parse(n):null}e.text(JSON.stringify(t.is(arguments[0],Object)))},copyFrom:function(e,t){return e.copyTo(this,t)},copyTo:function(e,n){t(e&&e.isSFile(),e+" is not a file");var i=this,n=n||{},r=i.isDir(),a=e.isDir();if(!r&&a&&(e=e.rel(i.name()),t(!e.isDir(),e+" is a directory."),a=!1),!r||a){if(r||a)return t(r&&a,"Both src and dst should be dir"),i.each(function(t){var i,r=e.rel(t.name());return n.progress&&(i=n.progress(r,{src:t,dst:r})),s.resolve(i).then(function(){return r.copyFrom(t,n)})});n.echo&&n.echo(i+" -> "+e);var o=this.act.fs.cp(this.act.path,e.getResolvedLinkPath(),n);return o=s.resolve(o),n.a?o.then(function(){return e.setMetaInfo(i.getMetaInfo())}):o}this.err("Cannot move dir "+i.path()+" to file "+e.path())},moveFrom:function(e,t){var n=this;return n.exists(function(i){return n.copyFrom(e,t).then(function(){return e.rm({recursive:!0})},function(e){if(!i)return n.exists(function(e){return e?n.rm({recursive:!0}):void 0}).then(function(){throw e});throw e})})},moveTo:function(e,t){return e.moveFrom(this,t)},assertDir:function(){return t.is(this.path(),n.Dir),this},each:function(e,t){var n=this.assertDir();return n.listFilesAsync(t).then(function(t){return s.each(t,e)})},eachrev:function(e,t){var n=this.assertDir();return n.listFilesAsync(t).then(function(t){return s.each(t.reverse(),e)})},recursive:function(e,t){var n=this.assertDir();return t=n.convertOptions(t),n.each(function(n){return n.isDir()?n.recursive(e,t):e(n)},t)},listFilesAsync:function(e){t(null==e||"object"==typeof e);{var n,i=this.assertDir();this.path()}return e=i.convertOptions(e),n||(n=e.order),this.act.fs.opendirAsync(this.act.path,e).then(function(t){for(var r=[],a=0;a<t.length;a++){var o=t[a],s=i.rel(o);e.excludesF(s)||r.push(s)}return"function"==typeof n&&r.sort&&r.sort(n),r})},listFiles:function(){var e=Array.prototype.slice.call(arguments);return s.assertResolved(this.listFilesAsync.apply(this,e))},ls:function(e){t(null==e||"object"==typeof e);var n=this.assertDir();if(!e)return this.act.fs.opendir(this.act.path,e);var i=n.listFiles(e);return i.map(function(e){return e.name()})},convertOptions:function(e){var r=i.extend({},e),a=(this.assertDir(),this.path()),o=r.excludes||{};if("function"==typeof o)r.excludesF=o;else if("object"==typeof o){if(o instanceof Array){var s={};o.forEach(function(e){n.startsWith(e,"/")?s[e]=1:s[a+e]=1}),o=s}r.excludesF=function(e){return o[e.path()]}}return t.is(r,{excludesF:Function})},mkdir:function(){return this.touch()},link:function(e,t){if(this.exists())throw new Error(this.path()+": exists.");return this.act.fs.link(this.act.path,e.path(),t)},resolveLink:function(){return this._resolve(this.act.path)},isLink:function(){return this.fs.isLink(this.path())},getResolvedLinkPath:function(){return this.act.path},getFS:function(){return this.act.fs},observe:function(e){return this.getFS().getRootFS().addObserver(this.path(),e)},getBlob:function(){return new Blob([this.bytes()],{type:this.contentType()})},setBlob:function(e){var t=this;return s.promise(function(n){var i=new FileReader;i.addEventListener("loadend",function(){s.resolve(t.setBytes(i.result)).then(n)}),i.readAsArrayBuffer(e)})},download:function(){if(this.isDir())throw new Error(this+": Download dir is not support yet. Use 'zip' instead.");o(this.getBlob(),this.name())},err:function(){var e=Array.prototype.slice.call(arguments);throw console.log.apply(console,e),new Error(e.join(""))},exportAsObject:function(e){var t=this,n={};this.recursive(function(e){n[e.relPath(t)]=e.text()},e);var i={base:t.path(),data:n};return i},importFromObject:function(e){"string"==typeof e&&(e=JSON.parse(e));var e=e.data;for(var t in e)this.rel(t).text(e[t])}},Object.defineProperty(u.prototype,"act",{get:function(){return this._act?this._act:(this._act={},this._act.path=this.fs.resolveLink(this._path),this._act.fs=this.rootFS.resolveFS(this._act.path),t.is(this._act,{fs:a,path:n.Absolute}),this._act)}}),u}),e("RootFS",["assert","FSClass","PathUtil","SFile"],function(e,t,n,i){var r=function(n){e.is(n,t),this.mount(null,n)},a=r.prototype,o={err:function(e,t){throw new Error(e+": "+t)},fstab:function(){return this._fstab=this._fstab||[]},unmount:function(t){e.is(arguments,[n.AbsDir]);var i=this.fstab();console.log(i);for(var r=0;r<i.length;r++)if(i[r].mountPoint==t)return i.splice(r,1),!0;return!1},availFSTypes:function(){return t.availFSTypes()},mount:function(n,i,r){if("string"==typeof i){var a=e(t.availFSTypes()[i],"fstype "+i+" is undefined.");i=a(n,r||{})}e.is(i,t),i.mounted(this,n),this.fstab().unshift(i)},resolveFS:function(i){e.is(i,n.Absolute);var r;return this.fstab().forEach(function(e){r||e.inMyFS(i)&&(r=e)}),r||this.err(i,"Cannot resolve"),e.is(r,t)},get:function(t){return e.is(t,n.Absolute),new i(this.resolveFS(t),t)},addObserver:function(){this.observers=this.observers||[];var t,n;if(2==arguments.length)t=arguments[0],n=arguments[1];else{if(1!=arguments.length)throw new Error("Invalid argument spec");t="",n=arguments[0]}e.is(t,String),e.is(n,Function);var i=this.observers,r={path:t,handler:n,remove:function(){var e=i.indexOf(this);i.splice(e,1)}};return this.observers.push(r),r},notifyChanged:function(e,t){this.observers&&this.observers.forEach(function(i){n.startsWith(e,i.path)&&i.handler(e,t)})},getRootFS:function(){return this}};for(var s in o)a[s]=o[s];return r}),e("zip",["SFile","FileSaver.min","Util","DeferredUtil"],function(e,t,n,i){var r={};return r.setJSZip=function(e){r.JSZip=e,i.external.Promise||(i.external.Promise=e.external.Promise)},"undefined"!=typeof JSZip&&r.setJSZip(JSZip),r.zip=function(t,n,a){function s(e,t){return t.each(function(t){var n=i.resolve();return a.progress&&(n=a.progress(t)),n.then(function(){if(t.isDir()){var n=e.folder(t.name().replace(/[\/\\]$/,""));return s(n,t)}return t.getContent(function(n){e.file(t.name(),n.toArrayBuffer())})})})}e.is(n)||(a=n),a=a||{};var u=new r.JSZip;return s(u,t).then(function(){return i.resolve(u.generateAsync({type:"arraybuffer",compression:"DEFLATE"}))}).then(function(i){return e.is(n)?n.setBytes(i):void o(new Blob([i],{type:"application/zip"}),t.name().replace(/[\/\\]$/,"")+".zip")})},r.unzip=function(t,n,a){var o,s={};a=a||{},e.is(t)&&(o=t.getContent(),t=o.toArrayBuffer()),a.onCheckFile||(a.onCheckFile=function(e){return a.overwrite?e:e.exists()?!1:e});var u=new r.JSZip;return i.resolve(u.loadAsync(t)).then(function(){return i.each(u.files,function(t,r){var o,u;return i.resolve(r.async("arraybuffer")).then(function(e){return o=e,u=n.rel(r.name),a.progress?i.resolve(a.progress(u)):void 0}).then(function(){if(console.log("Inflating",r.name),!u.isDir()){var t={file:u,status:"uploaded"};s[u.path()]=t;var n=FS.Content.bin(o,u.contentType()),i=a.onCheckFile(u,n);return i===!1&&(t.status="cancelled",u=null),e.is(i)&&(u.path()!==i.path()&&(t.redirectedTo=i),u=i),u?u.setContent(n):void 0}})})}).then(function(){return console.log("unzip done",s),s})},r}),e("FS",["FSClass","NativeFS","LSFS","WebFS","PathUtil","Env","assert","SFile","RootFS","Content","zip","DeferredUtil"],function(e,t,n,i,r,a,o,s,u,c,l,f){var p={};p.assert=o,p.Content=c,p.Class=e,p.DeferredUtil=f,p.Env=a,p.LSFS=n,p.NativeFS=t,p.PathUtil=r,p.RootFS=u,p.SFile=s,p.WebFS=i,p.zip=l,"object"==typeof window&&(window.FS=p);var h,m=new a({});return p.addFSType=e.addFSType,p.availFSTypes=e.availFSTypes,p.setEnvProvider=function(e){m=e},p.getEnvProvider=function(){return m},p.setEnv=function(e,t){if("object"==typeof e)for(var n in e)m.set(n,e[n]);else m.set(e,t)},p.getEnv=function(e){return"string"==typeof e?m.get(e):m.value},p.init=function(e){h||(e||("object"==typeof process?e=new t:"object"==typeof localStorage?e=new n(localStorage):"function"==typeof importScripts&&(self.addEventListener("message",function(e){var t=e.data;switch("string"==typeof t&&(t=JSON.parse(t)),t.type){case"upload":p.get(t.base).importFromObject(t.data);break;case"observe":h.observe(t.path,function(e,t){self.postMessage(JSON.stringify({type:"changed",path:e,content:p.get(e).text(),meta:t}))})}}),e=n.ramDisk())),h=new u(e))},p.getRootFS=function(){return p.init(),h},p.get=function(){return p.init(),h.get.apply(h,arguments)},p.expandPath=function(){return m.expandPath.apply(m,arguments)},p.resolve=function(e,t){return p.init(),s.is(e)?e:(e=m.expandPath(e),t&&!r.isAbsolutePath(e)?(t=m.expandPath(t),p.get(t).rel(e)):p.get(e))},p.mount=function(){return p.init(),h.mount.apply(h,arguments)},p.unmount=function(){return p.init(),h.unmount.apply(h,arguments)},p.isFile=function(e){return s.is(e)},p});var s;return t(["FS"],function(e){s=e}),void 0===window.FS&&(window.FS=s),s}),a.setName("Platform"),n([],function(){var e={},t=window.navigator.userAgent.toLowerCase();return e.tablet=-1!=t.indexOf("windows")&&-1!=t.indexOf("touch")||-1!=t.indexOf("ipad")||-1!=t.indexOf("android")&&-1==t.indexOf("mobile")||-1!=t.indexOf("firefox")&&-1!=t.indexOf("tablet")||-1!=t.indexOf("kindle")||-1!=t.indexOf("silk")||-1!=t.indexOf("playbook"),e.mobile=-1!=t.indexOf("windows")&&-1!=t.indexOf("phone")||-1!=t.indexOf("iphone")||-1!=t.indexOf("ipod")||-1!=t.indexOf("android")&&-1!=t.indexOf("mobile")||-1!=t.indexOf("firefox")&&-1!=t.indexOf("mobile")||-1!=t.indexOf("blackberry"),e}),a.setName("WebSite"),n(["FS","Platform"],function(e,t){var n,i=e.PathUtil,r=document.location.href,a=!!r.match(/html\/dev\//)&&!!r.match(/localhost:3/),o=location.protocol;switch(o.match(/^http/)||(o="https:"),window.WebSite_runType){case"IDE":return n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},n.builtinAssetNames={"images/Ball.png":1,"images/base.png":1,"images/Sample.png":1,"images/inputPad.png":1,"images/neko.png":1,"images/mapchip.png":1},n.pluginTop||(n.pluginTop=n.top+"/js/plugins"),n.sampleImg=n.top+"/images",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.mp4Disabled=n.isNW,n.tonyuHome="/Tonyu/",n.PathSep="/",n.isNW?(n.noconcat=!0,n.PathSep=require("path").sep,n.cwd=i.directorify(process.cwd().replace(/\\/g,"/")),n.tonyuHome=process.env.TONYU_HOME?i.directorify(process.env.TONYU_HOME):i.rel(n.cwd,"fs/Tonyu/"),n.logdir=process.env.TONYU_LOGDIR,n.wwwDir=i.rel(n.cwd,"www/"),n.platform=process.platform,n.ffmpeg=i.rel(n.cwd,"win32"==n.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),n.pkgInfo=require(i.rel(n.cwd,"package.json")),n.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):n.pkgInfo&&n.pkgInfo.config&&n.pkgInfo.config.prjDirs?n.pkgInfo.config.prjDirs.map(function(e){return e=i.directorify(e),i.isAbsolute(e)?e:i.rel(n.cwd,e)}):[i.rel(n.cwd,"Projects/"),i.rel(n.tonyuHome,"Projects/")],n.kernelDir=i.rel(n.wwwDir,"Kernel/")):(n.wwwDir=r.match(/edit\.tonyu\.jp\/n\//)?o+"//"+location.host+"/n/":o+"//"+location.host+"/",n.projects=[i.rel(n.tonyuHome,"Projects/")]),n.kernelDir=i.rel(n.wwwDir,"Kernel/"),n.compiledKernel="Kernel/js/concat.js",r.match(/localhost\/tonyu2/)?(n.wwwDir=o+"//"+location.host+"/tonyu2/",n.kernelDir=n.wwwDir+"Kernel/",n.compiledKernel=n.kernelDir+"js/concat.js",n.uploadTmpUrl=o+"//localhost/tsite/tonyu/e/cgi-bin/uploadTmp.cgi",n.newVersionUrl=o+"//localhost/tsite/tonyu/project/newVersion.cgi"):(n.uploadTmpUrl=o+"//edit.tonyu.jp/cgi-bin/uploadTmp.cgi",n.newVersionUrl=o+"//www.tonyu.jp/project/newVersion.cgi"),n.version=2,n.hoge="fuga",e.setEnvProvider(new e.Env(n)),window.WebSite=n;case"singleHTML":if(n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},"object"==typeof BuiltinAssets)for(var s in BuiltinAssets)n.urlAliases[s]=BuiltinAssets[s];return n.tonyuHome="/Tonyu/",n.projects=[i.rel(n.tonyuHome,"Projects/")],n.scriptServer=r.match(/localhost\/tonyu2/)?"http://localhost/tonyu2/":"https://edit.tonyu.jp/",n.pluginTop=n.scriptServer+"js/plugins",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.PathSep="/",n.compiledKernel=n.scriptServer+"Kernel/js/concat.js",e.setEnvProvider(new e.Env(n)),window.WebSite=n;case"multiHTML":return n={urlAliases:{},top:".",tablet:t.tablet,mobile:t.mobile},n.tonyuHome="/Tonyu/",n.pluginTop=n.top+"/js/plugins",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.PathSep="/",n.mp4Disabled=n.isNW,n.isNW&&(n.PathSep=require("path").sep,n.cwd=i.directorify(process.cwd().replace(/\\/g,"/")),n.platform=process.platform),e.setEnvProvider(new e.Env(n)),window.WebSite=n}if(r.match(/jsrun\.it/))n={urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png"},top:"",devMode:a,pluginTop:"https://edit.tonyu.jp/js/plugins",removeJSOutput:!0};else if(r.match(/tonyuexe\.appspot\.com/)||r.match(/localhost:8887/)||r.match(/\/html\/((dev)|(build))\//))n={urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:a};else if(r.match(/bitarrow/)||r.match(/localhost.*pub/)){n={};var u=n;n.serverType="BA",u.runtime="../../../runtime/",u.urlAliases={"images/base.png":u.runtime+"images/base.png","images/Sample.png":u.runtime+"images/Sample.png","images/neko.png":u.runtime+"images/neko.png","images/mapchip.png":u.runtime+"images/mapchip.png","images/sound.png":u.runtime+"images/sound.png","images/sound_ogg.png":u.runtime+"images/sound_ogg.png","images/sound_mp3.png":u.runtime+"images/sound_mp3.png","images/sound_mp4.png":u.runtime+"images/sound_mp4.png","images/sound_m4a.png":u.runtime+"images/sound_m4a.png","images/sound_mid.png":u.runtime+"images/sound_mid.png","images/sound_wav.png":u.runtime+"images/sound_wav.png","images/ecl.png":u.runtime+"images/ecl.png"}}else n={urlAliases:{},top:".",devMode:a};if("object"==typeof BuiltinAssets)for(var s in BuiltinAssets)n.urlAliases[s]=BuiltinAssets[s];n.builtinAssetNames={"images/Ball.png":1,"images/base.png":1,"images/Sample.png":1,"images/neko.png":1,"images/mapchip.png":1};var c=window.navigator.userAgent.toLowerCase();return n.tablet=-1!=c.indexOf("windows")&&-1!=c.indexOf("touch")||-1!=c.indexOf("ipad")||-1!=c.indexOf("android")&&-1==c.indexOf("mobile")||-1!=c.indexOf("firefox")&&-1!=c.indexOf("tablet")||-1!=c.indexOf("kindle")||-1!=c.indexOf("silk")||-1!=c.indexOf("playbook"),n.mobile=-1!=c.indexOf("windows")&&-1!=c.indexOf("phone")||-1!=c.indexOf("iphone")||-1!=c.indexOf("ipod")||-1!=c.indexOf("android")&&-1!=c.indexOf("mobile")||-1!=c.indexOf("firefox")&&-1!=c.indexOf("mobile")||-1!=c.indexOf("blackberry"),n.pluginTop||(n.pluginTop=n.top+"/js/plugins"),n.disableROM={},(r.match(/\.appspot\.com/)||r.match(/localhost:888[87]/))&&(n.serverType="GAE"),r.match(/localhost:3000/)&&(n.serverType="Node"),n.serverTop=r.match(/tonyuexe\.appspot\.com/)||r.match(/localhost:8887/)?n.top+"/exe":n.top+"/edit",n.sampleImg=n.top+"/images",n.blobPath=n.serverTop+"/serveBlob",n.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),n.mp4Disabled=n.isNW,n.tonyuHome="/Tonyu/",n.url={getDirInfo:n.serverTop+"/getDirInfo",getFiles:n.serverTop+"/File2LSSync",putFiles:n.serverTop+"/LS2FileSync"},n.PathSep="/",n.isNW?(n.PathSep=require("path").sep,n.cwd=i.directorify(process.cwd().replace(/\\/g,"/")),n.tonyuHome=process.env.TONYU_HOME?i.directorify(process.env.TONYU_HOME):i.rel(n.cwd,"fs/Tonyu/"),n.logdir=process.env.TONYU_LOGDIR,n.wwwDir=i.rel(n.cwd,"www/"),n.platform=process.platform,n.ffmpeg=i.rel(n.cwd,"win32"==n.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),n.pkgInfo=require(i.rel(n.cwd,"package.json")),n.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):n.pkgInfo&&n.pkgInfo.config&&n.pkgInfo.config.prjDirs?n.pkgInfo.config.prjDirs.map(function(e){return e=i.directorify(e),i.isAbsolute(e)?e:i.rel(n.cwd,e)}):[i.rel(n.cwd,"Projects/"),i.rel(n.tonyuHome,"Projects/")],n.kernelDir=i.rel(n.wwwDir,"Kernel/")):(n.wwwDir=o+"//"+location.host+"/",n.projects=[i.rel(n.tonyuHome,"Projects/")]),(r.match(/edit\.tonyu\.jp/)||r.match(/tonyuedit\.appspot\.com/)||r.match(/localhost:888/))&&(n.kernelDir=o+"//"+location.host+"/Kernel/"),n.compiledKernel=r.match(/edit\.tonyu\.jp/)||r.match(/tonyuedit\.appspot\.com/)||r.match(/localhost:888/)||n.isNW?n.kernelDir+"js/concat.js":"BA"===n.serverType?n.runtime+"lib/tonyu/kernel.js":"https://edit.tonyu.jp/Kernel/js/concat.js",r.match(/localhost\/tonyu2/)?(n.wwwDir=o+"//"+location.host+"/tonyu2/",n.kernelDir=n.wwwDir+"Kernel/",n.compiledKernel=n.kernelDir+"js/concat.js",n.uploadTmpUrl=o+"//localhost/tsite/tonyu/e/cgi-bin/uploadTmp.cgi",n.newVersionUrl=o+"//localhost/tsite/tonyu/project/newVersion.cgi"):(n.uploadTmpUrl=o+"//edit.tonyu.jp/cgi-bin/uploadTmp.cgi",n.newVersionUrl=o+"//www.tonyu.jp/project/newVersion.cgi"),r.match(/((index)|(project))2/)&&(n.version=2,n.devMode=n.isNW?!0:!1),e.setEnvProvider(new e.Env(n)),window.WebSite=n}),a.setName("plugins"),n(["WebSite"],function(e){function t(e){var t=window;return e.split(".").forEach(function(e){t&&(t=t[e])}),t}function n(e){return"function"==typeof e&&(e={onload:e}),e||(e={}),e.onload||(e.onload=function(){}),e}var r={},o={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"},gif:{src:"gif-concat.js",detection:/GIFWriter/,symbol:"GIF"},jquery_ui:{src:"jquery-ui.js",detection:/\$InputBox/,symbol:"$.ui"}};return r.installed=o,r.detectNeeded=function(e,t){for(var n in o){var i=o[n].detection.exec(e);i&&(t[n]=1)}return t},r.loaded=function(e){var n=o[e];if(!n)throw new Error("plugin not found: "+e);return t(n.symbol)},r.loadAll=function(e,t){function i(){u>=a.length?t.onload():r.load(a[u++],i)}t=n(t);var a=[];for(var s in e)o[s]&&!r.loaded(s)&&a.push(s);var u=0;console.log("loading plugins",a),setTimeout(i,0)},r.load=function(t,r){var s=o[t];if(!s)throw new Error("plugin not found: "+t);r=n(r);var u,c=e.pluginTop+"/"+s.src;if("undefined"==typeof a?"function"==typeof i&&(u=i):a.real&&(u=a.real.requirejs),u)c=c.replace(/\.js$/,""),console.log("Loading plugin via requirejs",c),u([c],function(e){!window[s.symbol]&&e&&(window[s.symbol]=e),r.onload(e)
});else{console.log("Loading plugin via <script>",c);var l=document.createElement("script");l.src=c,l.onload=r.onload,document.body.appendChild(l)}},r.request=function(e){if(!r.loaded(e)){var t=new Error("Plugin "+e+" required");t.pluginName=e}},r}),a.setName("DeferredUtil"),n(["FS"],function(e){return e.DeferredUtil}),a.setName("assert"),n(["FS"],function(e){return e.assert}),a.setName("compiledProject"),n(["DeferredUtil","WebSite","assert"],function(e,t,n){var i=function(i,r){return n.is(arguments,[String,String]),{getNamespace:function(){return i},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(t){var n=e.directPromise(),i=this.getNamespace();return this.getDependingProjects().forEach(function(e){e.getNamespace()!=i&&(n=n.then(function(){return e.loadClasses(t)}))}),n},loadClasses:function(e){console.log("Loading compiled classes ns=",i,"url=",r);var n=r+("BA"===t.serverType?"?"+Math.random():""),a=(window.navigator.userAgent.toLowerCase(),this);return this.loadDependingClasses(e).then(function(){return a.requirejs(n)}).then(function(){console.log("Done Loading compiled classes ns=",i,"url=",n,Tonyu.classes)})},requirejs:function(t){return e.promise(function(e){var n=document.getElementsByTagName("head")[0]||document.documentElement,i=document.createElement("script");"string"==typeof tonyu_app_version&&(t+="?"+tonyu_app_version),i.src=t;var r=!1;i.onload=i.onreadystatechange=function(){r||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(r=!0,console.log("Done load ",t),i.onload=i.onreadystatechange=null,n&&i.parentNode&&n.removeChild(i),e())},n.insertBefore(i,n.firstChild)})},loadClassesOLD:function(e){console.log("Load compiled classes ns=",i,"url=",r);var n=new $.Deferred,a=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.src=r+("BA"===t.serverType?"?"+Math.random():"");var s=!1;return o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,o.onload=o.onreadystatechange=null,a&&o.parentNode&&a.removeChild(o),console.log("Done Load compiled classes ns=",i,"url=",r,Tonyu.classes),n.resolve())},this.loadDependingClasses(e).then(function(){a.insertBefore(o,a.firstChild)}),n.promise()}}};return i}),a.setName("compiledTonyuProject"),n(["plugins","compiledProject"],function(e,t){var n=function(n,i,r){var a=t(n,i),o=t("kernel",WebSite.compiledKernel),s={getDir:function(){return r},getDependingProjects:function(){return[o]},getOptions:function(){var e=this.getDir().rel("options.json");return e.obj()},getResource:function(){var e=this.getDir().rel("res.json");return e.obj()},loadPlugins:function(t){var n=this.getOptions();return e.loadAll(n.plugins,t)},requestPlugin:function(){},run:function(e){var t={classes:Tonyu.classMetas};this.loadClasses(t).then(function(){Tonyu.run(e)})}};for(var u in s)a[u]=s[u];return a};return n}),a.setName("Shell"),n(["FS","assert"],function(e,t){function n(t,n){var r=i(t);if(e.SFile.is(r)||console.log(r," is not file"),n&&!r.exists())throw new Error(r+": no such file or directory");return r}function i(t){if("string"!=typeof t)return t;var n=r.cwd;return a.isAbsolutePath(t)?e.resolve(t,n):n.rel(t)}var r={},a=t(e.PathUtil);return r.newCommand=function(e,t){this[e]=t},r.cd=function(e){return r.cwd=n(e,!0),r.pwd()},r.vars=Object.create(e.getEnv()),r.mount=function(t,n){if(!t||!t.t){var i=[];for(var r in e.getRootFS().availFSTypes())i.push(r);return void sh.err("-t=("+i.join("|")+") should be specified.")}e.mount(n,t.t,t)},r.unmount=function(t){e.unmount(t)},r.fstab=function(){var t=e.getRootFS(),n=t.fstab(),i=this;n.forEach(function(e){i.echo(e.fstype()+"	"+(e.mountPoint||"<Default>"))})},r.resolve=n,r.pwd=function(){return r.cwd+""},r.ls=function(e){return e=e?n(e,!0):r.cwd,e.ls()},r.cp=function(e,t,i){i||(i={}),i.v&&(r.echo("cp",e,t),i.echo=r.echo.bind(r));var a=n(e,!0),o=n(t);return a.copyTo(o,i)},r.ln=function(e,t,i){var r=n(t),a=n(e,!0);if(r.isDir()&&r.exists()&&(r=r.rel(a.name())),r.exists())throw new Error(r+" exists");return r.link(a,i)},r.rm=function(e,t){if(t||(t={}),t.notrash)return e=n(e,!1),e.removeWithoutTrash(),1;if(e=n(e,!0),e.isDir()&&t.r){var i=e,a=0;return i.each(function(e){e.exists()&&(a+=r.rm(e,t))}),i.rm(),a+1}return e.rm(),1},r.mkdir=function(e){if(e=n(e,!1),e.exists())throw new Error(e+" : exists");return e.mkdir()},r.cat=function(e){return e=n(e,!0),r.echo(e.getContent(function(t){return e.isText()?t.toPlainText():t.toURL()}))},r.resolve=function(e){return e||(e="."),e=n(e)},r.grep=function(e,t,i){function a(e,t,n){i.res&&i.res.push({file:e,lineNo:t,line:n}),r.echo(e+"("+t+"): "+n)}return t=n(t,!0),i||(i={}),i.res||(i.res=[]),t.isDir()?t.each(function(t){r.grep(e,t,i)}):"string"==typeof e&&t.lines().forEach(function(n,i){n.indexOf(e)>=0&&a(t,i+1,n)}),i.res},r.touch=function(e){return e=n(e),e.text(e.exists()?e.text():""),1},r.setout=function(e){r.outUI=e},r.echo=function(){return $.when.apply($,arguments).then(function(){console.log.apply(console,arguments),r.outUI&&r.outUI.log&&r.outUI.log.apply(r.outUI,arguments)})},r.err=function(e){console.log.apply(console,arguments),e&&e.stack&&console.log(e.stack),r.outUI&&r.outUI.err&&r.outUI.err.apply(r.outUI,arguments)},r.clone=function(){var e=Object.create(this);return e.vars=Object.create(this.vars),e},r.getvar=function(e){return this.vars[e]||process&&process.env[e]},r.get=r.getvar,r.set=function(e,t){return this.vars[e]=t},r.strcat=function(){if(1==arguments.length)return arguments[0];for(var e="",t=0;t<arguments.length;t++)e+=arguments[t];return e},r.exists=function(e){return e=this.resolve(e),e.exists()},r.dl=function(e){return e=this.resolve(e||"."),e.download()},r.zip=function(){var t=this,n=Array.prototype.slice.call(arguments).map(function(e){return"string"==typeof e?t.resolve(e):e});return e.zip.zip.apply(e.zip,n)},r.unzip=function(){var t=this,n=Array.prototype.slice.call(arguments).map(function(e){return"string"==typeof e?t.resolve(e):e});return e.zip.unzip.apply(e.zip,n)},r.prompt=function(){},r.ASYNC={r:"SH_ASYNC"},r.help=function(){for(var e in r){var t=r[e];"function"==typeof t&&r.echo(e+(t.description?" - "+t.description:""))}},window.sh||(window.sh=r),"object"==typeof process?(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()},sh.cd(process.cwd().replace(/\\/g,"/"))):sh.cd("/"),r}),a.setName("Klass"),n(["assert"],function(e){function t(e){var t=/function[^\(]*\(([^\)]*)\)/,n=t.exec(e+"");return n?n[1].replace(/\s/g,"").split(","):[]}function n(e){if("object"!=typeof e)return!1;if(!e)return!1;var t={configurable:1,enumerable:1,value:1,writable:1,get:1,set:1},n=0;for(var i in e){if(!t[i])return!1;n+=t[i]}return n}var i={};return i.define=function(r){function a(t){r.$fields&&e.is(t,r.$fields)}function o(e){if(!f)return e;var n=t(e);return n[0]!==f?e:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(m),e.apply(m,t)}}function s(e){if(!l)return e;if(n(e)){for(var i in e)e[i]=s(e[i]);return e}if("function"!=typeof e)return e;var r=t(e);return r[0]!==l?e:function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),e.apply(this,t)}}var u,c;r.$parent?(c=r.$parent,u=Object.create(c.prototype),u.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return c.prototype[t].apply(this,e)}):u={};var l,f;r.$this&&(l=r.$this),r.$singleton&&(f=r.$singleton);var p,h=s(r.$)||function(e){if(e&&"object"==typeof e)for(var t in e)this[t]=e[t]};h instanceof Array&&(p=h,h=function(){for(var e=Array.prototype.slice.call(arguments),t=0;t<p.length;t++)e.length>0&&(this[p[t]]=e.shift())});var m;m=function(){if(!(this instanceof m)){var e=Object.create(u);return h.apply(e,arguments),a(e),e}h.apply(this,arguments),a(this)},c&&(m.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),n=e.shift();return c.prototype[n].apply(t,e)}),m.inherit=function(e){return e.$parent=m,i.define(e)},m.prototype=u;for(var d in r)"$"!=d[0]&&("static$"==d.substring(0,7)?m[d.substring(7)]=o(r[d]):n(r[d])?Object.defineProperty(u,d,s(r[d])):u[d]=s(r[d]));return u.$=h,Object.defineProperty(u,"$bind",{get:function(){return this.__bounded||(this.__bounded=new i.Binder(this)),this.__bounded}}),m},i.Function=function(){throw new Exception("Abstract")},i.opt=e.opt,i.Binder=i.define({$this:"t",$:function(e,t){for(var n in t)(function(n){"function"==typeof t[n]&&(e[n]=function(){var e=Array.prototype.slice.call(arguments);return t[n].apply(t,e)})})(n)}}),i}),a.setName("Tonyu.Thread"),n(["DeferredUtil","Klass"],function(e,t){var n={enterC:{},exitC:0},i=1;try{window.cnts=n}catch(r){}var a=t.define({$:function(){this.frame=null,this._isDead=!1,this.cnt=0,this._isWaiting=!1,this.fSuspended=!1,this.tryStack=[],this.preemptionTime=60,this.onEndHandlers=[],this.onTerminateHandlers=[],this.id=i++,this.age=0},isAlive:function(){return!this.isDead()},isDead:function(){return this._isDead=this._isDead||null==this.frame||this._threadGroup&&(this._threadGroup.objectPoolAge!=this.tGrpObjectPoolAge||this._threadGroup.isDeadThreadGroup())},setThreadGroup:function(e){this._threadGroup=e,this.tGrpObjectPoolAge=e.objectPoolAge},isWaiting:function(){return this._isWaiting},suspend:function(){this.fSuspended=!0,this.cnt=0},enter:function(e){this.frame={prev:this.frame,func:e}},apply:function(e,t,n){n||(n=[]);var i;if("string"==typeof t&&(i=e["fiber$"+t],!i))throw new Error("メソッド"+t+"が見つかりません");if("function"==typeof t&&(i=t.fiber,!i)){var r=t.methodInfo?t.methodInfo.name:t.name;throw new Error("メソッド"+r+"は待機可能メソッドではありません")}n=[this].concat(n);var a=0;return this.enter(function(t){switch(a){case 0:i.apply(e,n),a=1;break;case 1:t.termStatus="success",t.notifyEnd(t.retVal),n[0].exit(),a=2}})},notifyEnd:function(e){this.onEndHandlers.forEach(function(t){t(e)}),this.notifyTermination({status:"success",value:e})},notifyTermination:function(e){this.onTerminateHandlers.forEach(function(t){t(e)})},on:function(e,t){("end"===e||"success"===e)&&this.onEndHandlers.push(t),"terminate"===e&&(this.onTerminateHandlers.push(t),this.handleEx&&delete this.handleEx)},promise:function(){var t=this;return e.funcPromise(function(e,n){t.on("terminate",function(t){"success"===t.status?e(t.value):n("exception"===t.status?t.exception:new Error(t.status))})})},then:function(e,t){return t?this.proimse().then(e,t):this.proimse().then(e)},fail:function(e){return this.promise().fail(e)},gotoCatch:function(e){var t=this;if(0==t.tryStack.length)return t.termStatus="exception",t.kill(),void(t.handleEx?t.handleEx(e):t.notifyTermination({status:"exception",exception:e}));t.lastEx=e;for(var n=t.tryStack.pop();t.frame;){if(n.frame===t.frame){t.catchPC=n.catchPC;break}t.frame=t.frame.prev}},startCatch:function(){var e=this,t=e.lastEx;return e.lastEx=null,t},exit:function(e){this.frame=this.frame?this.frame.prev:null,this.retVal=e},enterTry:function(e){var t=this;t.tryStack.push({frame:t.frame,catchPC:e})},exitTry:function(){var e=this;e.tryStack.pop()},waitEvent:function(e,t){var n=this;if(n.suspend(),e.on){var i;t=t.concat(function(){n.lastEvent=arguments,n.retVal=arguments[0],i.remove(),n.steps()}),i=e.on.apply(e,t)}},runAsync:function(e){var t=this,n=function(){t.retVal=arguments,t.steps()},i=function(){for(var e="",n=0;n<arguments.length;n++)e+=arguments[n]+",";0==e.length&&(e="Async fail");var i=new Error(e);i.args=arguments,t.gotoCatch(i),t.steps()};t.suspend(),setTimeout(function(){e(n,i)},0)},waitFor:function(t){var n=this;return n._isWaiting=!0,n.suspend(),t instanceof a&&(t=t.promise()),e.ensureDefer(t).then(function(e){n.retVal=e,n.stepsLoop()}).fail(function(e){n.gotoCatch(n.wrapError(e)),n.stepsLoop()})},wrapError:function(e){if(e instanceof Error)return e;var t=new Error(e);return t.original=e,t},resume:function(e){this.retVal=e,this.steps()},steps:function(){var e=this;if(!e.isDead()){var t=Tonyu.currentThread;for(Tonyu.currentThread=e,e.cnt=e.preemptionTime,e.preempted=!1,e.fSuspended=!1;e.cnt>0&&e.frame;)try{for(;e.cnt-->0&&e.frame;)e.frame.func(e);e.preempted=!e.fSuspended&&e.isAlive()}catch(n){e.gotoCatch(n)}Tonyu.currentThread=t}},stepsLoop:function(){var e=this;e.steps(),e.preempted&&setTimeout(function(){e.stepsLoop()},0)},kill:function(){var e=this;e._isDead=!0,e.frame=null,e.termStatus||(e.termStatus="killed",e.notifyTermination({status:"killed"}))},clearFrame:function(){this.frame=null,this.tryStack=[]}});return a}),a.setName("Tonyu.Iterator"),n(["Klass"],function(e){function t(e,t){if(e.tonyuIterator)return e.tonyuIterator(t);if(e instanceof Array)return 1==t?new n(e):new i(e);if(e instanceof Object)return 1==t?new r(e):new a(e);throw console.log(e),new Error(e+" is not iterable")}var n=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.set[this.i],this.i++,!0)}}),i=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.i,this[1]=this.set[this.i],this.i++,!0)}}),r=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push(t);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i],this.i++,!0)}}),a=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push([t,e[t]]);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i][0],this[1]=this.elems[this.i][1],this.i++,!0)}});return t}),a.setName("Tonyu"),"function"!=typeof n&&(n=require("requirejs").define),n(["assert","Tonyu.Thread","Tonyu.Iterator","DeferredUtil"],function(e,t,n,i){return Tonyu=function(){function r(){var e=new t;return e.handleEx=s,e}function a(e){return i.funcPromise(function(t){setTimeout(t,e)})}function o(){return i.funcPromise(function(e){requestAnimationFrame(e)})}function s(e){if(!Tonyu.onRuntimeError)throw"undefined"==typeof $LASTPOS&&($LASTPOS=0),alert("エラー! at "+$LASTPOS+" メッセージ  : "+e),console.log(e.stack),e;Tonyu.onRuntimeError(e)}function u(t,n){return e.is(arguments,[String,Object]),l(klass.getMeta(t),n)}function c(e,t){return e?l(Object.create(e.prototype),t):l({},t)}function l(e,t){if(t&&"object"==typeof t)for(var n in t)e[n]=t[n];return e}function f(e,t){D[e]=t}function p(e){return D[e]}function h(e){var t=e.split("."),n=x;if(t.forEach(function(e){n&&(n=n[e])}),!n&&1==t.length){var i;for(var r in x){var a=x[r][e];if(a){if(n)throw new Error("曖昧なクラス名： "+r+"."+e+", "+i);n=a,i=r+"."+e}}}return n}function m(e,t){if("function"!=typeof t)return t;var n=function(){return t.apply(e,arguments)};return n.methodInfo=Tonyu.extend({thiz:e},t.methodInfo||{}),t.fiber&&(n.fiber=function(){return t.fiber.apply(e,arguments)},n.fiber.methodInfo=Tonyu.extend({thiz:e},t.fiber.methodInfo||{})),n}function d(e,t,n,i){if(!e)throw new Error(i+"(="+e+")のメソッド "+t+"を呼び出せません");var r=e[t];if("function"!=typeof r)throw new Error(("this"==i?"":i+".")+t+"(="+r+")はメソッドではありません");return r.apply(e,n)}function g(e,t,n){if("function"!=typeof e)throw new Error(n+"は関数ではありません");return e.apply({},t)}function y(e,t){if(e!=e||null==e)throw new Error(t+"(="+e+")は初期化されていません");return e}function v(e){for(var t=[],n=1;n<e.length;n++)t[n-1]=e[n];return t}function T(e){throw new Error("クラス名"+e+"はnewをつけて呼び出して下さい。")}function b(e){throw console.log("Not a tonyu object: ",e),new Error(e+" is not a tonyu object")}function A(e,t){return e in t}function S(e){var t=h(e);if(!t)throw new Error(e+" というクラスはありません");Tonyu.runMode=!0;var n,i=new t;(n=Tonyu.currentProject)&&(n.runningObj=i),$LASTPOS=0}function w(){var e=performance.now();if(e-k>1e3)throw P(1e4),new Error("無限ループをストップしました。\n   プロジェクト オプションで無限ループチェックの有無を設定できます。\n   [参考]https://edit.tonyu.jp/doc/options.html\n");B=e}function P(e){k=performance.now()+(e||0)}function M(e,t){return e?e instanceof t?!0:"function"==typeof e.getClassInfo&&t.meta?e.getClassInfo().includesRec[t.meta.fullName]:!1:!1}"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return Date.now()});klass=function(){throw alert("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again."),new Error("この関数は古くなりました。コンパイルをやり直してください。 Deprecated. compile again.")},klass.addMeta=u,klass.removeMeta=function(e){delete E[e]},klass.getMeta=function(e){if("function"==typeof e)return e.meta;if("string"==typeof e){var t=E[e];return t||(E[e]=t={}),t}},klass.ensureNamespace=function(e,t){var n,i=t.split("."),r=e;for(n=0;n<i.length;n++){var a=i[n];r[a]||(r[a]={}),r=r[a]}return r},Function.prototype.constructor=function(){throw new Error("This method should not be called")},klass.propReg=/^__([gs]et)ter__(.*)$/,klass.define=function(e){function t(e,n){if(n=n||{},n.isShim)return e;if(n.path=n.path||[],n.path.push(e),e.isShim)throw console.log("chkmeta::ctx",n),new Error("Shim found "+e.extenderFullName);if(e.superclass&&t(e.superclass,n),!e.includes)throw console.log("chkmeta::ctx",n),new Error("includes not found");return e.includes.forEach(function(e){t(e,n)}),n.path.pop(),e}function n(e,n){if(!e.prototype.hasOwnProperty("getClassInfo"))throw new Error("NO");if(!e.meta)throw console.log("metanotfound",e),new Error("meta not found");return t(e.meta,n),e}function i(e,t){var i=!t.init,r=t.includesRec;if(r[s])return e;r[s]=!0,o.forEach(function(n){e=n.extendFrom(e,l(t,{init:!1}))});var a="function"==typeof h?h(e):h;"undefined"!=typeof Profiler&&Profiler.profile(a,s);var d=a.initialize;delete a.initialize;var g;g=d?function(){this instanceof g||T(s),d.apply(this,arguments)}:e?function(){this instanceof g||T(s),e.apply(this,arguments)}:function(){this instanceof g||T(s)},g.prototype=c(e,{constructor:g}),g.meta=i?{isShim:!0,extenderFullName:s}:u(s,{fullName:s,shortName:f,namespace:p,decls:m,superclass:t.nonShimParent?t.nonShimParent.meta:null,includesRec:r,includes:o.map(function(e){return e.meta})}),g.meta.func=g,g.methods=a;var y=g.prototype,v={},b=klass.propReg;for(var A in a)if(!A.match(/^fiber\$/)){y[A]=a[A];var S="fiber$"+A;if(a[S]&&(y[S]=a[S],y[S].methodInfo=y[S].methodInfo||{name:A,klass:g,fiber:!0},y[A].fiber=y[S]),"__dummy"!==A&&!y[A])throw console.log("WHY!",y[A],y,A),new Error("WHY!"+A);y[A].methodInfo=y[A].methodInfo||{name:A,klass:g};var w=b.exec(A);w&&(v[w[2]]=v[w[2]]||{},v[w[2]][w[1]]=y[A])}y.isTonyuObject=!0;for(var A in v)Object.defineProperty(y,A,v[A]);return y.getClassInfo=function(){return g.meta},n(g,{isShim:i})}var r,a=e.superclass,o=e.includes,s=e.fullName,f=e.shortName,p=e.namespace,h=e.methods,m=e.decls,d=klass.ensureNamespace(Tonyu.classes,p),g=i(a,{init:!0,initFullName:s,includesRec:a?l({},a.meta.includesRec):{},nonShimParent:a});return g.extendFrom=i,d[f]=g,r=g,n(g,{isShim:!1})},klass.isSourceChanged=function(e){return e=e.meta||e,e.src&&e.src.tonyu?e.nodeTimestamp?e.src.tonyu.lastUpdate()>e.nodeTimestamp:!0:!1},klass.shouldCompile=function(e){if(e=e.meta||e,e.hasSemanticError)return!0;if(klass.isSourceChanged(e))return!0;for(var t=klass.getDependingClasses(e),n=0;n<t.length;n++)if(klass.shouldCompile(t[n]))return!0},klass.getDependingClasses=function(e){e=e.meta||e;var t=[];return e.superclass&&(t=[e.superclass]),e.includes&&(t=t.concat(e.includes)),t};var B,D={},x={},E={},k=performance.now();return setInterval(P,16),Tonyu={thread:r,klass:klass,bless:c,extend:l,globals:D,classes:x,classMetas:E,setGlobal:f,getGlobal:p,getClass:h,timeout:a,animationFrame:o,bindFunc:m,not_a_tonyu_object:b,is:M,hasKey:A,invokeMethod:d,callFunc:g,checkNonNull:y,run:S,iterator:n,checkLoop:w,resetLoopCheck:P,DeferredUtil:i,VERSION:1559441412271,A:v}}()}),a.setName("PatternParser"),n(["Tonyu"],function(e){var t=function(e,t){this.options=t||{},this.img=e,this.height=e.height,this.width=e.width;var n=this.newImage(e.width,e.height),i=n.getContext("2d");i.drawImage(e,0,0),this.ctx=i,this.pixels=this.ctx.getImageData(0,0,e.width,e.height).data,this.base=this.getPixel(0,0)};return e.extend(t.prototype,{newImage:function(e,t){var n=document.createElement("canvas");return n.width=e,n.height=t,n},getPixel:function(e,t){var n=this.pixels,i=4*(e+t*this.width),r=n[0+i],a=n[1+i],o=n[2+i],s=n[3+i];return 256*(256*(256*s+o)+a)+r},setPixel:function(e,t,n){var i=4*(e+t*this.width);this.pixels[0+i]=255&n,n=(n-(255&n))/256,this.pixels[1+i]=255&n,n=(n-(255&n))/256,this.pixels[2+i]=255&n,n=(n-(255&n))/256,this.pixels[3+i]=255&n},parse:function(){try{for(var e=[],t=0;t<this.height;t++)for(var n=0;n<this.width;n++){var i=this.getPixel(n,t);i!=this.base&&e.push(this.parse1Pattern(n,t))}return e}catch(r){if(r.isParseError)return console.log("parse error! "+r),[{image:this.img,x:0,y:0,width:this.width,height:this.height}];throw r}},parse1Pattern:function(e,t){function n(e){return e}function i(e,t,n){return{toString:function(){return"at ("+e+","+t+") :"+n},isParseError:!0}}for(var r=this.getPixel(e,t),a=e,o=t,s=this.base,u=this.width,c=this.height;u>a;){var l=this.getPixel(a,o);if(l!=r)break;a++}if(a>=u||this.getPixel(a,o)!=s)throw i(a,o,n(this.getPixel(a,o))+"!="+n(s));for(a--;c>o&&this.getPixel(a,o)==r;)o++;if(o>=c||this.getPixel(a,o)!=s)throw i(a,o,n(this.getPixel(a,o))+"!="+n(s));o--;var f=e+1,p=t+1,h=a-f,m=o-p;if(h*m==0)throw i(a,o,"w*h==0");for(var d=this.newImage(h,m),g=d.getContext("2d"),y=g.getImageData(0,0,h,m),v=y.data,T=0,b=p;o>b;b++)for(var A=f;a>A;A++){var S=this.getPixel(A,b);S==r?(v[T++]=0,v[T++]=0,v[T++]=0,v[T++]=0):(v[T++]=255&S,S=(S-(255&S))/256,v[T++]=255&S,S=(S-(255&S))/256,v[T++]=255&S,S=(S-(255&S))/256,v[T++]=255&S)}g.putImageData(y,0,0);for(var w=p-1;o>=w;w++)for(var P=f-1;a>=P;P++)this.setPixel(P,w,s);return this.options.boundsInSrc?{x:f,y:p,width:h,height:m}:{image:d,x:0,y:0,width:h,height:m}}}),t}),a.setName("Util"),Util=function(){function e(e,n){null==n&&(n=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+e+"=([^&#]*)"),r=i.exec(window.location.href);return null==r?n:t(r[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function n(e,t){return e.substring(e.length-t.length)===t}function i(e,t){return e.substring(0,t.length)===t}function r(e){function t(t){throw console.log(t),console.log(e,c),new Error(t)}e=e.replace(/[\n=]/g,"");var n=new Object;n[65]=0,n[66]=1,n[67]=2,n[68]=3,n[69]=4,n[70]=5,n[71]=6,n[72]=7,n[73]=8,n[74]=9,n[75]=10,n[76]=11,n[77]=12,n[78]=13,n[79]=14,n[80]=15,n[81]=16,n[82]=17,n[83]=18,n[84]=19,n[85]=20,n[86]=21,n[87]=22,n[88]=23,n[89]=24,n[90]=25,n[97]=26,n[98]=27,n[99]=28,n[100]=29,n[101]=30,n[102]=31,n[103]=32,n[104]=33,n[105]=34,n[106]=35,n[107]=36,n[108]=37,n[109]=38,n[110]=39,n[111]=40,n[112]=41,n[113]=42,n[114]=43,n[115]=44,n[116]=45,n[117]=46,n[118]=47,n[119]=48,n[120]=49,n[121]=50,n[122]=51,n[48]=52,n[49]=53,n[50]=54,n[51]=55,n[52]=56,n[53]=57,n[54]=58,n[55]=59,n[56]=60,n[57]=61,n[43]=62,n[47]=63;var i,r=e.length,a=0,o=0;if(!r)return new ArrayBuffer(0);i=Math.floor(r/4*3),"="==e.charAt(r-1)&&(i-=1),"="==e.charAt(r-2)&&(i-=1);for(var s=new ArrayBuffer(i),u=new Uint8Array(s),c=0,l=0;i>l&&(o=n[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),a=o<<2,c++,o=n[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o>>4&3,a=(15&o)<<4,c++,l++,!(l>=i))&&(o=n[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o>>2&15,a=(3&o)<<6,c++,l++,!(l>=i));)o=n[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o,c++,l++;return s}function a(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",i=new Uint8Array(e),r=i.length,a=0,o=0,s=0;r>s&&(o=i[s],n+=t[o>>2],a=(3&o)<<4,s++,!(s>=r))&&(o=i[s],n+=t[a|o>>4],a=(15&o)<<2,s++,!(s>=r));)o=i[s],n+=t[a|o>>6],n+=t[63&o],s++;var u=r%3;return u&&(n+=t[a]),1==u?n+="==":2==u&&(n+="="),n}function o(e){if(e.__privatized)return e;var t={__privatized:!0};for(var n in e)!function(n){var i=e[n];n.match(/^_/)||"function"==typeof i&&(t[n]=function(){var t=i.apply(e,arguments);return t})}(n);return t}function s(){return"undefined"!=typeof Buffer}function u(e){return s()&&e instanceof Buffer}function c(e){return e instanceof ArrayBuffer||u(e)}function l(e){for(var t=[],n=0;n<e.length;n++)t.push("%"+("0"+e[n].toString(16)).slice(-2));try{return decodeURIComponent(t.join(""))}catch(i){throw console.log(t.join("")),i}}function f(e,t){for(var n=encodeURIComponent(e),i=/^%(..)/,r=[],a=0;a<n.length;a++){var o=i.exec(n.substring(a));o?(r.push(parseInt("0x"+o[1])),a+=o[0].length-1):r.push(n.charCodeAt(a))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(r):new Uint8Array(r).buffer}return{getQueryString:e,endsWith:n,startsWith:i,Base64_To_ArrayBuffer:r,Base64_From_ArrayBuffer:a,utf8bytes2str:l,str2utf8bytes:f,privatize:o,hasNodeBuffer:s,isNodeBuffer:u,isBuffer:c}}(),n("Util",[],function(){return Util}),a.setName("Assets"),n(["WebSite","Util","Tonyu","FS"],function(e,t,n,i){var r={};return r.resolve=function(n,r,a){a=a||{};var o=i.isFile(r)?r:r.getDir();if(null==n&&(n=""),n=n.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,n){return e[n]}),e.urlAliases[n]&&(n=e.urlAliases[n]),t.startsWith(n,"ls:")){var s=n.substring("ls:".length);if(!o)throw new Error("Basedir not specified");var u=o.rel(s);if(!u.exists())throw new Error("Resource file not found: "+u);if(e.mp3Disabled&&s.match(/\.(mp3)$/)||e.mp4Disabled&&s.match(/\.(mp4|m4a)$/)){var c=o.rel(s.replace(/\.(mp3|mp4|m4a)$/,".ogg"));c.exists()&&(u=c)}if(n=u.getURL(),a.asFile)return u}return n},n.Assets=r,r}),a.setName("ImageList"),n(["PatternParser","Util","Assets","assert"],function(e,t,n,i){function r(e){var t=[];return e.forEach(function(e){e&&""!=e.url&&t.push(e)}),t}var a,o={};return a=function(t,a,s){s||(s={}),t=r(t);var u=[],c=t.length;0==c&&setTimeout(function(){var e=[];e.names={},a(e)},0),t.forEach(function(t,r){function l(){var n,o;if("single"==t.type)u[r]=[{image:this,x:0,y:0,width:this.width,height:this.height}];else if((n=t.pwidth)&&(o=t.pheight)){for(var s=0,l=0,f=this.width,p=this.height,h=[];;){var m=n,d=o;if(s+n>f&&(m=f-s),l+o>p&&(d=p-l),h.push({image:this,x:s,y:l,width:m,height:d}),s+=n,s+n>f&&(s=0,l+=o,l+o>p))break}u[r]=h}else{var g=new e(this);u[r]=g.parse()}if(u[r].name=t.name,i.is(u[r],Array),c--,0==c){var y=[],v={};u.forEach(function(e){v[e.name]=y.length,y=y.concat(e)}),y.names=v,a(y)}}console.log("loading",t,r);var f=t.url,p=f;if(o[p])return void l.apply(o[p],[]);f=n.resolve(f,s.prj||s.baseDir);var h=$("<img>");h.load(function(){o[p]=this,l.apply(this,[])}),h.attr("src",f)})},a.load=a,a.parse1=function(t,n,r){var a,o,s;if((a=t.pwidth)&&(o=t.pheight)){for(var u=0,c=0,l=n.width,f=n.height,p=[];;)if(p.push({image:this,x:u,y:c,width:a,height:o}),u+=a,u+a>l&&(u=0,c+=o,c+o>f))break;s=p}else{var h=new e(n,r);s=h.parse()}return s.name=t.name,i.is(s,Array)},window.ImageList=a,a}),a.setName("PicoAudio"),!function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,t),r.l=!0,r.exports}var n={};t.m=e,t.c=n,t.d=function(e,n,i){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:i})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(t.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)t.d(i,r,function(t){return e[t]}.bind(null,r));return i},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t){return!t||"object"!==r(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function s(e){var t="function"==typeof Map?new Map:void 0;return(s=function(e){function n(){return u(e,arguments,l(this).constructor)}if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)})(e)}function u(){return(u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&c(r,n.prototype),r}).apply(null,arguments)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n,i,r){var a=this,o=this.settings,s=this.context,u=this.states.startTime,c=i?0:e.channel||0,l=e.velocity*Number(i?1:null!=this.channels[c][2]?this.channels[c][2]:1)*o.generateVolume,f=!0;if(0>=l)return{isGainValueZero:!0};var p=l*((e.expression?e.expression[0].value:100)/127),h=s.createGain();if(h.gain.value=p,n?e.expression&&e.expression.forEach(function(e){var t=l*(e.value/127);t>0&&(f=!1),h.gain.setValueAtTime(t,e.time+u)}):p>0&&(f=!1),f)return{isGainValueZero:!0};var d=e.startTime+u,g=e.stopTime+u,y=o.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),v=t?s.createBufferSource():s.createOscillator(),T=s.createStereoPanner?s.createStereoPanner():s.createPanner?s.createPanner():{pan:{setValueAtTime:function(){}}},b=s.createGain(),A=s.createGain();t?(v.loop=!0,v.buffer=this.whitenoise):(v.type=e.type||"sine",v.detune.value=0,v.frequency.value=y,e.pitchBend&&e.pitchBend.forEach(function(t){v.frequency.setValueAtTime(o.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),t.time+u)}));var S,w,P=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;if(function(e,t,n){if(e.createStereoPanner)n>1&&(n=1),t.pan.value=n;else if(e.createPanner){var i=m(n);t.panningModel="equalpower",t.setPosition(i.x,i.y,i.z)}}(s,T,P),s.createStereoPanner||s.createPanner){var M=!0;s.createStereoPanner?e.pan&&e.pan.forEach(function(e){if(M)M=!1;else{var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1),T.pan.setValueAtTime(t,e.time+u)}}):s.createPanner&&(T.positionX?e.pan&&e.pan.forEach(function(e){if(firstPan)firstPan=!1;else{var t=m(64==e.value?0:e.value/127*2-1);T.positionX.setValueAtTime(t.x,e.time+u),T.positionY.setValueAtTime(t.y,e.time+u),T.positionZ.setValueAtTime(t.z,e.time+u)}}):e.pan&&e.pan.forEach(function(e){if(M)M=!1;else{var t=setTimeout(function(){a.clearFunc("pan",t);var n=64==e.value?0:e.value/127*2-1;n>1&&(n=1);var i=m(n);T.setPosition(i.x,i.y,i.z)},1e3*(e.time+u-s.currentTime));a.pushFunc({pan:t,stopFunc:function(){clearTimeout(t)}})}})),v.connect(T),T.connect(h)}else v.connect(h);
if(h.connect(b),b.connect(A),A.connect(this.masterGainNode),this.masterGainNode.connect(s.destination),!t&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){S=s.createOscillator(),w=s.createGain();var B=!0;e.modulation&&e.modulation.forEach(function(e){if(B)B=!1;else{var t=e.value/127;t>1&&(t=1),w.gain.setValueAtTime(10*y/440*t,e.time+u)}});var D=e.modulation?e.modulation[0].value/127:0;D>1&&(D=1),w.gain.value=10*y/440*D,S.frequency.value=6,S.connect(w),w.connect(v.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var x=this.convolver,E=s.createGain(),k=!0;e.reverb&&e.reverb.forEach(function(e){if(k)k=!1;else{var t=e.value/127;t>1&&(t=1),E.gain.setValueAtTime(t,e.time+u)}});var R=e.reverb?e.reverb[0].value/127:0;R>1&&(R=1),E.gain.value=R,b.connect(A),A.connect(E),E.connect(x)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var V=this.chorusDelayNode,C=s.createGain(),I=!0;e.chorus&&e.chorus.forEach(function(e){if(I)I=!1;else{var t=e.value/127;t>1&&(t=1),C.gain.setValueAtTime(t,e.time+u)}});var L=e.chorus?e.chorus[0].value/127:0;L>1&&(L=1),C.gain.value=L,b.connect(A),A.connect(C),C.connect(V)}return S&&(S.start(d),this.stopAudioNode(S,g,w)),v.start(d),t||i||r||this.stopAudioNode(v,g,A),{start:d,stop:g,pitch:y,channel:c,velocity:l,oscillator:v,panNode:T,gainNode:b,stopGainNode:A,isGainValueZero:!1}}function m(e){e>1&&(e=1);var t={},n=90*e;return t.x=Math.sin(n*(Math.PI/180)),t.y=0,t.z=-Math.cos(n*(Math.PI/180)),t}function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function g(e){return(g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e){if(this.debug){console.log(e);var t=performance.now()}var n=new Uint8Array(e);if(77!=n[0]||84!=n[1]||104!=n[2]||100!=n[3])return"Not Sandard MIDI File.";var i={};if(i.smf=n,function(e){var t=e.smf,n=4,i={};i.size=A.getInt(t,4,8),i.format=t[9],i.trackcount=A.getInt(t,10,12),i.timemanage=t[12],i.resolution=A.getInt(t,12,14),n+=4+i.size;for(var r=[],a=this.settings.isWebMIDI?17:16,o=0;a>o;o++){var s={};r.push(s),s.indices=new Int32Array(Math.floor(t.length/8)),s.indicesLength=0,s.indicesHead=-1,s.indicesFoot=0,s.indicesCur=0,s.indicesPre=0,s.notes=[]}return e.p=n,e.header=i,e.channels=r,e}.call(this,i),this.debug)var r=performance.now();if(function(e){for(var t=e.smf,n=e.p,i=e.header,r=e.channels,a=[],o=[],s=0;s<i.trackcount;s++){if(77!=t[n]||84!=t[n+1]||114!=t[n+2]||107!=t[n+3])return"Irregular SMF.";var u=(n+=4)+4+A.getInt(t,n,n+4);n+=4;for(var c=0,l=120,f=0,p=0,h=1,m=void 0;u>n;){if(null!=h){var d=A.variableLengthToInt(t,n,n+5);c+=m=d[0],n+=d[1]}var g=n;switch(t[n]>>4){case 8:case 9:case 10:case 11:case 14:var y=r[15&(h=t[n])];A.chIndicesInsert(this,y,c,n,3),n+=3;break;case 12:case 13:var v=r[15&(h=t[n])];A.chIndicesInsert(this,v,c,n,2),n+=2;break;case 15:switch(t[n]){case 240:case 247:var T=A.variableLengthToInt(t,n+1,n+1+4);if(T[0]>=7&&127==t[n+2]&&127==t[n+3]&&4==t[n+4]&&1==t[n+5])for(var b=0;16>b;b++){var S=r[b];A.chIndicesInsert(this,S,c,n,T[0])}n+=1+T[1]+T[0];break;case 241:n+=2;break;case 242:n+=3;break;case 243:n+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:n+=1;break;case 255:switch(t[n+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:c+=(this.settings.isSkipEnding?0:i.resolution)-m;break;case 81:for(var w=0;16>w;w++){var P=r[w];A.chIndicesInsert(this,P,c,n,6)}p+=60/l/i.resolution*(c-f),f=c,l=6e7/(65536*t[n+3]+256*t[n+4]+t[n+5]),a.push({timing:c,time:p,value:l});break;case 84:break;case 88:o.push({timing:c,value:[t[n+3],Math.pow(2,t[n+4])]})}var M=A.variableLengthToInt(t,n+2,n+2+4);n+=2+M[1]+M[0]}break;default:if(null==h)return"Irregular SMF. ("+n+" byte addr)";t[--n]=h,h=null}this.settings.isWebMIDI&&null!=h&&A.chIndicesInsert(this,r[16],c,g,n-g)}for(var B=0;B<r.length;B++)r[B].indicesCur=r[B].indicesHead,r[B].indicesPre=r[B].indicesHead}return e.p=n,e.tempoTrack=a,e.beatTrack=o,e}.call(this,i),this.debug)var a=performance.now();(function(e){for(var t,n,i,r=this,a=e.smf,o=e.header,s=e.channels,u=e.tempoTrack,c=0,l=-1,f=-1,p=Number.MAX_SAFE_INTEGER,h=Number.MAX_SAFE_INTEGER,m=0,d=0,y=function(e){var u=s[e],c=2,y=0,v=64,T=127,A=100,S=0,w=0,P=r.isTonyu2?0:10,M=0,B=127,D=127,x=0,E=127;t=120,n=0,i=0;for(var k=[],R=u.indicesHead,V=u.indices,C=new Array(128),I=function(){var s=V[R],g=V[R+2],I=V[R+3],L=60/t/o.resolution*(s-n)+i,O=a[g]>>4;switch(O){case 8:case 9:if(9==O&&0!=a[g+2]){var N={start:s,stop:null,startTime:L,stopTime:null,pitch:a[g+1],pitchBend:[{timing:s,time:L,value:y}],pan:[{timing:s,time:L,value:v}],expression:[{timing:s,time:L,value:T*(E/127)}],velocity:a[g+2]/127*(A/127),modulation:[{timing:s,time:L,value:S}],holdBeforeStop:null,reverb:[{timing:s,time:L,value:P}],chorus:[{timing:s,time:L,value:M}],instrument:x,channel:e,nextSameNoteOnInterval:-1,drumStopTime:2},F=C[a[g+1]];F&&(F.nextSameNoteOnInterval=L-F.startTime),C[a[g+1]]=N,k.some(function(e,t){var n=u.notes[e];n.pitch==a[g+1]&&null==n.stop&&(n.stop=s,n.stopTime=L,b.delete(k,t))}),k.push(u.notes.length),u.notes.push(N),p>s&&(p=s,h=L)}else k.some(function(e,t){var n=u.notes[e];return n.pitch==a[g+1]&&null==n.stop?(w>=r.settings.holdOnValue?null==n.holdBeforeStop&&(n.holdBeforeStop=[{timing:s,time:L,value:w}]):(n.stop=s,n.stopTime=L,b.delete(k,t)),s>m&&(m=s,d=L),!0):void 0});break;case 10:break;case 11:switch(a[g+1]){case 1:S=a[g+2],k.forEach(function(e){u.notes[e].modulation.push({timing:s,time:L,value:S})});break;case 6:0==B&&0==D&&(c=a[g+2])>24&&(c=24);break;case 7:A=a[g+2];break;case 10:v=a[g+2],k.forEach(function(e){u.notes[e].pan.push({timing:s,time:L,value:v})});break;case 11:T=a[g+2],k.forEach(function(e){u.notes[e].expression.push({timing:s,time:L,value:T*(E/127)})});break;case 64:if((w=a[g+2])<r.settings.holdOnValue)for(var Z=k.length-1;Z>=0;Z--){var G=k[Z],j=u.notes[G];null==j.stop&&null!=j.holdBeforeStop&&(j.stop=s,j.stopTime=L,b.delete(k,Z))}break;case 91:P=a[g+2],k.forEach(function(e){u.notes[e].reverb.push({timing:s,time:L,value:P})});break;case 93:M=a[g+2],k.forEach(function(e){u.notes[e].chorus.push({timing:s,time:L,value:M})});break;case 98:case 99:a[g+2];break;case 100:B=a[g+2];break;case 101:D=a[g+2];break;case 111:-1==l&&(l=s,f=L)}break;case 12:x=a[g+1];break;case 13:break;case 14:y=(128*a[g+2]+a[g+1]-8192)/8192*c,k.forEach(function(e){u.notes[e].pitchBend.push({timing:s,time:L,value:y})});break;case 15:switch(a[g]){case 240:case 247:if(127==a[g+1]&&127==a[g+2]&&4==a[g+3]&&1==a[g+4]){var W=a[g+6];W>127&&(W=127),E=W,k.forEach(function(e){u.notes[e].expression.push({timing:s,time:L,value:T*(E/127)})})}break;case 255:switch(a[g+1]){case 81:i+=60/t/o.resolution*(s-n),n=s,t=6e7/(65536*a[g+3]+256*a[g+4]+a[g+5])}}break;default:return{v:{v:"Error parseSMF. "}}}R=I};-1!=R;){var L=I();if("object"===g(L))return L.v}u.nowNoteOnIdxAry=k,r.debug||delete u.indices},v=0;16>v;v++){var T=y(v);if("object"===g(T))return T.v}for(v=0;16>v;v++){for(var A=s[v],S=A.nowNoteOnIdxAry,w=function(e){var t=A.notes[S[e]];null==t.stop&&(t.stop=m,t.stopTime=d,["pitchBend","pan","expression","modulation","reverb","chorus"].forEach(function(e){for(var n=t[e],i=n.length-1;i>=1;i--)n[i].timing>m&&b.delete(n,i)}),b.delete(S,e))},P=S.length-1;P>=0;P--)w(P);delete A.nowNoteOnIdxAry}this.settings.isSkipEnding&&(c=m),u.push({timing:c,time:60/t/o.resolution*(c-n)+i,value:120});var M=[];if(this.settings.isWebMIDI)for(var B=s[16],D=120,x=0,E=0,k=B.indicesHead,R=B.indices;-1!=k;){var V=R[k],C=R[k+1],I=R[k+2],L=R[k+3],O=60/D/o.resolution*(V-x)+E;switch(a[I]){case 255:switch(a[I+1]){case 81:E+=60/D/o.resolution*(V-x),x=V,D=6e7/(65536*a[I+3]+256*a[I+4]+a[I+5])}}M.push({time:O,tick:V,smfPtr:I,smfPtrLen:C}),k=L}return e.songLength=c,e.cc111Tick=l,e.cc111Time=f,e.firstNoteOnTiming=p,e.firstNoteOnTime=h,e.lastNoteOffTiming=m,e.lastNoteOffTime=d,this.settings.isWebMIDI&&(e.messages=M,e.smfData=new Uint8Array(a)),e}).call(this,i);var o={};if(o.header=i.header,o.tempoTrack=i.tempoTrack,o.beatTrack=i.beatTrack,o.channels=i.channels,o.songLength=i.songLength,o.cc111Tick=i.cc111Tick,o.cc111Time=i.cc111Time,o.firstNoteOnTiming=i.firstNoteOnTiming,o.firstNoteOnTime=i.firstNoteOnTime,o.lastNoteOffTiming=i.lastNoteOffTiming,o.lastNoteOffTime=i.lastNoteOffTime,this.settings.isWebMIDI&&(o.messages=i.messages,o.smfData=new Uint8Array(n)),this.debug){var s=performance.now();console.log("parseSMF time",s-t),console.log("parseSMF(0/2) time",r-t),console.log("parseSMF(1/2) time",a-r),console.log("parseSMF(2/2) time",s-a),console.log(o)}return o}function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.r(t);var T=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r;return t=e,r=[{key:"resetSeed",value:function(){this.init=!0,this.x=123456789,this.y=362436069,this.z=521288629,this.w=8867512}},{key:"random",value:function(){this.init||this.resetSeed();var e=this.x^this.x<<11;this.x=this.y,this.y=this.z,this.z=this.w;var t=this.w=this.w^this.w>>>19^e^e>>>8;return t=Math.abs(t)/2147483648%2}}],(n=null)&&i(t.prototype,n),r&&i(t,r),e}(),b=function(){function e(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,l(e).apply(this,arguments))}var t,n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(e,s(Array)),t=e,i=[{key:"delete",value:function(e,t){t==e.length-1?e.pop():0==t?e.shift():e.splice(t,1)}}],(n=null)&&a(t.prototype,n),i&&a(t,i),e}(),A=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,i=[{key:"getInt",value:function(e,t,n){for(var i=0,r=t;n>r;r++)i=(i<<8)+e[r];return i}},{key:"variableLengthToInt",value:function(e,t,n){for(var i=t,r=0;n-1>i&&e[i]>=128;)t+4>i&&(r=(r<<7)+(e[i]-128)),i++;return[r=(r<<7)+e[i],++i-t]}},{key:"chIndicesInsert",value:function(e,t,n,i,r){var a=t.indices;if(a.length<=t.indicesLength+4){if(e.debug)var o=performance.now();for(var s=new Int32Array(Math.floor(2*a.length)),u=a.length-1;u>=0;u--)s[u]=a[u];t.indices=a=s,e.debug&&console.log("malloc",performance.now()-o,s.length)}if(t.indicesLength>=4&&n<a[t.indicesFoot])for(;-1!=t.indicesCur;){if(n<a[t.indicesCur]){t.indicesCur==t.indicesHead?t.indicesHead=t.indicesLength:a[t.indicesPre+3]=t.indicesLength,a[t.indicesLength]=n,a[t.indicesLength+1]=r,a[t.indicesLength+2]=i,a[t.indicesLength+3]=t.indicesCur,t.indicesPre=t.indicesLength,t.indicesLength+=4;break}t.indicesPre=t.indicesCur,t.indicesCur=a[t.indicesCur+3]}else t.indicesLength>=4?a[t.indicesFoot+3]=t.indicesLength:t.indicesHead=0,t.indicesFoot=t.indicesLength,a[t.indicesLength]=n,a[t.indicesLength+1]=r,a[t.indicesLength+2]=i,a[t.indicesLength+3]=-1,t.indicesLength+=4}}],(n=null)&&f(t.prototype,n),i&&f(t,i),e}(),S=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,i=[{key:"init",value:function(e){this.updatePreTime=performance.now(),this.pPreTime=performance.now(),this.cPreTime=1e3*e.context.currentTime,this.pTimeSum=0,this.cTimeSum=0,this.cnt=0}},{key:"update",value:function(e){var t=e.context,n=e.settings,i=e.states,r=performance.now(),a=this.updatePreTime,o=this.pPreTime,s=this.cPreTime,u=this.pTimeSum,c=this.cTimeSum,l=this.cnt,f=r-a,p=r,h=1e3*t.currentTime;u+=p-o,c+=h-s,o=p,s=h;var m=u-c;if(i.latencyTime=m,m>=100?(i.latencyLimitTime+=m,c+=100):-100>=m?c=u:i.latencyLimitTime>0&&(i.latencyLimitTime-=.04*f,i.latencyLimitTime<0&&(i.latencyLimitTime=0)),i.updateIntervalTime=f,i.updateBufTime<f?i.updateBufTime=f:(i.updateBufTime>50&&(i.updateBufTime-=.001*i.updateBufTime),i.updateBufTime>100&&(i.updateBufTime-=.01*i.updateBufTime),i.updateBufMaxTime>150&&(i.updateBufMaxTime-=.002*i.updateBufMaxTime),i.updateBufTime<50&&(i.updateBufTime+=.002*i.updateBufTime),i.updateBufMaxTime>=10&&i.updateBufMaxTime<140&&(i.updateBufMaxTime+=.003*i.updateBufMaxTime)),i.updateBufTime>i.updateBufMaxTime){if(f>=900&&i.latencyLimitTime<=150)i.updateBufMaxTime+=f;else{var d=f-i.updateBufMaxTime;i.updateBufTime=i.updateBufMaxTime,i.updateBufMaxTime<10?(i.updateBufTime=i.updateBufMaxTime,i.updateBufMaxTime*=1.25):i.updateBufMaxTime+=d/2}i.updateBufMaxTime>1100&&(i.updateBufMaxTime=1100)}i.latencyLimitTime>200&&(c=u,i.latencyLimitTime-=5,i.latencyLimitTime>1e3&&(i.latencyLimitTime=1e3),i.updateBufMaxTime=1,i.updateBufTime=1,f=1);for(var g=0;16>g;g++){var y=e.playData.channels[g].notes,v=i.playIndices[g],T=function(){var r=y[v],a=t.currentTime-i.startTime;if(a>=r.stopTime)return"continue";if(0==l&&a>r.startTime+.05)return"continue";if(a+r.startTime<0)return"continue";if(a<r.startTime-i.updateBufTime/1e3)return"break";if(!n.isWebMIDI){if(i.stopFuncs.length>=350&&i.updateBufTime<1e3&&(i.updateBufTime=12,i.updateBufMaxTime=i.updateBufTime),-1!=n.maxPoly||-1!=n.maxPercPoly){var o=0,s=0;if(i.stopFuncs.forEach(function(e){e.note&&(9!=e.note.channel?r.start>=e.note.start&&r.start<e.note.stop&&o++:r.start==e.note.start&&s++)}),9!=r.channel&&o>=n.maxPoly||9==r.channel&&s>=n.maxPercPoly)return"continue"}var u=9!=r.channel?e.createNote(r):e.createPercussionNote(r);if(!u)return"continue";e.pushFunc({note:r,stopFunc:u})}i.noteOnAry.push(r)};e:for(;v<y.length;v++)switch(T()){case"continue":continue;case"break":break e}i.playIndices[g]=v}if(this.checkNoteOn(e),this.checkNoteOff(e),n.isWebMIDI&&null!=n.WebMIDIPortOutput){for(var b=e.playData.messages,S=e.playData.smfData,w=i.playIndices[16];w<b.length;w++){var P=b[w],M=t.currentTime-i.startTime;if(!(M>P.time+1)){if(M<P.time-1)break;var B=P.smfPtrLen,D=P.smfPtr,x=P.time,E=S[D];if(255!=E)try{if(240==E||247==E){if(n.WebMIDIPortSysEx){var k=A.variableLengthToInt(S,D+1,D+1+4),R=D+1+k[1],V=R+k[0],C=new Uint8Array(1+k[0]);C[0]=E;for(var I=V-R,L=0;I>L;L++)C[L+1]=S[R+L];n.WebMIDIPortOutput.send(C,1e3*(x-t.currentTime+window.performance.now()/1e3+i.startTime))}}else{for(var O=[],N=0;B>N;N++)O.push(S[D+N]);n.WebMIDIPortOutput.send(O,1e3*(x-t.currentTime+window.performance.now()/1e3+i.startTime))}}catch(e){console.log(e,D,B,x,E)}}}i.playIndices[16]=w}this.updatePreTime=r,this.pPreTime=o,this.cPreTime=s,this.pTimeSum=u,this.cTimeSum=c,this.cnt=l}},{key:"checkNoteOn",value:function(e){for(var t=e.context,n=e.trigger,i=e.states,r=e.states.noteOnAry,a=e.states.noteOffAry,o=0;o<r.length;o++){var s=r[o],u=t.currentTime-i.startTime;s.startTime-u<=0&&(b.delete(r,o),a.push(s),n.isNoteTrigger&&n.noteOn(s),o--)}}},{key:"checkNoteOff",value:function(e){for(var t=e.context,n=e.trigger,i=e.states,r=e.states.noteOffAry,a=0;a<r.length;a++){var o=r[a],s=t.currentTime-i.startTime;(9!=o.channel&&o.stopTime-s<=0||9==o.channel&&o.drumStopTime-s<=0)&&(b.delete(r,a),e.clearFunc("note",o),n.isNoteTrigger&&n.noteOff(o),a--)}}}],(n=null)&&p(t.prototype,n),i&&p(t,i),e}(),w=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,i;return t=e,i=[{key:"measureReverb",value:function(){for(var e=performance.now(),t=0;5e5>t&&!(performance.now()-e>=500);t++);return this.debug&&console.log("measureReverb",t,performance.now()-e),!(5e5>t)}}],(n=null)&&d(t.prototype,n),i&&d(t,i),e}(),P=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),function(e,t){this.debug=!1,this.isStarted=!1,this.isPlayed=!1,this.isTonyu2=!0,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!0,reverbVolume:1.5,isChorus:!0,chorusVolume:.5,isCC111:!0,loop:!1,isSkipBeginning:this.isTonyu2,isSkipEnding:!0,holdOnValue:64,maxPoly:-1,maxPercPoly:-1,isOfflineRendering:!1,isSameDrumSoundOverlap:!1},this.events=[],this.trigger={isNoteTrigger:!0,play:function(){},stop:function(){},noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:50,updateBufMaxTime:150,updateIntervalTime:0,latencyLimitTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.playData=null,this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1,this.onSongEndListener=null;for(var n=0;17>n;n++)this.channels.push([0,0,1]);e&&this.init(e,t),"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return Date.now()}),Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991)}.call(this,t,n)}var t,n,i;return t=e,(n=[{key:"init",value:function(e,t){return function(e,t){if(!this.isStarted){this.isStarted=!0;var n=window.AudioContext||window.webkitAudioContext;if(this.context=e||new n,this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,t&&t.whitenoise)this.whitenoise=t.whitenoise;else{this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate),T.resetSeed();for(var i=0;2>i;i++)for(var r=0;r<this.context.sampleRate;r++){var a=T.random();this.whitenoise.getChannelData(i)[r]=2*a-1}}if(t&&t.impulseResponse)this.impulseResponse=t.impulseResponse;else{var o=3.5*this.context.sampleRate;this.impulseResponse=this.context.createBuffer(2,o,this.context.sampleRate),T.resetSeed();for(var s=0;2>s;s++)for(var u=this.impulseResponse.getChannelData(s),c=0;o>c;c++){var l=(o-c)/o,f=c/this.context.sampleRate,p=(.03>f?0:l)*(f>=.03&&.031>f?2*l:l)*(f>=.04&&.042>f?1.5*l:l)*(f>=.05&&.054>f?1.25*l:l)*T.random()*.2*Math.pow(l-.03,4);u[c]=p}}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!0,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0),this.isTonyu2&&(this.settings.isReverb=t?t.settings.isReverb:this.measurePerformanceReverb())}}.call(this,e,t)}},{key:"parseSMF",value:function(e){return y.call(this,e)}},{key:"setData",value:function(e){return function(e){if(this.debug)var t=performance.now();if(this.states.isPlaying&&this.stop(),this.playData=e,this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming,this.firstNoteOnTime=e.firstNoteOnTime,this.lastNoteOffTime=e.lastNoteOffTime,this.initStatus(),this.debug){var n=performance.now();console.log("setData time",n-t)}return this}.call(this,e)}},{key:"play",value:function(e){return function(e){var t=this,n=this.context,i=this.settings,r=this.trigger,a=this.states;if(!a.isPlaying){if(i.isWebMIDI&&!e){if("completed"!=a.webMIDIWaitState){if("waiting"!=a.webMIDIWaitState){a.webMIDIWaitState="waiting";var o=1e3-1e3*(n.currentTime-a.webMIDIStopTime);0==a.webMIDIStopTime&&(o=1e3),setTimeout(function(){a.webMIDIWaitState="completed",a.isPlaying=!1,t.play()},o)}return}a.webMIDIWaitState=null}var s,u=n.currentTime;if(this.isPlayed=!0,a.isPlaying=!0,a.startTime=a.startTime||a.stopTime?a.startTime+u-a.stopTime:u,a.stopFuncs=[],i.isSkipBeginning){var c=this.firstNoteOnTime;-a.startTime+u<c&&this.setStartTime(c+a.startTime-u)}var l=1e3*((i.isCC111&&-1!=this.cc111Time?this.lastNoteOffTime:this.getTime(Number.MAX_SAFE_INTEGER))-n.currentTime+a.startTime);s=setTimeout(function p(){t.clearFunc("rootTimeout",s),(i.isCC111&&-1!=t.cc111Time?t.lastNoteOffTime:t.getTime(Number.MAX_SAFE_INTEGER))-n.currentTime+a.startTime<=0?(r.songEnd(),t.onSongEnd(),t.fireEvent("songEnd")):(s=setTimeout(p,1),t.pushFunc({rootTimeout:s,stopFunc:function(){clearTimeout(s)}}))},l),this.pushFunc({rootTimeout:s,stopFunc:function(){clearTimeout(s)}}),r.play(),this.fireEvent("play"),S.init(this);var f=setInterval(function(){S.update(t)},1);this.pushFunc({rootTimeout:f,stopFunc:function(){clearInterval(f)}})}}.call(this,e)}},{key:"stop",value:function(e){return function(e){var t=this,n=this.states;if(0!=n.isPlaying){if(n.isPlaying=!1,n.stopTime=this.context.currentTime,n.stopFuncs.forEach(function(e){e.stopFunc()}),n.stopFuncs=[],n.playIndices.forEach(function(e,t,n){n[t]=0}),n.noteOnAry=[],n.noteOffAry=[],this.settings.isWebMIDI){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;n.webMIDIStopTime=this.context.currentTime,setTimeout(function(){for(var e=0;16>e;e++)t.settings.WebMIDIPortOutput.send([176+e,120,0])},1e3)}this.trigger.stop(),this.fireEvent("stop")}}.call(this,e)}},{key:"initStatus",value:function(e,t){return function(e,t){if((!this.settings.isWebMIDI||null==this.states.webMIDIWaitState)&&(this.stop(e),this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:this.states.webMIDIStopTime,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:this.states.updateBufTime,updateBufMaxTime:this.states.updateBufMaxTime,updateIntervalTime:this.states.updateIntervalTime,latencyLimitTime:this.states.latencyLimitTime,noteOnAry:[],noteOffAry:[]},this.settings.isWebMIDI&&!t)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var n=0;16>n;n++)this.settings.WebMIDIPortOutput.send([192+n,0]),this.settings.WebMIDIPortOutput.send([224+n,0,64]),this.settings.WebMIDIPortOutput.send([176+n,100,0]),this.settings.WebMIDIPortOutput.send([176+n,101,0]),this.settings.WebMIDIPortOutput.send([176+n,6,2]),this.settings.WebMIDIPortOutput.send([176+n,100,1]),this.settings.WebMIDIPortOutput.send([176+n,96,0]),this.settings.WebMIDIPortOutput.send([176+n,97,64]),this.settings.WebMIDIPortOutput.send([176+n,7,100]),this.settings.WebMIDIPortOutput.send([176+n,10,64]),this.settings.WebMIDIPortOutput.send([176+n,11,127]),this.settings.WebMIDIPortOutput.send([176+n,98,0]),this.settings.WebMIDIPortOutput.send([176+n,99,0]),this.settings.WebMIDIPortOutput.send([176+n,122,0])}}.call(this,e,t)}},{key:"getTime",value:function(e){return function(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].timing)return this.tempoTrack[this.tempoTrack.length-1].time;for(var n=0,i=this.tempoTrack.length-1;;){t=Math.floor(n+(i-n)/2);var r=this.tempoTrack[t].timing;if(r>e)i=t-1;else{if(!(e>r))break;n=t+1}if(n>i){r>e&&t--;break}}}var a=0,o=0,s=120;if(t>=0){var u=this.tempoTrack[t];a=u.time,o=u.timing,s=u.value}return a+=60/s/this.settings.resolution*(e-o)}.call(this,e)}},{key:"getTiming",value:function(e){return function(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].time)return this.tempoTrack[this.tempoTrack.length-1].timing;for(var n=0,i=this.tempoTrack.length-1;;){t=Math.floor(n+(i-n)/2);var r=this.tempoTrack[t].time;if(r>e)i=t-1;else{if(!(e>r))break;n=t+1}if(n>i){r>e&&t--;break}}}var a=0,o=0,s=120;if(t>=0){var u=this.tempoTrack[t];a=u.time,o=u.timing,s=u.value}return o+=(e-a)/(60/s/this.settings.resolution)}.call(this,e)}},{key:"createBaseNote",value:function(e,t,n,i,r){return h.call(this,e,t,n,i,r)}},{key:"createNote",value:function(e){return function(e){var t=this,n=this.createBaseNote(e,!1,!0,!1,!0);if(n.isGainValueZero)return null;var i,r=n.oscillator,a=n.gainNode,o=n.stopGainNode,s=!1,u=!1;switch(1e3*this.channels[n.channel][0]||e.instrument){case 1e3:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:r.type="sine",a.gain.value*=1.5;break;case 2e3:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:r.type="square",a.gain.value*=.8;break;case 3e3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:r.type="sawtooth";break;case 4e3:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:r.type="triangle",a.gain.value*=1.5;break;default:r.type="square"}switch(("sine"==r.type||"triangle"==r.type)&&!s&&n.stop-n.start>.01&&(u=!0),this.channels[n.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:s=!0,a.gain.value*=1.1,a.gain.setValueAtTime(a.gain.value,n.start),a.gain.linearRampToValueAtTime(0,n.start+.2),this.stopAudioNode(r,n.start+.2,o);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:a.gain.value*=1.1;var c=(128-e.pitch)/128;a.gain.setValueAtTime(a.gain.value,n.start),a.gain.linearRampToValueAtTime(.85*a.gain.value,n.start+c*c/8),a.gain.linearRampToValueAtTime(.8*a.gain.value,n.start+c*c/4),a.gain.setTargetAtTime(0,n.start+c*c/4,5*c*c),this.stopAudioNode(r,n.stop,o,u);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:a.gain.value*=1.1,a.gain.setValueAtTime(a.gain.value,n.start),a.gain.linearRampToValueAtTime(0,n.start+1+4*n.velocity),this.stopAudioNode(r,n.stop,o,u);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:a.gain.value*=1,a.gain.setValueAtTime(a.gain.value,n.start),a.gain.linearRampToValueAtTime(.95*a.gain.value,n.start+.1),a.gain.setValueAtTime(.95*a.gain.value,n.start+.1),a.gain.linearRampToValueAtTime(0,n.start+2+10*n.velocity),this.stopAudioNode(r,n.stop,o,u);break;case 119:if(a.gain.value=0,this.stopAudioNode(r,n.stop,o,u),(i=this.createBaseNote(e,!0,!0)).isGainValueZero)break;i.oscillator.playbackRate.setValueAtTime((e.pitch+1)/128,n.start),i.gainNode.gain.setValueAtTime(0,n.start),i.gainNode.gain.linearRampToValueAtTime(1.3,n.start+2),this.stopAudioNode(i.oscillator,n.stop,i.stopGainNode);break;default:a.gain.value*=1.1,a.gain.setValueAtTime(a.gain.value,n.start),this.stopAudioNode(r,n.stop,o,u)}return function(){t.stopAudioNode(r,0,o,!0),i&&i.oscillator&&t.stopAudioNode(i.oscillator,0,i.stopGainNode,!0)}}.call(this,e)}},{key:"createPercussionNote",value:function(e){return function(e){var t=this,n=this.createBaseNote(e,!0,!1);if(n.isGainValueZero)return null;var i=n.oscillator,r=n.gainNode,a=n.stopGainNode,o=n.start,s=this.createBaseNote(e,!1,!1,!0),u=s.oscillator,c=s.gainNode,l=s.stopGainNode,f=e.nextSameNoteOnInterval;o<this.context.currentTime&&(o=this.context.currentTime);var p=0,h=0;switch(e.pitch){case 35:case 36:r.gain.value=.6,i.playbackRate.value=.02,p=.07,c.gain.value=1.1,u.frequency.setValueAtTime(120,o),u.frequency.linearRampToValueAtTime(50,o+.07),h=.07;break;case 38:case 40:i.playbackRate.value=.7,p=.05,c.gain.setValueAtTime(.8,o),c.gain.linearRampToValueAtTime(0,o+.05),u.frequency.setValueAtTime(300,o),u.frequency.linearRampToValueAtTime(200,o+.05),h=.05;break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,p=.1,u.type="square",c.gain.setValueAtTime(1,o),c.gain.linearRampToValueAtTime(.01,o+.1),u.frequency.setValueAtTime(150+20*(e.pitch-40),o),u.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),o+.1),h=.1;break;case 42:case 44:i.playbackRate.value=1.5,p=.02,h=0;break;case 46:i.playbackRate.value=1.5,p=.3,r.gain.setValueAtTime(.9,o),r.gain.linearRampToValueAtTime(0,o+.3),h=0;break;case 49:case 51:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,p=.5,r.gain.setValueAtTime(1,o),r.gain.linearRampToValueAtTime(0,o+.5),h=0;break;case 51:i.playbackRate.value=1.1,p=.4,r.gain.setValueAtTime(.8,o),r.gain.linearRampToValueAtTime(0,o+.4),h=0;break;case 59:i.playbackRate.value=1.8,p=.3,r.gain.setValueAtTime(.5,o),r.gain.linearRampToValueAtTime(0,o+.3),h=0;break;case 60:case 61:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(.8,o),c.gain.linearRampToValueAtTime(0,o+.1),u.frequency.setValueAtTime(400-40*(e.pitch-60),o),u.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),o+.1),h=.1;break;case 62:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(1,o),c.gain.linearRampToValueAtTime(0,o+.03),u.frequency.setValueAtTime(200,o),u.frequency.linearRampToValueAtTime(250,o+.03),h=.03;break;case 63:case 64:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(1,o),c.gain.linearRampToValueAtTime(0,o+.1),u.frequency.setValueAtTime(200-30*(e.pitch-63),o),u.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),o+.1),h=.1;break;case 56:case 75:i.playbackRate.value=.01,p=.1,c.gain.setValueAtTime(1,o),c.gain.linearRampToValueAtTime(0,o+.1),u.frequency.setValueAtTime(1e3+48*(e.pitch-56),o),h=.1;break;case 80:i.playbackRate.value=5,r.gain.setValueAtTime(.5,o),r.gain.linearRampToValueAtTime(0,o+.2),p=.05,u.type="triangle",c.gain.setValueAtTime(.7,o),c.gain.linearRampToValueAtTime(0,o+.2),u.frequency.setValueAtTime(6e3,o),h=.05;break;case 81:i.playbackRate.value=5,r.gain.setValueAtTime(.9,o),r.gain.linearRampToValueAtTime(0,o+.5),p=.5,u.type="triangle",c.gain.setValueAtTime(.8,o),c.gain.linearRampToValueAtTime(0,o+.3),u.frequency.setValueAtTime(6e3,o),h=.3;break;case 35:case 36:i.playbackRate.value=.25,r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.7,o+.004),r.gain.linearRampToValueAtTime(0,o+.008),p=.008,u.frequency.setValueAtTime(35==e.pitch?90:160,o),u.frequency.linearRampToValueAtTime(40,o+.08),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(3,o+.02),c.gain.linearRampToValueAtTime(0,o+.08),h=.08;break;case 37:i.playbackRate.value=.26,r.gain.setValueAtTime(1.5,o),r.gain.linearRampToValueAtTime(0,o+.041),p=.041,u.frequency.setValueAtTime(330,o),u.frequency.linearRampToValueAtTime(120,o+.02),c.gain.setValueAtTime(1,o),c.gain.linearRampToValueAtTime(0,o+.02),h=.02;break;case 38:case 40:var m=38==e.pitch?.25:.2;i.playbackRate.value=.7,r.gain.setValueAtTime(1,o),r.gain.linearRampToValueAtTime(0,o+m),p=m,u.frequency.setValueAtTime(38==e.pitch?140:200,o),u.frequency.linearRampToValueAtTime(38==e.pitch?100:160,o+.1),c.gain.setValueAtTime(2,o),c.gain.linearRampToValueAtTime(0,o+.1),h=.1;break;case 39:i.playbackRate.value=.5,r.gain.setValueAtTime(1.3,o),r.gain.linearRampToValueAtTime(0,o+.01),r.gain.setValueAtTime(1.3,o+.0101),r.gain.linearRampToValueAtTime(0,o+.02),r.gain.setValueAtTime(1.3,o+.0201),r.gain.linearRampToValueAtTime(0,o+.09),p=.09,u.type="triangle",u.frequency.setValueAtTime(180,o),c.gain.setValueAtTime(.8,o),c.gain.linearRampToValueAtTime(0,o+.01),c.gain.setValueAtTime(.8,o+.0101),c.gain.linearRampToValueAtTime(0,o+.02),c.gain.setValueAtTime(.8,o+.0201),c.gain.linearRampToValueAtTime(0,o+.03),h=.11;
break;case 41:case 43:case 45:case 47:case 48:case 50:var d=e.pitch-41+(e.pitch>=48?1:0);i.playbackRate.value=.3+d/45,r.gain.setValueAtTime(1.5,o),r.gain.linearRampToValueAtTime(0,o+.02),p=.02,u.frequency.setValueAtTime(90+15*d,o),u.frequency.linearRampToValueAtTime(30+7.5*d,o+.5-d/35),c.gain.setValueAtTime(1.5,o),c.gain.linearRampToValueAtTime(0,o+.5-d/35),h=.5-d/35;break;case 42:case 44:i.playbackRate.value=1,42==e.pitch?r.gain.setValueAtTime(.8,o):(r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.8,o+.014)),r.gain.linearRampToValueAtTime(0,o+.08),p=.08,c.gain.value=0,h=0;break;case 46:i.playbackRate.setValueAtTime(.35,o),i.playbackRate.linearRampToValueAtTime(.6,o+.1),i.playbackRate.linearRampToValueAtTime(1,o+.3),r.gain.setValueAtTime(1.1,o),r.gain.setTargetAtTime(0,o,.3),p=1.5,c.gain.value=0,h=0;break;case 49:case 57:var g=49==e.pitch?.3:.5,y=49==e.pitch?.4:.7;i.playbackRate.setValueAtTime(g,o),i.playbackRate.linearRampToValueAtTime(y,o+.15),i.playbackRate.linearRampToValueAtTime(.9,o+.4),r.gain.setValueAtTime(1.3,o),r.gain.setTargetAtTime(0,o,.35),p=2,c.gain.value=0,h=0;break;case 51:case 59:i.playbackRate.value=1,r.gain.setValueAtTime(.9,o),r.gain.setTargetAtTime(0,o,.35),p=2,u.type="triangle";var v=51==e.pitch?372:400;u.frequency.setValueAtTime(v,o),c.gain.setValueAtTime(.4,o),c.gain.setTargetAtTime(0,o,.35),h=2;break;case 52:i.playbackRate.setValueAtTime(.17,o),i.playbackRate.linearRampToValueAtTime(.25,o+.1),i.playbackRate.linearRampToValueAtTime(.5,o+.6),r.gain.setValueAtTime(1.3,o),r.gain.setTargetAtTime(0,o,.35),p=2,u.type="triangle",u.frequency.setValueAtTime(382,o),c.gain.setValueAtTime(.2,o),c.gain.setTargetAtTime(0,o,.35),h=2;break;case 53:i.playbackRate.setValueAtTime(.6,o),r.gain.setValueAtTime(1,o),r.gain.setTargetAtTime(0,o,.3),p=2,u.type="triangle",u.frequency.setValueAtTime(377,o),c.gain.setValueAtTime(.5,o),c.gain.setTargetAtTime(0,o,.35),h=2;break;case 55:i.playbackRate.setValueAtTime(.5,o),i.playbackRate.linearRampToValueAtTime(.8,o+.1),i.playbackRate.linearRampToValueAtTime(1,o+.6),r.gain.setValueAtTime(1.5,o),r.gain.setTargetAtTime(0,o,.3),p=1.75,c.gain.value=0,h=0;break;case 54:case 56:i.playbackRate.setValueAtTime(1,o);var T=54==e.pitch?1:.4,b=54==e.pitch?.01:0;r.gain.setValueAtTime(1*T/2,o),r.gain.linearRampToValueAtTime(1*T,o+b),r.gain.setTargetAtTime(0,o+b,.05),p=.3,u.frequency.setValueAtTime(54==e.pitch?6e3:495,o),T=54==e.pitch?1:2,c.gain.setValueAtTime(1*T/2,o),c.gain.linearRampToValueAtTime(1*T,o+b),c.gain.setTargetAtTime(0,o+b,.05),h=.3;break;case 58:i.playbackRate.setValueAtTime(.6,o),i.playbackRate.linearRampToValueAtTime(1,o+.8),r.gain.setValueAtTime(1.5,o),c.gain.setValueAtTime(.5,o);for(var A=0;40>A;A++)r.gain.linearRampToValueAtTime(.1*(40-A)/40,o+A/40*.8),r.gain.linearRampToValueAtTime(1.5*(40-(A+1))/40,o+(A+.99)/40*.8),c.gain.linearRampToValueAtTime(.025*(40-A)/40,o+A/40*.8),c.gain.linearRampToValueAtTime(.25*(40-(A+1))/40,o+(A+.99)/40*.8);r.gain.linearRampToValueAtTime(0,o+.8),c.gain.linearRampToValueAtTime(0,o+.8),p=.8,u.type="triangle",u.frequency.setValueAtTime(1e3,o),h=.8;break;case 80:i.playbackRate.value=1,r.gain.setValueAtTime(.5,o),r.gain.setTargetAtTime(0,o,.015),p=.2,u.type="triangle",u.frequency.setValueAtTime(6e3,o),c.gain.setValueAtTime(2.5,o),c.gain.setTargetAtTime(0,o,.02),h=.3;break;case 81:i.playbackRate.value=5,r.gain.setValueAtTime(.5,o),r.gain.setTargetAtTime(0,o,.08),p=.75,u.type="triangle",u.frequency.setValueAtTime(6e3,o),c.gain.setValueAtTime(2.5,o),c.gain.setTargetAtTime(0,o,.18),h=1;break;case 60:case 61:case 62:case 63:case 64:var S=e.pitch,w=60==S?700:61==S?282:62==S?385:63==S?295:210,P=60==S?.08:61==S?.1:62==S?.03:63==S?.12:.15;i.playbackRate.value=.03,r.gain.setValueAtTime(1.2,o),p=.03,u.frequency.setValueAtTime(.97*w,o),u.frequency.linearRampToValueAtTime(w,o+P),c.gain.setValueAtTime(1.8,o),c.gain.linearRampToValueAtTime(0,o+P),h=P;break;case 65:case 66:var M=65==e.pitch?.22:.25;i.playbackRate.setValueAtTime(65==e.pitch?.25:.22,o),i.playbackRate.linearRampToValueAtTime(65==e.pitch?.2:.18,o+M),r.gain.setValueAtTime(1.3,o),r.gain.linearRampToValueAtTime(.2,o+M/3.5),r.gain.linearRampToValueAtTime(0,o+M),p=M,u.type="triangle",u.frequency.setValueAtTime(65==e.pitch?203.3:145.52,o),u.frequency.linearRampToValueAtTime(65==e.pitch?190:136,o+.1),c.gain.setValueAtTime(3.2,o),c.gain.setTargetAtTime(0,o,.08),h=1;break;case 67:case 68:i.playbackRate.value=1,r.gain.setValueAtTime(.5,o),r.gain.linearRampToValueAtTime(.1,o+.02),r.gain.linearRampToValueAtTime(0,o+.08),p=.08,u.type="triangle",u.frequency.setValueAtTime(67==e.pitch?1430:1055,o),c.gain.setValueAtTime(2,o),c.gain.setTargetAtTime(0,o,.06),h=.75;break;case 69:i.playbackRate.value=1,r.gain.setValueAtTime(.3,o),r.gain.linearRampToValueAtTime(.8,o+.03),r.gain.linearRampToValueAtTime(0,o+.08),p=.08,c.gain.value=0,h=0;break;case 70:i.playbackRate.value=1,r.gain.setValueAtTime(1.2,o),r.gain.linearRampToValueAtTime(0,o+.06),p=.06,c.gain.value=0,h=0;break;case 71:case 72:r.gain.value=0,p=0;var B=71==e.pitch?.07:.4;u.type="triangle",u.frequency.setValueAtTime(71==e.pitch?2408:2105,o),c.gain.setValueAtTime(0,o);for(var D=0;74*B>D;D++)c.gain.linearRampToValueAtTime(2.5,o+(D+.2)/75),c.gain.linearRampToValueAtTime(.5,o+(D+.9)/75);c.gain.linearRampToValueAtTime(0,o+B),h=B;break;case 73:case 74:var x=73==e.pitch?.05:.35;i.playbackRate.setValueAtTime((e.pitch,.2),o),i.playbackRate.linearRampToValueAtTime(73==e.pitch?.7:.5,o+x),r.gain.value=.2;for(var E=0;100*x>E;E++)r.gain.setValueAtTime(.4,o+E/100),r.gain.setValueAtTime(.9,o+(E+.7)/100);p=x,c.gain.value=0,h=0;break;case 75:r.gain.value=0,p=0,u.frequency.setValueAtTime(2181,o),c.gain.setValueAtTime(0,o),c.gain.setValueAtTime(2,o+.005),c.gain.linearRampToValueAtTime(1,o+.015),c.gain.linearRampToValueAtTime(1.5,o+.025),c.gain.linearRampToValueAtTime(0,o+.08),h=.1;break;case 76:case 77:i.playbackRate.value=.1,r.gain.setValueAtTime(1.2,o),r.gain.linearRampToValueAtTime(0,o+.015),p=.015,u.frequency.setValueAtTime(76==e.pitch?800:600,o),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(3,o+.005),c.gain.setTargetAtTime(0,o+.005,.02),h=.2;break;case 78:case 79:r.gain.value=0,p=0;var k=78==e.pitch?750:270;u.frequency.setValueAtTime(k,o),u.frequency.linearRampToValueAtTime(k,o+.06),78==e.pitch&&u.frequency.linearRampToValueAtTime(.9*k,o+.18),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(1.5,o+.005),c.gain.linearRampToValueAtTime(.5,o+.02),c.gain.linearRampToValueAtTime(3,o+.04),c.gain.linearRampToValueAtTime(2,o+.135),c.gain.linearRampToValueAtTime(0,o+.18),h=.18;break;case 27:i.playbackRate.value=1,r.gain.setValueAtTime(1,o),r.gain.linearRampToValueAtTime(0,o+.002),p=.002,u.frequency.setValueAtTime(1500,o),u.frequency.linearRampToValueAtTime(280,o+.015),u.frequency.linearRampToValueAtTime(0,o+.07),c.gain.setValueAtTime(1.9,o),c.gain.linearRampToValueAtTime(0,o+.07),h=.07;break;case 28:i.playbackRate.value=1,r.gain.setValueAtTime(1.3,o),r.gain.linearRampToValueAtTime(0,o+.01),r.gain.setValueAtTime(1.1,o+.0101),r.gain.linearRampToValueAtTime(0,o+.02),r.gain.setValueAtTime(.9,o+.0201),r.gain.setTargetAtTime(0,o+.0201,.03),p=.2,c.gain.value=0,h=0;break;case 29:case 30:var R=29==e.pitch?.05:.07,V=29==e.pitch?.06:.09,C=29==e.pitch?.07:.11,I=29==e.pitch?.1:.15,L=29==e.pitch?.25:.4,O=29==e.pitch?.1:.06,N=29==e.pitch?.3:.2,F=29==e.pitch?.18:.12;i.playbackRate.setValueAtTime(O,o),i.playbackRate.linearRampToValueAtTime(N,o+R),i.playbackRate.linearRampToValueAtTime(0,o+V),i.playbackRate.linearRampToValueAtTime(N,o+C),i.playbackRate.linearRampToValueAtTime(F,o+I),i.playbackRate.linearRampToValueAtTime(0,o+L),r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(.4,o+R),r.gain.linearRampToValueAtTime(.1,o+C),r.gain.linearRampToValueAtTime(.3,o+I),r.gain.linearRampToValueAtTime(0,o+L),p=L;var Z=29==e.pitch?500:400,G=29==e.pitch?1950:1200,j=29==e.pitch?430:250;u.frequency.setValueAtTime(Z,o),u.frequency.linearRampToValueAtTime(G,o+R),u.frequency.linearRampToValueAtTime(0,o+V),u.frequency.linearRampToValueAtTime(G,o+C),u.frequency.linearRampToValueAtTime(j,o+I),u.frequency.linearRampToValueAtTime(0,o+L),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(.7,o+R),c.gain.linearRampToValueAtTime(.2,o+C),c.gain.linearRampToValueAtTime(.6,o+I),c.gain.linearRampToValueAtTime(0,o+L),h=L;break;case 31:i.playbackRate.setValueAtTime(.4,o),i.playbackRate.linearRampToValueAtTime(.5,o+.015),r.gain.setValueAtTime(1.2,o),r.gain.setTargetAtTime(0,o,.035),p=.3,u.frequency.setValueAtTime(3140,o),c.gain.setValueAtTime(1.2,o),c.gain.setTargetAtTime(0,o,.012),h=.3;break;case 32:r.gain.value=0,p=0,u.type="square",u.frequency.setValueAtTime(333,o),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(4,o+.0016),c.gain.linearRampToValueAtTime(0,o+.0032),h=.0032;break;case 33:case 34:i.playbackRate.setValueAtTime(.17,o),i.playbackRate.linearRampToValueAtTime(.22,o+.01),r.gain.setValueAtTime(1.5,o),r.gain.setTargetAtTime(0,o,.015),p=.3,34==e.pitch?(u.frequency.setValueAtTime(2040,o),c.gain.setValueAtTime(1,o),c.gain.setTargetAtTime(0,o,.12),h=1.1):(c.gain.value=0,h=0);break;case 82:i.playbackRate.value=1,r.gain.setValueAtTime(.5,o),r.gain.linearRampToValueAtTime(1,o+.02),r.gain.linearRampToValueAtTime(0,o+.07),p=.07,c.gain.value=0,h=0;break;case 83:i.playbackRate.value=1,r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(1.2,o+.015),r.gain.setTargetAtTime(0,o+.015,.06),p=.5,u.type="triangle",u.frequency.setValueAtTime(2709,o),u.frequency.linearRampToValueAtTime(2657,o+.3),c.gain.setValueAtTime(0,o),c.gain.linearRampToValueAtTime(.7,o+.025),c.gain.setTargetAtTime(0,o+.025,.07),h=.5;break;case 84:i.playbackRate.value=1;for(var W=0;28>W;W++)r.gain.setValueAtTime(.1,o+W/24*.45),r.gain.setTargetAtTime(0,o+W/24*.45,.01),u.frequency.setValueAtTime(1380*(1+W/24),o+W/24*.45),c.gain.setValueAtTime(1*(.2+W/24),o+W/24*.45),c.gain.setTargetAtTime(0,o+W/24*.45,27==W?.2:.01);p=.5,h=1.5;break;case 85:i.playbackRate.setValueAtTime(.35,o),r.gain.setValueAtTime(1.3,o),r.gain.setTargetAtTime(0,o,.01),p=.1,u.frequency.setValueAtTime(1730,o),c.gain.setValueAtTime(.5,o),c.gain.setTargetAtTime(0,o,.01),h=.1;break;case 86:case 87:i.playbackRate.setValueAtTime(.02,o),i.playbackRate.linearRampToValueAtTime(.015,o+.5),r.gain.setValueAtTime(0,o),r.gain.linearRampToValueAtTime(2,o+.005),r.gain.setTargetAtTime(0,o+.005,86==e.pitch?.03:.06),p=.5,u.frequency.setValueAtTime(88,o),u.frequency.linearRampToValueAtTime(86,o+.3),c.gain.setValueAtTime(2.5,o),c.gain.setTargetAtTime(0,o,86==e.pitch?.1:.3),h=86==e.pitch?.5:1.5;break;default:i.playbackRate.value=e.pitch/69*2,p=.05,h=0}return this.settings.isSameDrumSoundOverlap||-1==f||(p>f&&(p=f),h>f&&(h=f)),this.stopAudioNode(i,o+p,a),this.stopAudioNode(u,o+h,l),e.drumStopTime=e.startTime+(p>=h?p:h),function(){t.stopAudioNode(i,0,a,!0),t.stopAudioNode(u,0,l,!0)}}.call(this,e)}},{key:"stopAudioNode",value:function(e,t,n,i){return function(e,t,n,i){var r=t-.005,a=t;t<=this.context.currentTime&&(i?(r=this.context.currentTime,a=this.context.currentTime+.005):a=this.context.currentTime);try{i?(e.stop(a),n.gain.cancelScheduledValues(0),n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,a)):e.stop(a)}catch(e){n.gain.cancelScheduledValues(0),i?(n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,a)):n.gain.setValueAtTime(0,a)}}.call(this,e,t,n,i)}},{key:"pushFunc",value:function(e){return function(e){(e.note||e.rootTimeout||e.pan||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)}.call(this,e)}},{key:"clearFunc",value:function(e,t){return function(e,t){("note"==e||"rootTimeout"==e||"pan"==e||this.trigger.isNoteTrigger)&&this.states.stopFuncs.some(function(n,i,r){return n[e]==t?(b.delete(r,i),!0):void 0})}.call(this,e,t)}},{key:"startWebMIDI",value:function(){return function(){var e,t=this;if(navigator.requestMIDIAccess){var n=this.settings.WebMIDIPortSysEx,i=function(i){var r;return e=i.outputs,t.settings.WebMIDIPortOutputs=e,-1==t.settings.WebMIDIPort?t.settings.WebMIDIPortOutputs.forEach(function(e){r||(r=e)}):r=t.settings.WebMIDIPortOutputs.get(settings.WebMIDIPort),t.settings.WebMIDIPortOutput=r,t.settings.WebMIDIPortSysEx=n,r&&(r.open(),t.initStatus()),e};navigator.requestMIDIAccess({sysex:n}).then(i).catch(function r(e){console.log(e),n&&(n=!1,navigator.requestMIDIAccess({sysex:n}).then(i).catch(r))}),window.addEventListener("unload",function(){for(var e=0;16>e;e++){t.settings.WebMIDIPortOutput.send([176+e,120,0]);for(var n=0;128>n;n++)t.settings.WebMIDIPortOutput.send([128+e,n,0])}})}}.call(this)}},{key:"measurePerformanceReverb",value:function(){return w.measureReverb.call(this)}},{key:"addEventListener",value:function(e,t){this.events.push({type:e,func:t})}},{key:"fireEvent",value:function(e,t){this.events.forEach(function(e){if(e.type==n)try{e.func(t)}catch(n){console.log(n)}})}},{key:"getChannels",value:function(){return this.channels}},{key:"setChannels",value:function(e){var t=this;e.forEach(function(e,n){t.channels[n]=e})}},{key:"initChannels",value:function(){for(var e=0;16>e;e++)this.channels[e]=[0,0,1]}},{key:"getMasterVolume",value:function(){return this.settings.masterVolume}},{key:"setMasterVolume",value:function(e){this.settings.masterVolume=e,this.masterGainNode.gain.value=this.settings.masterVolume}},{key:"isLoop",value:function(){return this.settings.loop}},{key:"setLoop",value:function(e){this.settings.loop=e}},{key:"isWebMIDI",value:function(){return this.settings.isWebMIDI}},{key:"setWebMIDI",value:function(e){this.settings.isWebMIDI=e}},{key:"isCC111",value:function(){return this.settings.isCC111}},{key:"setCC111",value:function(e){this.settings.isCC111=e}},{key:"setStartTime",value:function(e){this.states.startTime-=e}},{key:"setOnSongEndListener",value:function(e){this.onSongEndListener=e}},{key:"onSongEnd",value:function(){this.onSongEndListener&&this.onSongEndListener()||this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.cc111Time),this.play(!0))}},{key:"isReverb",value:function(){return this.settings.isReverb}},{key:"setReverb",value:function(e){this.settings.isReverb=e}},{key:"getReverbVolume",value:function(){return this.settings.reverbVolume}},{key:"setReverbVolume",value:function(e){this.settings.reverbVolume=e}},{key:"isChorus",value:function(){return this.settings.isChorus}},{key:"setChorus",value:function(e){this.settings.isChorus=e}},{key:"getChorusVolume",value:function(){return this.settings.chorusVolume}},{key:"setChorusVolume",value:function(e){this.settings.chorusVolume=e}}])&&v(t.prototype,n),i&&v(t,i),e}();window.PicoAudio=P}]),n("PicoAudio",[],function(){return PicoAudio}),a.setName("T2MediaLib");var o=function(){var e=function(e){this.context=null,this.picoAudio=null,this.soundDataAry=[],this.bgmPlayerMax=16,this.bgmPlayerAry=[],this.masterVolume=1,this.seMasterVolume=1,this.bgmMasterVolume=1,this.playingAudio=null,this.audioVolume=1,this.audioTempo=1,this.audioDataAry={data:[]},this.seSources=[],this.init(e)};return e.prototype.init=function(e){if(!this.inited&&(this.inited=!0,!this.disabled&&(e?this.context=e:window.AudioContext?this.context=new AudioContext:window.webkitAudioContext?this.context=new webkitAudioContext:(this.context=null,console.log("Your browser does not support yet Web Audio API")),this.context)))for(var t=0;t<this.bgmPlayerMax;t++)this.bgmPlayerAry[t]=new s(this,t)},e.prototype.allClearSoundData=function(){var e=this.soundDataAry;for(var t in e)delete e[t]},e.prototype.clearSoundData=function(e){var t=this.soundDataAry;delete t[e]},e.prototype.allRemoveDecodedSoundData=function(){var e=this.soundDataAry;for(var t in e){var n=e[t];null!=n&&(n.isDecodeComplete()||n.isDecoding())&&n.removeDecodedData()}},e.prototype.removeDecodedSoundData=function(e){var t=this.soundDataAry[e];null!=t&&(t.isDecodeComplete()||t.isDecoding())&&t.removeDecodedData()},e.prototype.getMasterVolume=function(){return this.masterVolume},e.prototype.setMasterVolume=function(e){this.masterVolume=e;for(var t=0;t<this.bgmPlayerMax;t++){var n=this.bgmPlayerAry[t];n instanceof s&&n.onChangeBGMMasterVolume()}},e.prototype.createSoundFromArray=function(e,t,n){this.soundDataAry[e]=new u;for(var i=this.context,r=null!=t&&null!=n?2:1,a=i.createBuffer(r,array.length,i.sampleRate),o=a.getChannelData(0),s=null!=n?a.getChannelData(1):null,c=0;c<array.length;c++)o[c]=t[c];if(s)for(var c=0;c<array.length;c++)s[c]=n[c];this.soundDataAry[e].onDecodeComplete(a)},e.prototype.loadSound=function(e,t,n){if(this.soundDataAry[e]=new u,!this.context||this.disabled)return this.soundDataAry[e].onError("FUNC_DISABLED_ERROR"),null;(t.match(/\.(midi?)$/)||t.match(/^data:audio\/mid/))&&null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.context)),"object"==typeof WebSite&&WebSite.mp3Disabled&&(t=t.replace(/\.(mp3)$/,".ogg")),"object"==typeof WebSite&&WebSite.mp4Disabled&&(t=t.replace(/\.(mp4|m4a)$/,".ogg"));var i=this,r=new XMLHttpRequest;if(r.onload=function(){if(200===r.status||0===r.status){var t=r.response;t instanceof ArrayBuffer?(i.soundDataAry[e].onLoadComplete(t),n&&n.succ&&n.succ(e)):(i.soundDataAry[e].onError("XHR_RESPONSE_ERROR"),n&&n.err&&n.err(e,i.soundDataAry[e].errorID))}else i.soundDataAry[e].onError("XHR_STATUS_ERROR"),n&&n.err&&n.err(e,i.soundDataAry[e].errorID)},r.onerror=function(t){console.log(t+""),i.soundDataAry[e].onError("XHR_ERROR"),n&&n.err&&n.err(e,i.soundDataAry[e].errorID)},this.soundDataAry[e].onLoad(t),t.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer)r={onload:r.onload},r.response=Util.Base64_To_ArrayBuffer(t.replace(/^data:audio\/[a-zA-Z0-9\-]+;base64,/i,"")),r.status=200,r.onload();else{r.open("GET",t,!0),r.responseType="arraybuffer";try{r.send(null)}catch(a){this.soundDataAry[e].onError("FILE_NOT_FOUND")}}},e.prototype.decodeSound=function(e,t){var n=this.soundDataAry[e];if(null!=n&&null!=n.fileData&&n.isLoadComplete()&&!n.isDecodeComplete()){if(null==n.decodedCallbacksAry&&(n.decodedCallbacksAry=[]),t)if(null!=t.bgmPlayerId){var i=n.decodedCallbacksAry.some(function(e,i){return t.bgmPlayerId==e.bgmPlayerId?(n.decodedCallbacksAry[i]=t,!0):!1});i||n.decodedCallbacksAry.push(t)}else n.decodedCallbacksAry.push(t);if(!n.isDecoding()){n.onDecode();var r=n.fileData.slice(0);if(n.url.match(/\.(midi?)$/)||n.url.match(/^data:audio\/mid/)){null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.context));var a=new Uint8Array(r),o=this.picoAudio.parseSMF(a);"string"==typeof o?(console.log("T2MediaLib: Error parseSMF()",o),this.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,this.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null):(this.soundDataAry[e].onDecodeComplete(o),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)}else if(n.url.match(/\.mzo$/)||n.url.match(/^data:audio\/mzo/)){console.log("Loading mzo");var s=this,u=new Mezonet(this.context,{wavOutSpeed:50}),c=Array.prototype.slice.call(new Uint8Array(r));u.load(c),u.toAudioBuffer().then(function(t){console.log("MZO loaded",t),s.soundDataAry[e].isDecoding()&&(s.soundDataAry[e].onDecodeComplete(t.decodedData),s.soundDataAry[e].loopStart=t.loopStart,n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)},function(t){t instanceof Error?console.log("T2MediaLib: "+t.message,n.url):console.log("T2MediaLib: Error decodeMZO()",n.url),s.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,s.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null})}else{var s=this,l=function(t){s.soundDataAry[e].isDecoding()&&(s.soundDataAry[e].onDecodeComplete(t),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.succ&&t.succ(e)}),n.decodedCallbacksAry=null)},f=function(t){t instanceof Error?console.log("T2MediaLib: "+t.message,n.url):console.log("T2MediaLib: Error decodeAudioData()",n.url),s.soundDataAry[e].onError("DECODE_ERROR"),n.decodedCallbacksAry.forEach(function(t){"function"==typeof t.err&&t.err(e,s.soundDataAry[e].errorID)}),n.decodedCallbacksAry=null};this.context.decodeAudioData(r,l,f)}}}},e.prototype.activate=function(){if(this.init(),this.context){if(!this.isContextResumed&&this.context.resume){var e=this;this.context.resume().then(function(){e.isContextResumed=!0})}if(!this.isActivated){this.isActivated=!0;for(var t=this.context.createBuffer(1,Math.floor(this.context.sampleRate/32),this.context.sampleRate),n=t.getChannelData(0),i=0;i<n.length;i++)n[i]=0;var r=this.context.createBufferSource();r.buffer=t,r.connect(this.context.destination),r.start=r.start||r.noteOn,r.start(0)}}},e.prototype.getSoundFileData=function(e){var t=this.soundDataAry[e];return t?t.fileData:null},e.prototype.getSoundDecodedData=function(e){var t=this.soundDataAry[e];return t?t.decodedData:null},e.prototype.getCurrentTime=function(){return this.context?this.context.currentTime:null},e.prototype.playSE=function(e,t,n,i,r,a,o,s,u,c){if(!this.context)return null;var l=this.soundDataAry[e];if(null==l)return null;if(!l.isDecodeComplete()){var f=this,p={};return p.succ=function(e){f.playSE(e,t,n,i,r,a,o,s,u,c)},p.err=function(){},this.decodeSound(e,p),null}var h=l.decodedData;if(!(h instanceof AudioBuffer))return null;null==t&&(t=1),null==n&&(n=0),i||(i=1),r?r>h.duration?r=h.duration:0>r&&(r=0):r=0,durationStart=c,c||(durationStart=86400),a||(a=!1),o?0>o?o=0:o>h.duration&&(o=h.duration):o=l.loopStart||0,s?0>s?s=0:s>h.duration&&(s=h.duration):s=h.duration,u=u||0;var m=this.context.createBufferSource();this.context.createGain=this.context.createGain||this.context.createGainNode;var d=this.context.createGain(),g=this.context.createPanner();m.buffer=h,m.loop=a,m.loopStart=o,m.loopEnd=s,m.playbackRate.value=i,m.connect(d),d.connect(g),g.connect(this.context.destination),g.panningModel="equalpower",-1>n?n=-1:n>1&&(n=1);var y=90*n,v=Math.sin(y*(Math.PI/180)),T=-Math.cos(y*(Math.PI/180));(-1===n||1===n)&&(T=0),g.positionX?(g.positionX.value=v,g.positionY.value=0,g.positionZ.value=T):g.setPosition(v,0,T),d.gain.value=t*this.seMasterVolume*this.masterVolume;var b;b=a&&s-o>0&&r>s?s:r,m.gainNode=d,m.volumeValue=t,m.panNode=g,m.panValue=n,m.playStartTime=this.context.currentTime+u,m.playOffset=b,m.plusTime=b,m.start=m.start||m.noteOn,m.stop=m.stop||m.noteOff,m.start(u,r,durationStart),a&&null!=c&&m.stop(u+c);var A=this;return A.seSources.push(m),m.onended=function(){m.onended=null;var e=A.seSources.indexOf(m);e>=0&&A.seSources.splice(e,1)},m},e.prototype.stopSE=function(e){if(!(e instanceof AudioBufferSourceNode))return null;try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}return e},e.prototype.stopAllSE=function(){var e=this;this.seSources.forEach(function(t){e.stopSE(t)})},e.prototype.getSEMasterVolume=function(){return this.seMasterVolume},e.prototype.setSEMasterVolume=function(e){this.seMasterVolume=e},e.prototype.getSEVolume=function(e){return e instanceof AudioBufferSourceNode?source.volumeValue:null},e.prototype.setSEVolume=function(e,t){return e instanceof AudioBufferSourceNode?(e.gainNode.gain.value=t*this.seMasterVolume*this.masterVolume,source.volumeValue=t,e):null},e.prototype.getSERate=function(e){return e instanceof AudioBufferSourceNode?e.playbackRate.value:null},e.prototype.setSERate=function(e,t){return e instanceof AudioBufferSourceNode?void(e.playbackRate.value=t):null},e.prototype.getSEPan=function(e){return e instanceof AudioBufferSourceNode?e.panValue:null},e.prototype.setSEPan=function(e,t){if(!(e instanceof AudioBufferSourceNode))return null;var n=e.panNode;-1>t?t=-1:t>1&&(t=1);var i=90*t,r=Math.sin(i*(Math.PI/180)),a=Math.cos(i*(Math.PI/180));(-1===t||1===t)&&(a=0),n.positionX?(n.positionX.value=r,n.positionY.value=0,n.positionZ.value=a):n.setPosition(r,0,a),e.panValue=t},e.prototype.isSELoop=function(e){return e instanceof AudioBufferSourceNode?e.loop:null},e.prototype.setSELoop=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loop=t):null},e.prototype.getSELoopStartTime=function(e){return e instanceof AudioBufferSourceNode?e.loopStart:null},e.prototype.setSELoopStartTime=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopStart=t):null},e.prototype.getSELoopEndTime=function(e){return e instanceof AudioBufferSourceNode?e.loopEnd:null},e.prototype.setSELoopEndTime=function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopEnd=t):null},e.prototype.playBGM=function(e,t,n,i,r,a){if(!this.context)return null;var o=this._getBgmPlayer(e);return o?o.playBGM(t,n,i,r,a):null},e.prototype.stopBGM=function(e){var t=this._getBgmPlayer(e);return t?t.stopBGM():null},e.prototype.pauseBGM=function(e){var t=this._getBgmPlayer(e);return t?t.pauseBGM():null},e.prototype.resumeBGM=function(e){var t=this._getBgmPlayer(e);return t?t.resumeBGM():null},e.prototype.getBGMMasterVolume=function(){return this.bgmMasterVolume},e.prototype.setBGMMasterVolume=function(e){this.bgmMasterVolume=e;for(var t=0;t<this.bgmPlayerMax;t++){var n=this.bgmPlayerAry[t];n instanceof s&&n.onChangeBGMMasterVolume()}},e.prototype.getBGMVolume=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMVolume():null},e.prototype.setBGMVolume=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMVolume(t):null},e.prototype.getBGMTempo=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMTempo():null},e.prototype.setBGMTempo=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMTempo(t):null},e.prototype.getBGMPan=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMPan():null},e.prototype.setBGMPan=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMPan(t):null},e.prototype.isBGMLoop=function(e){var t=this._getBgmPlayer(e);return t?t.isBGMLoop():null},e.prototype.setBGMLoop=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoop(t):null},e.prototype.getBGMLoopStartTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLoopStartTime():null},e.prototype.setBGMLoopStartTime=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoopStartTime(t):null},e.prototype.getBGMLoopEndTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLoopEndTime():null},e.prototype.setBGMLoopEndTime=function(e,t){var n=this._getBgmPlayer(e);return n?n.setBGMLoopEndTime(t):null},e.prototype.getBGMCurrentTime=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMCurrentTime():null},e.prototype.getBGMLength=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMLength():null},e.prototype.getPlayingBGMName=function(e){var t=this._getBgmPlayer(e);return t?t.getPlayingBGMName():null},e.prototype.setOnBGMEndListener=function(e,t){var n=this._getBgmPlayer(e);return n?n.setOnBGMEndListener(t):null},e.prototype.getPlayingBGMState=function(e){var t=this._getBgmPlayer(e);return t?t.getPlayingBGMState():null},e.prototype.getBGMPicoAudio=function(e){var t=this._getBgmPlayer(e);return t?t.getBGMPicoAudio():null},e.prototype.getBGMPlayerMax=function(){return this.bgmPlayerMax},e.prototype.allStopBGM=function(){for(var e=0;e<this.bgmPlayerMax;e++)this.stopBGM(e)},e.prototype.allResetBGM=function(){for(var e=0;e<this.bgmPlayerMax;e++)this.stopBGM(e),this.setBGMVolume(e,1),this.setBGMTempo(e,1),this.setBGMPan(e,0);this.setMasterVolume(1),this.setSEMasterVolume(1),this.setBGMMasterVolume(1)},e.prototype._getBgmPlayer=function(e){if(0>e||this.bgmPlayerMax<=e)return null;var t=this.bgmPlayerAry[e];return t instanceof s?t:null},e.prototype.loadAudio=function(e,t){var n=new Audio(t);n.play(),this.audioDataAry.data[e]=null;var i=this;n.addEventListener("loadstart",function(){if(!i.context)return null;var e=i.context.createMediaElementSource(n);e.connect(i.context.destination)},!1),n.addEventListener("canplay",function(){this.audioDataAry.data[e]=n},!1),n.load()},e.prototype.playAudio=function(e,t,n){var i=this.audioDataAry.data[e];return i?(n||(n=0),this.playingAudio instanceof Audio&&(this.playingAudio.pause(),this.playingAudio.currentTime=0),this.playingAudio=i,i.loop=t,i.volume=this.audioVolume,i.currentTime=n,i.play(),i):null},e.prototype.stopAudio=function(){var e=this.playingAudio;return e instanceof Audio?(e.pause(),e.currentTime=0,this.playingAudio=null,e):null},e.prototype.pauseAudio=function(){var e=this.playingAudio;return e?(e.pause(),e):null},e.prototype.resumeAudio=function(){var e=this.playingAudio;return e?(e.play(),e):null},e.prototype.setAudioVolume=function(e){this.audioVolume=e,this.playingAudio instanceof Audio&&(this.playingAudio.volume=e)},e.prototype.setAudioTempo=function(e){this.audioTempo=e,this.playingAudio instanceof Audio&&(this.playingAudio.playbackRate=e)},e.prototype.setAudioPosition=function(e){this.playingAudio instanceof Audio&&(this.playingAudio.currentTime=e)},e.prototype.getAudioData=function(e){return this.audioDataAry.data[e]},e.prototype.getAudioCurrentTime=function(){return this.playingAudio instanceof Audio?this.playingAudio.currentTime:null},e.prototype.getAudioLength=function(){return this.playingAudio instanceof Audio?this.playingAudio.duration:null},e}(),s=function(){var e=function(e,t){this.t2MediaLib=e,this.id=t,this.playingBGMState="stop",this.playingBGMStatePending=null,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1,this.bgmPan=0,this.picoAudio=null,this.picoAudioSetDataBGMName=null,this.PICO_AUDIO_VOLUME_COEF=1};return e.prototype.playBGM=function(e,t,n,i,r){this.stopBGM();var a=this.t2MediaLib.soundDataAry[e];if(null==a)return null;if(!a.isDecodeComplete()){var o=this,s={};return s.bgmPlayerId=this.id,s.succ=function(){var a=o.playingBGMStatePending;o._setPlayingBGMState("stop",!0),"stop"!=a&&o.playingBGMName==e&&o.playBGM(e,t,n,i,r),"pause"==a&&o.pauseBGM()},s.err=function(){o._setPlayingBGMState("stop",!0)},this.playingBGMName=e,this._setPlayingBGMState("decoding",!0),this._setPlayingBGMState("play"),this.t2MediaLib.decodeSound(e,s),this}var u=a.decodedData;if(u instanceof AudioBuffer)this.playingBGM=this.t2MediaLib.playSE(e,this.bgmVolume,this.bgmPan,this.bgmTempo,n,t,i,r);else if(u instanceof Object){if(this._initPicoAudio(),e!=this.picoAudioSetDataBGMName?(this.picoAudio.setData(u),this.picoAudioSetDataBGMName=e):this.picoAudio.initStatus(),this.picoAudio.setLoop(t),this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*this.bgmVolume*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume),n){var c=this.picoAudio.getTime(Number.MAX_SAFE_INTEGER);n>c?n=c:0>n&&(n=0)}else n=0;this.picoAudio.setStartTime(n),this.picoAudio.play(),this.playingBGM=this.picoAudio}return this.playingBGMName=e,this.bgmPause=0,this._setPlayingBGMState("play"),this},e.prototype.stopBGM=function(){var e=this.playingBGM;if(e instanceof PicoAudio)this.picoAudio.stop();else if(e instanceof AudioBufferSourceNode)try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}return this.playingBGM=null,this.playingBGMName=null,this._setPlayingBGMState("stop"),this},e.prototype.pauseBGM=function(){var e=this.playingBGM;if(e instanceof PicoAudio)0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseCurrentTime=e.context.currentTime,e.stop(),this.bgmPause=1);else if(e instanceof AudioBufferSourceNode&&0===this.bgmPause){this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=this.t2MediaLib.getSELoopStartTime(e),this.bgmPauseLoopEnd=this.t2MediaLib.getSELoopEndTime(e),this.bgmPauseLoop=this.t2MediaLib.isSELoop(e),this.bgmPauseCurrentTime=e.context.currentTime,this.bgmPauseTempo=this.bgmTempo;try{e.stop(0)}catch(t){e.gainNode&&(e.gainNode.gain.cancelScheduledValues(this.context.currentTime),e.gainNode.gain.linearRampToValueAtTime(0,this.context.currentTime))}this.bgmPause=1
}return"stop"!=this.playingBGMState&&this._setPlayingBGMState("pause"),this},e.prototype.resumeBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?1===this.bgmPause&&(e.play(),this.bgmPause=0):e instanceof AudioBufferSourceNode&&1===this.bgmPause&&(e=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd)),this},e.prototype.onChangeBGMMasterVolume=function(){this.setBGMVolume(this.getBGMVolume())},e.prototype.getBGMVolume=function(){return this.bgmVolume},e.prototype.setBGMVolume=function(e){var t=this.playingBGM;return this.bgmVolume=e,t instanceof PicoAudio?this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*e*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume):t instanceof AudioBufferSourceNode&&(t.gainNode.gain.value=e*this.t2MediaLib.bgmMasterVolume*this.t2MediaLib.masterVolume),this},e.prototype.getBGMTempo=function(){return this.bgmTempo},e.prototype.setBGMTempo=function(e){var t=this.playingBGM;return(0>=e||isNaN(e))&&(e=1),t instanceof AudioBufferSourceNode&&0===this.bgmPause&&(t.plusTime-=(this.t2MediaLib.context.currentTime-t.playStartTime)*(e-this.bgmTempo)),this.bgmTempo=e,this.t2MediaLib.setSERate(t,e),this},e.prototype.getBGMPan=function(){return this.bgmPan},e.prototype.setBGMPan=function(e){var t=this.playingBGM;return this.bgmPan=e,t instanceof AudioBufferSourceNode&&this.t2MediaLib.setSEPan(t,e),this},e.prototype.isBGMLoop=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.isLoop():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoop:this.t2MediaLib.isSELoop(e):null},e.prototype.setBGMLoop=function(e){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.setLoop(e):t instanceof AudioBufferSourceNode&&(1===this.bgmPause?this.bgmPauseLoop=e:this.t2MediaLib.setSELoop(t,e)),this},e.prototype.getBGMLoopStartTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?0:e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopStart:this.t2MediaLib.getSELoopStartTime(e):null},e.prototype.setBGMLoopStartTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return this.t2MediaLib.setSELoopStartTime(t,e);this.bgmPauseLoopStart=e}return this},e.prototype.getBGMLoopEndTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.getBGMLength():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopEnd:this.t2MediaLib.getSELoopEndTime(e):null},e.prototype.setBGMLoopEndTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return this.t2MediaLib.setSELoopEndTime(t,e);this.bgmPauseLoopEnd=e}return this},e.prototype.getBGMCurrentTime=function(){var e=this.playingBGM;if(e instanceof PicoAudio){var t;return t=0===this.bgmPause?this.picoAudio.context.currentTime-this.picoAudio.states.startTime:this.bgmPauseTime}if(e instanceof AudioBufferSourceNode){var t,n,i,r,a,o,s;return 0===this.bgmPause?(i=this.t2MediaLib.context.currentTime,r=this.bgmTempo):(i=this.bgmPauseCurrentTime,r=this.bgmPauseTempo),n=(i-e.playStartTime)*r+e.plusTime,e.loop&&(e.loopEnd-e.loopStart>0?n<e.loopStart?(a=0,o=0,s=e.buffer.duration):(a=e.loopStart,o=e.loopStart,s=e.loopEnd-e.loopStart):(s=e.buffer.duration,a=0,o=0)),e.loop?t=(n-o)%s+a:(t=n,t>e.buffer.duration&&(t=e.buffer.duration)),t}return null},e.prototype.getBGMLength=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.getTime(Number.MAX_SAFE_INTEGER):e instanceof AudioBufferSourceNode?e.buffer.duration:null},e.prototype.getPlayingBGMName=function(){return this.playingBGMName},e.prototype.setOnBGMEndListener=function(e){null!=this.picoAudio&&this.picoAudio.setOnSongEndListener(e)},e.prototype.getPlayingBGMState=function(){return this.playingBGMState},e.prototype.getBGMPicoAudio=function(){return this._initPicoAudio(),this.picoAudio},e.prototype._setPlayingBGMState=function(e,t){t||"decoding"!=this.playingBGMState?(this.playingBGMState=e,this.playingBGMStatePending=null):this.playingBGMStatePending=e},e.prototype._initPicoAudio=function(){null==this.picoAudio&&(0==this.id&&(this.picoAudio=this.t2MediaLib.picoAudio),null==this.picoAudio&&(this.picoAudio=new PicoAudio(this.t2MediaLib.context,this.t2MediaLib.picoAudio)))},e}(),u=function(){var e=function(){this.state="none",this.errorID=null,this.url=null,this.fileData=null,this.decodedData=null,this.decodedCallbacksAry=null};return e.prototype.onLoad=function(e){this.state="loading",this.url=e},e.prototype.onLoadComplete=function(e){this.state="loaded",this.fileData=e},e.prototype.onDecode=function(){this.state="decoding"},e.prototype.onDecodeComplete=function(e){this.state="decoded",this.decodedData=e},e.prototype.onError=function(e){this.state="error",this.errorID=e},e.prototype.isLoadComplete=function(){switch(this.state){case"loaded":case"decoding":case"decoded":return!0}return!1},e.prototype.isDecoding=function(){return"decoding"==this.state},e.prototype.isDecodeComplete=function(){return"decoded"==this.state},e.prototype.removeDecodedData=function(){this.state="loaded",this.decodedData=null},e}();n("T2MediaLib",[],function(){return o}),a.setName("exceptionCatcher"),n([],function(){var e={};return e.f=function(t){if("function"==typeof t){if(t.isTrcf)return t;var n=function(){if(!e.handleException||e.enter)return t.apply(this,arguments);try{return e.enter=!0,t.apply(this,arguments)}catch(n){e.handleException(n)}finally{e.enter=!1}};return n.isTrcf=!0,n}if("object"==typeof t){for(var i in t)t[i]=e.f(t[i]);return t}},e}),a.setName("UI"),n(["Util","exceptionCatcher"],function(e,t){var n={},i=t.f;return n=function(){function t(){l.forEach(function(e){e()}),setTimeout(i(t),50)}function r(e){return e instanceof Array?a(e):"string"==typeof e?s(e):e}function a(e){var t=e[0],n=1,i=$("<"+t+">");for("object"!=typeof e[n]||e[n]instanceof Array||e[n]instanceof $||(o(i,e[n],t),n++);n<e.length;)i.append(r(e[n])),n++;return i}function o(t,r){function a(e,n){if(n)if("enterkey"==e)t.on("keypress",i(function(e){13==e.which&&n.apply(t,arguments)}));else if("realtimechange"==e){var a,o=!0;l.push(function(){var e;e="checkbox"==r.type?!!t.prop("checked"):t.val(),(o||a!=e)&&(n.apply(t,[e,a]),a=e),o=!1})}else t.on(e,i(n))}r.$var&&(f[r.$var]=t),r.$edit&&("string"==typeof r.$edit&&(r.$edit={name:r.$edit,type:n.types.String}),r.on||(r.on={}),r.on.realtimechange=i(function(e){p.writeToModel(r.$edit,e,t)}),f[r.$edit.name]||(f[r.$edit.name]=t),p.push({jq:t,params:r}));for(var o in r)if("on"==o)for(var s in r.on)a(s,r.on[s]);else"css"==o&&null!=r[o]?t.css(r[o]):e.startsWith(o,"$")||null==r[o]||t.attr(o,r[o])}function s(e){return $(document.createTextNode(e))}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var l=[],f={},p=[],h=r(u);return h.$edits=p,h.$vars=f,$.data(h,"edits",p),$.data(h,"vars",f),p.load=function(e){p.model=e,p.forEach(function(e){p.writeToJq(e.params.$edit,e.jq)}),p.validator.on.validate.call(p.validator,p.model)},p.writeToJq=function(e,t){var n=p.model;if(n){for(var i=e.name,r=i.split("."),a=0;a<r.length;a++)n=n[r[a]];n=e.type.toVal(n),"checkbox"==t.attr("type")?t.prop("checked",!!n):t.val(n)}},p.validator={errors:{},show:function(){if(f.validationMessage){f.validationMessage.empty();for(var e in this.errors)f.validationMessage.append(n("div",this.errors[e].mesg))}if(f.OKButton){var t=!0;for(var e in this.errors)t=!1;f.OKButton.attr("disabled",!t)}},on:{validate:function(){}},addError:function(e,t,n){this.errors[e]={mesg:t,jq:n},this.show()},removeError:function(e){delete this.errors[e],this.show()},allOK:function(){for(var e in this.errors)delete this.errors[e];this.show()},isValid:function(){var e=!0;for(var t in this.errors)e=!1;return e}},p.writeToModel=function(e,t,n){var i=p.model;if(i){var r=e.name;try{t=e.type.fromVal(t)}catch(a){return void p.validator.addError(r,a,n)}p.validator.removeError(r);for(var o=r.split("."),s=0;s<o.length;s++)s==o.length-1?p.on.writeToModel(r,t)||(i[o[s]]=t):i=i[o[s]];p.validator.on.validate.call(p.validator,p.model)}},p.on={},p.on.writeToModel=function(){},l.length>0&&setTimeout(i(t),50),h},n.types={String:{toVal:function(e){return e},fromVal:function(e){return e}},Number:{toVal:function(e){return e+""},fromVal:function(e){return parseFloat(e)}}},n}),a.setName("UIDiag"),n(["UI"],function(e){function t(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function n(e,n){return null==e&&(e=""),t(e)?{title:n,body:i(e)}:"undefined"!=typeof $&&e instanceof $?{title:e.title||n,body:e}:(t(e.body)&&(e.body=i(e.body)),e)}function i(t){var n=(t+"").split("\n");return 1==n.length?n[0]:e.apply(this,["div"].concat(n.map(function(e){return["div",e]})))}var r={};return r.confirm=function(t){function i(e){return function(){a.resolve(e),r.dialog("close"),r.remove()}}t=n(t,"確認");var r=e("div",{title:t.title},["div",t.body],["button",{on:{click:i(!0)}},"OK"],["button",{on:{click:i(!1)}},"キャンセル"]).dialog({width:"auto",close:i(!1)}),a=$.Deferred();return a.promise()},r.alert=function(t){function i(e){return function(){a.resolve(e),r.dialog("close"),r.remove()}}t=n(t,"確認");var r=e("div",{title:t.title},["div",t.body],["button",{on:{click:i(!0)}},"OK"]).dialog({width:"auto",close:i(!1)}),a=$.Deferred();return a.promise()},r.open=function(e,t,n,i,a,o,s){return r.prompt({title:e,body:t},n,{left:i,top:a,width:o,height:s})},r.getStatus=function(){return r.status},r.getText=function(){return r.val?r.val.val():""},r.prompt=function(t,i,a){function o(){r.status=1;var e=u.$vars.val.val();r.resultValue=e,c.resolve(e),u.dialog("close"),u.remove()}function s(){r.status=2,u.dialog("close"),u.remove(),c.resolve()}t=n(t,"入力"),a=a||{},position="number"==typeof a.left&&"number"==typeof a.top?{my:"left top",at:"left+"+a.left+" top+"+a.top,of:"body"}:{of:"body",at:"center",my:"center"};var u=e("div",{title:t.title},["div",t.body],["input",{on:{enterkey:o},$var:"val",value:i}],["br"],["button",{on:{click:o}},"OK"],["button",{on:{click:s}},"キャンセル"]).dialog({width:a.width||"auto",height:a.height||"auto",position:position,close:function(){u.dialog("close"),c.resolve()}});setTimeout(function(){u.$vars.val.focus()},10),r.status=0,r.val=u.$vars.val;var c=$.Deferred();return c.promise()},"undefined"!=typeof window&&(window.UIDiag=r),r}),a.setName("SEnv"),n("SEnv",["Klass","assert"],function(e){var t,n,r=10,a=32,o=32,s=96,u=48e3,c=99,l=100,f=101,p=102,h=103,m=104,d=105,g=106,y=107,v=108,T=109,b=110,A=111,S=112,w=113,P=114,M=115,B=116,D=117,x=118,E=119,k=120,R=255,V=0,C=16,I=16,L=256,O=function(e,t){return Math.trunc(N(e,"x")/N(t,"y"))},N=function(e,t){if(e!==e)throw new Error(t+": Not a number!");if("number"!=typeof e)throw console.error(e),new Error(t+": Not a not a number but not a number!");return e},F=(Math.abs.bind(Math),function(e){return e>=128?e-256:e}),Z=function(e,t){for(var n=[],i=t;e[i];i++)n.push(e[i]);return n},G=function(e,t){var n=e[t];return n+=256*e[t+1],n+=65536*e[t+2],n+=16777216*e[t+3],n>=2147483648&&(n-=4294967296),n},j=Number,W=5,U=65536>>W,_=111860.78125,q=[3421,3228,3047,2876,2715,2562,2419,2283,2155,2034,1920,1812,1711,1614,1524,1438,1358,1281,1210,1142,1078,1017,960,906,855,807,762,719,679,641,605,571,539,509,480,453,428,404,381,360,339,320,302,285,269,254,240,227,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,71,67,64,60,57,53,50,48,45,42,40,38,36,34,32,30,28,27,25,24,22,21,20,19,18,17,16,15,14],H=1,z=2,Q=null,$=!1,J=!0,K="psPlay",Y="psStop",X="psWait",et=[],tt=[],nt=e.define(n={$this:"t",$fields:{Pos:j,PrevPos:j,RPos:j,SccCount:Array,Steps:Array,SccWave:Array,WaveDat:Array,wdata2:Array,BeginPlay:Boolean,SeqTime:j,SeqTime120:j,WavOutMode:Boolean,EShape:Array,EVol:Array,EBaseVol:Array,ESpeed:Array,ECount:Array,Oct:Array,MCount:Array,MPoint:Array,MPointC:Array,Resting:Array,PlayState:Array,Slur:Array,Sync:Array,Detune:Array,PorStart:Array,PorEnd:Array,PorLen:Array,LfoV:Array,LfoA:Array,LfoC:Array,LfoD:Array,LfoDC:Array,LfoSync:Array,Fading:j,CurWav:Array,L2WL:Array,PCMW:Array,Delay:j,Tempo:j,ComStr:String,WFilename:String,EnvDat:Array,WriteMaxLen:j,soundMode:Array},load:function(e,t){function n(e){if(0==e.length)throw new Error("Out of data");return e.shift()}function i(e){if(e.length<4)throw new Error("Out of data");var t=e.shift(),n=1;return n<<=8,t+=e.shift()*n,n<<=8,t+=e.shift()*n,n<<=8,t+=e.shift()*n}var r=(i(t),n(t));e.MPoint=chdatas=[];for(var a=0;r>a;a++){var o=[];chdatas.push(o);for(var s=i(t),u=0;s>u;u++)o.push(n(t))}},loadWDT:function(e,t){if(!t)return i(["Tones.wdt"],function(t){e.loadWDT(t)});var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){var t=n.response;if(t){var i=new Uint8Array(t);console.log("Loading wdt",i.length);for(var r=0,a=0;96>a;a++)for(var o=0;32>o;o++)e.WaveDat[a][o]=i[r++];for(var a=0;16>a;a++)for(var o=0;32>o;o++)e.EnvDat[a][o]=i[r++];console.log("Loading wdt done")}},n.send(null)},getPlayPos:function(){var e=this.context.currentTime-this.playStartTime,t=Math.floor(e*this.sampleRate);return t%u},setSound:function(e,t,n,i){switch(e.soundMode[t]=J,n){case H:e.Steps[t]=i;break;case z:e.EVol[t]=i}},InitSin:function(){var e;for(e=0;U>e;e++)tt[e]=Math.trunc(127*Math.sin(6.2831852*e/U))},InitEnv:function(e){var t,n;for(e.EnvDat=[],t=0;C>t;t++)for(e.EnvDat[t]=[],n=0;o>n;n++)e.EnvDat[t][n]=Math.floor((o-1-n)/2)},ConvM2T:function(e){var t;for(et=[],t=0;96>t;t++)et[t]=Math.trunc(65536*_/q[t]*65536/e.sampleRate)},InitWave:function(e){var t,n;for(e.WaveDat=[],t=0;s>t;t++)for(e.WaveDat[t]=[],n=0;a/2>n;n++)e.WaveDat[t][n]=103,e.WaveDat[t][n+O(a,2)]=153},$:function(e,t,n){var i;for(n=n||{},e.useScriptProcessor=n.useScriptProcessor,e.useFast=n.useFast,e.resolution=n.resolution||120,e.wavOutSpeed=n.wavOutSpeed||10,e.context=t,e.sampleRate=e.context.sampleRate,e.Delay=2e3,e.Pos=e.PrevPos=e.RPos=e.SeqTime=e.SeqTime120=0,e.BeginPlay=!1,e.InitWave(),e.InitEnv(),e.InitSin(),e.ConvM2T(),e.wdata2=[],e.PCMW=[],e.L2WL=[],e.Sync=[],e.ECount=[],e.MCount=[],i=0;I>i;i++)e.PCMW[i]=Q;for(e.Steps=[],e.SccWave=[],e.SccCount=[],e.EShape=[],e.EVol=[],e.EBaseVol=[],e.MPoint=[],e.MPointC=[],e.ESpeed=[],e.PlayState=[],e.Detune=[],e.LfoV=[],e.LfoD=[],e.LfoDC=[],e.PorStart=[],e.PorEnd=[],e.PorLen=[],e.soundMode=[],e.CurWav=[],e.Oct=[],e.Resting=[],e.Slur=[],e.Sync=[],e.LfoV=[],e.LfoA=[],e.LfoC=[],e.LfoD=[],e.LfoDC=[],e.LfoSync=[],i=0;r>i;i++)e.LfoV[i]=0,e.LfoA[i]=0,e.LfoC[i]=0,e.LfoD[i]=0,e.LfoDC[i]=0,e.LfoSync[i]=0,e.Slur[i]=e.Sync[i]=0,e.PorStart[i]=e.PorEnd[i]=e.PorLen[i]=0,e.ECount[i]=0,e.MCount[i]=0,e.Resting[i]=0,e.Steps[i]=0,e.SccWave[i]=e.WaveDat[0],e.SccCount[i]=0,e.EShape[i]=e.EnvDat[0],e.EVol[i]=0,e.EBaseVol[i]=128,e.MPoint[i]=Q,e.MPointC[i]=0,e.ESpeed[i]=5,e.PlayState[i]=Y,e.Detune[i]=0,e.LfoV[i]=0,e.SelWav(i,0),e.LfoD[i]=0,e.LfoDC[i]=0,e.Oct[i]=4,e.soundMode[i]=$;e.Fading=L,e.timeLag=2e3,e.WriteMaxLen=2e4,e.WavOutMode=$,e.label2Time=[],e.PC2Time=[],e.WFilename="",e.Tempo=120,e.ComStr="",e.performance={writtenSamples:0,elapsedTime:0},e.loadWDT()},getBuffer:function(){var e=1;return this.buf?this.buf:(this.buf=this.context.createBuffer(e,u,this.sampleRate),this.buf)},playNode:function(){if(!this.isSrcPlaying){var e=this.context.createBufferSource();e.buffer=this.getBuffer(),"function"==typeof e.noteOn&&e.noteOn(0),e.connect(this.context.destination),e.start(),e.loop=!0,e.playStartTime=this.playStartTime=this.context.currentTime,this.bufSrc=e,this.isSrcPlaying=!0}},startRefreshLoop:function(e){function t(){if(e.isSrcPlaying)for(var t=0,a=Math.floor(e.getPlayPos()/n);;){if(t++>u/n)throw new Error("Mugen "+a);var o=Math.floor(r/n);if(a===o)break;e.refreshPSG(i,r,n),r=(r+n)%u}}if(null==e.refreshTimer){for(var n=e.resolution,i=e.getBuffer().getChannelData(0),r=0,a=0;u>a;a+=n)e.refreshPSG(i,a,n);e.refreshTimer=setInterval(t,16)}},stopRefreshLoop:function(e){null!=e.refreshTimer&&(clearInterval(e.refreshTimer),delete e.refreshTimer)},stopNode:function(){this.isSrcPlaying&&(this.bufSrc.stop(),this.isSrcPlaying=!1)},Play1Sound:function(e,t,n,i){if(!e.soundMode[t])return n==c?void(e.Resting[t]=J):void(0>t||t>=r||0>n||n>95||(e.Resting[t]=$,i||(e.ECount[t]=0,e.Sync[t]&&(e.SccCount[t]=0),e.LfoSync[t]!=V&&(e.LfoC[t]=0)),e.CurWav[t]<s?e.Steps[t]=et[n]+e.Detune[t]*O(et[n],2048):e.L2WL[t]>=2&&(e.Steps[t]=O(1073741824>>>e.L2WL[t]-2,O(et[36],65536))*O(et[n],65536)),e.PorLen[t]=-1))},Play1Por:function(e,t,n,i,a){0>t||t>=r||0>i||i>95||0>n||n>95||(e.Resting[t]=$,e.PorStart[t]=et[n]+e.Detune[t]*O(et[n],2048),e.PorEnd[t]=et[i]+e.Detune[t]*O(et[i],2048),a||(e.ECount[t]=0))},StopMML:function(e,t){0>t||t>=r||(e.WaitMML(t),e.PlayState[t]=Y,e.MCount[t]=e.SeqTime+1)},allWaiting:function(e){for(var t=0;r>t;t++)if(e.PlayState[t]==K)return!1;return!0},handleAllState:function(e){for(var t=!0,n=!0,i=0;r>i;i++)switch(e.PlayState[i]){case K:t=!1;case X:n=!1}if(t&&!n)for(var i=0;r>i;i++)e.RestartMML(i);return n},allStopped:function(e){for(var t=0;r>t;t++)if(e.PlayState[t]!=Y)return!1;return!0},RestartMML:function(e,t){0>t||t>=r||e.PlayState[t]==X&&(e.PlayState[t]=K,e.MCount[t]=e.SeqTime+1)},restartIfAllWaiting:function(e){if(e.allWaiting())for(var t=0;r>t;t++)e.RestartMML(t)},WaitMML:function(e,t){0>t||t>=r||(e.PlayState[t]=X,e.MCount[t]=e.SeqTime+1)},Start:function(e){e.Stop(),e.Rewind(),e.BeginPlay=J,e.startRefreshLoop(),e.playNode()},Rewind:function(e){var t;for(e.SeqTime=0,t=0;r>t;t++)e.soundMode[t]=$,e.MPointC[t]=0,e.PlayState[t]=K,e.MCount[t]=e.SeqTime},Stop:function(e){e.BeginPlay&&(e.stopNode(),e.stopRefreshLoop())},wavOut:function(e){e.Stop(),e.Rewind();for(var t=[],n=e.resolution,i=0;n>i;i++)t.push(0);var r=[];e.writtenSamples=0,e.WavOutMode=!0,e.label2Time=[],e.loopStart=null,e.PC2Time=[];var a=-1,o=e.wavOutSpeed||10;return new Promise(function(t){function i(){for(var s=(new Date).getTime()+o;(new Date).getTime()<=s;){for(var u=0;n>u;u++)r.push(0);e.refreshPSG(r,r.length-n,n),e.writtenSamples+=n;var c=Math.floor(e.writtenSamples/e.sampleRate);if(c>a&&(a=c),e.allStopped())return e.WavOutMode=!1,void t(r)}setTimeout(i,0)}setTimeout(i,0)})},toAudioBuffer:function(e){return e.wavOut().then(function(t){for(var n=e.context.createBuffer(1,t.length,e.sampleRate),i=n.getChannelData(0),r=0;r<i.length;r++)i[r]=t[r];var a={decodedData:n};return e.loopStart&&(a.loopStart=e.loopStart[0]/e.loopStart[1]),a})},SelWav:function(e,t,n){e.CurWav[t]=n,s>n?(e.SccWave[t]=e.WaveDat[n],e.L2WL[t]=5,e.Sync[t]=$):e.PCMW[n-s]!=Q&&(e.SccWave[t]=e.PCMW[n-s].Start,e.L2WL[t]=e.PCMW[n-s].Log2Len,e.Sync[t]=J)},RegPCM:function(e,t,n){console.log("[STUB]regpcm",t.map(function(e){return String.fromCharCode(e)}),n)},refreshPSG:function(e,n,i,a){var o,s,u,V,C,I,j,U,_,q=0,H=0,z=0,Y=0;_=0,C=J,t++;var X=(e.sampleRate/22050,44100/e.sampleRate),et=(new Date).getTime();if(e.allStopped())for(var o=i;i+a>=o;o++)n[o]=0;else{var nt=[],it=e.SeqTime;for(s=0;r>s;s++)if(e.MPoint[s][e.MPointC[s]]==Q&&e.StopMML(s),e.PlayState[s]==K)for(e.PorLen[s]>0&&(Y=e.MCount[s]-it,e.Steps[s]=O(e.PorStart[s],e.PorLen[s])*Y+O(e.PorEnd[s],e.PorLen[s]*(e.PorLen[s]-Y))),H=e.soundMode[s]?e.EVol[s]:e.Resting[s]?0:e.EShape[s][e.ECount[s]>>>11]*e.EVol[s]*e.EBaseVol[s],e.Fading<L&&(H*=O(e.Fading,L)),nt[s]=H,e.ECount[s]+e.ESpeed[s]*(a/2)<65536&&(e.ECount[s]+=e.ESpeed[s]*(a/2)),U=0;e.MCount[s]<=it;){var rt=e.MPointC[s];0==s&&(e.PC2Time[rt]=e.writtenSamples),I=e.MPoint[s][rt+1],j=e.MPoint[s][rt+2];var at=e.MPoint[s][rt];if(at>=0&&96>at||at===c)e.Play1Sound(s,at,e.Slur[s]),e.Slur[s]||(e.LfoDC[s]=e.LfoD[s]),e.Slur[s]=$,e.MCount[s]+=2*(I+256*j),e.MPointC[s]+=3;else switch(at){case g:e.Play1Por(s,I,j,e.Slur[s]),e.Slur[s]=$,e.MCount[s]+=2*(e.MPoint[s][rt+3]+256*e.MPoint[s][rt+4]),e.PorLen[s]=e.MCount[s]-it,e.MPointC[s]+=5;break;case h:e.Tempo=I+256*j,e.MPointC[s]+=3;break;case l:e.EVol[s]=I,e.MPointC[s]+=2;break;case E:e.EBaseVol[s]=I,e.MPointC[s]+=2;break;case f:e.ESpeed[s]=I,e.MPointC[s]+=2;break;case p:e.SelWav(s,I),e.MPointC[s]+=2;break;case w:for(e.MPointC[s]+=34,o=0;32>o;o++)e.WaveDat[I][o]=e.MPoint[s][rt+2+o];break;case y:e.EShape[s]=e.EnvDat[I],e.MPointC[s]+=2;break;case P:for(e.MPointC[s]+=34,o=0;32>o;o++)u=e.MPoint[s][rt+2+o],u>15&&(u=15),e.EnvDat[I][o]=u;break;case m:if(e.WavOutMode){if(0==s){var ot=e.MPointC[s]+G(e.MPoint[s],rt+1),st=e.PC2Time[ot];"number"==typeof st&&st<e.writtenSamples&&(e.loopStart=[st,e.sampleRate],console.log("@jump","ofs=",e.loopStart))}e.MPointC[s]+=5}else e.MPointC[s]+=G(e.MPoint[s],rt+1);U++,U>1&&(console.log("Jumpsafe!"),e.StopMML(s),e.MCount[s]=it+1);break;case k:e.WavOutMode&&0==s&&(e.label2Time[I]=[e.writtenSamples,e.sampleRate],console.log("@label",I,e.MPointC[s],e.writtenSamples+"/"+e.sampleRate)),e.MPointC[s]+=2;break;case d:e.Slur[s]=J,e.MPointC[s]+=1;break;case v:e.WaitMML(s),e.MPointC[s]+=1;break;case T:e.ComStr=Z(e.MPoint[s],rt+1),e.MPointC[s]+=e.ComStr.length+2;break;case A:e.WFilename=Z(e.MPoint[s],rt+1),e.MPointC[s]+=e.WFilename.length+2;break;case S:e.MPointC[s]+=1;break;case b:e.Detune[s]=F(I),e.MPointC[s]+=2;break;case M:e.LfoSync[s]=I,e.LfoV[s]=65536*j,e.LfoA[s]=e.MPoint[s][rt+3],e.LfoD[s]=0,e.MPointC[s]+=4;break;case x:e.LfoD[s]=I*e.sampleRate,e.MPointC[s]+=2;break;case B:e.Sync[s]=1==I,e.MPointC[s]+=2;break;case D:var ut=Z(e.MPoint[s],rt+1);e.RegPCM(ut,e.MPoint[s][rt+1+ut.length+1]),e.MPointC[s]+=ut.length+3;break;case R:e.StopMML(s);break;default:throw new Error("Invalid opcode"+at)}}e.handleAllState(),e.SeqTime+=Math.floor(e.Tempo*(a/120)*X);for(var ct=i;i+a>ct;ct++)n[ct]=0;for(s=0;r>s;s++)if(e.PlayState[s]==K)for(var ct=i;i+a>ct;ct++)C=!C,q=n[ct],H=nt[s],H>0&&(o=N(e.SccCount[s]>>>32-e.L2WL[s]),V=N(e.SccWave[s][o]),N(H),q+=V*H/67108864-H/524288,e.Sync[s]?(e.SccCount[s]<2*-e.Steps[s]||e.SccCount[s]>=0)&&(e.SccCount[s]+=e.Steps[s]):e.SccCount[s]+=e.Steps[s],0!=e.LfoV[s]&&(e.LfoDC[s]>0?e.LfoDC[s]-=e.Tempo:(e.SccCount[s]+=tt[e.LfoC[s]>>>16+W]*O(e.Steps[s],512)*O(e.LfoA[s],256),C&&(e.LfoC[s]+=e.LfoV[s])))),q>1&&(q=1),-1>q&&(q=-1),n[ct]=q,0==s&&(e.WaveDat[95][31&z]=Math.floor(78*Math.random()+90)),z++;e.performance.elapsedTime+=(new Date).getTime()-et,e.performance.writtenSamples+=a,e.performance.writeRate=e.performance.writtenSamples/(e.performance.elapsedTime/1e3*e.sampleRate)}}}),it={};for(var rt in n){var at=/\bt\s*\.\s*([a-zA-Z0-9]+)\b/g;if("function"==typeof n[rt]){{var ot=n[rt]+"";ot.replace(at,function(e,t){n.$fields[t]||null==it[t]&&(it[t]=1)})}it[rt]=0}}return console.log(it),nt}),a.setName("Tones.wdt"),n([],function(){return"data:application/octet-stream;base64,UFBQUFBQUFBQUFBQUFBQULm5ubm5ubm5ubm5ubm5ublnZ2dnZ6einUdETExBTHyao6OZnpNASWqZmJqZMENshm1LOjA6UFZOMys4RVBfZ3iHmKCvwMfUzLGpr8XPxbSSoGdnVUpBQD9BSUpKTlJjfK7BxL+xoHxiVkpPaIGToK1oYVZORkA5NDQ0NjpBSVZgbHuKlaOrrq6tq6Sfk4d8dopORUtVYGJobGdQRTw7RmF4jLO6uK+cmZmZmZqalY6MTkxOS0tLS0tLS0tLS0tLTH2uxc7SzruegVFQUE9PT05GSUdHRkZGRkZGz8/MzMzOz87Oz3dERUVFRUXOztDQSSdPa2xsa2tra2ttbW1ta4yx29rb3MGkim5WQSUlJScnR0lJSUlJSkpKSUlJSUlJSUlKvLy8u7y8u75GRkdHR0fs7OwPSqmfUEtJRTg4ODY2LysrKSkoKh4eHh4eHh4eH05OT09PT09PT09PT09PUFBQUFBQUFBQUFBPT0+4tra2Z2dbOTg7R2eIpK2kmIlsVUxHSlhwhJ+xq6OZmZmZjYiVioFsUS0iICo2TmCClaCzsaVrTEpccZGuurazsK+pop9cY1eRfGtfVUc/dZKecWhtomFjX3aBgXFgVUlAUYeY1ipFVWNseIKMkpmiqK2wubu+wMTFxcbGy8vQ0tHR0tR3iGBXbElAqKuOUk9Yk5OvuLm5ubSgcFZLTGpukpRma2dnZ2dnfpeZl4dwalBOZ2egtbOZeGVmcYKdrbWwrZmZZ2dnZ0c5MzMxMTEzNTk8Z5mZmZmZmcnJx8fGxsXDv7NKQUBUZW1tZV1dY3eUoKqrq5+cnai6xMXAtaWdk4p3YDA8TFZhZ3J8hI6fqrW/z9fs1rypnY2AcWFSRz80LSkgPEFGTlBWV1xdYmhscHN3eHyChoqRlZmeoKKlrbC1usHGv7WupaOak4+IiIR+eXhzbmtnYF1bxsZUUU5JQzs4NmBgYGBhwMC/v7/Dw8PExMPDw2NiZWVlZWVlZWVlYWFlV1dWVlRRVFJSUlTFxcXExMPDw8PDxFBQVFRUVldTVFfHx8fGxcS/v7u5tLCtp6Cal5KOhIB7cm5oYFdOPjgqxauxqZoXipOUZ2eTQ0GIlW2up6+VztDWSXKrpVCoTIOkyz5AQUFBQ0NBP0BGS1FdaHF3goePmaCps7u/xMXFxccjIChdZWBcRx8cGh0rRF11jaW80uBzs6ez29zOqY1qPmxmVjNBPmegtLy1u7iajYyUo6uqpJ+XkY2NjYyKiISZZ2dohIRYW4SEVleUq7q6sI1EREtlkZFbXJOrvr68sZeZmJhnZ2dnZ7a4QUNDP8vR0c/Oy8tFR0eZmZmZmZmZmShmg6q4qYqTpbq7uLWzq6igoJ6Xko2BdmNROC01SkMqAOH3/v/73wDh+v//+eoA6Pj+//nqAOj4///46gDk9vxnZ2dnqKqtgHl1gJSdnZV3cHOCjZyjoJyYl5SUmZmZmUNBRUdLVFhicHt+fn5+fn5+fn5+fn2BiJSns7/ExsbFcHBwcHBtbW1sbGxsbW1sbG1ubXzBw3M1HyApamxtbWzPz8/Oz8nBs5R7Zl1FOTw4RFJgc4mgvsXLy1dSUltix3FwcHBwc3V1dXV1dXNxcXFy1tYgIiJ2dnZ2dnZ1cXFxXDooNVowKDBcMCk1Q1BdeI2kvt3q4Ljd5tyx3+jcqH1mX19mZ2eZmYQ8PkZHSldddYKPlJmZmZmZmZmZmZmTjGdnZ3l4eHl5bFVMSklUgKSxsbawmqqzy76Yk7O+tLCtUTowLVKPsMHS1dHOzMfDtauZgWBFPDEzMTE+XICTjoFnZ2dnW09LXU5FVmNzhJOerrqnj4S/uJmZmZmZmZmZmb5RUElMTrXQ3N3cyYZwbHWOo8HV3dvBnZWOj5mgq7G4fX18gMG/e3h4eXl5fHx8gcG8gjAvLi4uLi4xMTAwL31HxMXGxsbFxcXFxURBPz8/QMPDxMTDw0ZDQ0FGRkdHR5q50OPcv62YhHV2j6u1qo5xVUpUcImKe2dSQCMcL0ZleGtcPDEuJygzYGNjZWZmZ567w8XAqaCOj4+SlJWUlIxlZWVHNjAkJTFQX2BgYGBfYp2qsbGwqJmRjoN8dXJubGdnZ2dUTEtQVFhfZWhxfI2vwMbJyb6qZ1pSRUaZmZmZgIePoLvQ29GwdrDQ3NS+nmFBKyMvT5JPLiQvRF9weH+uvsTEuqBYo7nAwL6vd2FQR0dHandqSklJSUlJSldshv8SfP8NaP7/DAz/B/0DA8T/yw/r++4PbfcSEvX4FBpaUWfJe7Cfqatnq2erqZ9KO5N952qZW4d2c3WGxlCZmdJnZ2dnZ2dnZ2dnZ2dnZ2dnmZmZmZmZmZmZmZmZmZmZmWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZmenJR5d4KSlYRmVlBRUVJnr8fHwbSrpaKelHllZWVugWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlnZ2dnbmBfYmuOvsC5qJKHhIB+fXx8fXFnVVaan5mZmWdnZ2dnZ2dnZ2dnZ2dnZ2eZmZmZmZmZmZmZmZmZmZmZZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlnZ2dnZ2dnZ2dnZ2dnZ2dnmZmZmZmZmZmZmZmZmZmZmWdnZ2dhWoGRhltYZXyap6mfc3FmYXycqa6kj4J9fYGMZ2dnZ2dnZ2dnZ2dnZ2dnZ5mZmZmZmZmZmZmZmZmZmZlzdTw6Oz8/Pz9FR0pPV2Fqc36JjZqgqrC2vL+/vnd3c5pROjQxKycrKysuMDAxNj44ODtKk7zL0NS/jK/A0Mm4Z2dnZ2dnZ2dnZ2dnZ2dnZ5KtwdDMwamNZmdnZ2dnZ2eKg2dfaGt5eYS4mnBmY2VnZ2dna4+rq6t+bnZ2oKOnmLCwZ0k8Ozs7PEBLUltsj6q0ury6mX1RSpi5uFBKh6u5S05Ma2trampqTE5OTk5OecnJysvLra+urq60yc7OzspwcHJy1NbX2NjY1tR1cnV1c3Nzubm2tkNBQUNxcHJycaurq2dnZ2dmY2NqxsbExV9fX2HGycbGxkVEPkA8Ozs7Ii5L/+sAGi9FYXecvtXh7PX5/v7+/v7++/Dr3LAoDRMjIiUCIy8rPDRHUU9GHhMZIDUKCkQqGhoKCQwREy88PoSMnIynoLuoz7i8l6eCcnxXZjlOGE9BbmGCopfGp7iZQUNFTHagya6TcEVDQUFBW2iBmai5xc/Gua2VfWtWTkc7Ozs8tLS0trS0Ojo4ODk5uLi4tra2tbW2tra4tbW1tT5WaHFzbF1QODlLbp21w8/Rz8/Pz9DR0dHR0c65h1Y+coOgu8TDuZ13YEA0MDM/VG2Hmaq1wMXGxsO1p5SAc206c3NzlaeooIhYQzpAZnZ1dsPBwMDBwcHBwHV3dnM7O09wlMXav5d2XUs1IjtGXHWPorDF2MOtmYFxW0s6LygkZ2doMzMzMTNlZWhnlZWVlZWV0NDS0NDQ0NDPmJmZmWeYXC8tLS0tLispKTxlfJGcnaq1uriulJK4trWYlbq4qGdnZ2dnZ2dnZ2dnZ2dnZ2eZqL7Hyb+xnJSEfTEpQJyaZ2dnZ2evsLS5Tjw8RU5PZ5mZmZmZmWhdXF+ZmZmZmZlnZ2eAl56VaFJFQ0VKZ2dnmZmZmZmZmZmZmZmZmZmZmWJnZ2dnZ2dnZ2dnZ2dnZ2eZtb6+saOVh3x5cVQ/QUxfNEFOXWVrc36Hj5yjpaijeJejtsDFys/V1tfX1tXV1SuaUTpYVlZ5WlxdXDAwMWA+ODg7SpO5xtDOz6TQ0Mq8rspnUVFMS1ZztsbHvq+djU9PUGF2iZior7i+wMHDxsnKP1BmZWA4NCozO1eInrPBxYaGg7+/moJRQDAkIyMkKTNbWldXV2d2dmc4ODg5OnmvxcTExMSxV1hYWFiImZmZilqCipRyj5uHomxkmX19hY2giWeHZmSMg5RnmIGZpYFmDw4LCgoJCAcHBgYFBQQEAwMDAgICAgICAgICAgICAgAPDgsKCQkJCAgIBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwEODg4ODg4ODg0MDAwMDAwMDAwLCwsLCwsLCwoKCgoKAgUICgsNDg8PDw8PDw8ODg0NDAwLCwsKCgoJCQgICAcPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQ8PDw8ODg4ODg4ODg4ODg4ODg0NDAwLCgoJCAgGBQQCAQAAAAUHCQoLCwwMDA0NDQ0ODg4ODg0NDQ0NDAwMDAwMDAwBAQECAgIDAwMDBAQFBAQFBQYHBwgJCQoLCwwNDg4ODg8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgYGBgUFBQUFBAQDAwICAgIBAQEBAAAPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQEAAA8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgYGBgUFBQUFBAQDAwICAgIBAQEBAAAPDgwLCgkIBwcGBgYGBQUFBQUEBAMDAgICAgEBAQEAAA8ODAsKCQgHBwYGBgYFBQUFBQQEAwMCAgICAQEBAQAADw4MCwoJCAcHBgcGBgYGBQUFBQYHCAgHCAgBAQEBAAA="}),a.setName("runtime"),i(["ImageList","PicoAudio","T2MediaLib","Tonyu","UIDiag","SEnv","Tones.wdt"],function(e,t,n,i,r,a){console.log("runtimes loaded",arguments),window.PicoAudio||(window.PicoAudio=t),window.T2MediaLib||(window.T2MediaLib=n),window.Mezonet||(window.Mezonet=a)}),a.setName("LSFS"),n(["FS"],function(e){return e.LSFS}),a.setName("NativeFS"),n(["FS"],function(e){return e.NativeFS}),a.setName("runScript2"),i(["FS","compiledTonyuProject","Shell","runtime","WebSite","LSFS","Tonyu","NativeFS"],function(e,t,n,i,r,a,o){$(function(){function i(){return 0}function s(){var e=i();l=$(window).width(),f=$(window).height(),p.attr({width:l-e,height:f-e})}function u(){o.currentProject=o.globals.$currentProject=S;var e=S.getOptions();S.runScriptMode=!0,S.run(e.run.bootClass)}SplashScreen={hide:function(){$("#splash").hide()},show:function(){},progress:function(e){$("#splash").text(e)}};var c=i(),l=$(window).width(),f=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var p=$("<canvas>").attr({width:l-c,height:f-c,"class":"tonyu-canvas"}).appendTo("body");o.globals.$mainCanvas=p;var h=navigator.userAgent.toLowerCase();-1!=h.indexOf("iphone")||-1!=h.indexOf("ipad")||-1!=h.indexOf("ipod")||window.parent&&window!==window.parent||$(window).resize(s);var m;if(r.isNW){var d=process.cwd().replace(/\\/g,"/"),g=location.href.replace(/^chrome-extension:\/\/\w*/,"");T=e.get(d+g),T.isDir()||(T=T.up()),m=T}else{var y=location.href.replace(/\?.*/,"").split(/\//),g=y.pop()||"runscript",v=y.pop()||"nobody",T=e.get(r.tonyuHome),b=e.get("/ram/");e.mount(b.path(),a.ramDisk()),m=b;var A=T.rel(v+"/"+g+"/");b.rel("files/").link(A)}loadFiles(m),n.cd(m),r.compiledKernel="js/kernel.js","BA"===r.serverType&&window.runtimePath&&(r.compiledKernel=window.runtimePath+"lib/tonyu/kernel.js");var S=t("user","js/concat.js",m);u()})}),a.setName()});