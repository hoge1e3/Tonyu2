!function(){var e={};return e.def=function(t,i,n){var r=e.getModuleInfo(e.curName);r.type=n,e.setReqs(r,t),r.func=function(){return i.apply(this,e.getObjs(t))},e.loadIfAvailable(r)},define=function(){var t=Array.prototype.slice.call(arguments);"string"==typeof t[0]&&(e.curName=t.shift());var i=t.shift(),n=t.shift();e.def(i,n,"define")},define.amd={jQuery:!0},requirejs=function(t,i){e.def(t,i,"require")},e.setReqs=function(t,i){i.forEach(function(i){var n=e.getModuleInfo(i);n.loaded||(t.reqs[i]=n,n.revReqs[t.name]=t)})},e.getModuleInfo=function(t){var i=e.modules;return i[t]||(i[t]={name:t,reqs:{},revReqs:{}}),i[t]},e.doLoad=function(t){var i=e.getModuleInfo(t);if(i.loaded)return i.obj;i.loaded=!0;var n=null;if(i.func)n=i.func();else{var r=t.split(/\./);n=function(){return this}(),r.forEach(function(e){n&&(n=n[e])}),null==n&&console.log("Warning: No obj for "+t)}if("define"==i.type&&null==n)throw"No obj for "+t;i.obj=n;for(var a in i.revReqs)e.notifyLoaded(i.revReqs[a],i.name);return n},e.notifyLoaded=function(t,i){delete t.reqs[i],e.loadIfAvailable(t)},e.loadIfAvailable=function(t){for(var i in t.reqs)return;e.doLoad(t.name)},e.getObjs=function(t){var i=[];return t.forEach(function(t){var n=e.doLoad(t);i.push(n)}),i},e.modules={},e.setName=function(t){e.curName&&(e.getModuleInfo(e.curName).func||e.doLoad(e.curName)),t&&(e.curName=t)},requireSimulator=e,e}(),requireSimulator.setName("extend"),define([],function(){return function(e,t){for(var i in t)e[i]=t[i]}}),requireSimulator.setName("assert"),define([],function(){function e(t){if(t instanceof Array){var i=[];return t.forEach(function(t){i=i.concat(e(t))}),i}return[t]}var t,i=function(t){this.failMesg=e(t||"Assertion failed: ")};i.prototype={_regedType:{},registerType:function(e,t){this._regedType[e]=t},MODE_STRICT:"strict",MODE_DEFENSIVE:"defensive",MODE_BOOL:"bool",fail:function(){var i=t(arguments),n=i.shift();if(i=e(i),i=this.failMesg.concat(n).concat(i).concat(["mode",this._mode]),console.log.apply(console,i),this.isDefensive())return n;if(this.isBool())return!1;throw new Error(i.join(" "))},subAssertion:function(){var n=t(arguments);return n=e(n),new i(this.failMesg.concat(n))},assert:function(e,t){return e?e:this.fail(e,t)},eq:function(e,t){return e!==t?this.fail(e,"!==",t):this.isBool()?!0:e},ne:function(e,t){return e===t?this.fail(e,"===",t):this.isBool()?!0:e},isset:function(e,t){return null==e?this.fail(e,(t||"")+" is null/undef"):this.isBool()?!0:e},is:function(e,t){var i=t,n=e;if(null==i)return this.fail(e,"assert.is: type must be set");if(i._assert_func)return i._assert_func.apply(this,[n]),this.isBool()?!0:e;if(this.assert(null!=e,[e,"should be ",i]),i instanceof Array||"object"==typeof global&&"function"==typeof global.Array&&i instanceof global.Array){if(!e||"number"!=typeof e.length)return this.fail(e,"should be array:");for(var r=this,a=0;a<i.length;a++){var o=r.subAssertion("failed at ",e,"[",a,"]: ");null==i[a]&&console.log("WOW!7",n[a],i[a]),o.is(n[a],i[a])}return this.isBool()?!0:e}if(i===String||"string"==i)return this.assert("string"==typeof n,[n,"should be a string "]),this.isBool()?!0:e;if(i===Number||"number"==i)return this.assert("number"==typeof n,[n,"should be a number"]),this.isBool()?!0:e;if(i instanceof RegExp||"object"==typeof global&&"function"==typeof global.RegExp&&i instanceof global.RegExp)return this.is(n,String),this.assert(i.exec(n),[n,"does not match to",i]),this.isBool()?!0:e;if(i===Function)return this.assert("function"==typeof n,[n,"should be a function"]),this.isBool()?!0:e;if("function"==typeof i)return this.assert(n instanceof i,[n,"should be ",i]),this.isBool()?!0:e;if(i&&"object"==typeof i){for(var s in i){var o=this.subAssertion("failed at ",e,".",s,":");o.is(e[s],i[s])}return this.isBool()?!0:e}if("string"==typeof i){var u=this._regedType[i];return u?this.is(e,u):this.isBool()?!0:e}return this.fail(e,"Invaild type: ",i)},ensureError:function(e,t){try{e()}catch(i){return"string"==typeof t&&r(i+""===t,e+" thrown an error "+i+" but expected:"+t),void console.log("Error thrown successfully: ",i.message)}this.fail(e,"should throw an error",t)},setMode:function(e){this._mode=e},isDefensive:function(){return this._mode===this.MODE_DEFENSIVE},isBool:function(){return this._mode===this.MODE_BOOL},isStrict:function(){return!this.isDefensive()&&!this.isBool()}},t=function(e){for(var t=[],i=0;i<e.length;i++)t.push(e[i]);return t};var n=new i,r=function(){try{return n.assert.apply(n,arguments)}catch(e){throw new Error(e.message)}};return["setMode","isDefensive","is","isset","ne","eq","ensureError"].forEach(function(e){r[e]=function(){try{return n[e].apply(n,arguments)}catch(t){throw console.log(t.stack),new Error(t.message)}}}),r.fail=n.fail.bind(n),r.MODE_STRICT=n.MODE_STRICT,r.MODE_DEFENSIVE=n.MODE_DEFENSIVE,r.MODE_BOOL=n.MODE_BOOL,r.f=function(e){return{_assert_func:e}},r.opt=function(e){return r.f(function(t){return null==t||t instanceof e})},r.and=function(){var e=t(arguments);return r(e instanceof Array),r.f(function(t){for(var i=this,n=0;n<e.length;n++)i.is(t,e[n])})},r}),requireSimulator.setName("PathUtil"),define(["assert"],function(e){function t(t,i){return e.is(arguments,[String,String]),t.substring(t.length-i.length)===i}function i(t,i){return e.is(arguments,[String,String]),t.substring(0,i.length)===i}var n,r=/^([a-zA-Z]):/,a=/^([a-z]+):\/\/\/?([^\/]+)\//,o=e.f(function(e){this.is(e,String),this.assert(n.isPath(e),[e," is not a path"])}),s=e.f(function(e){this.is(e,String),this.assert(n.isAbsolutePath(e),[e," is not a absolute path"])}),u=e.f(function(e){this.is(e,String),this.assert(!n.isAbsolutePath(e),[e," is not a relative path"])}),c=e.f(function(e){this.is(e,o),this.assert(n.isDir(e),[e," is not a directory path"])}),l=e.and(c,s),f=e.f(function(e){this.is(e,o),this.assert(!n.isDir(e),[e," is not a file path"])}),h="/";return n={Path:o,Absolute:s,Relative:u,Dir:c,File:f,AbsDir:l,SEP:h,endsWith:t,startsWith:i,hasDriveLetter:function(e){return r.exec(e)},isURL:function(e){var t=a.exec(e);if(t)return{protocol:t[1],hostPort:t[2],path:h+e.substring(t[0].length)}},isPath:function(){return e.is(arguments,[String]),!0},isRelativePath:function(t){return e.is(arguments,[String]),n.isPath(t)&&!n.isAbsolutePath(t)},isAbsolutePath:function(t){return e.is(arguments,[String]),n.isPath(t)&&(n.startsWith(t,h)||n.hasDriveLetter(t)||n.isURL(t))},isDir:function(i){return i=n.fixSep(i),e.is(arguments,[o]),t(i,h)},fixSep:function(t){return e.is(arguments,[String]),e.is(t.replace(/\\/g,"/"),o)},directorify:function(t){return t=n.fixSep(t),n.isDir(t)?t:e.is(t+h,c)},filify:function(t){return t=n.fixSep(t),n.isDir(t)?e.is(t.substring(0,t.length-1),f):t},splitPath:function(t){e.is(arguments,[o]);var i;if(i=this.isURL(t)){var n=this.splitPath(i.path);return n[0]=i.protocol+"://"+i.hostPort,n}t=t.replace(/\/+/g,h);var r=t.split(h);return""==r[r.length-1]&&(r[r.length-2]+=h,r.pop()),r},name:function(t){return e.is(arguments,[String]),n.splitPath(t).pop()},ext:function(t){e.is(arguments,[String]);var i=n.name(t),r=/\.[a-zA-Z0-9]+$/.exec(i);return r?r[0]:null},truncExt:function(t,i){e.is(t,String);var r=n.name(t);return i=i||n.ext(t),e.is(i,String),r.substring(0,r.length-i.length)},truncSEP:function(t){return e.is(arguments,[o]),n.isDir(t)?t.substring(0,t.length-1):t},endsWith:function(i,r){return e.is(arguments,[String,String]),t(n.name(i),r)},parent:function(t){return e.is(arguments,[String]),n.up(t)},rel:function(t,i){if(""==i)return t;e.is(arguments,[l,u]);var r=n.splitPath(i),a=t;a=a.replace(/\/$/,"");var o=n;return r.forEach(function(e){".."==e||"../"==e?a=o.up(a):(a=a.replace(/\/$/,""),a+=h+("."==e||"./"==e?"":e))}),a},relPath:function(t,i){return e.is(arguments,[s,s]),t.substring(0,i.length)!=i?"../"+n.relPath(t,this.up(i)):t.substring(i.length)},up:function(e){if(e=n.fixSep(e),e==h)return null;var t=n.splitPath(e);return t.pop(),t.join(h)+h}},n.isAbsolute=n.isAbsolutePath,n.isRelative=n.isRelativePath,"object"==typeof window&&(window.PathUtil=n),n}),requireSimulator.setName("MIMETypes"),define([],function(){return{".png":"image/png",".gif":"image/gif",".jpeg":"image/jpeg",".jpg":"image/jpeg",".ico":"image/icon",".mp3":"audio/mp3",".ogg":"audio/ogg",".mp4":"video/mp4",".m4a":"audio/x-m4a",".mid":"audio/mid",".midi":"audio/mid",".wav":"audio/wav",".txt":"text/plain",".html":"text/html",".htm":"text/html",".css":"text/css",".js":"text/javascript",".json":"text/json",".zip":"application/zip",".swf":"application/x-shockwave-flash",".pdf":"application/pdf",".doc":"application/word",".xls":"application/excel",".ppt":"application/powerpoint",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".docm":"application/vnd.ms-word.document.macroEnabled.12",".dotx":"application/vnd.openxmlformats-officedocument.wordprocessingml.template",".dotm":"application/vnd.ms-word.template.macroEnabled.12",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xlsm":"application/vnd.ms-excel.sheet.macroEnabled.12",".xltx":"application/vnd.openxmlformats-officedocument.spreadsheetml.template",".xltm":"application/vnd.ms-excel.template.macroEnabled.12",".xlsb":"application/vnd.ms-excel.sheet.binary.macroEnabled.12",".xlam":"application/vnd.ms-excel.addin.macroEnabled.12",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".pptm":"application/vnd.ms-powerpoint.presentation.macroEnabled.12",".potx":"application/vnd.openxmlformats-officedocument.presentationml.template",".potm":"application/vnd.ms-powerpoint.template.macroEnabled.12",".ppsx":"application/vnd.openxmlformats-officedocument.presentationml.slideshow",".ppsm":"application/vnd.ms-powerpoint.slideshow.macroEnabled.12",".ppam":"application/vnd.ms-powerpoint.addin.macroEnabled.12",".tonyu":"text/tonyu"}}),requireSimulator.setName("FS2"),define(["extend","PathUtil","MIMETypes","assert"],function(e,t,i,n){function r(e){throw new Error(e+" is STUB!")}var a=function(){},o={};return a.addFSType=function(e,t){o[e]=t},a.availFSTypes=function(){return o},e(a.prototype,{err:function(e,t){throw new Error(e+": "+t)},fstype:function(){return"Unknown"},isReadOnly:function(){r("isReadOnly")},supportsSync:function(){return!0},resolveFS:function(e){return n(this.getRootFS()!==this),this.getRootFS().resolveFS(e)},mounted:function(e,t){this.rootFS=e,this.mountPoint=t},inMyFS:function(e){return!this.mountPoint||t.startsWith(e,this.mountPoint)},getRootFS:function(){return n(this.rootFS,"rootFS is not set")},getReturnTypes:function(){r("")},getContent:function(){r("getContent")},getContentAsync:function(){return this.supportsSync()||r("getContentAsync"),$.when(this.getContent.apply(this,arguments))},setContent:function(){r("")},setContentAsync:function(e,t,i){var n=this;return n.supportsSync()||r("setContentAsync"),$.when(t).then(function(t){return $.when(n.setContent(e,t,i))})},getMetaInfo:function(){r("")},setMetaInfo:function(){r("")},mkdir:function(){r("mkdir")},touch:function(){r("touch")},exists:function(){r("exists")},opendir:function(){r("opendir")},cp:function(e,i,r){n.is(arguments,[t.Absolute,t.Absolute]),this.assertExist(e),r=r||{};var a=this.isDir(e),o=this.getRootFS().resolveFS(i),s=o.isDir(i);if(a||s)throw new Error("only file to file supports");if(this.supportsSync()&&o.supportsSync()){var u=this.getContent(e),c=o.setContent(i,u);return r.a&&o.setMetaInfo(i,this.getMetaInfo(e)),c}return o.setContentAsync(i,this.getContentAsync(e)).then(function(t){return r.a?o.setMetaInfo(i,this.getMetaInfo(e)):t})},mv:function(e,t,i){return this.cp(e,t,i),this.rm(e,{r:!0})},rm:function(){r("")},link:function(e,t){throw new Error("ln "+t+" "+e+" : This FS not support link.")},getURL:function(){r("")}}),a.delegateMethods=function(e,i){for(var r in i)!function(r){n.ne(r,"inMyFS"),e[r]=function(){var e=arguments[0];n.is(e,t.Absolute);var a=this.resolveFS(e);return a!==this?a[r].apply(a,arguments):i[r].apply(this,arguments)}}(r)},a.delegateMethods(a.prototype,{assertWriteable:function(e){this.isReadOnly(e)&&this.err(e,"read only.")},getContentType:function(e,n){var r=(t.ext(e)+"").toLowerCase();return i[r]||(n||{}).def||"text/plain"},isText:function(e){var i=this.getContentType(e);return t.startsWith(i,"text")},assertExist:function(e,i){this.exists(e,i)||this.err(e,": No such "+(t.isDir(e)?"directory":"file"))},isDir:function(e){return t.isDir(e)},find:function(e,i){n.is(arguments,[t.Absolute]);var r=this.opendir(e,i),a=this,o=[e];return r.forEach(function(n){var r=t.rel(e,n);if(t.isDir(r)){var s=a.resolveFS(r);o=o.concat(s.find(r,i))}else o.push(r)}),o},resolveLink:function(e){n.is(e,t.Absolute);for(var i=e;i;i=t.up(i)){n(!this.mountPoint||t.startsWith(i,this.mountPoint),i+" is out of mountPoint. path="+e);var r=this.isLink(i);if(r){n(r!=i,"l==p=="+r);var a=t.rel(r,t.relPath(e,i));return n(a!=e,"np==path=="+a),n.is(this.getRootFS().resolveFS(a).resolveLink(a),t.Absolute)}if(this.exists(i))return e}return e},isLink:function(){return null}}),a}),requireSimulator.setName("WebSite"),define(["PathUtil"],function(e){var t,i=document.location.href,n=!!i.match(/html\/dev\//)&&!!i.match(/localhost:3/);if(i.match(/jsrun\.it/))t={urlAliases:{"images/Ball.png":"http://jsrun.it/assets/9/X/T/b/9XTbt.png","images/base.png":"http://jsrun.it/assets/6/F/y/3/6Fy3B.png","images/Sample.png":"http://jsrun.it/assets/s/V/S/l/sVSlZ.png","images/neko.png":"http://jsrun.it/assets/f/D/z/z/fDzze.png","images/mapchip.png":"http://jsrun.it/assets/f/u/N/v/fuNvz.png","images/inputPad.png":"http://jsrun.it/assets/r/K/T/Y/rKTY9.png"},top:"",devMode:n,pluginTop:"http://tonyuedit.appspot.com/js/plugins",removeJSOutput:!0};else if(i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)||i.match(/\/html\/((dev)|(build))\//))t={urlAliases:{"images/Ball.png":"../../images/Ball.png","images/base.png":"../../images/base.png","images/Sample.png":"../../images/Sample.png","images/neko.png":"../../images/neko.png","images/inputPad.png":"../../images/inputPad.png","images/mapchip.png":"../../images/mapchip.png","images/sound.png":"../../images/sound.png","images/sound_ogg.png":"../../images/sound_ogg.png","images/sound_mp3.png":"../../images/sound_mp3.png","images/sound_mp4.png":"../../images/sound_mp4.png","images/sound_m4a.png":"../../images/sound_m4a.png","images/sound_mid.png":"../../images/sound_mid.png","images/sound_wav.png":"../../images/sound_wav.png","images/ecl.png":"../../images/ecl.png"},top:"../..",devMode:n};else if(i.match(/bitarrow/)||i.match(/localhost.*pub/)){t={};var r=t;t.serverType="BA",r.runtime="../../../runtime/",r.urlAliases={"images/base.png":r.runtime+"images/base.png","images/Sample.png":r.runtime+"images/Sample.png","images/neko.png":r.runtime+"images/neko.png","images/inputPad.png":r.runtime+"images/inputPad.png","images/mapchip.png":r.runtime+"images/mapchip.png","images/sound.png":r.runtime+"images/sound.png","images/sound_ogg.png":r.runtime+"images/sound_ogg.png","images/sound_mp3.png":r.runtime+"images/sound_mp3.png","images/sound_mp4.png":r.runtime+"images/sound_mp4.png","images/sound_m4a.png":r.runtime+"images/sound_m4a.png","images/sound_mid.png":r.runtime+"images/sound_mid.png","images/sound_wav.png":r.runtime+"images/sound_wav.png","images/ecl.png":r.runtime+"images/ecl.png"}}else t={urlAliases:{},top:".",devMode:n};var a=window.navigator.userAgent.toLowerCase();return t.tablet=-1!=a.indexOf("windows")&&-1!=a.indexOf("touch")||-1!=a.indexOf("ipad")||-1!=a.indexOf("android")&&-1==a.indexOf("mobile")||-1!=a.indexOf("firefox")&&-1!=a.indexOf("tablet")||-1!=a.indexOf("kindle")||-1!=a.indexOf("silk")||-1!=a.indexOf("playbook"),t.mobile=-1!=a.indexOf("windows")&&-1!=a.indexOf("phone")||-1!=a.indexOf("iphone")||-1!=a.indexOf("ipod")||-1!=a.indexOf("android")&&-1!=a.indexOf("mobile")||-1!=a.indexOf("firefox")&&-1!=a.indexOf("mobile")||-1!=a.indexOf("blackberry"),t.pluginTop||(t.pluginTop=t.top+"/js/plugins"),t.disableROM={},i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:8888/),(i.match(/\.appspot\.com/)||i.match(/localhost:888[87]/))&&(t.serverType="GAE"),i.match(/localhost:3000/)&&(t.serverType="Node"),t.serverTop=i.match(/tonyuexe\.appspot\.com/)||i.match(/localhost:8887/)?t.top+"/exe":t.top+"/edit",t.sampleImg=t.top+"/images",t.blobPath=t.serverTop+"/serveBlob",t.isNW="object"==typeof process&&(process.__node_webkit||process.__nwjs),t.mp3Disabled=t.isNW,t.tonyuHome="/Tonyu/",t.url={getDirInfo:t.serverTop+"/getDirInfo",getFiles:t.serverTop+"/File2LSSync",putFiles:t.serverTop+"/LS2FileSync"},t.isNW?(t.cwd=e.directorify(process.cwd()),t.tonyuHome=process.env.TONYU_HOME?e.directorify(process.env.TONYU_HOME):e.rel(t.cwd,"fs/Tonyu/"),t.logdir=process.env.TONYU_LOGDIR,t.wwwDir=e.rel(t.cwd,"www/"),t.platform=process.platform,t.ffmpeg=e.rel(t.cwd,"win32"==t.platform?"ffmpeg/bin/ffmpeg.exe":"ffmpeg/bin/ffmpeg"),t.pkgInfo=require(e.rel(t.cwd,"package.json")),t.projects=process.env.TONYU_PROJECTS?process.env.TONYU_PROJECTS.replace(/\\/g,"/").split(require("path").delimiter):t.pkgInfo&&t.pkgInfo.config&&t.pkgInfo.config.prjDirs?t.pkgInfo.config.prjDirs.map(function(i){return i=e.directorify(i),e.isAbsolute(i)?i:e.rel(t.cwd,i)}):[e.rel(t.cwd,"Projects/"),e.rel(t.tonyuHome,"Projects/")],t.kernelDir=e.rel(t.wwwDir,"Kernel/")):(t.wwwDir=location.protocol+"//"+location.host+"/",t.projects=[e.rel(t.tonyuHome,"Projects/")]),(i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/))&&(t.kernelDir=location.protocol+"//"+location.host+"/Kernel/"),t.compiledKernel=i.match(/tonyuedit\.appspot\.com/)||i.match(/localhost:888/)||t.isNW?t.top+"/Kernel/js/concat.js":"BA"===t.serverType?t.runtime+"lib/tonyu/kernel.js":"http://tonyuexe.appspot.com/Kernel/js/concat.js",window.WebSite=t}),requireSimulator.setName("Util"),Util=function(){function e(e,i){null==i&&(i=""),e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+e+"=([^&#]*)"),r=n.exec(window.location.href);return null==r?i:t(r[1])}function t(e){return decodeURIComponent(e.replace(/\+/g,"%20"))}function i(e,t){return e.substring(e.length-t.length)===t}function n(e,t){return e.substring(0,t.length)===t}function r(e){function t(t){throw console.log(t),console.log(e,c),new Error(t)}e=e.replace(/[\n=]/g,"");var i=new Object;i[65]=0,i[66]=1,i[67]=2,i[68]=3,i[69]=4,i[70]=5,i[71]=6,i[72]=7,i[73]=8,i[74]=9,i[75]=10,i[76]=11,i[77]=12,i[78]=13,i[79]=14,i[80]=15,i[81]=16,i[82]=17,i[83]=18,i[84]=19,i[85]=20,i[86]=21,i[87]=22,i[88]=23,i[89]=24,i[90]=25,i[97]=26,i[98]=27,i[99]=28,i[100]=29,i[101]=30,i[102]=31,i[103]=32,i[104]=33,i[105]=34,i[106]=35,i[107]=36,i[108]=37,i[109]=38,i[110]=39,i[111]=40,i[112]=41,i[113]=42,i[114]=43,i[115]=44,i[116]=45,i[117]=46,i[118]=47,i[119]=48,i[120]=49,i[121]=50,i[122]=51,i[48]=52,i[49]=53,i[50]=54,i[51]=55,i[52]=56,i[53]=57,i[54]=58,i[55]=59,i[56]=60,i[57]=61,i[43]=62,i[47]=63;var n,r=e.length,a=0,o=0;if(!r)return new ArrayBuffer(0);n=Math.floor(r/4*3),"="==e.charAt(r-1)&&(n-=1),"="==e.charAt(r-2)&&(n-=1);for(var s=new ArrayBuffer(n),u=new Uint8Array(s),c=0,l=0;n>l&&(o=i[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),a=o<<2,c++,o=i[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o>>4&3,a=(15&o)<<4,c++,l++,!(l>=n))&&(o=i[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o>>2&15,a=(3&o)<<6,c++,l++,!(l>=n));)o=i[e.charCodeAt(c)],void 0===o&&t("Invalid letter: "+e.charCodeAt(c)),u[l]=a|o,c++,l++;return s}function a(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],i="",n=new Uint8Array(e),r=n.length,a=0,o=0,s=0;r>s&&(o=n[s],i+=t[o>>2],a=(3&o)<<4,s++,!(s>=r))&&(o=n[s],i+=t[a|o>>4],a=(15&o)<<2,s++,!(s>=r));)o=n[s],i+=t[a|o>>6],i+=t[63&o],s++;var u=r%3;return u&&(i+=t[a]),1==u?i+="==":2==u&&(i+="="),i}function o(e){if(e.__privatized)return e;var t={__privatized:!0};for(var i in e)!function(i){var n=e[i];i.match(/^_/)||"function"==typeof n&&(t[i]=function(){var t=n.apply(e,arguments);return t})}(i);return t}function s(){return"undefined"!=typeof Buffer}function u(e){return s()&&e instanceof Buffer}function c(e){return e instanceof ArrayBuffer||u(e)}function l(e){for(var t=[],i=0;i<e.length;i++)t.push("%"+("0"+e[i].toString(16)).slice(-2));try{return decodeURIComponent(t.join(""))}catch(n){throw console.log(t.join("")),n}}function f(e,t){for(var i=encodeURIComponent(e),n=/^%(..)/,r=[],a=0;a<i.length;a++){var o=n.exec(i.substring(a));o?(r.push(parseInt("0x"+o[1])),a+=o[0].length-1):r.push(i.charCodeAt(a))}return"undefined"!=typeof Buffer&&t===Buffer?new Buffer(r):new Uint8Array(r).buffer}return{getQueryString:e,endsWith:i,startsWith:n,Base64_To_ArrayBuffer:r,Base64_From_ArrayBuffer:a,utf8bytes2str:l,str2utf8bytes:f,privatize:o,hasNodeBuffer:s,isNodeBuffer:u,isBuffer:c}}(),requireSimulator.setName("DataURL"),define(["extend","assert","Util"],function(e,t,i){function n(e,t){function n(t){throw console.log(t),console.log(e,h),new Error(t)}var r=t;e=e.replace(/[\n=]/g,"");var a=new Object;a[65]=0,a[66]=1,a[67]=2,a[68]=3,a[69]=4,a[70]=5,a[71]=6,a[72]=7,a[73]=8,a[74]=9,a[75]=10,a[76]=11,a[77]=12,a[78]=13,a[79]=14,a[80]=15,a[81]=16,a[82]=17,a[83]=18,a[84]=19,a[85]=20,a[86]=21,a[87]=22,a[88]=23,a[89]=24,a[90]=25,a[97]=26,a[98]=27,a[99]=28,a[100]=29,a[101]=30,a[102]=31,a[103]=32,a[104]=33,a[105]=34,a[106]=35,a[107]=36,a[108]=37,a[109]=38,a[110]=39,a[111]=40,a[112]=41,a[113]=42,a[114]=43,a[115]=44,a[116]=45,a[117]=46,a[118]=47,a[119]=48,a[120]=49,a[121]=50,a[122]=51,a[48]=52,a[49]=53,a[50]=54,a[51]=55,a[52]=56,a[53]=57,a[54]=58,a[55]=59,a[56]=60,a[57]=61,a[43]=62,a[47]=63;var o,s=e.length,u=0,c=0;if(!s)return new r(0);o=Math.floor(s/4*3),"="==e.charAt(s-1)&&(o-=1),"="==e.charAt(s-2)&&(o-=1);for(var l=new r(o),f=i.isNodeBuffer(l)?l:new Uint8Array(l),h=0,p=0;o>p&&(c=a[e.charCodeAt(h)],void 0===c&&n("Invalid letter: "+e.charCodeAt(h)),u=c<<2,h++,c=a[e.charCodeAt(h)],void 0===c&&n("Invalid letter: "+e.charCodeAt(h)),f[p]=u|c>>4&3,u=(15&c)<<4,h++,p++,!(p>=o))&&(c=a[e.charCodeAt(h)],void 0===c&&n("Invalid letter: "+e.charCodeAt(h)),f[p]=u|c>>2&15,u=(3&c)<<6,h++,p++,!(p>=o));)c=a[e.charCodeAt(h)],void 0===c&&n("Invalid letter: "+e.charCodeAt(h)),f[p]=u|c,h++,p++;return t===Uint8Array?f:l}function r(e){for(var t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n="",r=i.isNodeBuffer(e)?e:new Uint8Array(e),a=r.length,o=0,s=0,u=0;a>u&&(s=r[u],n+=t[s>>2],o=(3&s)<<4,u++,!(u>=a))&&(s=r[u],n+=t[o|s>>4],o=(15&s)<<2,u++,!(u>=a));)s=r[u],n+=t[o|s>>6],n+=t[63&s],u++;var c=a%3;return c&&(n+=t[o]),1==c?n+="==":2==c&&(n+="="),n}var a=i.hasNodeBuffer()?Buffer:ArrayBuffer,o=(i.isNodeBuffer,i.isBuffer),s=function(e,i){"string"==typeof e?(this.url=e,this.binType=i||a,this.dataURL2bin(e)):e&&o(e.buffer)?(this.buffer=e.buffer,t.is(i,String),this.contentType=i,this.bin2dataURL(this.buffer,this.contentType)):o(e)?(this.buffer=e,t.is(i,String),this.contentType=i,this.bin2dataURL(this.buffer,this.contentType)):(console.log(arguments),t.fail("Invalid args: ",arguments))};return s.isBuffer=o,e(s.prototype,{bin2dataURL:function(e,i){t(o(e)),t.is(i,String);var n=this.dataHeader(i),a=r(e);return t.is(a,String),this.url=n+a},dataURL2bin:function(e){t.is(arguments,[String]);var i=/^data:([^;]+);base64,/i,r=i.exec(e);return t(r,["malformed dataURL:",e]),this.contentType=r[1],this.buffer=n(e.substring(r[0].length),this.binType),t.is(this.buffer,this.binType)},dataHeader:function(e){return t.is(arguments,[String]),"data:"+e+";base64,"},toString:function(){return t.is(this.url,String)}}),s}),requireSimulator.setName("Content"),define(["DataURL","Util","assert"],function(e,t,i){var n=function(){},r=(t.isNodeBuffer,t.isBuffer);n.plainText=function(e,t){var i=new n;return i.contentType=t||"text/plain",i.plain=e,i},n.url=function(e){var t=new n;return t.url=e,t},n.buffer2ArrayBuffer=function(e){return t.isBuffer(e)?(e=Array.prototype.slice.call(e),i.is(new Uint8Array(e).buffer,ArrayBuffer)):i(e,"n2a: a is not set")},n.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return i(e,"a2n: a is not set")},n.bin=function(e,a){i(a,"contentType should be set");var o=new n;if(e&&r(e.buffer))o.arrayBuffer=e.buffer;else if(t.isNodeBuffer(e))o.nodeBuffer=e;else{if(!(e instanceof ArrayBuffer))throw new Error(e+" is not a bin");o.arrayBuffer=e}return o.contentType=a,o};var a=n.prototype;return a.toBin=function(i){if(i=i||(t.hasNodeBuffer()?Buffer:ArrayBuffer),this.nodeBuffer)return i===Buffer?this.nodeBuffer:this.arrayBuffer=n.buffer2ArrayBuffer(this.nodeBuffer);if(this.arrayBuffer)return i===ArrayBuffer?this.arrayBuffer:this.nodeBuffer=n.arrayBuffer2Buffer(this.arrayBuffer);if(this.url){var r=new e(this.url,i);return this.setBuffer(r.buffer)}if(null!=this.plain)return this.setBuffer(t.str2utf8bytes(this.plain,i));throw new Error("No data")},a.setBuffer=function(e){return i(e,"b is not set"),t.isNodeBuffer(e)?this.nodeBuffer=e:this.arrayBuffer=e},a.toArrayBuffer=function(){return this.toBin(ArrayBuffer)},a.toNodeBuffer=function(){return this.toBin(Buffer)},a.toURL=function(){if(this.url)return this.url;if(this.arrayBuffer||null==this.plain||(this.arrayBuffer=t.str2utf8bytes(this.plain,ArrayBuffer)),this.arrayBuffer||this.nodeBuffer){var i=new e(this.arrayBuffer||this.nodeBuffer,this.contentType);return this.url=i.url}throw new Error("No data")},a.toPlainText=function(){if(null!=this.plain)return this.plain;if(this.url&&!this.hasBin()){var i=new e(this.url,ArrayBuffer);this.arrayBuffer=i.buffer}if(this.hasBin())return this.plain=t.utf8bytes2str(this.nodeBuffer||new Uint8Array(this.arrayBuffer));throw new Error("No data")},a.hasURL=function(){return this.url},a.hasPlainText=function(){return null!=this.plain},a.hasBin=function(){return this.nodeBuffer||this.arrayBuffer},a.hasNodeBuffer=function(){return this.nodeBuffer},a.hasArrayBuffer=function(){return this.arrayBuffer},n}),requireSimulator.setName("NativeFS"),define(["FS2","assert","PathUtil","extend","MIMETypes","DataURL","Content"],function(e,t,i,n,r,a,o){var s="object"==typeof process&&(process.__node_webkit||process.__nwjs);if(!s)return function(){throw new Error("This system not suppert native FS")};var u=t,c=require("fs"),l=function(e){e&&(t.is(e,i.AbsDir),this.rootPoint=e)},f=i.hasDriveLetter(process.cwd());l.available=!0;var h=i.SEP,p=l.prototype=new e;return p.toNativePath=function(e){return this.rootPoint?(t.is(e,i.Absolute),t(this.inMyFS(e),e+" is not fs of "+this),i.rel(this.rootPoint,i.relPath(e,this.mountPoint||i.SEP))):e},p.arrayBuffer2Buffer=function(e){if(e instanceof ArrayBuffer){var t=new Buffer(new Uint8Array(e));return t}return e},e.addFSType("NativeFS",function(e,t){return new l(t.r)}),l.prototype.fstype=function(){return"Native"+(this.rootPoint?"("+this.rootPoint+")":"")},l.prototype.inMyFS=function(e){return this.mountPoint?i.startsWith(e,this.mountPoint):!(!!f^!!i.hasDriveLetter(e))},e.delegateMethods(l.prototype,{getReturnTypes:function(){return u.is(arguments,[String]),{getContent:ArrayBuffer,opendir:[String]}},getContent:function(e,n){n=n||{},t.is(e,i.Absolute);var r=this.toNativePath(e);return this.assertExist(e),this.isText(e)?o.plainText(c.readFileSync(r,{encoding:"utf8"})):o.bin(c.readFileSync(r),this.getContentType(e))},setContent:function(e,n){t.is(arguments,[i.Absolute,o]);var r=i.up(e);r&&this.getRootFS().resolveFS(r).mkdir(r);var a=this.toNativePath(e);n.hasBin()||!n.hasPlainText()?c.writeFileSync(a,n.toNodeBuffer()):c.writeFileSync(a,n.toPlainText())},getMetaInfo:function(e,t){this.assertExist(e,t);var i=this.stat(e);return i.lastUpdate=i.mtime.getTime(),i},setMetaInfo:function(){},isReadOnly:function(){return!1},stat:function(e){t.is(e,i.Absolute);var n=this.toNativePath(e);return c.statSync(n)},mkdir:function(e){if(u.is(arguments,[i.Absolute]),this.exists(e)){if(this.isDir(e))return;throw new Error(this+" is a file. not a dir.")}this.assertWriteable(e);var t=i.up(e);t&&this.getRootFS().resolveFS(t).mkdir(t);var n=this.toNativePath(e);return c.mkdirSync(n),this.assertExist(n)},opendir:function(e){u.is(arguments,[String]);var t=this.toNativePath(e),n=i.truncSEP(t),r=c.readdirSync(t).map(function(e){var t=c.statSync(n+h+e),i=t.isDirectory()?h:"";return e+i}),a=[];return u.is(a.concat(r),Array)},rm:function(e,t){u.is(arguments,[i.Absolute]),t=t||{},this.assertExist(e);var n=this.toNativePath(e);return this.isDir(e)?c.rmdirSync(n):c.unlinkSync(n)},exists:function(e){var t=this.toNativePath(e);return c.existsSync(t)},isDir:function(e){return this.exists(e)?this.stat(e).isDirectory():i.isDir(e)},touch:function(e){!this.exists(e)&&this.isDir(e)?this.mkdir(e):this.exists(e)&&c.utimesSync(e,Date.now()/1e3,Date.now()/1e3)},getURL:function(e){return"file:///"+e.replace(/\\/g,"/")}}),l}),requireSimulator.setName("LSFS"),define(["FS2","PathUtil","extend","assert","Util","Content"],function(e,t,i,n,r,a){function o(){return(new Date).getTime()}var s=function(e,t){this.storage=e,this.options=t||{}},u=t.isDir.bind(t),c=t.up.bind(t),l=t.endsWith.bind(t),f=(t.Path,t.Absolute),h=t.SEP;return s.ramDisk=function(){var e={};return e[t.SEP]="{}",new s(e)},e.addFSType("localStorage",function(){return new s(localStorage)}),e.addFSType("ram",function(){return s.ramDisk()}),s.now=o,s.prototype=new e,s.prototype.resolveKey=function(e){return n.is(e,t.Absolute),this.mountPoint?t.SEP+t.relPath(e,this.mountPoint):e},s.prototype.getItem=function(e){n.is(e,t.Absolute);var i=this.resolveKey(e);return this.storage[i]},s.prototype.setItem=function(e,i){n.is(e,t.Absolute);var r=this.resolveKey(e);n(r.indexOf("..")<0),n(t.startsWith(r,t.SEP)),this.storage[r]=i},s.prototype.removeItem=function(e){n.is(e,t.Absolute);var i=this.resolveKey(e);delete this.storage[i]},s.prototype.itemExists=function(e){n.is(e,t.Absolute);var i=this.resolveKey(e);return i in this.storage},s.prototype.getDirInfo=function(e){if(n.is(arguments,[t.AbsDir]),null==e)throw new Error("getDir: Null path");l(e,h)||(e+=h),n(this.inMyFS(e));var i={};try{var r=this.getItem(e);r&&(i=JSON.parse(r))}catch(a){console.log("dinfo err : ",e,r)}return i},s.prototype.putDirInfo=function(e,i,r){if(n.is(arguments,[t.AbsDir,Object]),!u(e))throw new Error("Not a directory : "+e);n(this.inMyFS(e)),this.setItem(e,JSON.stringify(i));var a=c(e);if(null!=a&&this.inMyFS(a)){var o=this.getDirInfo(a);this._touch(o,a,t.name(e),r)}},s.prototype._touch=function(e,t,i,r){n.is(arguments,[Object,String,String]),n(this.inMyFS(t)),e[i]||(e[i]={},r&&(e[i].trashed=!0)),r||delete e[i].trashed,e[i].lastUpdate=o(),this.putDirInfo(t,e,r)},s.prototype.removeEntry=function(e,t,i){n.is(arguments,[Object,String,String]),e[i]&&(e[i]={lastUpdate:o(),trashed:!0},this.putDirInfo(t,e,!0))},s.prototype.removeEntryWithoutTrash=function(e,t,i){n.is(arguments,[Object,String,String]),e[i]&&(delete e[i],this.putDirInfo(t,e,!0))},s.prototype.isRAM=function(){return this.storage!==localStorage},s.prototype.fstype=function(){return this.isRAM()?"ramDisk":"localStorage"},e.delegateMethods(s.prototype,{isReadOnly:function(){return this.options.readOnly},getReturnTypes:function(){return n.is(arguments,[String]),{getContent:String,opendir:[String]}},getContent:function(e){n.is(arguments,[f]),this.assertExist(e);var t;return t=this.isText(e)?a.plainText(this.getItem(e)):a.url(this.getItem(e))},setContent:function(e,t){n.is(arguments,[f,a]),this.assertWriteable(e),this.isText(e)?this.setItem(e,t.toPlainText()):this.setItem(e,t.toURL()),this.touch(e)},getMetaInfo:function(e){if(this.assertExist(e,{includeTrashed:!0}),n.is(arguments,[f]),e==t.SEP)return{};var i=n(t.up(e));if(!this.inMyFS(i))return{};var r=t.name(e);n.is(i,t.AbsDir);var a=this.getDirInfo(i);return n(a[r])},setMetaInfo:function(e,i){n.is(arguments,[String,Object]),this.assertWriteable(e);
var r=n(t.up(e));if(this.inMyFS(r)){var a=this.getDirInfo(r),o=t.name(e);a[o]=i,this.putDirInfo(r,a,a[o].trashed)}},mkdir:function(e){n.is(arguments,[f]),this.assertWriteable(e),this.touch(e)},opendir:function(e,t){n.is(arguments,[String]),t=t||{};var i=this.getDirInfo(e),r=[];for(var a in i)n(i[a]),(!i[a].trashed||t.includeTrashed)&&r.push(a);return n.is(r,Array)},rm:function(e,i){n.is(arguments,[f]),i=i||{},this.assertWriteable(e);var r=t.up(e);if(null==r||!this.inMyFS(r))throw new Error(e+": cannot remove. It is root of this FS.");if(this.assertExist(e,{includeTrashed:i.noTrash}),t.isDir(e)){var a=this.opendir(e);a.length>0&&this.err(e,"Directory not empty"),i.noTrash&&this.removeItem(e)}else this.removeItem(e);var o=this.getDirInfo(r);i.noTrash?this.removeEntryWithoutTrash(o,r,t.name(e)):this.removeEntry(o,r,t.name(e))},exists:function(e,i){n.is(arguments,[f]),i=i||{};var r=t.name(e),a=t.up(e);if(null==a||!this.inMyFS(a))return!0;var o=this.getDirInfo(a),s=o[r];return s&&s.trashed&&this.itemExists(e)&&this.isDir(e),!s&&this.itemExists(e),s&&!s.trashed&&!s.link&&!this.itemExists(e),s&&!i.includeTrashed&&(s=!s.trashed),!!s},link:function(e,i){n.is(arguments,[t.Absolute,t.Absolute]),this.assertWriteable(e),this.exists(e)&&this.err(e,"file exists"),t.isDir(e)&&!t.isDir(i)&&this.err(e," can not link to file "+i),!t.isDir(e)&&t.isDir(i)&&this.err(e," can not link to directory "+i);var r={};r.link=i,r.lastUpdate=o(),this.setMetaInfo(e,r),n(this.exists(e)),n(this.isLink(e))},isLink:function(e){if(n.is(arguments,[t.Absolute]),!this.exists(e))return null;var i=n(this.getMetaInfo(e));return i.link},touch:function(e){n.is(arguments,[f]),this.assertWriteable(e),this.itemExists(e)||(t.isDir(e)?this.setItem(e,"{}"):this.setItem(e,""));var i=c(e);if(null!=i)if(this.inMyFS(i)){var r=this.getDirInfo(i);this._touch(r,i,t.name(e),!1)}else n(this.getRootFS()!==this),this.getRootFS().resolveFS(i).touch(i)},getURL:function(e){return this.getContent(e).toURL()}}),s}),requireSimulator.setName("Env"),define(["assert","PathUtil"],function(e,t){var i=function(e){this.value=e};return i.prototype={expand:function(t){e.is(t,String);var i=this;return t.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(e,t){return i.get(t)})},expandPath:function(i){return e.is(i,String),i=this.expand(i),i=i.replace(/\/+/g,"/"),i=i.replace(/^[a-z][a-z]+:\//,function(e){return e+"/"}),e.is(i,t.Path)},get:function(e){return this.value[e]},set:function(e,t){this.value[e]=t}},i}),requireSimulator.setName("SFile"),define(["extend","assert","PathUtil","Util","Content","FS2"],function(e,t,i,n,r,a){var o=function(e,n){t.is(n,i.Absolute),this._path=n,this.rootFS=e,this.fs=e.resolveFS(n),this.act={},this.act.path=this.fs.resolveLink(n),this.act.fs=e.resolveFS(this.act.path),t.is(this.act,{fs:a,path:i.Absolute}),this.isDir()&&!i.isDir(n)&&(this._path+=i.SEP)};return o.is=function(e){return e&&"function"==typeof e.isSFile&&e.isSFile()},o.prototype={isSFile:function(){return!0},setPolicy:function(e){if(this.policy)throw new Error("policy already set");return this.policy=e,this._clone()},getPolicy:function(){return this.policy},_clone:function(){return this._resolve(this.path())},_resolve:function(e,r){var a;if(r=r||{},o.is(e))a=e;else{t.is(e,i.Absolute);var s,u=r.policy||this.policy;if(u&&(s=u.topDir)&&(s.path&&(s=s.path()),!i.startsWith(e,s)))throw new Error(e+": cannot access. Restricted to "+s);a=new o(this.rootFS,e),a.policy=u}return a.policy?n.privatize(a):a},contains:function(e){return t(o.is(e),e+" shoud be a SFile object."),this.isDir()?i.startsWith(e.path(),this.path()):!1},path:function(){return this._path},name:function(){return i.name(this.path())},truncExt:function(e){return i.truncExt(this.path(),e)},ext:function(){return i.ext(this.path())},relPath:function(e){var n=e.path?e.path():e;return i.relPath(this.path(),t.is(n,i.Absolute))},up:function(){var e=this.path(),t=i.up(e);return null==t?null:this._resolve(t)},sibling:function(e){return this.up().rel(e)},rel:function(e){t.is(e,i.Relative),this.assertDir();var n=this.path();return this._resolve(i.rel(n,e))},startsWith:function(e){return i.startsWith(this.name(),e)},endsWith:function(e){return i.endsWith(this.name(),e)},equals:function(e){return e&&"function"==typeof e.path&&e.path()==this.path()},toString:function(){return this.path()},touch:function(){this.act.fs.touch(this.act.path)},isReadOnly:function(){return this.act.fs.isReadOnly(this.act.path)},isTrashed:function(){var e=this.metaInfo();return e?e.trashed:!1},metaInfo:function(){return 0==arguments.length?this.getMetaInfo.apply(this,arguments):this.setMetaInfo.apply(this,arguments)},getMetaInfo:function(e){return this.act.fs.getMetaInfo(this.act.path,e)},setMetaInfo:function(e,t){return this.act.fs.setMetaInfo(this.act.path,e,t)},lastUpdate:function(){return t(this.exists()),this.metaInfo().lastUpdate},exists:function(e){e=e||{};var t=this.fs.exists(this.path(),e);return t||e.noFollowLink?t:this.act.fs.exists(this.act.path,{noFollowLink:!0})},rm:function(e){return e=e||{},this.isLink()?this.fs.rm(this.path(),e):(this.isDir()&&(e.recursive||e.r)&&this.each(function(t){t.rm(e)}),this.act.fs.rm(this.act.path,e))},removeWithoutTrash:function(e){e=e||{},e.noTrash=!0,this.rm(e)},isDir:function(){return this.act.fs.isDir(this.act.path)},text:function(){return arguments.length>0?void this.setText(arguments[0]):this.getText()},setText:function(e){t.is(e,String),this.isText()?this.act.fs.setContent(this.act.path,r.plainText(e)):this.act.fs.setContent(this.act.path,r.url(e))},getContent:function(e){return"function"==typeof e?this.act.fs.getContentAsync(this.act.path).then(e):this.act.fs.getContent(this.act.path)},setContent:function(e){return this.act.fs.setContentAsync(this.act.path,e)},getText:function(){return this.isText()?this.act.fs.getContent(this.act.path).toPlainText():this.act.fs.getContent(this.act.path).toURL()},isText:function(){return this.act.fs.isText(this.act.path)},contentType:function(){return this.act.fs.getContentType(this.act.path)},setBytes:function(e){return this.act.fs.setContent(this.act.path,r.bin(e,this.contentType()))},getBytes:function(e){return e=e||{},this.act.fs.getContent(this.act.path).toBin(e.binType)},getURL:function(){return this.act.fs.getURL(this.act.path)},lines:function(){return this.text().replace(/\r/g,"").split("\n")},obj:function(){var e=this;if(0==arguments.length){var i=e.text();return i?JSON.parse(i):null}e.text(JSON.stringify(t.is(arguments[0],Object)))},copyFrom:function(e,t){return e.copyTo(this,t)},copyTo:function(e,i){t(e&&e.isSFile(),e+" is not a file");var n=this,i=i||{},r=n.isDir(),a=e.isDir();if(!r&&a&&(e=e.rel(n.name()),t(!e.isDir(),e+" is a directory."),a=!1),r&&!a)this.err("Cannot move dir to file");else{if(!r&&!a){i.echo&&i.echo(n+" -> "+e);var o=this.act.fs.cp(this.act.path,e.getResolvedLinkPath(),i);return i.a&&e.setMetaInfo(n.getMetaInfo()),o}t(r&&a),n.each(function(t){e.rel(t.name()).copyFrom(t,i)})}},moveFrom:function(e,t){var i=this.copyFrom(e,t);return e.rm({recursive:!0}),i},assertDir:function(){return t.is(this.path(),i.Dir),this},each:function(e,t){var i=this.assertDir();i.listFiles(t).forEach(e)},recursive:function(e,t){var i=this.assertDir();i.each(function(t){t.isDir()?t.recursive(e):e(t)},t)},listFiles:function(e){t(null==e||"object"==typeof e);var i,n=this.assertDir(),r=this.path();"function"==typeof e&&(i=e),e=n.convertOptions(e),i||(i=e.order);for(var a=this.act.fs.opendir(this.act.path,e),o=[],s=0;s<a.length;s++){var u=a[s];e.excludes[r+u]||o.push(n.rel(u))}return"function"==typeof i&&o.sort&&o.sort(i),o},ls:function(e){t(null==e||"object"==typeof e);var i=this.assertDir(),n=i.listFiles(e);return n.map(function(e){return e.name()})},convertOptions:function(e){var n=(this.assertDir(),this.path());if(e||(e={}),e.excludes||(e.excludes={}),e.excludes instanceof Array){var r={};e.excludes.forEach(function(e){i.startsWith(e,"/")?r[e]=1:r[n+e]=1}),e.excludes=r}return t.is(e,{excludes:{}})},mkdir:function(){this.touch()},link:function(e,t){if(this.exists())throw new Error(this.path()+": exists.");return this.act.fs.link(this.act.path,e.path(),t)},resolveLink:function(){return this._resolve(this.act.path)},isLink:function(){return this.fs.isLink(this.path())},getResolvedLinkPath:function(){return this.act.path}},o}),requireSimulator.setName("RootFS"),define(["assert","FS2","PathUtil","SFile"],function(e,t,i,n){var r=function(i){e.is(i,t),this.mount(null,i)},a=r.prototype,o={err:function(e,t){throw new Error(e+": "+t)},fstab:function(){return this._fstab=this._fstab||[]},unmount:function(t){e.is(arguments,[i.AbsDir]);var n=this.fstab();console.log(n);for(var r=0;r<n.length;r++)if(n[r].mountPoint==t)return n.splice(r,1),!0;return!1},availFSTypes:function(){return t.availFSTypes()},mount:function(i,n,r){if("string"==typeof n){var a=e(t.availFSTypes()[n],"fstype "+n+" is undefined.");n=a(i,r||{})}e.is(n,t),n.mounted(this,i),this.fstab().unshift(n)},resolveFS:function(n){e.is(n,i.Absolute);var r;return this.fstab().forEach(function(e){r||e.inMyFS(n)&&(r=e)}),r||this.err(n,"Cannot resolve"),e.is(r,t)},get:function(t){return e.is(t,i.Absolute),new n(this.resolveFS(t),t)}};for(var s in o)a[s]=o[s];return r}),requireSimulator.setName("FS"),define(["FS2","WebSite","NativeFS","LSFS","PathUtil","Env","assert","SFile","RootFS"],function(e,t,i,n,r,a,o,s,u){var e={};"object"==typeof window&&(window.FS=e);var c,l=new a(t);return c=new u(t.isNW?new i:new n(localStorage)),e.isFile=function(e){return s.is(e)},e.PathUtil=r,e.getRootFS=function(){return c},e.get=function(){return c.get.apply(c,arguments)},e.expandPath=function(){return l.expandPath.apply(l,arguments)},e.resolve=function(t,i){return s.is(t)?t:(t=l.expandPath(t),i&&!r.isAbsolutePath(t)?(i=l.expandPath(i),e.get(i).rel(t)):e.get(t))},e.mount=function(){return c.mount.apply(c,arguments)},e.unmount=function(){return c.unmount.apply(c,arguments)},e}),requireSimulator.setName("plugins"),define(["WebSite"],function(e){function t(e){return"function"==typeof e&&(e={onload:e}),e||(e={}),e.onload||(e.onload=function(){}),e}var i={},n={box2d:{src:"Box2dWeb-2.1.a.3.min.js",detection:/BodyActor/,symbol:"Box2D"},timbre:{src:"timbre.js",detection:/\bplay(SE)?\b/,symbol:"T"}};return i.installed=n,i.detectNeeded=function(e,t){for(var i in n){var r=n[i].detection.exec(e);r&&(t[i]=1)}return t},i.loaded=function(e){var t=n[e];if(!t)throw new Error("plugin not found: "+e);return window[t.symbol]},i.loadAll=function(e,r){function a(){u>=o.length?r.onload():i.load(o[u++],a)}r=t(r);var o=[];for(var s in e)n[s]&&!i.loaded(s)&&o.push(s);var u=0;console.log("loading plugins",o),setTimeout(a,0)},i.load=function(i,r){var a=n[i];if(!a)throw new Error("plugin not found: "+i);r=t(r);var o=e.pluginTop+"/"+a.src;location.href.match(/^file:/)?($("<script>").attr("src",o).appendTo("body"),setTimeout(r.onload,500)):$.getScript(o,r.onload)},i.request=function(e){if(!i.loaded(e)){var t=new Error("Plugin "+e+" required");t.pluginName=e}},i}),requireSimulator.setName("DeferredUtil"),define([],function(){var e;return e={ensureDefer:function(e){var t,i=new $.Deferred;return $.when(e).then(function(e){t?i.resolve(e):setTimeout(function(){i.resolve(e)},0)}).fail(function(e){t?i.reject(e):setTimeout(function(){i.reject(e)},0)}),t=!0,i.promise()},directPromise:function(e){var t=new $.Deferred;return setTimeout(function(){t.resolve(e)},0),t.promise()},then:function(t){return e.directPromise().then(t)},timeout:function(e){var t=new $.Deferred;return setTimeout(function(){t.resolve()},e),t.promise()},funcPromise:function(e){var t=new $.Deferred;return e(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise()},throwPromise:function(e){var t=new $.Deferred;return setTimeout(function(){t.reject(e)},0),t.promise()},throwF:function(t){return function(){try{return t.apply(this,arguments)}catch(i){return console.log(i,i.stack),e.throwPromise(i)}}},each:function(t,i){if(t instanceof Array)return e.loop(function(n){return n>=t.length?e.brk():$.when(i(t[n],n)).then(function(){return n+1})},0);var n=[];for(var r in t)n.push({k:r,v:t[r]});return e.each(n,function(e){return i(e.k,e.v)})},loop:function(t,i){return e.directPromise(i).then(e.throwF(function(){var i=t.apply(this,arguments);return i.DU_BRK?i.res:$.when(i).then(function(i){return e.loop(t,i)})}))},brk:function(e){return{DU_BRK:!0,res:e}}},e.begin=e.try=e.tr=e.throwF,e.promise=e.callbackToPromise=e.funcPromise,e}),requireSimulator.setName("compiledProject"),define(["DeferredUtil","WebSite"],function(e,t){var i=function(i,n){return{getNamespace:function(){return i},sourceDir:function(){return null},getDependingProjects:function(){return[]},loadDependingClasses:function(t){var i=e.directPromise(),n=this.getNamespace();return this.getDependingProjects().forEach(function(e){e.getNamespace()!=n&&(i=i.then(function(){return e.loadClasses(t)}))}),i},loadClasses:function(e){console.log("Load compiled classes ns=",i,"url=",n);var r=new $.Deferred,a=document.getElementsByTagName("head")[0]||document.documentElement,o=document.createElement("script");o.src=n+("BA"===t.serverType?"?"+Math.random():"");var s=!1;return o.onload=o.onreadystatechange=function(){s||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(s=!0,o.onload=o.onreadystatechange=null,a&&o.parentNode&&a.removeChild(o),console.log("Done Load compiled classes ns=",i,"url=",n,Tonyu.classes),r.resolve())},this.loadDependingClasses(e).then(function(){a.insertBefore(o,a.firstChild)}),r.promise()}}};return i}),requireSimulator.setName("compiledTonyuProject"),define(["plugins","compiledProject"],function(e,t){var i=function(i,n,r){var a=t(i,n),o=t("kernel",WebSite.compiledKernel),s={getDir:function(){return r},getDependingProjects:function(){return[o]},getOptions:function(){var e=this.getDir().rel("options.json");return e.obj()},getResource:function(){var e=this.getDir().rel("res.json");return e.obj()},loadPlugins:function(t){var i=this.getOptions();return e.loadAll(i.plugins,t)},requestPlugin:function(){},run:function(e){var t={classes:Tonyu.classMetas};this.loadClasses(t).then(function(){Tonyu.run(e)})}};for(var u in s)a[u]=s[u];return a};return i}),requireSimulator.setName("Shell"),define(["FS","Util","WebSite","PathUtil","assert"],function(e,t,i,n){function r(e,t){var i=a(e);if(t&&!i.exists())throw i+": no such file or directory";return i}function a(t){if("string"!=typeof t)return t;if(n.isAbsolutePath(t))return e.get(t);var i=o.cwd;return i.rel(t)}var o={};return o.cd=function(e){return o.cwd=r(e,!0),o.pwd()},o.mount=function(t,i){if(!t||!t.t){var n=[];for(var r in e.getRootFS().availFSTypes())n.push(r);return void sh.err("-t=("+n.join("|")+") should be specified.")}e.mount(i,t.t,t)},o.unmount=function(t){e.unmount(t)},o.fstab=function(){var t=e.getRootFS(),i=t.fstab(),n=this;i.forEach(function(e){n.echo(e.fstype()+"	"+(e.mountPoint||""))})},o.resolve=r,o.pwd=function(){return o.cwd+""},o.ls=function(e){return e=e?r(e,!0):o.cwd,e.ls()},o.cp=function(e,t,i){i||(i={}),i.v&&(o.echo("cp",e,t),i.echo=o.echo.bind(o));var n=r(e,!0),a=r(t);return n.copyTo(a,i)},o.ln=function(e,t,i){var n=r(t),a=r(e,!0);if(n.isDir()&&n.exists()&&(n=n.rel(a.name())),n.exists())throw new Error(n+" exists");return n.link(a,i)},o.rm=function(e,t){if(t||(t={}),t.notrash)return e=r(e,!1),e.removeWithoutTrash(),1;if(e=r(e,!0),e.isDir()&&t.r){var i=e,n=0;return i.each(function(e){e.exists()&&(n+=o.rm(e,t))}),i.rm(),n+1}return e.rm(),1},o.cat=function(e){return e=r(e,!0),o.echo(e.getContent(function(t){return e.isText()?t.toPlainText():t.toURL()}))},o.resolve=function(e){return e||(e="."),e=r(e)},o.grep=function(e,t,i){function n(e,t,n){i.res&&i.res.push({file:e,lineNo:t,line:n}),o.echo(e+"("+t+"): "+n)}return t=r(t,!0),i||(i={}),i.res||(i.res=[]),t.isDir()?t.each(function(t){o.grep(e,t,i)}):"string"==typeof e&&t.lines().forEach(function(i,r){i.indexOf(e)>=0&&n(t,r+1,i)}),i.res},o.touch=function(e){return e=r(e),e.text(e.exists()?e.text():""),1},o.setout=function(e){o.outUI=e},o.echo=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.log&&o.outUI.log.apply(o.outUI,arguments)},o.err=function(){console.log.apply(console,arguments),o.outUI&&o.outUI.err&&o.outUI.err.apply(o.outUI,arguments)},o.prompt=function(){},o.ASYNC={r:"SH_ASYNC"},o.help=function(){for(var e in o){var t=o[e];"function"==typeof t&&o.echo(e+(t.description?" - "+t.description:""))}},sh=o,i.isNW&&(sh.devtool=function(){require("nw.gui").Window.get().showDevTools()}),o}),requireSimulator.setName("Klass"),define(["assert"],function(e){function t(e){if("object"!=typeof e)return!1;if(!e)return!1;var t={configurable:1,enumerable:1,value:1,writable:1,get:1,set:1},i=0;for(var n in e){if(!t[n])return!1;i+=t[n]}return i}var i={};return i.define=function(n){function r(t){n.$fields&&e.is(t,n.$fields)}var a,o;n.$parent?(o=n.$parent,a=Object.create(o.prototype),a.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return o.prototype[t].apply(this,e)}):a={};var s,u=n.$||function(e){if(e&&"object"==typeof e)for(var t in e)this[t]=e[t]};u instanceof Array&&(s=u,u=function(){for(var e=Array.prototype.slice.call(arguments),t=0;t<s.length;t++)e.length>0&&(this[s[t]]=e.shift())});var c;c=function(){if(!(this instanceof c)){var e=Object.create(a);return u.apply(e,arguments),r(e),e}u.apply(this,arguments),r(this)},o&&(c.super=function(){var e=Array.prototype.slice.call(arguments),t=e.shift(),i=e.shift();return o.prototype[i].apply(t,e)}),c.inherit=function(e){return e.$parent=c,i.define(e)},c.prototype=a;for(var l in n)"$"!=l[0]&&("static$"==l.substring(0,7)?c[l.substring(7)]=n[l]:t(n[l])?Object.defineProperty(a,l,n[l]):a[l]=n[l]);return a.$=u,c},i.Function=function(){throw new Exception("Abstract")},i.opt=e.opt,i}),requireSimulator.setName("Tonyu.Thread"),define(["DeferredUtil","Klass"],function(e,t){var i={enterC:{},exitC:0};try{window.cnts=i}catch(n){}var r=t.define({$:function(){this.frame=null,this._isDead=!1,this.cnt=0,this._isWaiting=!1,this.fSuspended=!1,this.tryStack=[],this.preemptionTime=60,this.onEndHandlers=[],this.onTerminateHandlers=[],this.age=0},isAlive:function(){return!this.isDead()},isDead:function(){return this._isDead=this._isDead||null==this.frame||this._threadGroup&&(this._threadGroup.objectPoolAge!=this.tGrpObjectPoolAge||this._threadGroup.isDeadThreadGroup())},setThreadGroup:function(e){this._threadGroup=e,this.tGrpObjectPoolAge=e.objectPoolAge},isWaiting:function(){return this._isWaiting},suspend:function(){this.fSuspended=!0,this.cnt=0},enter:function(e){this.frame={prev:this.frame,func:e}},apply:function(e,t,i){i||(i=[]);var n;if("string"==typeof t&&(n=e["fiber$"+t],!n))throw new Error(""+t+"");"function"==typeof t&&(n=t.fiber),i=[this].concat(i);var r=0;return this.enter(function(t){switch(r){case 0:n.apply(e,i),r=1;break;case 1:t.termStatus="success",t.notifyEnd(t.retVal),i[0].exit(),r=2}})},notifyEnd:function(e){this.onEndHandlers.forEach(function(t){t(e)}),this.notifyTermination({status:"success",value:e})},notifyTermination:function(e){this.onTerminateHandlers.forEach(function(t){t(e)})},on:function(e,t){("end"===e||"success"===e)&&this.onEndHandlers.push(t),"terminate"===e&&(this.onTerminateHandlers.push(t),this.handleEx&&delete this.handleEx)},promise:function(){var t=this;return e.funcPromise(function(e,i){t.on("terminate",function(t){"success"===t.status?e(t.value):i("exception"===t.status?t.exception:new Error(t.status))})})},then:function(e,t){return t?this.proimse().then(e,t):this.proimse().then(e)},fail:function(e){return this.promise().fail(e)},gotoCatch:function(e){var t=this;if(0==t.tryStack.length)return t.termStatus="exception",t.kill(),void(t.handleEx?t.handleEx(e):t.notifyTermination({status:"exception",exception:e}));t.lastEx=e;for(var i=t.tryStack.pop();t.frame;){if(i.frame===t.frame){t.catchPC=i.catchPC;break}t.frame=t.frame.prev}},startCatch:function(){var e=this,t=e.lastEx;return e.lastEx=null,t},exit:function(e){this.frame=this.frame?this.frame.prev:null,this.retVal=e},enterTry:function(e){var t=this;t.tryStack.push({frame:t.frame,catchPC:e})},exitTry:function(){var e=this;e.tryStack.pop()},waitEvent:function(e,t){var i=this;if(i.suspend(),e.on){var n;t=t.concat(function(){i.lastEvent=arguments,i.retVal=arguments[0],n.remove(),i.steps()}),n=e.on.apply(e,t)}},runAsync:function(e){var t=this,i=function(){t.retVal=arguments,t.steps()},n=function(){for(var e="",i=0;i<arguments.length;i++)e+=arguments[i]+",";0==e.length&&(e="Async fail");var n=new Error(e);n.args=arguments,t.gotoCatch(n),t.steps()};t.suspend(),setTimeout(function(){e(i,n)},0)},waitFor:function(t){var i=this;return i._isWaiting=!0,i.suspend(),t instanceof r&&(t=t.promise()),e.ensureDefer(t).then(function(e){i.retVal=e,i.steps()}).fail(function(e){if(e instanceof Error)i.gotoCatch(e);else{var t=new Error(e);t.original=e,i.gotoCatch(t)}i.steps()})},resume:function(e){this.retVal=e,this.steps()},steps:function(){var e=this;if(!e.isDead()){var t=Tonyu.currentThread;for(Tonyu.currentThread=e,e.cnt=e.preemptionTime,e.preempted=!1,e.fSuspended=!1;e.cnt>0&&e.frame;)try{for(;e.cnt-->0&&e.frame;)e.frame.func(e);e.preempted=!e.fSuspended&&e.isAlive()}catch(i){e.gotoCatch(i)}Tonyu.currentThread=t}},kill:function(){var e=this;e._isDead=!0,e.frame=null,e.termStatus||(e.termStatus="killed",e.notifyTermination({status:"killed"}))},clearFrame:function(){this.frame=null,this.tryStack=[]}});return r}),requireSimulator.setName("Tonyu.Iterator"),define(["Klass"],function(e){function t(e,t){if(e.tonyuIterator)return e.tonyuIterator(t);if(e instanceof Array)return 1==t?new i(e):new n(e);if(e instanceof Object)return 1==t?new r(e):new a(e);throw console.log(e),new Error(e+" is not iterable")}var i=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.set[this.i],this.i++,!0)}}),n=e.define({$:function(e){this.set=e,this.i=0},next:function(){return this.i>=this.set.length?!1:(this[0]=this.i,this[1]=this.set[this.i],this.i++,!0)}}),r=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push(t);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i],this.i++,!0)}}),a=e.define({$:function(e){this.elems=[];for(var t in e)this.elems.push([t,e[t]]);this.i=0},next:function(){return this.i>=this.elems.length?!1:(this[0]=this.elems[this.i][0],this[1]=this.elems[this.i][1],this.i++,!0)}});return t}),requireSimulator.setName("Tonyu"),"function"!=typeof define&&(define=require("requirejs").define),define(["assert","Tonyu.Thread","Tonyu.Iterator","DeferredUtil"],function(e,t,i,n){return Tonyu=function(){function r(){var e=new t;return e.handleEx=s,e}function a(e){return n.funcPromise(function(t){setTimeout(t,e)})}function o(){return n.funcPromise(function(e){requestAnimationFrame(e)})}function s(e){if(!Tonyu.onRuntimeError)throw"undefined"==typeof $LASTPOS&&($LASTPOS=0),alert("! at "+$LASTPOS+"   : "+e),console.log(e.stack),e;Tonyu.onRuntimeError(e)}function u(t,i){return e.is(arguments,[String,Object]),l(klass.getMeta(t),i)}function c(e,t){return e?l(Object.create(e.prototype),t):t}function l(e,t){if(t&&"object"==typeof t)for(var i in t)e[i]=t[i];return e}function f(e,t){L[e]=t}function h(e){return L[e]}function p(e){var t=e.split("."),i=x;if(t.forEach(function(e){i&&(i=i[e])}),!i&&1==t.length){var n;for(var r in x){var a=x[r][e];if(a){if(i)throw new Error(" "+r+"."+e+", "+n);i=a,n=r+"."+e}}}return i}function d(e,t){if("function"!=typeof t)return t;var i=function(){return t.apply(e,arguments)};return i.methodInfo=Tonyu.extend({thiz:e},t.methodInfo||{}),t.fiber&&(i.fiber=function(){return t.fiber.apply(e,arguments)},i.fiber.methodInfo=Tonyu.extend({thiz:e},t.fiber.methodInfo||{})),i}function m(e,t,i,n){if(!e)throw new Error(n+"(="+e+") "+t+"");var r=e[t];if("function"!=typeof r)throw new Error(("this"==n?"":n+".")+t+"(="+r+")");return r.apply(e,i)}function g(e,t,i){if("function"!=typeof e)throw new Error(i+"");return e.apply({},t)}function v(e,t){if(e!=e||null==e)throw new Error(t+"(="+e+")");return e}function y(e){for(var t=[],i=1;i<e.length;i++)t[i-1]=e[i];return t}function b(e){throw new Error(""+e+"new")}function T(e){throw console.log("Not a tonyu object: ",e),new Error(e+" is not a tonyu object")}function M(e,t){return e in t}function A(e){var t=p(e);if(!t)throw new Error(e+" ");Tonyu.runMode=!0;var i=new t,n=r();n.apply(i,"main");var a;(a=Tonyu.currentProject)&&(a.runningThread=n,a.runningObj=i),$LASTPOS=0,n.steps()}function S(){var e=(new Date).getTime();if(e-D>1e3)throw P(1e4),new Error(""+(e-w));w=e}function P(e){D=(new Date).getTime()+(e||0)}klass=function(){throw alert(" Deprecated. compile again."),new Error(" Deprecated. compile again.")},klass.addMeta=u,klass.removeMeta=function(e){delete B[e]},klass.getMeta=function(e){if("function"==typeof e)return e.meta;if("string"==typeof e){var t=B[e];return t||(B[e]=t={}),t}},klass.ensureNamespace=function(e,t){var i,n=t.split("."),r=e;for(i=0;i<n.length;i++){var a=n[i];r[a]||(r[a]={}),r=r[a]}return r},Function.prototype.constructor=function(){throw new Error("This method should not be called")},klass.define=function(e){var t=e.superclass,i=e.includes,n=e.fullName,r=e.shortName,a=e.namespace,o=e.methods,s=e.decls,l=klass.ensureNamespace(Tonyu.classes,a),f=o,h=f.initialize;delete f.initialize;var p;p=h?function(){this instanceof p||b(n),h.apply(this,arguments)}:t?function(){this instanceof p||b(n),t.apply(this,arguments)}:function(){this instanceof p||b(n)},l[r]=p,p.methods=f,i.forEach(function(e){if(!e.methods)throw e+" Does not have methods";for(var t in e.methods)t in f||(f[t]=e.methods[t])});var d={},m=/^__([gs]et)ter__(.*)$/;for(var g in f)if(!g.match(/^fiber\$/)){f["fiber$"+g]&&(f[g].fiber=f["fiber$"+g],f[g].fiber.methodInfo={name:g,klass:p,fiber:!0}),f[g].methodInfo={name:g,klass:p};var v=m.exec(g);v&&(d[v[2]]=d[v[2]]||{},d[v[2]][v[1]]=f[g])}p.prototype=c(t,f),p.prototype.isTonyuObject=!0;for(var g in d)Object.defineProperty(p.prototype,g,d[g]);p.meta=u(n,{fullName:n,shortName:r,namepsace:a,decls:s,superclass:t?t.meta:null,func:p,includes:i.map(function(e){return e.meta})});var y=klass.getMeta(p);return p.prototype.getClassInfo=function(){return y},p},klass.isSourceChanged=function(e){return e=e.meta||e,e.src&&e.src.tonyu?e.nodeTimestamp?e.src.tonyu.lastUpdate()>e.nodeTimestamp:!0:!1},klass.shouldCompile=function(e){if(e=e.meta||e,klass.isSourceChanged(e))return!0;for(var t=klass.getDependingClasses(e),i=0;i<t.length;i++)if(klass.shouldCompile(t[i]))return!0},klass.getDependingClasses=function(e){e=e.meta||e;var t=[];return e.superclass&&(t=[e.superclass]),e.includes&&(t=t.concat(e.includes)),t};var w,L={},x={},B={},D=(new Date).getTime();return setInterval(P,16),Tonyu={thread:r,klass:klass,bless:c,extend:l,globals:L,classes:x,classMetas:B,setGlobal:f,getGlobal:h,getClass:p,timeout:a,animationFrame:o,bindFunc:d,not_a_tonyu_object:T,hasKey:M,invokeMethod:m,callFunc:g,checkNonNull:v,run:A,iterator:i,checkLoop:S,resetLoopCheck:P,VERSION:1503453200013,A:y}}()}),requireSimulator.setName("PatternParser"),define(["Tonyu"],function(e){var t=function(e,t){this.options=t||{},this.img=e,this.height=e.height,this.width=e.width;var i=this.newImage(e.width,e.height),n=i.getContext("2d");n.drawImage(e,0,0),this.ctx=n,this.pixels=this.ctx.getImageData(0,0,e.width,e.height).data,this.base=this.getPixel(0,0)};return e.extend(t.prototype,{newImage:function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,i},getPixel:function(e,t){var i=this.pixels,n=4*(e+t*this.width),r=i[0+n],a=i[1+n],o=i[2+n],s=i[3+n];return 256*(256*(256*s+o)+a)+r},setPixel:function(e,t,i){var n=4*(e+t*this.width);this.pixels[0+n]=255&i,i=(i-(255&i))/256,this.pixels[1+n]=255&i,i=(i-(255&i))/256,this.pixels[2+n]=255&i,i=(i-(255&i))/256,this.pixels[3+n]=255&i},parse:function(){try{for(var e=[],t=0;t<this.height;t++)for(var i=0;i<this.width;i++){var n=this.getPixel(i,t);n!=this.base&&e.push(this.parse1Pattern(i,t))}return e}catch(r){if(r.isParseError)return console.log("parse error! "+r),[{image:this.img,x:0,y:0,width:this.width,height:this.height}];throw r}},parse1Pattern:function(e,t){function i(e){return e}function n(e,t,i){return{toString:function(){return"at ("+e+","+t+") :"+i},isParseError:!0}}for(var r=this.getPixel(e,t),a=e,o=t,s=this.base,u=this.width,c=this.height;u>a;){var l=this.getPixel(a,o);if(l!=r)break;a++}if(a>=u||this.getPixel(a,o)!=s)throw n(a,o,i(this.getPixel(a,o))+"!="+i(s));for(a--;c>o&&this.getPixel(a,o)==r;)o++;if(o>=c||this.getPixel(a,o)!=s)throw n(a,o,i(this.getPixel(a,o))+"!="+i(s));o--;var f=e+1,h=t+1,p=a-f,d=o-h;if(console.log("PP",f,h,p,d,a,o),p*d==0)throw n(a,o,"w*h==0");for(var m=this.newImage(p,d),g=m.getContext("2d"),v=g.getImageData(0,0,p,d),y=v.data,b=0,T=h;o>T;T++)for(var M=f;a>M;M++){var A=this.getPixel(M,T);A==r?(y[b++]=0,y[b++]=0,y[b++]=0,y[b++]=0):(y[b++]=255&A,A=(A-(255&A))/256,y[b++]=255&A,A=(A-(255&A))/256,y[b++]=255&A,A=(A-(255&A))/256,y[b++]=255&A)}g.putImageData(v,0,0);for(var S=h-1;o>=S;S++)for(var P=f-1;a>=P;P++)this.setPixel(P,S,s);return this.options.boundsInSrc?{x:f,y:h,width:p,height:d}:{image:m,x:0,y:0,width:p,height:d}}}),t}),requireSimulator.setName("Assets"),define(["WebSite","Util","Tonyu","FS"],function(e,t,i,n){var r={};return r.resolve=function(i,r){var a=n.isFile(r)?r:r.getDir();if(null==i&&(i=""),i=i.replace(/\$\{([a-zA-Z0-9_]+)\}/g,function(t,i){return e[i]}),e.urlAliases[i]&&(i=e.urlAliases[i]),t.startsWith(i,"ls:")){var o=i.substring("ls:".length);if(!a)throw new Error("Basedir not specified");var s=a.rel(o);if(!s.exists())throw new Error("Resource file not found: "+s);if(e.mp3Disabled&&o.match(/\.(mp3|mp4|m4a)$/)){var u=a.rel(o.replace(/\.(mp3|mp4|m4a)$/,".ogg"));u.exists()&&(s=u)}i=s.getURL()}return i},i.Assets=r,r}),requireSimulator.setName("ImageList"),define(["PatternParser","Util","Assets","assert"],function(e,t,i,n){function r(e){var t=[];return e.forEach(function(e){e&&""!=e.url&&t.push(e)}),t}var a,o={};return a=function(t,a,s){s||(s={}),t=r(t);var u=[],c=t.length;0==c&&setTimeout(function(){var e=[];e.names={},a(e)},0),t.forEach(function(t,r){function l(){var i,o;if("single"==t.type)u[r]=[{image:this,x:0,y:0,width:this.width,height:this.height}];else if((i=t.pwidth)&&(o=t.pheight)){for(var s=0,l=0,f=this.width,h=this.height,p=[];;){var d=i,m=o;if(s+i>f&&(d=f-s),l+o>h&&(m=h-l),p.push({image:this,x:s,y:l,width:d,height:m}),s+=i,s+i>f&&(s=0,l+=o,l+o>h))break}u[r]=p}else{var g=new e(this);u[r]=g.parse()}if(u[r].name=t.name,n.is(u[r],Array),c--,0==c){var v=[],y={};u.forEach(function(e){y[e.name]=v.length,v=v.concat(e)}),v.names=y,a(v)}}console.log("loading",t,r);var f=t.url,h=f;if(o[h])return void l.apply(o[h],[]);f=i.resolve(f,s.prj||s.baseDir);var p=$("<img>");p.load(function(){o[h]=this,l.apply(this,[])}),p.attr("src",f)})},a.load=a,a.parse1=function(t,i,r){var a,o,s;if((a=t.pwidth)&&(o=t.pheight)){for(var u=0,c=0,l=i.width,f=i.height,h=[];;)if(h.push({image:this,x:u,y:c,width:a,height:o}),u+=a,u+a>l&&(u=0,c+=o,c+o>f))break;s=h}else{var p=new e(i,r);s=p.parse()}return s.name=t.name,n.is(s,Array)},window.ImageList=a,a}),requireSimulator.setName("PicoAudio");var PicoAudio=function(){function e(e,t){var i=window.AudioContext||window.webkitAudioContext;this.context=e?e:new i,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,hashLength:this.isAndroid()?25:50,hashBuffer:2,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!this.isAndroid(),reverbVolume:1.5,isChorus:!0,chorusVolume:.5,isCC111:!0,dramMaxPlayLength:.5,loop:!1},this.trigger={isNoteTrigger:!0,noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1;
for(var n=0;17>n;n++)this.channels.push([0,0,1]);if(t&&t.whitenoise)this.whitenoise=t.whitenoise;else{this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate);for(var r=0;2>r;r++)for(var n=0;n<this.context.sampleRate;n++)this.whitenoise.getChannelData(r)[n]=2*Math.random()-1}if(this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,t&&t.impulseResponse)this.impulseResponse=t.impulseResponse;else{var a=3.5*this.context.sampleRate;this.impulseResponse=this.context.createBuffer(2,a,this.context.sampleRate);for(var r=0;2>r;r++)for(var o=this.impulseResponse.getChannelData(r),n=0;a>n;n++){var s=(a-n)/a,u=n/this.context.sampleRate,c=(.03>u?0:s)*(u>=.03&&.031>u?2*s:s)*(u>=.04&&.042>u?1.5*s:s)*(u>=.05&&.054>u?1.25*s:s)*Math.random()*.2*Math.pow(s-.03,4);o[n]=c}}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!1,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0),this.onSongEndListener=null}return e.prototype.createNote=function(e){var t=!1;if(e.channel)switch(this.channels[e.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:t=!0}var i=this.createBaseNote(e,!0,!1,t),n=i.oscillator,r=i.gainNode,a=(i.panNode,i.noiseCutGainNode),o=!1,s=this;switch(this.channels[i.channel][0]/10||e.instrument){case.1:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",r.gain.value*=1.5;break;case.2:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",r.gain.value*=.8;break;case.3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:n.type="sawtooth";break;case.4:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",r.gain.value*=1.5;break;default:n.type="square"}switch(this.channels[i.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:o=!0,r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(0,i.start+.2),s.stopAudioNode(n,i.start+.5,r);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(.95*r.gain.value,i.start+.1),r.gain.setValueAtTime(.95*r.gain.value,i.start+.1),r.gain.linearRampToValueAtTime(0,i.start+1.5+3*i.velocity);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:r.gain.value*=1.1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(0,i.start+1+4*i.velocity);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:r.gain.value*=1,r.gain.setValueAtTime(r.gain.value,i.start),r.gain.linearRampToValueAtTime(.95*r.gain.value,i.start+.1),r.gain.setValueAtTime(.95*r.gain.value,i.start+.1),r.gain.linearRampToValueAtTime(0,i.start+2+10*i.velocity);break;case 119:r.gain.value=0,s.stopAudioNode(n,0,r)}return("sine"==n.type||"triangle"==n.type)&&!o&&i.stop-i.start>.01&&(a.gain.setValueAtTime(1,i.stop-.005),a.gain.linearRampToValueAtTime(0,i.stop)),function(){s.stopAudioNode(n,0,r)}},e.prototype.createPercussionNote=function(e){var t=this.createBaseNote(e,!1),i=t.oscillator,n=t.gainNode,r=(t.panNode,t.start),a=(t.stop,t.velocity*((e.expression?e.expression[0].value:100)/127)),o=this.createBaseNote(e,!1,!0),s=o.oscillator,u=o.gainNode,c=(o.panNode,this);switch(e.pitch){case 35:case 36:n.gain.value=.6*a,i.playbackRate.value=.02,c.stopAudioNode(i,r+.07,n),u.gain.value=1.1*a,s.frequency.setValueAtTime(120,r),s.frequency.linearRampToValueAtTime(50,r+.07),c.stopAudioNode(s,r+.07,u);break;case 38:case 40:i.playbackRate.value=.7,c.stopAudioNode(i,r+.05,n),u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.05),s.frequency.setValueAtTime(300,r),s.frequency.linearRampToValueAtTime(200,r+.05),c.stopAudioNode(s,r+.05,u);break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,c.stopAudioNode(i,r+.1,n),s.type="square",u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(.01,r+.1),s.frequency.setValueAtTime(150+20*(e.pitch-40),r),s.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),r+.1),c.stopAudioNode(s,r+.1,u);break;case 42:case 44:i.playbackRate.value=1.5,c.stopAudioNode(i,r+.02,n),c.stopAudioNode(s,0,u);break;case 46:i.playbackRate.value=1.5,c.stopAudioNode(i,r+.3,n),n.gain.setValueAtTime(.9*a,r),n.gain.linearRampToValueAtTime(0,r+.3),c.stopAudioNode(s,0,u);break;case 49:case 51:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,c.stopAudioNode(i,r+.5,n),n.gain.setValueAtTime(1*a,r),n.gain.linearRampToValueAtTime(0,r+.5),c.stopAudioNode(s,0,u);break;case 51:i.playbackRate.value=1.1,c.stopAudioNode(i,r+.4,n),n.gain.setValueAtTime(.8*a,r),n.gain.linearRampToValueAtTime(0,r+.4),c.stopAudioNode(s,0,u);break;case 59:i.playbackRate.value=1.8,c.stopAudioNode(i,r+.3,n),n.gain.setValueAtTime(.5*a,r),n.gain.linearRampToValueAtTime(0,r+.3),c.stopAudioNode(s,0,u);break;case 60:case 61:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(400-40*(e.pitch-60),r),s.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),r+.1),c.stopAudioNode(s,r+.1,u);break;case 62:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.03),s.frequency.setValueAtTime(200,r),s.frequency.linearRampToValueAtTime(250,r+.03),c.stopAudioNode(s,r+.03,u);break;case 63:case 64:i.playbackRate.value=.03,c.stopAudioNode(i,r+.03,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(200-30*(e.pitch-63),r),s.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),r+.1),c.stopAudioNode(s,r+.1,u);break;case 56:case 75:i.playbackRate.value=.01,c.stopAudioNode(i,r+.1,n),u.gain.setValueAtTime(a,r),u.gain.linearRampToValueAtTime(0,r+.1),s.frequency.setValueAtTime(1e3+48*(e.pitch-56),r),c.stopAudioNode(s,r+.1,u);break;case 80:i.playbackRate.value=5,n.gain.setValueAtTime(.5*a,r),n.gain.linearRampToValueAtTime(0,r+.2),c.stopAudioNode(i,r+.05,n),s.type="triangle",u.gain.setValueAtTime(.7*a,r),u.gain.linearRampToValueAtTime(0,r+.2),s.frequency.setValueAtTime(6e3,r),c.stopAudioNode(s,r+.05,u);break;case 81:i.playbackRate.value=5,n.gain.setValueAtTime(.9*a,r),n.gain.linearRampToValueAtTime(0,r+.5),c.stopAudioNode(i,r+.5,n),s.type="triangle",u.gain.setValueAtTime(.8*a,r),u.gain.linearRampToValueAtTime(0,r+.3),s.frequency.setValueAtTime(6e3,r),c.stopAudioNode(s,r+.3,u);break;default:i.playbackRate.value=e.pitch/69*2,c.stopAudioNode(i,r+.05,n),c.stopAudioNode(s,0,u)}return function(){c.stopAudioNode(i,0,n),c.stopAudioNode(s,0,u)}},e.prototype.createBaseNote=function(e,t,i,n){var r=this.settings,a=this.context,o=this.states.startTime,s=this.getTime(e.start)+o,u=this.getTime(e.stop)+o,c=r.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),l=i?0:e.channel||0,f=e.velocity*Number(i?1:this.channels[l][2]||1)*r.generateVolume,h=9!=l?a.createOscillator():a.createBufferSource(),p=a.createStereoPanner?a.createStereoPanner():a.createPanner?a.createPanner():{pan:{setValueAtTime:function(){}}},d=a.createGain(),m=a.createGain(),g=this;if(!a.createStereoPanner&&a.createPanner){var v=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;v>1&&(v=1);var y=90*v,b=Math.sin(y*(Math.PI/180)),T=-Math.cos(y*(Math.PI/180));p.panningModel="equalpower",p.setPosition(b,0,T)}else if(a.createStereoPanner){var v=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;v>1&&(v=1),p.pan.value=v}if(d.gain.value=f*((e.expression?e.expression[0].value:100)/127),9!=l?(h.type=e.type||"sine",h.detune.value=0,h.frequency.value=c,e.pitchBend?e.pitchBend.forEach(function(t){h.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),g.getTime(t.timing)+o)}):!1):(h.loop=!0,h.buffer=this.whitenoise),t&&(e.expression?e.expression.forEach(function(e){d.gain.setValueAtTime(f*(e.value/127),g.getTime(e.timing)+o)}):!1),a.createStereoPanner||a.createPanner){var M=!0;a.createStereoPanner?e.pan?e.pan.forEach(function(e){if(M)return void(M=!1);var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1),p.pan.setValueAtTime(t,g.getTime(e.timing)+o)}):!1:a.createPanner&&(p.positionX?e.pan?e.pan.forEach(function(e){if(M)return void(M=!1);var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1);var i=90*t,n=Math.sin(i*(Math.PI/180)),r=-Math.cos(i*(Math.PI/180));p.positionX.setValueAtTime(n,g.getTime(e.timing)+o),p.positionY.setValueAtTime(0,g.getTime(e.timing)+o),p.positionZ.setValueAtTime(r,g.getTime(e.timing)+o)}):!1:e.pan?e.pan.forEach(function(e){if(M)return void(M=!1);var t=setTimeout(function(){g.clearFunc("pan",t);var i=64==e.value?0:e.value/127*2-1;i>1&&(i=1);var n=90*i,r=Math.sin(n*(Math.PI/180)),a=-Math.cos(n*(Math.PI/180));p.setPosition(r,0,a)},1e3*(g.getTime(e.timing)+o-a.currentTime));g.pushFunc({pan:t,stopFunc:function(){clearTimeout(t)}})}):!1),h.connect(p),p.connect(d)}else h.connect(d);if(d.connect(m),m.connect(this.masterGainNode),this.masterGainNode.connect(a.destination),9!=l&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){var A=a.createOscillator(),S=a.createGain();M=!0,e.modulation?e.modulation.forEach(function(e){if(M)return void(M=!1);var t=e.value/127;t>1&&(t=1),S.gain.setValueAtTime(10*c/440*t,g.getTime(e.timing)+o)}):!1;var P=e.modulation?e.modulation[0].value/127:0;P>1&&(P=1),S.gain.value=10*c/440*P,A.frequency.value=6,A.connect(S),S.connect(h.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var w=this.convolver,L=(this.masterGainNode,a.createGain());M=!0,e.reverb?e.reverb.forEach(function(e){if(M)return void(M=!1);var t=e.value/127;t>1&&(t=1),L.gain.setValueAtTime(t,g.getTime(e.timing)+o)}):!1;var x=e.reverb?e.reverb[0].value/127:0;x>1&&(x=1),L.gain.value=x,d.connect(L),L.connect(w)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var B=this.chorusDelayNode,D=(this.masterGainNode,a.createGain());M=!0,e.chorus?e.chorus.forEach(function(e){if(M)return void(M=!1);var t=e.value/127;t>1&&(t=1),D.gain.setValueAtTime(t,g.getTime(e.timing)+o)}):!1;var E=e.chorus?e.chorus[0].value/127:0;E>1&&(E=1),D.gain.value=E,d.connect(D),D.connect(B)}return A&&(A.start(s),this.stopAudioNode(A,u,S)),h.start(s),9==l||i||n||this.stopAudioNode(h,u,d),{start:s,stop:u,pitch:c,channel:l,velocity:f,oscillator:h,panNode:p,gainNode:d,noiseCutGainNode:m}},e.prototype.startWebMIDI=function(){var e,t=this;if(navigator.requestMIDIAccess){var i=this.settings.WebMIDIPortSysEx,n=function(n){e=n.outputs,t.settings.WebMIDIPortOutputs=e;var r;return-1==t.settings.WebMIDIPort?t.settings.WebMIDIPortOutputs.forEach(function(e){r||(r=e)}):r=t.settings.WebMIDIPortOutputs.get(settings.WebMIDIPort),t.settings.WebMIDIPortOutput=r,t.settings.WebMIDIPortSysEx=i,r&&(r.open(),t.initStatus()),e},r=function(e){console.log(e),i&&(i=!1,navigator.requestMIDIAccess({sysex:i}).then(n).catch(r))};navigator.requestMIDIAccess({sysex:i}).then(n).catch(r),window.addEventListener("unload",function(){for(var e=0;16>e;e++){t.settings.WebMIDIPortOutput.send([176+e,120,0]);for(var i=0;128>i;i++)t.settings.WebMIDIPortOutput.send([128+e,i,0])}})}},e.prototype.initStatus=function(e,t){if(!this.settings.isWebMIDI||null==this.states.webMIDIWaitState){this.stop(e);var i=this.states.webMIDIStopTime;if(this.states={isPlaying:!1,playIndex:0,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0},this.states.webMIDIStopTime=i,this.settings.isWebMIDI&&!t){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var n=0;16>n;n++)this.settings.WebMIDIPortOutput.send([192+n,0]),this.settings.WebMIDIPortOutput.send([224+n,0,64]),this.settings.WebMIDIPortOutput.send([176+n,100,0]),this.settings.WebMIDIPortOutput.send([176+n,101,0]),this.settings.WebMIDIPortOutput.send([176+n,6,2]),this.settings.WebMIDIPortOutput.send([176+n,100,1]),this.settings.WebMIDIPortOutput.send([176+n,96,0]),this.settings.WebMIDIPortOutput.send([176+n,97,64]),this.settings.WebMIDIPortOutput.send([176+n,7,100]),this.settings.WebMIDIPortOutput.send([176+n,10,64]),this.settings.WebMIDIPortOutput.send([176+n,11,127]),this.settings.WebMIDIPortOutput.send([176+n,98,0]),this.settings.WebMIDIPortOutput.send([176+n,99,0]),this.settings.WebMIDIPortOutput.send([176+n,122,0])}}},e.prototype.stop=function(e){var t=this.states,i=this;if(0!=t.isPlaying&&(t.isPlaying=!1,t.playIndex-=this.settings.hashBuffer+1,t.stopTime=this.context.currentTime,t.stopFuncs.forEach(function(e){e.stopFunc()}),t.stopFuncs=[],this.settings.isWebMIDI)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;t.webMIDIStopTime=this.context.currentTime,setTimeout(function(){for(var e=0;16>e;e++){i.settings.WebMIDIPortOutput.send([176+e,120,0]);for(var t=0;128>t;t++)i.settings.WebMIDIPortOutput.send([128+e,t,0])}},200)}},e.prototype.play=function(e){var t=this.context,i=this.settings,n=this.trigger,r=this.states,a=this.hashedDataList,o=this;if(1!=r.isPlaying){if(i.isWebMIDI&&!e){if("completed"!=r.webMIDIWaitState){if("waiting"!=r.webMIDIWaitState){r.webMIDIWaitState="waiting";var s=800-1e3*(t.currentTime-r.webMIDIStopTime);0==r.webMIDIStopTime&&(s=800),setTimeout(function(){o.states.webMIDIWaitState="completed",o.states.isPlaying=!1,o.play()},s)}return}r.webMIDIWaitState=null}{var u=this.context.currentTime;r.startTime}r.isPlaying=!0,r.startTime=r.startTime||r.stopTime?r.startTime+u-r.stopTime:u,r.stopFuncs=[];var c=this.getTime(this.firstNoteOnTiming);-r.startTime+u<c&&this.setStartTime(c+r.startTime-u);var l,f=function(){o.clearFunc("rootTimeout",l);var e=o.getTime(o.settings.isCC111&&-1!=o.cc111Time?o.lastNoteOffTiming:o.getTiming(Number.MAX_SAFE_INTEGER));e-t.currentTime+r.startTime<=0?o.onSongEnd():(l=setTimeout(f,1),o.pushFunc({rootTimeout:l,stopFunc:function(){clearTimeout(l)}}))},h=this.getTime(this.settings.isCC111&&-1!=this.cc111Time?this.lastNoteOffTiming:this.getTiming(Number.MAX_SAFE_INTEGER)),p=1e3*(h-t.currentTime+r.startTime);l=setTimeout(f,p),o.pushFunc({rootTimeout:l,stopFunc:function(){clearTimeout(l)}}),function d(e){if(r.playIndex=e,a&&a[e]&&a[e].forEach(function(e){i.isWebMIDI||o.pushFunc({note:e,stopFunc:9!=e.channel?o.createNote(e):o.createPercussionNote(e)});var a=setTimeout(function(){o.clearFunc("timeout",a),n.isNoteTrigger&&n.noteOn(e);var t=setTimeout(function(){o.clearFunc("timeout",t),o.clearFunc("note",e),n.isNoteTrigger&&n.noteOff(e)},9!=e.channel?1e3*(o.getTime(e.stop)-o.getTime(e.start)):1e3*o.settings.dramMaxPlayLength);o.pushFunc({timeout:t,stopFunc:function(){clearTimeout(t)}})},1e3*(o.getTime(e.start)-t.currentTime+r.startTime));o.pushFunc({timeout:a,stopFunc:function(){clearTimeout(a)}})}),i.isWebMIDI&&o.hashedMessageList&&o.hashedMessageList[e]&&o.hashedMessageList[e].forEach(function(e){if(null!=i.WebMIDIPortOutput&&255!=e.message[0]&&(o.settings.WebMIDIPortSysEx||240!=e.message[0]&&247!=e.message[0]))try{i.WebMIDIPortOutput.send(e.message,1e3*(o.getTime(e.timing)-t.currentTime+window.performance.now()/1e3+r.startTime))}catch(n){console.log(n,e.message)}}),e<a.length)if(e-Math.floor(1e3*(t.currentTime-r.startTime)/i.hashLength)<=i.hashBuffer)d(e+1);else{var s=setTimeout(function(){d(e+1),o.clearFunc("rootTimeout",s)},i.hashLength);o.pushFunc({rootTimeout:s,stopFunc:function(){clearTimeout(s)}})}else n.songEnd()}(r.playIndex||0)}},e.prototype.setData=function(e){this.states.isPlaying&&this.stop(),this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming;var t=this,i=[];if(e.channels.forEach(function(e){e.notes.forEach(function(e){var n=t.getTime(e.start)*(1e3/t.settings.hashLength);i[Math.floor(n)]||(i[Math.floor(n)]=[]),i[Math.floor(n)].push(e)})}),this.settings.isWebMIDI){var n=[];e.messages.forEach(function(e){var i=t.getTime(e.timing)*(1e3/t.settings.hashLength);n[Math.floor(i)]||(n[Math.floor(i)]=[]),n[Math.floor(i)].push(e)}),this.hashedMessageList=n}return this.hashedDataList=i,this.initStatus(),this},e.prototype.getMasterVolume=function(){return this.settings.masterVolume},e.prototype.setMasterVolume=function(e){this.settings.masterVolume=e,this.masterGainNode.gain.value=this.settings.masterVolume},e.prototype.isLoop=function(){return this.settings.loop},e.prototype.setLoop=function(e){this.settings.loop=e},e.prototype.isWebMIDI=function(){return this.settings.isWebMIDI},e.prototype.setWebMIDI=function(e){this.settings.isWebMIDI=e},e.prototype.isCC111=function(){return this.settings.isCC111},e.prototype.setCC111=function(e){this.settings.isCC111=e},e.prototype.setStartTime=function(e){this.states.startTime-=e,this.states.playIndex=Math.floor(1e3*e/this.settings.hashLength)},e.prototype.setOnSongEndListener=function(e){this.onSongEndListener=e},e.prototype.onSongEnd=function(){if(this.onSongEndListener){var e=this.onSongEndListener();if(e)return}this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.getTime(this.cc111Time)),this.play(!0))},e.prototype.isReverb=function(){return this.settings.isReverb},e.prototype.setReverb=function(e){this.settings.isReverb=e},e.prototype.getReverbVolume=function(){return this.settings.reverbVolume},e.prototype.setReverbVolume=function(e){this.settings.reverbVolume=e},e.prototype.isChorus=function(){return this.settings.isChorus},e.prototype.setChorus=function(e){this.settings.isChorus=e},e.prototype.getChorusVolume=function(){return this.settings.chorusVolume},e.prototype.setChorusVolume=function(e){this.settings.chorusVolume=e},e.prototype.isAndroid=function(){var e=navigator.userAgent.toLowerCase();return-1!=e.indexOf("android")&&-1==e.indexOf("windows")},e.prototype.getTime=function(e){var t=0,i=120,n=0,r=this;return this.tempoTrack.some(function(a){return e<a.timing?!0:(t+=60/i/r.settings.resolution*(a.timing-n),n=a.timing,void(i=a.value))}),t+=60/i/r.settings.resolution*(e-n)},e.prototype.getTiming=function(e){var t=0,i=120,n=0,r=this;return this.tempoTrack.some(function(a){return t+=60/i/r.settings.resolution*(a.timing-n),t>e?(t-=60/i/r.settings.resolution*(a.timing-n),n+=(e-t)/(60/i/r.settings.resolution),!0):(n=a.timing,void(i=a.value))}),n},e.prototype.parseSMF=function(e){function t(e){for(var t=0,i=0;i<e.length;i++)t=(t<<8)+e[i];return t}function i(e){for(var t=0,i=0;t<e.length-1&&e[t]>=128;)4>t&&(i=(i<<7)+(e[t]-128)),t++;return i=(i<<7)+e[t],t++,[i,t]}if(77!=e[0]||84!=e[1]||104!=e[2]||100!=e[3])return"Not Sandard MIDI File.";var n=new Object,r=4,a=new Object;a.size=t(e.subarray(4,8)),a.format=e[9],a.trackcount=t(e.subarray(10,12)),a.timemanage=e[12],a.resolution=t(e.subarray(12,14)),r+=4+a.size;for(var o=new Array,s=new Array,u=new Array,c=-1,l=Number.MAX_SAFE_INTEGER,f=0,h=0;16>h;h++){var p=new Object;u.push(p),p.messages=[],p.notes=[]}var d=0;if(this.settings.isWebMIDI)var m=[];for(var g=0;g<a.trackcount;g++){if(77!=e[r]||84!=e[r+1]||114!=e[r+2]||107!=e[r+3])return"Irregular SMF.";r+=4;var v=(new Object,r+4+t(e.subarray(r,r+4)));r+=4;for(var y=0,b=1;v>r;){if(null!=b){var T=i(e.subarray(r,r+5)),M=T[0];y+=M,y>1e8&&(y=1e8),r+=T[1]}if(this.settings.isWebMIDI)var A=r;var S,P={timing:y,mes:[]};switch(Math.floor(e[r]/16)){case 8:case 9:case 10:case 11:case 14:b=e[r],P.mes.push(e[r],e[r+1],e[r+2]);var w=u[15&b].messages;for(S=w.length-1;S>=0;S--){var L=w[S];if(y>=L.timing)break}S++,w.splice(S,0,P),r+=3;break;case 12:case 13:b=e[r],P.mes.push(e[r],e[r+1]);var w=u[15&b].messages;for(S=w.length-1;S>=0;S--){var L=w[S];if(y>=L.timing)break}S++,w.splice(S,0,P),r+=2;break;case 15:switch(e[r]){case 240:case 247:var T=i(e.subarray(r+1,r+1+4));if(T[0]>=7&&127==e[r+2]&&127==e[r+3]&&4==e[r+4]&&1==e[r+5])for(var h=0;16>h;h++){P.mes.push(e[r],T[0]-1,e[r+2],e[r+3],e[r+4],e[r+5],e[r+6],e[r+7]);var w=u[h].messages;for(S=w.length-1;S>=0;S--){var L=w[S];if(y>=L.timing)break}S++,w.splice(S,0,P)}r+=1+T[1]+T[0];break;case 241:r+=2;break;case 242:r+=3;break;case 243:r+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:r+=1;break;case 255:switch(e[r+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:y+=-M;break;case 81:n.tempo=6e7/(65536*e[r+3]+256*e[r+4]+e[r+5]),o.push({timing:y,value:6e7/(65536*e[r+3]+256*e[r+4]+e[r+5])});break;case 84:break;case 88:s.push({timing:y,value:[e[r+3],Math.pow(2,e[r+4])]});break;case 89:case 127:}var T=i(e.subarray(r+2,r+2+4));r+=2+T[1]+T[0]}break;default:if(null==b)return"Irregular SMF.";r--,e[r]=b,b=null}if(this.settings.isWebMIDI&&null!=b){var x=e[A];if(240==x||247==x){if(this.settings.WebMIDIPortSysEx){var T=i(e.subarray(A+1,A+1+4)),B=A+1+T[1],D=B+T[0],E=new Uint8Array(1+T[0]);E[0]=x;for(var I=D-B,h=0;I>h;h++)E[h+1]=e[B+h];m.push({message:E,timing:y})}}else m.push({message:e.subarray(A,r),timing:y})}}y>d&&(d=y)}o.push({timing:d,value:120});for(var N=0;N<u.length;N++){for(var p=u[N],r=0,v=p.messages.length,G=2,k=0,_=64,O=127,R=100,C=0,V=0,F=0,W=127,j=127,U=127,q=127,$=null,z=127,K=[];v>r;){var P=p.messages[r],y=P.timing,H=p.messages[r].mes;switch(Math.floor(H[0]/16)){case 8:var h=0;K.some(function(e){var t=p.notes[e];return t.pitch==H[1]&&null==t.stop?(t.stop=y,K.splice(h,1),y>f&&(f=y),!0):void h++});break;case 9:if(0!=H[2]){var X={start:y,stop:null,pitch:H[1],pitchBend:[{timing:y,value:k}],pan:[{timing:y,value:_}],expression:[{timing:y,value:O*(z/127)}],velocity:H[2]/127*(R/127),modulation:[{timing:y,value:C}],reverb:[{timing:y,value:V}],chorus:[{timing:y,value:F}],instrument:$,channel:N};K.push(p.notes.length),p.notes.push(X),l>y&&(l=y)}else{var h=0;K.some(function(e){var t=p.notes[e];return t.pitch==H[1]&&null==t.stop?(t.stop=y,K.splice(h,1),y>f&&(f=y),!0):void h++})}break;case 10:break;case 11:switch(H[1]){case 1:C=H[2],K.forEach(function(e){var t=p.notes[e];t.modulation.push({timing:y,value:C})});break;case 6:0==U&&0==q&&(G=H[2],G>24&&(G=24));break;case 7:R=H[2];break;case 10:_=H[2],K.forEach(function(e){var t=p.notes[e];t.pan.push({timing:y,value:_})});break;case 11:O=H[2],K.forEach(function(e){var t=p.notes[e];t.expression.push({timing:y,value:O*(z/127)})});break;case 91:V=H[2],K.forEach(function(e){var t=p.notes[e];t.reverb.push({timing:y,value:V})});break;case 93:F=H[2],K.forEach(function(e){var t=p.notes[e];t.chorus.push({timing:y,value:F})});break;case 98:W=H[2];break;case 99:j=H[2];break;case 100:U=H[2];break;case 101:q=H[2];break;case 111:-1==c&&(c=y)}break;case 12:$=H[1];break;case 13:break;case 14:k=(128*H[2]+H[1]-8192)/8192*G,K.forEach(function(e){var t=p.notes[e];t.pitchBend.push({timing:y,value:k})});break;case 15:switch(H[0]){case 240:case 247:if(H[1]>=6&&127==H[2]&&127==H[3]&&4==H[4]&&1==H[5]){var Y=H[7];Y>127&&(Y=127),z=Y,K.forEach(function(e){var t=p.notes[e];t.expression.push({timing:y,value:O*(z/127)})})}}break;default:return"Error parseSMF."}r++}delete p.messages}return n.header=a,n.tempoTrack=o,n.beatTrack=s,n.channels=u,n.songLength=d,n.cc111Time=c,n.firstNoteOnTiming=l,n.lastNoteOffTiming=f,this.settings.isWebMIDI&&(n.messages=m),n},e.prototype.stopAudioNode=function(e,t,i){try{t>0?e.stop(t):(e.stop(this.context.currentTime+.005),i.gain.cancelScheduledValues(this.context.currentTime),i.gain.linearRampToValueAtTime(0,this.context.currentTime+.005))}catch(n){i.gain.cancelScheduledValues(t),0>=t&&i.gain.linearRampToValueAtTime(0,this.context.currentTime+.005)}},e.prototype.pushFunc=function(e){(e.note||e.rootTimeout||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)},e.prototype.clearFunc=function(e,t){if("note"==e||"rootTimeout"==e||this.trigger.isNoteTrigger){var i=this;i.states.stopFuncs.some(function(n,r){return n[e]==t?(i.states.stopFuncs.splice(r,1),!0):void 0})}},e}();requireSimulator.setName("T2MediaLib");var T2MediaLib_BGMPlayer=function(e){this.id=e,this.playingState="stop",this.playingStatePending=null,this.playingBGM=null,this.playingBGMName=null,this.bgmPause=0,this.bgmPauseTime=0,this.bgmPauseCurrentTime=0,this.bgmPauseTempo=0,this.bgmPauseLoop=!1,this.bgmPauseLoopStart=0,this.bgmPauseLoopEnd=0,this.bgmVolume=1,this.bgmTempo=1,this.bgmPan=0,this.picoAudio=null,this.picoAudioSetDataBGMName=null,this.PICO_AUDIO_VOLUME_COEF=1};T2MediaLib_BGMPlayer.prototype.playBGM=function(e,t,i,n,r){if(!T2MediaLib.context)return null;this.stopBGM();var a=T2MediaLib.soundDataAry[e];if(null==a)return null;if(!a.isDecodeComplete()){if(!a.isDecoding()){var o=this,s={};s.succ=function(){var a=o.playingStatePending;o._setPlayingState("stop",!0),"stop"!=a&&o.playBGM(e,t,i,n,r),"pause"==a&&o.pauseBGM()},s.err=function(){o._setPlayingState("stop",!0)},this.playingBGMName=e,this._setPlayingState("decoding",!0),T2MediaLib.decodeSound(e,s)}return this}var u=a.decodedData;if(u instanceof AudioBuffer)this.playingBGM=T2MediaLib.playSE(e,this.bgmVolume,this.bgmPan,this.bgmTempo,i,t,n,r);else if(u instanceof Object){if(null==this.picoAudio&&(this.picoAudio=new PicoAudio(T2MediaLib.context,T2MediaLib.picoAudio)),e!=this.picoAudioSetDataBGMName?(this.picoAudio.setData(u),this.picoAudioSetDataBGMName=e):this.picoAudio.initStatus(),this.picoAudio.setLoop(t),this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*this.bgmVolume*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),i){var c=this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER));i>c?i=c:0>i&&(i=0)}else i=0;this.picoAudio.setStartTime(i),this.picoAudio.play(),this.playingBGM=this.picoAudio}return this.playingBGMName=e,this.bgmPause=0,this._setPlayingState("play"),this},T2MediaLib_BGMPlayer.prototype.stopBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.stop():e instanceof AudioBufferSourceNode&&e.stop(0),this.playingBGM=null,this.playingBGMName=null,this._setPlayingState("stop"),this},T2MediaLib_BGMPlayer.prototype.pauseBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseCurrentTime=e.context.currentTime,e.stop(),this.bgmPause=1):e instanceof AudioBufferSourceNode&&0===this.bgmPause&&(this.bgmPauseTime=this.getBGMCurrentTime(),this.bgmPauseLoopStart=T2MediaLib.getSELoopStartTime(e),this.bgmPauseLoopEnd=T2MediaLib.getSELoopEndTime(e),this.bgmPauseLoop=T2MediaLib.isSELoop(e),this.bgmPauseCurrentTime=e.context.currentTime,this.bgmPauseTempo=this.bgmTempo,e.stop(0),this.bgmPause=1),"stop"!=this.playingState&&this._setPlayingState("pause"),this},T2MediaLib_BGMPlayer.prototype.resumeBGM=function(){var e=this.playingBGM;return e instanceof PicoAudio?1===this.bgmPause&&(e.play(),this.bgmPause=0):e instanceof AudioBufferSourceNode&&1===this.bgmPause&&(e=this.playBGM(this.playingBGMName,this.bgmPauseLoop,this.bgmPauseTime,this.bgmPauseLoopStart,this.bgmPauseLoopEnd)),this},T2MediaLib_BGMPlayer.prototype.onChangeBGMMasterVolume=function(){this.setBGMVolume(this.getBGMVolume())},T2MediaLib_BGMPlayer.prototype.getBGMVolume=function(){return this.bgmVolume},T2MediaLib_BGMPlayer.prototype.setBGMVolume=function(e){var t=this.playingBGM;return this.bgmVolume=e,t instanceof PicoAudio?this.picoAudio.setMasterVolume(this.PICO_AUDIO_VOLUME_COEF*e*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume):t instanceof AudioBufferSourceNode&&(t.gainNode.gain.value=e*T2MediaLib.bgmMasterVolume*T2MediaLib.masterVolume),this},T2MediaLib_BGMPlayer.prototype.getBGMTempo=function(){return this.bgmTempo},T2MediaLib_BGMPlayer.prototype.setBGMTempo=function(e){var t=this.playingBGM;return 0>=e&&(e=1),t instanceof AudioBufferSourceNode&&0===this.bgmPause&&(t.plusTime-=(T2MediaLib.context.currentTime-t.playStartTime)*(e-this.bgmTempo)),this.bgmTempo=e,T2MediaLib.setSERate(t,e),this},T2MediaLib_BGMPlayer.prototype.getBGMPan=function(){return this.bgmPan},T2MediaLib_BGMPlayer.prototype.setBGMPan=function(e){var t=this.playingBGM;return this.bgmPan=e,t instanceof AudioBufferSourceNode&&T2MediaLib.setSEPan(t,e),this},T2MediaLib_BGMPlayer.prototype.isBGMLoop=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.isLoop():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoop:T2MediaLib.isSELoop(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoop=function(e){var t=this.playingBGM;return t instanceof PicoAudio?this.picoAudio.setLoop(e):t instanceof AudioBufferSourceNode&&(1===this.bgmPause?this.bgmPauseLoop=e:T2MediaLib.setSELoop(t,e)),this},T2MediaLib_BGMPlayer.prototype.getBGMLoopStartTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?0:e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopStart:T2MediaLib.getSELoopStartTime(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopStartTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopStartTime(t,e);this.bgmPauseLoopStart=e}return this},T2MediaLib_BGMPlayer.prototype.getBGMLoopEndTime=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.getBGMLength():e instanceof AudioBufferSourceNode?1===this.bgmPause?this.bgmPauseLoopEnd:T2MediaLib.getSELoopEndTime(e):null},T2MediaLib_BGMPlayer.prototype.setBGMLoopEndTime=function(e){var t=this.playingBGM;if(t instanceof AudioBufferSourceNode){if(1!==this.bgmPause)return T2MediaLib.setSELoopEndTime(t,e);this.bgmPauseLoopEnd=e}return this},T2MediaLib_BGMPlayer.prototype.getBGMCurrentTime=function(){var e=this.playingBGM;if(e instanceof PicoAudio){var t;return t=0===this.bgmPause?this.picoAudio.getTime(this.picoAudio.getTiming(this.picoAudio.context.currentTime-this.picoAudio.states.startTime)):this.bgmPauseTime}if(e instanceof AudioBufferSourceNode){var t,i,n,r,a,o,s;return 0===this.bgmPause?(n=T2MediaLib.context.currentTime,r=this.bgmTempo):(n=this.bgmPauseCurrentTime,r=this.bgmPauseTempo),i=(n-e.playStartTime)*r+e.plusTime,e.loop&&(e.loopEnd-e.loopStart>0?i<e.loopStart?(a=0,o=0,s=e.buffer.duration):(a=e.loopStart,o=e.loopStart,s=e.loopEnd-e.loopStart):(s=e.buffer.duration,a=0,o=0)),e.loop?t=(i-o)%s+a:(t=i,t>e.buffer.duration&&(t=e.buffer.duration)),t}return null},T2MediaLib_BGMPlayer.prototype.getBGMLength=function(){var e=this.playingBGM;return e instanceof PicoAudio?this.picoAudio.getTime(this.picoAudio.getTiming(Number.MAX_SAFE_INTEGER)):e instanceof AudioBufferSourceNode?e.buffer.duration:null},T2MediaLib_BGMPlayer.prototype.getPlayingBGMName=function(){return this.playingBGMName},T2MediaLib_BGMPlayer.prototype.setOnBGMEndListener=function(e){null==this.picoAudio&&this.picoAudio.setOnSongEndListener(e)},T2MediaLib_BGMPlayer.prototype.getPlayingState=function(){return this.playingState
},T2MediaLib_BGMPlayer.prototype._setPlayingState=function(e,t){t||"decoding"!=this.playingState?(this.playingState=e,this.playingStatePending=null):this.playingStatePending=e};var T2MediaLib_SoundData=function(){this.state="none",this.errorID=null,this.url=null,this.fileData=null,this.decodedData=null};T2MediaLib_SoundData.prototype.onLoad=function(e){this.state="loading",this.url=e},T2MediaLib_SoundData.prototype.onLoadComplete=function(e){this.state="loaded",this.fileData=e},T2MediaLib_SoundData.prototype.onDecode=function(){this.state="decoding"},T2MediaLib_SoundData.prototype.onDecodeComplete=function(e){this.state="decoded",this.decodedData=e},T2MediaLib_SoundData.prototype.onError=function(e){this.state="error",this.errorID=e},T2MediaLib_SoundData.prototype.isLoadComplete=function(){switch(this.state){case"loaded":case"decoding":case"decoded":return!0}return!1},T2MediaLib_SoundData.prototype.isDecoding=function(){return"decoding"==this.state},T2MediaLib_SoundData.prototype.isDecodeComplete=function(){return"decoded"==this.state},T2MediaLib_SoundData.prototype.getDecodedData=function(){return this.decodedData};var T2MediaLib={context:null,picoAudio:null,soundDataAry:[],bgmPlayerMax:16,bgmPlayerAry:[],masterVolume:1,seMasterVolume:1,bgmMasterVolume:1,playingAudio:null,audioVolume:1,audioTempo:1,audioDataAry:{data:[]},init:function(){if(!this.inited&&(this.inited=!0,!this.disabled&&(window.AudioContext?T2MediaLib.context=new AudioContext:window.webkitAudioContext?T2MediaLib.context=new webkitAudioContext:(T2MediaLib.context=null,console.log("Your browser does not support yet Web Audio API")),T2MediaLib.context))){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.bgmPlayerAry[e]=new T2MediaLib_BGMPlayer(e);T2MediaLib.picoAudio=new PicoAudio(T2MediaLib.context)}},allClearData:function(){var e=T2MediaLib.soundDataAry;for(var t in e)delete e[t]},clearData:function(e){var t=T2MediaLib.soundDataAry;delete t[e]},getMasterVolume:function(){return T2MediaLib.masterVolume},setMasterVolume:function(e){T2MediaLib.masterVolume=e;for(var t=0;t<T2MediaLib.bgmPlayerMax;t++){var i=T2MediaLib.bgmPlayerAry[t];i instanceof T2MediaLib_BGMPlayer&&i.onChangeBGMMasterVolume()}},loadSoundFromArray:function(e,t,i){T2MediaLib.soundDataAry[e]=new T2MediaLib_SoundData;for(var n=T2MediaLib.context,r=null!=t&&null!=i?2:1,a=n.createBuffer(r,array.length,n.sampleRate),o=a.getChannelData(0),s=null!=i?a.getChannelData(1):null,u=0;u<array.length;u++)o[u]=t[u];if(s)for(var u=0;u<array.length;u++)s[u]=i[u];T2MediaLib.soundDataAry[e].onDecodeComplete(a)},loadSound:function(e,t,i){if(T2MediaLib.soundDataAry[e]=new T2MediaLib_SoundData,!T2MediaLib.context||T2MediaLib.disabled)return T2MediaLib.soundDataAry[e].onError("FUNC_DISABLED_ERROR"),null;"object"==typeof WebSite&&WebSite.mp3Disabled&&(t=t.replace(/\.(mp3|mp4|m4a)$/,".ogg"));var n=new XMLHttpRequest;n.onload=function(){if(200===n.status||0===n.status){var t=n.response;t instanceof ArrayBuffer?(T2MediaLib.soundDataAry[e].onLoadComplete(t),i&&i.succ&&i.succ(e)):(T2MediaLib.soundDataAry[e].onError("XHR_RESPONSE_ERROR"),i&&i.err&&i.err(e,T2MediaLib.soundDataAry[e]))}else T2MediaLib.soundDataAry[e].onError("XHR_STATUS_ERROR"),i&&i.err&&i.err(e,T2MediaLib.soundDataAry[e])},n.onerror=function(t){T2MediaLib.soundDataAry[e].onError("XHR_ERROR"),i&&i.err&&i.err(e,t+"")},T2MediaLib.soundDataAry[e].onLoad(t),t.match(/^data:/)&&Util&&Util.Base64_To_ArrayBuffer?(n={onload:n.onload},n.response=Util.Base64_To_ArrayBuffer(t.replace(/^data:audio\/[a-zA-Z0-9]+;base64,/i,"")),n.status=200,n.onload()):(n.open("GET",t,!0),n.responseType="arraybuffer",n.send(null))},decodeSound:function(e,t){var i=T2MediaLib.soundDataAry[e];if(null!=i){var n=i.fileData;if(i.onDecode(),i.url.match(/\.(midi?)$/)||i.url.match(/^data:audio\/mid/)){null==T2MediaLib.picoAudio&&(T2MediaLib.picoAudio=new PicoAudio(T2MediaLib.context));var r=new Uint8Array(n),a=T2MediaLib.picoAudio.parseSMF(r);T2MediaLib.soundDataAry[e].onDecodeComplete(a),t&&t.succ&&t.succ(e)}else{var o=function(i){T2MediaLib.soundDataAry[e].onDecodeComplete(i),t&&t.succ&&t.succ(e)},s=function(n){n instanceof Error?console.log("T2MediaLib: "+n.message,i.url):console.log("T2MediaLib: Error decodeAudioData()",i.url),T2MediaLib.soundDataAry[e].onError("DECODE_ERROR"),t&&t.err&&t.err(e,T2MediaLib.soundDataAry[e])};T2MediaLib.context.decodeAudioData(n,o,s)}}},activate:function(){if(this.init(),!this.isActivated){this.isActivated=!0;for(var e=T2MediaLib.context,t=e.createBuffer(1,Math.floor(e.sampleRate/32),e.sampleRate),i=t.getChannelData(0),n=(Math.floor(e.sampleRate/860),0);n<i.length;n++)i[n]=0;var r=e.createBufferSource();r.buffer=t,r.connect(e.destination),r.noteOn?r.noteOn(0):r.start&&r.start(0)}},getSoundData:function(e){var t=T2MediaLib.soundDataAry[e];return t?t.getDecodedData():null},playSE:function(e,t,i,n,r,a,o,s){if(!T2MediaLib.context)return null;var u=T2MediaLib.soundDataAry[e];if(null==u)return null;if(!u.isDecodeComplete()){var c={};return c.succ=function(){T2MediaLib.playSE(e,t,i,n,r,a,o,s)},c.err=function(){},T2MediaLib.decodeSound(e,c),null}var l=u.decodedData;if(!(l instanceof AudioBuffer))return null;null==t&&(t=1),null==i&&(i=0),n||(n=1),r?r>l.duration?r=l.duration:0>r&&(r=0):r=0,a||(a=!1),o?0>o?o=0:o>l.duration&&(o=l.duration):o=0,s?0>s?s=0:s>l.duration&&(s=l.duration):s=l.duration;var f=T2MediaLib.context.createBufferSource();T2MediaLib.context.createGain=T2MediaLib.context.createGain||T2MediaLib.context.createGainNode;var h=T2MediaLib.context.createGain(),p=T2MediaLib.context.createPanner();f.buffer=l,f.loop=a,f.loopStart=o,f.loopEnd=s,f.playbackRate.value=n,f.connect(h),h.connect(p),p.connect(T2MediaLib.context.destination),p.panningModel="equalpower",-1>i?i=-1:i>1&&(i=1);var d=90*i,m=Math.sin(d*(Math.PI/180)),g=-Math.cos(d*(Math.PI/180));(-1===i||1===i)&&(g=0),p.positionX?(p.positionX.value=m,p.positionY.value=0,p.positionZ.value=g):p.setPosition(m,0,g),h.gain.value=t*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume;var v;return v=a&&s-o>0&&r>s?s:r,f.gainNode=h,f.volumeValue=t,f.panNode=p,f.panValue=i,f.playStartTime=T2MediaLib.context.currentTime,f.playOffset=v,f.plusTime=v,f.start=f.start||f.noteOn,f.stop=f.stop||f.noteOff,r?a?f.start(0,r,86400):f.start(0,r):f.start(0),f.onended=function(){f.disconnect(),f.onended=null,delete f.gainNode,delete f.panNode},f},stopSE:function(e){return e instanceof AudioBufferSourceNode?(e.stop(0),e):null},getSEMasterVolume:function(){return T2MediaLib.seMasterVolume},setSEMasterVolume:function(e){T2MediaLib.seMasterVolume=e},getSEVolume:function(e){return e instanceof AudioBufferSourceNode?source.volumeValue:null},setSEVolume:function(e,t){return e instanceof AudioBufferSourceNode?(e.gainNode.gain.value=t*T2MediaLib.seMasterVolume*T2MediaLib.masterVolume,source.volumeValue=t,e):null},getSERate:function(e){return e instanceof AudioBufferSourceNode?e.playbackRate.value:null},setSERate:function(e,t){return e instanceof AudioBufferSourceNode?void(e.playbackRate.value=t):null},getSEPan:function(e){return e instanceof AudioBufferSourceNode?e.panValue:null},setSEPan:function(e,t){if(!(e instanceof AudioBufferSourceNode))return null;var i=e.panNode;-1>t?t=-1:t>1&&(t=1);var n=90*t,r=Math.sin(n*(Math.PI/180)),a=Math.cos(n*(Math.PI/180));(-1===t||1===t)&&(a=0),i.positionX?(i.positionX.value=r,i.positionY.value=0,i.positionZ.value=a):i.setPosition(r,0,a),e.panValue=t},isSELoop:function(e){return e instanceof AudioBufferSourceNode?e.loop:null},setSELoop:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loop=t):null},getSELoopStartTime:function(e){return e instanceof AudioBufferSourceNode?e.loopStart:null},setSELoopStartTime:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopStart=t):null},getSELoopEndTime:function(e){return e instanceof AudioBufferSourceNode?e.loopEnd:null},setSELoopEndTime:function(e,t){return e instanceof AudioBufferSourceNode?void(e.loopEnd=t):null},playBGM:function(e,t,i,n,r,a){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var o=T2MediaLib.bgmPlayerAry[e];return o instanceof T2MediaLib_BGMPlayer?o.playBGM(t,i,n,r,a):null},stopBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.stopBGM():null},pauseBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.pauseBGM():null},resumeBGM:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.resumeBGM():null},getBGMMasterVolume:function(){return T2MediaLib.bgmMasterVolume},setBGMMasterVolume:function(e){T2MediaLib.bgmMasterVolume=e;for(var t=0;t<T2MediaLib.bgmPlayerMax;t++){var i=T2MediaLib.bgmPlayerAry[t];i instanceof T2MediaLib_BGMPlayer&&i.onChangeBGMMasterVolume()}},getBGMVolume:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMVolume():null},setBGMVolume:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMVolume(t):null},getBGMTempo:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMTempo():null},setBGMTempo:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMTempo(t):null},getBGMPan:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMPan():null},setBGMPan:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMPan(t):null},isBGMLoop:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.isBGMLoop():null},setBGMLoop:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoop(t):null},getBGMLoopStartTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLoopStartTime():null},setBGMLoopStartTime:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoopStartTime(t):null},getBGMLoopEndTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLoopEndTime():null},setBGMLoopEndTime:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setBGMLoopEndTime(t):null},getBGMCurrentTime:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMCurrentTime():null},getBGMLength:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getBGMLength():null},getPlayingBGMName:function(e){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var t=T2MediaLib.bgmPlayerAry[e];return t instanceof T2MediaLib_BGMPlayer?t.getPlayingBGMName():null},setOnBGMEndListener:function(e,t){if(0>e||T2MediaLib.bgmPlayerMax<=e)return null;var i=T2MediaLib.bgmPlayerAry[e];return i instanceof T2MediaLib_BGMPlayer?i.setOnBGMEndListener(t):null},getBGMPlayerMax:function(){return T2MediaLib.bgmPlayerMax},allStopBGM:function(){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.stopBGM(e)},allResetBGM:function(){for(var e=0;e<T2MediaLib.bgmPlayerMax;e++)T2MediaLib.stopBGM(e),T2MediaLib.setBGMVolume(e,1),T2MediaLib.setBGMTempo(e,1),T2MediaLib.setBGMPan(e,0);T2MediaLib.setMasterVolume(1),T2MediaLib.setSEMasterVolume(1),T2MediaLib.setBGMMasterVolume(1)},loadAudio:function(e,t){var i=new Audio(t);i.play(),T2MediaLib.audioDataAry.data[e]=null,i.addEventListener("loadstart",function(){if(!T2MediaLib.context)return null;var e=T2MediaLib.context.createMediaElementSource(i);e.connect(T2MediaLib.context.destination)},!1),i.addEventListener("canplay",function(){T2MediaLib.audioDataAry.data[e]=i},!1),i.load()},playAudio:function(e,t,i){var n=T2MediaLib.audioDataAry.data[e];return n?(i||(i=0),T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.pause(),T2MediaLib.playingAudio.currentTime=0),T2MediaLib.playingAudio=n,n.loop=t,n.volume=T2MediaLib.audioVolume,n.currentTime=i,n.play(),n):null},stopAudio:function(){var e=T2MediaLib.playingAudio;return e instanceof Audio?(e.pause(),e.currentTime=0,T2MediaLib.playingAudio=null,e):null},pauseAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.pause(),e):null},resumeAudio:function(){var e=T2MediaLib.playingAudio;return e?(e.play(),e):null},setAudioVolume:function(e){T2MediaLib.audioVolume=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.volume=e)},setAudioTempo:function(e){T2MediaLib.audioTempo=e,T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.playbackRate=e)},setAudioPosition:function(e){T2MediaLib.playingAudio instanceof Audio&&(T2MediaLib.playingAudio.currentTime=e)},getAudioData:function(e){return T2MediaLib.audioDataAry.data[e]},getAudioCurrentTime:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.currentTime:null},getAudioLength:function(){return T2MediaLib.playingAudio instanceof Audio?T2MediaLib.playingAudio.duration:null}};requireSimulator.setName("exceptionCatcher"),define([],function(){var e={};return e.f=function(t){if("function"==typeof t){if(t.isTrcf)return t;var i=function(){if(!e.handleException||e.enter)return t.apply(this,arguments);try{return e.enter=!0,t.apply(this,arguments)}catch(i){e.handleException(i)}finally{e.enter=!1}};return i.isTrcf=!0,i}if("object"==typeof t){for(var n in t)t[n]=e.f(t[n]);return t}},e}),requireSimulator.setName("UI"),define(["Util","exceptionCatcher"],function(e,t){var i={},n=t.f;return i=function(){function t(){l.forEach(function(e){e()}),setTimeout(n(t),50)}function r(e){return e instanceof Array?a(e):"string"==typeof e?s(e):e}function a(e){var t=e[0],i=1,n=$("<"+t+">");for("object"!=typeof e[i]||e[i]instanceof Array||e[i]instanceof $||(o(n,e[i],t),i++);i<e.length;)n.append(r(e[i])),i++;return n}function o(t,r){function a(e,i){if(i)if("enterkey"==e)t.on("keypress",n(function(e){13==e.which&&i.apply(t,arguments)}));else if("realtimechange"==e){var a,o=!0;l.push(function(){var e;e="checkbox"==r.type?!!t.prop("checked"):t.val(),(o||a!=e)&&(i.apply(t,[e,a]),a=e),o=!1})}else t.on(e,n(i))}r.$var&&(f[r.$var]=t),r.$edit&&("string"==typeof r.$edit&&(r.$edit={name:r.$edit,type:i.types.String}),r.on||(r.on={}),r.on.realtimechange=n(function(e){h.writeToModel(r.$edit,e,t)}),f[r.$edit.name]||(f[r.$edit.name]=t),h.push({jq:t,params:r}));for(var o in r)if("on"==o)for(var s in r.on)a(s,r.on[s]);else"css"==o&&null!=r[o]?t.css(r[o]):e.startsWith(o,"$")||null==r[o]||t.attr(o,r[o])}function s(e){return $("<span>").text(e)}for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];var l=[],f={},h=[],p=r(u);return p.$edits=h,p.$vars=f,h.load=function(e){h.model=e,h.forEach(function(e){h.writeToJq(e.params.$edit,e.jq)}),h.validator.on.validate.call(h.validator,h.model)},h.writeToJq=function(e,t){var i=h.model;if(i){for(var n=e.name,r=n.split("."),a=0;a<r.length;a++)i=i[r[a]];i=e.type.toVal(i),"checkbox"==t.attr("type")?t.prop("checked",!!i):t.val(i)}},h.validator={errors:{},show:function(){if(f.validationMessage){f.validationMessage.empty();for(var e in this.errors)f.validationMessage.append(i("div",this.errors[e].mesg))}if(f.OKButton){var t=!0;for(var e in this.errors)t=!1;f.OKButton.attr("disabled",!t)}},on:{validate:function(){}},addError:function(e,t,i){this.errors[e]={mesg:t,jq:i},this.show()},removeError:function(e){delete this.errors[e],this.show()},allOK:function(){for(var e in this.errors)delete this.errors[e];this.show()},isValid:function(){var e=!0;for(var t in this.errors)e=!1;return e}},h.writeToModel=function(e,t,i){var n=h.model;if(n){var r=e.name;try{t=e.type.fromVal(t)}catch(a){return void h.validator.addError(r,a,i)}h.validator.removeError(r);for(var o=r.split("."),s=0;s<o.length;s++)s==o.length-1?h.on.writeToModel(r,t)||(n[o[s]]=t):n=n[o[s]];h.validator.on.validate.call(h.validator,h.model)}},h.on={},h.on.writeToModel=function(){},l.length>0&&setTimeout(n(t),50),p},i.types={String:{toVal:function(e){return e},fromVal:function(e){return e}},Number:{toVal:function(e){return e+""},fromVal:function(e){return parseFloat(e)}}},i}),requireSimulator.setName("UIDiag"),define(["UI"],function(e){var t={};return t.confirm=function(t){function i(e){return function(){r.resolve(e),n.dialog("close"),n.remove()}}var n=e("div",{title:""},["div",t],["button",{on:{click:i(!0)}},"OK"],["button",{on:{click:i(!1)}},""]).dialog({width:"auto",close:i(!1)}),r=$.Deferred();return r.promise()},t.alert=function(t){function i(e){return function(){r.resolve(e),n.dialog("close"),n.remove()}}var n=e("div",{title:""},["div",t],["button",{on:{click:i(!0)}},"OK"]).dialog({width:"auto",close:i(!1)}),r=$.Deferred();return r.promise()},t.prompt=function(t,i){function n(){var e=a.$vars.val.val();o.resolve(e),a.dialog("close"),a.remove()}function r(){a.dialog("close"),a.remove(),o.resolve()}var a=e("div",{title:""},["div",t],["input",{on:{enterkey:n},$var:"val",value:i}],["br"],["button",{on:{click:n}},"OK"],["button",{on:{click:r}},""]).dialog({width:"auto",close:function(){a.dialog("close"),o.resolve()}});setTimeout(function(){a.$vars.val.focus()},10);var o=$.Deferred();return o.promise()},"undefined"!=typeof window&&(window.UIDiag=t),t}),requireSimulator.setName("runtime"),requirejs(["ImageList","PicoAudio","T2MediaLib","Tonyu","UIDiag"],function(){}),requireSimulator.setName("runScript2"),requirejs(["FS","compiledTonyuProject","Shell","runtime","WebSite","LSFS","Tonyu","NativeFS"],function(e,t,i,n,r,a,o){$(function(){function n(){var e=navigator.userAgent.toLowerCase();return-1==e.indexOf("iphone")&&-1==e.indexOf("ipad")&&-1==e.indexOf("ipod")||window==window.parent?0:40}function s(){var e=n();l=$(window).width(),f=$(window).height(),h.attr({width:l-e,height:f-e})}function u(){o.currentProject=o.globals.$currentProject=T;var e=T.getOptions();T.runScriptMode=!0,T.run(e.run.bootClass)}SplashScreen={hide:function(){$("#splash").hide()},show:function(){},progress:function(e){$("#splash").text(e)}};var c=n(),l=$(window).width(),f=$(window).height();$("body").css({overflow:"hidden",margin:"0px"});var h=$("<canvas>").attr({width:l-c,height:f-c}).appendTo("body");$(window).resize(s);var p;if(r.isNW){var d=location.href.replace(/^file:\/\//,"");d.match(/^\/[a-z]:/i)&&(d=d.replace(/^\//,"")),d=e.get(d),d.isDir()||(d=d.up()),p=d.rel("data/")}else{var m=location.href.replace(/\?.*/,"").split(/\//),g=m.pop()||"runscript",v=m.pop()||"nobody",d=e.get(r.tonyuHome),y=e.get("/ram/");e.mount(y.path(),a.ramDisk()),p=y;var b=d.rel(v+"/"+g+"/");y.rel("files/").link(b)}loadFiles(p),i.cd(p),r.compiledKernel="js/kernel.js","BA"===r.serverType&&(r.compiledKernel=window.runtimePath+"lib/tonyu/kernel.js");var T=t("user","js/concat.js",p);u()})}),requireSimulator.setName();