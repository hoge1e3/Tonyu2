!function(e){var t={};function a(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,a),n.l=!0,n.exports}a.m=e,a.c=t,a.d=function(e,t,i){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(a.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)a.d(i,n,function(t){return e[t]}.bind(null,n));return i},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=0)}([function(e,t,a){"use strict";function i(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}a.r(t);var n=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,a,n;return t=e,n=[{key:"resetSeed",value:function(){this.init=!0,this.x=123456789,this.y=362436069,this.z=521288629,this.w=8867512}},{key:"random",value:function(){this.init||this.resetSeed();var e=this.x^this.x<<11;this.x=this.y,this.y=this.z,this.z=this.w;var t=this.w=this.w^this.w>>>19^e^e>>>8;return t=Math.abs(t)/2147483648%2}}],(a=null)&&i(t.prototype,a),n&&i(t,n),e}();function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function u(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function o(e){var t="function"==typeof Map?new Map:void 0;return(o=function(e){if(null===e||(a=e,-1===Function.toString.call(a).indexOf("[native code]")))return e;var a;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return c(e,arguments,m(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),l(i,e)})(e)}function c(e,t,a){return(c=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,a){var i=[null];i.push.apply(i,t);var n=new(Function.bind.apply(e,i));return a&&l(n,a.prototype),n}).apply(null,arguments)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var p=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),u(this,m(t).apply(this,arguments))}var a,i,n;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,o(Array)),a=t,n=[{key:"delete",value:function(e,t){t==e.length-1?e.pop():0==t?e.shift():e.splice(t,1)}}],(i=null)&&r(a.prototype,i),n&&r(a,n),t}();function T(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,a,i;return t=e,i=[{key:"getInt",value:function(e,t,a){for(var i=0,n=t;n<a;n++)i=(i<<8)+e[n];return i}},{key:"variableLengthToInt",value:function(e,t,a){for(var i=t,n=0;i<a-1&&e[i]>=128;)i<t+4&&(n=(n<<7)+(e[i]-128)),i++;return[n=(n<<7)+e[i],++i-t]}},{key:"chIndicesInsert",value:function(e,t,a,i,n){var s=t.indices;if(s.length<=t.indicesLength+4){if(e.debug)var r=performance.now();for(var u=new Int32Array(Math.floor(2*s.length)),o=s.length-1;o>=0;o--)u[o]=s[o];t.indices=s=u,e.debug&&console.log("malloc",performance.now()-r,u.length)}if(t.indicesLength>=4&&a<s[t.indicesFoot])for(;-1!=t.indicesCur;){if(a<s[t.indicesCur]){t.indicesCur==t.indicesHead?t.indicesHead=t.indicesLength:s[t.indicesPre+3]=t.indicesLength,s[t.indicesLength]=a,s[t.indicesLength+1]=n,s[t.indicesLength+2]=i,s[t.indicesLength+3]=t.indicesCur,t.indicesPre=t.indicesLength,t.indicesLength+=4;break}t.indicesPre=t.indicesCur,t.indicesCur=s[t.indicesCur+3]}else t.indicesLength>=4?s[t.indicesFoot+3]=t.indicesLength:t.indicesHead=0,t.indicesFoot=t.indicesLength,s[t.indicesLength]=a,s[t.indicesLength+1]=n,s[t.indicesLength+2]=i,s[t.indicesLength+3]=-1,t.indicesLength+=4}}],(a=null)&&T(t.prototype,a),i&&T(t,i),e}();function f(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var g=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,a,i;return t=e,i=[{key:"init",value:function(e){this.updatePreTime=performance.now(),this.pPreTime=performance.now(),this.cPreTime=1e3*e.context.currentTime,this.pTimeSum=0,this.cTimeSum=0,this.cnt=0}},{key:"update",value:function(e){var t=e.context,a=e.settings,i=e.states,n=performance.now(),s=this.updatePreTime,r=this.pPreTime,u=this.cPreTime,o=this.pTimeSum,c=this.cTimeSum,l=this.cnt,m=n-s,p=n,T=1e3*t.currentTime;o+=p-r,c+=T-u,r=p,u=T;var f=o-c;if(i.latencyTime=f,f>=100?(i.latencyLimitTime+=f,c+=100):f<=-100?c=o:i.latencyLimitTime>0&&(i.latencyLimitTime-=.04*m,i.latencyLimitTime<0&&(i.latencyLimitTime=0)),i.updateIntervalTime=m,i.updateBufTime<m?i.updateBufTime=m:(i.updateBufTime>50&&(i.updateBufTime-=.001*i.updateBufTime),i.updateBufTime>100&&(i.updateBufTime-=.01*i.updateBufTime),i.updateBufMaxTime>150&&(i.updateBufMaxTime-=.002*i.updateBufMaxTime),i.updateBufTime<50&&(i.updateBufTime+=.002*i.updateBufTime),i.updateBufMaxTime>=10&&i.updateBufMaxTime<140&&(i.updateBufMaxTime+=.003*i.updateBufMaxTime)),i.updateBufTime>i.updateBufMaxTime){if(m>=900&&i.latencyLimitTime<=150)i.updateBufMaxTime+=m;else{var g=m-i.updateBufMaxTime;i.updateBufTime=i.updateBufMaxTime,i.updateBufMaxTime<10?(i.updateBufTime=i.updateBufMaxTime,i.updateBufMaxTime*=1.25):i.updateBufMaxTime+=g/2}i.updateBufMaxTime>1100&&(i.updateBufMaxTime=1100)}i.latencyLimitTime>200&&(c=o,i.latencyLimitTime-=5,i.latencyLimitTime>1e3&&(i.latencyLimitTime=1e3),i.updateBufMaxTime=1,i.updateBufTime=1,m=1);for(var v=0;v<16;v++){var y=e.playData.channels[v].notes,b=i.playIndices[v],d=function(){var n=y[b],s=t.currentTime-i.startTime;if(s>=n.stopTime)return"continue";if(0==l&&s>n.startTime+.05)return"continue";if(s+n.startTime<0)return"continue";if(s<n.startTime-i.updateBufTime/1e3)return"break";if(!a.isWebMIDI){if(i.stopFuncs.length>=350&&i.updateBufTime<1e3&&(i.updateBufTime=12,i.updateBufMaxTime=i.updateBufTime),-1!=a.maxPoly||-1!=a.maxPercPoly){var r=0,u=0;if(i.stopFuncs.forEach(function(e){e.note&&(9!=e.note.channel?n.start>=e.note.start&&n.start<e.note.stop&&r++:n.start==e.note.start&&u++)}),9!=n.channel&&r>=a.maxPoly||9==n.channel&&u>=a.maxPercPoly)return"continue"}var o=9!=n.channel?e.createNote(n):e.createPercussionNote(n);if(!o)return"continue";e.pushFunc({note:n,stopFunc:o})}i.noteOnAry.push(n)};e:for(;b<y.length;b++){switch(d()){case"continue":continue;case"break":break e}}i.playIndices[v]=b}if(this.checkNoteOn(e),this.checkNoteOff(e),a.isWebMIDI&&null!=a.WebMIDIPortOutput){for(var A=e.playData.messages,V=e.playData.smfData,k=i.playIndices[16];k<A.length;k++){var R=A[k],I=t.currentTime-i.startTime;if(!(I>R.time+1)){if(I<R.time-1)break;var M=R.smfPtrLen,w=R.smfPtr,N=R.time,P=V[w];if(255!=P)try{if(240==P||247==P){if(a.WebMIDIPortSysEx){var O=h.variableLengthToInt(V,w+1,w+1+4),S=w+1+O[1],x=S+O[0],D=new Uint8Array(1+O[0]);D[0]=P;for(var E=x-S,q=0;q<E;q++)D[q+1]=V[S+q];a.WebMIDIPortOutput.send(D,1e3*(N-t.currentTime+window.performance.now()/1e3+i.startTime))}}else{for(var B=[],W=0;W<M;W++)B.push(V[w+W]);a.WebMIDIPortOutput.send(B,1e3*(N-t.currentTime+window.performance.now()/1e3+i.startTime))}}catch(e){console.log(e,w,M,N,P)}}}i.playIndices[16]=k}this.updatePreTime=n,this.pPreTime=r,this.cPreTime=u,this.pTimeSum=o,this.cTimeSum=c,this.cnt=l}},{key:"checkNoteOn",value:function(e){for(var t=e.context,a=e.trigger,i=e.states,n=e.states.noteOnAry,s=e.states.noteOffAry,r=0;r<n.length;r++){var u=n[r],o=t.currentTime-i.startTime;u.startTime-o<=0&&(p.delete(n,r),s.push(u),a.isNoteTrigger&&a.noteOn(u),r--)}}},{key:"checkNoteOff",value:function(e){for(var t=e.context,a=e.trigger,i=e.states,n=e.states.noteOffAry,s=0;s<n.length;s++){var r=n[s],u=t.currentTime-i.startTime;(9!=r.channel&&r.stopTime-u<=0||9==r.channel&&r.drumStopTime-u<=0)&&(p.delete(n,s),e.clearFunc("note",r),a.isNoteTrigger&&a.noteOff(r),s--)}}}],(a=null)&&f(t.prototype,a),i&&f(t,i),e}();function v(e,t,a,i,n){var s=this,r=this.settings,u=this.context,o=this.states.startTime,c=i?0:e.channel||0,l=e.velocity*Number(i?1:null!=this.channels[c][2]?this.channels[c][2]:1)*r.generateVolume,m=!0;if(l<=0)return{isGainValueZero:!0};var p=l*((e.expression?e.expression[0].value:100)/127),T=u.createGain();if(T.gain.value=p,a?e.expression&&e.expression.forEach(function(e){var t=l*(e.value/127);t>0&&(m=!1),T.gain.setValueAtTime(t,e.time+o)}):p>0&&(m=!1),m)return{isGainValueZero:!0};var h=e.startTime+o,f=e.stopTime+o,g=r.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),v=t?u.createBufferSource():u.createOscillator(),b=u.createStereoPanner?u.createStereoPanner():u.createPanner?u.createPanner():{pan:{setValueAtTime:function(){}}},d=u.createGain(),A=u.createGain();t?(v.loop=!0,v.buffer=this.whitenoise):(v.type=e.type||"sine",v.detune.value=0,v.frequency.value=g,e.pitchBend&&e.pitchBend.forEach(function(t){v.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),t.time+o)}));var V,k,R=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;if(function(e,t,a){if(e.createStereoPanner)a>1&&(a=1),t.pan.value=a;else if(e.createPanner){var i=y(a);t.panningModel="equalpower",t.setPosition(i.x,i.y,i.z)}}(u,b,R),u.createStereoPanner||u.createPanner){var I=!0;u.createStereoPanner?e.pan&&e.pan.forEach(function(e){if(I)I=!1;else{var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1),b.pan.setValueAtTime(t,e.time+o)}}):u.createPanner&&(b.positionX?e.pan&&e.pan.forEach(function(e){if(firstPan)firstPan=!1;else{var t=y(64==e.value?0:e.value/127*2-1);b.positionX.setValueAtTime(t.x,e.time+o),b.positionY.setValueAtTime(t.y,e.time+o),b.positionZ.setValueAtTime(t.z,e.time+o)}}):e.pan&&e.pan.forEach(function(e){if(I)I=!1;else{var t=setTimeout(function(){s.clearFunc("pan",t);var a=64==e.value?0:e.value/127*2-1;a>1&&(a=1);var i=y(a);b.setPosition(i.x,i.y,i.z)},1e3*(e.time+o-u.currentTime));s.pushFunc({pan:t,stopFunc:function(){clearTimeout(t)}})}})),v.connect(b),b.connect(T)}else v.connect(T);if(T.connect(d),d.connect(A),A.connect(this.masterGainNode),this.masterGainNode.connect(u.destination),!t&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){V=u.createOscillator(),k=u.createGain();var M=!0;e.modulation&&e.modulation.forEach(function(e){if(M)M=!1;else{var t=e.value/127;t>1&&(t=1),k.gain.setValueAtTime(10*g/440*t,e.time+o)}});var w=e.modulation?e.modulation[0].value/127:0;w>1&&(w=1),k.gain.value=10*g/440*w,V.frequency.value=6,V.connect(k),k.connect(v.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var N=this.convolver,P=u.createGain(),O=!0;e.reverb&&e.reverb.forEach(function(e){if(O)O=!1;else{var t=e.value/127;t>1&&(t=1),P.gain.setValueAtTime(t,e.time+o)}});var S=e.reverb?e.reverb[0].value/127:0;S>1&&(S=1),P.gain.value=S,d.connect(A),A.connect(P),P.connect(N)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var x=this.chorusDelayNode,D=u.createGain(),E=!0;e.chorus&&e.chorus.forEach(function(e){if(E)E=!1;else{var t=e.value/127;t>1&&(t=1),D.gain.setValueAtTime(t,e.time+o)}});var q=e.chorus?e.chorus[0].value/127:0;q>1&&(q=1),D.gain.value=q,d.connect(A),A.connect(D),D.connect(x)}return V&&(V.start(h),this.stopAudioNode(V,f,k)),v.start(h),t||i||n||this.stopAudioNode(v,f,A),{start:h,stop:f,pitch:g,channel:c,velocity:l,oscillator:v,panNode:b,gainNode:d,stopGainNode:A,isGainValueZero:!1}}function y(e){e>1&&(e=1);var t={},a=90*e;return t.x=Math.sin(a*(Math.PI/180)),t.y=0,t.z=-Math.cos(a*(Math.PI/180)),t}function b(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,a,i;return t=e,i=[{key:"measureReverb",value:function(){for(var e=performance.now(),t=0;t<5e5&&!(performance.now()-e>=500);t++);return this.debug&&console.log("measureReverb",t,performance.now()-e),!(t<5e5)}}],(a=null)&&b(t.prototype,a),i&&b(t,i),e}();function A(e){return(A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function V(e){if(this.debug){console.log(e);var t=performance.now()}var a=new Uint8Array(e);if(77!=a[0]||84!=a[1]||104!=a[2]||100!=a[3])return"Not Sandard MIDI File.";var i={};if(i.smf=a,function(e){var t=e.smf,a=4,i={};i.size=h.getInt(t,4,8),i.format=t[9],i.trackcount=h.getInt(t,10,12),i.timemanage=t[12],i.resolution=h.getInt(t,12,14),a+=4+i.size;for(var n=[],s=this.settings.isWebMIDI?17:16,r=0;r<s;r++){var u={};n.push(u),u.indices=new Int32Array(Math.floor(t.length/8)),u.indicesLength=0,u.indicesHead=-1,u.indicesFoot=0,u.indicesCur=0,u.indicesPre=0,u.notes=[]}return e.p=a,e.header=i,e.channels=n,e}.call(this,i),this.debug)var n=performance.now();if(function(e){for(var t=e.smf,a=e.p,i=e.header,n=e.channels,s=[],r=[],u=0;u<i.trackcount;u++){if(77!=t[a]||84!=t[a+1]||114!=t[a+2]||107!=t[a+3])return"Irregular SMF.";var o=(a+=4)+4+h.getInt(t,a,a+4);a+=4;for(var c=0,l=120,m=0,p=0,T=1,f=void 0;a<o;){if(null!=T){var g=h.variableLengthToInt(t,a,a+5);c+=f=g[0],a+=g[1]}var v=a;switch(t[a]>>4){case 8:case 9:case 10:case 11:case 14:var y=n[15&(T=t[a])];h.chIndicesInsert(this,y,c,a,3),a+=3;break;case 12:case 13:var b=n[15&(T=t[a])];h.chIndicesInsert(this,b,c,a,2),a+=2;break;case 15:switch(t[a]){case 240:case 247:var d=h.variableLengthToInt(t,a+1,a+1+4);if(d[0]>=7&&127==t[a+2]&&127==t[a+3]&&4==t[a+4]&&1==t[a+5])for(var A=0;A<16;A++){var V=n[A];h.chIndicesInsert(this,V,c,a,d[0])}a+=1+d[1]+d[0];break;case 241:a+=2;break;case 242:a+=3;break;case 243:a+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:a+=1;break;case 255:switch(t[a+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:c+=(this.settings.isSkipEnding?0:i.resolution)-f;break;case 81:for(var k=0;k<16;k++){var R=n[k];h.chIndicesInsert(this,R,c,a,6)}p+=60/l/i.resolution*(c-m),m=c,l=6e7/(65536*t[a+3]+256*t[a+4]+t[a+5]),s.push({timing:c,time:p,value:l});break;case 84:break;case 88:r.push({timing:c,value:[t[a+3],Math.pow(2,t[a+4])]})}var I=h.variableLengthToInt(t,a+2,a+2+4);a+=2+I[1]+I[0]}break;default:if(null==T)return"Irregular SMF. ("+a+" byte addr)";t[--a]=T,T=null}this.settings.isWebMIDI&&null!=T&&h.chIndicesInsert(this,n[16],c,v,a-v)}for(var M=0;M<n.length;M++)n[M].indicesCur=n[M].indicesHead,n[M].indicesPre=n[M].indicesHead}return e.p=a,e.tempoTrack=s,e.beatTrack=r,e}.call(this,i),this.debug)var s=performance.now();(function(e){for(var t,a,i,n=this,s=e.smf,r=e.header,u=e.channels,o=e.tempoTrack,c=0,l=-1,m=-1,T=Number.MAX_SAFE_INTEGER,h=Number.MAX_SAFE_INTEGER,f=0,g=0,v=function(e){var o=u[e],c=2,v=0,y=64,b=127,d=100,V=0,k=0,R=n.isTonyu2?0:10,I=0,M=127,w=127,N=0,P=127;t=120,a=0,i=0;for(var O=[],S=o.indicesHead,x=o.indices,D=new Array(128),E=function(){var u=x[S],A=x[S+2],E=x[S+3],q=60/t/r.resolution*(u-a)+i,B=s[A]>>4;switch(B){case 8:case 9:if(9==B&&0!=s[A+2]){var W={start:u,stop:null,startTime:q,stopTime:null,pitch:s[A+1],pitchBend:[{timing:u,time:q,value:v}],pan:[{timing:u,time:q,value:y}],expression:[{timing:u,time:q,value:b*(P/127)}],velocity:s[A+2]/127*(d/127),modulation:[{timing:u,time:q,value:V}],holdBeforeStop:null,reverb:[{timing:u,time:q,value:R}],chorus:[{timing:u,time:q,value:I}],instrument:N,channel:e,nextSameNoteOnInterval:-1,drumStopTime:2},L=D[s[A+1]];L&&(L.nextSameNoteOnInterval=q-L.startTime),D[s[A+1]]=W,O.some(function(e,t){var a=o.notes[e];a.pitch==s[A+1]&&null==a.stop&&(a.stop=u,a.stopTime=q,p.delete(O,t))}),O.push(o.notes.length),o.notes.push(W),u<T&&(T=u,h=q)}else O.some(function(e,t){var a=o.notes[e];if(a.pitch==s[A+1]&&null==a.stop)return k>=n.settings.holdOnValue?null==a.holdBeforeStop&&(a.holdBeforeStop=[{timing:u,time:q,value:k}]):(a.stop=u,a.stopTime=q,p.delete(O,t)),u>f&&(f=u,g=q),!0});break;case 10:break;case 11:switch(s[A+1]){case 1:V=s[A+2],O.forEach(function(e){o.notes[e].modulation.push({timing:u,time:q,value:V})});break;case 6:0==M&&0==w&&(c=s[A+2])>24&&(c=24);break;case 7:d=s[A+2];break;case 10:y=s[A+2],O.forEach(function(e){o.notes[e].pan.push({timing:u,time:q,value:y})});break;case 11:b=s[A+2],O.forEach(function(e){o.notes[e].expression.push({timing:u,time:q,value:b*(P/127)})});break;case 64:if((k=s[A+2])<n.settings.holdOnValue)for(var G=O.length-1;G>=0;G--){var C=O[G],F=o.notes[C];null==F.stop&&null!=F.holdBeforeStop&&(F.stop=u,F.stopTime=q,p.delete(O,G))}break;case 91:R=s[A+2],O.forEach(function(e){o.notes[e].reverb.push({timing:u,time:q,value:R})});break;case 93:I=s[A+2],O.forEach(function(e){o.notes[e].chorus.push({timing:u,time:q,value:I})});break;case 98:case 99:s[A+2];break;case 100:M=s[A+2];break;case 101:w=s[A+2];break;case 111:-1==l&&(l=u,m=q)}break;case 12:N=s[A+1];break;case 13:break;case 14:v=(128*s[A+2]+s[A+1]-8192)/8192*c,O.forEach(function(e){o.notes[e].pitchBend.push({timing:u,time:q,value:v})});break;case 15:switch(s[A]){case 240:case 247:if(127==s[A+1]&&127==s[A+2]&&4==s[A+3]&&1==s[A+4]){var _=s[A+6];_>127&&(_=127),P=_,O.forEach(function(e){o.notes[e].expression.push({timing:u,time:q,value:b*(P/127)})})}break;case 255:switch(s[A+1]){case 81:i+=60/t/r.resolution*(u-a),a=u,t=6e7/(65536*s[A+3]+256*s[A+4]+s[A+5])}}break;default:return{v:{v:"Error parseSMF. "}}}S=E};-1!=S;){var q=E();if("object"===A(q))return q.v}o.nowNoteOnIdxAry=O,n.debug||delete o.indices},y=0;y<16;y++){var b=v(y);if("object"===A(b))return b.v}for(y=0;y<16;y++){for(var d=u[y],V=d.nowNoteOnIdxAry,k=function(e){var t=d.notes[V[e]];null==t.stop&&(t.stop=f,t.stopTime=g,["pitchBend","pan","expression","modulation","reverb","chorus"].forEach(function(e){for(var a=t[e],i=a.length-1;i>=1;i--)a[i].timing>f&&p.delete(a,i)}),p.delete(V,e))},R=V.length-1;R>=0;R--)k(R);delete d.nowNoteOnIdxAry}this.settings.isSkipEnding&&(c=f),o.push({timing:c,time:60/t/r.resolution*(c-a)+i,value:120});var I=[];if(this.settings.isWebMIDI)for(var M=u[16],w=120,N=0,P=0,O=M.indicesHead,S=M.indices;-1!=O;){var x=S[O],D=S[O+1],E=S[O+2],q=S[O+3],B=60/w/r.resolution*(x-N)+P;switch(s[E]){case 255:switch(s[E+1]){case 81:P+=60/w/r.resolution*(x-N),N=x,w=6e7/(65536*s[E+3]+256*s[E+4]+s[E+5])}}I.push({time:B,tick:x,smfPtr:E,smfPtrLen:D}),O=q}return e.songLength=c,e.cc111Tick=l,e.cc111Time=m,e.firstNoteOnTiming=T,e.firstNoteOnTime=h,e.lastNoteOffTiming=f,e.lastNoteOffTime=g,this.settings.isWebMIDI&&(e.messages=I,e.smfData=new Uint8Array(s)),e}).call(this,i);var r={};if(r.header=i.header,r.tempoTrack=i.tempoTrack,r.beatTrack=i.beatTrack,r.channels=i.channels,r.songLength=i.songLength,r.cc111Tick=i.cc111Tick,r.cc111Time=i.cc111Time,r.firstNoteOnTiming=i.firstNoteOnTiming,r.firstNoteOnTime=i.firstNoteOnTime,r.lastNoteOffTiming=i.lastNoteOffTiming,r.lastNoteOffTime=i.lastNoteOffTime,this.settings.isWebMIDI&&(r.messages=i.messages,r.smfData=new Uint8Array(a)),this.debug){var u=performance.now();console.log("parseSMF time",u-t),console.log("parseSMF(0/2) time",n-t),console.log("parseSMF(1/2) time",s-n),console.log("parseSMF(2/2) time",u-s),console.log(r)}return r}function k(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var R=function(){function e(t,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),function(e,t){this.debug=!1,this.isStarted=!1,this.isPlayed=!1,this.isTonyu2=!0,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!0,reverbVolume:1.5,isChorus:!0,chorusVolume:.5,isCC111:!0,loop:!1,isSkipBeginning:this.isTonyu2,isSkipEnding:!0,holdOnValue:64,maxPoly:-1,maxPercPoly:-1,isOfflineRendering:!1,isSameDrumSoundOverlap:!1},this.events=[],this.trigger={isNoteTrigger:!0,play:function(){},stop:function(){},noteOn:function(){},noteOff:function(){},songEnd:function(){}},this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:50,updateBufMaxTime:150,updateIntervalTime:0,latencyLimitTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.playData=null,this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1,this.onSongEndListener=null;for(var a=0;a<17;a++)this.channels.push([0,0,1]);e&&this.init(e,t),"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return Date.now()}),Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991)}.call(this,t,a)}var t,a,i;return t=e,(a=[{key:"init",value:function(e,t){return function(e,t){if(!this.isStarted){this.isStarted=!0;var a=window.AudioContext||window.webkitAudioContext;if(this.context=e||new a,this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume,t&&t.whitenoise)this.whitenoise=t.whitenoise;else{this.whitenoise=this.context.createBuffer(2,this.context.sampleRate,this.context.sampleRate),n.resetSeed();for(var i=0;i<2;i++)for(var s=0;s<this.context.sampleRate;s++){var r=n.random();this.whitenoise.getChannelData(i)[s]=2*r-1}}if(t&&t.impulseResponse)this.impulseResponse=t.impulseResponse;else{var u=3.5*this.context.sampleRate;this.impulseResponse=this.context.createBuffer(2,u,this.context.sampleRate),n.resetSeed();for(var o=0;o<2;o++)for(var c=this.impulseResponse.getChannelData(o),l=0;l<u;l++){var m=(u-l)/u,p=l/this.context.sampleRate,T=(p<.03?0:m)*(p>=.03&&p<.031?2*m:m)*(p>=.04&&p<.042?1.5*m:m)*(p>=.05&&p<.054?1.25*m:m)*n.random()*.2*Math.pow(m-.03,4);c[l]=T}}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!0,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0),this.isTonyu2&&(this.settings.isReverb=t?t.settings.isReverb:this.measurePerformanceReverb())}}.call(this,e,t)}},{key:"parseSMF",value:function(e){return V.call(this,e)}},{key:"setData",value:function(e){return function(e){if(this.debug)var t=performance.now();if(this.states.isPlaying&&this.stop(),this.playData=e,this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming,this.firstNoteOnTime=e.firstNoteOnTime,this.lastNoteOffTime=e.lastNoteOffTime,this.initStatus(),this.debug){var a=performance.now();console.log("setData time",a-t)}return this}.call(this,e)}},{key:"play",value:function(e){return function(e){var t=this,a=this.context,i=this.settings,n=this.trigger,s=this.states;if(!s.isPlaying){if(i.isWebMIDI&&!e){if("completed"!=s.webMIDIWaitState){if("waiting"!=s.webMIDIWaitState){s.webMIDIWaitState="waiting";var r=1e3-1e3*(a.currentTime-s.webMIDIStopTime);0==s.webMIDIStopTime&&(r=1e3),setTimeout(function(){s.webMIDIWaitState="completed",s.isPlaying=!1,t.play()},r)}return}s.webMIDIWaitState=null}var u,o=a.currentTime;if(this.isPlayed=!0,s.isPlaying=!0,s.startTime=s.startTime||s.stopTime?s.startTime+o-s.stopTime:o,s.stopFuncs=[],i.isSkipBeginning){var c=this.firstNoteOnTime;-s.startTime+o<c&&this.setStartTime(c+s.startTime-o)}var l=1e3*((i.isCC111&&-1!=this.cc111Time?this.lastNoteOffTime:this.getTime(Number.MAX_SAFE_INTEGER))-a.currentTime+s.startTime);u=setTimeout(function e(){t.clearFunc("rootTimeout",u),(i.isCC111&&-1!=t.cc111Time?t.lastNoteOffTime:t.getTime(Number.MAX_SAFE_INTEGER))-a.currentTime+s.startTime<=0?(n.songEnd(),t.onSongEnd(),t.fireEvent("songEnd")):(u=setTimeout(e,1),t.pushFunc({rootTimeout:u,stopFunc:function(){clearTimeout(u)}}))},l),this.pushFunc({rootTimeout:u,stopFunc:function(){clearTimeout(u)}}),n.play(),this.fireEvent("play"),g.init(this);var m=setInterval(function(){g.update(t)},1);this.pushFunc({rootTimeout:m,stopFunc:function(){clearInterval(m)}})}}.call(this,e)}},{key:"stop",value:function(e){return function(e){var t=this,a=this.states;if(0!=a.isPlaying){if(a.isPlaying=!1,a.stopTime=this.context.currentTime,a.stopFuncs.forEach(function(e){e.stopFunc()}),a.stopFuncs=[],a.playIndices.forEach(function(e,t,a){a[t]=0}),a.noteOnAry=[],a.noteOffAry=[],this.settings.isWebMIDI){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;a.webMIDIStopTime=this.context.currentTime,setTimeout(function(){for(var e=0;e<16;e++)t.settings.WebMIDIPortOutput.send([176+e,120,0])},1e3)}this.trigger.stop(),this.fireEvent("stop")}}.call(this,e)}},{key:"initStatus",value:function(e,t){return function(e,t){if((!this.settings.isWebMIDI||null==this.states.webMIDIWaitState)&&(this.stop(e),this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:this.states.webMIDIStopTime,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:this.states.updateBufTime,updateBufMaxTime:this.states.updateBufMaxTime,updateIntervalTime:this.states.updateIntervalTime,latencyLimitTime:this.states.latencyLimitTime,noteOnAry:[],noteOffAry:[]},this.settings.isWebMIDI&&!t)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var a=0;a<16;a++)this.settings.WebMIDIPortOutput.send([192+a,0]),this.settings.WebMIDIPortOutput.send([224+a,0,64]),this.settings.WebMIDIPortOutput.send([176+a,100,0]),this.settings.WebMIDIPortOutput.send([176+a,101,0]),this.settings.WebMIDIPortOutput.send([176+a,6,2]),this.settings.WebMIDIPortOutput.send([176+a,100,1]),this.settings.WebMIDIPortOutput.send([176+a,96,0]),this.settings.WebMIDIPortOutput.send([176+a,97,64]),this.settings.WebMIDIPortOutput.send([176+a,7,100]),this.settings.WebMIDIPortOutput.send([176+a,10,64]),this.settings.WebMIDIPortOutput.send([176+a,11,127]),this.settings.WebMIDIPortOutput.send([176+a,98,0]),this.settings.WebMIDIPortOutput.send([176+a,99,0]),this.settings.WebMIDIPortOutput.send([176+a,122,0])}}.call(this,e,t)}},{key:"getTime",value:function(e){return function(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].timing)return this.tempoTrack[this.tempoTrack.length-1].time;for(var a=0,i=this.tempoTrack.length-1;;){t=Math.floor(a+(i-a)/2);var n=this.tempoTrack[t].timing;if(e<n)i=t-1;else{if(!(e>n))break;a=t+1}if(a>i){e<n&&t--;break}}}var s=0,r=0,u=120;if(t>=0){var o=this.tempoTrack[t];s=o.time,r=o.timing,u=o.value}return s+=60/u/this.settings.resolution*(e-r)}.call(this,e)}},{key:"getTiming",value:function(e){return function(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].time)return this.tempoTrack[this.tempoTrack.length-1].timing;for(var a=0,i=this.tempoTrack.length-1;;){t=Math.floor(a+(i-a)/2);var n=this.tempoTrack[t].time;if(e<n)i=t-1;else{if(!(e>n))break;a=t+1}if(a>i){e<n&&t--;break}}}var s=0,r=0,u=120;if(t>=0){var o=this.tempoTrack[t];s=o.time,r=o.timing,u=o.value}return r+=(e-s)/(60/u/this.settings.resolution)}.call(this,e)}},{key:"createBaseNote",value:function(e,t,a,i,n){return v.call(this,e,t,a,i,n)}},{key:"createNote",value:function(e){return function(e){var t=this,a=this.createBaseNote(e,!1,!0,!1,!0);if(a.isGainValueZero)return null;var i,n=a.oscillator,s=a.gainNode,r=a.stopGainNode,u=!1,o=!1;switch(1e3*this.channels[a.channel][0]||e.instrument){case 1e3:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",s.gain.value*=1.5;break;case 2e3:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",s.gain.value*=.8;break;case 3e3:case 0:case 1:case 2:case 3:case 6:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 71:case 82:case 87:n.type="sawtooth";break;case 4e3:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",s.gain.value*=1.5;break;default:n.type="square"}switch(("sine"==n.type||"triangle"==n.type)&&!u&&a.stop-a.start>.01&&(o=!0),this.channels[a.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:u=!0,s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(0,a.start+.2),this.stopAudioNode(n,a.start+.2,r);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:s.gain.value*=1.1;var c=(128-e.pitch)/128;s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(.85*s.gain.value,a.start+c*c/8),s.gain.linearRampToValueAtTime(.8*s.gain.value,a.start+c*c/4),s.gain.setTargetAtTime(0,a.start+c*c/4,5*c*c),this.stopAudioNode(n,a.stop,r,o);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(0,a.start+1+4*a.velocity),this.stopAudioNode(n,a.stop,r,o);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:s.gain.value*=1,s.gain.setValueAtTime(s.gain.value,a.start),s.gain.linearRampToValueAtTime(.95*s.gain.value,a.start+.1),s.gain.setValueAtTime(.95*s.gain.value,a.start+.1),s.gain.linearRampToValueAtTime(0,a.start+2+10*a.velocity),this.stopAudioNode(n,a.stop,r,o);break;case 119:if(s.gain.value=0,this.stopAudioNode(n,a.stop,r,o),(i=this.createBaseNote(e,!0,!0)).isGainValueZero)break;i.oscillator.playbackRate.setValueAtTime((e.pitch+1)/128,a.start),i.gainNode.gain.setValueAtTime(0,a.start),i.gainNode.gain.linearRampToValueAtTime(1.3,a.start+2),this.stopAudioNode(i.oscillator,a.stop,i.stopGainNode);break;default:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,a.start),this.stopAudioNode(n,a.stop,r,o)}return function(){t.stopAudioNode(n,0,r,!0),i&&i.oscillator&&t.stopAudioNode(i.oscillator,0,i.stopGainNode,!0)}}.call(this,e)}},{key:"createPercussionNote",value:function(e){return function(e){var t=this,a=this.createBaseNote(e,!0,!1);if(a.isGainValueZero)return null;var i=a.oscillator,n=a.gainNode,s=a.stopGainNode,r=a.start,u=this.createBaseNote(e,!1,!1,!0),o=u.oscillator,c=u.gainNode,l=u.stopGainNode,m=e.nextSameNoteOnInterval;r<this.context.currentTime&&(r=this.context.currentTime);var p=0,T=0;switch(e.pitch){case 35:case 36:n.gain.value=.6,i.playbackRate.value=.02,p=.07,c.gain.value=1.1,o.frequency.setValueAtTime(120,r),o.frequency.linearRampToValueAtTime(50,r+.07),T=.07;break;case 38:case 40:i.playbackRate.value=.7,p=.05,c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.05),o.frequency.setValueAtTime(300,r),o.frequency.linearRampToValueAtTime(200,r+.05),T=.05;break;case 41:case 43:case 45:case 47:case 48:case 50:i.playbackRate.value=.01,p=.1,o.type="square",c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(.01,r+.1),o.frequency.setValueAtTime(150+20*(e.pitch-40),r),o.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),r+.1),T=.1;break;case 42:case 44:i.playbackRate.value=1.5,p=.02,T=0;break;case 46:i.playbackRate.value=1.5,p=.3,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.3),T=0;break;case 49:case 51:case 52:case 53:case 55:case 57:i.playbackRate.value=1.2,p=.5,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.5),T=0;break;case 51:i.playbackRate.value=1.1,p=.4,n.gain.setValueAtTime(.8,r),n.gain.linearRampToValueAtTime(0,r+.4),T=0;break;case 59:i.playbackRate.value=1.8,p=.3,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.3),T=0;break;case 60:case 61:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.1),o.frequency.setValueAtTime(400-40*(e.pitch-60),r),o.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),r+.1),T=.1;break;case 62:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.03),o.frequency.setValueAtTime(200,r),o.frequency.linearRampToValueAtTime(250,r+.03),T=.03;break;case 63:case 64:i.playbackRate.value=.03,p=.03,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.1),o.frequency.setValueAtTime(200-30*(e.pitch-63),r),o.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),r+.1),T=.1;break;case 56:case 75:i.playbackRate.value=.01,p=.1,c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.1),o.frequency.setValueAtTime(1e3+48*(e.pitch-56),r),T=.1;break;case 80:i.playbackRate.value=5,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.2),p=.05,o.type="triangle",c.gain.setValueAtTime(.7,r),c.gain.linearRampToValueAtTime(0,r+.2),o.frequency.setValueAtTime(6e3,r),T=.05;break;case 81:i.playbackRate.value=5,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.5),p=.5,o.type="triangle",c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.3),o.frequency.setValueAtTime(6e3,r),T=.3;break;case 35:case 36:i.playbackRate.value=.25,n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.7,r+.004),n.gain.linearRampToValueAtTime(0,r+.008),p=.008,o.frequency.setValueAtTime(35==e.pitch?90:160,r),o.frequency.linearRampToValueAtTime(40,r+.08),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(3,r+.02),c.gain.linearRampToValueAtTime(0,r+.08),T=.08;break;case 37:i.playbackRate.value=.26,n.gain.setValueAtTime(1.5,r),n.gain.linearRampToValueAtTime(0,r+.041),p=.041,o.frequency.setValueAtTime(330,r),o.frequency.linearRampToValueAtTime(120,r+.02),c.gain.setValueAtTime(1,r),c.gain.linearRampToValueAtTime(0,r+.02),T=.02;break;case 38:case 40:var h=38==e.pitch?.25:.2;i.playbackRate.value=.7,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+h),p=h,o.frequency.setValueAtTime(38==e.pitch?140:200,r),o.frequency.linearRampToValueAtTime(38==e.pitch?100:160,r+.1),c.gain.setValueAtTime(2,r),c.gain.linearRampToValueAtTime(0,r+.1),T=.1;break;case 39:i.playbackRate.value=.5,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.3,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(1.3,r+.0201),n.gain.linearRampToValueAtTime(0,r+.09),p=.09,o.type="triangle",o.frequency.setValueAtTime(180,r),c.gain.setValueAtTime(.8,r),c.gain.linearRampToValueAtTime(0,r+.01),c.gain.setValueAtTime(.8,r+.0101),c.gain.linearRampToValueAtTime(0,r+.02),c.gain.setValueAtTime(.8,r+.0201),c.gain.linearRampToValueAtTime(0,r+.03),T=.11;break;case 41:case 43:case 45:case 47:case 48:case 50:var f=e.pitch-41+(e.pitch>=48?1:0);i.playbackRate.value=.3+f/45,n.gain.setValueAtTime(1.5,r),n.gain.linearRampToValueAtTime(0,r+.02),p=.02,o.frequency.setValueAtTime(90+15*f,r),o.frequency.linearRampToValueAtTime(30+7.5*f,r+.5-f/35),c.gain.setValueAtTime(1.5,r),c.gain.linearRampToValueAtTime(0,r+.5-f/35),T=.5-f/35;break;case 42:case 44:i.playbackRate.value=1,42==e.pitch?n.gain.setValueAtTime(.8,r):(n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.8,r+.014)),n.gain.linearRampToValueAtTime(0,r+.08),p=.08,c.gain.value=0,T=0;break;case 46:i.playbackRate.setValueAtTime(.35,r),i.playbackRate.linearRampToValueAtTime(.6,r+.1),i.playbackRate.linearRampToValueAtTime(1,r+.3),n.gain.setValueAtTime(1.1,r),n.gain.setTargetAtTime(0,r,.3),p=1.5,c.gain.value=0,T=0;break;case 49:case 57:var g=49==e.pitch?.3:.5,v=49==e.pitch?.4:.7;i.playbackRate.setValueAtTime(g,r),i.playbackRate.linearRampToValueAtTime(v,r+.15),i.playbackRate.linearRampToValueAtTime(.9,r+.4),n.gain.setValueAtTime(1.3,r),n.gain.setTargetAtTime(0,r,.35),p=2,c.gain.value=0,T=0;break;case 51:case 59:i.playbackRate.value=1,n.gain.setValueAtTime(.9,r),n.gain.setTargetAtTime(0,r,.35),p=2,o.type="triangle";var y=51==e.pitch?372:400;o.frequency.setValueAtTime(y,r),c.gain.setValueAtTime(.4,r),c.gain.setTargetAtTime(0,r,.35),T=2;break;case 52:i.playbackRate.setValueAtTime(.17,r),i.playbackRate.linearRampToValueAtTime(.25,r+.1),i.playbackRate.linearRampToValueAtTime(.5,r+.6),n.gain.setValueAtTime(1.3,r),n.gain.setTargetAtTime(0,r,.35),p=2,o.type="triangle",o.frequency.setValueAtTime(382,r),c.gain.setValueAtTime(.2,r),c.gain.setTargetAtTime(0,r,.35),T=2;break;case 53:i.playbackRate.setValueAtTime(.6,r),n.gain.setValueAtTime(1,r),n.gain.setTargetAtTime(0,r,.3),p=2,o.type="triangle",o.frequency.setValueAtTime(377,r),c.gain.setValueAtTime(.5,r),c.gain.setTargetAtTime(0,r,.35),T=2;break;case 55:i.playbackRate.setValueAtTime(.5,r),i.playbackRate.linearRampToValueAtTime(.8,r+.1),i.playbackRate.linearRampToValueAtTime(1,r+.6),n.gain.setValueAtTime(1.5,r),n.gain.setTargetAtTime(0,r,.3),p=1.75,c.gain.value=0,T=0;break;case 54:case 56:i.playbackRate.setValueAtTime(1,r);var b=54==e.pitch?1:.4,d=54==e.pitch?.01:0;n.gain.setValueAtTime(1*b/2,r),n.gain.linearRampToValueAtTime(1*b,r+d),n.gain.setTargetAtTime(0,r+d,.05),p=.3,o.frequency.setValueAtTime(54==e.pitch?6e3:495,r),b=54==e.pitch?1:2,c.gain.setValueAtTime(1*b/2,r),c.gain.linearRampToValueAtTime(1*b,r+d),c.gain.setTargetAtTime(0,r+d,.05),T=.3;break;case 58:i.playbackRate.setValueAtTime(.6,r),i.playbackRate.linearRampToValueAtTime(1,r+.8),n.gain.setValueAtTime(1.5,r),c.gain.setValueAtTime(.5,r);for(var A=0;A<40;A++)n.gain.linearRampToValueAtTime(.1*(40-A)/40,r+A/40*.8),n.gain.linearRampToValueAtTime(1.5*(40-(A+1))/40,r+(A+.99)/40*.8),c.gain.linearRampToValueAtTime(.025*(40-A)/40,r+A/40*.8),c.gain.linearRampToValueAtTime(.25*(40-(A+1))/40,r+(A+.99)/40*.8);n.gain.linearRampToValueAtTime(0,r+.8),c.gain.linearRampToValueAtTime(0,r+.8),p=.8,o.type="triangle",o.frequency.setValueAtTime(1e3,r),T=.8;break;case 80:i.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.setTargetAtTime(0,r,.015),p=.2,o.type="triangle",o.frequency.setValueAtTime(6e3,r),c.gain.setValueAtTime(2.5,r),c.gain.setTargetAtTime(0,r,.02),T=.3;break;case 81:i.playbackRate.value=5,n.gain.setValueAtTime(.5,r),n.gain.setTargetAtTime(0,r,.08),p=.75,o.type="triangle",o.frequency.setValueAtTime(6e3,r),c.gain.setValueAtTime(2.5,r),c.gain.setTargetAtTime(0,r,.18),T=1;break;case 60:case 61:case 62:case 63:case 64:var V=e.pitch,k=60==V?700:61==V?282:62==V?385:63==V?295:210,R=60==V?.08:61==V?.1:62==V?.03:63==V?.12:.15;i.playbackRate.value=.03,n.gain.setValueAtTime(1.2,r),p=.03,o.frequency.setValueAtTime(.97*k,r),o.frequency.linearRampToValueAtTime(k,r+R),c.gain.setValueAtTime(1.8,r),c.gain.linearRampToValueAtTime(0,r+R),T=R;break;case 65:case 66:var I=65==e.pitch?.22:.25;i.playbackRate.setValueAtTime(65==e.pitch?.25:.22,r),i.playbackRate.linearRampToValueAtTime(65==e.pitch?.2:.18,r+I),n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(.2,r+I/3.5),n.gain.linearRampToValueAtTime(0,r+I),p=I,o.type="triangle",o.frequency.setValueAtTime(65==e.pitch?203.3:145.52,r),o.frequency.linearRampToValueAtTime(65==e.pitch?190:136,r+.1),c.gain.setValueAtTime(3.2,r),c.gain.setTargetAtTime(0,r,.08),T=1;break;case 67:case 68:i.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(.1,r+.02),n.gain.linearRampToValueAtTime(0,r+.08),p=.08,o.type="triangle",o.frequency.setValueAtTime(67==e.pitch?1430:1055,r),c.gain.setValueAtTime(2,r),c.gain.setTargetAtTime(0,r,.06),T=.75;break;case 69:i.playbackRate.value=1,n.gain.setValueAtTime(.3,r),n.gain.linearRampToValueAtTime(.8,r+.03),n.gain.linearRampToValueAtTime(0,r+.08),p=.08,c.gain.value=0,T=0;break;case 70:i.playbackRate.value=1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.06),p=.06,c.gain.value=0,T=0;break;case 71:case 72:n.gain.value=0,p=0;var M=71==e.pitch?.07:.4;o.type="triangle",o.frequency.setValueAtTime(71==e.pitch?2408:2105,r),c.gain.setValueAtTime(0,r);for(var w=0;w<74*M;w++)c.gain.linearRampToValueAtTime(2.5,r+(w+.2)/75),c.gain.linearRampToValueAtTime(.5,r+(w+.9)/75);c.gain.linearRampToValueAtTime(0,r+M),T=M;break;case 73:case 74:var N=73==e.pitch?.05:.35;i.playbackRate.setValueAtTime((e.pitch,.2),r),i.playbackRate.linearRampToValueAtTime(73==e.pitch?.7:.5,r+N),n.gain.value=.2;for(var P=0;P<100*N;P++)n.gain.setValueAtTime(.4,r+P/100),n.gain.setValueAtTime(.9,r+(P+.7)/100);p=N,c.gain.value=0,T=0;break;case 75:n.gain.value=0,p=0,o.frequency.setValueAtTime(2181,r),c.gain.setValueAtTime(0,r),c.gain.setValueAtTime(2,r+.005),c.gain.linearRampToValueAtTime(1,r+.015),c.gain.linearRampToValueAtTime(1.5,r+.025),c.gain.linearRampToValueAtTime(0,r+.08),T=.1;break;case 76:case 77:i.playbackRate.value=.1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.015),p=.015,o.frequency.setValueAtTime(76==e.pitch?800:600,r),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(3,r+.005),c.gain.setTargetAtTime(0,r+.005,.02),T=.2;break;case 78:case 79:n.gain.value=0,p=0;var O=78==e.pitch?750:270;o.frequency.setValueAtTime(O,r),o.frequency.linearRampToValueAtTime(O,r+.06),78==e.pitch&&o.frequency.linearRampToValueAtTime(.9*O,r+.18),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(1.5,r+.005),c.gain.linearRampToValueAtTime(.5,r+.02),c.gain.linearRampToValueAtTime(3,r+.04),c.gain.linearRampToValueAtTime(2,r+.135),c.gain.linearRampToValueAtTime(0,r+.18),T=.18;break;case 27:i.playbackRate.value=1,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.002),p=.002,o.frequency.setValueAtTime(1500,r),o.frequency.linearRampToValueAtTime(280,r+.015),o.frequency.linearRampToValueAtTime(0,r+.07),c.gain.setValueAtTime(1.9,r),c.gain.linearRampToValueAtTime(0,r+.07),T=.07;break;case 28:i.playbackRate.value=1,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.1,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(.9,r+.0201),n.gain.setTargetAtTime(0,r+.0201,.03),p=.2,c.gain.value=0,T=0;break;case 29:case 30:var S=29==e.pitch?.05:.07,x=29==e.pitch?.06:.09,D=29==e.pitch?.07:.11,E=29==e.pitch?.1:.15,q=29==e.pitch?.25:.4,B=29==e.pitch?.1:.06,W=29==e.pitch?.3:.2,L=29==e.pitch?.18:.12;i.playbackRate.setValueAtTime(B,r),i.playbackRate.linearRampToValueAtTime(W,r+S),i.playbackRate.linearRampToValueAtTime(0,r+x),i.playbackRate.linearRampToValueAtTime(W,r+D),i.playbackRate.linearRampToValueAtTime(L,r+E),i.playbackRate.linearRampToValueAtTime(0,r+q),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.4,r+S),n.gain.linearRampToValueAtTime(.1,r+D),n.gain.linearRampToValueAtTime(.3,r+E),n.gain.linearRampToValueAtTime(0,r+q),p=q;var G=29==e.pitch?500:400,C=29==e.pitch?1950:1200,F=29==e.pitch?430:250;o.frequency.setValueAtTime(G,r),o.frequency.linearRampToValueAtTime(C,r+S),o.frequency.linearRampToValueAtTime(0,r+x),o.frequency.linearRampToValueAtTime(C,r+D),o.frequency.linearRampToValueAtTime(F,r+E),o.frequency.linearRampToValueAtTime(0,r+q),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.7,r+S),c.gain.linearRampToValueAtTime(.2,r+D),c.gain.linearRampToValueAtTime(.6,r+E),c.gain.linearRampToValueAtTime(0,r+q),T=q;break;case 31:i.playbackRate.setValueAtTime(.4,r),i.playbackRate.linearRampToValueAtTime(.5,r+.015),n.gain.setValueAtTime(1.2,r),n.gain.setTargetAtTime(0,r,.035),p=.3,o.frequency.setValueAtTime(3140,r),c.gain.setValueAtTime(1.2,r),c.gain.setTargetAtTime(0,r,.012),T=.3;break;case 32:n.gain.value=0,p=0,o.type="square",o.frequency.setValueAtTime(333,r),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(4,r+.0016),c.gain.linearRampToValueAtTime(0,r+.0032),T=.0032;break;case 33:case 34:i.playbackRate.setValueAtTime(.17,r),i.playbackRate.linearRampToValueAtTime(.22,r+.01),n.gain.setValueAtTime(1.5,r),n.gain.setTargetAtTime(0,r,.015),p=.3,34==e.pitch?(o.frequency.setValueAtTime(2040,r),c.gain.setValueAtTime(1,r),c.gain.setTargetAtTime(0,r,.12),T=1.1):(c.gain.value=0,T=0);break;case 82:i.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(1,r+.02),n.gain.linearRampToValueAtTime(0,r+.07),p=.07,c.gain.value=0,T=0;break;case 83:i.playbackRate.value=1,n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(1.2,r+.015),n.gain.setTargetAtTime(0,r+.015,.06),p=.5,o.type="triangle",o.frequency.setValueAtTime(2709,r),o.frequency.linearRampToValueAtTime(2657,r+.3),c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.7,r+.025),c.gain.setTargetAtTime(0,r+.025,.07),T=.5;break;case 84:i.playbackRate.value=1;for(var _=0;_<28;_++)n.gain.setValueAtTime(.1,r+_/24*.45),n.gain.setTargetAtTime(0,r+_/24*.45,.01),o.frequency.setValueAtTime(1380*(1+_/24),r+_/24*.45),c.gain.setValueAtTime(1*(.2+_/24),r+_/24*.45),c.gain.setTargetAtTime(0,r+_/24*.45,27==_?.2:.01);p=.5,T=1.5;break;case 85:i.playbackRate.setValueAtTime(.35,r),n.gain.setValueAtTime(1.3,r),n.gain.setTargetAtTime(0,r,.01),p=.1,o.frequency.setValueAtTime(1730,r),c.gain.setValueAtTime(.5,r),c.gain.setTargetAtTime(0,r,.01),T=.1;break;case 86:case 87:i.playbackRate.setValueAtTime(.02,r),i.playbackRate.linearRampToValueAtTime(.015,r+.5),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(2,r+.005),n.gain.setTargetAtTime(0,r+.005,86==e.pitch?.03:.06),p=.5,o.frequency.setValueAtTime(88,r),o.frequency.linearRampToValueAtTime(86,r+.3),c.gain.setValueAtTime(2.5,r),c.gain.setTargetAtTime(0,r,86==e.pitch?.1:.3),T=86==e.pitch?.5:1.5;break;default:i.playbackRate.value=e.pitch/69*2,p=.05,T=0}return this.settings.isSameDrumSoundOverlap||-1==m||(p>m&&(p=m),T>m&&(T=m)),this.stopAudioNode(i,r+p,s),this.stopAudioNode(o,r+T,l),e.drumStopTime=e.startTime+(p>=T?p:T),function(){t.stopAudioNode(i,0,s,!0),t.stopAudioNode(o,0,l,!0)}}.call(this,e)}},{key:"stopAudioNode",value:function(e,t,a,i){return function(e,t,a,i){var n=t-.005,s=t;t<=this.context.currentTime&&(i?(n=this.context.currentTime,s=this.context.currentTime+.005):s=this.context.currentTime);try{i?(e.stop(s),a.gain.cancelScheduledValues(0),a.gain.setValueAtTime(1,n),a.gain.linearRampToValueAtTime(0,s)):e.stop(s)}catch(e){a.gain.cancelScheduledValues(0),i?(a.gain.setValueAtTime(1,n),a.gain.linearRampToValueAtTime(0,s)):a.gain.setValueAtTime(0,s)}}.call(this,e,t,a,i)}},{key:"pushFunc",value:function(e){return function(e){(e.note||e.rootTimeout||e.pan||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)}.call(this,e)}},{key:"clearFunc",value:function(e,t){return function(e,t){("note"==e||"rootTimeout"==e||"pan"==e||this.trigger.isNoteTrigger)&&this.states.stopFuncs.some(function(a,i,n){if(a[e]==t)return p.delete(n,i),!0})}.call(this,e,t)}},{key:"startWebMIDI",value:function(){return function(){var e,t=this;if(navigator.requestMIDIAccess){var a=this.settings.WebMIDIPortSysEx,i=function(i){var n;return e=i.outputs,t.settings.WebMIDIPortOutputs=e,-1==t.settings.WebMIDIPort?t.settings.WebMIDIPortOutputs.forEach(function(e){n||(n=e)}):n=t.settings.WebMIDIPortOutputs.get(settings.WebMIDIPort),t.settings.WebMIDIPortOutput=n,t.settings.WebMIDIPortSysEx=a,n&&(n.open(),t.initStatus()),e};navigator.requestMIDIAccess({sysex:a}).then(i).catch(function e(t){console.log(t),a&&(a=!1,navigator.requestMIDIAccess({sysex:a}).then(i).catch(e))}),window.addEventListener("unload",function(e){for(var a=0;a<16;a++){t.settings.WebMIDIPortOutput.send([176+a,120,0]);for(var i=0;i<128;i++)t.settings.WebMIDIPortOutput.send([128+a,i,0])}})}}.call(this)}},{key:"measurePerformanceReverb",value:function(){return d.measureReverb.call(this)}},{key:"addEventListener",value:function(e,t){this.events.push({type:e,func:t})}},{key:"fireEvent",value:function(e,t){this.events.forEach(function(a){if(a.type==e)try{a.func(t)}catch(e){console.log(e)}})}},{key:"getChannels",value:function(){return this.channels}},{key:"setChannels",value:function(e){var t=this;e.forEach(function(e,a){t.channels[a]=e})}},{key:"initChannels",value:function(){for(var e=0;e<16;e++)this.channels[e]=[0,0,1]}},{key:"getMasterVolume",value:function(){return this.settings.masterVolume}},{key:"setMasterVolume",value:function(e){this.settings.masterVolume=e,this.masterGainNode.gain.value=this.settings.masterVolume}},{key:"isLoop",value:function(){return this.settings.loop}},{key:"setLoop",value:function(e){this.settings.loop=e}},{key:"isWebMIDI",value:function(){return this.settings.isWebMIDI}},{key:"setWebMIDI",value:function(e){this.settings.isWebMIDI=e}},{key:"isCC111",value:function(){return this.settings.isCC111}},{key:"setCC111",value:function(e){this.settings.isCC111=e}},{key:"setStartTime",value:function(e){this.states.startTime-=e}},{key:"setOnSongEndListener",value:function(e){this.onSongEndListener=e}},{key:"onSongEnd",value:function(){if(this.onSongEndListener&&this.onSongEndListener())return;this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.cc111Time),this.play(!0))}},{key:"isReverb",value:function(){return this.settings.isReverb}},{key:"setReverb",value:function(e){this.settings.isReverb=e}},{key:"getReverbVolume",value:function(){return this.settings.reverbVolume}},{key:"setReverbVolume",value:function(e){this.settings.reverbVolume=e}},{key:"isChorus",value:function(){return this.settings.isChorus}},{key:"setChorus",value:function(e){this.settings.isChorus=e}},{key:"getChorusVolume",value:function(){return this.settings.chorusVolume}},{key:"setChorusVolume",value:function(e){this.settings.chorusVolume=e}}])&&k(t.prototype,a),i&&k(t,i),e}();window.PicoAudio=R}]);