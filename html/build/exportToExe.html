<!DOCTYPE html>
<html>
<head>
<title>Export to tonyuexe</title>
<meta charset="utf-8">
<script src="../../js/lib/jquery-1.10.1.js" type="text/javascript"></script>
<script src="../../js/reqConf.js"></script>
<script src="../../js/lib/require.js"></script>
<style>
.on-logged-out { display:none; }
.on-logged-in { display:none; }
#complete {display:none;}
</style>
<script>
requirejs.config(reqConf);
requirejs(["Auth","Util","fs/exportToJsdoit","requestFragment"],function (Auth,Util,exj,rf){
  $(function () {
   var dir=Util.getQueryString("dir", "/Tonyu/Projects/1_Animation/");
   var dirs=dir.split("/");
   dirs.pop();
   var name=dirs.pop();
   $("#prjNameSpan").text(name);
   $("#prjName").val(name);
   Auth.currentUser(function(res) {
      if (res) {
          $(".on-logged-out").hide();
          $(".on-logged-in").show();
          rf.ajax({ type:"get", //redirectTo:"tonyuexe",
              url:"../../edit/get-project-info",
              data:{pathInfo:"/get-project-info", project:name},
              success:function (res) {
                  console.log("get-prj",res);
                  var data=JSON.parse(res);
                  if (data.license!="null") $("#license").val(data.license);
                  $("#allowFork").attr("checked",data.allowFork!="false");
                  $("#publishToList").attr("checked",data.publishToList!="false");
                  $(".submit-wait").hide();
                  var button=$("<button>").text("公開する").click(function (e) {
                      $(".submit-wait").show();
                      $(this).hide();
                      var data={pathInfo:"/upload-project"};
                      $("#theForm input").each(function () {
                          var t=$(this);
                          data[t.attr("name")]=t.val();
                      });
                      $("#theForm select").each(function () {
                          var t=$(this);
                          data[t.attr("name")]=t.val();
                      });
                      $("#theForm textarea").each(function () {
                          var t=$(this);
                          data[t.attr("name")]=t.val();
                      });
                      console.log("upload-project data",data);
                      rf.ajax({type:"post", redirectTo:"tonyuexe",
                          data:data,
                          success:function (res) {
                              console.log("upload-prj",res);
                              res=JSON.parse(res);
                              $("#complete").show();
                              $("#url").attr("href",res.url);

                          },error: function () {
                              alert("Error "+arguments)
                          }
                      });
                      e.preventDefault();
                      return false;
                  });
                  $("#theForm").append(button);
              },
              error: function () {
                  alert("Error "+arguments)
              }
          });
      } else {
          $(".on-logged-in").hide();
          $(".on-logged-out").show();
      }
      $(".wait-loggin").hide();
   });
  });
});
</script>
</head>
<body>
<div class="wait-loggin">ユーザ情報を取得しています</div>
<div class="on-logged-out"><a href="../../edit/login">ログイン</a>をしてください</div>
<div class="on-logged-in">
<h1><span id="prjNameSpan"></span>をtonyuexe.appspot.comで公開する </h1>
<div>※<a target="terms" href="../../doc/terms.html">利用規約</a>を確認してください</div>


<form id="theForm"><!--   action="../../edit/upload-project" method="POST"-->
<input type="hidden" id="prjName" name="project"/>
<textarea name="prog" cols=100 rows=24 style="display:none;"></textarea>

<div><input type="checkbox" id="publishToList" name="publishToList" value="true">このプロジェクトをプロジェクト一覧に表示する</div>
<ul>
<li>プロジェクト一覧は，tonyuedit（プロジェクト開発環境），tonyuexe（プロジェクト実行専用サイト）いずれの利用者からも見ることができます．
(現段階では未実装)</li>
</ul>

<div><input type="checkbox" id="allowFork" name="allowFork" value="true">このプロジェクトのForkを許可する</div>
<ul>
<li>Forkとは，他の投稿者がこのプロジェクトのコピーに変更を加えることです．このプロジェクト自身が他の投稿者に変更されることはありません．(現段階では未実装)
</li></ul>

<div>ライセンス
<select name="license" id="license">
<option value="mit">MIT License</option>
<option value="gpl3">GPLv3</option>
</select>
</div>
<div class="submit-wait">お待ちください....</div>
<hr/>
<div id="complete">
<h3>アップロード完了</h3>
<a id="url">アップロードしたプロジェクトを開く</a><br/>
<a href="index.html">Home</a>
</div>


</form>
</div>


</body>

</html>
